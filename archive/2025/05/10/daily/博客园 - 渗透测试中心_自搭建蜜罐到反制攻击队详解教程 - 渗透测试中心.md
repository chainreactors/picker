---
title: 自搭建蜜罐到反制攻击队详解教程 - 渗透测试中心
url: https://www.cnblogs.com/backlion/p/18867809
source: 博客园 - 渗透测试中心
date: 2025-05-10
fetch_date: 2025-10-06T22:30:00.893824
---

# 自搭建蜜罐到反制攻击队详解教程 - 渗透测试中心

[![](https://img2024.cnblogs.com/blog/35695/202509/35695-20250929100304557-587378723.jpg)](https://qoder.com/)

* [![博客园logo](//assets.cnblogs.com/logo.svg)](https://www.cnblogs.com/ "开发者的网上家园")
* [会员](https://cnblogs.vip/)
* [众包](https://www.cnblogs.com/cmt/p/18500368)
* [新闻](https://news.cnblogs.com/)
* [博问](https://q.cnblogs.com/)
* [闪存](https://ing.cnblogs.com/)
* [赞助商](https://www.cnblogs.com/cmt/p/19081960)
* [HarmonyOS](https://harmonyos.cnblogs.com/)
* [Chat2DB](https://chat2db-ai.com/)

* ![搜索](//assets.cnblogs.com/icons/search.svg)
  ![搜索](//assets.cnblogs.com/icons/enter.svg)
  + ![搜索](//assets.cnblogs.com/icons/search.svg)

    所有博客
  + ![搜索](//assets.cnblogs.com/icons/search.svg)

    当前博客
* [![写随笔](//assets.cnblogs.com/icons/newpost.svg)](https://i.cnblogs.com/EditPosts.aspx?opt=1 "写随笔")
  [![我的博客](//assets.cnblogs.com/icons/myblog.svg)](https://passport.cnblogs.com/GetBlogApplyStatus.aspx "我的博客")
  [![短消息](//assets.cnblogs.com/icons/message.svg)](https://msg.cnblogs.com/ "短消息")
  ![简洁模式](//assets.cnblogs.com/icons/lite-mode-on.svg)

  [![用户头像](//assets.cnblogs.com/icons/avatar-default.svg)](https://home.cnblogs.com/)

  [我的博客](https://passport.cnblogs.com/GetBlogApplyStatus.aspx)
  [我的园子](https://home.cnblogs.com/)
  [账号设置](https://account.cnblogs.com/settings/account)
  [会员中心](https://vip.cnblogs.com/my)
  简洁模式 ...
  退出登录

  [注册](https://account.cnblogs.com/signup)
  登录

[![返回主页](/skins/custom/images/logo.gif)](https://www.cnblogs.com/backlion/)

# [渗透测试中心](https://www.cnblogs.com/backlion)

##

* [博客园](https://www.cnblogs.com/)
* [首页](https://www.cnblogs.com/backlion/)
* [新随笔](https://i.cnblogs.com/EditPosts.aspx?opt=1)
* [联系](https://msg.cnblogs.com/send/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E5%BF%83)
* [管理](https://i.cnblogs.com/)
* 订阅
  [![订阅](/skins/coffee/images/xml.gif)](https://www.cnblogs.com/backlion/rss/)

# [自搭建蜜罐到反制攻击队详解教程](https://www.cnblogs.com/backlion/p/18867809 "发布于 2025-05-09 11:02")

### 前言

溯源反制一直是老生常谈的话题，是红蓝双方的对抗博弈，即便是专业的红队也会有犯错的时刻，大致总结为下面这些原因：

* 比赛提供的机器太过于卡顿，使用虚拟机操作影响效率，心情浮躁直接真机操作
* 红队操作习惯不好，未使用干净的虚拟机操作，机器上存有可溯源身份的文件或信息
* ”淹死的大多是会游泳的人“，因为有经验所以轻敌，抱有自己不会犯错的心理
* 对蜜罐判别不准确，未使用无痕模式或者识别蜜罐插件，甚至把蜜罐当作成果分享给队友

### 反制的大致流程

![image-20230725200645118](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110150905-2078027241.png)

### 蜜罐部署

部署一个高仿真的虚拟环境，这里有一些事项需要注意的

* 部署的蜜罐需提前向裁判报备，避免后续扯皮，且蜜罐需单独隔离，防止横向扩散
* 蜜罐不能太假，如多端口开启不同的web服务，系统要给攻击人员一种是靠自己努力获取成果的假象

如果直接使用xx厂商的云蜜罐，特征十分明显，还很容易在测绘平台上打上`蜜罐`标签，并且常规反制功能很鸡肋，触发条件很苛刻

![image-20230726113316371](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110151632-1947451015.png)

这次直接使用之前用来漏洞调试的`致远OA`环境，考虑到攻击队有学生队，保留一个存在nday的漏洞环境，让其能直接工具一键化getshell进行后渗透利用

镜像导入云服务器需要到下面这个地址下载驱动进行安装，再导出镜像，不然在云服务器会导入失败

<https://cloud.tencent.com/document/product/213/17815>

![image-20230726112024147](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110152188-1614171662.png)

搭建成功后把域名解析到IP上，域名命名最好以 `demo`、`crm`常见字典内字符为主，确保能被子域名扫描器识别到

![image-20230801150910986](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110152991-461179039.png)

另外可以通过waf自定义重定向页面至蜜罐地址，加快fofa、hunter等测绘平台的收录速度

![image-20230801151538336](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110153631-2089032160.png)

![image-20230801151438865](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110154260-862170179.png)

蜜罐部署好了，接下来就是木马的投放选择，文件内容可以选择`密码本、内部VPN程序、公司通讯录`等吸引攻击者的东西

这次我选择的是伪装内部vpn程序，并配合文档指导增加可信度和点击率

![image-20230803162751068](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110154978-878299053.png)

由于攻击队点击蜜罐充满随机性，为了能及时反制可设置上线提醒，具体参考 <https://xz.aliyun.com/t/10698>

接下来就可以静候佳音，等待攻击者上钩，主打的就是一手姜太公钓鱼

### 溯源反制

#### 常规溯源

溯源得分规则需要**交叉举证**、同时举证攻击者具备**网络安全攻击能力**，可从态势感知或防火墙上收集攻击者IP

![image-20230804114002608](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110155725-377496923.png)

对IP去重后进行**指纹识别**，例如安全博客、扫描器等等，从这些资产中溯源可以提高效率，这里推荐使用ehole

<https://github.com/EdgeSecurityTeam/EHole>

![image-20230804124810712](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110156582-1930429180.png)

举个例子，根据IP进行端口扫描发现到其搭建了灯塔系统

![image-20230804125035741](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110157419-737869286.png)

并通过态势感知平台发现其最近有扫描行为，很大概率是攻击队ip

![image-20230804125137173](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110158130-516306359.png)去微步进行Ip查询，发现IP绑定了域名，国内域名需要备案实名

![image-20230804125229046](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110158837-1023773602.png)

通过查询该域名whois信息，获取攻击者姓名：`沈xx`，qq邮箱：`578xxxxxx@qq.com`

![image-20230804125335696](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110159572-1423864917.png)

#### 反制攻击队成员1

案例来源于最近的ps比赛，寂静的夜晚突然响起了上线告警，正准备收拾东西下班的我顿时不困了

在反制过程中由于翻东西速度过快，可能会遗漏部分重要内容，建议边录屏边进行操作

通过机器上的录屏文件推测为现场攻击队成员，但由于视频过大不方便拷贝取证，只能另寻方法确认攻击队

![image-20230726122159369](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110200604-805568606.png)

攻击者操作习惯不错，使用的是虚拟机，在各个文件夹搜索许久并未找到个人信息相关的文件，正当一筹莫展之际突然翻到浏览器历史记录有这么一条

![image-20230803163728736](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110201414-308617180.png)

`username`居然是个手机号，一开始还以为只是普通的攻击成果没注意，百度一波发现是来自浙江温州的手机，明显与本次hw对应不上，猜测为攻击者本人手机

![image-20230803164107367](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110202169-68543979.png)

于是通过手机号反查个人信息，获取到了名字`陈xx`，就读于`浙江xxxx学校`，通过谷歌语法查询关键字，成功定位其任职于`xx信息公司`

![image-20230726121558031](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110202865-827530062.png)

通过内部通讯录二次确认攻击队队员身份，确定为在职实验室人员，这么一来所有的信息都对上了，结束收工

![image-20230726120729395](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110203528-351899129.png)

小插曲：从浏览器历史记录还获取到了灯塔系统的账密，攻击队应该感激我没有把任务删掉哈哈?

![image-20230804120913470](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110204250-1039635789.png)

#### 反制攻击队成员2

又是一位幸运玩家不小心踩罐，从机器上的python脚本文件找到ICP备案查询的`cookie`和`token`

![image-20230726115346985](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110204992-269055812.png)

burp替换cookie后成功获取攻击者的`百度ID`

![image-20230726115720013](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110205963-1366111655.png)

进而互联网搜索其名字的相关信息，发现还搭建了技术博客，成功定位其真实姓名 `吴xx`

![image-20230726115226838](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110206819-365663188.png)

并通过机器上的`CISP-PTE考试信息`进一步确认其身份

![image-20230726120407990](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110207691-720492499.png)

#### 反制攻击队成员3

宁静的村庄突然收到一则微信好友申请，正在吃瓜的我知道来活了，一眼就知道是攻击队微信钓鱼，将计就计配合其表演

![image-20230801153932954](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110208465-1294958356.png)

这里使用热点和虚拟机模拟个人终端环境点击攻击队的木马程序，并在桌面上放置反钓鱼木马文件`xx蓝方信息表`

![image-20230801160823564](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110209315-2139405728.png)

这里使用的是lnk文件，制作方法可通过后面的lnk文件制作模块进行查阅，为了实现解压文件的时候不可预览内容，我们需要选择rar压缩文件进行加密

![image-20230804111528572](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110210008-167856202.png)

这样解压之后就只有一个独立的lnk文件出现，在心烦意乱的hw后期攻击队很容易放松警惕不注意，最后也是成功上线机器

![image-20230801162614286](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110210808-2009499750.png)

### 涉及的技术手段

#### 木马免杀

要想反制攻击队，首先离不开的就是一个免杀性持久的木马，能抗能打

厚颜无耻的我趁机来打一波广告，过国内杀软常见三剑客，添加反沙箱代码可实现微步绿色，VT10以内

菜鸡本人项目：<https://github.com/Pizz33/GobypassAV-shellcode>

好兄弟王超攻的项目：<https://github.com/wangfly-me/SysHttpHookSleep>

![image-20230725194823394](https://img2023.cnblogs.com/blog/1049983/202505/1049983-20250509110211612-1358224981.png)

#### 反沙箱

传统的反沙箱有很多，如检测开机时间、机器内存大小、鼠标移动点击等等，这里提供两种比较实用的，剩下师傅们可以慢慢探索

检测桌面文件数量

```
func desktop() {
  desktopPath, err :\= os.UserHomeDir()
  if err != nil {
    fmt.Println("无法获取用户桌面路径：", err)
    return
  }

  desktopFiles, err :\= ioutil.ReadDir(filepath.Join(desktopPath, "Desktop"))
  if err != nil {
    fmt.Println("无法读取用户桌面文件列表：", err)
    return
  }

  fileCount :\= len(desktopFiles)
  fmt.Pr...