---
title: 【技术分享】在QQ上检测安卓锁机勒索软件
url: https://mp.weixin.qq.com/s?__biz=MzA5ODA0NDE2MA==&mid=2649782474&idx=1&sn=e63de67311a09a22e4aa762607a68eeb&chksm=889348a5bfe4c1b3bcdbcc7f123268be1c6ed63892fd42a29bbf312f1b97a867741e6cf7f91f&scene=58&subscene=0#rd
source: 安全客
date: 2023-01-29
fetch_date: 2025-10-04T05:08:03.630971
---

# 【技术分享】在QQ上检测安卓锁机勒索软件

![cover_image](https://mmbiz.qpic.cn/mmbiz_jpg/Ok4fxxCpBb79wSQStBKbdC7cSCQ3bnZgXA4ra6qr8zJTd6WQdJFdobxXd8Cqwo9JbQicIIK2yfiaymJ14byuyyqw/0?wx_fmt=jpeg)

# 【技术分享】在QQ上检测安卓锁机勒索软件

安全客

近年来，越来越多的锁机勒索软件（Locker-Ransomware）对Android平台以及用户的财产构成了巨大威胁。锁机勒索软件通过强制锁定设备勒索受害者的赎金，更糟糕的是，已经形成了成熟的勒索软件交易链。有效检测锁机勒索软件是一个紧急但至关重要的问题，为了解决这个问题，在本文中提出一种轻量级的自动方法来检测锁机勒索软件。

首先，对锁机勒索软件的交易市场进行了全面调查，并对锁机勒索软件的行为进行了全面分析。其次，为解决代码混淆问题，基于观察到的行为提取了显示文本和后台操作的特征。细粒度的特征是从多个来源提取的，可以从各个方面分析锁机勒索软件。最后，采用四种机器学习算法的集合进行检测，实验结果表明方法优于VirusTotal。以99.98％的检测精度实现最佳性能。

![](https://mmbiz.qpic.cn/mmbiz_gif/Ok4fxxCpBb76XtFEItIAkehEES6u34RvOEDFECyv5nPqzUxMS76qPyLYk0ssnl4BTc78jNpAGw7fBOKxCN7y3A/640?wx_fmt=gif&tp=wxpic&wxfrom=5&wx_lazy=1)

0x01 Introduction

勒索软件是一种恶意软件，它通过阻止对设备或数据的访问来勒索用户勒索赎金。通常，勒索软件可分为锁机勒索软件和加密勒索软件。更具体地说，锁机勒索软件通过重置PIN码或弹出全屏窗口来阻止用户与设备的互动。窗口覆盖了屏幕，使用户无法与设备进行交互。只有在受害者付款并输入了密码后，窗口才能消失。

加密勒索软件会加密用户的数据，并要求支付解密费用。锁机勒索软件和加密勒索软件有时会同时出现。应该注意的是，支付赎金并不能保证用户可以获得密码并重新获得对设备的访问权。大多数勒索软件攻击者都是由利润驱动的。为了诱使用户毫不犹豫和怀疑地支付赎金，攻击者转向了心理战术。他们经常为勒索软件配备侮辱性的信息和色情图片。他们对技术和心理学的巧妙使用使勒索软件成为公众的严峻问题。

勒索软件首先出现在计算机上。第一个勒索软件（称为AIDS）是在1980年代后期创建的。它加密文件并要求通过邮件勒索。随着互联网和加密货币的发展，勒索软件已经变得强大起来，具有多种传播和支付方式，在过去几年中造成了巨大损失。2017年，在感染了150个国家的200,000台计算机并造成40亿美元的经济损失后，WannaCry获得了迄今为止最广泛的勒索软件攻击知名度。

近年来，智能移动设备已受到广泛青睐。作为最受欢迎的移动操作系统，Android以85.9％的全球份额占领了市场。Android系统的开放性和易于使用的应用程序分发机制吸引了许多攻击者。2014年出现的Sypeng是第一个Android 锁机勒索软件样本。它通过伪造的Adobe Flash更新消息感染了设备。它锁定了屏幕，并弹出一条伪造的FBI消息，要求支付200美元的赎金。Koler因其自我复制的行为而成为第一个Android勒索软件蠕虫，它会自动将包含该蠕虫的下载链接的消息发送给受感染设备的联系人列表中的每个人。

在2015年，Lockerpin成为第一个能够重置设备PIN码的勒索软件的真实示例，它给受害者配备了锁定的手机屏幕，要求支付500美元的赎金。2017年，卡巴斯基实验室检测到超过54.4万个移动勒索软件。McAfee Lab声称，移动恶意软件作者将目光投向了获利。他们增加了勒索软件功能，以在移动平台上造成新的威胁。显然，针对Android的移动勒索软件已经对Android生态系统和用户的财产构成了巨大威胁。

中国是世界上最大的智能手机市场。2018年，中国人口的50.37％使用了智能手机。2017年12月，Android占据了中国移动操作系统市场78％的份额。但是，根据腾讯移动分析，中国用户的系统版本中有42％仍低于Android 6.0。平台早期版本的缺点（例如缺乏灵活的权限管理）使用户面临遭受攻击的高风险。

腾讯开发的QQ是全球最大的在线社区之一，拥有超过8.99亿活跃帐户。它的流行和匿名注册机制使其成为勒索软件交易的热门市场。针对Android的勒索软件的飞速增长，越来越需要能够自动分析和检测它们的有效方法。

有效检测锁机勒索软件的挑战之一是，大多数锁机勒索软件都是使用代码混淆构建的。函数的名称被替换为简单的字母，例如，reset\_password()被替换为a()，这增加了分析代码的难度。此外，锁机柜勒索软件通常与shell一起出现。它冒充流行的下载应用程序。安装后，shell程序将立即释放内部的锁机程序勒索软件，以执行恶意行为。在shell的保护下，大量的勒索勒索软件可以逃脱现有的检测方法。

![](https://mmbiz.qpic.cn/mmbiz_gif/Ok4fxxCpBb76XtFEItIAkehEES6u34RvOEDFECyv5nPqzUxMS76qPyLYk0ssnl4BTc78jNpAGw7fBOKxCN7y3A/640?wx_fmt=gif&tp=wxpic&wxfrom=5&wx_lazy=1)

0x02 Android Locker-Ransomware

在本节中将描述锁机勒索软件的传播和行为，发现数百个与锁机勒索软件交易相关的QQ群。勒索软件交易已成为成熟的产业链。观察到以下有关Android锁机勒索软件传播和行为的策略。

### A.传播

#### 1）市场

为了逃避法规和提高交易概率，交易环境需要匿名以及交易者进行谈判和付款的便利。QQ的匿名注册机制及其数字钱包完全符合要求。此外，大量的QQ用户是勒索软件销售商的潜在客户。要出售勒索软件，卖方可以加入现有的QQ群或创建自己的群组。通过搜索关键字可以找到销售勒索软件的QQ群。群成员的数量从几十到上千。对于买家，他们可以付费加入该群，并向所有群成员发送消息以请求勒索软件。值得注意的是，不仅群所有者，而且群中的所有其他成员都可以是卖方。团体是一个开放的市场。经过协商，一种勒索软件的价格通常低于￥10。买方可以通过QQ钱包向卖方付款，卖方将向他发送勒索软件。

在某些群中，群所有者共享勒索软件开发工具，视频教程和源代码。一旦支付了大约￥100的费用，他们还将提供有关如何开发勒索软件的一对一辅导。因此，除了出售勒索软件外，卖方还可以从会费，勒索和辅导费中获利。尽管单价似乎不令人满意，但是由于有大量购买者，利润是诱人的。许多普通人甚至受害者都在从事勒索软件交易，这使得勒索软件市场在社交网络上繁荣起来。交易过程如下图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb76XtFEItIAkehEES6u34Rv4ZgGsHOdEONepFbB8nicXiaIpYudeicFqHoWxib99bT1t97JuVqJnElnCw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

为了遏制勒索软件的传播，QQ配备了在线防病毒引擎，可以扫描上载的文件并删除已识别的恶意软件。但是，卖方通过将勒索软件压缩为加密的.rar文件并将带有密码的文件发送给买方就可以避免扫描。没有密码，防病毒引擎将无法提取和检测勒索软件。结果，卖方可以轻松地打破防御并共享群文件。

#### 2）开发工具

Android Studio是可在PC上运行的Android官方集成开发环境。但是，为了加速开发过程，攻击者更可能使用可以在Android设备上操作的AIDE。它可以通过简单的操作来编辑，调试，编译，签名和运行APK。为了生成自己的勒索软件，新学习者可以通过仅更改解锁密码和联系信息来利用现有勒索软件的源代码。通过详细的教程，即使对Android知识不多，也可以完成重新打包过程。硬件和技能的低要求使AIDE成为勒索软件开发中最受欢迎的工具。

#### 3）伪装

勒索软件总是伪装成流行的应用程序，以诱使下载。根据勒索软件的名称，锁机勒索软件通常伪装成热门游戏，抢红包机器人，QQ附加服务提供商和色情图形视频播放器。这些应用程序具有一些共同点：（1）大多数目标应用程序是非法的，并且在官方应用程序市场上不可用。因此，无论谁需要它们，都必须求助于其他来源，这为勒索软件的发行创造了机会。（2）这些应用程序往往需要更多权限，甚至需要root权限。熟悉这些应用程序的受害者会在安装过程中毫不犹豫地授予权限。（3）他们拥有广泛的用户群。勒索软件针对具有特殊需求但对Android知识很少的用户。勒索软件会伪装成引诱的下载，毫不费力。

### B.行为

#### 1）锁屏

锁机勒索软件最常见的行为是通过在屏幕上创建浮动窗口或更改PIN码来使设备不可用。浮动窗口显示威胁性消息以及攻击者的联系信息和付款方式。窗口不响应任何触摸事件，后退或主页按钮也不响应，从而使设备完全不可访问。在Android平台上，窗口的放置和外观由WindowManager 控制。勒索软件通过设置Win dowManager的特定布局参数来创建浮动窗口。例如，当窗口的类型设置为TYPE\_SYSTEM\_ERROR时，将被授予最高特权。它可以出现在所有内容之上。如果将其标志设置为FLAG\_NOT\_FOCUSABLE或FLAG\_NOT\_TOUCHABLE，则窗口将永远无法获得按键输入焦点或接收触摸事件，因此用户无法向其发送按键或其他按钮事件。一个例子可以在下图中看到。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb76XtFEItIAkehEES6u34RvRfjsppGutWX4Kv9Lqqn5xG9a6EBASMZsEceFv7phibjibIibLTgmTGNicA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

要禁用物理或虚拟键（例如主页，后退和菜单），攻击者将覆盖onKeyDown()方法以忽略按下事件。一些勒索软件诱使用户授予设备管理员特权。勒索软件使用DevicePolicyManager.ACTION\_ADD\_DEVICE\_ADMIN的动作创建了一个意图，以将自己作为新的设备管理员添加到系统中。管理员活动后，勒索软件将具有重写/data/system/password.key文件并重置PIN码以锁定屏幕的权限。更糟糕的是，具有管理员权限的应用无法像普通应用一样通过拖到垃圾箱中来卸载。因此，不熟悉系统设置的用户很难摆脱勒索软件。

下图显示了锁定电话的屏幕。将向受害者显示文本视图以插入密码。密码的生成基于屏幕上显示的密钥。攻击者将其QQ号码留作联系信息。希望受害者联系其QQ并支付赎金以获取密码。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb76XtFEItIAkehEES6u34RvJhtjYYZibbfzegia7IxRWbicjcRDhduKoAOrLql0P8AGB7fGpB2NzkJ6w/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

#### 2）阻止通话

一些勒索软件可以阻止电话，使设备无法访问。每当有电话打入时，Android系统都会将事件广播到所有应用程序。勒索软件可以通过注册广播接收器来监听事件。它可以从TelephonyManager中提取电话号码。如果该数字不是攻击者预先定义的数字，勒索软件将终止呼叫。通过将振铃器模式设置为RINGER\_MODE\_SILENT，运行的软件可以使电话静音以在暗中进行阻止过程。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb76XtFEItIAkehEES6u34Rvjia21R41P5icFyPN5mOTk75uPRiaBARbn4TRDCJ5w9fB6SXUSPInqo2zQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

#### 3）高优先级

设备启动完成后，大多数勒索软件便开始工作。它注册一个BroadcastReceiver并监听BOOT\_COMPLETED意图。在AndroidManifeat.xml中，有一个意图过滤器属性，称为优先级。它控制广播接收器的执行顺序。具有较高优先级值的应用程序将在具有较低优先级值的应用程序之前被调用。勒索软件将优先级设置为整数的最大值，从而赋予其最高优先级。这将是第一个知道设备已完成启动的应用程序，然后它将中止广播并启动恶意服务。一个例子可以在图4中看到。

#### 4）劫持活动

设备完成启动后，勒索软件将利用ActivityManager定期检测到顶级活动。如果top活动的软件包名称不属于勒索软件，则勒索软件可以通过调用killBackgroundProcesses()并重新启动其自己的活动来终止顶级活动。

#### 5）root shell

某些勒索软件利用根shell伪装成流行的应用程序。根shell的任务是获得root许可并在系统目录中发布勒索软件。锁定屏幕的真正勒索软件隐藏在/ asset目录中，并伪装为.so文件，例如dalvik.so。获得root许可后，root shell将dalvik.so复制到/ system / app /目录，并将其重命名为x.apk。重新启动系统后，勒索软件将自动安装在设备上。Android将其视为无法直接卸载的预装系统应用程序。尽管大多数勒索软件都可以通过Android调试桥（ADB,Android Debug Bridge）删除，但它仍然困扰着普通用户。

### C.密码和解锁

#### 1）密码

##### a：没有密码

勒索软件会弹出一个全屏浮动窗口，其中仅包含联系信息。攻击者收到赎金后，将通过致电或发短信给受害者来触发。

##### b：恒定密码

某些密码是恒定值，例如可以很容易记住的生日或句子。只有输入正确的密码后，浮动窗口才会消失。专业人员可以毫不费力地在反编译代码中找到常量密码。

##### c：高级密码

这种密码采用复杂的逻辑计算或加密算法，例如AES，DES。为了生成大量不同的密码，勒索软件可以创建一个随机数并将其用于计算。在某些情况下，加密进度包括几轮以使密码坚不可摧。

#### 2）解锁

##### a：输入密码

解锁设备的最常见方法是支付密码。在浮动窗口中输入密码后，该窗口将消失，受害者重新获得对设备的控制。

##### b：电话或短信

另一种方法是通过给受害者打电话或发短信来触发。攻击者用勒索软件的代码预定义了他的电话号码，并注册了一个监听器来监视电话状态。当有电话或短信进入时，勒索软件会检查它是否来自攻击者。如果呼叫号码与预定义的电话号码相同，则勒索软件将终止其服务。但是通过这种方式，攻击者的电话号码被暴露了。

##### c：通过解锁工具

为了解密高级密码，攻击者通常会开发一种解锁工具来自动对加密算法进行逆向计算。他们将在收到赎金后向受害者提供工具，受害者可以生成密码并自行解锁手机。

##### d：通过互联网

为了保护其个人信息，攻击者应用了匿名通信技术（例如Onion Network）来远程解锁设备。该技术最初旨在保护发送者和接收者的隐私，但被大量恶意软件滥用。

#### D.付款

大多数攻击者将其QQ号码留作联系信息，并指示受害者通过QQ钱包付款。与其他国家的高赎金不同，QQ的锁机勒索软件使用户可以负担得起，通常是￥20-￥50，因此受害者不会以“麻烦越少越好”的心态报警。此外，QQ是假名，受害者无法找到有关攻击者的个人信息。一些攻击者通过留下QR码来隐藏其QQ号。QRcode链接到攻击者的QQ钱包的付款界面。因此，受害者在不了解攻击者的情况下支付了赎金。尽管一些国际勒索软件支持比特币，但尚未在QQ上观察到任何样本。

#### E. API的早期版本

发现大多数锁机勒索软件都基于API的早期版本，86％的示例针对的是与Android 5.0相对应的API 21。早期版本缺乏灵活的权限控制机制。用户需要授予应用安装时间权限，否则将无法成功安装该应用。如果用户轻率地安装了运行软件并授予他们危险的权限，则这些权限是不可撤销的，这使勒索软件有机会损坏设备。但是，仍有42％的中国用户的系统版本使用Android 6.0。与使用更高版本的Android的用户相比，他们更容易受到勒索软件的攻击。

#### F.心理技巧

勒索软件受利润驱动。攻击者会充分利用心理技巧来达到目标。他们利用用户的贪婪并通过提供免费应用程序诱使他们安装勒索软件。为了防止受害者寻求帮助，他们转向恐惧和羞辱。与大多数恶意软件的地下和偷偷摸摸的行为不同，勒索软件倾向于展示胜利。勒索软件显示威胁性消息和色情图片，伴随响亮的音乐和频繁的振动，迫使受害者支付赎金。受害人将耻于寻求专业人士的帮助，必须顺服地付款。

![](https://mmbiz.qpic.cn/mmbiz_gif/Ok4fxxCpBb76XtFEItIAkehEES6u34RvOEDFECyv5nPqzUxMS76qPyLYk0ssnl4BTc78jNpAGw7fBOKxCN7y3A/640?wx_fmt=gif&tp=wxpic&wxfrom=5&wx_lazy=1)

0x03 Method

### A.概述

在本节中提出一个框架，用于根据发现的行为来分析和检测锁机勒索软件。如下图所示，在将应用程序馈入框架后，文本和行为模块并行工作以提取UI中显示的文本和背景中的行为。提取六类特征。通过四个分类器的组合，最终将这些应用程序识别为良性应用程序或锁机勒索软件。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb76XtFEItIAkehEES6u34RvPbEDU2InCbkS4n9bXTuCGYx7hZIfiblBAYr7bMJaiaJCA95ReDVQkHhA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

### B.特征提取

特征的提取和选择对于有效检测锁机勒索软件非常重要。在以前的工作中，一种类型的特征通常来自一个来源。例如，权限仅从清单文件中提取，而API是从反编译代码中提取的。但是，在锁机勒索软件的开发过程中，有多种现有方法可用于同一特征，例如，小部件中的文本可能会出现在布局文件，字符串资源或反编译的代码中。因此，在工作中，特征集中的一种功能可能来自不同的来源。有两个观察结果：

（1）与其他隐藏了恶意行为的恶意软件不同，Locker-Ra...