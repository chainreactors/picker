---
title: 针对一个有意思的钓鱼免杀样本的详细分析
url: https://mp.weixin.qq.com/s?__biz=MzA4ODEyODA3MQ==&mid=2247488548&idx=1&sn=8b4c3c6c511d9030155d3a81ceedb86e&chksm=902fbb0ca758321a4d6d7d2ff00935026377a148faca571aa017d12cbd1be1fa9d8ab15af5ae&scene=58&subscene=0#rd
source: 安全分析与研究
date: 2024-07-18
fetch_date: 2025-10-06T17:44:39.916412
---

# 针对一个有意思的钓鱼免杀样本的详细分析

![cover_image](http://mmbiz.qpic.cn/mmbiz_jpg/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9urz7NAIMkpSuqysacWFAXhayvdjzGBWSBon3ic59Bk99YSAMcVuibCTA/0?wx_fmt=jpeg)

# 针对一个有意思的钓鱼免杀样本的详细分析

原创

pandazhengzheng

安全分析与研究

**安全分析与研究**

专注于全球恶意软件的分析与研究

前言概述

原文首发出处：

https://xz.aliyun.com/t/15022

先知社区 作者：熊猫正正

近日跟踪到一个钓鱼样本，比较有意思，沙箱没有跑出行为，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9t9A5TaFehUBPp423nFSaRpQtqPXUYFOkqh3HkbVdjcEQkwmkmdOgcg/640?wx_fmt=png)

针对这种沙箱跑不出行为的免杀对抗型样本，都值得深入的分析和研究，笔者对这个样本进行了详细分析，分享出来供大家参考学习。

详细分析

1.钓鱼样本解压缩之后，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9ribL41b964z5vXBmiabOtmibZhXAyr5mvUCCZS1UTw23o96SXToBft5Hw/640?wx_fmt=png)

2.\_MACOSX目录下的文件信息，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9Okek46ZicRF5DPW8wchm3MNMpDkRR2EthHEk9GtS7OC5NWpHd1OnvxQ/640?wx_fmt=png)

3.LNK快捷方式相关信息，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9wMcBO38VXxLDHkbUtTuQibzEUnTTxM4ZyH0j4hZZ7xuQ0yfKcwRM3Bg/640?wx_fmt=png)

4.调用执行对应目录下的VBS脚本，VBS脚本内容，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9onGStGRCQOdpg4UEDq4HYVMeRsJC6JkIeDTMYIOBzrpRZmFHoaD1yw/640?wx_fmt=png)

5.重命名目录下的相关文件并启动DS\_Strore.exe程序，最后执行PING操作，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R90W58M9ynQUqPYToCPgvuDlvIg7ia6IBOmGib0MBsslj6lU7mSb7wQZBg/640?wx_fmt=png&from=appmsg)

6.DS\_Strore.exe程序,主函数代码，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9gTBOS67jjAr0ovxCwk8V9YguR6Bj6a2pjKp8hicgubMOgicazeJibfHQQ/640?wx_fmt=png)

7.直接定位到关键函数，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9TY7mb17CY7FLbfwQuVxOSrVwBJfLicHDiacZEISsPQnytquPF0o9x8qA/640?wx_fmt=png)

8.分配内存空间，然后将ShellCode代码拷贝到分配的内存空间，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9e90cdMKlMII6ujA4CDibiavExGYCicv5TJC2UTNBMtq6CFbLY3BCfPHFg/640?wx_fmt=png)

9.拷贝完成之后，再跳转执行到分配的内存空间ShellCode代码处，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9bdEibWia9Yn5b5mO1wJ0vianlMJM72npJul7hbJx51wibeiapX6fW4NB3aQ/640?wx_fmt=png)

10.ShellCode加载相关的DLL模块，并获取相关函数地址，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R91XEvaAX7FuOrx8bia23x8cm4RK03wvPXa2425IDBNziajv26GJlg7lUw/640?wx_fmt=png)

11.ShellCode包含很多混淆垃圾代码，防止IDA静态分析，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9adzaxZP1qgn0bDyXKbsXrMVBap2TZgcQLPkaQ9kTG7DmVroiaH2Cx9A/640?wx_fmt=png)

12.解密相应的字符串信息，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9VA7BmOno80AN5xbsQiaNozmicibHOtoC40HL9WP60IqpNblJOPyXh8bqQ/640?wx_fmt=png)

13.解密出来的随机字符串信息为LRcOSGV0ewEDBAQCQAA=，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9DfutAn7SauKmoXk6J1XJTSf3ia7u81NUFSjusfGXbw0lhv2ZqmUmHoQ/640?wx_fmt=png)

14.创建互斥变量Yh-ioklsdf-san，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9FARhibyDVriavsiasNgwdlaYQRkLUibISYNNXHBrFzuNWPLqHnfeSEYdhw/640?wx_fmt=png)

15.调用VirtualAlloc分配相应的内存空间，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9ib6eXZ1yqibia8lIdpXlfA9c3pqnsFAiaSSDEeSDttBeXBlPIF6KAf5FtQ/640?wx_fmt=png)

16.连接远程服务器service-h87kxr41-1319584009.bj.tencentapigw.com.cn，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R93DiaSK4w6RZ7FOCxCn7s0gpaIppyJ9g7iaej6nVUezcxrhGOs7gQdhRw/640?wx_fmt=png)

17.通过URL链接发送POST请求，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R92xdW4vn9fd32ZVeh2TbBbg5kbuhTNYHLbRJ2hhwicosNGic6hcyeTHag/640?wx_fmt=png)

18.将之前解密出来的随机字符串LRcOSGV0ewEDBAQCQAA=发送到远程服务器，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R99uwsqcVxM4lzcyRlibBT6ePaAhbbiaYZF7GDao7LnWjyBC4obpC8OEdA/640?wx_fmt=png)

19.接受服务器端返回的加密数据，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9HTtjAibicYHy9wyDZFDHusv3C2wqKDTRaBqicibAfRZbc0SQmad00GCibZg/640?wx_fmt=png)

20.查询服务器端加密数据信息，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9ribMKrTwmTZQ5YiaeKelQERibYAVas7IHG59txMibzXEbF01JKdwKkUA4A/640?wx_fmt=png)

21.调用VirtualAlloc分配内存空间，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R93nbcur5tk9mxUVppibyvEOAlib1FJcUrtL9QP5I6QnpUT5OYuibKICEMA/640?wx_fmt=png)

22.从服务器端读取加密数据到内存空间，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9NWOXDiccD2G6ibV4ibAztTQicyG6wLQopGduqw4YkY7fUE0FOKYCnDA1sw/640?wx_fmt=png)

23.读取的加密数据，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9OCT01SvwUrxEUziblLxQxB5Xy8Tj7ybd9ADYDHNCP9rozWvic3ib3bSwg/640?wx_fmt=png)

24.将返回的加密数据拷贝到之前分配的内存空间当中，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9m1s5AS19jyHsiajmUxoiaOoQibr0k2T8rUAJGrUXy6iaTNQ944G63IBLdg/640?wx_fmt=png)

25.拷贝完成之后，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9p0mMwYO3dHyNx6n19CrrX6neQlX8XqiaOcXDrVbvWKxoZGRnzQr8fsA/640?wx_fmt=png)

26.重复上面的操作，循环读取服务器端加密的数据，并返回到分配的内存空间，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9xpBJldd7nHX9Te28QaYwgghliamggCQZjguwOCSETn2NRcyoIOdwKMg/640?wx_fmt=png)

27.将返回的加密数据再拷贝到之前的内存空间的后面，请求完成之后，返回的加密数据，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9EtoibRdeluib5ztMu3s80YOZEFeA7dibFdnicAic9g29nC9pxkC76hiba19A/640?wx_fmt=png)

28.解密字符串，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9iciaibNt8ib0UFFQj7xRL0NFFUEE15h5dCB3q0a10KEehpaXuYzM1lGysQ/640?wx_fmt=png)

29.解密接受的服务器端数据，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9ianrnN5Yich3RdMB0ErAx4MCrmaWaU769qqJNp1BvuHqaAMcpiamzst2g/640?wx_fmt=png)

30.解密后的服务端器加密数据，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9BicwP9FpiaSNtEeDV93qCNtSQxHJDXxjfAtMNPSlgxB3TAwSeq9s54iaQ/640?wx_fmt=png)

31.设置解密后的PayLoad内存属性为可执行，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9C4vBOicQLoiaWjSqrgOF5giauZ9LANxnaX0JwlNDZ089rW04xystiankAQ/640?wx_fmt=png)

最后执行解密出来的PayLoad，笔者在调试的时候会遇到接收数据不完整的情况，解密出来PayLoad不完整，可能是服务器网络或笔者网络不稳定,也可能是程序BUG吧，不过猜测最后的PayLoad应该是一个CS木马之类的，后面应该还有机会拿到完整的PayLoad笔者再分析。

威胁情报

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmWD0zmZwiaiahy8ZYN9xLJ2R9osfP4TicvDnfWXFccWXJ5fSv0oqSlUiaJQsjuxhGERF5rUJYnhVXX8oQ/640?wx_fmt=png&from=appmsg)

总结结尾

做安全，免杀是一个永恒的话题，是一场猫捉老鼠的游戏，通过研究一些对抗型的攻击样本，可以更好的了解攻击者在使用什么技术。

预览时标签不可点

阅读原文

修改于

![]()

微信扫一扫
关注该公众号

继续滑动看下一个

轻触阅读原文

![](http://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVcFgYKtoVnKR7h3pkl3AyxwS0l7iagicAJnYjEQhwIuZgR3RR65DLpJh2TGZS82DY7CjsBUmiaAl7BQ/0?wx_fmt=png)

安全分析与研究

向上滑动看下一个

知道了

![]()
微信扫一扫
使用小程序

取消
允许

取消
允许

取消
允许

×
分析

![跳转二维码]()

![作者头像](http://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVcFgYKtoVnKR7h3pkl3AyxwS0l7iagicAJnYjEQhwIuZgR3RR65DLpJh2TGZS82DY7CjsBUmiaAl7BQ/0?wx_fmt=png)

微信扫一扫可打开此内容，
使用完整服务

：
，
，
，
，
，
，
，
，
，
，
，
，
。

视频
小程序
赞
，轻点两下取消赞
在看
，轻点两下取消在看
分享
留言
收藏
听过