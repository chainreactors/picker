---
title: Windows Exploitation Challenge – Blue Frost Security 2022
url: https://voidsec.com/windows-exploitation-challenge-blue-frost-security-2022/
source: Blog Archives - VoidSec
date: 2022-12-02
fetch_date: 2025-10-04T00:17:25.550834
---

# Windows Exploitation Challenge – Blue Frost Security 2022

[![VoidSec](//voidsec.com/wp-content/uploads/2018/02/Voidsec_logo.png)![VoidSec](//voidsec.com/wp-content/uploads/2018/02/Voidsec_logo_.png)![VoidSec](//voidsec.com/wp-content/uploads/2018/02/Voidsec_logo.png)![VoidSec](//voidsec.com/wp-content/uploads/2018/02/Voidsec_logo_.png)](https://voidsec.com/ "VoidSec - Some things in life are unpredictable, your Cyber Security doesn’t have to be one of them")

* [Blog](https://voidsec.com/category/blog/)
* [Advisories](https://voidsec.com/advisories/)

  + [Vulnerability Disclosure Policy](https://voidsec.com/disclosure-policy/)
* [About](https://voidsec.com/member/voidsec/)
* [Contact](https://voidsec.com/contact-me/)

* [Blog](https://voidsec.com/category/blog/)
* [Advisories](https://voidsec.com/advisories/)

  + [Vulnerability Disclosure Policy](https://voidsec.com/disclosure-policy/)
* [About](https://voidsec.com/member/voidsec/)
* [Contact](https://voidsec.com/contact-me/)

[Back to Posts](https://voidsec.com)

![](https://voidsec.com/wp-content/uploads/2022/11/bfs.png)

### Share this post

[Facebook](https://www.facebook.com/sharer.php?u=https://voidsec.com/windows-exploitation-challenge-blue-frost-security-2022/ "Facebook")
[Twitter](https://twitter.com/intent/tweet?text=Windows+Exploitation+Challenge+%26%238211%3B+Blue+Frost+Security+2022+%28Ekoparty%29&url=https://voidsec.com/windows-exploitation-challenge-blue-frost-security-2022/ "X")
[LinkedIn](https://www.linkedin.com/shareArticle?mini=true&url=https://voidsec.com/windows-exploitation-challenge-blue-frost-security-2022/&title=Windows+Exploitation+Challenge+%26%238211%3B+Blue+Frost+Security+2022+%28Ekoparty%29 "LinkedIn")
[Email](/cdn-cgi/l/email-protection#655a1610070f00061158320c0b010a12164e201d15090a0c1104110c0a0b4e260d040909000b02004e4057534057565d5754544056274e270910004e23170a16114e36000610170c111c4e575557574e40575d200e0a150417111c40575c430408155e070a011c580d111115165f4a4a130a0c011600064b060a084a120c0b010a121648001d15090a0c1104110c0a0b48060d040909000b020048070910004803170a16114816000610170c111c48575557574a "Email")
[VK](https://vk.com/share.php?url=https://voidsec.com/windows-exploitation-challenge-blue-frost-security-2022/&title=Windows+Exploitation+Challenge+%26%238211%3B+Blue+Frost+Security+2022+%28Ekoparty%29&image=https://voidsec.com/wp-content/uploads/2022/11/bfs.png&noparse=true "VK")
[Reddit](http://www.reddit.com/submit?url=https://voidsec.com/windows-exploitation-challenge-blue-frost-security-2022/&title=Windows+Exploitation+Challenge+%26%238211%3B+Blue+Frost+Security+2022+%28Ekoparty%29 "Reddit")
WhatsApp

## Windows Exploitation Challenge – Blue Frost Security 2022 (Ekoparty)

Posted by: voidsec

Post Date: December 1, 2022

---

[voidsec](https://voidsec.com/author/voidsec/ "Posts by voidsec")2023-06-14T17:52:49+02:00

**Reading Time:**   16 minutes

Last month, during Ekoparty, Blue Frost Security published a [Windows challenge](https://labs.bluefrostsecurity.de/blog.html/2022/10/25/bfs-ekoparty-2022-exploitation-challenges/). Since having a Windows exploitation challenge, is one of a kind in CTFs, and since I’ve found the challenge interesting and very clever, I’ve decided to post about my reverse engineering and exploitation methodology.

Table of Contents

* [Challenge Requests](#challenge-requests)
* [High-Level Analysis](#high-level-analysis)
* [Handshake](#handshake)
* [Data Processing](#data-processing)
* [char\_replace()](#char-replace)
* [Chaining Vulnerabilities](#chaining-vulnerabilities)
  + [Integer Overflow](#integer-overflow)
  + [Stack-based Buffer Overflow](#stack-based-buffer-overflow)
  + [Mitigations](#mitigations)
* [Type Confusion](#type-confusion)
* [Code Execution](#code-execution)
  + [iretd](#iretd)
  + [Global Descriptor Table](#global-descriptor-table)
* [Video PoC and Exploit](#video-poc-and-exploit)
* [Resources & References](#resources-references)

## Challenge Requests

1. Only Python solutions without external libraries will be accepted
2. The goal is to execute the Windows Calculator (calc.exe)
3. The solution should work on Windows 10 or Windows 11
4. Process continuation is desirable (not mandatory)

You can download the target application [here](https://static.bluefrostsecurity.de/files/lab/bfs-eko2022.zip) ([backup](https://github.com/VoidSec/Exploit-Development/tree/master/windows/x64/usermode/remote/ekoparty2022_BFS_challenge)).

## High-Level Analysis

When exploring an unknown executable, one of the first things I always check is the security features that were built into the binary when it was compiled. If on Linux I’m used to <checksec.sh>, on Windows I use <winchecksec> or [PESecurity](https://github.com/NetSPI/PESecurity); they aren’t kept updated but they serve our purpose.

Doing so, resulted in the following mitigations:

```
C:\Users\VoidSec>winchecksec.exe bfs-eko2022.exe

Architecture    : AMD64
Dynamic Base    : "Present"
ASLR            : "Present"
High Entropy VA : "NotPresent"
Force Integrity : "NotPresent"
Isolation       : "Present"
NX/DEP          : "Present"
SEH             : N/A
CFG             : "NotPresent"
RFG             : "NotPresent"
SafeSEH         : N/A
GS              : "Present"
Authenticode    : False
.NET            : False
```

Some of these details can also be confirmed, at runtime, with a tool like [System Informer](https://systeminformer.sourceforge.io/downloads.php) (former Process Hacker):

![](https://voidsec.com/wp-content/uploads/porto_placeholders/100x12.jpg)

This means that we are dealing with an x64, un-obfuscated, C++ (checked with [DIE](https://github.com/horsicq/DIE-engine/releases)) compiled binary with ASLR, DEP and stack-canaries enabled mitigations but no CFG.

Once executed, the binary binds on `0.0.0.0`, port `31415`, and awaits client connection.

![](https://voidsec.com/wp-content/uploads/porto_placeholders/100x13.jpg)![](https://voidsec.com/wp-content/uploads/porto_placeholders/100x29.jpg)

As per my methodology, I’ve proceeded with reverse engineering the high-level functionalities of each code block, renaming them with some meaningful labels. One thing that also helps me better visualize the code flow is colouring blocks:

* Blue shades: nodes that I’m stepping through while debugging or paths followed by the software. For more complex software I’m generally tracing the execution flow with tools like <PIN>, <Dynamorio> and the [Tenet](https://github.com/gaasedelen/tenet) IDA’s plugin.
* Green shades: blocks that I want to reach or that are holding main/interesting functionalities I’d like to explore.
* Black/grey: error messages/irrelevant code sections.
* Orange: possible logic vulnerabilities that I’d like to further examine.
* Red: possible memory corruption vulnerabilities that I’d like to further examine.

I’ve then collapsed all irrelevant nodes, leaving me with the following simplified code graph:

# ![](https://voidsec.com/wp-content/uploads/porto_placeholders/100x62.jpg)

## Handshake

I usually combine debugging and static code analysis in order to get the most out of both. I then proceeded to write a simple python “client” to interact with the target.

As soon as the software start, an always static (both in size and memory address) buffer is allocated in the heap:

![](https://voidsec.com/wp-content/uploads/porto_placeholders/100x24.jpg)

As we can see from the `VirtualAlloc()` API call above, the buffer is allocated at address `0x10000000` and it is of size `0x1000` (4096 bytes); the memory protection for the region is `RWX`.

After that, we find the socket initialization, the server binding, and then it enters a loop, waiting for a client connection.

Data sent to the server is stored in the previously allocated **heap-buffer** and then a function is called. This function, opportunely renamed as `handhshake_check()`, has the following prototype: `handhshake_check(uint buffer_length, *buffer)` and once decompiled it results in the following code:

```
_BOOL8 __fastcall handhshake_check(__int64 buffer_length, cons...