---
title: “银狐”又又又变种了！新“银狐”木马样本分析在此
url: https://mp.weixin.qq.com/s?__biz=Mzg2NjgzNjA5NQ==&mid=2247523917&idx=1&sn=89d9e4cb1792b419f46b7516de333a3b&chksm=ce46155df9319c4bccc7483a431d52722238f67fdca80c3e8328e0c29da472baa7399ee4c374&scene=58&subscene=0#rd
source: 深信服千里目安全技术中心
date: 2024-11-30
fetch_date: 2025-10-06T19:17:01.460210
---

# “银狐”又又又变种了！新“银狐”木马样本分析在此

![cover_image](https://mmbiz.qpic.cn/mmbiz_jpg/w8NHw6tcQ5xJjzdkFvS0QvgbLEI7PB62SZP7Cof7dA7oHF3zS12f8zI5edq3cbOLiaOETcEoUQNfbseZicKUG9XQ/0?wx_fmt=jpeg)

# “银狐”又又又变种了！新“银狐”木马样本分析在此

原创

深盾终端实验室

深信服千里目安全技术中心

![](https://mmbiz.qpic.cn/mmbiz_gif/w8NHw6tcQ5zFObpGGvbWzxnyX6UtTRfibHlJCvfKQGPIDhYFImibr1SvBqtkm7KjzZsHVdzmOMBrQuKeYghpKOHA/640?wx_fmt=gif)

**恶意文件名称：**

未知

**威胁类型：**

RAT

**简单描述：**

银狐组织通过微信或其它通讯软件以公司名单为诱饵传播给用户，经用户解压并运行exe文件后，即开始与攻击者控制的C2通信。

**事件描述**

近期，深盾终端实验室在运营工作中发现了一起利用微信等其它IM软件钓鱼的相关样本，攻击者通过**“公司名单”**等作为切入口，诱导用户自行解压缩并点击运行恶意文件。

此样本**攻击流程复杂度高**，攻击者C2隐藏于云服务器且具有多段载荷加载的能力。样本层层隐藏，**在用户点击运行后，攻击者可以通过该样本向受害者主机投送后续恶意文件或者执行ShellCode，获取用户主机的任意数据并能操控用户主机**。

经分析，此样本与近期疯狂扩散的通过微信群聊传播的名称为“金稅四期（电脑版）-uninstall.msi”样本有所不同，此次发现的样本**编译时间更新，部分 C2 截止样本分析时仍然存活，所应用的技术手法也有较大差别**。

**不同之处具体表现为：**

**从ATTCK的角度来看**，以往大多数的银狐样本都会通过计划任务、服务、注册表或启动目录来实现持久化项，但此类持久化行为容易被安全软件检测，本次发现的样本并未发现持久化项驻留。虽然本次发现的样本应用了 UACMe 的代码但在样本前期的执行阶段并未发现调用，通过注册表禁用 UAC 这种易被发现的危险操作也并未执行。

**从样本最后应用的木马来看**，以往银狐样本通常是 gh0st 木马远控变种或 winos 远控，此次发现的远控组件中并未发现 gh0st 木马常见的键盘输入窃取等功能。

**从技术手法上看**，以往银狐样本常使用 TrueUpdate 程序白利用、BYOVD 自保护等手法，随着安全软件的逐步迭代，也推动着银狐组织逐步探索、使用其它更难被检测的技术。

**下图是对12个不同时期银狐样本所使用到的 ATTCK 的标注，从中可以一窥银狐组织的技术演化过程。**

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xwtm0ltFS4HVhfQhJLlS4DDKzibnUMc7d1OQGibc3PJg3E6V2mibXU6RbGzBYBTk5gMeuGz2Cib1AqRA/640?wx_fmt=png&from=appmsg)

**恶意文件分析**

本次捕获的银狐样本在攻击技术上相对以前有较大的变化，主要包括：**技术应用上更新、技术组合上更多、隐蔽性更强等**，给传统安全软件带来了更大挑战。

1. 入口文件作为 Loader 远程加载 ShellCode 可以有效降低被静态扫描检出的几率且此样本大量使用反射加载，嵌套式的加载给动态分析增加了很多难度。

2. 增加的对文件名称的检测可以在一定程度上绕过沙箱。

3. 代码中复用了 Github 项目 UACMe 的代码用于提权。

4. NT Stub 函数的利用有效避免了被安全软件动态检出。

5. 2023 年 BlackHat 中披露的 PoolParty 技术的应用也标志着银狐在不断“进化”，正在积极应用新型技术手段躲避安全软件的检出。

**样本执行流程图如下所示：**

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xJjzdkFvS0QvgbLEI7PB62nic1aJEvUib06GCTYzsBzZTSa4sjnv19kzeicA5eYHltPgLdNQk5jC9zQ/640?wx_fmt=png&from=appmsg)

**入口文件exe基本信息如下：**

|  |  |
| --- | --- |
| hash | b4c591c844a5909be98e596c52b658bd |
| 文件类型 | x64, peExe |
| 编译时间 | 2024-11-18 10:53:41 |
| 编译器 | Microsoft Visual C/C++(19.29.30156)[C++] |
| 链接程序 | Microsoft Linker(14.29.30156) |

攻击者剥离合法文件的数字签名数据并将数据附加在样本后段，达到伪造签名的目的。此种方法在一定程度上可以绕过部分杀毒软件的静态检测。

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xwtm0ltFS4HVhfQhJLlS4DMxIlEYmbZ19sOnKmoufiaicT3LI39g06sZs9r3qjI4NWVqBUH1Bc4jSA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xJjzdkFvS0QvgbLEI7PB62PMYbNdIuoWnB6eS4rEgOVTKYgcJ7aOAV2wG4HfEQsIKpgvuJ1xRj0w/640?wx_fmt=png&from=appmsg)

样本本身作为一个 Loader 并未大幅度运用混淆和反调试技巧。使用Event对象的等待机制结合rdtsc指令，刻意让样本在等待60s后再执行，达到反沙箱的目的。

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xJjzdkFvS0QvgbLEI7PB62CzaQwia8zanU2NibMa8PkXRq567VGrE2mekcHCVn8iasM6KpWByZXx7LA/640?wx_fmt=png&from=appmsg)

检测当前系统是否存在虚拟内存，并限制当前系统内存大小必须不小于4GB，否则样本退出执行。

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xJjzdkFvS0QvgbLEI7PB628ibicicaHibBLKPPGCyyfPGKWZIxicd5woHCUeBRpv2rQkf1Jl2RTs8DRkg/640?wx_fmt=png&from=appmsg)

对外连URL做拼接时，每4字节作为一块数据并以\x00作为终止，分别将每块数据的首地址入栈，将拼接后的数据写入申请的小块内存中，最终得到URL：

hxxps://kjdhz.oss-cn-shenzhen.aliyuncs.com/360.dat

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xJjzdkFvS0QvgbLEI7PB62vgWaqaZtkEZsMRPwNuD4UJKeibuL3W5dNEnXsdkIibXPmUYXe7lVdh0A/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xJjzdkFvS0QvgbLEI7PB62Z2slcdQufb27II3j5iaf2UNRYZzHgjSFjqp1fKnteBHxmmAEZCqrwoA/640?wx_fmt=png&from=appmsg)

从URL指向的服务器获取数据，去除末尾0x10字节的数据后，将数据移动到新申请的内存中，使用0xF解密获取到的数据。

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xJjzdkFvS0QvgbLEI7PB62qHkKwkTviciaFZ4nQMEWwX7Qe845bctVKMOTq65I6ibBLViahib3QXkLia3Q/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xJjzdkFvS0QvgbLEI7PB62kMUF6WOPibJlLFTE8hWSsu2bm8WIKeFRao13AXvTDzIDMqGwQfKGuXg/640?wx_fmt=png&from=appmsg)

通过 TEB -> PEB -> Ldr 获取到 ntdll 的基址，从 ntdll 基址定位到导出表，轮计算 ntdll 导出表中每个函数名称的 ROR4 值，对比攻击者传入的值，匹配则返回该函数在SSDT表中的 Index。随后攻击者通过自行实现的Nt存根函数直接调用系统函数。

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xJjzdkFvS0QvgbLEI7PB62TxGAETP8th5ERqdd6xFc42aGibkTx5gJ0hD92UKmV3p20WYZ4wPpwBA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xJjzdkFvS0QvgbLEI7PB62fsldCAYVeNuib48ktibQcozZJfib2Tlib5vibXGaribiaDyaH1eiavc6tlhbibA/640?wx_fmt=png&from=appmsg)

基于以上方式，样本依次调用 NtAllocateVirtualMemory、ZwWriteVirtualMemory 将数据写申请的可执行空间中，随后调用 NtCreateThreadEx 执行。主线程在新线程结束运行后会自行退出，此后程序终止。

在新线程执行 ShellCode 阶段，通过 PEB -> Ldr 获取当前进程的 BaseName，即文件名称。定位到 Kernel32.dll 的基址，随后同样通过函数名称 hash 的方式获取导出函数，动态加载所需要的函数。

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xJjzdkFvS0QvgbLEI7PB62WUwTb5iaUVYAPrxCIeW6Q5KnKVT3a08nhVjL29GHic4EcZXzuicv5KjIw/640?wx_fmt=png&from=appmsg)

反射加载 ShellCode 中存在的 PE 文件。IAT 重建后先执行 TLS ，若无跳转至 OEP 执行。该反射加载的 Loader 疑似使用了第三方组件。

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xJjzdkFvS0QvgbLEI7PB62cLPXSW5nRMSmvafialnonfy18475R1icJPlpAHfbcXnJ0NkLOITqNG1w/640?wx_fmt=png&from=appmsg)

反射加载的 DLL 的基本信息如下：

|  |  |
| --- | --- |
| Hash | 9557f6c29dd69a1cf67d91810fffc536 |
| 文件类型 | x64, peDLL |
| 编译时间 | 2023-04-23 09:30:56 |
| 编译器 | Microsoft Visual C/C++(19.29.30148)[LTCG/C] |
| 链接程序 | Microsoft Linker(14.29.30148) |
| 依赖项目 | UACMev3.6.4 [hxxps://github.com/hfiref0x/UACME/blob/v3.6.4] |

反射加载的DLL使用了 Github 的项目 UACMe，该项目旨在利用 Windows 机制进行 UAC Bypass。样本在会判定当前系统的主版本号，以Win10作分界线执行不同的动作。

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xJjzdkFvS0QvgbLEI7PB62iayxUPv7wIJPZBmddGcF76TaSvoVzq5O0uYb99jEDHbkS1ZKk9p7LKg/640?wx_fmt=png&from=appmsg)

**下面将分两种情况进行分析：**

**1.系统版本低于Win10**

样本会枚举当前系统中的所有进程。若枚举失败或当前系统中不存在 360Tray.exe，则会检测当前文件名称中是否存在123、[6001-6010、6012、6014.....] 等字符串，若不存在则程序退出。同时还会在注册表 HKEY\_CURRENT\_USER\Console\huorong[随机6个字符] 路径下写入 ShellCode 代码并释放文件 C:\\Users\\Public\\Downloads\\ bb.jp。

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xwtm0ltFS4HVhfQhJLlS4DnnziaRnQ91ibbiaIFGE2JiagaLgmAic1y4AqSKlUFraRicl8Ucj8qRllw4Sw/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xJjzdkFvS0QvgbLEI7PB62mLhib8kqaSMhvqXaWqhXY7JEO3diaGJjKzTa14MdWpMHRkBzkgh8ScaQ/640?wx_fmt=png&from=appmsg)

随后再次执行内存中的反射加载代码，加载一个新的 DLL。PE 文件和反射加载代码在同一块内存中。该 DLL 与后面 Win10 及以上版本反射加载的 DLL 相同，hash 均为 c7e2f05d4af536270ea0559ea155b46d，后面会分析此 DLL，此处暂时忽略。

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xJjzdkFvS0QvgbLEI7PB62UFHTRgmB6ObQ6NIuGa90jIwCLGQg3KKhNFnXhTxAUvMOk88Wkpu3Gw/640?wx_fmt=png&from=appmsg)

若正常枚举且发现 360Tray.exe，则会查询当前进程 Token 并获取 Sid 的 SubAuthority 值。

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xJjzdkFvS0QvgbLEI7PB62VOHYjhfzPd0PjxWf2VvNwawIpNkJNS6L1YicofJLwBrvItQgm4Po6SQ/640?wx_fmt=png&from=appmsg)

若获取的值为 0x3000，即 SECURITY\_MANDATORY\_HIGH\_RID(Administrator) 时，同样会将 ShellCode 写入上述注册表键下、释放C:\\Users\\Public\\Downloads\\bb.jpg文件、检测当前进程的文件名称。随后在C:\\Users\\Public\\Downloads 目录下释放 QMPlayer.exe(带签名的白程序)，通过 ShellExecuteW 拉起执行。若通过进程枚举发现成功拉起该进程，则会通过 Restart Manager API 关闭路径为C:\\Program Files (x86)\\360\\360Safe\\safemon\\360tray.exe 的进程。执行完毕后，同样会执行 1 中的 DLL 反射加载，这里不再赘述。

QMPlayer.exe 基本信息如下：

|  |  |
| --- | --- |
| Hash | d31fffb42b84f5ac31aa744df8a23888 [白文件 Signed QMPlayer] |
| 文件类型 | x64, peExe |
| 编译时间 | 2017-12-01 17:05:34 |
| 编译器 | Microsoft Visual C/C++(19.00.24215)[LTCG/C++] |
| 链接程序 | Microsoft Linker(5.10.7303) |

**2.系统版本不低于 Win10**

同样会在注册表 HKEY\_CURRENT\_USER\Console\huorong[随机6个字符] 路径下写入 ShellCode 代码并释放文件 C:\\Users\\Public\\Downloads\\ bb.jpg，检测当前进程的文件名称。随后枚举当前系统正在运行的所有进程，找到 explorer.exe 后通过2023年 Black Hat 披露的 PoolParty 技术，将代码注入到 explorer.exe 进程中。注入方式与传统的远程线程创建注入的方式主要区别在于PoolParty 通过线程池注入其它进程，这在一定程度上能绕过传统杀毒引擎对进程注入的检测。这里不赘述 PoolParty 的技术细节。

注入的代码同样也包含反射加载的 Loader 和同一内存块的 PE 文件。

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xJjzdkFvS0QvgbLEI7PB62NuU7sQmfpNWu1YBA47O93x8VRw8cqOh4LOib6B6Aarv0f6XPWZJ7s5g/640?wx_fmt=png&from=appmsg)

注入后的  explorer.exe 被断住后，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xJjzdkFvS0QvgbLEI7PB621RgFkMyGyhndLeicD55iaiceS0bDQ6sOSiawsInm1lge1iaHhP2FswX7HibA/640?wx_fmt=png&from=appmsg)

反射加载的 DLL 的基本信息如下：

|  |  |
| --- | --- |
| Hash | c7e2f05d4af536270ea0559ea155b46d |
| 文件类型 | x64, peDLL |
| 编译时间 | 2024-09-19 19:59:01 |
| 编译器 | PureBasic |
| 链接程序 | Microsoft Linker(10.00.30319) |

该 DLL 会读取C...