---
title: 从嵌入式系统到网络设备：路由器安全攻防技术详解
url: https://forum.butian.net/share/3995
source: 奇安信攻防社区
date: 2025-01-15
fetch_date: 2025-10-06T20:09:12.963142
---

# 从嵌入式系统到网络设备：路由器安全攻防技术详解

#

[问答](https://forum.butian.net/questions)

*发起*

* [提问](https://forum.butian.net/question/create)
* [文章](https://forum.butian.net/share/create)

[攻防](https://forum.butian.net/community)
[活动](https://forum.butian.net/movable)

Toggle navigation

* [首页 (current)](https://forum.butian.net)
* [问答](https://forum.butian.net/questions)
* [商城](https://forum.butian.net/shop)
* [实战攻防技术](https://forum.butian.net/community)
* [漏洞分析与复现](https://forum.butian.net/articles)
  NEW
* [活动](https://forum.butian.net/movable)
* [摸鱼办](https://forum.butian.net/questions/Play)

搜索

* [登录](https://forum.butian.net/login)
* [注册](https://user.skyeye.qianxin.com/user/register?next=http://forum.butian.net/btlogin)

### 从嵌入式系统到网络设备：路由器安全攻防技术详解

* [硬件与物联网](https://forum.butian.net/topic/51)

物联网（Internet of Things, IoT）的概念最早由英国技术专家凯文·阿什顿（Kevin Ashton）于1999年提出。当时，阿什顿在麻省理工学院（MIT）的自动识别中心（Auto-ID Center）工作，旨在研究将物理对象通过互联网连接起来，以实现更有效的供应链管理

物联网（Internet of Things, IoT）的概念最早由英国技术专家凯文·阿什顿（Kevin Ashton）于1999年提出。当时，阿什顿在麻省理工学院（MIT）的自动识别中心（Auto-ID Center）工作，旨在研究将物理对象通过互联网连接起来，以实现更有效的供应链管理。阿什顿首次在演讲中使用了“物联网”这一术语，用以描述一个新的技术生态系统，其中的对象能够通过互联网互相连接和交换数据，实现智能化。物联网设备已经广泛渗透到生活的各个领域，如家庭摄像头、智能灯泡、智能手表、智能门锁、智能电表和水表等。然而，随着物联网的快速发展和普及，安全隐患也日益凸显，而路由器是物联网的核心，它主要作用与物联网内设备的互联互通，其重要性也越发重要。
什么是MIPS指令集
==========
MIPS（Microprocessor without Interlocked Pipeline Stages），是一种采取精简指令集（RISC）的指令集架构（ISA），最早的MIPS架构是32位，最新的版本已经变成64位。MIPS汇编语言是用于编写MIPS（Microprocessor without Interlocked Pipeline Stages）架构微处理器指令的低级语言，常见于路由器，MIPS架构是一种典型的精简指令集计算机（RISC）体系结构，最初由斯坦福大学的John Hennessy在1980年代初期设计，目的是为了实现高性能的处理器设计，通过使用简单的指令集来加速指令的执行速度。MIPS架构和汇编语言被广泛用于各种设备和应用中，包括嵌入式系统、路由器、微控制器以及视频游戏控制器等。
MIPS常见寄存器与逻辑运算指令
----------------
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-c8f372b967272b31793e85b31b69d9beb51f2803.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-0d1f4e4a1875926fd051b31f2ca74dc6ab7554c2.png)
叶子函数（Leaf Function）与非叶子函数（Non-Leaf Function）
--------------------------------------------
在MISP（Malware Information Sharing Platform &amp; Threat Sharing）中，叶子函数和非叶子函数是用于描述事件对象的两种不同类型函数，叶子函数是指在其执行过程中不调用其他函数的函数。这意味着叶子函数只执行操作而不“分支”到程序的其他部分。由于叶子函数不进行任何函数调用，它们通常直接执行计算或操作，然后返回结果。这种函数的特点是执行路径简单，资源需求相对可预测。
叶子函数的特点：不包含对其他函数的调用。执行过程中不需要为其他函数调用保留额外的栈空间。通常执行时间较短，资源使用较少。
```php
int leaf\_function(int x) {
return x \* 2;
}
```
在这个示例中，leaf\\_function 是一个叶子函数，它只是简单地对参数 x 进行乘以 2 的操作并返回结果
非叶子函数是指在其执行过程中至少调用一个其他函数的函数。这种函数的执行可能依赖于它调用的其他函数的结果。非叶子函数可能涉及更复杂的逻辑和操作，执行路径可能因为其中包含的函数调用而变得复杂。
非叶子函数的特点：包含至少一个对其他函数的调用。执行过程中需要为被调用的函数分配栈空间。由于包含函数调用，其执行时间和资源使用可能不如叶子函数容易预测
```php
int non\_leaf\_function(int x) {
int y = leaf\_function(x);
return y + 1;
}
```
在这个示例中，non\\_leaf\\_function 是一个非叶子函数，因为它调用了 leaf\\_function 函数
如果在非叶子函数里利用栈溢出漏洞控制$ra寄存器构造ROP链， 调用一次sleep函数来清空$ra寄存器 ，sleep函数在MIPS汇编操作如下
```php
li $a0,1
```
QEMU（Quick EMUlator）
--------------------
QEMU（Quick EMUlator）\[2\]是一个开源的虚拟机监控器（hypervisor）和仿真器，它可以在多种架构上执行客户机操作系统。QEMU最初由Fabrice Bellard开发，并且在GNU通用公共许可证（GPL）下发布的。QEMU允许用户模拟完整的计算机系统，包括处理器和各种外设，这样可以在一个主机系统上运行一个或多个客户操作系统。
QEMU既可以作为虚拟机监控器，也可以作为仿真器使用。作为虚拟机监控器，QEMU能够创建并管理虚拟机，允许在宿主系统上同时运行多个客户机操作系统。作为仿真器，QEMU可以模拟处理器架构，允许在一个系统上运行不同架构的二进制程序。它也支持多种硬件架构，包括 x86、ARM、MIPS、PowerPC、SPARC 等。这使得QEMU成为跨平台的工具，可以在不同体系结构之间执行虚拟化和仿真。
在linux平台上执行这个命令可以安装QEMU
```php
sudo apt install qemu-user-static
```
这个命令会默认安装全部的QEMU模拟架构工具，QEMU工具的命名都有其特殊意义，这里以qemu-aarch64-static举例
qemu：代表这个工具是QEMU仿真器的其中一种
aarch64：指的是 ARMv8 架构的 64 位模式，也就是现代 ARM 处理器的 64 位架构（如在许多智能手机、平板电脑和一些服务器中使用的处理器）。aarch64 是 ARM 64 位指令集的一种通称，用于区分早期的 32 位 ARM 指令集（ARMv7 及之前，通常称为 armhf 或 armel）
static：意味着这个 QEMU 的可执行文件是静态链接的。静态链接的二进制文件包含了运行程序所需的所有库的副本，这意味着它不依赖于系统上的共享库。这种方式使得该可执行文件可以在没有安装必要库的系统上运行，增强了其在不同环境中的可移植性和使用的灵活性
栈溢出
===
什么是栈溢出
------
栈溢出（Stack Overflow）是一种常见的软件安全漏洞，发生在程序的栈内存区域分配不当时，特别是当程序试图向栈写入超过其分配空间的数据时。栈是操作系统为程序运行时分配的一块连续内存区域，用于存储局部变量、函数参数、返回地址等
简单来说，在程序运行时，系统会为程序在内存里生成一个固定空间，如果超过了这个空间，就会造成缓冲区溢出，可以导致程序运行失败、系统宕机、重新启动等后果。更为严重的是，甚至可以取得系统特权，进而进行各种非法操作
这个栈空间里会存放用户输入的一些值和寄存器里的值，栈溢出攻击就是我们输入的字符覆盖掉了特殊的寄存器里的值，控制特殊的寄存器，从而达到控制程序执行流的一个效果
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-9899673127104ebbcd8251c63fa45db6fd7482f7.png)
以上图为例，左边代表的是一个正常的栈空间，右边是受栈溢出攻击后的栈空间，原本的Return address指针指向的是栈上其他正常的内存地址，由于被栈溢出攻击，原本指针指向的内存地址被覆盖了，变成攻击者存放Shellcode的地址，导致程序执行Shellcode
所以栈溢出可以导致程序异常终止或行为不稳定。当栈空间被耗尽或栈内存被恶意字符覆盖时，程序可能无法继续正常执行，导致崩溃。这不仅影响用户体验，也可能导致数据丢失或损坏。更严重的是，栈溢出可以被恶意利用来破坏程序的安全性，执行任意代码
路由器产生漏洞常见的函数
------------
### strcpy
strcpy是C语言标准库中的一个函数，其原型定义在 &lt;string.h&gt; 头文件中。该函数用于将一个字符串复制到另一个字符串中，虽然 strcpy 在字符串操作中非常常用，但它也带来了显著的安全隐患，主要是因为它不检查目标缓冲区的大小，这可能导致缓冲区溢出
如果源字符串的长度超过了目标缓冲区的大小，strcpy 会继续复制字符到目标缓冲区之外的内存区域，这会覆盖和破坏相邻的内存，导致数据损坏、程序崩溃，甚至可能允许攻击者执行任意代码
### system
system是C语言标准库中的一个函数，用于在当前程序中执行一个命令行指令。它的原型定义在 &lt;stdlib.h&gt; 头文件中，允许程序调用外部程序或执行 shell 命令，虽然 system 函数为程序提供了执行外部命令的强大功能，但它也可能造成命令注入攻击：如果 system 函数的输入来自不可信的用户输入，攻击者可能会注入恶意命令，导致程序执行未授权的命令。这可能会泄露敏感信息、破坏系统或为攻击者提供系统访问权限
system 函数创建的子进程会继承其父进程（即当前程序）的用户权限。如果程序以高权限（如 root 用户）运行，那么通过 system 执行的命令也将具有这些权限，从而可能被滥用来执行危险的操作
### scanf
scanf是C语言中用于从标准输入读取字符串并将其存储到变量中的函数。它是C标准库 &lt;stdio.h&gt; 中的一部分。scanf允许程序员指定输入的格式，以便正确地解析并将其转换为指定类型的数据。然而，scanf也存在一些安全隐患，使用%s格式读取字符串时，如果输入的字符串长度超过了目标缓冲区的大小，会覆盖相邻的内存，就会造成缓冲区溢出
路由器栈溢出漏洞研究
==========
提取固件内的文件
--------
路由器的升级安装包通常都是一个.bin文件，需要用到binwalk工具来提取固件里的文件，执行命令
```php
binwalk -eM 固件名称.bin --run-as=root
```
可以提取指定固件内的文件，-eM参数的作用是分析的文件中查找并提取发现的文件，--run-as=root参数的作用是以root权限去提取固件内的文件
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-26334eda02f4e8652c2cf634b0341e23e1fbd6f9.png)
提取完成之后，binwalk会在当前活动文件夹下自动生成一个文件夹，这个文件夹里存放的就是固件内的文件，固件里存储的是一个linux系统，进入文件夹后可以看到其中的文件
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-b364da9a5327cb60860e3000938ccf3b410b31ac.png)
静态分析交互程序
--------
路由器与用户交互的程序通常存储在bin目录下，在本文案例中，这个程序名称为httpd，其主要作用是实现路由器的Web界面管理功能。这个Web界面管理可以通过浏览器访问，让用户可以通过图形化界面来配置和管理路由器的各种功能和设置。
分析程序需要用到Ghidra工具，Ghidra是一款强大的逆向工程工具，用于分析、逆向软件与固件，将httpd程序导入Ghidra后，可以分析程序的汇编代码与Ghidra通过汇编代码生成的C语言代码
将httpd程序导入ghidra后按住ctrl+shift+e，呼出搜索界面，搜索strcpy函数，除了strcpy函数，也可以搜索system函数寻找RCE漏洞
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-9baf51b66dc20de5f9a1a6b721c02cf1d8fe0741.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-4b2f22cba9ae8666a59c68f56b9cef302b0885fb.png)
上图就是程序调用了strcpy的地方，点击就能看到对应函数伪代码
通过静态分析，会发现程序内的saveParentControlInfo函数调用了危险函数strcpy
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-13c73a6195e752550ca93db730090073f4ff5100.png)
首先，程序调用了compare\\_parentcontrol\\_time函数，在compare\\_parentcontrol\\_time函数中，函数获取了名为time的参数名，并将参数的值赋予了\*\*s变量里，如果\*\*s变量是空的值，那么uVar1=1了，程序最下面return的就是uVar1这个变量，如果uVar1=1，那么无法进入父函数的if判断里，所以这里不能使\\_\\_s变量为空，要传入time参数名
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-778871801196760fc23a7faf45cfb1c463fba1f7.png)
compare\\_parentcontrol\\_time函数返回父函数saveParentControlInfo函数后，传入time参数进入if判断，程序有调用了get\\_parentControl\\_list\\_Info函数，程序这里刚好获取了一个名为time的函数，然后在下面使用了strcpy函数将\*\*src\*\*00变量里的值复制到parm\\_2+2的地址里，strcpy这个函数不会检测字符串的长度，很容易造成栈溢出
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-5318789f03796859f083724fc393de2f9813614e.png)
最后，交叉定位找到调用saveParentControlInfo函数的路由saveParentControlInfo和web路径goform，只要使用time参数传入过长的字符串就会造成栈溢出
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-faa230cd950dffe4cf7f429462a2546766e02999.png)
payload:
```php
import requests
url = "http://路由器ip/goform/saveParentControlInfo"
data = {
"time":b'A'\*10000
}
res = requests.post(url=url,data=data)
```
QEMU环境模拟与破解环境检测函数
-----------------
因为这个路由器是MIPS架构的，我们用QEMU搭建仿真环境时，就要使用这个工具qemu-mipsel-static
```php
qemu-mipsel-static -L . ./bin/httpd
-L .: 这个选项告诉 QEMU 在指定的目录（在这个例子中是当前目录，表示为 .）中寻找系统库和其他必要的文件
```
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-331df0a231812f9f3b13278d7f74b27cada21275.png)
但是在运行程序时会发现它一直卡在Welcome to字符串处，将文件导入ida
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-a13372fc71f344e6cab461276b322c491616da28.png)
按shift+f12可以查找程序内所有的字符串...