---
title: 企业上云的新攻击面分析
url: https://mp.weixin.qq.com/s?__biz=Mzg2MDY2ODc5MA==&mid=2247484101&idx=1&sn=eb8769f08a921e7fd668ec522ee48faa&chksm=ce2394dcf9541dca21c06496b40926e4dc79f22f6de396e0cdc032e8e81898f480591b9cafbd&scene=58&subscene=0#rd
source: 银针安全
date: 2024-12-19
fetch_date: 2025-10-06T20:01:30.430399
---

# 企业上云的新攻击面分析

![cover_image](https://mmbiz.qpic.cn/mmbiz_jpg/HwHmjibphiaE1xIricFGUxesWoAnUricIcGPtvSib1rcU1JVr1c0mBhcGBvwczw1uGbyWzZ2kDy0d0K7Wz8mAe5IpBw/0?wx_fmt=jpeg)

# 企业上云的新攻击面分析

原创

Ape1ron

银针安全

**注1：本文引用的实际案例均来自业界公开渠道。**

**注2：同一类云服务、功能在不同的云厂商可能叫法不同，例如AWS IAM和阿里云 RAM本质上是一个东西，本文默认使用AWS的定义。**

### 目录：

* • 前言
* • 攻击面概要
* • 云服务漏洞

+ • 跨租户漏洞

- • 租户资源实例隔离缺陷
- • 云服务管理面失陷
- • 云服务内部账号凭据泄露
- • 跨租户越权访问
- • 云服务引入的供应链攻击

+ • 非跨租户漏洞

- • 资源实例内的漏洞
- • Agent漏洞
- • 各类oneclick漏洞

* • 高风险的云特性

+ • 云服务角色引入的提权路径
+ • 利用云平台内部IP打破网络隔离
+ • 隐式API
+ • 共享父域引入的风险
+ • 云凭据即运维系统
+ • 可将攻击技术应用于云服务

* • 错误的云配置

+ • 对象存储使用不当
+ • AWS Cognito配置不当

* • 写在最后
* • 参考

# 一、前言

按照笔者的理解，我们常谈的云安全实际包含了两大方面：云平台自身的安全，以及云上租户的安全。**本文主要目的是探讨后者，也即企业上云后，相较于传统IDC等环境，作为云上租户面临的一些新攻击面**。

不过云平台自身的安全是租户安全的基石，因此即便是探讨云上租户的安全，谈及云平台安全/云服务漏洞也是无可避免的。

# 二、攻击面概要

在分析攻击面之前，需要先了解“云安全责任共担模型”，这是划分云厂商和租户责任边界的协议。

简单来说，不同类型的云服务有不同安全责任边界，例如IaaS类型的云服务，从操作系统开始都由租户自行负责，如果出了个系统漏洞，原则上需要由租户自行升级打补丁。

借用GCP的一张图（https://cloud.google.com/learn/paas-vs-iaas-vs-saas），对多种类型的云服务的责任边界进行了划分。

![](https://mmbiz.qpic.cn/mmbiz_png/HwHmjibphiaE1xIricFGUxesWoAnUricIcGPfIS9IFdN8ib8hIz6A4PfZjrBMFGm68gT1SdEo2WTQGMrNJQDvR5yzDQ/640?wx_fmt=png&from=appmsg "null")

不过从笔者的经验来看，实际的安全责任边界并没有想象中的清晰：)，会有一些模糊的地方。

这里笔者将云上租户面临的攻击面划分为三大块：

* • **云服务漏洞**：直接或间接影响租户；责任方在云平台
* • **错误的云配置**：一般由于租户不熟悉云服务的机制导致，直接影响租户；责任方在租户
* • **高风险的云特性**：云平台或云服务的底层设计机制导致，默认扩大了租户的安全风险；这里正是责任边界最模糊的地方。

![](https://mmbiz.qpic.cn/mmbiz_png/HwHmjibphiaE1xIricFGUxesWoAnUricIcGPVlToLbS7b42WjYWadjvlwe2CgR8vy03OKt2xDW4JxWrUT2QE3fJhaA/640?wx_fmt=png&from=appmsg "null")

下面会对每一类攻击面展开说明，并引入1-3个案例或示例辅以分析。

# 三、云服务漏洞

常见的云服务漏洞类型包括：

* • **传统漏洞**：命令注入、代码沙箱逃逸、越权访问、SSRF等
* • **云原生组件漏洞**：容器逃逸、K8s集群接管等
* • **虚拟化漏洞**：虚拟机逃逸、虚拟化网络隔离打破等
* • **内部凭据泄露**：云服务内部账号、私有镜像仓库凭据等
* • **云服务Agent漏洞**：本地提权、敏感信息泄露等
* • **软件云服务化保留的高风险功能**：PostgreSQL命令执行、kubeconfig引入插件执行命令、terraform配置文件引入外部模块执行命令等
* • **云服务IAM使用不当**：混淆代理人、IAM提权等
* • **云服务功能缺陷**：云日志记录缺失、云WAF通用绕过等

但正如前面所提，本文探讨的核心是云上租户的安全，相较于云服务漏洞类型，更关心云服务漏洞如何影响租户。从这个角度出发，笔者粗暴地将云服务漏洞划分为两类:

1. 1. **跨租户漏洞**：这类漏洞意味着攻击者无需其他前置条件，可利用漏洞直接影响云上租户

* • **租户资源实例隔离缺陷**->跨租户访问资源实例
* • **云服务管理面失陷**->用运管能力接管租户的资源实例
* • **云服务内部账号凭据泄露**->用云服务账号获取租户授权角色的凭据，进而接管租户的资源实例
* • **跨租户的越权访问**->直接获取数据或权限
* • **云服务引入的供应链攻击**->租户使用云服务提供的sdk、镜像等被注入恶意代码

2. 2. **非(直接)跨租户漏洞**：只能在当前租户或资源示例内实现类似"提权"的能力，要实际影响到租户，还需要先从其他途径获得目标租户内的一个"驻点"。

* • **资源实例内的各类漏洞，但未能打破租户隔离**
* • **云服务角色引入的提权漏洞**
* • **云服务Agent引入的本地提权或信息泄露**
* • **云服务功能缺陷，影响租户的资源实例或开发的应用**
* • **租户内的越权访问**

**资源实例**：**云服务为租户提供的最小资源单位**，不同云服务各不相同，例如EC2是一台VM，EKS是一个K8s集群。

## 3.1 跨租户漏洞

### 3.1.1 租户资源实例隔离缺陷

隔离是云安全的基石，但不同云服务为租户所提供的资源实例的隔离强度往往是不同的，即便是同一类型的云服务，出于资源利用率、部署成本、运管方式等各种因素的考量，隔离强度都可能大不相同。

根据笔者的经验，云服务资源实例的常见隔离方案，以及所对应打破隔离所需要的能力如下所示：

![](https://mmbiz.qpic.cn/mmbiz_jpg/HwHmjibphiaE1xIricFGUxesWoAnUricIcGPNDQQb7DBb0ptwpHEfn8dCQLKkicQEPQIzbicnhbwGNBEgnZFfjpv2Gag/640?wx_fmt=jpeg&from=appmsg "null")

画板

实际情况可能会比上图更复杂一些，但隔离强度的趋势是大致相同的，同一水平线上的隔离方案可能各有千秋，打破隔离的方式也有所不同。

#### 两个对比案例

来看两个来自微软Azure和谷歌GCP的案例：

![](https://mmbiz.qpic.cn/mmbiz_png/HwHmjibphiaE1xIricFGUxesWoAnUricIcGPMfzibCiaB8ooKxLgsxgialfCicr8ia34nK0keGxibWArVT7JbpDg2fvCNFCA/640?wx_fmt=png&from=appmsg "null")

![](https://mmbiz.qpic.cn/mmbiz_png/HwHmjibphiaE1xIricFGUxesWoAnUricIcGPVAYkIIYGZUjVnIr0JgicSaLQia8iaImCAtAVbwCGYgOgr04zxr5RQicGlw/640?wx_fmt=png&from=appmsg "null")

* • 图一，Azure：https://www.wiz.io/blog/wiz-research-discovers-extrareplica-cross-account-database-vulnerability-in-azure-postgresql
* • 图二，GCP：https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities

PostgreSQL在9.3版本开始提供`copy from program`语句，支持执行系统命令，而各大云厂商都通过对数据库用户降权的方式来做限制。

两个漏洞的过程其实是非常类似的，都先进行了数据库用户提权，然后再利用`copy from program`获得了容器的权限，在GCP上甚至完成了容器逃逸，得到了宿主机的权限，但最终却只在Azure上完成了跨租户的攻击。**核心区别就在于资源实例的隔离强度，Azure上并没有实施网络隔离**。

#### 小结

这两个案例都是wiz团队公开的，近几年有多个安全团队针对不同云厂商的云数据库做了一系列的测试，以下是一些公开的案例：

* • 阿里云：数据库集群失陷，可实现跨租户接管数据库，https://www.wiz.io/blog/brokensesame-accidental-write-permissions-to-private-registry-allowed-potential-r
* • IBM Cloud：不同租户的数据库实例通过K8s namespaces隔离，漏洞只能控制当前租户所在的namespace，没能实现直接跨租户接管数据库实例。但泄露了内部容器镜像仓库和制品仓库的凭据，并测试了可覆盖任意数据库实例上的安装包，证明可通过供应链实现跨租户的影响，https://www.wiz.io/blog/hells-keychain-supply-chain-attack-in-ibm-cloud-databases-for-postgresql
* • AWS：云服务内部账号凭据泄露，未进一步验证是否有跨租户影响，https://blog.lightspin.io/aws-rds-critical-security-vulnerability
* • Azure：网络隔离缺陷，可实现跨租户接管数据库，https://www.wiz.io/blog/wiz-research-discovers-extrareplica-cross-account-database-vulnerability-in-azure-postgresql
* • GCP：均没有提及跨租户的影响，在最后一个案例中提到了可以访问内部镜像仓库，但未进一步说明读写权限、也未说明对租户的实际影响，https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities、https://www.ezequiel.tech/2020/08/dropping-shell-in.html、https://www.dig.security/post/gcp-cloudsql-vulnerability-leads-to-internal-container-access-and-data-exposure

在GCP的三个公开案例中，分别涉及GCP云数据库中的PostgreSQL、MySQL、SQL Server，但都没有出现直接跨租户的影响。

从案例中进一步分析GCP云数据库的部署方式和隔离方案，会发现GCP和其他云厂商最大的不同点在于：其他云厂商都是在K8s集群的基础上进行部署，数据库实例通过pod的形式提供，隔离方案也依赖于K8s的机制，而GCP虽然也通过容器来提供数据库实例，但上层似乎并没有使用K8s，每个租户的容器都部署在独立的VM，真正的隔离边界是在上层VM，并且在VM之间也进行了网络隔离。

似乎谷歌认为将容器作为云服务、至少是数据库这类高敏感云服务的隔离边界是不足的？

后面在Hacker news上面看到了一篇帖子：https://news.ycombinator.com/item?id=36086858，里面有一些声称为GCP员工或前员工的人的提到谷歌似乎特别认为容器边界并不安全，将数据库放入独立的VM也是服务演进的结果，这也从侧面印证了上述猜想。

![](https://mmbiz.qpic.cn/mmbiz_png/HwHmjibphiaE1xIricFGUxesWoAnUricIcGPkNjMRPAFFDrsDCQXb9EITES7icbwgiaHejDNCGAcSibdkn26hwQnxP2fw/640?wx_fmt=png&from=appmsg "null")

当然，这里并不是完全否定通过容器来作为云服务资源实例的隔离边界，也无意拉踩各个云厂商（毕竟一类案例也很难有说服力，部分云服务会提供私有资源版本和公用资源版本，这可能也是差异点之一）。

**笔者只是想强调隔离强度的重要性，不同云厂商在设计同类云服务的底层架构时并没有统一的标准**，甚至同一个云厂商下的同类服务也大有不同，也很少有看到某个云服务明确声明自己提供了什么级别的隔离强度，这对云厂商和租户来说都是一个挑战：

* • 于租户而言，在选用云厂商/云服务的时候，没有一个合适和公开标准来评估云服务的安全性
* • 于云厂商而言，云服务在架构设计时如何平衡经济成本和隔离强度似乎也没有一个权威的标准

### 3.1.2 云服务管理面失陷

#### 案例一（ChaosDB）：接管Azure Cosmos DB云服务

![](https://mmbiz.qpic.cn/mmbiz_png/HwHmjibphiaE1xIricFGUxesWoAnUricIcGPqCKHfl8icSAquIUaOFDNTvwA87oAffLOpZ6Ezib7unfBDmu8OVAgLyow/640?wx_fmt=png&from=appmsg "null")

* • **原文**：https://www.wiz.io/blog/chaosdb-explained-azures-cosmos-db-vulnerability-walkthrough
* • **服务介绍**：Cosmos DB 是微软 Azure 提供的一种分布式、多模型的数据库服务。支持多种数据模型，包括文档、键值、图形和列族等。该服务在2019年引入了jupyter，租户可使用jupyter对Cosmos DB的数据进行可视化，这个功能在2021年默认开启。
* • **影响**：控制了部署Cosmos DB资源的底层集群，相当于接管了Cosmos DB服务，可访问任意租户的cosmos数据库。

#### 案例二（I Own your Cloud Shell）：Azure跨租户接管CloudShell

![](https://mmbiz.qpic.cn/mmbiz_png/HwHmjibphiaE1xIricFGUxesWoAnUricIcGPXBtUysG6BWKib8OXQRgoic3LnZpibicxrhzyZdowrJhicDKWGUGuD3dXmnA/640?wx_fmt=png&from=appmsg "null")

* • **原文**：https://hencohen10.medium.com/i-own-your-cloud-shell-taking-over-azure-cloud-shell-kubernetes-cluster-through-unsecured-558621519cf9
* • **服务介绍**：用过公有云的小伙伴应该都很熟悉CloudShell，它是通过浏览器提供的Shell，预装了一些工具，往往在控制台的首页就能直接点击使用，供用户便捷体验、使用和管理云上资源，一般就是一个容器环境，Azure的CloudShell也是类似的。
* • **影响**：控制攻击者CloudShell所处的k8s集群，导致任意租户的CloudShell被接管。

#### 小结

集群被控制是管理面失陷最常见的场景，容器在云环境中被广泛使用，因此K8s这类容器编排服务事实上会充当某些云服务的"资源管理系统"。获得了K8s集群的权限，往往就相当于控制了云服务提供实例的底层计算资源。除此以外还有几类场景：

* • 用云服务构建云服务是各个云厂商常见的做法，因此底层云服务B失陷会影响上层云服务A，此外云服务A要使用云服务B必然要有对应的账号，这个内部账号泄露了也有可能导致管理面失陷。
* • 云服务背后的运维平台和CI/CD系统。

### 3.1.3 云服务内部账号凭据泄露

有云平台有两个典型的场景：

* • **跨租户访问**：租户A访问租户B的云上资源
* • **跨云服务访问**：云服务P访问租户在云服务Q上购买的资源

为了满足这两类场景，各个云服务厂商都有相关的方案。由于两个场景本质上都是一类"授权问题"，因此很"巧合"，大部分云服务厂商都设计了一套方案来同时解决两个场景：

* • AWS：**IAM角色**，角色的实体可以是AWS账号，也可以是AWS服务。
* • GCP：**IAM服务账号**，GCP的授权机制和其他云厂商有所不同。
* • 阿里云：**RAM角色**，角色的实体可以是阿里云账号，也可以是阿里云服务。
* • 华为云：**IAM委托**，被委托方可以是华为云账号，也可以是华为云服务。
* • 腾讯云：**CAM角色**，角色的实体可以是腾讯云账号，也可以是腾讯云服务。

![](https://mmbiz.qpic.cn/mmbiz_png/HwHmjibphiaE1xIricFGUxesWoAnUricIcGP6eOvVZE2GRzvEdlv6nsp4jVHniaFCAgIbHEnZYR7AicsQlPDiccAicISHQ/640?wx_fmt=png&from=appmsg "null")

在跨租户的场景，角色的实体是租户账号，我们很容易想到：如果租户A授权了租户B，一旦租户B的云凭据泄露了（有足够权限），那么攻击者就能顺藤摸瓜攻击租户A。

**但创建一个实体是云服务的角色，这个动作背后的含义是什么呢？我们把代表云服务的实体也看作了一类特殊的租户账号，就很好理解了**。这类账号也被IAM所管理，遵循IAM的规则，可以用这个账号的凭据来调用IAM的接口。也即：无论可信实体是AWS服务还是AWS账户，本质都是授权给某个租户账号，只不过AWS服务的账号是相对特殊的。

**事实上也的确如此，本文将这类特殊的租户账号称为云服务内部账号（不同的云厂商可能叫法不同，但本质上应该是一样的）。当这类云服务内账号的凭据泄露了，就可以复用跨租户的攻击方式，例如利用云服务内部账号凭据通过AssumeRole API获取租户的临时凭据，进而攻击租户。**

#### 案例一（Superglue）：获得AWS Glue服务内部账号凭据，代入任意Glue服务的用户的对应角色，...