---
title: 我只是想要一个简单轻量的 K8s 镜像预热而已！
url: https://github.red/forklift/
source: Light Cube
date: 2023-03-16
fetch_date: 2025-10-04T09:42:15.574101
---

# 我只是想要一个简单轻量的 K8s 镜像预热而已！

[![logo](/images/logo.svg)](/)

[é¦é¡µ](/)

[å³äºæ](/about-me/)

[ç»æçè¨](/guestbook/)

[åé¾](/my-friends/)

[æç« å½æ¡£](/archive/)

[æ´æ°æ¥å¿](/update-history/)

![æåªæ¯æ³è¦ä¸ä¸ªç®åè½»éç K8s éåé¢ç­èå·²ï¼](https://img10.360buyimg.com/da/jfs/t1/167684/29/40948/49584/65d4df17Fab157920/17cc127dd36922f8.png.webp)

## æåªæ¯æ³è¦ä¸ä¸ªç®åè½»éç K8s éåé¢ç­èå·²ï¼

[2023-03-15](//forklift//)â¢
[åæ](/categories/%E5%88%9B%E6%84%8F/)
â¢
4415 å­ / 9 åé

æè¿ä¸ä¸ªå¤æï¼æççæ´»åçäºå¾å¤§çåå¨ã2 æ 15 æ¥å ä¸ºä¸ç´ä»¥æ¥ç§¯æçæç»ªï¼å¿æå¾å·®ãé£å¤©æ·±å¤ææäºç¦»èï¼ç¦»å¼äºä»é¶å¼å§ä¸ç´å¹²äºä¸¤å¹´å¤çå¬å¸ã

åé¢åæ¯å ä¸ºä¸äºä¸æ¹ä¾¿æè¯´çåå ï¼ç»è¥äºä¸¤å¹´å¤ç NekoBox è¢«è¿«å³ç«ãä¹åæä¼éå¯¹è¿ä¸ªäºæä¸é¨åä¸ç¯æç« ï¼è¯´æèåå°åºåçäºä»ä¹ï¼ä»¥ååäº«è¿ä¸¤å¹´æ¥çå¿å¾ä½ä¼ï¼åæ¶ç»ä¹åèç¨æ·æä¾æ°æ®å­æ¡£ååçæ¸ éãæ´ä»¶äºæåççæºçªç¶çï¼å¯¹æèè¨ä¹ç®æ¯ä¸ç§äººçä½éªå§ï¼ååã

ä»å¤©æ³è¦åäº«çï¼æ¯ Cardinal Pro å¹³å°å¨ä»å¹´ HGAME 2023 æ¯èµæ¶éå°çä¸ä¸ªé®é¢ï¼ä»¥åæç»åºçè§£å³æ¹æ¡ï¼å¯è½ä¸æ¯å¾å®åï¼è¿è¯·åä½å¤å¤æç¹ã

## è¯¶ï¼ææ°å çèç¹æä¹ä¸è½ç¨ï¼ï¼

ä»å¹´ç HGAME 2023 æ¯åä¼ç¬¬ä¸æ¬¡ä½¿ç¨æå¼åç Cardinal Pro å¹³å°ä¸¾åï¼ç¸æ¯ä¹åä½¿ç¨ PHP å¼åçå¹³å°ï¼æå¤§çç¹è²å°±æ¯å¹³å°æ¯æåºäº Kubernetes å¨æå¯åéæç¬äº«é¶æºï¼ç¸æ¯ä¹åç±åºé¢äººåç¬ä½¿ç¨åèªçå­¦çæºé¨ç½²å±äº«é¢ç®ç¯å¢ï¼æäºè´¨çé£è·ã

> è¿éææ­ä¸æ¡å¹¿åï¼å¦æä½ æç¸å³æ¯èµ / å¹è®­éæ±ï¼æ³ä½¿ç¨ Cardinal Pro åä¸ç«èµå¹³å°ï¼æ¬¢è¿èç³»[æ­å·åæ­¦ç§æ](https://lwsec.cn/)~

è·å¾å¹´çåä¼å¯åææ°èµä¸æ ·ï¼HGAME 2023 æ¯ä¸ä¸ªé¿è¾¾ä¸ä¸ªæçæ¯èµï¼ç»åä¸ºåå¨åç¬è®¡ç®æåï¼å¯¹åºå°æ¯èµå¹³å°éå°±æ¯ååºæ¯èµãåèµäººæ°ä¹æ¯éå¨éåï¼è½åæå°æåçæ°çï¼ææå¯è½æºè¿æåçæ»å³èµãæä»¥å¯¹äºå¹³å°èè¨ï¼æä»¬è¦åºå¯¹çå°±æ¯æ¯èµåå¼å§æ¶ç¬¬ä¸å¨ççªåæµéä»¥åéæå¨æé¶æºå¼å¯éæ±ã

å¨ç¬¬ä¸å¨çæ¶åï¼è¿ç»´çåå­¦æ¥çéç¾¤ç¶æåç°éç¾¤å Pod æ°éè¾å¤ï¼èç¹ç¸å¯¹ååè¾å¤§ï¼å æ­¤æ°å äºä¸ä¸ªèç¹è¿éç¾¤ãç¸å¯¹åºçï¼åé¢å¼å¯çé¢ç®é¶æºä¹å°±ä¼è¢« K8s ä¼åè°åº¦å°æ°å¼çç©ºé²èç¹ä¸ãç¶åé®é¢å°±åºç°äº ââ å¹³å°ä¸éæé¢ç®ç¯å¢ä¸ç´å¼ä¸èµ·æ¥ï¼æåè¶è¿è®¾ç½®çè¶æ¶æ¶é´ï¼åç«¯è¿åæ¥éã
ç»è¿ææ¥åç°ï¼æ¯å ä¸ºæ¬æ¬¡æ¯èµä¸ºäºå°½å¯è½çèçº¦ææ¬ï¼éç¾¤å¤§å¤ä½¿ç¨è¾¹ç¼èç¹ï¼æä¸äºèç¹çç½ç»ç¯å¢å¯è½å¶å°æ½é£ï¼å¯¼è´æ æ³è¿æ¥ä¸éåæºæåéåãå½æ¶ä¸´æ¶çè§£å³æ¹æ¡æ¯éæ°æ¢äºå¶ä»ç½ç»æ­£å¸¸çè¾¹ç¼èç¹æåã

åæ¥è®¨è®ºäºä¸ï¼è®¤ä¸ºéç¾¤åéè¦æä¸ªéåé¢ç­çåè½ï¼æåå°éè¦ç¨å°çéåæåå°æ¬å°ãå ä¸ºæµéé«å³°å°±æ¯å¨æ¯èµåæï¼è¿æ¶å¾å¾ä¹æ¯ç¬¬ä¸æ¬¡æåéåï¼ä¸ç¸å°±ä¼ç¸ä¸çå¾å½±åç¨æ·ä½éªã

## ç°æçè½®å­å¤ªéäº

æç´¢äºä¸ç¸å³çèµæï¼åç°é¿éå¼æºç [Dragonfly](https://d7y.io/) å [Openkruise](https://openkruise.io/) é¡¹ç®é½æ¯æéåé¢ç­çåè½ã

### Dragonfly

Dragonfly æ¯ä½ä¸ºä¸ä¸ª P2P æä»¶ååç³»ç»è¢«è®¾è®¡åºæ¥ï¼æåçç®çæ¯ä¸ºäºæ¯æååä¸èåçæå¡å¨é´å¤§è§æ¨¡çæä»¶ååéæ±ãèå®¹å¨éåæ¬è´¨ä¸ä¹æ¯å­å¨ç£çä¸çä¸å±å±æä»¶ï¼æä»¥ä¹å°±é¡ºå¸¦æ¯æäºãå·ä½çä»ç»æç« å¯ä»¥çè¿ç¯ï¼[ãç´å»é¿éå11ç¥ç§ææ¯ï¼PBçº§å¤§è§æ¨¡æä»¶ååç³»ç»âè»èâã](https://developer.aliyun.com/article/244897)ã
ä½æ¯å½ææ­£åå¤éæ©æ­å»º Dragonfly æ¶ï¼æåç°è¿ä¸è¥¿æ­èµ·æ¥åè¿éè¦ Redis å MySQLï¼ï¼ï¼ä»¥åå®å¯¹äº Docker è¿è¡æ¶çéåååï¼è¿éè¦æç¼è¾ `/etc/docker/daemon.json` æä»¶æ·»å ç§æçéåæºå¹¶éå¯ Docker è¿è¡æ¶ã
è¿ç§ä¾µå¥å¼å¤ªå¼ºçéç½®æå¹¶ä¸åæ¬¢ï¼å æ­¤æ¾å¼äºä½¿ç¨ Dragonflyã

### Openkruise

æå¨æèªå·±çéç¾¤éä½¿ç¨äº Openkruise æ¥ç» Elaina ä»£ç è¿è¡å¨åå®¹å¨é¢ç­ï¼ç¸æ¯ Dragonfly çèªå·±å¯å¨äºä¸ä¸ª HTTP ä»£çä½ä¸ºç§æéåæºï¼Openkruise åæ¯å®ä¹äºä¸ä¸ªåä¸º `ImagePullJob` ç CRD (Custom Resource Define) å®å¶èµæºç¨äºæè¿°éåé¢ç­çç­ç¥ãæå¯ä»¥æå®æåéåçåç§°ä»¥åæåç­ç¥ï¼Openkruise é»è®¤ä¼å¨æ¯å¤©é¶ç¹æ£æ¥ä¸éæ¯å¦æéåæ²¡ææåã
å¨é¨ç½²ä¸ï¼ä¹åªæ¯ä¸ä¸ª Controller Podï¼ç¶åå¨æ¯ä¸ªèç¹ä¸ DaemonSet é½èµ·ä¸ä¸ª Daemon Podï¼ç¸å¯¹æ¥è¯´æ¯è¾è½»éã
ä½æ¯å°±æ¯èµå¹³å°æ¥è¯´ï¼æ¯æ¬¡åºé¢äººä¸ä¼ äºä¸éé¢ç®ï¼å°±è¦æå¨åå»ºä¸ä¸ª `ImagePullJob` èµæºæ¥éç½®è¿ä¸ªé¢ç®çéåé¢ç­ãè¿ä¸ªå·¥ä½äº¤ç»è¿ç»´çåå­¦æå¨æ¥åä¸å¤ªåéï¼ç´æ¥è¦åè¿å¹³å°è®©å®å»åä¸ç®¡ç Openkruise çèµæºä¹ä¸ä¼éã
åµä¸ Openkruise ä»ä»åªæ¯èªå¨ä»éåæºæåéåç½¢äºï¼éå°ä¸ææå°çèç¹æ¬èº«ç½ç»æé®é¢ï¼è¿ä¸ä¸éåä»åºï¼è¿æ¯æ è§£ã

## éè£ç®±åè½¦å¯å¨ï¼

ç»¼ä¸ï¼ææ³è¦çä»ä»åªæ¯ä¸ä¸ªç®åè½»éï¼è½å¨éç¾¤èç¹é´åæ­¥æå®å½åç©ºé´å Pod éåçç»ä»¶ãæä»¥å°±æäº forklift è¿ä¹ä¸ä¸ªé¡¹ç®ï¼<https://github.com/wuhan005/forklift> ï¼forklift çä¸­æç¿»è¯æ¯åè½¦ï¼ä¹å°±æ¯æ¸¯å£ç å¤´ç¨æ¥æ¬è¿éè£ç®±çé£ç©æï¼ç¨å¨è¿éè¿æºè´´åçã

åæ¾ä¸å¼ æç²ç¥ç»å¾æ¶æå¾ï¼ç¶åæåæ¥è¯¦ç»åäº«ä¸å®çä¸äºå®ç°ç»èï¼

![](/images/2023/03/forklift-architecture.png)

å Openkruise ä¸æ ·ï¼æä¼å¨éç¾¤éçä¸å°èç¹ä¸é¨ç½²ä¸ä¸ª `forklift-controller` ä½ä¸ºä¸»çæ§å¶å¨ï¼è¿å°èç¹ä¹å°±æä»»èµ·äºä»å¤é¨æåéåå¹¶ååçå·¥ä½ãå®éå¨çäº§ä¸­æä»¬å¯ä»¥ç¨ Node Selector æ¥æå®ä¸å°ç½ç»å¥½ç£çå¤§çèç¹ä½ä¸º Controllerã
ææçèç¹ä¸é½ä¼é¨ç½²ä¸ä¸ª `forklift-daemonset` ç¨äºå®æ¶è½®è¯¢ controllerï¼ä¸èªå·±æ¬å°å·²æçéååå¯¹æ¯ï¼çæ¯å¦æç¼ºå¤±çéåéè¦æåãå¦æéè¦æååå»è¯·æ± controllerã

ä¸è®ºæ¯ `forklift-controller` è¿æ¯ `forklift-daemonset`ï¼å®ä»¬ä¸ºäºè½æä½èªèº«èç¹å®¿ä¸»æºä¸çå®¹å¨è¿è¡æ¶ï¼å æ­¤é½æ¯é¨ç½²ä¸ºç¹æå®¹å¨ï¼å¹¶ä¸è½è®¿é®å°å®¿ä¸»æºçè¿ç¨ãå·ä½çå®¿ä¸»æºå½ä»¤æ§è¡æ¹å¼å¯ä»¥éè¯»æä¹åçæç« ï¼[ãååï¼ä½ è¿ kubectl exec æä¹ä¸è½æå®ç¨æ·åï¼ã](https://github.red/kubectl-exec-as-root/#%E4%BB%A3%E7%A0%81%E8%BF%98%E6%98%AF%E5%BE%97%E5%86%99%E7%9A%84%EF%BC%8C%E8%AF%A5%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E5%91%A2%EF%BC%9F)
åæ¶è¿è¦æå¨ä¸ä¸ªå¸¦éç¾¤ Pods ååºæ¥çæéç ServiceAccount Token å° Pod åï¼å ä¸ºéè¦è·åæå®å½åç©ºé´ä¸ç Pod éåä¿¡æ¯ã

### forklift-controller

å¯¹äº Controller èè¨ï¼ç¨æ·éè¿å¨ ConfigMap ä¸­æå®éè¦åæ­¥éåçå½åç©ºé´ï¼ConfigMap ä»¥éç½®æä»¶çå½¢å¼è¢«æè½½å°å®¹å¨ä¸­ãController è¯»åéç½®åï¼å¯å¨ä¸ä¸ªç®åç HTTP æå¡ï¼æ ¹è·¯ç± `/` è¿åæå®å½åç©ºé´ä¸çææ Pods éåã
`/load` è·¯ç±æ ¹æ®ä¼ å¥çéååï¼è¿åéåæä»¶åãå¦æ Controller èç¹ä¸äºåä¸å«è¿ä¸ªéåï¼é£ä¹å®ä¼æä½å®¿ä¸»æºæ§è¡ `docker pull` å½ä»¤å»æåï¼ä¹åå `docker export` å°å®¿ä¸»æºï¼å¯¼åºåå®¿ä¸»æºæ§è¡ `docker cp` å¤å¶éåç Tar åå° Pod çå®¹å¨åï¼æåå¨ HTTP ååºä¸­è¿åã

è¿éæä¸ä¸ªæ¯è¾èç¼çç¹ï¼æå¨æ§è¡ `docker cp` å½ä»¤æ¶ï¼å®æ´çå½ä»¤å¦ï¼`docker cp /tmp/image.tar <containerID>:/tmp`ï¼å¶ä¸­ç `<containerID>`ï¼ä¹å°±æ¯å®¹å¨ IDï¼åºè¯¥å¦ä½æ­£ç¡®çè·åå¢ï¼
å¨ç½ä¸æ¾äºä¸åï¼å¾å°çåæ³ä¹åªæä¸æ¡æ¡éåç­éå½å Pod ç `ContainerStatuses`ï¼æ¾å° Name ä¸ºå½åå®¹å¨åç Status è®°å½ï¼åè¯»åè¿æ¡è®°å½ä¸­ç ContianerID ...