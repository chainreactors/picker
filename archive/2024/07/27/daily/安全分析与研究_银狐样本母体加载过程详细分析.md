---
title: 银狐样本母体加载过程详细分析
url: https://mp.weixin.qq.com/s?__biz=MzA4ODEyODA3MQ==&mid=2247488588&idx=1&sn=cc0f10f378cb7363c8e62785db6537aa&chksm=902fbb64a7583272a6ff4b070ac77c70e4dbeb0244619404ce25d30c0bb7d4f4e4666565d4f4&scene=58&subscene=0#rd
source: 安全分析与研究
date: 2024-07-27
fetch_date: 2025-10-06T17:43:07.121779
---

# 银狐样本母体加载过程详细分析

![cover_image](http://mmbiz.qpic.cn/mmbiz_jpg/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvT4mZia3gZVFHwoM7KJ8Qw50CDN21brBDI0vYq8QJGZ6Sa7pVxUOo8WXg/0?wx_fmt=jpeg)

# 银狐样本母体加载过程详细分析

原创

pandazhengzheng

安全分析与研究

前言概述

原文首发出处：

https://xz.aliyun.com/t/14998

先知社区 作者：熊猫正正

近日有朋友通过微信找到我，让我帮忙看一个银狐黑产团伙的样本，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTm8He49KMKlU6UF9ViaotjKlHPt0E2ic8WNDQPmM37DibRiaAwyzoc8icYpw/640?wx_fmt=png)

笔者针对这个银狐母体样本进行了详细分析，因为后面的加密数据已经失效，主要将整个母体的加载过程分享出来，供一些初入逆向的朋友学习参考。

详细分析

1.首先我们从样本start函数开始，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTgW3xeiaMVIYUyLj4qfHogJsSbvOAVJxRcZ92jCfVlbjQQJiaIEq690GQ/640?wx_fmt=png)

2.跳转到恶意代码处，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvT1VxY32I05gNMl76aWKA55jhNibWFicykl20xv48j5sbUYiaTRMSD7icibyA/640?wx_fmt=png)

3.此处有延时执行，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTr8dAjwxXQSSSZ7cymq4iciawKBKo0oLKgby5kxCXF1Sib1RbwSJV93ctA/640?wx_fmt=png)

4.往下执行跳转到恶意代码，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTFQRFvfpI0AruNlonavic6cc8icEwD6aJPo3qX7YIibsxw04Mwu2hfTs9A/640?wx_fmt=png)

5.分配内存空间，然后将恶意ShellCode代码拷贝到该内存空间，并跳转到ShellCode代码执行，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTKduR6FHxC7MicnELH1xBHdJesL7VVdhRNXBZIiaQ9LwO7P5Sa9jPFUbQ/640?wx_fmt=png)

6.动态调试将恶意ShellCode代码拷贝到分配的内存空间，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTZLrpiaqD0YQiaSt1X2q6Qu4ScVwWpYicY53BJbsQvmH3DToHUpES4CZ4A/640?wx_fmt=png)

7.然后跳转执行到ShellCode代码，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTiaK5iadtia9QRRlbevianEbszz6bd9IeY1SlHCINWc0HetndUPe93uIPUQ/640?wx_fmt=png)

8.进入ShellCode代码，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTN9DdU7HiaVRy9JNibPicicuU9UGHfcDHUgtNUh924Et4QP1VsjBlw55ycQ/640?wx_fmt=png)

9.ShellCode代码会有一个解密操作，解密后面加密的恶意代码，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTMUfkvn1U1OEsoZwZGWJ5cm76GsT5dBRpkk6QNpgqVVdGic2pQY1bsIA/640?wx_fmt=png)

10.上面就是朋友所说的ShellCode代码解密处，往后面继续执行直到解密出后面的代码，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTvc9MRkN1CXCER2yjE24jJYuchMeqOvORdxtfKYBoZYa44ol1iaMf5fg/640?wx_fmt=png)

11.往下单步执行跳转到ShellCode核心代码处，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvThZPJkg8ULrN9RsFzLeYNCLwvrMe7ut6Qfia0IP2ib0bz1AFLpVdJzUTg/640?wx_fmt=png)

12.ShellCode核心代码，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvT5WDBP2FAXDV2mtUnvsriccPicKWTbDtEiaZI9wiabNmeMSYGfkfgaEvOsQ/640?wx_fmt=png)

13.调用pid.DllGetClassObject判断值是否为0x80040111，如果不等于0x80040111，则直接退出程序，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTFE6q00eI11hljohxMhg2uicibozzkg6ibkxBj9IaibFQiaaoONmzg3Hb9hw/640?wx_fmt=png)

14.此处又有一个延时操作，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTlqg3sr7hFAkNjO6THYzib5QX9rwpdxemuvnmiaBlpyDTyvjNNUJcLNsg/640?wx_fmt=png)

15.获取当时进程，然后调用kernel32.VirtualAllocExNuma是否成功，不成功则直接退出程序，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvT2DHpcHGX7Z5qTjvjBtTt2eF95K85dltFe7T6YOjG8Zr1WMOJppickhA/640?wx_fmt=png)

16.遍历查找相关进程信息以及进程SID信息，是否符合条件，如果不符合，则退出程序，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTWqgQibRuBXl6NWAfDJc2PicY4RvW22E2IuWZyRYp9y5NyKsw2uTVjhqg/640?wx_fmt=png)

17.获取计算机名，然后使用这个计算机名创建互斥变量，判断程序是否已经运行，如果运行了，则直接退出程序，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTBVeVTHAianmyBUfZibVGEldjy6uWGsZ9qiaUukGlSF2d3ApKNZJhbsNxA/640?wx_fmt=png)

18.判断进程Token信息是否为管理员权限等，如果不符合条件，则使用参数，调用程序，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTMicgmVJnm31BguvK0VL7cU7E6vxVXvlxuJ8xEsYWlIHxB8nWBmMz7Gw/640?wx_fmt=png)

19.获取c:\\xxxx.ini文件的属性，如果成功，则直接退出程序，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTbQDKUlf1DDicNTKwiaPuw6X8k4qIDNq7SU9CBoibht10pXGqSIgwdQdzw/640?wx_fmt=png)

20.通过时间间隔来返调试，如果发现程序在被调试，则直接退出程序，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTicTicldN7CcGKWr0GSib9NMZCjOdByjdE1PwEgJliaV2qG6cqgrfz2WkAA/640?wx_fmt=png)

21.通过RDTSC指令来反调试，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTfMZgxByqTYqhCJibyt3NBreiaAbytPET6xw9yVBqn1qjZuBES80aMmgA/640?wx_fmt=png)

22.通过遍历360进程相关信息以及360程序窗口信息，如果发现360相关信息，则弹出错误对话框，并退出程序，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTdcxCNINa56bDxPiaYFQE3cTb3l3mnibms7P5tjojH36XCMxVhMsTnxLQ/640?wx_fmt=png)

23.遍历系统进程查找相关安全检测工具进程，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTic6QGUUPS2nicTxTKQNaiciaOVUkxUylZZmdL1RcZaEyIeUlLbe1gYp00Q/640?wx_fmt=png)

24.如果发现上面的进程信息，则把恶意程序相关的目录添加到非检测目录下，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTnX6E9Kw6icuNJ7RboC6jmQC6iauQfAjJqjDKAgciaynWBaFY6Z7N3WR4A/640?wx_fmt=png)

25.后面就是从远程服务器端下载相关的数据，然后解密等操作，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTtfkYAq2kSRwUn2wtqa1PgH8trWpWXCsOt7b9FT6E7cNSgzmW7MKt6Q/640?wx_fmt=png)

26.将加密的远程URL链接信息进行解密，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvT4b0cO8Qr0y01qR1Vtfibj8zQM6ic8w2S3zAWojniaPQOpBwsGvjzJHA5w/640?wx_fmt=png)

27.解密远程URL函数，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTKrFdYkxSIVbdBjzibc2uQqzicHnqicRictwud66IYGzRr0SGVzZ62ZV3kA/640?wx_fmt=png)

28.解密之后的远程URL信息，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTts1DPnh7QQ6TkeAhhBe7qHx0uo4XPdusQ0MPryFgOaTQ8ib5XxuzPvg/640?wx_fmt=png)

29.然后通过HTTP函数，向远程服务器请求相关数据，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTMp7Yvajz6SSicWuLHYc3uOU8OVORucvKGvWmJW7yRfk1KtjSDPypRtg/640?wx_fmt=png)

30.最后将请求的数据解密，解密函数，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTxpudvgrama7VSNFzzm6kEjkibkY8aQJKGA7hRaLibgRRLXNEbXMMs3hw/640?wx_fmt=png)

由于请求的URL数据已经失效，拿不到后面的加密数据了，主要分析了前面的母体加载远程URL数据的请求过程，中间有很多相关的反调试，以及反分析的手段。

威胁情报

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXGQO281ibtU9NnpnoGl3pvTsJf5HhTQkDxItbIWI9Gia9lVUm7jyRPuPEMEQcmZhN1SYJK1mTdP4VQ/640?wx_fmt=png)

总结结尾

去年使用“银狐”黑客远控工具的黑产团伙非常活跃，今年这些黑产团伙仍然非常活跃，而且仍然在不断的更新自己的攻击样本，采用各种免杀方式，逃避安全厂商的检测，免杀对抗手法一直在升级。

预览时标签不可点

阅读原文

![]()

微信扫一扫
关注该公众号

继续滑动看下一个

轻触阅读原文

![](http://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVcFgYKtoVnKR7h3pkl3AyxwS0l7iagicAJnYjEQhwIuZgR3RR65DLpJh2TGZS82DY7CjsBUmiaAl7BQ/0?wx_fmt=png)

安全分析与研究

向上滑动看下一个

知道了

![]()
微信扫一扫
使用小程序

取消
允许

取消
允许

取消
允许

×
分析

![跳转二维码]()

![作者头像](http://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVcFgYKtoVnKR7h3pkl3AyxwS0l7iagicAJnYjEQhwIuZgR3RR65DLpJh2TGZS82DY7CjsBUmiaAl7BQ/0?wx_fmt=png)

微信扫一扫可打开此内容，
使用完整服务

：
，
，
，
，
，
，
，
，
，
，
，
，
。

视频
小程序
赞
，轻点两下取消赞
在看
，轻点两下取消在看
分享
留言
收藏
听过