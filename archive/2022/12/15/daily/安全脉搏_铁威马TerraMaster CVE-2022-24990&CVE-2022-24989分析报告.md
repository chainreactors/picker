---
title: 铁威马TerraMaster CVE-2022-24990&CVE-2022-24989分析报告
url: https://www.secpulse.com/archives/193536.html
source: 安全脉搏
date: 2022-12-15
fetch_date: 2025-10-04T01:31:00.648037
---

# 铁威马TerraMaster CVE-2022-24990&CVE-2022-24989分析报告

[![](https://www.secpulse.com/wp-content/themes/secpulse2017/img/logo-header.png)](https://www.secpulse.com "安全脉搏")

* [首页](https://www.secpulse.com/)
* [分类阅读](https://www.secpulse.com/archives/category/category)

  #### 脉搏文库

  - [内网渗透](https://www.secpulse.com/archives/category/articles/intranet-penetration)
  - |
  - [代码审计](https://www.secpulse.com/archives/category/articles/code-audit)
  - |
  - [安全文献](https://www.secpulse.com/archives/category/articles/sec-doc)
  - |
  - [Web安全](https://www.secpulse.com/archives/category/articles/web)
  - |
  - [移动安全](https://www.secpulse.com/archives/category/articles/mobile-security)
  - |
  - [系统安全](https://www.secpulse.com/archives/category/articles/system)
  - |
  - [工控安全](https://www.secpulse.com/archives/category/articles/industrial-safety)
  - |
  - [CTF](https://www.secpulse.com/archives/category/exclusive/ctf-writeup)
  - |
  - [IOT安全](https://www.secpulse.com/archives/category/iot-security)
  - |

#### 安全建设

+ [业务安全](https://www.secpulse.com/archives/category/construction/businesssecurity)
+ |
+ [安全管理](https://www.secpulse.com/archives/category/construction/securityissue)
+ |
+ [数据分析](https://www.secpulse.com/archives/category/construction/bigdata)
+ |

#### 其他

+ [资讯](https://www.secpulse.com/archives/category/news)
+ |
+ [漏洞](https://www.secpulse.com/archives/category/vul)
+ |
+ [工具](https://www.secpulse.com/archives/category/tools)
+ |
+ [人物志](https://www.secpulse.com/archives/category/people)
+ |
+ [区块链安全](https://www.secpulse.com/archives/category/exclusive/block_chain_security)
+ |
+ [安全招聘](https://www.secpulse.com/archives/category/hiring)
+ |

- [安全问答](https://www.secpulse.com/newpage/question_list)
- [金币商城](https://www.secpulse.com/shop?donotcachepage=c010349fd98847cb9d6e07d3cbc19288)
- [安全招聘](https://www.secpulse.com/archives/category/hiring)
- [活动日程](https://www.secpulse.com/newpage/activity)
- [live课程](https://www.secpulse.com/live)
- [企业服务](https://duoyinsu.com/service.html)
- [插件社区](https://x.secpulse.com/)

小程序

![脉搏小程序](https://www.secpulse.com/wp-content/themes/secpulse2017/img/wxchat.jpg)
[登录](https://www.secpulse.com/user_login)
|
[注册](https://www.secpulse.com/user-register)

# 铁威马TerraMaster CVE-2022-24990&CVE-2022-24989分析报告

[漏洞](https://www.secpulse.com/archives/category/vul)

[i春秋聚集地](https://www.secpulse.com/newpage/author?author_id=31924)

2022-12-14

9,919

概述

Terramaster TOS是一款基于Linux平台的、专用于TerraMaster云存储NAS服务器的操作系统。Terramaster TOS 4.2.29版本存在漏洞，可能允许经过身份验证的远程攻击者在系统上执行任意命令，这是由 createRaid 模块中的缺陷引起的。通过发送特制命令，攻击者可以利用此漏洞在系统上以 root 身份执行任意命令。最新版本已对漏洞进行修补，建议更新到最新版本。

### 固件分析

从官网下载固件，这里我们选择`F2-220` `4.2.28`版本。

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193536-1671007109.png)

铁威马使用nginx，解压后在`/etc/nginx/nginx.conf`中可以找到相关配置。

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193536-1671007113.png)

查看`/usr/www`发现php文件均被加密，使用二进制工具查看。

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193536-1671007119.png)

可以看到前面32个字节为一串数字加上字符，从第33个字节开始为乱码。查看多个php文件均出现上诉情况，且前16个字节一样，16字节开始的几个字节与文件大小相关。有理由相信使用同一种加密方式加密。查询相关资料，发现铁威马曾使用`GH65Hws2jedf3fl3MeK`进行加密。对php解释器（位于`usr/sbin/php`）进行查找，未发现相关字符串。再直接在文件夹中进行字符匹配，最终在`/usr/lib/php/modules/php_terra_master.so`中找到该字符串。

定位到相关代码

```
FILE *__fastcall pm9screw_ext_fopen(FILE *stream)
{
  v2 = 16LL;
  v3 = v28;
  while ( v2 )
  {
    *v3 = 0;
    v3 = (v3 + 4);
    --v2;
  }
  v4 = 16LL;
  v5 = v29;
  while ( v4 )
  {
    *v5 = 0;
    v5 = (v5 + 4);
    --v4;
  }
  yek(v28);  //新key
  v6 = md5(v28);
  v28[0] = *v6;
  v28[1] = v6[1];
  oldyek(v29); //旧key
  v7 = md5(v29);
  v29[0] = *v7;
  v27 = v29[0];
  v29[1] = v7[1];
  s2 = v28[0];
  *nptr = 0LL;
  v8 = fileno(stream);
  sub_3A50(v8, &stat_buf);
  v24 = stat_buf.st_size;
  v9 = malloc(0x200000uLL);
  v10 = v24;
  *v9 = 0LL;
  v11 = v9;
  fread(v9, v10, 1uLL, stream);
  v22 = teg_yek(stream);
  fclose(stream);
  v12 = memcmp(v11, &s2, 0x10uLL);
  v13 = v22;
  if ( !v12 )
  {
    v14 = v24;
    for ( i = 16LL; v14 > i; ++i )
    {
      v16 = v11[i];
      if ( i > 31 )
        v11[i - 32] = v16;
      else
        v23[i] = v16;
    }
    v17 = v28;
LABEL_23:
    screw_aes(0LL, v11, v14, v17, &v24, v13); // 加密函数
    v24 = atoi(nptr);
    goto LABEL_24;
  }
  if ( !memcmp(v11, &v27, 0x10uLL) )
  {
    v14 = v24;
    v13 = v22;
    for ( j = 16LL; j < v14; ++j )
    {
      v19 = v11[j];
      if ( j > 31 )
        v11[j - 32] = v19;
      else
        v23[j] = v19;
    }
    v17 = v29;
    goto LABEL_23;
  }
LABEL_24:
  v20 = tmpfile64();
  fwrite(v11, v24, 1uLL, v20);
  free(v11);
  rewind(v20);
  return v20;
}
```

从函数名字可以看出该加密与aes有关，且名称与screw有关。在github搜索`screw`，存在相关代码。

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193536-1671007124.png)

下载后编译，名称为screw，定位到加密函数

```
void __fastcall screw_encrypt(const char *a1)
{
  memset(s, 0, sizeof(s));
  memset(&key, 0, 0x40uLL);
  v1 = (const void *)md5("FwWpZKxH7twCAG4JQMO");
  memcpy(&key, v1, 0x20uLL);
  enTag = key;
  qword_C428 = qword_C3E8;
  stream = fopen(a1, "rb");
  if ( !stream )
  {
    fprintf(stderr, "File not found(%s)", a1);
    exit(0);
  }
  v2 = fileno(stream);
  fstat(v2, &v6);
  v5 = v6.st_size;
  ptr = malloc(0x200000uLL);
  memset(ptr, 0, 8uLL);
  fread(ptr, (int)v5, 1uLL, stream);
  fclose(stream);
  sprintf(s, "%d", v5);
  if ( !memcmp(ptr, &enTag, 0x10uLL) )
  {
    errMsg(a1, " Already Crypted");
  }
  else if ( (int)v5 > 0 )
  {
    screw_aes(1LL, ptr, v5, &key, &v5);  //加密函数
    stream = fopen(a1, "wb");
    if ( !stream )
    {
      errMsg("Can not create crypt file(%s)", v4);
      exit(0);
    }
    fwrite(&enTag, 0x10uLL, 1uLL, stream);
    fwrite(s, 0x10uLL, 1uLL, stream);
    fwrite(ptr, (int)v5, 1uLL, stream);
    fclose(stream);
    alertMsg("Success Crypting - ", a1);
    free(ptr);
  }
  else
  {
    errMsg(a1, " will not be crypted");
  }
}
```

可以发现该加密函数与`php_terra_master.so`中的加密函数高度相似，也就是说`php_terra_master.so`中的函数是在原函数基础上做了一些小改动。经过分析，主要存在下面2个改变：

#### 一. 2个 key

其中1个key就是`GH65Hws2jedf3fl3MeK`，也就是oldkey，将screw中的key替换为`GH65Hws2jedf3fl3MeK`,将一个phpdemo进行加密，加密后如下：

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193536-1671007125.png)

可以发现demo加密后格式与目标基本一致，只是前面16个字节不相同。

另外1个key也就是newkey就有点意思了。

```
__int64 __fastcall yek(__int64 a1)
{
  for ( result = 0LL; result != 32; ++result )
  {
    if ( (result & 1) != 0 )
      v2 = CAONIM[2 * result]; //newkey
    else
      v2 = CAONIM[result];
    *(a1 + result) = v2;
  }
  return result;
}
```

可以看到这个变量名起的就很有个性，再看一下对应的字符串。

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193536-16710071251.png)

只能说感受到了开发人员的良苦用心，最后得到的key为`I''o0aot2eaoyota45eaedot6aoitlae`,再次将demo进行加密。

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193536-1671007126.png)

可以看到demo文件加密出来的文件与我们需要解密的文件基本一致，前面16个字节的标志也相同，不过这样是解密不出来的，这就涉及到了第二个变化。

#### 二.screw\_aes加密函数多了个参数

跟进去发现该函数在加密后，与某个数进行了异或。

```
__int64 __fastcall screw_aes(int a1, __int64 a2, int a3, _DWORD *a4, _DWORD *a5, int a6)
{
  v19 = (a3 % 16 != 0) + a3 / 16;
  if ( a6 == -1 )
  {
    v9 = get_random1();
    v10 = get_dom2();
  }
  else
  {
    v9 = a6;
    v10 = a6;
  }
  v11 = v20;
  v12 = 64LL;
  v13 = a4;
  while ( v12 )
  {
    *v11 = *v13++;
    v11 += 4;
    --v12;
  }
  if ( a1 )
    aes_setkey_enc(v21, v20, 256LL);
  else
    aes_setkey_dec(v21, v20, 256LL);
  for ( i = 0; i < v19; ++i )
  {
    v14 = 0LL;
    if ( a1 )
    {
      aes_crypt_cbc(v21, 1LL, 16LL, a4, a2, a2);
      for ( j = 0LL; j != 16; ++j )
        *(a2 + j) ^= v9;        //异或
    }
    else
    {
      do
        *(a2 + v14++) ^= v10; //异或
      while ( v14 != 16 );
      aes_crypt_cbc(v21, 0LL, 16LL, a4, a2, a2);
    }
    a2 += 16LL;
  }
  result = (16 * v19);
  *a5 = result;
  return result;
}
```

追踪该参数，定位参数来源函数

```
char __fastcall teg_yek(F...