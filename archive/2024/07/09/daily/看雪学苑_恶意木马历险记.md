---
title: 恶意木马历险记
url: https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458562562&idx=2&sn=1d66bb3141b820c717f86d349660e9ec&chksm=b18d808886fa099efc353521af0839c9bf5fbd4cae2985cf3a9a6ea28fa617f8300c0ab115a7&scene=58&subscene=0#rd
source: 看雪学苑
date: 2024-07-09
fetch_date: 2025-10-06T17:45:51.538667
---

# 恶意木马历险记

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBMAe3IFDRsicpszZ1x9ldRVgcrW0q3JGw6NKnmXPVibOymx84TOCcMZGRQ/0?wx_fmt=jpeg)

# 恶意木马历险记

ookkaa

看雪学苑

起因

之前下载某个软件的时候，有点不对劲，六七百M，但是还是双击打开了，后来这个东西释放/下载了一些木马文件下来，Defender告警了，我才发现有问题，后来github的号都被盗了，非常的气愤，接下来分析一下这个小马。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBM0ZAJmd3tsp1EqqcLGXdpibBWmeMYqUgHJVw4eBQzb2jYrmg5b7z1ibXw/640?wx_fmt=other&from=appmsg)

Sha256
d77f0490f9c921baad0015c1eec2cafe1021814c8c28dee10a93179476fcb366

### 第一件事，DIE一下。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBMMPQpVsTakFA5iarPnw5P86Gic5W2CvVqOibBHvZxicT92YtfLicaibjXEVvA/640?wx_fmt=other&from=appmsg)

是C/C++写的，直接IDA，IDA帮我自动跳到main函数。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBMew6ia9v7iarySiafNM0P0f3vaib3czgLBskgtdMcVkjej7lGUytMgKCmag/640?wx_fmt=other&from=appmsg)
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBMbKc0OqWibLY3Og56GLJiarCkWAOib7488WuDIib85EicLPSbkNHGywV3sDQ/640?wx_fmt=other&from=appmsg)

####

#### 龙卷风 ? 很好，我就喜欢这种有强度的。

#### F5先试试水。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBMBOD4Um0OW2pC5MdibjRGGk5qr6W6xiaoPTDcUx0krkNAAKh6tfYolMqA/640?wx_fmt=other&from=appmsg)

很好，不出意料，这个问题修改一下cfg先解决一下。

#### MAX\_FUNCSIZE修改成512K之后，再f5。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBM7PEuWzVdYDrTB14uJhmDoWXWx2lJuS4gXnynKrT8qqctoBb7HcpdEA/640?wx_fmt=webp&from=appmsg)

很好，完全看不懂(这里其实至少可以看出有bcf在的，bcf也是ollvm里的一种混淆措施，不懂的可以google下，太基础的不讲了)。

#### 先一个个来，先解决平坦化。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBMxljiaHmV4hX5LDbicDaVIojBxSKsRfPCFCyUTZe0Z6KNyWQdicEdtaU1g/640?wx_fmt=other&from=appmsg)

虽然看着比较吓人，但是稍微仔细看一下会发现，分发块的TRUE分支对应的真实块。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBMkHcT2xxjzzbibEic15d6Uu5pszaiaoUYZEDqtDnlsGO6FMPw8lbEAWibWQ/640?wx_fmt=other&from=appmsg)

几乎所有的真实块最后都链接到LoopEnd(LoopEnd是啥可以看一下ollvm的源码,这里不细讲,资料比较多)。

#### 这种类似于标准OLLVM思路处理思路其实比较清楚

定位到StateVar(控制流平坦化的相关概念)被赋值的指令，然后找这个值对应的真实块，然后Patch就好了，但是写代码很吃细节(特别魔改过的ollvm)，因为容易错，特别是大函数，编译器也瞎jb优化，有时候标准的ollvm自动优化成不标准的了。

#### 控制流平坦化处理完之后，f5。

控制流很清晰，但是还是有bcf在，逻辑几乎还是看不了。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBMjkZ29SPRiaOybuLE9SFsCxV2DUD2TV4x3ZDKXNgxs7rRs7t9eInj2Hw/640?wx_fmt=webp&from=appmsg)

#### 接下来处理bcf

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBMJNzwhQOvU0QQnzoMazia0TV4OyaUFneMZq0PYrgEZCQ6usGB7iaT9Dzw/640?wx_fmt=webp&from=appmsg)

仔细研究下，其实每个函数都有2个bcf变量(ollvm好像全局只有2个bcf变量,有点忘了)，用来构造恒成立不等式的，这里有10个，因为他核心的混淆函数只有五个。

我的处理bcf的方式是，因为那个变量不影响运算，我直接把引用这个变量的指令Patch了，举个例子

#### mov ecx, bogus\_10 -> mov ecx, 1

主要目的是让这个ecx寄存器变成常量，让IDA的反编译器来参与优化。

#### bcf处理完之后，代码也不一定完全能看。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBMsN3QSKQt9agg3qVwG6y5WgnmnxF8vILIpol96zZ1xJYh9GfK3mVwHg/640?wx_fmt=webp&from=appmsg)

他这个样本还有类似于虚拟寄存器的东西。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBM8p3ibqjicSYkmvgyDLh6oUvcX00GLaI43PdTXcUcqMWP2Ldp19l6j0bw/640?wx_fmt=webp&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBMFWMvSVdAvicCugv7ATt44rghOV0dxOufrhibuWakxsxezKSMDgykcKWA/640?wx_fmt=webp&from=appmsg)

这一系列运算都不知道在干嘛。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBMmKfibwDiajCcyVdCsDTtvXEkLybM0G6Keb8ibXQHhibPVJvn5zkw7RMtGA/640?wx_fmt=webp&from=appmsg)

这种超大的函数，只能借助Proximity browser来借助分析一下调用流(这里有个问题，ida卡的不行，ida只占那么一两百M内存是怎么回事，有几个g可以给他为什么不吃，鼠标移一下就卡好几秒，有没有懂哥)。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBM073ibQSuOflbD7uY9thc15TeicOKI5tskyzv4pl7WoibFVqKiad2cXuNZw/640?wx_fmt=webp&from=appmsg)

这种一看就是shellcode的调用,但是shellcode在哪里呢，这是大问题。

直接定位到CreateThread。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBMkm7zDDcIic2jQjk8ichaZzAWSm7Fd7DCTXUmmlkHUATJ4wrIZW84nJMQ/640?wx_fmt=other&from=appmsg)

很好，只需要知道这个&v3186[\*v3187]在哪里。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBMP38jCPkTPDPKpuYUmon4blLpnU2fwJPpLDMiaJBRpHyjExL09uicONKA/640?wx_fmt=webp&from=appmsg)

很好，静态分析已经到头了(这部分的太多数学运算指令了，有点整不明白，希望大手子来指点下)。

#### 动态调试

其实就是关键的系统API附近打断点，祈祷解密的shellcode在附近就是了(单步去分析这些运算指令也不现实，就跟手动跟VMProtect一样)。

打了好几个地方的断点，无果。

后来在这里附近：

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBMfKLPnwxIUIAuS2IiaKpKw8zEMzMQIhnshHAtgT8FUmyEKbQEkpd6Jfg/640?wx_fmt=webp&from=appmsg)

起初我是想知道这些字符串是怎么被运算出来的。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBMcuLSibicBAepOkM1p6nZuRfQIW11FsvJeJYibUhd4gv4dzqsKZiamTqsBg/640?wx_fmt=webp&from=appmsg)

后来发现还要写常量替换，指令合并，不然还是看不懂的(写起来估计也费劲，还不一定有用)。

但是，狗运有点好。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBMIdfk2EOHum83MGEbQJZNRKopQ5Lq9rkJ0HFib8IwkKROFcRYoDmIiaNw/640?wx_fmt=webp&from=appmsg)

似乎直接在内存中发现了这个shellcode？

####

#### savedata dump.bin,00177E40,0x23b000

直接dump出来，上传vt。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBM5y8BxKXpgkPwiao9lICPqb4GzZfibufRRWFxfiaaNCGc1qwYhnOOic9MRA/640?wx_fmt=webp&from=appmsg)

很好，说明dump的没问题(但是这部分shellcode具体是怎么来的，其实并没有搞出来)。

#### 二段Shellcode其实比较简单了

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBMSXE4EJcg7RjsOOvRCqE47CdwniaciaNCge1O62ibFpibgd2RJybeNOiaCwA/640?wx_fmt=other&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBM7cpBKicETS2rv2OmZUjbka8y31b6mBFLATMAiaO2gmUGbKTWqfdsQv0A/640?wx_fmt=webp&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBMg5yoRHlQc3q2KtZMLtSdufz7b4ruDCo6ZZaIHkvicicAryWCMxLLmnow/640?wx_fmt=other&from=appmsg)
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBM0QuI5OFW1h89HzP0VIMtEhb2blpdYx9bIYkiceWLBxygkcOwK3DERjQ/640?wx_fmt=other&from=appmsg)
https://github.com/adobe/chromium/blob/cfe5bf0b51b1f6b9fe239c2a3c2f2364da9967d7/chrome/browser/webdata/token\_service\_table.cc#L60

慢慢分析就好了。

肯定是把我chrome的token和cookie偷了。

接下来准备研究一下，在有别人token和cookie的情况下，能做什么事，大伙期待下一篇帖子把。

####

#### 这篇帖子涉及到的二进制文件和代码会上传到github，下面是链接：

https://github.com/helloobaby/thread-282253-details

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GZzGxZaAxFIdoJxv7yscBM5BNe7w1ypNGqKBoicBibEWRLfoPEh44C1N6CY0THMcojnebXPIGQcZCQ/640?wx_fmt=png&from=appmsg)

**看雪ID：ookkaa**

https://bbs.kanxue.com/user-home-865434.htm

\*本文为看雪论坛优秀文章，由 ookkaa 原创，转载请注明来自看雪社区

[![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FeKI2dpuEZmzElBSWjbK2Swlh5qgZ4LPAcBFXaHDvvavRnX8hycnTaUhEFU0fmC3kOc2WbC4Hgow/640?wx_fmt=jpeg&from=appmsg)](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458561802&idx=1&sn=26e2967f8e2f36987b08e5ea51d118a9&chksm=b18d9d8086fa149660ad8eb751d2d1cdd14e35868b60952a9f0522db79d6d2220f9d87ff049e&scene=21#wechat_redirect)

**# 往期推荐**

1、[Win10和Win11内存区域划分及动态随机的本质](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458562039&idx=1&sn=995437743de239147b79436f1e621d0d&chksm=b18d9d7d86fa146b9670f08e896c9d5797842af42004bdf5615208ddf639c3b480e99f79e6f6&scene=21#wechat_redirect)

2、[Windows主机入侵检测与防御内核技术深入解析](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458561802&idx=2&sn=db9630a32c5c1aeaa311a1c9c0362cc3&chksm=b18d9d8086fa14962ffbbcdfb63373c259ec5f085f905e5c63e757474e558a32451c730e5c0c&scene=21#wechat_redirect)

3、[反沙箱钓鱼远控样本分析](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458561661&idx=1&sn=daaa415aa700e0df08bb13330b007415&chksm=b18d9cf786fa15e1c62cc8101bc78a3cb1ec5bb536301cd6079d487550b35950f8e7293d2929&scene=21#wechat_redirect)

4、[安全浏览器历史记录数据库解密算法逆向](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458560882&idx=1&sn=e27bca997c1990cc5540dddb4c99046d&chksm=b18d99f886fa10eecf64719afebae9102c9e33fcae4a7e003cbfd12ff8957225cdba60fac248&scene=21#wechat_redirect)

5、[APP小说VIP功能分析](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458560855&idx=2&sn=eda57c590bef26a345dd92990e26774f&chksm=b18d99dd86fa10cb16875905093f8c532049bb47386fb582a31093ebb45d93c856fba6239abe&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_jpg/Uia4617poZXP96fGaMPX...