---
title: Sidekick in Action: Deobfuscating Strings in Amadey Malware
url: https://binary.ninja/2024/08/12/sidekick-in-action-deobfuscating-strings-in-amadey-malware.html
source: Binary Ninja
date: 2024-08-13
fetch_date: 2025-10-06T18:04:03.450226
---

# Sidekick in Action: Deobfuscating Strings in Amadey Malware

[![](/images/binary-ninja-logo.svg)](/)

* [Features](/features/)
* [Enterprise](/enterprise/)
* [Sidekick](https://sidekick.binary.ninja)
* [Cloud](https://cloud.binary.ninja)
* [Training](/training/)
* [Support](/support/)

  [Extended Support](/support/extended.html)
  [Documentation](/support/#documentation)
  [License/Installer Recovery](/recover/)
  [Renew Current License](/renew/)
  [Slack Signup](https://slack.binary.ninja/)
  [FAQ](/faq/)
  [Sponsorship Information](/sponsorship/)
  [Portal](https://portal.binary.ninja/)
  [Contact Us](/support/)
* [Blog](/blog/)
* [Gear](https://shop.binary.ninja)

[Free](/free)
[Purchase](/purchase)

Participate in our [Reverse Engineering Survey](/survey/) to win free licenses or admission to [RE//verse](https://re-verse.io/)!

# Binary Ninja Blog

## Sidekick in Action: Deobfuscating Strings in Amadey Malware

* [Brian Knudson](https://github.com/kristopax)
* 2024-08-12
* [sidekick](/tag/sidekick)

Sidekick 2.0 includes a set of powerful features that can help you accomplish a variety of tasks. Today, we will be applying several of them to the task of de-obfuscating strings in a malware sample called Amadey.

Amadey, as explained in its [Malpedia entry](https://malpedia.caad.fkie.fraunhofer.de/details/win.amadey), is a botnet that periodically sends information about the system and installed AV software to its C2 server and polls to receive orders from it. Its main functionality is that it can load other payloads (called âtasksâ) for all or specifically targeted computers compromised by the malware. This particular malware sample employs an obfuscation technique that stores the strings referenced by the binary as encrypted strings that are then decrypted during runtime. This makes it more difficult for analysts to reverse engineer and understand what the malware is doing and also prevents anti-virus software from identifying it.

*Big thanks to [Josh Reynolds](https://x.com/jershmagersh) from [InvokeRE](https://invokere.com/) for giving us the Amadey sample and working with our team to improve Sidekickâs malware analysis while we were working on this post.*

Letâs get started.

## Find Decryption Function

First, we need to find the function in the binary that decrypts the encrypted strings. (Note: This sample binary is stripped of any symbol information that would ordinarily assist us in this task.) Since this is a task that requires both iterating over the code in the binary and analyzing its contents, the automation and reasoning capabilities of the Analysis Workbench makes it most suitable for this task.

Within the Analysis Workbench, we enter a simple task description of âFind functions that perform decryption on stringsâ:

![Analysis Workbench Find Decryption Functions](/blog/images/sidekick-in-action/analysis-workbench-find-decryption-functions.png)

Sidekick automatically generates the script that will perform that task. You will notice a few things in this script:

* Sidekick chose to create an `LLMOperator` to determine if a given function performs decryption on strings (line 2). When invoked, the `LLMOperator` will use a large language model to determine if the function passed to it (on line 12) performs decryption on strings.
* Sidekick determined that it needed to iterate over all defined functions in the binary in order to complete the request (line 7).
* Sidekick chose to notify us of its progress as a helpful convenience (line 9)
* Sidekick chose to output its results in an index named âDecryption Functionsâ (lines 5, 16)

Since the âDescriptionâ metadata in the index entry doesnât provide us with any additional information, letâs ask the Sidekick Coding Assistant to give us an actual description of the decryption routine:

![Analysis Workbench Describe Decryption Type](/blog/images/sidekick-in-action/analysis-workbench-describe-decryption-type.png)

Next, letâs run the script and see what we get in the output `Decryption Functions` index:

![Indexes Decryption Functions](/blog/images/sidekick-in-action/indexes-decryption-functions.png)

Within a few seconds, we already have a few entries to look at. The function `sub_401290` seems promising, so letâs take a peek:

![Linear View Decryption Function](/blog/images/sidekick-in-action/linear-view-decryption-function.png)

Yep. This is the decryption function weâre looking for.

## Convert Decryption Function to Python

Letâs see if we can convert it to Python so that we can easily run it within an Analysis Workbench script. The Sidekick Assistant is particularly suitable for this kind of task given its focus on smaller sets of function, so letâs ask the Assistant to convert it to Python for us:

![Assistant Convert Decryption Function to Python](/blog/images/sidekick-in-action/assistant-convert-decryption-function-to-python.png)

That was easy!

## Decrypt Strings

Now that we have identified the decryption function and converted it to Python, letâs actually use it to decrypt all the strings passed to it. Since we are searching for multiple locations across the binary, calling custom Python code on data at those locations, and outputting those results for us to review, the Analysis Workbench is the perfect tool for this job. So letâs write another script.

In the Analysis Workbench, we will create a new, empty script by clicking on the hamburger menu and selecting `New Script`.

![Analysis Workbench New Script](/blog/images/sidekick-in-action/analysis-workbench-new-script.png)

Weâll give our script a title, paste in our Python decryption function, give it a new name, and ask the Sidekick Coding Assistant to use the given Python decryption function to decrypt all the strings passed to the `sub_401290` function.

![Analysis Workbench Add Python Decryption Function](/blog/images/sidekick-in-action/analysis-workbench-add-python-decryption-function.png)

Letâs see what we get.

![Analysis Workbench Decrypt Strings Passed to Decryption Function](/blog/images/sidekick-in-action/analysis-workbench-decrypt-strings-passed-to-decryption-function.png)

After running this revision of the updated script, we do not get any results. This happens because the strings passed to `sub_401290` do not have string variables defined for them in the binary, so `bv.get_string_at` will not return anything. The reason that Binary Ninja did not make string variables for them is because they are encrypted strings. This is very common in reverse engineering tools when analyzing binaries with encrypted strings since they do not look like real strings. Therefore, we need to create the string by reading its bytes from the binary directly. Instead of trying to do that ourselves, letâs just ask Sidekick to create a function for us that does that. At the same time, letâs also have Sidekick update the script to output both the call instruction and the decrypted string to the index as the strings are decrypted.

![Analysis Workbench Create Function to Read String Bytes](/blog/images/sidekick-in-action/analysis-workbench-create-function-to-read-string-bytes.png)

After running this script revision, we get this error:

![Analysis Workbench Byte Range Error](/blog/images/sidekick-in-action/analysis-workbench-byte-range-error.png)

Errors are no fun, so letâs have Sidekick deal with it (since it has access to the content in the Output console):

![Analysis Workbench Fix Error](/blog/images/sidekick-in-action/analysis-workbench-fix-error.png)

Now letâs run it!

![Indexes Decrypted Strings](/blog/images/sidekick-in-action/indexes-decrypted-strings.png)

Success!

## View Decrypted Strings in Code Insight Map

Since we output the decrypted strings to an index, we can use Sidekickâs Code Insight Map to view the relationship between functions that reference those decrypted strings and help us understand what the binary is doing with those strings. Letâs also run the `High-Level Functions` script (included by default within the Analy...