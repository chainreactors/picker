---
title: Chaining our way to Pre-Auth RCE in Metabase (CVE-2023-38646)
url: https://govuln.com/news/url/Rn9r
source: Sec-News 安全文摘
date: 2023-07-29
fetch_date: 2025-10-04T11:52:29.233665
---

# Chaining our way to Pre-Auth RCE in Metabase (CVE-2023-38646)

[Assetnote has been acquired by Searchlight Cyber. Click here to learn more.](https://www.assetnote.io/acquisition?ref=banner)

[![](https://cdn.prod.website-files.com/6422e507d5004f85d107063a/6798e2df001e0d7d5c33a901_AN%20x%20SLC_Logo_Col_White.svg)](/)

[Why Assetnote](/why-assetnote)

Platform

What Powers Our Product

[Continuous Asset Discovery

Get an unparalleled view of your environment in real-time](/platform/asset-discovery)

[Deep Asset Enrichment

Contextualize and track assets as they evolve](/platform/asset-enrichment)

[Assetnote Exposure Engine

Identify high-signal exposures by the hour](/platform/assetnote-exposure-engine)

[Expert Security Research

Industry-leading offensive security research at your fingertips](/platform/expert-security-research)

What Empowers Our Customers

[Collaborative Workflows

Work together under one platform](/platform/collaborative-workflows)

[Customization

Customize our platform to fit your needs](/platform/customization)

Use Cases

By Objective

[Continuous Asset Discovery and Inventory

Stay up-to-date with your evolving attack surface](/use-cases/continuous-asset-discovery-and-inventory)

[Real-Time Exposure Monitoring

Monitor and get high-signal findings](/use-cases/continuous-security-monitoring)

[Attack Surface Reduction

Understand the full extent of your attack surface to reduce it](/use-cases/attack-surface-reduction)

[Mergers & Acquisitions

Don't inherit exposures of an acquired attack surface](/use-cases/mergers-and-acquisitions)

[Bug Bounty Readiness

Find all the low-hanging fruit for a more effective program](/use-cases/bug-bounty-readiness)

By Surface

[Application & Infrastructure

Assetnote covers all traditional EASM surfaces](/use-cases/surface-application-infrastructure)

[Cloud Platforms

Assetnote secures the cloud platforms you rely on: AWS, GCP, Azure, and more!](/use-cases/surface-cloud-platforms)

[API Security

Assetnote secures the API attack surface as it grows](/use-cases/surface-api-security)

Company

[About Us

Learn about who we are and why we do what we do.](/company/about-us)[Careers

Join us in our mission to build awesome security products.](/company/careers)

[Resources

Get the latest insights on Attack Surface Management here!](/resources/resources-overview)[Contact

Meet with the Assetnote team and get your questions answered.](/company/contact)

[Research](/resources/research)[Labs](https://labs.assetnote.io)[ASM Roles](https://asmroles.assetnote.io)

[Request a Demo](/demo)

[Research Notes](/resources/research)

Security Research

July 22, 2023

# Chaining our way to Pre-Auth RCE in Metabase (CVE-2023-38646)

No items found.

![](https://cdn.prod.website-files.com/6422e507d5004f85d107063a/653795bb35bc995a6f921d3f_citrixbleed.svg)

Creative Commons license

Metabase is an open source business intelligence tool that lets you create charts and dashboards using data from a variety of databases and data sources. Itâs a popular project, with over 33k stars on GitHub and has had quite a lot of scrutiny from a vulnerability research perspective in the last few years.

Our security research team decided to focus on this product due to our experiences in dealing with previous vulnerabilities that affected Metabase ([Log4Shell](https://github.com/metabase/metabase/security/advisories/GHSA-vmm4-cwrm-38rj), [SSRF](https://nvd.nist.gov/vuln/detail/CVE-2021-41277)) and due to our analysis on the widespread nature of this software on the internet.

Despite Metabase not giving us credit in their initial advisory, we were the original discoverers and reporters of this bug to Metabase.

As of writing this blog post, there are about ~20k instances of Metabase exposed on the external internet. Given that this tool is designed to connect to extremely sensitive datasources, a pre-auth RCE vulnerability has a great impact, as not only are you able to get a shell on a critical part of an organizationâs network, but you will likely also be able to access sensitive datasources.

In order to follow along in our journey to achieving pre-auth RCE, you can spin up an instance of Metabase that is vulnerable by running the following command: <span class="code\_single-line">docker run -d -p 3000:3000 --name metabase metabase/metabase:v0.46.6</span>. This will spin up a vulnerable instance of Metabase on port 3000. No special configuration is required to exploit the vulnerability we present in this blog.

When reviewing the different flows inside Metabase and capturing the traffic from the installation steps of the product, we noticed that there was a special token that was used to allow users to complete the setup process. This token was called the <span class="code\_single-line">setup-token</span> and most people would assume that the setup flow can only be completed once (the first setup).

After auditing Metabaseâs Clojure code and their frontend, we found that the intended flow for Metabaseâs setup looked something like the following:

![](https://cdn.prod.website-files.com/64233a8baf1eba1d72a641d4/659e9c49da973e85aec358af_metabase-setup-flow.png)

However, as we set up our local instance of Metabase, we were shocked to find that the <span class="code\_single-line">setup-token</span> value was still present after the installation and accessible to unauthenticated users via the following two methods:

1. Viewing the HTML source of the index/login page and finding it embedded in a JSON object
2. Viewing <span class="code\_single-line">/api/session/properties</span> (also accessible without auth)

So, in reality, what was actually happening was the following:

![](https://cdn.prod.website-files.com/64233a8baf1eba1d72a641d4/659e9c6b0ee425750060997d_metabase-setup-flow-reality.png)

But hang on a second, a lot of the instances we were checking online did not have the setup-token exposed. Many instances we checked had <span class="code\_single-line">"setup-token":null</span>, so why is our local installation not wiping the setup token? We did get some comfort as we did also find plenty of instances in the wild where the setup-token had not been wiped even though the instances were fully setup.

At this point, both my colleague and I were frantically trying to work out the root cause of this issue. It was not immediately obvious even after several hours of reading their codebase. We decided to take a journey down memory lane and systematically go through their historical commits until we found a clue.

Eventually, we landed on the following commit made in Jan, 2022: <https://github.com/metabase/metabase/commit/0526d88f997d0f26304cdbb6313996df463ad13f#diff-44990eafd7da3ac7942a9f232b56ec045c558fdc3c414a2439e42b5668eced32L141>.

![](https://cdn.prod.website-files.com/64233a8baf1eba1d72a641d4/659e9c77bf8a147d8a9e23af_bad-commit.png)

Based off our understanding, there was some refactoring work done on the Metabase codebase where a critical part of the setup flow was deleted: removing the setup token after Metabase has been setup.

To explain the caveat to this entire chain, in order for your Metabase instance to have been vulnerable, it must have been set up after this commit was made (Jan 2022). This explained why so many older Metabase instances did not have their setup-token exposed.

With that mystery solved, we moved onto the next stage of the exploitation process, which was going from an exposed setup token to reliable remote code execution. Given that Metabase is designed to connect to so many different types of datasources/databases, we were confident that we could escalate this vulnerability.

The setup phase of Metabase prompts you to connect to a datasource/database. As this is a part of the setup flow, an endpoint exists at <span class="code\_single-line">/api/setup/validate</span> which takes in a JDBC URI as a part of the POST request and then validates the connection before allowing you to complete the setup.

In the land of Clojure/Java, itâs common to see many ...