---
title: Stranger Strings: An exploitable flaw in SQLite
url: https://buaq.net/go-132568.html
source: unSafe.sh - 不安全
date: 2022-10-26
fetch_date: 2025-10-03T20:52:38.598726
---

# Stranger Strings: An exploitable flaw in SQLite

* [unSafe.sh - 不安全](https://unsafe.sh)
* [我的收藏](/user/collects)
* [今日热榜](/?hot=true)
* [公众号文章](/?gzh=true)
* [导航](/nav/index)
* [Github CVE](/cve)
* [Github Tools](/tools)
* [编码/解码](/encode)
* [文件传输](/share/index)
* [Twitter Bot](https://twitter.com/buaqbot)
* [Telegram Bot](https://t.me/aqinfo)
* [Search](/search/search)

[Rss](/rss.xml)

[ ]
黑夜模式

![](https://8aqnet.cdn.bcebos.com/fe744086e9e30558eff68db62d7465a6.jpg)

Stranger Strings: An exploitable flaw in SQLite

By Andreas KellasTrail of Bits is publicly disclosing CVE-2022-35737, which affe
*2022-10-25 19:30:10
Author: [blog.trailofbits.com(查看原文)](/jump-132568.htm)
阅读量:39
收藏*

---

**By Andreas Kellas**

Trail of Bits is publicly disclosing [CVE-2022-35737](https://nvd.nist.gov/vuln/detail/CVE-2022-35737), which affects applications that use the SQLite library API. CVE-2022-35737 was introduced in SQLite version 1.0.12 (released on October 17, 2000) and fixed in [release 3.39.2](https://www.sqlite.org/releaselog/3_39_2.html) (released on July 21, 2022). CVE-2022-35737 is exploitable on 64-bit systems, and exploitability depends on how the program is compiled; arbitrary code execution is confirmed when the library is compiled without stack canaries, but unconfirmed when stack canaries are present, and denial-of-service is confirmed in all cases.

On vulnerable systems, CVE-2022-35737 is exploitable when large string inputs are passed to the SQLite implementations of the `printf` functions and when the format string contains the `%Q`, `%q`, or `%w` format substitution types. This is enough to cause the program to crash. We also show that if the format string contains the `!` special character to enable unicode character scanning, then it is possible to achieve arbitrary code execution in the worst case, or to cause the program to hang and loop (nearly) indefinitely.

SQLite is used [in nearly everything](https://thenewstack.io/the-origin-story-of-sqlite-the-worlds-most-widely-used-database-software/), from naval warships to smartphones to other programming languages. The open-source database engine has a long history of being very secure: many CVEs that are initially pinned to SQLite [actually don’t impact it at all](https://www.sqlite.org/cves.html). This blog post describes the vulnerability and our [proof-of-concept exploits](https://github.com/trailofbits/publications/tree/master/disclosures/CVE-2022-35737#readme), which actually does impact certain versions of SQLite. Although this bug may be difficult to reach in deployed applications, it is a prime example of a vulnerability that is made easier to exploit by “divergent representations” that result from applying compiler optimizations to undefined behavior. In an upcoming blog post, we will show how to find instances of the divergent representations bug in binaries and source code.

## Background: Stumbling onto a bug

A [recent blog post](https://pwning.systems/posts/php_filter_var_shenanigans/) presented a vulnerability in PHP that seemed like the perfect candidate for a variant analysis. The blog’s bug manifested when a 64-bit unsigned integer string length was implicitly converted into a 32-bit signed integer when passed as an argument to a function. We formulated a variant analysis for this bug class, found a few bugs, and while most of them were banal, one in particular stood out: a function used for properly escaping quote characters in the [PHP PDO SQLite module](https://github.com/php/php-src/blob/5d5d9796fc4bd6d91f39db5531ae5713b8afbaec/ext/pdo_sqlite/sqlite_driver.c#L227). And thus began our strange journey into SQLite string formatting.

SQLite is the [most widely deployed database engine](https://www.sqlite.org/mostdeployed.html), thanks in part to its very [permissive licensing](https://www.sqlite.org/copyright.html) and cross-platform, portable design. It is written in C, and can be compiled into a standalone application or a library that exposes APIs for application programmers to use. It seems to be used everywhere—a perception that was reinforced when we tripped right over this vulnerability while hunting for bugs elsewhere.

```
 static zend_string* sqlite_handle_quoter(pdo_dbh_t *dbh, const zend_string *unquoted, enum pdo_param_type paramtype)
 {
		char *quoted = safe_emalloc(2, ZSTR_LEN(unquoted), 3);
		/* TODO use %Q format? */
		sqlite3_snprintf(2*ZSTR_LEN(unquoted) + 3, quoted, "'%q'", ZSTR_VAL(unquoted));
		zend_string *quoted_str = zend_string_init(quoted, strlen(quoted), 0);
		efree(quoted);
		return quoted_str;
 }
```

On line 231, an unsigned long `(2*ZSTR_LEN(unquoted) + 3)` is passed as the first parameter to `sqlite3_snprintf`, which expects a signed integer. This felt exciting, and we quickly scripted a simple proof of concept. We expected to be able to exploit this bug to produce a poorly formatted string with mismatched quote characters by passing large strings to the function, and possibly achieve SQL injection in vulnerable applications.

[![](https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/10/php.png?resize=690%2C74&ssl=1)](https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/10/php.png?ssl=1)

### There’s a bug in my bug!

We quickly determined that the crash was occurring in the SQLite shared object, so we naturally took a closer look at the `sqlite3_snprintf` function.

SQLite implements [custom versions of the `printf` family](https://www.sqlite.org/c3ref/mprintf.html) of functions and adds the new format specifiers `%Q`, `%q`, and `%w`, which are designed to properly escape quote characters in the input string in order to make safe SQL queries. [For example](https://github.com/trailofbits/publications/blob/master/disclosures/CVE-2022-35737/snprintf-good-example.c), we wrote the following code snippet to properly use `sqlite3_snprintf` with the format specifier `%q` to output a string where all single-quote characters are escaped with another single quote. Additionally, the entire string is wrapped in a leading and trailing single quote, the way the PHP quote function intends:

```
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sqlite3.h>

int main(int argc, char *argv[]) {

    char src[] = "hello, \'world\'!";
    char dst[sizeof(src) + 4];  // Add 4 to account for extra quotes.

    sqlite3_snprintf(sizeof(dst), dst, "'%q'", src);

    printf("src: %s\n", src);
    printf("dst: %s\n", dst);
    return 0;
}
```

[![](https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/10/JFlSpPEseXvmCQRGPnEdZv2Zkv3pSw1Pi38WgjmChwunr88oF5oSKWvseCrv8ke_ghwTTqZ3OV_I_uULb9kFumFmvOp6Jj0MTcD0bU79msxJEP1CUUzcpL2oJ0zw.png?resize=690%2C63&ssl=1)](https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/10/JFlSpPEseXvmCQRGPnEdZv2Zkv3pSw1Pi38WgjmChwunr88oF5oSKWvseCrv8ke_ghwTTqZ3OV_I_uULb9kFumFmvOp6Jj0MTcD0bU79msxJEP1CUUzcpL2oJ0zw.png?ssl=1)

`sqlite3_snprintf` properly wraps the original string in single quotes, and escapes any existing single-quotes in the input string.

Next, we [changed our program](https://github.com/trailofbits/publications/blob/master/disclosures/CVE-2022-35737/snprintf-crash.c) to imitate the behavior of the PHP script by passing the same large 2GB string directly to `sqlite3_snprintf`:

```
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sqlite3.h>

#define STR_LEN ((0x100000001 - 3) / 2)

int main(int argc, char *argv[]) {

    char *src = calloc(1, STR_LEN + 1); // Account for NULL byte.
    memset(src, 'a', STR_SIZE);
    char *dst = calloc(1, STR_LEN + 3); // Account for extra quotes and NULL byte.

    sqlite3_snprintf(2*STR_LEN + 3, dst, "'%q'", src);

    printf("src: %s\n", src);
    printf("dst: %s\n", dst);
    return 0;
}
```

[![](https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/10/fish-.a.out-terminated-by-signal-SIGSEGV-Address-boundary-error.png?resize=683%2C52&ssl=1)](https://i0.wp.com/blog.trailofbits.com/wp-content/uploads/2022/10/fish-.a.out-terminated-by-signal-SIGSEGV-Address-bo...