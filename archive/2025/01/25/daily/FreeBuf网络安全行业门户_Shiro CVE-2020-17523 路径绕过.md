---
title: Shiro CVE-2020-17523 路径绕过
url: https://www.freebuf.com/vuls/420772.html
source: FreeBuf网络安全行业门户
date: 2025-01-25
fetch_date: 2025-10-06T20:10:09.749442
---

# Shiro CVE-2020-17523 路径绕过

[![freeBuf](/images/logoMax.png)](/)

主站

分类

云安全

AI安全

开发安全

终端安全

数据安全

Web安全

基础安全

企业安全

关基安全

移动安全

系统安全

其他安全

特色

热点

工具

漏洞

人物志

活动

安全招聘

攻防演练

政策法规

[报告](https://www.freebuf.com/report)[专辑](/column)

* ···
* [公开课](https://live.freebuf.com)
* ···
* [商城](https://shop.freebuf.com)
* ···
* 用户服务
* ···

行业服务

政 府

CNCERT
CNNVD

会员体系（甲方）
会员体系（厂商）
产品名录
企业空间

[知识大陆](https://wiki.freebuf.com/page)

搜索

![](/freebuf/img/7aa3bf7.svg) ![](/freebuf/img/181d733.svg)

创作中心

[登录](https://www.freebuf.com/oauth)[注册](https://www.freebuf.com/oauth)

官方公众号企业安全新浪微博

![](/images/gzh_code.jpg)

FreeBuf.COM网络安全行业门户，每日发布专业的安全资讯、技术剖析。

![FreeBuf+小程序](/images/xcx-code.jpg)

FreeBuf+小程序把安全装进口袋

[![](https://image.3001.net/images/20231020/1697804527_653270ef7570cc7356ba8.png)](https://wiki.freebuf.com)

Shiro CVE-2020-17523 路径匹配绕过

* ![]()
* 关注

* [漏洞](https://www.freebuf.com/articles/vuls)

Shiro CVE-2020-17523 路径匹配绕过

2025-01-28 12:35:32

所属地 广东省

# 漏洞描述

Apache Shiro before 1.7.1, when using Apache Shiro with Spring, a specially crafted HTTP request may cause an authentication bypass.[1]

# 漏洞条件

* shiro < 1.7.1
* 路径配置 是类似“/\*”的只有一个通配符，而不能是类似“/\*\*”的双统配符
* 使用spring

# 漏洞复现

## 环境

基础环境：

```
- shiro:1.7.0
- springboot:2.7.4
```

shiro配置：

```
@Bean
    ShiroFilterFactoryBean getShiroFilterFactoryBean(DefaultWebSecurityManager securityManager) {
        ShiroFilterFactoryBean bean = new ShiroFilterFactoryBean();
        bean.setSecurityManager(securityManager);
        bean.setLoginUrl("/login");
        bean.setSuccessUrl("/loginSuccess");
        bean.setUnauthorizedUrl("/unauthorized");
        LinkedHashMap<String, String> map = new LinkedHashMap<String, String>();
        //url --> filter1,filter2....
        map.put("/admin/*", "authc, roles[admin]");   //   如果是"/admin/**"则漏洞无效
        map.put("/login","authc");
        bean.setFilterChainDefinitionMap(map);
        return bean;
    }
```

controller:

```
@ResponseBody
@GetMapping("/admin/{param}")
public String adminInfo(@PathVariable String param) {
    if(param == null){
        return "you are admin";
    }
    return "admin Info: " + param;
}
```

## 测试

**payload**

```
/admin/%20
```

结果:
![image.png](https://image.3001.net/images/20250203/1738570381_67a07a8dabb99b58a413d.png!small)

# 漏洞分析

请求同上。

漏洞入口：`PathMatchingFilterChainResolver.getchain(...)`
![image](https://image.3001.net/images/20250124/1737704917_679345d5d51f5dd155e66.png!small)

getPathWithinApplication(request)保留了空格

![image](https://image.3001.net/images/20250124/1737704933_679345e528b3656d7c94d.png!small)

![image](https://image.3001.net/images/20250124/1737704952_679345f82d86879fd6320.png!small)

springweb路径匹配路口:`AbstractHandlerMethodMapping.getHandlerInternal(...)`

![image](https://image.3001.net/images/20250124/1737704967_6793460759aca32b445a0.png!small)

从漏洞复现结果可知，最终能够匹配“/admin/{param}"。

但是为什么shiro中"/admin/ "(末尾有空格）无法匹配"/admin/\*"?

```
PathMatchingFilterChainResolver.pathMatches(String pattern, String path) --不断跟进--->
AntPathMatcher.doMatch(pattern, path, true);
```

* 第一步：将传入的路径以分割符”/“，分割路径为数组：![image](https://image.3001.net/images/20250124/1737704993_679346213a128d8bc4e3d.png!small)不过，从图中发现，pattern（配置的路径）能够正常的被分割为["admin","\*"],然而path 没有被分割为["admin"," "],而是缺少了空格符。

> 也就是说相当于把“/admin/ " 变成了“/admin",最终结果必然是不匹配的

* 第二步：进入以下while循环，进行循环匹配

```
// Match all elements up to the first **
        while (pattIdxStart <= pattIdxEnd && pathIdxStart <= pathIdxEnd) {
            String patDir = pattDirs[pattIdxStart];
            if ("**".equals(patDir)) {
                break;
            }
            if (!matchStrings(patDir, pathDirs[pathIdxStart])) {
                return false;
            }
            pattIdxStart++;
            pathIdxStart++;
        }
```

* 第三步：由于pathDirs长度小于pattDirs长度，所以最终path会先耗尽（exhausted），从而跳出循环，进入下图分支（最上层的if条件），最终返回false![image](https://image.3001.net/images/20250124/1737705027_679346431c695681f7401.png!small)

综上可知,最根本的原因就在`StringUtils.tokenizeToStringArray(...)`：分割时去除了空格

![image](https://image.3001.net/images/20250124/1737705046_679346561bb6e97b58954.png!small)

```
public static String[] tokenizeToStringArray(String str, String delimiters, boolean trimTokens, boolean ignoreEmptyTokens) {
        if (str == null) {
            return null;
        } else {
            StringTokenizer st = new StringTokenizer(str, delimiters);
            List tokens = new ArrayList();

            while(true) {
                String token;
                do {
                    if (!st.hasMoreTokens()) {
                        return toStringArray(tokens);
                    }

                    token = st.nextToken();
                    if (trimTokens) {
                        //token = " "时，token.trim()会返回去除首尾空格后的字符串：""
                        //因此最终数组中没有空格符
                        token = token.trim();
                    }
                } while(ignoreEmptyTokens && token.length() <= 0);

                tokens.add(token);
            }
        }
    }
```

> trim(): Returns a string whose value is this string, with any leading and trailing whitespace removed.

# **漏洞修复**

将`trimTokens`参数设置为false: [[3]](https://github.com/apache/shiro/commit/ab1ea4a2006f6bd6a2b5f72740b7135662f8f160)

![image](https://image.3001.net/images/20250124/1737705065_6793466920d8646233718.png!small)

**Reference**

---

[1] [Security Reports | Apache Shiro](https://shiro.apache.org/security-reports.html#cve_2020_17523)

[2] [文章 - Shiro 历史漏洞分析 - 先知社区](https://xz.aliyun.com/news/11079#toc-33)

# 漏洞分析 # Shiro # Java代码审计 # 开源组件安全

本文为 独立观点，未经授权禁止转载。
如需授权、对文章有疑问或需删除稿件，请联系 FreeBuf
客服小蜜蜂（微信：freebee1024）

被以下专辑收录，发现更多精彩内容

+ 收入我的专辑

+ 加入我的收藏

展开更多

相关推荐

![]()

关 注

* 0 文章数
* 0 关注者

文章目录

环境

测试

![](/images/logo_b.png)

本站由阿里云 提供计算与安全服务

### 用户服务

* [有奖投稿](https://www.freebuf.com/write)
* [提交漏洞](https://www.vulbox.com/bounties/detail-72)
* [参与众测](https://www.vulbox.com/projects/list)
* [商城](https://shop.freebuf.com)

### 企业服务

* [安全咨询](https://company.freebuf.com)
* [产业全景图](https://www.freebuf.com/news/307349.html)
* [企业SRC](https://www.vulbox.com/service/src)
* [安全众测](https://www.vulbox.com/)

### 合作信息

* [斗象官网](https://www.tophant.com/)
* [广告投放](https://www.freebuf.com/articles/444331.html)
* [联系我们](https://www.freebuf.com/articles/444332.html)

### 关于我们

* [关于我们](https://www.freebuf.com/news/others/864.html)
* 微信公众号
* [新浪微博](http://weibo.com/freebuf)

### 战略伙伴

* [![](https://image.3001.net/images/20191017/1571306518_5da83c1686dd9.png)](http://www.aliyun.com/?freebuf)

### FreeBuf知识大陆

![](https://image.3001.net/images/20250703/1751535036_68664dbcae34ac40bb9e7.png)

扫码把安全装进口袋

* [斗象科技](https://www.tophant.com/)
* [FreeBuf](https://www.freebuf.com)
* [漏洞盒子](https://www.vulbox.com/)
* [斗象智能安全](https://ai.tophant.com/)
* [免责条款](https://www.freebuf.com/dis)
* [协议条款](https://my.freebuf.com/AgreeProtocol/duty)

Copyright © 2025 WWW.FREEBUF.COM All Rights Reserved
[沪ICP备2024099014号](https://beian.miit.gov.cn/#/Integrated/index) | [沪公安网备
![](https://image.3001.net/images/20200106/1578291342_5e12d08ec2379.png)](http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31011502009321)