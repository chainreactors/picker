---
title: 内核漏洞学习记录（CVE-2021-22555）
url: https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458565629&idx=1&sn=f07b4983ee9378e3146d939c02c51bd7&chksm=b18d8b7786fa0261a9685c18bcc980819b8524e61e75ea1af315b5b383bde56947b61658691e&scene=58&subscene=0#rd
source: 看雪学苑
date: 2024-08-04
fetch_date: 2025-10-06T18:03:52.779482
---

# 内核漏洞学习记录（CVE-2021-22555）

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GRSx16NymEZASvWUkD0o0xWUXEWxibWGaibflqicCbyz8740u7ic974GAEbZJibV5uZoHKzng7Im2TsNQ/0?wx_fmt=jpeg)

# 内核漏洞学习记录（CVE-2021-22555）

pureGavin

看雪学苑

```
一

前言
```

看雪的二进制课程已经学习结束了，此篇是考核内容，顺便检测一下我对课程内容的理解程度。

### 参考内容

https://www.anquanke.com/post/id/254027

https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/

https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html

以及看雪的二进制课程。

```
二

漏洞分析
```

先看一下kasan给出的信息。

```
[ 1185.205439] ==================================================================
[ 1185.205993] BUG: KASAN: slab-out-of-bounds in xt_compat_target_from_user+0x20a/0x4c0 [x_tables]
[ 1185.206102] Write of size 4 at addr ffff8881e4c97600 by task poc/2059

[ 1185.206255] CPU: 1 PID: 2059 Comm: poc Not tainted 5.8.1 #1
[ 1185.206257] Hardware name: VMware, Inc. VMware Virtual Platform/440BX Desktop Reference Platform, BIOS 6.00 11/12/2020
[ 1185.206259] Call Trace:
[ 1185.206326]  dump_stack+0x9d/0xda
[ 1185.206346]  print_address_description.constprop.0+0x1f/0x210
[ 1185.206353]  ? _raw_spin_lock_irqsave+0x8e/0xf0
[ 1185.206355]  ? _raw_spin_trylock_bh+0x130/0x130
[ 1185.206371]  ? xt_compat_target_from_user+0x20a/0x4c0 [x_tables]
[ 1185.206373]  kasan_report.cold+0x37/0x7c
[ 1185.206377]  ? xt_compat_target_from_user+0x20a/0x4c0 [x_tables]
[ 1185.206390]  check_memory_region+0x15b/0x1e0
[ 1185.206393]  memset+0x24/0x50
[ 1185.206399]  xt_compat_target_from_user+0x20a/0x4c0 [x_tables]
[ 1185.206406]  ? xt_compat_match_from_user+0x4c0/0x4c0 [x_tables]
[ 1185.206410]  ? __kmalloc_node+0x127/0x380
[ 1185.206416]  translate_compat_table+0xf00/0x16d0 [ip6_tables]
[ 1185.206420]  ? ip6t_register_table+0x2d0/0x2d0 [ip6_tables]
[ 1185.206423]  ? kasan_unpoison_shadow+0x38/0x50
[ 1185.206425]  ? __kasan_kmalloc.constprop.0+0xcf/0xe0
[ 1185.206427]  ? kasan_kmalloc+0x9/0x10
[ 1185.206428]  ? __kmalloc_node+0x127/0x380
[ 1185.206431]  ? __kasan_check_write+0x14/0x20
[ 1185.206433]  compat_do_replace.isra.0+0x160/0x380 [ip6_tables]
[ 1185.206435]  ? __kasan_check_write+0x14/0x20
[ 1185.206438]  ? translate_compat_table+0x16d0/0x16d0 [ip6_tables]
[ 1185.206453]  ? apparmor_task_alloc+0x2f0/0x2f0
[ 1185.206465]  ? is_bpf_text_address+0xe/0x20
[ 1185.206478]  ? ns_capable_common+0x5c/0xe0
[ 1185.206481]  compat_do_ip6t_set_ctl+0xe4/0x130 [ip6_tables]
[ 1185.206496]  compat_nf_setsockopt+0x74/0x100
[ 1185.206503]  compat_ipv6_setsockopt.part.0+0x582/0x780
[ 1185.206505]  ? ipv6_setsockopt+0x110/0x110
[ 1185.206507]  ? save_stack+0x42/0x50
[ 1185.206509]  ? save_stack+0x23/0x50
[ 1185.206511]  ? __kasan_kmalloc.constprop.0+0xcf/0xe0
[ 1185.206513]  ? kasan_slab_alloc+0xe/0x10
[ 1185.206514]  ? kmem_cache_alloc+0xd7/0x250
[ 1185.206521]  ? security_file_alloc+0x2f/0x130
[ 1185.206525]  ? __alloc_file+0xb1/0x370
[ 1185.206526]  ? alloc_empty_file+0x46/0xf0
[ 1185.206529]  ? alloc_file+0x59/0x500
[ 1185.206530]  ? alloc_file_pseudo+0x17e/0x270
[ 1185.206535]  ? sock_alloc_file+0x47/0x170
[ 1185.206537]  ? __sys_socket+0x108/0x1d0
[ 1185.206541]  ? __do_compat_sys_socketcall+0x51c/0x5e0
[ 1185.206543]  ? __ia32_compat_sys_socketcall+0x53/0x70
[ 1185.206549]  ? do_syscall_32_irqs_on+0x4a/0x70
[ 1185.206552]  ? do_fast_syscall_32+0x5f/0xd0
[ 1185.206554]  ? do_SYSENTER_32+0x1f/0x30
[ 1185.206558]  ? entry_SYSENTER_compat_after_hwframe+0x4d/0x5f
[ 1185.206560]  ? __ia32_compat_sys_socketcall+0x53/0x70
[ 1185.206561]  ? do_syscall_32_irqs_on+0x4a/0x70
[ 1185.206563]  ? do_fast_syscall_32+0x5f/0xd0
[ 1185.206565]  ? do_SYSENTER_32+0x1f/0x30
[ 1185.206567]  ? entry_SYSENTER_compat_after_hwframe+0x4d/0x5f
[ 1185.206569]  ? __ia32_compat_sys_socketcall+0x53/0x70
[ 1185.206571]  ? do_syscall_32_irqs_on+0x4a/0x70
[ 1185.206573]  ? do_fast_syscall_32+0x5f/0xd0
[ 1185.206575]  ? do_SYSENTER_32+0x1f/0x30
[ 1185.206577]  ? entry_SYSENTER_compat_after_hwframe+0x4d/0x5f
[ 1185.206579]  ? __sys_socket+0xdd/0x1d0
[ 1185.206581]  ? __do_compat_sys_socketcall+0x51c/0x5e0
[ 1185.206583]  ? __ia32_compat_sys_socketcall+0x53/0x70
[ 1185.206585]  ? do_syscall_32_irqs_on+0x4a/0x70
[ 1185.206587]  ? do_fast_syscall_32+0x5f/0xd0
[ 1185.206588]  ? do_SYSENTER_32+0x1f/0x30
[ 1185.206590]  ? entry_SYSENTER_compat_after_hwframe+0x4d/0x5f
[ 1185.206595]  ? __mod_lruvec_state+0x8c/0x320
[ 1185.206598]  ? alloc_pages_current+0xdc/0x1c0
[ 1185.206600]  ? kasan_init_slab_obj+0x25/0x30
[ 1185.206603]  ? setup_object.isra.0+0x2b/0xa0
[ 1185.206605]  ? __kasan_check_write+0x14/0x20
[ 1185.206607]  ? apparmor_file_alloc_security+0x178/0x5c0
[ 1185.206609]  ? kasan_unpoison_shadow+0x38/0x50
[ 1185.206611]  ? apparmor_ptrace_access_check+0x460/0x460
[ 1185.206613]  ? security_file_alloc+0x2f/0x130
[ 1185.206614]  ? kmem_cache_alloc+0x180/0x250
[ 1185.206617]  ? __kasan_check_write+0x14/0x20
[ 1185.206619]  ? __mutex_init+0xba/0x130
[ 1185.206621]  ? __alloc_file+0x1a5/0x370
[ 1185.206623]  ? alloc_empty_file+0x92/0xf0
[ 1185.206625]  ? alloc_file+0x228/0x500
[ 1185.206629]  ? _cond_resched+0x19/0x30
[ 1185.206632]  ? aa_sk_perm+0x12a/0x610
[ 1185.206634]  compat_ipv6_setsockopt+0xb4/0x160
[ 1185.206640]  ? __fget_files+0x12b/0x250
[ 1185.206647]  inet_csk_compat_setsockopt+0x6b/0x120
[ 1185.206650]  compat_tcp_setsockopt+0x1c/0x30
[ 1185.206653]  compat_sock_common_setsockopt+0x8a/0x160
[ 1185.206655]  __compat_sys_setsockopt+0x139/0x330
[ 1185.206658]  ? __sys_socket+0x11b/0x1d0
[ 1185.206660]  ? __x32_compat_sys_recvmmsg_time32+0x150/0x150
[ 1185.206662]  ? __kasan_check_write+0x14/0x20
[ 1185.206664]  __do_compat_sys_socketcall+0x48c/0x5e0
[ 1185.206667]  ? __x32_compat_sys_setsockopt+0x150/0x150
[ 1185.206673]  ? perf_event_namespaces+0x1a/0x30
[ 1185.206677]  ? walk_process_tree+0x330/0x330
[ 1185.206679]  ? __kasan_check_read+0x11/0x20
[ 1185.206684]  ? fpregs_assert_state_consistent+0x22/0xa0
[ 1185.206686]  ? __prepare_exit_to_usermode+0x76/0x210
[ 1185.206688]  ? fpregs_assert_state_consistent+0x22/0xa0
[ 1185.206690]  __ia32_compat_sys_socketcall+0x53/0x70
[ 1185.206693]  do_syscall_32_irqs_on+0x4a/0x70
[ 1185.206696]  do_fast_syscall_32+0x5f/0xd0
[ 1185.206698]  do_SYSENTER_32+0x1f/0x30
[ 1185.206700]  entry_SYSENTER_compat_after_hwframe+0x4d/0x5f
[ 1185.206705] RIP: 0023:0xf7f08569
[ 1185.206711] Code: c4 01 10 03 03 74 c0 01 10 05 03 74 b8 01 10 06 03 74 b4 01 10 07 03 74 b0 01 10 08 03 74 d8 01 00 51 52 55 89 e5 0f 34 cd 80 <5d> 5a 59 c3 90 90 90 90 8d b4 26 00 00 00 00 8d b4 26 00 00 00 00
[ 1185.206712] RSP: 002b:00000000ffed1440 EFLAGS: 00000246 ORIG_RAX: 0000000000000066
[ 1185.206715] RAX: ffffffffffffffda RBX: 000000000000000e RCX: 00000000ffed1458
[ 1185.206716] RDX: 00000000ffed14bc RSI: 00000000f7ef5000 RDI: 00000000ffed16cc
[ 1185.206717] RBP: 00000000ffed16e8 R08: 0000000000000000 R09: 0000000000000000
[ 1185.206718] R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000000
[ 1185.206719] R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000

[ 1185.206746] Allocated by task 2059:
[ 1185.206836]  save_stack+0x23/0x50
[ 1185.206838]  __kasan_kmalloc.constprop.0+0xcf/0xe0
[ 1185.206840]  kasan_kmalloc+0x9/0x10
[ 1185.206842]  __kmalloc_node+0x127/0x380
[ 1185.206845]  kvmalloc_node+0x7b/0x90
[ 1185.206855]  xt_alloc_table_info+0x2f/0x80 [x_tables]
[ 1185.206860]  translate_compat_table+0xb38/0x16d0 [ip6_tables]
[ 1185.206862]  compat_do_replace.isra.0+0x160/0x380 [ip6_tables]
[ 1185.206865]  compat_do_ip6t_set_ctl+0xe4/0x130 [ip6_tables]
[ 1185.206868]  compat_nf_setsockopt+0x74/0x100
[ 1185.206871]  compat_ipv6_setsockopt.part.0+0x582/0x780
[ 1185.206873]  compat_ipv6_setsockopt+0xb4/0x160
[ 1185.206875]  inet_csk_compat_setsockopt+0x6b/0x120
[ 1185.206877]  compat_tcp_setsockopt+0x1c/0x30
[ 1185.206879]  compat_sock_common_setsockopt+0x8a/0x160
[ 1185.206882]  __compat_sys_setsockopt+0x139/0x330
[ 1185.206884]  __do_compat_sys_socketcall+0x48c/0x5e0
[ 1185.206886]  __ia32_compat_sys_socketcall+0x53/0x70
[ 1185.206889]  do_syscall_32_irqs_on+0x4a/0x70
[ 1185.206892]  do_fast...