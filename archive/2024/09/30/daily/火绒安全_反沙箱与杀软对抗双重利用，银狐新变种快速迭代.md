---
title: 反沙箱与杀软对抗双重利用，银狐新变种快速迭代
url: https://mp.weixin.qq.com/s?__biz=MzI3NjYzMDM1Mg==&mid=2247520116&idx=1&sn=4c494ebc1f5d3f7bfd888cd7931ae29a&chksm=eb70514bdc07d85d981016a7b85d68e9d32bc10be95326933db6ab26ebb8a2e4dd44525b6c32&scene=58&subscene=0#rd
source: 火绒安全
date: 2024-09-30
fetch_date: 2025-10-06T18:25:40.551559
---

# 反沙箱与杀软对抗双重利用，银狐新变种快速迭代

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicwrhjApe7IQiaCyPiajUzEpvvegV3GGQHmttcPDE6ejHPKCw50sjC0f0w/0?wx_fmt=jpeg)

# 反沙箱与杀软对抗双重利用，银狐新变种快速迭代

原创

火绒安全

火绒安全

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/0icdicRft8tz4nrnOI1emtFr0UYnrLKytAvy2gia6ZuIUJs14h2pEIwpiaWPCTTuCQIDibx9dlfXoyrNyVEWb8DVUUA/640?wx_fmt=gif&from=appmsg)

近期，火绒威胁情报中心监测到一批相对更加活跃的“银狐”系列变种木马，火绒安全工程师第一时间提取样本进行分析。分析中发现样本具有检测沙箱和杀毒软件的行为，还会下载 TrueSightKiller 驱动关闭杀软，同时下载创建计划任务的 Shellcode 实现持久化，最终下载后门模块实现远程控制。目前，火绒安全产品可对上述病毒进行拦截查杀，请广大用户及时更新病毒库以提高防御能力。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqichJyic2zicibic9XCpX4iapW6vxsFylK1IBG0pUOLe6icUgAkNVHSMicSPia0aw/640?wx_fmt=png&from=appmsg)

火绒查杀图

根据火绒威胁情报中心监测情况显示，该系列木马在 9 月 14 日被截获处理，其传播量在  9 月 18 日达到顶峰，直至 9 月 20 日不再活跃。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqic4xSFo3B8ydM0CcQ7eqKze8efEpNuAd4SW7KzzIGwaOVrtbWsWibBbvg/640?wx_fmt=png&from=appmsg)

活跃趋势

样本执行流程如下所示：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicMNfhGialtv5yjpQnyE0AYsddY04xJVqJ0MWuiatzU4NVXqYK2HiaFh8Hg/640?wx_fmt=png&from=appmsg)

流程图

**一**

**样本分析**

该样本最初通过分配内存，复制 0x14002EB20 处代码并调用。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicG3XAM47nBDOt8yBGRWr4V7YPKzic88SGDp3LRPrr6ZEVh7hM3WSUNnw/640?wx_fmt=png&from=appmsg)

复制内存

随后通过异或算法对 210002E 处代码进行解密。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicFGInuX48vbu9GtNIh5PicZ5WLeGxQM55QRhFNkgznZaDN5L8MclIbHQ/640?wx_fmt=png&from=appmsg)

解密

之后的具体逻辑如图所示，包含检测沙箱、检测安全软件、关闭安全软件、使函数失效、创建互斥体以及判断管理员权限等操作。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqichXUC3TIXtvKTADrcc2OmxA6u9icySbDmgnJkhg6CRmqWBtpBeZdCppQ/640?wx_fmt=png&from=appmsg)

具体逻辑

其中创建互斥体的代码如下，此操作用来检测两个互斥体是否存在，若不存在，则先创建其中之一互斥体，后续创建另一个互斥体。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicUc1eAswvg38ibgndBmewW3AAxnoquev5oia6O9m12nbxHc6nC7DxFDpg/640?wx_fmt=png&from=appmsg)

创建互斥体

检测管理员权限代码如下，如果没有权限则会重新用管理员权限打开。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqic5z3Daicjl4aZ8SoNkzTicT46AfnJvCgXXP16nkSUt7WLObSXSUCNlgMg/640?wx_fmt=png&from=appmsg)

管理员权限启动

**反沙箱**

该银狐样本中存在大量反沙箱操作。

通过生僻函数 VirtualAllocExNuma 进行分配内存，若成功则直接返回，并继续执行后续操作。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicqb2GbDAQsyLfw11DeLLTtby3cNl1dtH9icI0ll0ic7Muiaicb3BcXSGzSA/640?wx_fmt=png&from=appmsg)

生僻函数

通过 HeapAlloc 分配相对大的内存—95MB来检测沙箱，并进行 for 循环加。猜测此过程可能是用于检测某些沙箱为了缩短检测时间直接跳过的情况。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicuLYK1Vs89BFq021N0BFsbD7etibLSb8cIDvgm5gM2JahRJM60WmNSzw/640?wx_fmt=png&from=appmsg)

检测沙箱

通过三个函数判断：

* 时间是否被加速。
* CPU 速度是否过慢。
* rdtsc 是否被篡改使 frndint 计算周期数过小。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicDgTibqkXJ5hnj09OibpydjiczjOpzZHm0CIqp5yxhRHyFyET557enqEOQ/640?wx_fmt=png&from=appmsg)

反沙箱

判断程序是否处于 Windows Defender 沙箱中：

* 利用 NtCompressKey 特定句柄传入返回是否成功。
* 利用 NtIsProcessInJob 传入特定值返回 STATUS\_VOLSNAP\_HIBERNATE\_READY {卷影复制服务}系统现在处于休眠状态。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqiclrJKoWwoIDpLXHAMdLv9qTmtUjiapHFAsgHUqd89W16jMy0Krp6ibgIw/640?wx_fmt=png&from=appmsg)

检测 Windows Defender 沙箱

如果不成功，则会检测 SxIn.dll 是否被加载。猜测是以此判断程序是否处于隔离沙箱中。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicAp2ZFqUTbUbD8SOQEicHhqfWmGxjiawpVBQYRDJm5Kv99SY7ZXsoS5iag/640?wx_fmt=png&from=appmsg)

检测隔离沙箱

检测 CPU 核数大于等于 2 个以上。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicoKFHrCeArBWKpTWJWYonWiakSINYyt1iaEOLibswaqWol3icUpy5Af4Pdg/640?wx_fmt=png&from=appmsg)

CPU 数量

**安全软件对抗**

样本会通过 VirtualProtect 函数更改内存权限，然后将该函数第一个指令替换为 retn ，使 AmsiScanBuffer 和 NtTraceEvent 函数失效。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicImph9uLAic6SW3dicK7Ggj2VXHiaexRQGFXHa784Tupr5Fvlic4duIRvFg/640?wx_fmt=png&from=appmsg)

Hook 函数

检测是否存在 360tray.exe、360sd.exe、360safe.exe 进程名，若不存在，则进一步搜索相关窗口类名为 Q360SafeMonClass 的窗口。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqica6qVrsLdR9q2KxoulEG3AuicTuRdqg0W6jyfTTLic9BAL6e7cpLhotOA/640?wx_fmt=png&from=appmsg)

检测安全软件

如果检测到类名为 Q360SafeMonClass 的窗口，则会利用 PostMessageA 函数将其关闭。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicoE1qaf87EEicUuvzQJYa2LVM1ibPlT76jkX7tTbU67yVFPIHAH9X3Vzg/640?wx_fmt=png&from=appmsg)

关闭窗口

其中 EnumWindow 遍历窗口时，通过 ChangeWindowMessageFilterEx 函数使该窗口允许接收 WM\_QUIT 指令，随后利用发送消息的方式关闭该窗口。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqic85iauGicib4qjVibicfSVnJt8qDOxAGiaZicFGswPtwylWibiat21qvWVBzbWnA/640?wx_fmt=png&from=appmsg)

关闭窗口

如果安全软件不存在，则会将 'C:\\','C:\\ProgramData','C:\\Users','C:\\Program Files (x86)' 路径添加到 Windows Defender 白名单中，以躲避检测。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicIiaC78JXbVJqb7icoVEwm7ykKOKKmWsIZRW75pkicbNfahRJiaXFU17cGQ/640?wx_fmt=png&from=appmsg)

添加白名单

**下载 PACqpC.exe**

完成上述一系列检查后，该样本会下载一些文件和 Shellcode ，比如：TrueSightKiller 驱动程序和用于创建计划任务的 Shellcode 等。

大致流程如下：解密链接，利用链接下载内容，并使用流密码进行解密，之后创建文件夹并隐藏文件夹。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqic2yxQurQlx2Bd8m66FfWJMqjejfX9D3N0SzJYI3ngTLeic6WceEw9ibpg/640?wx_fmt=png&from=appmsg)

具体流程

样本在此流程中，利用 InternetReadFile API 函数下载数据。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicTNjPibY3cVia6CztxmOzx3KM9lTq4muvRK4fpEbX78Xia0mTxibia78tZMA/640?wx_fmt=png&from=appmsg)

下载数据

其中，下载链接和下载的数据分别利用凯撒密码和简单流密码进行解密。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicf920v7yedJVaKnttP0WWQtNHBRqGykSmTZ2BPodKW6fJR3I1pMYMtg/640?wx_fmt=png&from=appmsg)

解密算法

解密后的 URL 数据如图所示，包含下载链接和相对应的文件名。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicKCibica6qYUE2zsr3FsOU5gIiaDzRm3aqpqOZZ1SfpNF2rbK31ibcyeIxg/640?wx_fmt=png&from=appmsg)

URL 数据

随后检查是否有安全软件。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqictNGwt4QNgrb97iaXOQI1w5QplpEIcy7VwmZ9he5jfbqCvHg9keSqPtw/640?wx_fmt=png&from=appmsg)

检查安全软件是否存在

如果检查到安全软件，将保持之后下载到的数据解密并写入文件后的文件句柄处于开启状态，以此阻止安全软件的读取。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicRFBQejlPAjqxzLtGCicwib6sTjhGNRYNkibotktSSR094Za1r0Dtw5b7A/640?wx_fmt=png&from=appmsg)

写入文件

下载后开始分析数据，并提取出异或秘钥和数据开头地址。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqic2nqtm0sJ3icTPmDiamEJdYhTT8V67GXgwzeyVUibjLYQpVyDvk7XWRVNg/640?wx_fmt=png&from=appmsg)

分析数据

开始下载 a.gif、b.gif、c.gif、d.gif ，它们分别对应 install.exe（即随机名 PACqpC.exe ）、hccutils.dll、1.gif、2.jpg 。这些文件中的最后一个字节用作异或解密的秘钥，倒数第五个字节至倒数第二个字节用于计算出数据开头偏移，其中 b.gif 的最后四位会写入随机数。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicauYE4PAkjzWYLhfKGULrv5DnGvJfLkwoFaEQD92LicPdnN7Ff4dYxqQ/640?wx_fmt=png&from=appmsg)

整体逻辑

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicjsK7Z86rOZGcrbGIjfpqAGicP80v8E5ia5JuvMG6jSuU8a2pEianialMow/640?wx_fmt=png&from=appmsg)

异或、随机数、获取秘钥和偏移

随后会读取自身内容，并利用 \*/& 定位，将 32 位随机数+\*/&之后的 36 位数据写入到 C:\Users\InstallUP.ini 文件中。这些数据是被加密的 IP 和端口，用于下载后门模块后的动态替换 IP 和端口。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicTDCKj8JfibH1hhTf1tRK82sOaYqMEsLZC24yK0Z6Ywvk3rVqib6B4EbQ/640?wx_fmt=png&from=appmsg)

InstallUP.ini 文件

接着通过链接 https://197oss.oss-cn-beijing.aliyuncs.com/s.dat 下载 TrueSightKiller 驱动，并将此驱动写入到 C:\Users\TTruespanl.sys 中，同时保持文件句柄处于开启状态。该驱动用于关闭杀毒软件。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicLuHlGrmAqzm3VvcTWbyPeUrZhsPdygic3HqEV0NxPlCB2oKbTeoNAng/640?wx_fmt=png&from=appmsg)

下载驱动

之后通过链接 https://197oss.oss-cn-beijing.aliyuncs.com/s.jpg 下载 Shellcode ，通过利用 VirtualProtect 设置执行权限并执行。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz6g3VgibzzSeZd1Oic702SKqicEPK5nsdyj9hKxBfOR2soCS3xEMLVWHjA0NceWhYhHzrSQIIZvtaChQ/640?wx_fmt=png&from=appmsg)

下载执行 Shellcode

Shellcode 中存在被压缩的 Dll ，对其进行解压缩后手动加载，并从中获取 Regis...