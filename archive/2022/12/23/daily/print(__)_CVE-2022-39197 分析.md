---
title: CVE-2022-39197 分析
url: https://www.o2oxy.cn/4157.html
source: print("")
date: 2022-12-23
fetch_date: 2025-10-04T02:20:10.907647
---

# CVE-2022-39197 分析

![print("")](https://www.o2oxy.cn/wp-content/themes/JieStyle-Two/images/avatar.jpg)

### print("")

* [Home](http://www.o2oxy.cn)
* [信息安全](https://www.o2oxy.cn/category/%E5%AE%89%E5%85%A8)
* [WEB前端](https://www.o2oxy.cn/category/web%E5%89%8D%E7%AB%AF)
* [linux](https://www.o2oxy.cn/category/linux)
* [python](https://www.o2oxy.cn/category/%E6%95%B0%E6%8D%AE%E5%BA%93)
* [监控](https://www.o2oxy.cn/category/%E7%9B%91%E6%8E%A7)
* [生活](https://www.o2oxy.cn/category/%E7%94%9F%E6%B4%BB)
* [Java学习](https://www.o2oxy.cn/category/%E5%AE%89%E5%85%A8/java)
* [宝塔面板最新活动](https://www.bt.cn/huodong)
* [Author](https://www.o2oxy.cn/tags)

# CVE-2022-39197 分析

作者: print("")
分类: [Java学习](https://www.o2oxy.cn/category/%E5%AE%89%E5%85%A8/java),[信息安全](https://www.o2oxy.cn/category/%E5%AE%89%E5%85%A8)
发布时间: 2022-12-22 17:50
阅读次数: 4,356 次

之前9月份的时候，忘记写了。现在重新写一份记录一下整个过程。利用过程的查找真的是废了眼睛

CobaltStrike官方发布的最新4.7.1版本的更新日志中介绍，<=4.7的teamserver版本存在XSS漏洞

## **一、swing漏洞**

CobaltStrike 使用的组件为swing  那么首先了解一下他是怎么解析使用html

<https://docs.oracle.com/javase/tutorial/uiswing/components/html.html>

解析HTMl Demo

```
import javax.swing.*;
import java.awt.*;

public class demo {
    /**{
     * 创建并显示GUI。出于线程安全的考虑，
     * 这个方法在事件调用线程中调用。
     */
    private static void createAndShowGUI() {
        // 确保一个漂亮的外观风格
        JFrame.setDefaultLookAndFeelDecorated(true);
        // 创建及设置窗口
        JFrame frame = new JFrame("HelloWorldSwing");
        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        frame.setPreferredSize(new Dimension(800, 600));
        // 添加 "Hello World" 标签
        JLabel label = new JLabel("<html><h1>66666</h1></html>");
        frame.getContentPane().add(label);
        // 显示窗口
        frame.pack();
        frame.setVisible(true);
    }
    public static void main(String[] args) {
        // 显示应用 GUI
        javax.swing.SwingUtilities.invokeLater(new Runnable() {
            public void run() {
                createAndShowGUI();
            }
        });
    }
}
```

[![](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ截图20221222171610.png)](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ%E6%88%AA%E5%9B%BE20221222171610.png)

追踪一下解析html 的过程 发现最终会调用到javax.swing.text.html.HTML.java

[![](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ截图20221222172506.png)](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ%E6%88%AA%E5%9B%BE20221222172506.png)

会循环调用 每个TAG 标签。 执行完之后会经过javax/swing/text/html/HTMLDocument.HTMLReader 进行一个初始化

每个标签都有一个初始化函数例如：

[![](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ截图20221222173151.png)](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ%E6%88%AA%E5%9B%BE20221222173151.png)

例如A标签

[![](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ截图20221222173448.png)](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ%E6%88%AA%E5%9B%BE20221222173448.png)

这里大概明白了 他的一个整体的逻辑了。就是每个TAG 都有一个或者公用的一个类。

然后进入到javax/swing/text/html/HTMLEditorKit.create 函数中

[![](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ截图20221222174235.png)](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ%E6%88%AA%E5%9B%BE20221222174235.png)

在HTMLEditorKit里的create方法可以看到不同的标签会对应到创建不同的view

那么顺序是Read –> create –>new xx 视图。例如H6标签。如下

[![](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ截图20221222174522.png)](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ%E6%88%AA%E5%9B%BE20221222174522.png)

其中发现一个有意思的标签javax/swing/text/html/ObjectView

[![](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ截图20221222174754.png)](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ%E6%88%AA%E5%9B%BE20221222174754.png)

例子如下：

```
        <object classid="javax.swing.JLabel">
        <param name="text" value="sample text">
        </object>
```

代码如下：

```
  /**
     * Create the component.  The classid is used
     * as a specification of the classname, which
     * we try to load.
     */
    protected Component createComponent() {
        AttributeSet attr = getElement().getAttributes();
        String classname = (String) attr.getAttribute(HTML.Attribute.CLASSID);
        try {
            ReflectUtil.checkPackageAccess(classname);
            Class c = Class.forName(classname, true,Thread.currentThread().
                                    getContextClassLoader());
            Object o = c.newInstance();
            if (o instanceof Component) {
                Component comp = (Component) o;
                setParameters(comp, attr);
                return comp;
            }
        } catch (Throwable e) {
            // couldn't create a component... fall through to the
            // couldn't load representation.
        }

        return getUnloadableRepresentation();
    }
```

首先获取了classid  字符串名称。然后直接获取了这个类的对象。然后进行实例化这个类。。但是这个有一个条件，就是为 Component  类或者是他的子类

那么看看。对应的key VALUE 的设置

[![](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ截图20221222180526.png)](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ%E6%88%AA%E5%9B%BE20221222180526.png)

那么总结一下这个object 的利用的条件

```
classid传入需要实例化的类，类必须继承与Component
必须有无参构造方法，貌似是因为newinstant是调用的无参构造方法
必须存在一个setXXX方法的XXX属性
setXXX方法的传参数必须是接受一个string类型的参数
```

那么根据如上的要求。写了一个Demo

```
import java.awt.Dimension;
import javax.swing.*;
public class demo {
    private static void createAndShowGUI() {

        // 确保一个漂亮的外观风格
        JFrame.setDefaultLookAndFeelDecorated(true);
        // 创建及设置窗口
        JFrame frame = new JFrame("HelloWorldSwing");
        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        frame.setPreferredSize(new Dimension(800, 600));
        // 添加 "Hello World" 标签
        String payload = "<html><object classid='javax.swing.JLabel'><param name='text' value='test'></object>";
        System.out.println(payload);
        JLabel label = new JLabel(payload);

        frame.getContentPane().add(label);

        // 显示窗口
        frame.pack();
        frame.setVisible(true);
    }

    public static void main(String[] args) {
        // 显示应用 GUI
        javax.swing.SwingUtilities.invokeLater(new Runnable() {
            public void run() {
                createAndShowGUI();
            }
        });
    }

}
```

[![](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ截图20221222165442.png)](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ%E6%88%AA%E5%9B%BE20221222165442.png)

```
JLabel 继承链--> JComponent -->Container  -->Component
```

public class JLabel extends JComponent implements SwingConstants, Accessible

这里是引用了。javax.swing.JLabel.setText 函数

[![](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ截图20221222180853.png)](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ%E6%88%AA%E5%9B%BE20221222180853.png)

## **二、CobaltStrike 代码类的寻找**

首先我们先导入任意一个版本的CS jar包到当前项目中

[![](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ截图20221222181347.png)](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ%E6%88%AA%E5%9B%BE20221222181347.png)

通过Navigate —–> Type Hierarchy  查询所有的子类

[![](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ截图20221222184626.png)](https://www.o2oxy.cn/wp-content/uploads/2022/12/QQ%E6%88%AA%E5%9B%BE20221222184626.png)

还可以使用codeql 进行查询

```
class SetMethod extends Method{
    SetMethod(){
        this.getDeclaringType().getASupertype*().hasQualifiedName("java.awt", "Component") and
        this.getName().indexOf("set") = 0 and
        this.getName().length() > 3 and
        this.isPublic() and
        this.fromSource() and
        this.getNumberOfParameters() = 1
        and this.getAParamType().getName() = "String"
        and this.getTotalNumberOfLines() > 3
        and this.getDeclaringType().getAConstructor().isPublic()
        and this.getDeclaringType().getAConstructor().hasNoParameters()
    }
}

from SetMethod setMethod
select setMethod, setMethod.getDeclaringType().getPackage().getName()+"."+setMethod.getDeclaringType()
```

大概找了好几个小时之后。就发现了这个类比较符合条件的

org.apache.batik.swing.JSVGCanvas.setURI()

```
    public void setURI(String var1) {
        String var2 = this.uri;
        this.uri = var1;
        if (this.uri != null) {
            this.loadSVGDocument(this.uri);
        } else {
            t...