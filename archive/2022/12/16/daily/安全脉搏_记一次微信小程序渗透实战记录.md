---
title: 记一次微信小程序渗透实战记录
url: https://www.secpulse.com/archives/193629.html
source: 安全脉搏
date: 2022-12-16
fetch_date: 2025-10-04T01:39:09.875420
---

# 记一次微信小程序渗透实战记录

[![](https://www.secpulse.com/wp-content/themes/secpulse2017/img/logo-header.png)](https://www.secpulse.com "安全脉搏")

* [首页](https://www.secpulse.com/)
* [分类阅读](https://www.secpulse.com/archives/category/category)

  #### 脉搏文库

  - [内网渗透](https://www.secpulse.com/archives/category/articles/intranet-penetration)
  - |
  - [代码审计](https://www.secpulse.com/archives/category/articles/code-audit)
  - |
  - [安全文献](https://www.secpulse.com/archives/category/articles/sec-doc)
  - |
  - [Web安全](https://www.secpulse.com/archives/category/articles/web)
  - |
  - [移动安全](https://www.secpulse.com/archives/category/articles/mobile-security)
  - |
  - [系统安全](https://www.secpulse.com/archives/category/articles/system)
  - |
  - [工控安全](https://www.secpulse.com/archives/category/articles/industrial-safety)
  - |
  - [CTF](https://www.secpulse.com/archives/category/exclusive/ctf-writeup)
  - |
  - [IOT安全](https://www.secpulse.com/archives/category/iot-security)
  - |

#### 安全建设

+ [业务安全](https://www.secpulse.com/archives/category/construction/businesssecurity)
+ |
+ [安全管理](https://www.secpulse.com/archives/category/construction/securityissue)
+ |
+ [数据分析](https://www.secpulse.com/archives/category/construction/bigdata)
+ |

#### 其他

+ [资讯](https://www.secpulse.com/archives/category/news)
+ |
+ [漏洞](https://www.secpulse.com/archives/category/vul)
+ |
+ [工具](https://www.secpulse.com/archives/category/tools)
+ |
+ [人物志](https://www.secpulse.com/archives/category/people)
+ |
+ [区块链安全](https://www.secpulse.com/archives/category/exclusive/block_chain_security)
+ |
+ [安全招聘](https://www.secpulse.com/archives/category/hiring)
+ |

- [安全问答](https://www.secpulse.com/newpage/question_list)
- [金币商城](https://www.secpulse.com/shop?donotcachepage=c010349fd98847cb9d6e07d3cbc19288)
- [安全招聘](https://www.secpulse.com/archives/category/hiring)
- [活动日程](https://www.secpulse.com/newpage/activity)
- [live课程](https://www.secpulse.com/live)
- [企业服务](https://duoyinsu.com/service.html)
- [插件社区](https://x.secpulse.com/)

小程序

![脉搏小程序](https://www.secpulse.com/wp-content/themes/secpulse2017/img/wxchat.jpg)
[登录](https://www.secpulse.com/user_login)
|
[注册](https://www.secpulse.com/user-register)

# 记一次微信小程序渗透实战记录

[移动安全](https://www.secpulse.com/archives/category/articles/mobile-security)

[潇湘信安](https://www.secpulse.com/newpage/author?author_id=37983)
![]( https://www.secpulse.com/wp-content/themes/secpulse2017/img/renzheng3.png)

2022-12-15

23,188

|  |
| --- |
| **声明：**该公众号大部分文章来自作者日常学习笔记，也有部分文章是经过作者授权和其他公众号白名单转载，未经授权，严禁转载，如需转载，联系开白。  请勿利用文章内的相关技术从事非法测试，如因此产生的一切不良后果与文章作者和本公众号无关。 |

文章来源：奇安信攻防社区（dota\_st）

原文地址：https://forum.butian.net/share/1227

**0x00 前言**

最近好多小伙伴都在问怎么对微信小程序进行渗透，遂写篇文章抛砖引玉。

**0x01 环境准备**

我使用的是夜神模拟器配合 burpsuite 进行抓包。夜神模拟器我使用的是`6.6.1.1`的版本，算是很老的版本了，内设系统为`Android5.0`。新的版本中安卓似乎都是7.0以上了，抓取 HTTPS 包会比较麻烦，所以我就一直没有换版本。如果有需要的朋友可以自取，后面会打包云盘在文章底部。

首先我们需要设置好抓包环境，先通过`ipconfig`查看我们当前 ip，这里我用的是以太网，也就是插着网线；如果是连着 WIFI，则找对应的即可

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091018.png)

在 burpsuite 添加上，这里我设置端口为`8888`，可以按照自己需求更改

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091020.png)

打开夜神模拟器，在 WLAN 选择手动代理，并设置代理地址和代理端口，和 burpsuite 对应

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091021.png)

保存后，打开浏览器访问`ip:port`，这里的话为`192.168.1.102:8888`，点击`CA Certificate`下载证书

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091022.png)

打开文件管理器，在`sdcard->Download`目录中可以看到下载下来的证书

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091023.png)

将`cacert.der`更名为`cacert.cer`，也就是将后缀改成`cer`，然后到手机设置->安全中，选择从 SD 卡安装

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091024.png)

安装证书

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091025.png)

测试一下，浏览器访问百度，burpsuite 能正常抓包说明已经设置环境成功

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091027.png)

**0x02 反编译微信小程序代码**

我们在模拟器里登录微信，然后随便选择一个微信小程序打开

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091029.png)

打开文件管理器，在`data/data/com.tencent.mm/MicroMsg`会生成一个md5加密命名的文件夹（如果打开微信小程序过多，同时有多个文件夹不容易识别的情况，可以选择把`MicroMsg`文件夹所有内容删除掉，再去重新打开微信小程序，就会得到唯一一个MD5加密命名的文件夹啦）

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091030.png)

在该文件夹下的`appbrand/pkg`目录下找到`.wxapkg`后缀结尾的文件，其中只有几MB大小的为刚刚打开的小程序的文件

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091031.png)

点击勾选之后，来到根目录下的`mnt/shared/App`目录，打开右上角三个`.`的功能菜单选择粘贴选择项，将文件复制到该文件夹

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091032.png)

这里的文件夹就是电脑共享的文件夹，点击打开电脑文件夹

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-16710910321.png)

可以找到小程序的文件

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091033.png)

这里推荐有 GUI 界面的反编译工具：

```
https://github.com/ezshine/wxapkg-convertor/releases
```

直接将文件鼠标拖拽到 GUI 界面即可开始反编译，在拖入文件的当前目录得到反编译生成的文件夹

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091034.png)

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091035.png)

然后就可以开始舒服的看看 js 代码啦

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091038.png)

**0x03 反编译源码代码审计**

举例某小程序审计，在登录界面爆破无关之后，直接反编译拖源码审计一下，反编译出来的源码，我们着重看 js 文件及其配置文件即可。第一想法就是先找一些接口，尝试是否有未授权之类的漏洞，下面就是找到的一处路由`user/getUserInfoByUsername`

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091040.png)

可以看到发送数据类型为 json 格式，并且参数为`username`和`school`，于是尝试构造请求发送

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091042.png)

成功获取系统管理员详细信息，其中包括关键的密码。获取到 md5 加密形式的密码密文后，本来还想去 cmd5 去解一下， 但是接下来注意到一个登录路由`user/loginByUsernameAndPassword`

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091044.png)

从源码中都看得出来就是通过账号密码去登录，刚刚未授权得到的密码存储为 md5 加密形式，想来登录应该也是进行 md5 加密的形式，所以直接发送加密形式的密码即可，构造请求发送

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091045.png)

验证登录成功。这类常常出现未授权漏洞的路由命名方式大抵都是

```
xxxByXXXId
xxxByUsername
xxxbyphone
......
```

审计的时候我们可以做一个规则去全局搜索源码匹配这类命名方式的路由

**0x04 其他类型漏洞案例**

下面举例其他类型的漏洞审计案例，这里目的是为了说明小程序有哪些漏洞可以挖

**信息泄露**

反编译出来的源码泄露登录账号密码，这里是因为在 js 文件中写死了账号密码，只做了前端验证导致的漏洞，从下面贴的两个小程序源码中可以看到

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091048.png)

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091049.png)

在时间稍稍往前的小程序中，还经常会有泄露小程序`secret`的情况，简直就是把打开保险箱的密码放在你面前

**未授权接口**

仔细翻找 js 文件能找到不少未鉴权的 api 接口（可以着重注意配置文件，不少配置文件都会写上路由列表），例如该 api 返回大量用户敏感信息

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-193629-1671091050.png)

测试未授权时，有一些小技巧：例如当在 GET 或者 POST 传参中有`token`等鉴权参数，例如

```
GET /api/GetUserInfo?id=xxx&token=xxxx HTTP/1.1
```

可以尝试将`token`参数的值置空或者删除`token`参数，往往能 bypass 鉴权，我已经遇见好多次这种情况了。举例一个案例：

该微信小程序可以注册用户，注册账号登录之后抓包，我的账号数据包如下

```
GET /wx/queryOrders?orderState=&serviceUid=&repairUid=6864&pageNum=1&pageSize=20&uid=6864&token=9938C366-XXXX-XXXX-XXXX-9C7709D8C9E8
```

当我尝试将`uid`参数改成其他用户时，返回权限不足，尝试将`token`删除

```
GET /wx/queryOrders?orderState=&serviceUid=&pageNum=1&pageSize=200&uid=2000
```

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/...