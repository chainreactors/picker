---
title: 从开放重定向到远程代码执行
url: https://mp.weixin.qq.com/s?__biz=MzIzMTIzNTM0MA==&mid=2247497171&idx=1&sn=8ca08a7437f1a26a0c136af6fda98438&chksm=e8a5ffb0dfd276a6d18a974e8e5a98377b41ace5f8fa8630955361d271604ac952982eda96f4&scene=58&subscene=0#rd
source: 迪哥讲事
date: 2025-02-22
fetch_date: 2025-10-06T20:38:11.663049
---

# 从开放重定向到远程代码执行

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8HuTUC0DtDwzywClYzdQIVa8P40gYNgFDOwJOyiahfYUniaMxcA3eHiakTg/0?wx_fmt=jpeg)

# 从开放重定向到远程代码执行

迪哥讲事

编者荐语：

ssrf测试思路值得总结

以下文章来源于骨哥说事
，作者骨哥说事

![](http://wx.qlogo.cn/mmhead/Tjnia6K0WAwzfic3VPt0EfMjicnGXzicDLoHEqtz1cP3Iozxf1tSyMxCFNG9Aya8SziaVKhVw7ia6QugE/0)

**骨哥说事**
.

一个喜爱鼓捣的技术宅

|  |
| --- |
| ****声明：**** 文章中涉及的程序(方法)可能带有攻击性，仅供安全研究与教学之用，读者将其信息做其他用途，由用户承担全部法律及连带责任，文章作者不承担任何法律及连带责任。 |

#

# **博客新域名：****https://gugesay.com**

目录

    背景介绍

* 引起注意的功能点
* 三种可能性
* 开放重定向（Open Redirect）
* 反序列化实现
* Kohana
* 利用链
* Log 日志
* 空字节问题
* 最后的投毒

#

#

# 背景介绍

今天来讲一位国外白帽子在VK（也就是Mail.Ru集团） 发现并利用一系列漏洞，最终在一周内成功实现远程代码执行(RCE)的故事。时间大概发生在2021年10月，当时我们的故事主角发现了几个简单的XSS漏洞，他选择了先不上报，因为他认为这种漏洞的重复率可能会很高，而且观察其他白帽子以往提交的漏洞报告时，会发现基本聚焦在以下几类漏洞：

* API RCE
* FastCGI的SSRF + RCE
* 存储型XSS
* Seedr.ru上的命令执行漏洞

# 引起注意的功能点

12月份时，我们故事的主角在另一个国家度假，于是他趁着闲暇之余开始重新审视这个项目，他注意到了一个特别的功能，该功能的HTML源码可以允许服务器根据hosting GET参数的值下载视频的元数据，有了这个发现，他开始去寻找可能的攻击场景。

在 https://api-stage.seedr.ru/player 页面的 HTML 源代码中，我注意到了一段注释：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8HibWu6V1wqZ1N9UnyVZ8zH3hs8KVDwI5icBUEaoiaqVsA8uicCzNjKQHxyA/640?wx_fmt=png&from=appmsg)

`https://player.seedr.ru/video?vid=cpapXGq50UY&post_id=57b6ceef64225d5b0f8b456c&config=https%3A%2F%2Fseedr.com%2Fconfig%2F57975d1b64225d607e8b456e.json&hosting=youtube`

看到这串URL，你是不是有忍不住要测试各个参数值的冲动？是的，我们的主角也是这么想的，但经过几次尝试后并没有获得任何有用的信息，于是他继续尝试其他参数，当打开`https://player.seedr.ru/video?vid=cpapXGq50UY&post_id=57b6ceef64225d5b0f8b456c&config=https%3A%2F%2Fseedr.com%2Fconfig%2F57975d1b64225d607e8b456e.json&hosting=youtube`时，白帽小哥观察到响应包中，Open Graph meta标记填充了一些有关视频的信息，如视频的标题、描述、图像等：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8Hpj6VCI1f0Ih64HIWwaCHnyyrxAMAPibY5vghKibBHialEtFtt6vN5JIxA/640?wx_fmt=png&from=appmsg)

经过测试，发现到 `**post_id**` 和 `**config**` GET 参数对响应没有明显的影响，那么我们可以将URL简化为：

`*https://player.seedr.ru/video?vid=cpapXGq50UY&hosting=youtube*`

那么假设播放器不太可能只支持 YouTube，如果 `**hosting**` GET 参数更改为 coub 和 vimeo的话：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8H8r0NSfGv4rJJLIKt1xr5w2sJkia27h806PwKd03mhx1GEEOe3ZwsXfg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8HVZF5OaCyvGeKcoW2w0RmFmJvrDSPfzH6b6WvsuhicxYdE0Y2BCVX5jA/640?wx_fmt=png&from=appmsg)

因此根据 `hosting` GET 参数的值，服务器使用 `**file_get_contents()**` 向 YouTube、Vimeo 或 Coub API 执行了 HTTP 请求，下载有关视频的元数据 ( `**vid**` GET 参数），解析并返回包含该视频和填充的 Open Graph meta标记的播放器 HTML 页面。

`vid` GET 参数是一个注入点，可以在 `file_get_contents()` 中控制路径的最后部分，也可以使用路径遍历（ `/../` ）和其它一些有用的符号（ `?` 、 `#` 、 `@` ）。

更有趣的是，在 Vimeo 服务器向 http://vimeo.com/api/v2/video/VID.php 发出请求的情况下，可以在前面的屏幕截图中注意到它，事实证明，当使用路径中的 `**.php**` 扩展名时，Vimeo 返回的不是 JSON 字符串，**而是序列化字符串！**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8HRfoj43nQu99eL0HdNj44gJCFoWBCr4cF2Yupn0FvkXkZ57TEhXoQdQ/640?wx_fmt=png&from=appmsg)

假设在 `file_get_contents()` 之后，服务器对 Vimeo 的响应使用`**unserialize()**` ：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8HS1NwvKlqS2yLRtCALQCojuSPWfwQzvcvcticbW32CUyA38ZZr2HWsiag/640?wx_fmt=png&from=appmsg)

那岂不是存在反序列化漏洞？

# 三种可能性

1. 对 `file_get_contents()` 进行模糊测试以绕过 vimeo.com 主机，实现 SSRF 盲注以及可能不安全的反序列化
2. 在 vimeo.com 上找到受控响应 -> 可能不安全的反序列化
3. 在 vimeo.com 上查找开放重定向 ->  SSRF 盲注 -> 可能不安全的反序列化

经过几个小时对 `vid` GET 参数进行不同的修改并在本地对 `file_get_contents()` 进行模糊测试后，白帽小哥没有发现任何有用的信息，于是他决定与几个值得信赖的小伙伴分享有关该漏洞的所有信息。

经过尝试，第一种和第二种方案均宣告失败。

# 开放重定向（Open Redirect）

当尝试利用该漏洞时，白帽小哥一直谨记 Harsh Jaiswal (@rootxharsh) 在 vimeo.com 上发表的有关 SSRF 的文章（https://infosecwriteups.com/vimeo-ssrf-with-code-execution-potential-68c774ba7c1e），该发现大概发生在 2019 年，所以这些开放重定向基本已经被修复了，但这可能是白帽小哥最后的机会，因此他决定以这种方式继续挖掘。

白帽小哥在尝试失败后，最终还是向 Harsh Jaiswal 虚心请教，Harsh Jaiswal 很爽快的分享了一个有效的开放重定向链接，该链接与白帽小哥假设的相同，但不同的是，该重定向链接拥有正确的 GET 参数值，从该链接中，白帽小哥了解到这并不是 vimeo.com 上的安全问题，而是一个真正的功能。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8HQQJiaEibickq2Vj2q3FicYW17o03BR80WUr16ibURBdvhTiaH8qUYB78vIEg/640?wx_fmt=png&from=appmsg)

好的，现在白帽小哥在 vimeo.com 上拥有了一个有效的开放重定向链接，继续尝试：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8HwDz7OGGIibna3JIibyopJicKc4AiaibV6YCa40rkdwe4hlVvS2HHbPHQ62g/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8HwDz7OGGIibna3JIibyopJicKc4AiaibV6YCa40rkdwe4hlVvS2HHbPHQ62g/640?wx_fmt=png&from=appmsg)

终于成功收到了 HTTP 回应，但是在开始反序列化利用之前，白帽小哥决定先玩一下 SSRF：

* https://127.0.0.1

  ![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8HRlTP3exrZkwYqRanTIxr0J6tqtL1vkHY7I9F9kvBGMshib9ak95k4wg/640?wx_fmt=png&from=appmsg)

* https://127.0.0.1:22

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8HWTfMJibvMdqsvkeYLH1oGNVKFicTlhibsRYOkreKh8QTb8XibYR3NlCyDQ/640?wx_fmt=png&from=appmsg)

* https://127.0.0.1:25

  ![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8H0DDq8AWXVGQLrZoLCMlcPKlCyOepiaPnFBHlaDg1S6Em1hVIpjvwTCw/640?wx_fmt=png&from=appmsg)

由于 `file_get_contents()` 的响应直接发送到 `unserialize()` ，因此无法实现完整的 SSRF，但至少目前已经有了能够执行端口扫描的半盲 SSRF：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8H7mDS3TN1jaybV2HP0zrbH5tujmO7debpFpDlLzuib3C9m5QXNjpeYiaA/640?wx_fmt=png&from=appmsg)

# 反序列化实现

成功利用 PHP 中的不安全反序列化需要什么？

* ̶C̶o̶n̶t̶r̶o̶l̶l̶e̶d̶ ̶i̶n̶p̶u̶t̶
* 具有神奇方法的类（ `**__wakeup()**` 、 `**__destroy()**` 、 `**__toString()**` 等）
* 对攻击者的神奇方法很有用，可以被用于文件操作、RCE、SQLi 等
* 类已加载

正如以上所示，白帽小哥对主机的后端代码一无所知，因此利用反序列化的唯一方法就是尝试所有已知的利用链，为此，白帽小哥使用了很棒的工具 PHPGGC，它是 PHP `unserialize()` Payloads的库以及生成它们的工具，在被利用时，它有近 90 个可用的Payloads，其中很大一部分是针对不同的 CMS 和框架，如 WordPress、ThinkPHP、Typo3、Magento、Laravr 等，这些对白帽小哥目前的案例来说基本毫无用处。

于是白帽小哥将赌注全部押在了 Doctrine、Guzzle、Monolog 和 Swift Mailer 等常用库上，他使用 PHPGGC 预先生成了所有可用的Payloads，将它们托管在受控服务器上，然后开始暴破，但是都遇到了同样的错误：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8Hs2AqZzLXmFX0MibhwGtXSIH3ygrvojX2z1a1THDf7P7ke0H3eSC1Nkw/640?wx_fmt=png&from=appmsg)

\*发生错误的原因是序列化字符串内部存在对尚未包含的类的引用，因此触发了 PHP 自动加载机制来加载该类，但由于某种原因失败了。 *©*
Sven\*

这个 PHP 脚本非常原始，不包含任何可以使用的附加类，很难过，但又不得不承认这个残酷的结果...

基本上故事到这里就结束了，但白帽小哥的内心有一种不甘，这一晚他彻夜未眠。

# Kohana

几天后，一个偶然的机会，白帽小哥注意到了 PHP `unserialize()` 中有关释放后使用漏洞的信息，碰巧，player.seedr.ru 上的 PHP 版本已经过时，于是白帽小哥开始“研究”这块领域，在“研究”期间，他熟悉了Taoguang Chen的报告（https://twitter.com/chtg57），他向PHP报告了可能有几十个与 `unserialize()` 有关的问题，实际上，与内存相关的漏洞对白帽小哥来说依然是一个空白领域，但他依然尝试构造一些Payloads，在对本地环境进行一番测试后，他重返 player.seedr.ru，将Payloads托管在受控服务器上，发送请求，然后......

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8HibK4mmVlUs2lYD0bKyQ0o5SkWrYHyAWF4fqOxU4Ce04t4iaicnJA6rjOQ/640?wx_fmt=png&from=appmsg)

“什么？设备上没有剩余空间？真的吗，我才刚刚开始？但是，这看起来似乎不像是有关设备空间的默认错误”

**“kohana”**，这个词在白帽小哥测试期间曾多次出现，于是白帽小哥快速的去Burp Suite的历史记录中寻找有关Kohana的记录：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8Hm6ySXg7PEicQibZMCxNbpRXiaHeVCgDEEGyiaZOamFsFggwTYLgRqDDibeg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8HAQVSYlrv4X8ibicge3fZ5m3HB7NbHpe0ibghhmhvlwjYcDKSye9qTBpgw/640?wx_fmt=png&from=appmsg)

Seedr 和 Nativeroll 都是视频广告平台， Seedr 有一个老式的设计，所以白帽小哥猜它是在 Nativeroll 很久之前创建的，这两个平台均被 Mail.Ru 集团收购，可能以某种方式合并在了 HackerOne 上，因此，v2.nativeroll.tv/api/、api.seedr.ru、api-stage.seedr.ru、player.seedr.ru 共享着相同的代码库，愈加清晰了～

让我们重回美丽的错误页面，环境、包含的文件、加载的扩展——看起来很有趣，以下是单击”included files“链接后观察到的结果：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8HeonibicPTN3zkh57arQowamLNLqdNAib1mdLctT2iaK9fPcsmzszEE2XzQ/640?wx_fmt=png&from=appmsg)

几乎有 90 个included files，实际上是加载了诸如 `autoload.php` 的不同类， Kohana 是某种 CMS 框架吗？是的。经过一番谷歌搜索后，可以发现它的 GitHub 存储库 https://github.com/koseven/kohana/ ，看起来早已被弃用：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8HEz2oflLZfRIDSjKeRib4ZiaMgJNQW8u1tEK7QYKWI4CiaErAL4jlzjhGA/640?wx_fmt=png&from=appmsg)

为了准确地在 api.seedr.ru/video 上触发错误异常，白帽小哥从 http://vimeo.com/api/v2/video/123459.php 获取结果，并将 description 属性的值从字符串修改为数组。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jkpSMoZzKNdGUOPV4pZoC8HRfoj43nQu99eL...