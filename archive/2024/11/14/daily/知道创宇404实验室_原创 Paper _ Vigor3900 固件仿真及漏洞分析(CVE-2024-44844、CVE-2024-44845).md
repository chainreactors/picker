---
title: 原创 Paper | Vigor3900 固件仿真及漏洞分析(CVE-2024-44844、CVE-2024-44845)
url: https://mp.weixin.qq.com/s?__biz=MzAxNDY2MTQ2OQ==&mid=2650989809&idx=1&sn=59e24b139d616af6ecba7ffe4405ddd7&chksm=8079a6c3b70e2fd50cece8a352d2222de22473efc6ecc19ddf08f65ba6d3fb3a8b4047078050&scene=58&subscene=0#rd
source: 知道创宇404实验室
date: 2024-11-14
fetch_date: 2025-10-06T19:19:05.665074
---

# 原创 Paper | Vigor3900 固件仿真及漏洞分析(CVE-2024-44844、CVE-2024-44845)

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ibOOfRiajZFoichIXvvVRb1dibM1MJzPFbfAic10lKBnvX22Iv4bSWtlcyyA/0?wx_fmt=jpeg)

# 原创 Paper | Vigor3900 固件仿真及漏洞分析(CVE-2024-44844、CVE-2024-44845)

原创

404实验室

知道创宇404实验室

**作者：fan@******知道创宇404实验室****

**时间：**2024年11月13日****

**1.前言**

参考资料

我在日常跟踪漏洞情报的过程中，看到 `Vigor3900` 最新版本固件 `1.5.1.6` 存在多处后台命令注入漏洞(CVE-2024-44844/CVE-2024-44845)[1]。正好最近看到几个固件仿真小工具，我打算一并试试效果。

**2.产品介绍**

参考资料

`Vigor3900` 是 `DrayTek` 推出的一款高性能、多功能的企业级路由器，专为满足中大型企业、跨国公司及组织机构的网络需求而设计。支持多 `WAN` 冗余和负载均衡，具备强大的 `VPN` 功能和高级防火墙，适合复杂网络环境中的远程办公和分支机构互联，提供稳定、安全的网络解决方案。

**3.环境模拟**

参考资料

#### **3.1 固件提取**

`DrayTek` 官网提供固件下载[2]

```
固件版本：Vigor3900 v1.5.1.6
https://fw.draytek.com.tw/Vigor3900/Firmware/v1.5.1.6/Vigor3900_v1.5.1.6.zip
```

首先尝试 `binwalk` 提取压缩包中 `.all` 文件，只获取到一个 `.ubi` 文件。

```
$ binwalk -e V3900_1516.all

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
131120        0x20030         UBI erase count header, version: 1, EC: 0x0, VID header offset: 0x200, data offset: 0x800

$ ls _V3900_1516.all.extracted/
20030.ubi
```

一般情况下使用 `ubireader` 提取 `.ubi` 文件，可惜失败了。

```
$ ubireader_extract_files _V3900_1516.all.extracted/20030.ubi
UBI Fatal: Less than 2 layout blocks found.
```

通过了解得知[3]，`ubi_reader` 工具对于 `ubi` 文件要求较为严格，它并不能处理所有厂商定制的 `UBI` 镜像。`ubidump` 具备更强的兼容性，在处理特定固件格式时做了更多定制化处理。

使用 `ubidump.py` [4]进行提取。

```
$ cd _V3900_1516.all.extracted/
$ python3 ubidump.py -s . 20030.ubi
==> 20030.ubi <==
1 named volumes found, 2 physical volumes, blocksize=0x20000
== volume b'rootfs' ==
saved 3402 files
$ ls rootfs/
bin   config_backup  dev  lib  proc  sbin  tmp  var
boot  data           etc  mnt  rom   sys   usr  www
```

判断架构为 32位arm 小端。

```
$ file rootfs/bin/busybox
rootfs/bin/busybox: ELF 32-bit LSB executable, ARM, EABI4 version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.3, stripped
```

`firmwalker` 简单扫一下找找 `web` 服务，发现 `lighttpd` 服务。

```
$ ./firmwalker.sh /home/iot/Desktop/vigor/_V3900_1516.all.extracted/rootfs

***Search for web servers***
##################################### search for web servers
##################################### apache

##################################### lighttpd
s/usr/sbin/lighttpd
s/usr/lib/lighttpd
s/etc/lighttpd
s/etc/init.d/lighttpd
```

#### **3.2 固件仿真**

固件仿真可以尝试一下 `Sevnup`[5] (根据文件系统信息自动下载相关的内核文件、配置ip地址、打包上传文件系统等)。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75iblPQ0karKvzX9L8Riawr8nO2QxHdwg4jy2367Bo0lxPsSa0uA3e7BKdQ/640?wx_fmt=png&from=appmsg)图1 Senvup 模拟固件

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ib2R1iaAG35byTz1defwmsxFrGl55GFxWCMOia6dRC8wHiaNO6kXFQv3Whw/640?wx_fmt=png&from=appmsg)图2 Senvup 模拟固件

只需要在 `qemu` 里运行框中四条命令就行(`qemu` 里不能复制粘贴，所以我运行完 `ifconfig` 后使用 `ssh` 连上去)。

```
ifconfig eth0 10.10.10.2/24
ping 10.10.10.1
wget http://10.10.10.1:8000/load_in_mips.sh
sh load_in_mips.sh
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ib0ApgkMmkQgaFOAx9PyYA1LFwEiasQb7f2B7Ip1hq8qic4hSPPLARvMAA/640?wx_fmt=png&from=appmsg)图3 Senvup 模拟固件

执行完四条命令后直接进入 `shell` 并修改权限。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ibFoG6Zq4XcHrV7TdmSuLrsCX5aN7tBuASBQGeYSdb4bClDM9dLnkmyA/640?wx_fmt=png&from=appmsg)图4 Shell

前文已经提到过 `web` 服务是 `lighttpd`，尝试运行 `/etc/init.d/httpd`，出现报错。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ibFG6ZT9xv4jxsTj09gDmUia6UbEUVgbutcVUS1e0UKD3av9lTe2p9jPQ/640?wx_fmt=png&from=appmsg)图5 运行 lighttpd 报错

看看 `/etc/init.d/lighttpd` 和 `/etc/lighttpd/serverport.conf`，`lighttpd` 如何解析 `serverport.conf`。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ibzZibYZ6NffNNibSs142RDwOlCNeL1Gibh0ia02FnkG9Hyhd1JorluqYfuQ/640?wx_fmt=png&from=appmsg)图6 /etc/init.d/lighttpd 源码

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ibHrxkgrkcWD7V4aE46AIlNzibR2R9XONyqAhWYZjIrHBsWQqem1OInsg/640?wx_fmt=png&from=appmsg)图7 /etc/lighttpd/serverport.conf 源码

可以看到 `lighttpd` 会根据当前 `web_Port` 变量的值(`http` 服务器端口) 向 `serverport.conf` 写入内容，配置 `lighttpd` 服务器的监听端口，看来并没有获取到 `web_port` 的值。

`grep -r "web_port"` 匹配关键字发现端口应该是 `80`。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ibbia81aUry6tUrQmH7VVdLjnLZqWcXHWT4R6HOWc2f5dCFVFmkz181Uw/640?wx_fmt=png&from=appmsg)

将 `/etc/init.d/lighttpd` 中 `web_Port` 改成 `80` 成功启动。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ibbeRZbKgHdUYykNGB4CxbNWmS4JHQadPapyk7Ql6mNbEB3GgILX0J7A/640?wx_fmt=png&from=appmsg)图9 修改 /etc/init.d/lighttpd web\_port

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ibNVAssP0ibkZmMrRnUaMQh9AOiaoUfE0KV3iawPWuvwngPSjsfbf1QdtaA/640?wx_fmt=png&from=appmsg)

访问却出现 `404`。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ib84GbSMibzluibzziaSz8QrwcMP9vSqgmKibbnF9iaufNu7TKgDjNX4QNicJQ/640?wx_fmt=png&from=appmsg)图11 访问报错

继续看看 `/www` 目录下都有什么文件，发现 `/www/mobile` 目录下存在 `idnex.html` 。并且访问 `ip/mobile` 即可访问到 `/www/mobile/index.html`。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ibxHaYCxoLtyK4l8pWia1GJjfXuQ1ghibmiaArErF8oy5POC7Hf6cmg6ZbQ/640?wx_fmt=png&from=appmsg)图12 ls /www

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ibfLxAmdBia18hW9tPVtWWwjnOx3qHlKCAQ9vOaCkkXuwfQ1ZXqErISdQ/640?wx_fmt=png&from=appmsg)图13 访问 /www/mobile

用户手册上说默认后台地址就是 `192.168.1.1` (我仿真的环境是 `10.10.10.2`) 而不是 `/www/mobile` 目录下，所以 `/www` 目录下应该同样存在 `idnex.html` 文件。并且从用户手册得知默认账户密码 `admin/admin` 。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ibFWNWuPrTP5aq316zpiaRPKpDIlE8EIhAEFiba09AxuibC5ToQQU8ceZicA/640?wx_fmt=png&from=appmsg)图14 用户手册

发现 `/www/ajax.zip` 包含 `index.html`，`unzip` 解压得到 `index.html` 并成功访问。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ibGTb1v673BdTfHoQFHianmJnbby6TibxV5orBjq2zXU1ZNQqLkk4IdA5Q/640?wx_fmt=png&from=appmsg)图15 grep -r "index.html"

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ibIZIibeGFd8pz1jO2voYwaXzdLQVHMDfTzzGWx3P7ibQ0IYAMEJT1m9QA/640?wx_fmt=png&from=appmsg)图16 解压 ajax.zip

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ibticVRNh2AWTZevoB8Ij1GCIibXqw1NZKeyrdarrKPXomuvI9DSe2mCKA/640?wx_fmt=png&from=appmsg)图17 访问成功

接下来我们发现，登录又失败了，因为是后台漏洞所以必须拿到 `cookie` ，我们来抓包看看怎么回事。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ibJ7plasWr6iaZZxzt9Y5ibog7ibxgZf8vVHwLIicic8NB9aFtF3icicXRPDWoA/640?wx_fmt=png&from=appmsg)图18 登录失败

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ibnjFpG9ZSEZtmCnGfOEwHJlOBKNcBr9ApXRdvOSNicFoPa4ZxYGXHOGw/640?wx_fmt=png&from=appmsg)图19 抓包

登录认证请求的 `/www/cgi-bin/mainfunction.cgi` 文件，拖进 `ida` 搜索关键字 `fail`。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ibU983p79h4G99sb1UjATibvzIBQc2qMSF1uBthQ2yr25Zia7QO1aAQYGw/640?wx_fmt=png&from=appmsg)图20 ida 搜索关键字 fail

`Web UI Log-in Failure` 应该就是这，交叉引用看看。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75iboVGrOJHzFDKGX2qJWaicYiciaFwY16r5IEotb08Eia1j4TFSXGNOdmfaBA/640?wx_fmt=png&from=appmsg)图21 交叉引用

分析代码可知 `sub_2BDE4` 接收了用户名、密码、远程 IP 并返回登录状态 `v30`。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ibmSsEpd3r7Gwzmm3uUknm0B7m6umdYjtjzWsOr5MugaNOdckZia663iaA/640?wx_fmt=png&from=appmsg)

继续跟进 `sub_2C15C` ，程序会将用户输入密码与系统中存储的密码进行匹配。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ibYh8ZkupN6uvBQ7oibG4FuwpTmbFFdWKuN14HQogsh9dMz7iaG2lRkm2Q/640?wx_fmt=png&from=appmsg)

所以继续回到 `shell`，搜索 `passwd` 相关文件，`find . -name "*passwd*"` 。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ib6gMMiaCx4MFNVO7dJwyBVo7Fxyx0ewic2ugjSZB9bmTmyWDQibHeTmftg/640?wx_fmt=png&from=appmsg)

系统中存了密码但是认证还是失败，证明可能有脚本操作 `/etc/data-default/passwd`，继续搜索关键字 `grep -r /etc/data-default/passwd`。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2xCZsBITAJvHCAdfiaJs75ib7fR3h4nIXSicB5BK3GPLDsp8EuCHyeVbAyUVlcZXV...