---
title: 【技术分享】印度统一支付接口和支付应用程序的安全性分析
url: https://mp.weixin.qq.com/s?__biz=MzA5ODA0NDE2MA==&mid=2649782031&idx=1&sn=ab56c9f0da2f6afafba3450a2f41efcd&chksm=88934760bfe4ce76789774eeb94c4fc99ec3c41bd830079a138ad91d6a18d645908d164b0cd4&scene=58&subscene=0#rd
source: 安全客
date: 2023-01-11
fetch_date: 2025-10-04T03:32:25.175759
---

# 【技术分享】印度统一支付接口和支付应用程序的安全性分析

![cover_image](https://mmbiz.qpic.cn/mmbiz_jpg/Ok4fxxCpBb5pPuRVVia9xFGTHI8VlX4xhc80tibxIK7XkN6YEs8LoqXLvpj4sWYXNSqdSFSXlBvsEFWmncSNWdzg/0?wx_fmt=jpeg)

# 【技术分享】印度统一支付接口和支付应用程序的安全性分析

原创

CDra90n

安全客

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5pPuRVVia9xFGTHI8VlX4xhNeLOeA4ic6vc9eJqj8guxBG7OsDx23aMqstSLXPicP2VHYBcaf7oKHJg/640?wx_fmt=png)

自2016年以来，在印度政府的大力推动下，基于智能手机的支付应用程序已成为主流，2018年通过这些应用程序进行的交易超过500亿美元。其中许多应用程序使用印度政府引入的通用基础架构，称为统一支付接口（UPI），但尚未对支持汇款的这一关键基础架构进行安全性分析。

本文通过七个流行的UPI应用程序对该协议的设计进行了逆向，从而对UPI协议进行了详细的安全性分析。发现了UPI 1.0规范中多因素身份验证设计级别的缺陷，当与攻击者控制的已安装应用程序结合使用时，可能会导致攻击。在攻击的最极端版本中，即使受害者从未使用过UPI应用程序，这些漏洞也可能使受害者的银行帐户被关联并清空，潜在的攻击是可扩展的并可以远程进行。

**0****1**

**Introduction**

支付应用程序已成为印度的主流支付工具，随着印度政府在2016年将大笔纸币货币化之后，印度政府积极鼓励其公民使用电子支付方式。为了大规模实现数字小额支付，印度国家银行联合会印度国家支付公司（NPCI）引入了统一支付接口（UPI），以实现不同用户的银行帐户之间的免费和即时转账。截至2019年7月，UPI交易的价值已达到约210亿美元。UPI的开放式后端体系结构可轻松实现新支付应用程序的集成和互操作性，这是一个重要的推动力。当前，大约有88个UPI支付应用程序和140多个银行可以通过UPI与这些应用程序进行交易,本文着重于UPI设计中的漏洞以及付款应用对UPI的使用情况。

之前已经对包括印度支付应用程序在内的支付应用程序的分析中发现了漏洞，并且发现印度移动银行服务存在PIN修复漏洞。但是，在这些研究中，移动应用程序没有共享通用的支付接口，以前尚未对多个支付应用程序使用的通用接口进行分析。进行这样的分析非常重要，因为其中的安全漏洞可能会影响多个银行和多个应用程序的客户，而与使用的其他更强的安全功能无关，本文专注于许多印度支付应用程序使用的统一支付接口的安全性分析及其设计选择。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5pPuRVVia9xFGTHI8VlX4xhsuE5y7oqtpLSnWehnrkO6wn8Lj3mElodOy3vfwRk2g7TormCukg9QA/640?wx_fmt=png)

如上表所示是印度最受欢迎的7种UPI应用程序。在分析的7种应用程序中，Google Pay（Tez），PhonePe，Paytm和BHIM这4种UPI应用程序的综合市场份额为88 ％，并在许多购物网站中被广泛接受。在总共88个UPI应用程序中，许多都是BHIM的较小变体，BHIM是NPCI（也是UPI的设计师）发布的旗舰应用程序。今天，有近48家银行发行了BHIM应用的银行品牌版本。由于Android拥有印度移动市场90％以上的份额，因此专注于这些应用的Android版本。

威胁模型假设用户在非root用户的Android手机上谨慎使用授权的付款应用程序，但已安装具有常用权限的攻击者控制的应用程序。尽管社交工程攻击可以简化发现的某些漏洞的利用，但不依赖其成功与否。发现了UPI 1.0协议中的几种设计选择，这些选择可能导致以下类型的攻击：

•攻击1：给定用户的手机号码，未经授权注册：此攻击会泄漏私人数据，例如用户拥有银行帐户的银行集和银行帐号。

•攻击2：根据用户的手机号和部分借记卡卡号，在银行帐户上进行未经授权的交易：在印度使用借记卡购物（无论是在商店内还是在线购物）都要求用户通过输入秘密PIN来授权付款。在这种攻击中，攻击者可以通过知道用户的手机号和打印在卡上的借记卡信息（最后六位数字和有效日期，不带PIN）来对从未使用过UPI的用户的银行帐户进行交易付款应用程式。

•攻击3：没有借记卡卡号的未经授权的交易：这种攻击表明，不知道用户身份验证因素的攻击者如何学习所有因素以对该用户的银行帐户进行未经授权的交易。

工作开始于两年前，当时NPCI发布了UPI 1.0和BHIM，这是分析的重点。考虑到发布调查结果的潜在风险，直到NPCI解决了最近发布的UPI 2.0中的关键攻击媒介才发布。

**0****2**

**Background**

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5pPuRVVia9xFGTHI8VlX4xhQgGoXcKficibshDvJ9C7fSgx4yLEnkzlJA6OCmsKVOibl3uxkEPAhQ7ew/640?wx_fmt=png)

印度的早期移动支付应用程序仅是钱包应用程序。他们可以通过要求用户输入借记卡号从用户的银行帐户中提取资金，但不能将钱存回该银行帐户。取消货币化后（2016年），为鼓励无现金交易，由印度政府支持的名为印度国家支付公司（NPCI）的印度银行财团推出了统一支付接口（UPI），该接口允许NPCI认证的移动应用程序在不同用户的银行帐户之间进行免费的即时汇款。UPI应用程序可以共享所有相同的支付接口，因此可以相互操作。例如，BHIM的用户可以立即将一笔小额购买的钱从她的银行帐户转移到使用Google Pay的店主的银行帐户中。因此，印度大多数商店都通过UPI应用程序接受移动支付。根据应用程序的不同，用户最多可以无限制地执行每笔交易$ 1500。上图b显示了与上图a中的传统网上银行系统相比的UPI汇款系统。

### （1）在UPI应用程序上的用户注册

UPI付款系统要求Alice在带外银行帐户中注册她的主要手机号码，以进行收款。UPI使用手机号（i）作为用户在银行的数字身份的代理，以便在给定手机号的情况下查找银行帐户；（ii）作为通过SMS一次性密码（OTP）进行身份验证的因素；（iii）提醒用户交易。印度政府要求手机提供商获取政府颁发的ID的副本，手动验证ID，并在发出手机号之前进行生物特征验证。要注册UPI服务，Alice必须设置其UPI用户配置文件，添加银行帐户并在该银行帐户上启用交易，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5pPuRVVia9xFGTHI8VlX4xhcnm3uDu86qporScneGOWQuysZj03Xr1iauTz2syT9onHpHkKBTlgKcw/640?wx_fmt=png)

1.设置UPI用户配置文件：Alice必须首先通过安装在其银行注册手机上的UPI应用使用UPI创建配置文件。Alice必须首先通过UPI应用将其手机号码提供给UPI进行验证。

UPI从用户那里收集此信息的方式可能随每个应用程序而变化。例如，某些应用程序从设备读取手机号，而其他一些则要求用户键入手机号。例如，上图的屏幕截图3显示了BHIM如何从手机中读取Alice手机号码供爱丽斯选择。然后，UPI应用程序将Alice的手机号发送到UPI服务器进行验证。验证后，UPI服务器将在该应用程序上为Alice发布UPI ID。截图2显示了BHIM在验证Alice后如何通知她。如果Alice使用多个应用程序，则UPI服务器为每个应用程序发布一个不同的UPI ID。然后，应用程序会提示Alice设置密码。密码的性质还是特定于应用程序的。例如，BHIM要求用户设置一个4位数的密码，如截图5所示。

2.添加一个银行帐户：设置Alice的个人资料后，她必须添加要用于提取和存款的银行帐户。为Alice提供了支持UPI的银行名称列表（截图6），现在她可以从中选择自己的银行。Alice可能重复此步骤以添加多个银行帐户。

3.启用交易：为了使Alice能够在添加的银行帐户上进行交易，她必须在第一次交易之前为该帐户设置UPI PIN。UPI PIN码是Alice授权以后进行任何交易的秘密。要设置UPI PIN码，Alice必须提供借记卡上打印的信息-银行自动柜员机或借记卡号的最后六位数字和有效期。Alice丝还必须输入从UPI服务器收到的OTP。UPI PIN是一个高度敏感的因素，因为UPI服务器使用它来防止在Alice的银行帐户上进行未经授权的交易。

为了向Bob汇款，Alice首先使用她在用户注册期间设置的密码登录UPI应用。然后，带外，Alice要求Bob提供他的UPI ID，这通常是Bob的手机号码。Alice选择了她先前添加到应用程序中的一个银行帐户（截图7），向Bob发起了交易，并通过提供UPI PIN对其进行了授权。在内部，UPI付款接口将资金从Bob选择的银行帐户直接转到与Bob的UPI ID关联的Bob的银行帐户。

### （2）用户注册的UPI规范

NPCI发布的UPI规范为UPI应用程序与UPI服务器之间的客户端-服务器握手提供了“广泛的指导原则”，讨论了可以从规范中获得的协议详细信息。

1.设置UPI用户个人资料：UPI应用获取用户的手机号码后，该应用必须从Alice的手机向UPI服务器发送加密的出站SMS。此过程是自动的，并且不涉及用户，以保证用户的手机与其设备之间的牢固关联。根据UPI的说法，这是该协议的“最关键的安全要求”，因为首先基于此关联来验证来自用户设备的所有金钱交易。UPI将此用户设备（由设备ID，应用程序ID和IMEI编号等参数标识）与其手机号的这种关联称为设备绑定。组合的手机号和设备信息（代表此绑定）称为设备指纹，根据UPI规范，该指纹是身份验证的首要因素。

密码UPI规范认为应用程序密码是可选的，并且不承担密码认证的责任。UPI将其交给UPI应用程序供应商来验证密码。因此，完全验证用户身份的责任由两个服务器共享：UPI服务器（用于验证设备指纹和UPI PIN）和支付应用程序服务器（用于验证应用程序密码）。

2.添加银行帐户：用户添加银行的请求必须来自在UPI注册的设备。在内部，UPI会根据用户的手机号获取所选银行的帐号和IFSC代码，以便以后通过UPI应用进行交易。

3.启用交易：UPI允许使用手机号或帐号以及IFSC代码或任何UPI ID进行交易。UPI规范要求，使用手机（设备指纹）作为第二因素，并且使用UPI PIN作为第二因素，所有交易必须至少为2FA。该规范将手机视为“what you have”的因素，这使UPI可以使用上述两个因素来提供“一键式双因素身份验证”。

对于与UPI集成的应用程序，NPCI通过代码审查和认证过程来增强应用程序安全性。与UPI服务器的所有通信都是通过基于PKI的加密连接进行的。当前，UPI已成为移动交易的事实上的标准。

### （3）威胁模型

假设一名普通用户Alice从官方来源（例如Google Play）安装了付款应用；没有一个支付应用程序包含无关的恶意代码。Alice的电话配置合理，带有互联网功能，可以防止不受信任的实体对其进行物理访问。

另一方面，攻击者Eve使用root的手机，Eve可以使用她可以使用的任何工具对支付应用程序进行逆向。假设Eve发行了一个貌似有用的、没有权限的应用程序Mally，该应用程序请求以下两个权限-android.permission.INTERNET和android.permission.RECEIVE\_SMS。Alice发现该应用有用并安装了该应用，并授予了必要的权限。

Mally要求的权限在Android上并不罕见。Android的最新版本会自动授予INTERNET权限，而无需用户提示。SMS许可在Android上具有合法用途，大约有15％的Android应用请求它们。每个任务的RECEIVE\_SMS仅授予读取传入的SMS消息的权限，而不授予读取以前接收的消息或发送SMS消息的权限。许多流行的社交媒体应用程序（例如Telegram和WhatsApp，SMS /呼叫阻止程序应用程序）以及安全应用程序（例如Kaspersky Mobile Security和BitDefender）都使用此权限。

由于以下原因，认威胁模型是现实的。首先，根据最近两年的Android安全评估，印度是前木马和后门等潜在有害应用程序比例最高的前三名国家，这些应用程序有时预装在Android设备上。Google最近还发布了警告，指出53％的主要攻击是由于预装在低成本智能手机上的恶意应用所致。

为了简化一些攻击描述，使用READ\_PHONE\_STATE或可访问性权限来描述Mally，这样做是为了显示攻击者获取用户信息（例如，用户的手机号码）的多种方式。但是，在这种情况下，还将显示不需要这两个权限的其他攻击媒介。

**0****3**

**Security analysis**

### （1）方法

在本节中将描述如何对专有协议UPI进行逆向工程以学习其身份验证握手。由于无权访问UPI的服务器，因此选择通过支持该协议的支付应用程序对该应用程序层协议进行逆向工程。

协议分析：为了对UPI进行逆向工程，首先揭露了客户端-服务器身份验证握手的每个步骤，其目标是（i）了解UPI如何进行设备指纹采集；（ii）建立用户开设帐户和进行交易所需的凭证。除了UPI的默认身份验证工作流之外，还寻找可用于减少攻击者所需凭据的备用工作流或路径。最后，在协议交互过程中寻找任何泄漏的用户特定属性，如果被攻击者拦截，这些属性稍后会被利用。对来自不同工作流程的发现进行分类，以找到合理的攻击媒介并验证潜在的利用。

用于提取协议数据的方法取决于应用程序的规范及其使用的安全防护，由于UPI 1.0规范仅声明了广泛的安全性准则，而不是协议的详细信息，因此检查了多个应用程序，以了解协议在不同应用程序之间是否有所不同们将分析BHIM，这是由维护UPI系统的同一政府组织发布的旗舰应用程序，然后通过分析其他应用程序来确认发现。

App逆向工程：捕获应用发送和接收的协议数据的一种方法是在沙盒中运行它。沙盒工具（如CuckooDroid ）使用仿真器进行动态分析。因此，为了测试UPI应用程序是否可以在沙箱中运行，在Linux主机上的Android SDK内置模拟器中手动运行每个应用程序。但是，发现这些应用程序必须在没有物理SIM卡的情况下才能运行，而该SIM卡在模拟器上不可用。这些应用程序还使用反仿真技术，以防止它们在仿真器中运行。

除了反仿真之外，发现支付应用程序还使用其他几种防御措施。例如，它们所有人都检测到root手机，并阻止用户在root手机上运行应用程序。一些应用程序还寻找hook库的存在，例如Xposed ，它们通常需要root访问权限才能修改系统文件。此外，所有应用程序都被混淆，使用加密通信，强制会话超时和帐户锁定，避免以明文形式存储或传输数据，并避免使用硬编码的凭据或密钥。这些应用程序使用的安全防护程度表明，应用程序开发人员在设计应用程序时就考虑了安全性。

安全评估表明，某些应用程序（例如BHIM）允许重新打包。利用它来静态地检测应用程序的代码，以了解身份验证握手的细节，例如活动名称和生成网络流量的方法。由于这些细节有助于进行精确的分析，因此首先检查应用程序是否可以打包和重新打包。为了对应用程序进行检测，首先使用APKTool 对其进行分解，插入调试语句，然后使用签名对其进行重新打包。

出现的一个问题是，在应用程序的代码中应该插入什么位置，因为这需要了解要插入的应用程序的方法。由于不知道这是先验知识，因此使用JEB和反编译器对应用程序进行了手动逆向。有时，JEB无法反编译被控制流混淆的某些类。在这种情况下，使用JDK的javap命令读取字节码。用来自两个混合分析仪MobSF和Drozer 的静态分量的结果来扩充分析。

无法重新打包某些应用程序，例如Google Pay。在这种情况下，使用称为mitmproxy 的TLS中间人代理来拦截应用程序的网络流量。在Android手机上安装OpenVPN应用，在Linux主机上安装OpenVPN服务，并配置主机的防火墙规则以将流量路由到mitmproxy。该设置还要求在手机上安装mitmproxy的证书。但是从Android Nougat开始，Android不信任用户安装的证书，并且设置系统证书需要root访问权限，这是一个障碍。因此，在Android Marshmallow和Lollipop设备上进行了分析。

### （2）BHIM用户注册协议

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5pPuRVVia9xFGTHI8VlX4xh0nWSPic5WNTMiaGHe4Piaxib1SHOUxQTPNL3B6dsh8q2zwQS4YmMc7DdrA/640?wx_fmt=png)

上图左侧的步骤1-10是客户端服务器在BHIM版本1.3和UPI 1.0服务器之间进行握手的步骤，并显示了最少的相关协议数据。左侧的屏幕数字（带圆圈）指示之前图中生成流量的应用程序的屏幕截图，在下面介绍UPI默认工作流程的十个步骤：

步骤1：当Alice启动BHIM时，BHIM首先请求Alice发送SMS消息的权限（以供以后使用）（截图2）。一旦获得BHIM的许可，BHIM就会以HTTPS消息的形式将Alice的设备详细信息（例如设备的Android版本，设备ID，品牌，制造商和型号）发送到UPI服务器。

步骤2：UPI服务器向Alice发送一个13位的注册令牌，该令牌标识她的设备，并等待以SMS消息的形式从Alice取回该令牌。

步骤3：BHIM应用将注册令牌作为SMS消息发送到UPI服务器。BHIM等待使用sendTextMessage API的deliveryIntent进行SMS传递确认。

步骤4：UPI服务器收到SMS时，（i）得知Alice获得了令牌；（ii）从消息中获取她的手机号码。UPI服务器使用此信息将Alice的手机号硬绑定到她的设备。UPI服务器还向BHIM发送确认已收到SMS。

步骤5：BHIM通过将注册令牌作为HTTPS消息发送回服务器，从UPI服务器请求其设备的硬绑定状态。

步骤6：UPI服务器以包含Alice的客户ID，注册令牌等的验证状态作为响应，将其返回给Alice。到目前为止，UPI服务器已经验证了Alice和她的设备（截图4）。

步骤7：BHIM要求Alice设置密码（截图5）。该应用程序将Alice密码的SHA-256哈希值与她的手机号码连接在一起，并将其作为HTTPS POST请求发送到UPI服务器。

...