---
title: 干货 | 域内敏感信息搜集
url: https://www.secpulse.com/archives/189286.html
source: 安全脉搏
date: 2022-10-19
fetch_date: 2025-10-03T20:13:03.964916
---

# 干货 | 域内敏感信息搜集

[![](https://www.secpulse.com/wp-content/themes/secpulse2017/img/logo-header.png)](https://www.secpulse.com "安全脉搏")

* [首页](https://www.secpulse.com/)
* [分类阅读](https://www.secpulse.com/archives/category/category)

  #### 脉搏文库

  - [内网渗透](https://www.secpulse.com/archives/category/articles/intranet-penetration)
  - |
  - [代码审计](https://www.secpulse.com/archives/category/articles/code-audit)
  - |
  - [安全文献](https://www.secpulse.com/archives/category/articles/sec-doc)
  - |
  - [Web安全](https://www.secpulse.com/archives/category/articles/web)
  - |
  - [移动安全](https://www.secpulse.com/archives/category/articles/mobile-security)
  - |
  - [系统安全](https://www.secpulse.com/archives/category/articles/system)
  - |
  - [工控安全](https://www.secpulse.com/archives/category/articles/industrial-safety)
  - |
  - [CTF](https://www.secpulse.com/archives/category/exclusive/ctf-writeup)
  - |
  - [IOT安全](https://www.secpulse.com/archives/category/iot-security)
  - |

#### 安全建设

+ [业务安全](https://www.secpulse.com/archives/category/construction/businesssecurity)
+ |
+ [安全管理](https://www.secpulse.com/archives/category/construction/securityissue)
+ |
+ [数据分析](https://www.secpulse.com/archives/category/construction/bigdata)
+ |

#### 其他

+ [资讯](https://www.secpulse.com/archives/category/news)
+ |
+ [漏洞](https://www.secpulse.com/archives/category/vul)
+ |
+ [工具](https://www.secpulse.com/archives/category/tools)
+ |
+ [人物志](https://www.secpulse.com/archives/category/people)
+ |
+ [区块链安全](https://www.secpulse.com/archives/category/exclusive/block_chain_security)
+ |
+ [安全招聘](https://www.secpulse.com/archives/category/hiring)
+ |

- [安全问答](https://www.secpulse.com/newpage/question_list)
- [金币商城](https://www.secpulse.com/shop?donotcachepage=c010349fd98847cb9d6e07d3cbc19288)
- [安全招聘](https://www.secpulse.com/archives/category/hiring)
- [活动日程](https://www.secpulse.com/newpage/activity)
- [live课程](https://www.secpulse.com/live)
- [企业服务](https://duoyinsu.com/service.html)
- [插件社区](https://x.secpulse.com/)

小程序

![脉搏小程序](https://www.secpulse.com/wp-content/themes/secpulse2017/img/wxchat.jpg)
[登录](https://www.secpulse.com/user_login)
|
[注册](https://www.secpulse.com/user-register)

# 干货 | 域内敏感信息搜集

[工具](https://www.secpulse.com/archives/category/tools)

[HACK\_Learn](https://www.secpulse.com/newpage/author?author_id=8971)
![]( https://www.secpulse.com/wp-content/themes/secpulse2017/img/renzheng0.png)

2022-10-18

10,783

# 域内敏感信息搜集

原文：https://xz.aliyun.com/t/11667，无编译好的版本，代码有点问题，需要整合、修改并编译。

# 工具传参

在域外我们需要指定ip地址，域用户账户和密码，三个参数。在主函数中用了NDesk.Options来处理获取的参数，先定义三个list：

```
List<string> domains = new List<string>();
List<string> users = new List<string>();
List<string> passes = new List<string>();
```

工具一般运行-h会提示使用信息，在主函数中定义一个bool变量，命名为show\_help，初始值为false，当为true时，代表用户使用-h参数，获取帮助信息，并在主函数中new一个options来存放帮助信息。

```
bool show_help = false;
OptionSet options = new OptionSet()
{
    { "d|domain=", "the {IP} of the DC target",v => domains.Add (v) },
    { "u|user=", "the {user} of the DC target",v => users.Add (v) },
    { "p|pass=", "the {pass} of the DC target",v => passes.Add (v) },
    { "h|help",  "show this message and exit",v => show_help = v != null },
};
```

再在主类中，主函数外，定义公共静态成员函数，用来输出帮助信息。

```
public static void ShowHelp(OptionSet p)
{
    Console.WriteLine("Usage:");
    p.WriteOptionDescriptions(Console.Out);
}
```

最后在主函数内，调用该函数。

```
options.Parse(args);
if (show_help)
{
    ShowHelp(options);
    return;
}
```

然后写了个GetArgsValue类来存储这些值。

```
public static class GetArgsValue
{
    public static string domain = "";
    public static string user = "";
    public static string pass = "";
    public static void GetDomainValue(List<string> param1 = null)
    {
        foreach (string p in param1)
        {
            domain = p;
        }
    }

    public static void GetUserValue(List<string> param2 = null)
    {
        foreach (string p in param2)
        {
            user = p;
        }
    }

    public static void GetPassValue(List<string> param3 = null)
    {
        foreach (string p in param3)
        {
            pass = p;
        }
    }
}
```

# 获取域内机器名

思路：先进行LDAP连接，后在用户过滤器中，指定过滤条件(&(objectclass=computer))获取机器。使用System.DirectoryServices命名空间，来连接LDAP目录，然后获取机器名，最后将机器名写入到machine.txt文本中，供下面函数调用。

```
public static DirectoryEntry coon = null;
public static DirectorySearcher search = null;

public static void Machine()
{
    string url = "LDAP://" + GetArgsValue.domain;
    //域外
    if (GetArgsValue.user != "" && GetArgsValue.pass != "")
    {
        string username = GetArgsValue.user;
        string password = GetArgsValue.pass;
        coon = new DirectoryEntry(url, username, password);
        search = new DirectorySearcher(coon);
    }
    //域内
    else
    {
        coon = new DirectoryEntry(url);
        search = new DirectorySearcher(coon);
    }
    search.Filter = "(&(objectclass=computer))";
    using (StreamWriter file = new StreamWriter(@"machine.txt", true))
    {
        foreach (SearchResult r in search.FindAll())
        {
            string computername = "";
            computername = r.Properties["cn"][0].ToString();
            //Console.WriteLine("===========All Computers===========");
            //Console.WriteLine(computername);
            file.WriteLine(computername);
        }
    }
}
```

# 机器探测存活

百度现成的代码，用的Ping类。

```
public static bool IsMachineUp(string hostName)
{
    bool retVal = false;
    try
    {
        Ping pingSender = new Ping();
        PingOptions options = new PingOptions();
        options.DontFragment = true;
        string data = "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa";
        byte[] buffer = Encoding.ASCII.GetBytes(data);
        int timeout = 120;

        PingReply reply = pingSender.Send(hostName, timeout, buffer, options);
        if (reply.Status == IPStatus.Success)
        {
            retVal = true;
        }
    }
    catch (Exception ex)
    {
        retVal = false;
    }
    return retVal;
}
```

# 获取桌面文件

1. 1. 先在同一目录下，创建CInfos文件夹。
2. 2. 然后获取目标机器c:users目录，如果存在该目录创建机器名。
3. 3. 再遍历users目录存在哪些用户，同理如果存在desktop目录创建用户名和desktop.txt。
4. 4. 接下来就是遍历desktop目录所有文件以及文件夹内的文件。

```
public static void C()
{
    try
    {
        string CFiles = "";
        StreamReader machine_name = new StreamReader(@"machine.txt");
        while (!machine_name.EndOfStream)
        {
            try
            {
                string machine = machine_name.ReadLine();
                if (IsMachineUp(machine))
                {
                    string currentpath = Directory.GetCurrentDirectory();
                    CFiles = currentpath + "\CInfos";
                    Directory.CreateDirectory(CFiles);

                    Console.ForegroundColor = ConsoleColor.Yellow;
                    Console.WriteLine("[*]" + machine);
                    Console.ForegroundColor = ConsoleColor.White;

                    //获取users目录
                    string dpath = @"\" + machine + @"c$";
                    var d_list = Directory.EnumerateDirectories(dpath);
                    if (Directory.Exists(dpath))
                    {
                        //创建机器名文件夹
                        string MachineFolder = CFiles + "\" + machine;
                        Directory.CreateDirectory(MachineFolder);
                        //创建输出文本
                        string E_txt = MachineFolder + "\cFiles.txt";
                        StreamWriter sw = File.CreateText(E_txt);
                        sw.Close();
                        try
                        {
                            var files = Directory.GetFiles(dpath);
                            foreach (string file in files)
                            {
                                Console.WriteLine(file);
                                string create_time = Directory.GetCreationTime(file).ToString();
                                string writeFileTo = "create time:" + create_time + "  " + file + "rn";
                                File.AppendAllText(E_txt, writeFileTo);
                      ...