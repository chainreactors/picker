---
title: &#x5b;Guest Diary&#x5d; Using Zeek, Snort, and Grafana to Detect Crypto Mining Malware, (Tue, Nov 26th)
url: https://isc.sans.edu/diary/rss/31472
source: SANS Internet Storm Center, InfoCON: green
date: 2024-11-27
fetch_date: 2025-10-06T19:19:29.138194
---

# &#x5b;Guest Diary&#x5d; Using Zeek, Snort, and Grafana to Detect Crypto Mining Malware, (Tue, Nov 26th)

# [Internet Storm Center](/)

[Sign In](/login.html)
[Sign Up](/register.html)

Handler on Duty: [Johannes Ullrich](/handler_list.html#johannes-ullrich "Johannes Ullrich")

Threat Level: [green](/infocon.html)

* [previous](/diary/31470)
* [next](/diary/31474)

# [[Guest Diary] Using Zeek, Snort, and Grafana to Detect Crypto Mining Malware](/forums/diary/Guest%2BDiary%2BUsing%2BZeek%2BSnort%2Band%2BGrafana%2Bto%2BDetect%2BCrypto%2BMining%2BMalware/31472/)

**Published**: 2024-11-26. **Last Updated**: 2024-11-26 20:07:54 UTC
**by** [David Fitzmaurice, SANS.edu BACS Student](/handler_list.html#david-fitzmaurice,-sans.edu-bacs-student) (Version: 1)

[0 comment(s)](/diary/Guest%2BDiary%2BUsing%2BZeek%2BSnort%2Band%2BGrafana%2Bto%2BDetect%2BCrypto%2BMining%2BMalware/31472/#comments)

[This is a Guest Diary by David Fitzmaurice, an ISC intern as part of the SANS.edu Bachelor's Degree in Applied Cybersecurity (BACS) program [1].

Over the last six months there have been frequent SSH connections leaving versions of the RedTail malware on my DShield Honeypot [2]. This variation of the malware is placed on a victim device through a secure shell (SSH) connection. Upon a successful install of the malware the server will send a domain name system (DNS) request for the command and control IPs and begin communicating with its botnet.

This kind of attack is easy to prevent on a small network with only a handful of devices where SSH servers aren’t accessible to the internet. In a large network serviced by administrators with varying skill levels devices are often left with default or weak credentials. How can we minimize the time to detect a breach from a crypto miner?

**![](https://isc.sans.edu/diaryimages/images/2024-11-27_figure1.png)
Figure 1: Diagram showing the collecting network architecture and the visible portion of the attacking network.**

This malware uses SSH password guessing for the initial exploit and install of the RedTail malware as shown in figure 2. This attack uses username and password combos that can be found as defaults or passwords commonly used when users are forced to change their passwords frequently such as username `root` and password **`abc123!@#`**. This is a great reminder not to arbitrarily require password changes. Once the attacking server successfully authenticates it will upload the following files.

* **`setup.sh`**
* **`redtail.x86_64`**
* **`redtail.i686`**
* **`redtail.arm8`**
* **`redtail.arm7`**
* **`clean.sh`**

**![](https://isc.sans.edu/diaryimages/images/2024-11-27_figure2.png)
Figure 2: Initial SSH Connection to DShield Honeypot**

The RedTail files above each contain strings associated with the XMRig [3] crypto mining software.  The clean.sh script is used to prep the system for install and the **`setup.sh`** script is used to select and install the executable file appropriate for the victim system which will be one of the RedTail files above. Once the RedTail malware is run it will start two apache [4] processes for network communications, send a DNS request to various DNS servers for `moneroed[.]net`, create a connection to the original attacking IP on [port 43782](/port/43782), and create a connection to one of the servers identified in the DNS request to `moneroed[.]net` IPv4 records on [port 2137](/port/2137). The DNS requests can be seen in Figure 3, and the command and control connections can be seen in Figure 4.

**![](https://isc.sans.edu/diaryimages/images/2024-11-27_figure3.png)
Figure 3: DNS Request/Response**

**![](https://isc.sans.edu/diaryimages/images/2024-11-27_figure4.png)
Figure 4: Command and Control Channels**

Using the default configuration for Snort [5] did not generate any alerts from this attack. The default configuration for Zeek created SSH logs, DNS logs, and connection logs. In a busy network this could easily go undetected. Following the TCP stream for that [port 2137](/port/2137) connection in Wireshark shows JSON entries in ASCII that look exactly like the Stratum mining protocol [6] used by the XMRig software. This is shown in Figure 5.

**![](https://isc.sans.edu/diaryimages/images/2024-11-27_figure5_v2.PNG)
Figure 5: Port 2137 connection showing Stratum mining protocol communications**

In order to detect the Stratum mining protocol I found a Zeek package called zeek-cryptomining [6] that included Zeek scripts and signatures to detect the most common crypto mining communications such as communications from XMRig. Once the package was loaded onto my network sensor I started getting logs showing the malware communications. The network tap and network sensor can be seen in figures 1-4 and the logs created from the Stratum mining protocol can be seen in figure 6.

**![](https://isc.sans.edu/diaryimages/images/2024-11-27_figure6_v2.PNG)
Figure 6: An example of searching Grafana for Zeek\_Notice logs generated from an infected system.**

The [port 43782](/port/43782) connection proved to be a bit more complicated. During the initial connection the attacking server transferred around 70,000 bytes of data to the victim device. Once that concluded the victim system would send data starting with the hex bytes **`0x0c180000003c`** in each transmission. This is shown below in figure 7.

**![](https://isc.sans.edu/diaryimages/images/2024-11-27_figure7_v2.PNG)
Figure 7: Hex dump of port 43782 TCP stream in Wireshark.**

In order to track the connections seen on [port 43782](/port/43782) a Snort rule can be written. In this case I used the hex bytes 0x0c180000003c which I observed in most client to server packets. To speed up the rule writing process I used ChatGPT [8] to generate a basic draft.

**ChatGPT Prompt**
“Create a Snort signature to alert when the first six bytes of a TCP payload are as follows 0x0c180000003c. This signature should alert when the communications are from the home network to the internet.“

**ChatGPT Rule**
`alert tcp $HOME_NET any -> $EXTERNAL_NET any (msg:"TCP payload matches 0x0c180000003c"; content:"|0C 18 00 00 00 3C|"; offset:0; depth:6; flow:to_server,established; sid:1000001; rev:1;)`

I searched the Snort documentation [8] to verify the fields and add additional information. As a rule AI in its current state should be used as an augment, but any outputs should be verified. The Snort rule I used is added below. I decided to use the `classtype` field to output “`Known malware command and control traffic`” and set “`Priority: 1`” in the alert logs. The logs from testing the rule on my network tap and Grafana[9] server can be seen in figure 8.

`alert tcp $HOME_NET any -> $EXTERNAL_NET any (msg:"TCP payload starts with 0x0c180000003c. Possible Crypto mining."; content:"|0c 18 00 00 00 3c|"; offset:0; depth:6; sid:1900001; rev:1; classtype:malware-cnc;)`

**![](https://isc.sans.edu/diaryimages/images/2024-11-27_figure8_v2.PNG)
Figure 8: Snort alerts seen in Grafana for [port 43782](/port/43782) traffic**

These rules are specific enough to avoid false positives and broad enough to consistently detect when the RetTail malware is active. These rules have been running on my network tap from September 12, 2024 through November 15, 2024 and have not created any false positives. In that time the RedTail network has used three different initial attack IPs, and the sha256 hash of the X86\_64 variant of RedTail has changed five times. If we were to only rely on threat intelligence to identify malicious file hashes or IPs we would miss those changes.

Using a network tap or mirroring a port into an intrusion detection system (IDS) like Snort or Zeek and sending the traffic to a log analysis tool like Grafana creates a great environment for threat hunting activities. With some effort to characterize and create signatures or scripts for malicious network traffic threats can be detected almost immediately when the network is monitored. Analysts could take this a step further and characterize normal communications on the network so when something unusual occurs it will be noti...