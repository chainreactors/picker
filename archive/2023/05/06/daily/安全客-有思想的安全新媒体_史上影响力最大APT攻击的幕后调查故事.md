---
title: 史上影响力最大APT攻击的幕后调查故事
url: https://www.anquanke.com/post/id/288513
source: 安全客-有思想的安全新媒体
date: 2023-05-06
fetch_date: 2025-10-04T11:36:46.285951
---

# 史上影响力最大APT攻击的幕后调查故事

首页

阅读

* [安全资讯](https://www.anquanke.com/news)
* [安全知识](https://www.anquanke.com/knowledge)
* [安全工具](https://www.anquanke.com/tool)

活动

社区

学院

安全导航

内容精选

* [专栏](/column/index.html)
* [精选专题](https://www.anquanke.com/subject-list)
* [安全KER季刊](https://www.anquanke.com/discovery)
* [360网络安全周报](https://www.anquanke.com/week-list)

# 史上影响力最大APT攻击的幕后调查故事

阅读量**203767**

|评论**1**

发布时间 : 2023-05-05 11:46:58

**x**

##### 译文声明

本文是翻译文章，文章原作者 赛博攻防悟道，文章来源：https://mp.weixin.qq.com/s/N\_\_c78Ih1GeF8Y9d6fGfDg

原文地址：<https://www.wired.com/story/the-untold-story-of-solarwinds-the-boldest-supply-chain-hack-ever/>

译文仅供参考，具体内容表达以及含义原文为准。

那是2019年底，安全公司Volexity的总裁Adair正在调查一家美国智库的网络安全漏洞。入侵没什么特别的，Adair认为他和他的团队会迅速踢走攻击者并完成这个案子，然而直到他们发现了一些奇怪的事情…..第二组黑客此后又活跃在智库的网络中，他们正在追踪电子邮件，拷贝副本并将它们发送到外部的服务器。这些入侵者的技术要高超得多，他们每周都会多次往返智库网络，窃取特定高管、政策专家和IT员工的邮件。

Adair和他的同事将第二组黑客团伙称为“Dark Halo”，并将他们从网络中踢走，但很快他们又回来了。事实证明，黑客三年前在网络上植入了一类秘密的恶意代码后门，允许他们进入受感染的机器或与受感染的机器通信。现在是第一次暴露了这种情况，他们使用了这种后门。“我们关上了一扇门，他们很快就去了另一扇门”，Adair说。

Adair的团队花了一周的时间再次将攻击者踢出网络并清除了后门。但在2020年6月下旬，黑客不知何故又卷土重来，他们又开始从相同账号中盗取电子邮件。调查人员花了数天时间试图弄清楚他们是如何溜回来的。Volexity将注意力集中在智囊团的一台服务器上，这是一台运行某流行软件的机器，该服务器帮助智库的系统管理员管理他们的计算机网络。该软件是由一家为世界各地IT团队所熟知的公司开发的，但几乎所有人都可能会感到困惑，这是一家位于德克萨斯州奥斯汀的叫SolarWinds的公司。

Adair和他的团队认为黑客一定是在受害者的服务器上留了一个后门，但经过大量调查后，他们找不到这个后门。所以他们再次将入侵者赶了出去，为了安全起见，只能将服务器与互联网断开连接。Adair希望一切就此结束，但是这件事一直困扰着他。几天来，他都在凌晨2点左右醒来，感觉团队错过了一件大事。

是的，他们错过了，他们并不是唯一碰到这样情况的人。大约在Adair的团队将Dark Halo踢出智库网络的同时，美国司法部也在努力应对一次入侵事件，涉及运行相同SolarWinds软件试用版的服务器出现了问题。据知情人士透露，美国司法部在5月下旬发现从服务器传输到互联网的可疑流量，因此他们请世界上最重要的网络安全公司之一“Mandiant”来帮助他们调查，他们还与微软合作，但仍然不清楚如何被入侵。（司法部发言人证实发生了这一事件和调查，但拒绝透露Mandiant和微软是否参与其中，两家公司均未对调查发表评论）

据熟悉该事件的消息人士称，调查人员怀疑黑客可能通过利用SolarWinds软件中的漏洞直接破坏了司法部的服务器。消息人士称，司法部团队联系了SolarWinds公司，甚至引用了他们认为可能与该问题相关的特定文件，但SolarWinds的工程师无法在他们的代码中找到漏洞。数周来回之后，谜团仍未解开，调查人员与SolarWinds之间的沟通也停止了（SolarWinds拒绝对这一事件发表评论）。当然，该部门并不知道Volexity也出奇地处理了相似的黑客攻击事件。

随着夏天到了秋天，在这种闭门造车的情况下，政府和安全行业的人们开始怀疑有什么大事正在发生。但政府多年来一直试图改善与外部安全专家的沟通，突然间就不再沟通了。在接下来的几个月里，“通常很健谈的人都变得沉默寡言了”，一位前政府工作人员说。他说，某些人越来越担心一场毁灭性的网络行动正在展开，而且没有人能控制它。

事实上，美国司法部和Volexity公司已经无意中发现了十年来最复杂的网络攻击活动之一。肇事者确实入侵了SolarWinds的软件。使用调查人员以前从未见过的技术，黑客获得了对公司数千名客户的访问权限。受感染者中至少有八个重要美国联邦机构，包括美国国防部、国土安全部和财政部，以及先进的技术公司，甚至顶级的安全公司，这些公司包括英特尔、思科和Palo Alto，当然微软和 Mandiant也在受害者名单上，他们中没有人知道发生了什么。

在美国司法部事件发生后，该行动至少持续了六个月还未被发现。直到调查人员最终破获它时，他们被黑客攻击的复杂性和终极谋划震惊了。然而，两年多过去了，他们拼凑的事件碎片或者至少他们公开分享过的信息，仍然无法还原攻击的全貌。关于这场攻击活动对美国联邦系统的影响以及被盗数据的全面统计，从未向公众或国会议员提供过。根据前政府的消息来源和某些人的说法，许多受影响的联邦机构没有能够维护足够的网络安全日志，因此不知道被拿走了什么。更糟糕的是：一些专家认为，SolarWinds并不是唯一的被攻击媒介，其他软件制造商曾经或可能仍然在传播恶意软件。

下面是对揭露这起黑客行动的最终调查内幕描述。它是如何发生的，以及迄今为止我们所知道的一切…

**线索**

2020年11月10日，Mandiant公司的一位名叫Henna Parviz的分析师处理了一次例行安全告警，只要员工在公司的多因素身份验证系统中注册一部新手机，就会触发这种警报。该系统向经过认证的设备发送一次性访问代码，允许员工登录公司的VPN网络。但是Parviz注意到这款三星设备有一些不寻常的地方：“它没有关联的电话号码”。

Parviz仔细查看了手机的活动日志，发现了另一个奇怪的细节。该员工似乎使用手机从佛罗里达州的IP地址登录了他的VPN账号。但此人不住在佛罗里达州，他的旧iPhone仍然在多因素系统中注册。然后她注意到三星手机已从佛罗里达州的IP地址登录，同时该员工也从他的家乡使用iPhone登录。这引起了Mandiant公司的注意！

Mandiant安全团队封锁了这个三星设备，然后花了一周时间调查入侵者如何获得员工的VPN用户名和密码。他们很快意识到这个问题已经不是某个员工的账户失陷了。攻击者实施了Golden SAML攻击，一种用于劫持公司任意员工身份验证系统的复杂技术，他们可以夺取任意员工账户的控制权，授予这些账户更多权限，甚至可以创建具有无限访问权限的新账户。有了这种能力，攻击者可以深入访问到公司内部的任何网络和资产。

11月17日，Mandiant工程咨询部门的高级成员Scott Runnels和Eric Scales悄悄召集了一个大约10人的顶级调查响应团队，他们从其他项目中调取了人力，但没有告诉管理层任何原因，甚至没有提这些抽调的员工何时会回来。由于不确定调查响应会发现什么，Runnels和 Scales需要控制知情人的范围。该团队很快意识到，黑客已经活跃了数周，但通过“无文件攻击”来逃避检测，通过破坏网络上已有的管理工具来实施他们的恶意行为，这样就不会在攻击活动中引入他们自己的工具。他们还试图避免在活动日志和其他地方留下痕迹，以规避调查人员搜寻威胁的常规模式。

但在攻击者试图对抗Mandiant的过程中，无意中留下了不同的指纹。几天之内，调查人员找到了踪迹，开始了解入侵者去过哪里以及他们偷了什么东西。

11月20日星期五早上，Mandiant的创始人兼首席执行官Kevin Mandia在与3000名员工举行的全体会议上点击退出，就注意到他的助手在他的日历中添加了一个新的电话会议，上面只备注了“安全简报”。Mandia是一名52岁的前空军情报官员，退役20年后仍留着标准的军人发型。他本打算在周末早点下班，但还是先拨通了电话会议，他期待能够快速结束会议，但会议在进行了五分钟后，他就知道他的周末结束了。

Mandia于2004年创立的公司调查了过去二十年中许多最引人注目的黑客事件。该公司于2013年被FireEye收购，去年又被谷歌收购，该公司的威胁猎手每年处理1000多起安全事件，其中包括谷歌、索尼、Colonial Pipeline等公司的事件。在那段时间里，Mandiant本身从未遭受过严重的黑客攻击，现在猎人成了猎物。

Mandia了解到，入侵者窃取了自己公司用来查找客户网络漏洞的红队工具，入侵者还查看了识别其政府客户的敏感信息。当他的团队描述入侵者如何隐藏他们的入侵活动时，Mandia回忆起了他职业生涯早期的事件。从1995年到2013年，在空军特别调查办公室和私企部门，他曾观察到俄罗斯威胁行为者在不断测试系统，一旦调查人员锁定他们，他们就会消失。俄罗斯威胁行为者的坚持和隐秘使他们成为Mandia遇到过的最难缠的对手。现在，在会议上听到自己公司内部出现了相似的入侵活动，他的直觉告诉一位会议听众：“开始对这种攻击模式进行匹配”。在得知令人不安的被入侵消息后的第二天，他联系了美国国家安全局（NSA）和其他政府联系人。

当Mandia与政府商讨时，Mandiant的首席技术官Charles Carmakal联系了一些老朋友。这次入侵活动的许多黑客攻击技战术都很陌生，他想知道之前的Mandiant同事Christopher Glyer和Nick Carr是否见过这些技战术。Glyer和Carr花了多年时间调查大规模、复杂的攻击，并广泛跟踪了很多臭名昭著的黑客组织。现在，这两个人在微软工作，他们比在Mandiant时可以看到更多黑客攻击活动的数据。

Carmakal只是告诉他们最基本的信息，他想获得帮助，以确定Mandiant发现的一些活动。这两家公司的员工经常在调查方面交流情报，因此Glyer并没有多想这个请求。那天晚上，他花了几个小时研究Carmakal发给他的数据，然后请Carr接替他。Carr是一个夜猫子，所以他们经常一起合作，Carr在早上将工作交回给Glyer。

这两个人没有看到任何熟悉的已知黑客组织的技战术，但随着他们追踪线索，他们意识到Mandiant正在追踪的是非常重要的目标。”每次你抽取一根线，会发现一条更长的线”，Glyer回忆道。他们可以看到多个受害者正在与Carmakal要求他们跟踪的黑客组织进行通信。对于每个受害者，攻击者都会建立一个专用的命令控制服务器，并给该机器一个名字，这部分模仿了受害者网络上真实系统的名称，以避免引起怀疑。当Glyer和Carr看到这些名称列表时，他们意识到可以使用它来识别新的受害者。在这个过程中，他们发现了Carmakal没有向他们透露的东西，Mandiant自身已被黑客攻击。

这是一个“天哪”时刻，微软威胁情报负责人John Lambert回忆道。攻击者不仅仅是想窃取数据，他们还在对抗他们最大的敌人之一，进行反情报活动。“当客户遇到安全事件时，谁是他们最经常联系的人？”，他说。“是Mandiant。”

随着Carr和Glyer关联了更多的线索，他们意识到曾在几个月前未解决的入侵事件中看到了这次黑客攻击的迹象。越来越多的证据表明，黑客们在隐藏他们的行踪方面表现出卓越的技能和谨慎，这让他们想起了某个熟悉的APT组织。

**搜寻**

在Mandiant公司内部，员工们正拼命想办法解决黑客盗走的用于暴露客户防御漏洞的红队工具问题。他们担心入侵者会将这些产品用于攻击Mandiant的客户或在暗网上进行分发，因此Mandiant成立了一个响应团队，着手制定一种方案来检测这些工具在野外的使用情况。同时，Runnels的团队也在加紧研究黑客到底是如何隐蔽地侵入公司系统的。

由于疫情的缘故，Mandiant的团队在家里工作，因此他们每天连接着会议电话，持续了18个小时，一边梳理日志和系统，一边绘制黑客走过的每一个步骤。随着时间的推移，他们逐渐熟悉了彼此的生活节奏，背景中孩子和伴侣的声音，Runnels脚边沉睡的斗牛犬轻微的鼾声。这项工作如此消耗精力，以至于有一次，Runnels在淋浴时接到了Mandiant一名高管的电话。

Runnels和Scales每天向Mandia汇报。每次CEO都问同样的问题：黑客是如何入侵的？但调查人员没有答案。

在12月8日，当检测工具准备好并且该公司感觉已经获得了足够有关入侵事件的信息可以公开时，Mandiant公司打破沉默，发布了一份重磅声明，揭示其已遭到黑客攻击。声明内容简洁：技术高超的黑客窃取了该公司的一些安全工具，但其中许多已经是公开的，并且没有证据表明攻击者使用了这些工具。首席技术官Carmakal担心客户会失去对公司的信心。他也担心同事们会对这个消息作何反应。“员工们会感到尴尬吗？”， 他想知道，“人们还想不想继续成为这个团队的一员？”

Mandiant公司并没有透露入侵者是如何进入公司网络的，或者他们在公司网络中停留了多长时间。该公司拒绝评论。这些省略造成了这次入侵事件是孤立事件而没有其他受害者的印象，人们开始怀疑该公司是否犯了基本的安全错误导致被攻击。“我们说我们被顶尖对手攻破了，” Carmakal说，这是每个受害者都会声称的情况：“在没有调查清楚之前，我们还不能提供证据”。

Mandiant公司并没有清楚地说明它是在何时第一次发现了导致入侵源头的线索。Runnels的团队提出了一连串的假设，并花费数周时间追踪每一个线索，但最终什么都没有找到。当他们在流量日志中发现一个重要线索时，他们几乎已经失去了希望：数月前，Mandiant的一台服务器曾与互联网上的一个神秘系统短暂通信过。而那台服务器正在运行SolarWinds的软件。

SolarWinds研发了数十个程序，供IT管理员监控和管理他们的网络，帮助他们同时配置和打补丁大量的系统，跟踪服务器和应用程序的性能，以及分析流量。Mandiant正在使用该公司最受欢迎的软件之一，名为Orion的软件套件。这个软件只应该偶尔与SolarWinds的网络通信以获取更新，但实际上它正在与一个未知的系统通信，很可能是黑客的命令控制服务器。

早在6月份，Mandiant就被召唤来协助美国司法部调查一台运行SolarWinds软件的服务器入侵事件。为什么全球顶尖安全公司之一的“熟悉已知攻击模式”的专家们似乎没有意识到这两个案件之间的相似性，这是SolarWinds安全事件仍然存在的一个谜团。很可能Runnels所选的几个人没有参与司法案件的工作，内部保密措施也防止他们发现这种联系。（Mandiant拒绝置评）

Runnels的团队怀疑入侵者已在Mandiant服务器上安装了后门，他们委派团队中的技术总监Willi Ballenthin和其他两名成员来寻找它。他面临的任务并不简单。Orion软件套件由超过18000个文件和14 GB的代码和数据组成。Ballenthin认为，要找到造成可疑流量的恶意组件就像在没有读过《白鲸》这本书的情况下在其中查找特定句子一样困难。

然而，他们只花了24小时就找到了一直在寻找的那个段落：“一个看似负责恶意流量的某个文件”。Carmakal认为他们是在12月11日找到的它。

这个文件是一个.dll动态链接库，也是其他程序共享的代码组件。这个.dll文件非常大，包含约46000行代码，执行了4000多个合法的操作，并且在他们分析了一个小时后，发现它还执行了一个非法的操作。

这个.dll的主要工作是告诉SolarWinds有关客户Orion软件使用情况的信息。但黑客嵌入了恶意代码，使其将受害者网络的情报传输到他们的命令控制服务器。Ballenthin将这个恶意代码称为“Sunburst”，这是对SolarWinds的一种玩弄。他们对这个发现感到非常兴奋。但现在他们必须弄清楚入侵者是如何将它偷偷嵌入到Orion软件的.dll中的。

这远非易事。Orion的.dll文件是用SolarWinds数字证书签名的，这个数字证书验证该文件是合法的公司代码。一个可能性是攻击者窃取了数字证书，创建了一个后门版本的Orion文件，签名该文件以使其看起来是正常的，然后安装了恶意的.dll文件在Mandiant的服务器上。或者更令人担忧的是，他们可能已经入侵了SolarWinds的网络，在SolarWinds编译（将代码转换为软件）并签名之前，修改了合法的Orion.dll源代码。第二种情况似乎太不切实际，以至于Mandiant的团队并没有真正考虑它，直到一名调查员从SolarWinds网站上下载了一个Orion软件更新，发现其中有相同的后门。

这个发现的含义是惊人的。Orion软件套件有大约33000个客户，其中一些客户从3月份开始就收到了被黑客篡改过的软件更新。这意味着一些客户可能已经被攻击者入侵了八个月。Mandiant团队面临着软件供应链攻击的典型案例，对可信软件在其源头进行的恶意修改。攻击者这一举动可以感染数千台机器，甚至可能是数百万台。

2017年，黑客破坏了软件供应链，通过入侵计算机安全清理工具CCleaner向超过200万用户传递恶意软件。同年，黑客在软件更新中传播了恶意NotPetya蠕虫到乌克兰的TurboTax等软件中，然后蔓延到全球。不久之后，黑客也曾使用软件更新向数千名华硕客户植入后门。即使在调查的早期阶段，Mandiant团队就已经能够判断这些攻击远远无法与SolarWinds攻击相媲美。

**调查**

2020年12月12日是一个星期六的早晨，Mandia打电话给SolarWinds的总裁兼首席执行官凯文·汤普森。这位德克萨斯州公司的14年资深员工将在月底卸任CEO。Mandia要告诉他的消息是：Orion软件已被感染。这是一个结束他任期的糟糕方式。“我们将在24小时内公开这个消息，” Mandia说。他承诺给SolarWinds一个先发布公告的机会，但时间表是不可协商的。Mandia没有提到的是他自己也面临外部压力：一名记者已经得到了有关后门的消息，并联系了他的公司以确认它。Mandia预计这个故事将在周日晚上爆料，他想先抢占先机。

汤普森开始拨打电话，其中之一是致电SolarWinds安全架构主管蒂姆·布朗。布朗及其团队很快确认了Sunburst后门存在于Orion软件更新中，并惊恐地发现自2020年春季以来已向多达18,000名客户提供了该软件更新（并非每个Orion用户都下载了该更新）。汤普森和其他人在周六大部分时...