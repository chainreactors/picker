---
title: The Windows Registry Adventure #8: Practical exploitation of hive memory corruption
url: https://googleprojectzero.blogspot.com/2025/05/the-windows-registry-adventure-8-exploitation.html
source: Project Zero
date: 2025-05-29
fetch_date: 2025-10-06T22:29:04.057726
---

# The Windows Registry Adventure #8: Practical exploitation of hive memory corruption

# [Project Zero](https://googleprojectzero.blogspot.com/)

News and updates from the Project Zero team at Google

## Wednesday, May 28, 2025

### The Windows Registry Adventure #8: Practical exploitation of hive memory corruption

Posted by Mateusz Jurczyk, Google Project Zero

In the [previous blog post](https://googleprojectzero.blogspot.com/2025/05/the-windows-registry-adventure-7-attack-surface.html), we focused on the general security analysis of the registry and how to effectively approach finding vulnerabilities in it. Here, we will direct our attention to the exploitation of hive-based memory corruption bugs, i.e., those that allow an attacker to overwrite data within an active hive mapping in memory. This is a class of issues characteristic of the Windows registry, but universal enough that the techniques described here are applicable to [17](https://project-zero.issues.chromium.org/issues?q=CVE-2022-34707%20OR%20CVE-2022-34708%20OR%20CVE-2022-37956%20OR%20CVE-2022-37988%20OR%20CVE-2022-38037%20OR%20CVE-2023-21675%20OR%20CVE-2023-21748%20OR%20CVE-2023-23420%20OR%20CVE-2023-23421%20OR%20CVE-2023-23422%20OR%20CVE-2023-23423%20OR%20CVE-2023-28248%20OR%20CVE-2023-35382%20OR%20CVE-2023-38139%20OR%20CVE-2024-26182%20OR%20%20CVE-2024-43641%20OR%20CVE-2024-49114) of my past vulnerabilities, as well as likely any similar bugs in the future. As we know, hives exhibit a very special behavior in terms of low-level memory management (how and where they are mapped in memory), handling of allocated and freed memory chunks by a custom allocator, and the nature of data stored there. All this makes exploiting this type of vulnerability especially interesting from the offensive security perspective, which is why I would like to describe it here in detail.

Similar to any other type of memory corruption, the vast majority of hive memory corruption issues can be classified into two groups: spatial violations (such as buffer overflows):

[![A diagram showing a corrupted memory cell overflowing an adjacent cell](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj2cnmRXF5pxU4eJk13OsumymAYXEqnnICfxVyIDcM5LyyV00On5OT-PDpfIxwUmrEwTt6m9ksAaDTYbKi08zTGXOjLfvFlRrAhGaATI2wq2TBL-yecg15_xe3UsXUOtgSoDXyywYB1J46EQv_cqP_kVMxkFMXtCGWA1-Iy3vsvgUmZFuCYUiQ5LoPTQ9c/s933/image5.png "A diagram showing a corrupted memory cell overflowing an adjacent cell")](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj2cnmRXF5pxU4eJk13OsumymAYXEqnnICfxVyIDcM5LyyV00On5OT-PDpfIxwUmrEwTt6m9ksAaDTYbKi08zTGXOjLfvFlRrAhGaATI2wq2TBL-yecg15_xe3UsXUOtgSoDXyywYB1J46EQv_cqP_kVMxkFMXtCGWA1-Iy3vsvgUmZFuCYUiQ5LoPTQ9c/s933/image5.png)

and temporal violations, such as use-after-free conditions:

[![A diagram showing multiple invalid references to a freed cell](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh6FFGFmqEfSfaeWmlmZjdZeyMeHLk_IChZUwN5W6V0XP7o6_0zTxidHhwWTOToJS0TB5SUhsr5Zkf2-NYoGBwT3um1z625ZGni-ykzQbg7CNgU2eVbv05ts0iGxR6ttuIZJZchkpDDV7UOtw7lWGS21Udfk0eW7TSKabU50fGEVjr2KIZQbVURSRo84UE/s933/image19.png "A diagram showing multiple invalid references to a freed cell")](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh6FFGFmqEfSfaeWmlmZjdZeyMeHLk_IChZUwN5W6V0XP7o6_0zTxidHhwWTOToJS0TB5SUhsr5Zkf2-NYoGBwT3um1z625ZGni-ykzQbg7CNgU2eVbv05ts0iGxR6ttuIZJZchkpDDV7UOtw7lWGS21Udfk0eW7TSKabU50fGEVjr2KIZQbVURSRo84UE/s933/image19.png)

In this write up, we will aim to select the most promising vulnerability candidate and then create a step-by-step exploit for it that will elevate the privileges of a regular user in the system, from Medium IL to system-level privileges. Our target will be Windows 11, and an additional requirement will be to successfully bypass all modern security mitigations. I have previously presented on this topic at OffensiveCon 2024 with a presentation titled ["Practical Exploitation of Registry Vulnerabilities in the Windows Kernel"](https://www.offensivecon.org/speakers/2024/mateusz-jurczyk.html), and this blog post can be considered a supplement and expansion of the information shown there. Those deeply interested in the subject are encouraged to review the [slides](https://j00ru.vexillium.org/slides/2024/offensivecon.pdf) and [recording](https://www.youtube.com/watch?v=qllMa2UUPvY) available from that presentation.

## Where to start: high-level overview of potential options

Let's start with a recap of some key points. As you may recall, the Windows registry cell allocator (i.e., the internal HvAllocateCell, HvReallocateCell, and HvFreeCell functions) operates in a way that is very favorable for exploitation. Firstly, it completely lacks any safeguards against memory corruption, and secondly, it has no element of randomness, making its behavior entirely predictable. Consequently, there is no need to employ any "hive spraying" or other similar techniques known from typical heap exploitation – if we manage to achieve the desired cell layout on a test machine, it will be reproducible on other computers without any additional steps. A potential exception could be carrying out attacks on global, shared hives within HKLM and HKU, as we don't know their initial state, and some randomness may arise from operations performed concurrently by other applications. Nevertheless, even this shouldn't pose a particularly significant challenge. We can safely assume that arranging the memory layout of a hive is straightforward, and if we have some memory corruption capability within it, we will eventually be able to overwrite any type of cell given some patience and experimentation.

The exploitation of classic memory corruption bugs typically involves the following steps:

1. Initial memory corruption primitive
2. ???
3. ???
4. ???
5. Profit (in the form of arbitrary code execution, privilege escalation, etc.)

The task of the exploit developer is to fill in the gaps in this list, devising the intermediate steps leading to the desired goal. There are usually several such intermediate steps because, given the current state of security and mitigations, vulnerabilities rarely lead directly from memory corruption to code execution in a single step. Instead, a strategy of progressively developing stronger and stronger primitives is employed, where the final chain might look like this, for instance:

[![A flowchart depicting exploit development strategy, starting with "Memory corruption" which leads to "Information leak". This is followed by "Arbitrary vtable call", then "ROP" (Return-Oriented Programming). "ROP" leads to "Allocation of executable payload", which ultimately results in "Arbitrary code execution".](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjLNPhQCEIJQwPAmHwGkk7aqreRRHqKBmZfFg9oz7Rs1NZhCekTv6ZOzf3Ol7eb3riI02g-Fp9dR-_DVq4WSn7Vzlc4P3QGlT9T6xINLbhUJIJ6IiTCPECl71N05nKL7ti7lU-4ZYpbfkRi0L66-9U9p47eUipaCUGuC-7C59QVpYUD5zD0NyxKcKfBSJo/s1200/image11.png "A flowchart depicting exploit development strategy, starting with \"Memory corruption\" which leads to \"Information leak\". This is followed by \"Arbitrary vtable call\", then \"ROP\" (Return-Oriented Programming). \"ROP\" leads to \"Allocation of executable payload\", which ultimately results in \"Arbitrary code execution\".")](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjLNPhQCEIJQwPAmHwGkk7aqreRRHqKBmZfFg9oz7Rs1NZhCekTv6ZOzf3Ol7eb3riI02g-Fp9dR-_DVq4WSn7Vzlc4P3QGlT9T6xINLbhUJIJ6IiTCPECl71N05nKL7ti7lU-4ZYpbfkRi0L66-9U9p47eUipaCUGuC-7C59QVpYUD5zD0NyxKcKfBSJo/s1348/image11.png)

In this model, the second/third steps are achieved by finding another interesting object, arranging for it to be allocated near the overwritten buffer, and then corrupting it in such a way as to create a new primitive. However, in the case of hives, our options in this regard seem limited: we assume that we can fully control the representation of any cell in the hive, but the problem is that there is no immediately interesting data in them from an exploitation point of view. For example, the regf format does not co...