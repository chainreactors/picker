---
title: CVE-2022-38627: A journey through SQLite Injection to compromise the whole enterprise building
url: https://infosecwriteups.com/cve-2022-38627-a-journey-through-sqlite-injection-to-compromise-the-whole-enterprise-building-15cebd072ed6?source=rss----7b722bfd1b8d--bug_bounty
source: Bug Bounty in InfoSec Write-ups on Medium
date: 2023-01-03
fetch_date: 2025-10-04T02:54:42.044611
---

# CVE-2022-38627: A journey through SQLite Injection to compromise the whole enterprise building

[Sitemap](/sitemap/sitemap.xml)

[Open in app](https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F15cebd072ed6&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&%7Estage=mobileNavBar&source=post_page---top_nav_layout_nav-----------------------------------------)

Sign up

[Sign in](https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Finfosecwriteups.com%2Fcve-2022-38627-a-journey-through-sqlite-injection-to-compromise-the-whole-enterprise-building-15cebd072ed6&source=post_page---top_nav_layout_nav-----------------------global_nav------------------)

[Medium Logo](https://medium.com/?source=post_page---top_nav_layout_nav-----------------------------------------)

[Write](https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---top_nav_layout_nav-----------------------new_post_topnav------------------)

[Search](https://medium.com/search?source=post_page---top_nav_layout_nav-----------------------------------------)

Sign up

[Sign in](https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Finfosecwriteups.com%2Fcve-2022-38627-a-journey-through-sqlite-injection-to-compromise-the-whole-enterprise-building-15cebd072ed6&source=post_page---top_nav_layout_nav-----------------------global_nav------------------)

![](https://miro.medium.com/v2/resize:fill:64:64/1*dmbNkD5D-u45r44go_cf0g.png)

[## InfoSec Write-ups](https://infosecwriteups.com/?source=post_page---publication_nav-7b722bfd1b8d-15cebd072ed6---------------------------------------)

·

Follow publication

[![InfoSec Write-ups](https://miro.medium.com/v2/resize:fill:76:76/1*SWJxYWGZzgmBP1D0Qg_3zQ.png)](https://infosecwriteups.com/?source=post_page---post_publication_sidebar-7b722bfd1b8d-15cebd072ed6---------------------------------------)

A collection of write-ups from the best hackers in the world on topics ranging from bug bounties and CTFs to vulnhub machines, hardware challenges and real life encounters. Subscribe to our weekly newsletter for the coolest infosec updates: <https://weekly.infosecwriteups.com/>

Follow publication

# CVE-2022-38627: A journey through SQLite Injection to compromise the whole enterprise building

## Introduction:

[![Omar Hashem](https://miro.medium.com/v2/resize:fill:64:64/1*ayu-cF0Elq8Emv1cdCLf_A.jpeg)](https://omar0x01.medium.com/?source=post_page---byline--15cebd072ed6---------------------------------------)

[Omar Hashem](https://omar0x01.medium.com/?source=post_page---byline--15cebd072ed6---------------------------------------)

5 min read

·

Dec 30, 2022

--

2

Listen

Share

In this research, I will show you how I managed to find this critical 0-day that allows me to control the entire enterprise building (doors, cameras, elevators, etc… ) in addition to that, I can collect employee data and add new employees who have permission to access the enterprise building, all of this is besides to the natural impact of a critical SQL injection vulnerability

Actually, in this research, you will see the implementation of hacking movies scenes but a real-life scenario

### Summary of Linear eMerge E3 Series product:

The Linear eMerge E3 Series is one of the industry leading products in building management systems as it is one of the most widely used products in the industry which is used for control

* School Districts and Campuses (K12 & Higher Ed)
* Corporate Campuses
* State/Local Government buildings (Civic Centers, City Hall, Police Stations, Jails, etc.)
* Public Utilities
* Transportation (Airports, Subway, Bus Depots)
* Places of Worship (Churches, Mega-Church campuses)
* Medical Facilities (Hospitals, Pharma, Bio Labs, etc.)
* And more

### Let’s start the Static-Analysis:

I came across this endpoint /badging/badge\_template\_print.php so let’s take a look at the code

As you can see the developers take user input through the “idt” parameter and then pass it to the query using prepare statement which should prevent the SQL Injection

Press enter or click to view image in full size

![]()

but wait a minute there is a wrong implementation of prepare statement here and to know what has gone wrong we need to understand what are (the prepare statement workflow) first

## How prepared statement work:

The prepared statement processing workflow passes through 7 phases

Press enter or click to view image in full size

![]()

**Prepare Statement Phases *for SQL query processing***

simply it passes the query to the database like this

> $sth = $db->prepare(“SELECT \* FROM “.dbtable.” where No = ?”);

as the question mark is called a parameter placeholder

So what happens under the prepared statement is that the query will be passed through 7 phases:

**1- Parsing Phase:** parsed for Syntax errors and misspelling checks to ensure the validity of the SQL query then

**2- Semantics Check Phase:** The Database Management System (DBMS) establishes the validity of the query. Does the specified columns and table exist? Does the user have privileges to execute this query?

**3- Binding Phase:** the database engine detects the placeholders, and the query is compiled with placeholders. The user-supplied data will be added later at (Placeholder replacement phase like this).

> $sth->bindValue(1, $id, PDO::PARAM\_INT);

**4- Query Optimization** **Phase:** The DBMS chooses the best algorithm for executing the query.

**5- Cache** **Phase:** The best algorithm is saved in the cache, so the next time when the same query is executed it will skip the first four phases and jump straight to the Placeholder replacement phase

**6- Placeholder Replacement** **Phases:** at this phase, the placeholders are replaced with the user’s data. However, the query is already pre-compiled (**Binding**), so the final query will not go through the compilation phase again. For this reason, the user-provided data will always be interpreted as a simple string and cannot modify the original query’s logic. which makes the query will be immune to SQL Injection vulnerabilities for that data.

**7- Execution Phase:**

> $sth->execute();

then finally the query executed successfully

These are the phases that prepared statements pass through to prevent the SQL injection

So let’s retake a look at what happened here

Press enter or click to view image in full size

![]()

the developer Put the $id parameter that comes from the user into the prepared statement and not bind Value as I have described above so if the user input parameter is something like that

> ?id=1 UNION SELECT \* FROM User

then the $sth variable value will be like that

> $db->prepare(“SELECT \* FROM User where No=1 UNION SELECT \* FROM User”)

so the prepared statement will take our input as part of the query (not considering it a bind value) and the user input will be passed through all Phases from Phase one which mean that the user input will be considered part of the query as the SQL compiler will compile it as a part of the query and will not be considered as a bind value because it passed in Query from the first phase, not at the sixth phases(placeholder replacement) and which will lead to successfully SQLI

Press enter or click to view image in full size

![]()

$xml variable is load XML file by using the parameter “tpl”

First “if statement” forces us to load an XML file that contains <picture> tag anyway developers created this XML file “aa.xml” for that, so all we need to do is just put the file name in the “tpl” parameter ?tpl=aa.xml

The second “if statement” we need to make it false to execute else that will print the “ImageFile” column in the page to extract the database content

So in our exploitation, we need to concatenate the output on the ImageFile column as this is the possible way to extract the database

### Exploitation:

As I have already access to the source code and database so I know that The ImageFile column was column number 12 out of 39 columns on the “User” table so we don’t need to exploit it as we expl...