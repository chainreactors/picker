---
title: 陌陌安全获Apple致谢：CVE-2022-42837 - iTunes Store 之殇
url: https://buaq.net/go-140601.html
source: unSafe.sh - 不安全
date: 2022-12-20
fetch_date: 2025-10-04T01:58:06.707200
---

# 陌陌安全获Apple致谢：CVE-2022-42837 - iTunes Store 之殇

* [unSafe.sh - 不安全](https://unsafe.sh)
* [我的收藏](/user/collects)
* [今日热榜](/?hot=true)
* [公众号文章](/?gzh=true)
* [导航](/nav/index)
* [Github CVE](/cve)
* [Github Tools](/tools)
* [编码/解码](/encode)
* [文件传输](/share/index)
* [Twitter Bot](https://twitter.com/buaqbot)
* [Telegram Bot](https://t.me/aqinfo)
* [Search](/search/search)

[Rss](/rss.xml)

[ ]
黑夜模式

![](https://8aqnet.cdn.bcebos.com/7dc56a8faa275b8bf3c0689edd06ab4e.jpg)

陌陌安全获Apple致谢：CVE-2022-42837 - iTunes Store 之殇

导语：陌陌安全获Apple致谢；iOS
*2022-12-19 17:56:32
Author: [www.4hou.com(查看原文)](/jump-140601.htm)
阅读量:53
收藏*

---

导语：陌陌安全获Apple致谢；iOS

先为我们的同学@dwj1210鼓鼓掌👏。作为围观了整个漏洞从发现到最终形成本篇文章的同学。小编前面先说一句：本次漏洞发现非常巧合，前些天给WMCTF出题的时候，dwj同学突然小声念叨好像挖到了一个RCE。于是在出完题后，我们开始了给Apple提交漏洞帮助Apple修复的漫长之路，也就有了dwj这篇文章。以下就是dwj同学的自述：

为什么这里叫做 iTunes Store 之殇，是因为 iTunes Store App 任意 javascript 代码执行的漏洞已经被修了好几次了。

该漏洞由 Safari 浏览器 中的一个恶意页面引入，当你点击一个 URL Schemes 或 Universal Links 的链接时，可以通过这个特殊的 URL 调起指定 App 并传入攻击荷载。如果在 Safari浏览器中输入sms://可以调起信息 App，此时会有一个弹框询问是否允许打开。

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/1YLJUhm0ZtmleLCxRHiaDhUeuOFZ4YqIFXzwLwicLFXSv4Jr0ibnvquianRcMLXLvJicpha1LVTLekv85f8eaFqMoMg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

但是一些内置的 Apple 应用程序是被 Safari 浏览器信任的，不会询问用户直接拉起，这些应用程序被硬编码在系统代码中：

![image.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20221219/1671443711134266.png "1671442395180672.png")

早在 Pwn2Own 2014 年韩国黑客 lokihardt 通过一个特殊的 URL 在 iTunes Store 打开了任意的网页：

![image.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20221219/1671443711179082.png "1671443506286533.png")

而 itms:// 就是 iTunes Store 注册的 URL Scheme，由于应用程序白名单的缘故不需要向用户询问就可以直接在 iTunes Store 中打开恶意的网页。

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/1YLJUhm0ZtmleLCxRHiaDhUeuOFZ4YqIFh07akaUb4lGdTZEeoMHHbrko3kDXTkKLLicPIqIzplSdumR1sNiboUFA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

此时结合一个 UAF 就完成了沙箱逃逸加任意代码执行。

后面苹果加入了域名限制，只有域名后缀满足 trustedDomains 域名列表时才会打开，但是 lokihardt 又找到了一个信任域的 DOM xss 又打了一次。

之后沉寂多年，在 2020 年天府杯上，cc 师傅凭借完整的 full chain exploit 远程破解了搭载 iOS14.2 的 iPhone11 设备。

而该漏洞利用链的第一步依然是从 Safari 到 iTunes Store，不利用内存破坏，不执行 shellcode，通过一个特殊的 URL 可以绕过域名白名单的校验执行任意的 javascript 代码，触发 xss 弹计算器。

![image.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20221219/1671443713198130.png "1671442479170011.png")

感兴趣的朋友可以直接研读 cc 师傅的文章：《CVE-2021-1748：从客户端 XSS 到弹计算器》 https://codecolor.ist/2021/08/04/mistuned-part-i/

而今天要介绍的依然是 iTunes Store 的任意 javascript 代码执行。

iTunes Store 中有一段逻辑，当传入的 URL Scheme 中有一个特殊的参数时，应用就会忽略 URL 的 host，直接加载 URL Scheme 参数中的 URL 进行加载，比如：

![image.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20221219/1671443713157287.png "1671443654630915.png")

iTunes Store 在启动的时候会从这个URL拉取一个 XML 文件，XML 文件中的 trustedDomains 字段中预置了 Apple 的可信域名：

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/1YLJUhm0ZtmleLCxRHiaDhUeuOFZ4YqIF1aViaWRsqWtia80nH8rtdN48FPkmEibPOBP3NyzzpC9UdHHSm7vo5Q2cQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

只有页面的主机名和 trustedDomains 字段的后缀匹配，该页面才会被允许在 iTunes Store 中打开。

域名校验在-[ISURLBag urlIsTrusted:]函数中，但是该函数的域名校验存在缺陷。当你传入的 URL 为http://@www.apple.com:@www.hacker.com 时，iOS 系统在通过 -[NSURL host]函数取 host 时会取到www.apple.com，但是实际打开的页面却是 www.hacker.com。据了解在 Android 平台同样存在类似的问题。

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/1YLJUhm0ZtmleLCxRHiaDhUeuOFZ4YqIF0dzbStibRa7m3WN7ARZ1G4shDmf3lUFADMlMXZl8sAXYqNm0YhBDEOw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

所以我们就可以构造一个这样的 URL Scheme 来绕过域名校验打开一个任意的网页：

![image.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20221219/1671443709171258.png "1671443709171258.png")

该漏洞目前已于 iOS16.2 修复，不清楚可用最低版本，但是 iOS9 - iOS16.1.2 应该都是可用的。由于影响范围比较大，所以提供的 PoC 隐去了部分关键参数。

iTunes Store 打开网页使用的 SUWebView 通过  JavaScript bridge 注入了许多功能；SUWebView 将 SUScriptInterface 类的方法导出到 js 上下文中。这些 API 被放在全局作用域的 iTunes 命名空间里。

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/1YLJUhm0ZtmleLCxRHiaDhUeuOFZ4YqIFdwibdN0c0MxdJj534EungVJsAu2P8TibOsgBto3DYkoHNZmZBRT1nOpw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

另外在这个 WebView 中向任意域名发送请求，都会带上部分 iTunes Store cookie 信息:

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/1YLJUhm0ZtmleLCxRHiaDhUeuOFZ4YqIFddvracZHPtD1o2fMIHoKt6gboHIEu4qycmwgwuZ8I3X0qh6vzOA8hQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

例行弹计算器：

![图片](https://mmbiz.qpic.cn/mmbiz_gif/1YLJUhm0ZtmleLCxRHiaDhUeuOFZ4YqIFcGXOsAsBSfiaiaNxvpU03u3C8ljm2O2aVYo0ibSVTHQKNTKcDFuwsBV6w/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

如若转载，请注明原文地址

* 分享至

![取消](https://www.4hou.com/sihou/images/close.jpg)
![嘶吼](https://www.4hou.com/sihou/images/logo.png)

感谢您的支持，我会继续努力的!

![扫码支持]( "扫一扫")

打开微信扫一扫后点击右上角即可分享哟

![](https://www.4hou.com/captcha/flat?WhkUP0e5)

#### 你可能感兴趣的

* [![](https://img.4hou.com/images/微信图片_20221219175558.jpg)

  陌陌安全获Apple致谢：CVE-2022-42837 - iTunes Store 之殇](https://www.4hou.com/posts/zl3q)
* [![](https://img.4hou.com/images/SecureHashAltogirthm23_Released_960x600_v4_A.png)

  NIST弃用SHA-1，转用SHA-2和SHA-3](https://www.4hou.com/posts/nJ35)
* [![](https://img.4hou.com/images/1671417227497434.png)

  外媒：国际乒联服务器出问题，马龙樊振东等个人信息遭泄露](https://www.4hou.com/posts/r732)
* [![](https://img.4hou.com/images/15d17847575af4fad158b335efd1fee9.png)

  网络攻击发生后应立马采取的五个步骤](https://www.4hou.com/posts/YXwW)
* [![](https://img.4hou.com/images/242192f892fd0ce563064d62db453ebc.png)

  PRoot漏洞可劫持Linux设备](https://www.4hou.com/posts/l6w1)
* [![](https://img.4hou.com/images/1670286541136741.png)

  勒索软件攻击迫使法国医院转移病人](https://www.4hou.com/posts/2JZA)

![]()

文章来源: https://www.4hou.com/posts/zl3q
 如有侵权请联系:admin#unsafe.sh

© [unSafe.sh - 不安全](https://unsafe.sh) Powered By [PaperCache](https://github.com/code-scan/PaperCache)

* admin#unsafe.sh
* [安全马克](https://aq.mk)
* [星际黑客](https://xj.hk)
* [T00ls](https://t00ls.net)