---
title: 【技术干货】CVE-2021-3019 Lanproxy 目录遍历漏洞
url: https://mp.weixin.qq.com/s?__biz=Mzg5NjEyMjA5OQ==&mid=2247496274&idx=1&sn=5c6544a72b9eed690e3a73c2fb027c7c&chksm=c0075fcef770d6d8054d952a01dcff84dfa075b6ac36186f4bc7311cfb88357186f5de273068&scene=58&subscene=0#rd
source: 星阑科技
date: 2022-11-02
fetch_date: 2025-10-03T21:33:29.789631
---

# 【技术干货】CVE-2021-3019 Lanproxy 目录遍历漏洞

![cover_image](https://mmbiz.qpic.cn/mmbiz_jpg/Cc8QqLUKOejy8CicdsicvS9CrxiahYZqqzgoo56zovbRzdEFH9VUMviawzzfX5cqs34Qp54iaicQg866ojkkiczJTiaNUA/0?wx_fmt=jpeg)

# 【技术干货】CVE-2021-3019 Lanproxy 目录遍历漏洞

星阑科技

以下文章来源于星阑实验室
，作者PortalLab

![](http://wx.qlogo.cn/mmhead/Q3auHgzwzM7I2gqBRVgAVpkPNqBsibrgE0DM5mTmZIRYzgFUNPjF59g/0)

**星阑实验室**
.

聚焦API安全最新资讯，分享API安全研究成果

![](https://mmbiz.qpic.cn/mmbiz_gif/Cc8QqLUKOeiaFHTFtiatmEIxZQcXOHfyr6GOBM88IeMm28ybjSAHEJKicuQxPxN5L5NFZ5mza2NOnuokf9ant2fUQ/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NSkNgX8voWSJmuSUlcQtsLKWSxBUmsxRCOqbNibhhXFuhtfXiak5ibYGMcEGD9yzzIy4qVq1Q5a63IQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NSkNgX8voWSJmuSUlcQtsLgZE9TXJrsxHuabVS0UbocSyplzJJ0pxtQQZpAzIBdZwlByjZ3qUUAQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1 "好看的图.png")

**李安**

**@PortalLab实验室**

**漏洞描述**

Lanproxy 0.1 存在路径遍历漏洞，该漏洞允许目录遍历读取/../conf/config.properties来获取到内部网连接的凭据。

**Lanproxy**

lanproxy是一个将局域网个人电脑、服务器代理到公网的内网穿透工具，支持tcp流量转发，可支持任何tcp上层协议（访问内网网站、本地支付接口调试、ssh访问、远程桌面...）

**漏洞版本**

Lanproxy 0.1

## **修复前：**

![](https://mmbiz.qpic.cn/mmbiz_jpg/wfFYMXc5G1MoAsYvBMESs0VKFUPXLfJHCp022BTYCOtjsqAjty1KrOEoAq8zZH2GXWjxYH5SqWyzhOfOuLmWag/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

## **修复补丁：**https://github.com/ffay/lanproxy/commit/7787a143f9abf31ada4588e11741c92f0e145240

![](https://mmbiz.qpic.cn/mmbiz_jpg/wfFYMXc5G1MoAsYvBMESs0VKFUPXLfJHFoDTbiajDIDeFY7Wgs8o3WCyZf5ib8J64hrAG8UcGLMql7owYsZnpVnA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

**修复方式：**如果在路径中检测到`../` ，直接返回 Forbidden。

**漏洞成因：**对用户输入的路径、没有进行过滤、攻击者可以使用该漏洞去访问任意文件。

**环境搭建**

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MoAsYvBMESs0VKFUPXLfJHMxghbywvnj2Mlqtp5nmdCc8YgNMDPzhJGv44jBcgiaicep4RCYPJumww/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**漏洞复现**

**拉取源码**

git clone https://github.com/ffay/lanproxy.git

**回退到漏洞修复之前**

cd lanproxy/

git reset --hard f768adb1fca4dbcb83c16778d9f3407bb8b2f524

**maven编译项目**

mvn package

项目编译完成后、会在项目根目录下创建distribution目录、包含服务端、客户端。

![](https://mmbiz.qpic.cn/mmbiz_jpg/wfFYMXc5G1MoAsYvBMESs0VKFUPXLfJHeJar2agqvGR7ltMa0Raq1KUDPGAhy5YSkx7In5jE8MmWDy6dgpziaXA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

## **config.properties**

![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MoAsYvBMESs0VKFUPXLfJH72ysiarX35xdE8kHErOkz3mLqyjkDPWOdAJlaE3X6lxS7tft78lEevw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_jpg/wfFYMXc5G1MoAsYvBMESs0VKFUPXLfJHpeibAcpyTNCR5AcCV8YWZUxnibcMkmAvwHpMuibf8hH27SkMqM2pnnD9w/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

**漏洞测试**

1、运行启动命令：

sh distribution/proxy-server-0.1/bin/startup.sh

2、访问http://127.0.0.1:8090端口、出现如下界面、环境启动成功：

![](https://mmbiz.qpic.cn/mmbiz_jpg/wfFYMXc5G1MoAsYvBMESs0VKFUPXLfJHtzTSVwmKJxjZUiaB6UkJ3wakTIJIPx6cOfBHSKiaeDwNLR5ABIwRNKdQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

3、测试Payload：/%2F..%2F/conf/config.properties

![](https://mmbiz.qpic.cn/mmbiz_jpg/wfFYMXc5G1MoAsYvBMESs0VKFUPXLfJHpoPLqEmhDJjvB97n0aKjC2xTymVKF3YeX4PBS5LRRc7r5ickUpVRWIQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

在使用Payload后、获取到config.properties 配置文件。该文件中包含：管理页面用户名、密码、以及ssl相关配置。

**漏洞分析**

**开启debug模式**

Lanproxy 的启动脚本 distribution/proxy-server-0.1/bin/startup.sh 、 debug 参数可以开启调试模式。调试端口为8000。

![](https://mmbiz.qpic.cn/mmbiz_jpg/wfFYMXc5G1MoAsYvBMESs0VKFUPXLfJHZylOPmOqOLWnG1ZjpibcCt5AibsZwG2BwGvwEHG4wXocPehmFNjk8A9A/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

sh distribution/proxy-server-0.1/bin/startup.sh debug

**IDEA 配置**

![](https://mmbiz.qpic.cn/mmbiz_jpg/wfFYMXc5G1MoAsYvBMESs0VKFUPXLfJHkXC05m0LfkMVD3Hc52HQvcrLW8CvXDae7wfVQPWoC5ZUVCT9P0vzTg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

**动态调试**

将断点打到 src/main/java/org/fengfei/lanproxy/server/config/web/HttpRequestHandler.java#outputPages，先通过URI实例，获取到uriPath(请求路径)：/%2F..%2Fconf%2Fconfig.properties

![](https://mmbiz.qpic.cn/mmbiz_jpg/wfFYMXc5G1MoAsYvBMESs0VKFUPXLfJHXLaXwoVVgz94xDibYnzOf1bk3ribTtLrfNLArzRZYs9pwtrbPR3mZocA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

接下来，会判断该路径是否为/，是/返回 index.html，否则返回获取到的uriPath。

PAGE\_FOLDER 是获取当前程序所在的目录。

![](https://mmbiz.qpic.cn/mmbiz_jpg/wfFYMXc5G1MoAsYvBMESs0VKFUPXLfJH5G6PLKn8EfJegaGmWb33EAicPxia4S17icdyzxI4Kr1LkTaibf0THfkiaAQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

紧接着、会拼接PAGE\_FOLDER与uriPath。

![](https://mmbiz.qpic.cn/mmbiz_jpg/wfFYMXc5G1MoAsYvBMESs0VKFUPXLfJHcyBFStIkVtFEPibJ9thrTk4QQT27Ul4214icPaicEZWk2HGMStzicsk9vA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

然后、生成一个新的File实例，rfile，然后判读是否是目录、还会检查该文件是否存在。

![](https://mmbiz.qpic.cn/mmbiz_jpg/wfFYMXc5G1MoAsYvBMESs0VKFUPXLfJHmzEbg6yxvibch5uywYZsMswXgKKp31xrsFkiboxfDVt3F8ALDoJpPic9w/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

最后，使用 RandomAccessFile() 去读取文件。到这一步，已经可以读取到 config.properties 文件。

![](https://mmbiz.qpic.cn/mmbiz_jpg/wfFYMXc5G1MoAsYvBMESs0VKFUPXLfJHKBQfTXF4lnbdQUl6VEe5IlPge8zjoXg4zzibnGPxjibVcH343nUnWDtA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

**修复建议**

安装最新Lanproxy版本，可以通过源码或者最新的安装包进行更新。

**源码：**https://github.com/ffay/lanproxy

**安装包：**https://file.nioee.com/d/2e81550ebdbd416c933f/

**更多技术干货，欢迎关注“星阑实验室”公众号**

**关于Portal Lab**

星阑科技 Portal Lab 致力于前沿安全技术研究及能力工具化。主要研究方向为API 安全、应用安全、攻防对抗等领域。实验室成员研究成果曾发表于BlackHat、HITB、BlueHat、KCon、XCon等国内外知名安全会议，并多次发布开源安全工具。未来，Portal Lab将继续以开放创新的态度积极投入各类安全技术研究，持续为安全社区及企业级客户提供高质量技术输出。

**往期 · 推荐**

[![](https://mmbiz.qpic.cn/mmbiz_jpg/Cc8QqLUKOegoGL5ScibX9RqY6PqMAtnoZfER1hSGkj87C4oXR4PqW7CM8tiavmQur8O7WZQyZgVLn1wKwHsibcvEg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=Mzg5NjEyMjA5OQ==&mid=2247492888&idx=1&sn=219ad26c37836f5cdefc5f41dea620c0&chksm=c0074884f770c192f60f651f3e0c6a0f293b38a59d9499a89cd1b9c2e2d8cbc4dd4620783ed1&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/Cc8QqLUKOegoGL5ScibX9RqY6PqMAtnoZQtEDMUM2CZ3jqhq9cO3DtWcP2KgvjlDJia2Arlsw9IrGfWPEO7RYl3w/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=Mzg5NjEyMjA5OQ==&mid=2247492771&idx=1&sn=5bc86cbf62a83db69b1b1919ad86273b&chksm=c007493ff770c0290f199daef6b03bd09f9f85e35c5179c3ca8fe062623ecc27522b45850f0a&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/Cc8QqLUKOegoGL5ScibX9RqY6PqMAtnoZ1qIhLiasDXUrUT4RWJ7zFYmTMVWz1ww66AqdvxjF9ynLOR7139xQib7Q/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=Mzg5NjEyMjA5OQ==&mid=2247492691&idx=1&sn=7f4fdf863953280d024c2ae7144badff&chksm=c00749cff770c0d98d9848f5415e2c7b395add84d39e4ab51172549c024d36cfc80af23ad43e&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/Cc8QqLUKOegoGL5ScibX9RqY6PqMAtnoZRibR6e5iawhrSuV4TM3ib9AssGQNZ9SPQGCic3G3M9PgpLt5GafnkEiaPmw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=Mzg5NjEyMjA5OQ==&mid=2247492617&idx=1&sn=103b4a185c02f1435ddcc1778bd038e6&chksm=c0074995f770c08374efe7cda4e53a8991a867e2b1b73fe05f0f4a32335756a56c77483ee75f&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_gif/Cc8QqLUKOehwcHoxicoOah5mxDjLHMZ9RHUxNeibERphRXOj3AEupxt7JyOt3LF1RmmWQibYmicTv2DxM93iaEJhLxw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

预览时标签不可点

![]()

微信扫一扫
关注该公众号

继续滑动看下一个

轻触阅读原文

![](http://mmbiz.qpic.cn/mmbiz_png/Cc8QqLUKOegqicSqJoUd8bSLhdEYnZt3HwOB3tQXas2d1T2xlXc1K1hVMIl1qLxY6qwm5kFbJ6YURBkoXUtPoiaA/0?wx_fmt=png)

星阑科技

向上滑动看下一个

知道了

![]()
微信扫一扫
使用小程序

取消
允许

取消
允许

取消
允许

×
分析

![跳转二维码]()

![作者头像](http://mmbiz.qpic.cn/mmbiz_png/Cc8QqLUKOegqicSqJoUd8bSLhdEYnZt3HwOB3tQXas2d1T2xlXc1K1hVMIl1qLxY6qwm5kFbJ6YURBkoXUtPoiaA/0?wx_fmt=png)

微信扫一扫可打开此内容，
使用完整服务

：
，
，
，
，
，
，
，
，
，
，
，
，
。

视频
小程序
赞
，轻点两下取消赞
在看
，轻点两下取消在看
分享
留言
收藏
听过