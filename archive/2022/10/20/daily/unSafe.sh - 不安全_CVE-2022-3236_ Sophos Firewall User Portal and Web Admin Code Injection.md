---
title: CVE-2022-3236: Sophos Firewall User Portal and Web Admin Code Injection
url: https://buaq.net/go-131690.html
source: unSafe.sh - 不安全
date: 2022-10-20
fetch_date: 2025-10-03T20:21:02.112868
---

# CVE-2022-3236: Sophos Firewall User Portal and Web Admin Code Injection

* [unSafe.sh - 不安全](https://unsafe.sh)
* [我的收藏](/user/collects)
* [今日热榜](/?hot=true)
* [公众号文章](/?gzh=true)
* [导航](/nav/index)
* [Github CVE](/cve)
* [Github Tools](/tools)
* [编码/解码](/encode)
* [文件传输](/share/index)
* [Twitter Bot](https://twitter.com/buaqbot)
* [Telegram Bot](https://t.me/aqinfo)
* [Search](/search/search)

[Rss](/rss.xml)

[ ]
黑夜模式

![]()

CVE-2022-3236: Sophos Firewall User Portal and Web Admin Code Injection

In this excerpt of a Trend Micro Vulnerability Research
*2022-10-19 22:0:0
Author: [www.thezdi.com(查看原文)](/jump-131690.htm)
阅读量:88
收藏*

---

*In this excerpt of a Trend Micro Vulnerability Research Service vulnerability report, Guy Lederfein and Dusan Stevanovic of the Trend Micro Research Team detail a recently patched code injection vulnerability in the Sophos Firewall. The bug is due to improper validation of JSON keys submitted in the “JSON” parameter sent to the Controller endpoint. Successful exploitation of this vulnerability could result in remote code execution with the privileges of the root user. The following is a portion of their write-up covering CVE-2022-3236, with a few minimal modifications.*

Sophos recently [patched](https://www.sophos.com/en-us/security-advisories/sophos-sa-20220923-sfos-rce) a code injection vulnerability in Sophos Firewall v19.0 MR1 (19.0.1) and previous. This vulnerability is due to improper validation of JSON keys submitted in the “json” parameter sent to the Controller endpoint. A remote, unauthenticated attacker could exploit this vulnerability by sending a specially crafted request to an affected server. Successfully exploiting this vulnerability could result in remote code execution with the privileges of the root user.

**The Vulnerability**

Sophos Firewall is a network security solution, which can be deployed on purpose-built devices, on a cloud network (AWS/Azure), on a virtual device, or as a software appliance on x86 Intel hardware. The firewall application supports multiple network security features, including application-aware routing, TLS inspection, deep packet inspection, remote access VPN, logging, and reporting. Sophos Firewall exposes a web admin console for managing the device’s configuration via HTTPS on TCP port 4444. In addition, Sophos Firewall exposes a user portal for updating a user’s details or downloading authentication clients via HTTPS on TCP port 443.

HTTP is a request/response protocol described in RFCs 7230 - 7237 and other RFCs. A request is sent by a client to a server, which in turn sends a response back to the client. An HTTP request consists of a request line, various headers, an empty line, and an optional message body:

where CRLF represents the new line sequence Carriage Return (CR) followed by Line Feed (LF) and SP represents a space character. Parameters can be passed from the client to the server as name-value pairs in either the Request-URI or in the message-body, depending on the Method used and the Content-Type header. For example, a simple HTTP request passing a parameter named “param” with value “1”, using the GET method might look like this:

A corresponding HTTP request using the POST method might look like this:

JavaScript Object Notation (JSON) is a data-interchange format used for creating machine parseable, human-readable output. A JSON object has the following syntax:

• An object is enclosed in curly braces {}.

An example JSON object is as follows:

`{“name”:”bob”, “age”:30}`

The web admin and user portal web interfaces exposed by Sophos Firewall both run on a [Jetty](https://www.eclipse.org/jetty/) server behind an Apache httpd server. Configuration and diagnostic requests issued through these interfaces are submitted via requests to the *Controller* servlet. This servlet retrieves the appropriate *EventBean* object based on the *mode* HTTP request parameter. For example, if the *mode* HTTP request parameter is set to 151 or 451, the *WebAdminAuth* or *UserPortalAuth* classes are called to process the request, respectively. In each of these classes, the *generateAndSendAjaxEvent()* method of the *CSCClient* class is called. This method parses the *json* HTTP request parameter and modifies specific fields from the parsed object. The *send()* method is then called, which in turn calls *\_send()*, which adds the *mode* JSON parameter according to the mode of the associated *EventBean* object. It then sends the created JSON object as a string, including appropriate headers, to the local CSC server over TCP or UDP port 299.

When the CSC server receives the JSON object submitted by the Jetty server, it validates the JSON object submitted via the *validateJSON()* method in the Perl script *CyberAPIArch.pm*. If the JSON object contains a key named *\_discriminator*, the *getValidationHash()* method is called. This method iterates over each key of the *\_discriminator* Perl hash, representing field names. Each field name is associated with a JSON object describing the mapping between field values and object names. Some Perl objects resolved when parsing the JSON object received (*natrule*, *securitypolicy*, *hotspot*, etc.) contain a template with a *\_discriminator* key containing such a mapping for specific field names between field values and their associated objects. The method iterates over the field values to check whether the submitted JSON object contains a field with the referenced name and value. If so, it retrieves the associated object name and attempts to resolve it to an object using the *eval* [function](https://perldoc.perl.org/functions/eval).

A code injection vulnerability has been reported for Sophos Firewall. This vulnerability is due to improper validation of JSON keys submitted in the “json” parameter sent to the Controller endpoint. Specifically, the *\_discriminator* key can be set in the HTTP request. This JSON object is sent, after some modification, to the CSC server. However, the *\_discriminator* key set is sent unmodified. Once the *validateJSON()* method of the Perl script *CyberAPIArch.pm* is called, it will detect this key and call *getValidationHash()*. The Perl method iterates over the *$hashObj* hash object, which contains a key named *\_discriminator* whose value is a nested hash with a *value* key set with the value set for the *\_discriminator* key in the original request sent. This *value* key is treated as a nested hash containing field values mapped to object names. Therefore, if the originally submitted JSON object contains a key named *value* with its value set to one of the values in this nested hash, the associated object name will be resolved using the *eval* function. Since the *\_discriminator* key in the original request can be set to a JSON object with an arbitrary mapping between values and object names, a malicious object can be submitted to be concatenated into the *eval* function, resulting in code injection.

Sophos attempts to perform input validation on request parameters, including the JSON object, using the *RequestCheckFilter* Java object. This filter detects request parameters and JSON keys with non-ASCII printable characters. However, arbitrary request parameters and JSON keys containing ASCII printable characters can still be submitted, including the *\_discriminator* key.

A remote, unauthenticated attacker could exploit this vulnerability by sending a crafted request to the target server. Successfully exploiting this vulnerability could result in arbitrary Perl commands being run on the server, resulting in remote code execution with the privileges of the root user.

**Source Code Walkthrough**

The following code snippet was taken from Sophos Firewall version 19.0.1 with additional comments added by Trend Micro.

From the decompiled Java class *cyberoam.sessionmanagement.RequestCheckFilter*:

From the Perl script *CyberAPIArch.pm*:

**Detecting Attacks**

To detect an attack attempting to exploit this vulnerability, the detection device must monitor and parse traff...