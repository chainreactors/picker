---
title: 云原生后门扫描探索与实现
url: https://www.anquanke.com/post/id/287473
source: 安全客-有思想的安全新媒体
date: 2024-03-26
fetch_date: 2025-10-04T12:10:47.129584
---

# 云原生后门扫描探索与实现

首页

阅读

* [安全资讯](https://www.anquanke.com/news)
* [安全知识](https://www.anquanke.com/knowledge)
* [安全工具](https://www.anquanke.com/tool)

活动

社区

学院

安全导航

内容精选

* [专栏](/column/index.html)
* [精选专题](https://www.anquanke.com/subject-list)
* [安全KER季刊](https://www.anquanke.com/discovery)
* [360网络安全周报](https://www.anquanke.com/week-list)

# 云原生后门扫描探索与实现

阅读量**1017972**

|评论**1**

发布时间 : 2024-03-25 11:24:54

**x**

##### 译文声明

本文是翻译文章

译文仅供参考，具体内容表达以及含义原文为准。

# 云原生后门扫描探索与实现

在云原生高速发展的今天，针对云环境的攻击方法也层出不穷。本文讲述了vesta对云原生后门检测的理念和实践。

## DaemonSet

Daemonset因为其特点能够在所有node节点上部署一个pod，因此成为了最受欢迎的后门入口。对Pod设置后门也有如下的几种方法:

* Pod command和arg直接反弹shell
  此类型将反弹shell写入pod的command从而达到对每一个node进行持久化控制，具体内容可以参考CDK的backdoor内容，链接如下
  > <https://github.com/cdk-team/CDK/blob/3c6b0c1648b25b98067dd308eebcb2a3afb9e95e/pkg/exploit/k8s_backdoor_daemonset.go>

因此，改持久化方法对pod的command和arg的内容进行输入检查即可。

* 从其他资源引入反弹代码到Pod中运行
  此类型持久化中比较典型的外部资源一个是Secret，Secret拥有其天然特性Base64编码使得运维人员不能在第一时间看出端倪，但是又能够在Pod内部被ValueFrom调用的时候进行自动解码。亦或者从自制的恶意镜像上拉取进行持久化。
* Sidecar
  考虑到上述几个方案都有痕迹的产生，因此可以考虑k8s自带的kube-proxy，自带的privileged也是满足大多数的渗透要求。可以参考k0otkit脚本以及相关的文章，链接如下
  > <https://github.com/Metarget/k0otkit>

## 检测

在后门检测中，首先需要对各种权限和安全配置进行检测，因为持久性是后门攻击的本质，攻击者需要长期控制宿主机。因此，需要检测特权权限、必要的capabilities以及相关的挂载。其次，需要检测与 Pod 相关的附加命令，因为现在有许多反向代理的命令和各种绕过的 shell，每次都精确检测都是不现实的。因此，采用对特殊符号和关键字的检查，并将其与字符串总数相除得到一个比率值，然后与相应的阈值进行比较，最后生成报告。

后门相关检测有：

* Secret以及ConfigMap的内容以及解码，判断反代命令的同时也要判断是否是可执行文件
* DaemonSet相关镜像的识别
* Pod的权限以及相关配置检测，例如`Privileged`, `volumeMounts`, `command`, `args`, `RBAC`等

在完成上述检查的开发之后，又发现了另外一个问题。要对DaemonSet进行扫描必然扫描Kubernetes内部关键的namespaces，而这些namespaces又有相当一部分的DaemonSet以及DaemonSet启动的Pod会有特别高的权限，如果加上后期各种监控框架，那么检测出来的结果就会特别繁杂，导致运维人员每次会处理大量无关的安全事件，这是非常消耗时间的。

以一个简单的OpenShift架构以及11个node节点为例子，下列扫描出来的结果都是冗余的

![openshift daemonset]( "openshift daemonset")

并且正常的`kube-system`命名空间中的kube-proxy也会因为priveleged权限出现在运维人员眼中，出现次数一旦多就会导致对该pod关注度慢慢减少，以至于真正出现后门程序的时候会忽略该实例，导致错过最佳处置时间。

因此vesta对检测的Pod进行了剪枝。我们发现了如下几个参数

* age
* restarts
* certification

age分为node的age以及pod的age，而restarts则是容器重启的次数以及最近一次重启的时间，如图

![age,restarts]( "age,restarts")

通过age我们能够直接观察到最近一次修改的时间，通过讲DaemonSet对应的pod中最近修改时间与其他pod的时间进行对比。同时restarts的数值也能够帮助我们一个Pod的正常情况，例如如果一个restarts的次数相对于其他Pod的来说异常地高，可能的行为是反弹的shell所连接的IP并没有连通，导致Pod一直重启尝试连接目标IP，而相对于其他的Pod的平均次数过低的重启次数又能够判断该容器在最近被replace替换过。 如下图就是一个非常典型的被加入后门的场景

![backdoor]( "backdoor")

而node的age则能够帮助我们获取该node被启动的最早时间，kubernetes安装的证书也同样能够帮助我们拿到K8s最早启动的时间。因此通过目标pod修改时间与node启动最早时间以及其他Pod的修改时间做综合的对比来判断是否跳过该Pod的扫描。

实现的代码如下

* 后面的检测逻辑: <https://github.com/kvesta/vesta/commit/3443fe6e99e17cb40a63b94617a1828092bb4d64#diff-9d440e59ec5a1f856ab57efdf078acf0c0b35adaa036616afa957bec7c48e0b4>
* Pod的优化扫描逻辑: <https://github.com/kvesta/vesta/commit/efaec20c55a3f238516a8187448b91b58a5f822d#diff-e9451bda4fd61e18ef216377ead1083aea189c43f19c0f72c71f016b8f960576R644>

至此为vesta对DaemonSet的扫描逻辑以及实现，项目地址为

> <https://github.com/kvesta/vesta>

本文翻译自 原文链接。如若转载请注明出处。

商务合作，文章发布请联系 anquanke@360.cn

本文由**piteam**原创发布

转载，请参考[转载声明](https://www.anquanke.com/note/repost)，注明出处： [https://www.anquanke.com/post/id/287473](/post/id/287473)

安全KER - 有思想的安全新媒体

本文转载自:

如若转载,请注明出处：

安全KER - 有思想的安全新媒体

分享到：![微信](https://p0.ssl.qhimg.com/sdm/28_28_100/t01e29062a5dcd13c10.png)

* [Go](/tag/Go)
* [kubernetes](/tag/kubernetes)
* [vesta](/tag/vesta)
* [vulnerabilities-scanner](/tag/vulnerabilities-scanner)

**+1**21赞

收藏

![](https://p5.ssl.qhimg.com/t01078c156b729d6484.png)piteam

分享到：![微信](https://p0.ssl.qhimg.com/sdm/28_28_100/t01e29062a5dcd13c10.png)

## 发表评论

您还未登录，请先登录。

[登录](/login/index.html)

![](https://p2.ssl.qhimg.com/t014757b72460d855bf.png)

[![](https://p5.ssl.qhimg.com/t01078c156b729d6484.png)](/member.html?memberId=159402)

[piteam](/member.html?memberId=159402)

这个人太懒了，签名都懒得写一个

* 文章
* **2**

* 粉丝
* **0**

### TA的文章

* ##### [云原生后门扫描探索与实现](/post/id/287473)

  2024-03-25 11:24:54
* ##### [资产扫描利器——AlliN](/post/id/254023)

  2021-09-27 15:30:53

### 相关文章

* ##### [首次发现针对Kubernetes的Dero加密劫持操作](/post/id/287482)

  2023-03-16 11:00:08
* ##### [带你了解爆火的 GraphQL（附带 Go 示例）](/post/id/285397)

  2023-01-12 16:30:30
* ##### [Who Goes First? Detecting Go Concurrency Bugs via Message Reordering](/post/id/267296)

  2022-02-28 14:30:15
* ##### [无恒实验室联合GORM推出安全好用的ORM框架-GEN](/post/id/258298)

  2021-11-04 17:30:33
* ##### [gomarkdown/markdown 项目的 XSS 漏洞产生与分析](/post/id/250541)

  2021-08-23 15:30:08
* ##### [初探 Golang 代码混淆](/post/id/241594)

  2021-05-25 10:00:15
* ##### [继续Go！Go！Go！Sofacy组织已使用Go语言开发出新的Zebrocy变种](/post/id/168260)

  2018-12-21 11:15:53

### 热门推荐

文章目录

* [DaemonSet](#h2-0)
* [检测](#h2-1)

![](https://p0.qhimg.com/t11098f6bcd5614af4bf21ef9b5.png)

安全KER

* [关于我们](/about)
* [联系我们](/note/contact)
* [用户协议](/note/protocol)
* [隐私协议](/note/privacy)

商务合作

* [合作内容](/note/business)
* [联系方式](/note/contact)
* [友情链接](/link)

内容需知

* [投稿须知](https://www.anquanke.com/contribute/tips)
* [转载须知](/note/repost)
* 官网QQ群：568681302

合作单位

* [![安全KER](https://p0.ssl.qhimg.com/t01592a959354157bc0.png)](http://www.cert.org.cn/)
* [![安全KER](https://p0.ssl.qhimg.com/t014f76fcea94035e47.png)](http://www.cnnvd.org.cn/)

Copyright © 北京奇虎科技有限公司 三六零数字安全科技集团有限公司 安全KER All Rights Reserved [京ICP备08010314号-66](https://beian.miit.gov.cn/)[![](https://icon.cnzz.com/img/pic.gif)](https://www.cnzz.com/stat/website.php?web_id=1271278035 "站长统计")

微信二维码

**X**![安全KER](https://p0.ssl.qhimg.com/t0151209205b47f2270.jpg)