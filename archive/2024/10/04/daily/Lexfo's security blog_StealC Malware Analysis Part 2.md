---
title: StealC Malware Analysis Part 2
url: https://blog.lexfo.fr/StealC_malware_analysis_part2.html
source: Lexfo's security blog
date: 2024-10-04
fetch_date: 2025-10-06T18:50:43.615378
---

# StealC Malware Analysis Part 2

[BLOG POSTS](/index.html) [CATEGORIES](/categories.html) [ARCHIVES](/archives.html)

[CONTACT US](https://lexfo.fr/contact/)

StealC Malware Analysis Part 2

Tue 03 September 2024 by **Lexfo** in [Malware Analysis](category/malware-analysis.html)

# 04 - Loader analysis (Stage 2)

## Stage 2 information

In the [previous article](./StealC_malware_analysis_part1.html), we retrieved Stage2 (a PE) encrypted and embedded in Stage1.

A first phase of research can be interesting in order to retrieve some pieces of information. If you're working on a new sample, it's likely to be missing from IOC and sample sharing platforms such as VirusTotal, MalwareBazaar... At this point, you'll need to use sandboxes, as described in the [Reminders and preparation of the analysis environment](./StealC_malware_analysis_part1.html#02-reminders-and-preparation-of-the-analysis-environment) chapter.

Information on Stage 2 is given below:

| Type | Data |
| --- | --- |
| SHA256 | 9874c7bd9d008c8a7105c8e402813204d5c3ddc3fb8d1aaddbb0e19d65062dfb |
| SHA1 | 8cfd1de05578d750b296d13f6f8bc1d78d42a891 |
| MD5 | 999af7adf5fa30b3d748da1b2e84affd |
| File size | 427.50 KB (437760 bytes) |
| First seen | 2024-04-16 14:48:13 UTC (VirusTotal) |
| Magic | PE32 executable (GUI) Intel 80386, for MS Windows |
| imphash | cdfd758783fcb7e7c9a9010b0d1ea06a |
| ssdeep | 6144:XI+yLuPAYp/YKaUdAOmNGZxYSwkrVEi597BoVAw5:zyL2AYp/Hl8NMYSwkrVEiZoVR5 |

## Detonation in a sandbox

We will detonate the sample in a sandbox disconnected from the network to avoid leaving traces on the Internet and alerting the malicious actor. If you're on an incident response mission, or need to work on a sample requiring a high level of discretion, it's best not to submit the sample online.

To do this, you can install an open-source sandbox such as [Cape Sandbox](https://github.com/kevoreilly/CAPEv2). You can [follow the documentation](https://capev2.readthedocs.io/en/latest/) to set up the sandbox on a server supporting virtualization. If you can't afford to host a Cape-type solution, you can detonate the sample in your Windows virtual machine. We recommend setting up a system such as `Inetsim` to simulate a network environment and detect potential requests made by the sample.

Once the sandbox is set up on your side, you can detonate the sample (Stage 2) to gather more information about it.

When we run the sample in the sandbox, we can see that the *dummy* sample of `Inetsim` is executed. This lets us know that an executable has been downloaded from the network and run:

![](../images/stealc_analysis/guest_vm_sandbox_inetsim.png)

Guest VM sandbox with Inetsim

If you look at the logs of your `Inetsim` service, you should find more or less the same elements that Cape Sandbox can show you:

![](../images/stealc_analysis/cape_sandbox_loader_signatures.png)

Cape Sandbox signature - Loader (Stage 2)

Thanks to this detonation, we are able to understand that the sample is a loader and executes stage 3. We can draw up the following IOC list:

| Type | IOC |
| --- | --- |
| ipv4 | 185.172.128[.]90 |
| ipv4 | 185.172.128[.]228 |
| ipv4 | 185.172.128[.]59 |
| ipv4 | 185.172.128[.]228 |
| filename | BroomSetup.exe |
| filename | syncUpd.exe |
| url | hxxp://185[.]172.128.90/cpa/ping.php?substr=0&s=ab&sub=0 |
| url | hxxp://185[.]172.128.228/ping.php?substr=0 |
| url | hxxp://185[.]172.128.59/syncUpd.exe |
| url | hxxp://185[.]172.128.228/BroomSetup.exe |

## Sample recovery

To prevent the malicious infrastructure from shutting down its services, if your level of discretion allows it, you can download the supposedly malicious samples (`syncUpd.exe` and `BroomSetup.exe`). To do this, we recommend not using your exit IP directly, so as not to communicate with the malicious infrastructure. You can, for example, use the Tor network or a VPN provider, or even your own server hosted remotely and dedicated to this type of use.

Some malicious actors may block specific IP addresses, such as Tor exit nodes, User-Agent and so on. If you are faced with this type of problem, don't hesitate to reproduce a victim's execution environment as closely as possible. The location of an IP address can have an effect on C2's decision to respond to you. If the actor is targeting France, it's best to use a French IP.

From your sandbox, you can retrieve the User-Agent used by Stage 2 to carry out its request.

![](../images/stealc_analysis/cape_sandbox_http_request_loader_stage2.png)

Cape Sandbox - HTTP requests from Stage 2 (Loader)

In our case, the malicious actor doesn't seem to be filtering. We can use `curl` via Tor to download the sample (the URLs have been deliberately filtered by us to avoid misuse by a reader):

```
torify curl -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.6261.129 Safari/537.36" -O BroomSetup.exe.bin hxxp://185[.]172.128.228/BroomSetup.exe
torify curl -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.6261.129 Safari/537.36" -O syncUpd.exe.bin hxxp://185[.]172.128.59/syncUpd.exe
```

When you search for the cryptographic fingerprint of the two samples on VirusTotal, you'll find that `BroomSetup.exe` is a legitimate program, while `syncUpd.exe` is identified as malicious. If you run a Yara scan with the rule we wrote in the [Stage 1 chapter](./StealC_malware_analysis_part1.html), you'll find that `syncUpd.exe` is packed with the same packer as Stage 1! We'll look at how to unpack it in the next chapter.

It's highly likely that by the time you take this article, the executables will no longer be accessible from the malicious actor's C2. We can send them to you on request.

If the sandbox method is all you need to retrieve C2 from the malicious actor, you can proceed to the next chapter. In the next section, we'll use MIASM to retrieve HTTP requests directly.

## Retrieving loader requests with MIASM

Our Stage 2 (loader) appears to make HTTP requests to an IP address to transmit information, retrieve and then execute possibly malicious samples.

A sandbox can in some cases work if no antiVM system is in place in the sample. A sandbox may take some time to run and produce a report. If you need to scale up IOC extraction, you can automate the extraction process. As seen in the [previous article on Stage 1](./StealC_malware_analysis_part1.html), we'll look at how to retrieve these URLs with the MIASM framework.

Prepare your virtual environment, install MIASM, and let's start with [a new example script provided by MIASM](https://github.com/cea-sec/miasm/blob/master/example/jitter/sandbox_pe_x86_32.py). As you develop the script, you may find it useful to open the sample in a disassembler to understand why it is not executing as desired.

To start with, you can add the default options to introduce the environment required to run our sample:

```
options.usesegm = True
options.use_windows_structs = True
options.load_hdr = True
options.dependencies = True
```

Run the script and add the missing WinAPI methods as described in the previous article. For example:

```
[INFO    ]: kernel32_GetProcAddress(libbase=0x7111e000, fname=0x4293b4) ret addr: 0x40dae2
Traceback (most recent call last):
  File "/home/user/Dev/test_stealc/stage2_loader_miasm.py", line 21, in <module>
    sb.run()
  File "/home/user/Dev/test_stealc/venv/lib/python3.11/site-packages/miasm-0.1.5.dev47-py3.11-linux-x86_64.egg/miasm/analysis/sandbox.py", line 529, in run
    super(Sandbox_Win_x86_32, self).run(addr)
  File "/home/user/Dev/test_stealc/venv/lib/python3.11/site-packages/miasm-0.1.5.dev47-py3.11-linux-x86_64.egg/miasm/analysis/sandbox.py", line 136, in run
    self.jitter.continue_run()
  File "/home/user/Dev/test_stealc/venv/lib/python3.11/site-packages/miasm-0.1.5.dev47-py3.11-linux-x86_64.egg/miasm/jitter/jitload.py", line 430, in continue_run
    return next(self.run_iterator)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/user/Dev/test_stealc/venv/li...