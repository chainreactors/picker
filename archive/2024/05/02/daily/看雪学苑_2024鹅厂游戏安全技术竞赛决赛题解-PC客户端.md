---
title: 2024鹅厂游戏安全技术竞赛决赛题解-PC客户端
url: https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458553428&idx=1&sn=19827007d760d6a001d6883bac5c5a83&chksm=b18dbcde86fa35c87c8cf4a5940b9d361332aa42e416daa39b12962e1d7a0ecf7ef95c362b53&scene=58&subscene=0#rd
source: 看雪学苑
date: 2024-05-02
fetch_date: 2025-10-06T17:17:09.606914
---

# 2024鹅厂游戏安全技术竞赛决赛题解-PC客户端

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHX715ObTnCibl14T3icxXhUdiaRRSVO56fhe3hiasEUgafkaprQibia8LUqlA/0?wx_fmt=jpeg)

# 2024鹅厂游戏安全技术竞赛决赛题解-PC客户端

R0g

看雪学苑

```
一

Loader.sys分析
```

##

虚拟机系统环境：Windows 10 x64 1909 18363.418

调试环境：KDNET network kernel debugging*（https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-a-network-debugging-connection）*

老规矩查壳：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHHThykoT5mMtNvM7DevHzL7JUHq0pEPbic2gE7ibGFIj2mFUqLvAQ8VCg/640?wx_fmt=other&from=appmsg)

很好，什么也看不出来；直接拖IDA看看。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHXEgB2jAxabgLZuMjLpsj4DdpGBT7OTAgeRHnFLQ0EOjTgXicDLYTObw/640?wx_fmt=other&from=appmsg)

导入表有个ExAllocatePoolWithTag，尝试Hook了不过并没有什么卵用，跑起来只会拷贝一个“2024.wo.shi.chu.ti.ren”的字符串上去......直接看Disassembly。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqH4W89dZ8Uw4KPEo512NcCcR1kfo0uWdQdcTjkH2F4O8J9fPv45kKvBw/640?wx_fmt=other&from=appmsg)

一眼VMP，等分析完成后Shift+F12看字符串。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHeibaBPianlkdH6nLzBGsljg1tEsA0E0CmylEeqtPhWpxtysnMcMSwnEg/640?wx_fmt=other&from=appmsg)

“bad array new length”和“vector too long”明显来自stl库，应该是被std::string和std::vector的某个类成员函数所引用的。

```
struct std::string
{
    char *data;
    __int64 unknown;
    __int64 length;
    __int64 capacity;
};
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHK57iaU1Zhd88Qicwb6icvdWNl6tCIQbfOpqicdhsMAD6E4a0IILicoZzukA/640?wx_fmt=other&from=appmsg)

跑一下Lumina私服能出一些符号，其中std::string成员函数：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHG4g87aWJ1IvBqkAc2pknWcXkzvHlC2nY67Yic0ougCQvtic4YJ1uTQibA/640?wx_fmt=other&from=appmsg)

挨个xref找访问，std::string::~string和std::string::find\_last\_of能追到同一个地方。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHAT4DDicuQWKAthghylkpZTuVc5jRgLpSQchdTWqA3M9QicuzmxONt0Mg/640?wx_fmt=other&from=appmsg)

word\_140675E20数组逐字与0xACE进行了异或，拷贝出代码来跑一下：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHNZP3cETMcmTIibzicJJpl7aJOS3d7EeMaQGEwG28POjpTplPAJdh5zQg/640?wx_fmt=other&from=appmsg)

得到存放key的文件路径：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHfuKibMIMoHG4gh1nK8Bqk2qVb7wicFYTrrTwoicXPgCyGqIOp86pD0qVA/640?wx_fmt=other&from=appmsg)![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHHQibqayByLvSjGbrZdoPABRUcfJwlDG22ibVX0GicJCOBFxqibUxZ3E8Dg/640?wx_fmt=other&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHAKv5eOmrMpVYduicWKCphuZkzIiaNWh0axCbvy7jcR6LrwTTrVWF1Bhw/640?wx_fmt=png&from=appmsg)

联想到key的格式“ACE-4051574845”，可以知道此处正在进行字符串分割。

其次，sub\_140AFC7E2通过复制给chatgpt解析能大致得出其为字符串转整数的功能。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHOyfCftjan4I3xETGFR1Blwh6feErp6yUHTGyH5nNV3xsIPJby24keQ/640?wx_fmt=png&from=appmsg)

下断验证：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHVQyOaAyeJxyVEnu5HEB8nF5SE5L4uJicEJcY8qAWc2miarDEicgtscSYA/640?wx_fmt=png&from=appmsg)

还原大致逻辑，sub\_140009CBC是对用户名进行计算，得到一个输出值。算法如下：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHXFmAvkRmfq5SoJsZdTL79UicNlZgu4vEf8VUV1ic9PuETZsZBOancdUQ/640?wx_fmt=png&from=appmsg)

整体逻辑：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHqWk3vjMeYJuISMdNtXLuj0Wukh30aC4PXnWPJKsAg5Nic36ChSeNicuw/640?wx_fmt=png&from=appmsg)

用户名匹配时，函数返回1即true，失败返回false。

exp思路：修改用户名输出值与key的比较结果，使函数返回值恒为true即可。

具体方法：注册LoadImage回调，判断加载的映像是否为目标驱动，使判断函数尾部的xor al, al变成mov a1, 1。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHgE8rUfZFTBlqbglnoSh0gyHGsycHBNRJFHmKUXvRa3ntGQx8HcSrRw/640?wx_fmt=png&from=appmsg)

#

```
二

shellcode分析
```

成功加载Loader驱动后，System进程的CPU占有直接飙升至99%。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHaB1zGkf4lNcl7o2IibB6fiafoyWyLibia4Jiaicv6S7XdjfCVdD7eicWeFfpg/640?wx_fmt=png&from=appmsg)

说明Shellcode应当是启动了。而Loader想在内核跑shellcode必然要写到可执行内存并获得执行时机。可执行内存的获取方式一般为：

ExAllocatePool/ExAllocatePoolWithTag/MmAllocateIndenpendentPages/MmAllocateContiguousMemory....

执行时机：PsCreateSystemThread/WorkItem/APC/DPC/Timer/...

延续初赛的解题代码，直接用DetoursX挂钩PsCreateSystemThread、ExAllocatePoolWithTag

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqH80ibEwKXxAB0oGibkQE9oZNyL1S8TSuBh0gRVlnsylMtCllIqhAaYgicA/640?wx_fmt=png&from=appmsg)

BSOD，看调用栈是PsCreateSystemThread后的双重错误。而ExAllocatePoolWithTag直接执行到了挂钩后面的int3上去了。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHd7WnQfn2dhbLJZbweVwufGiaTKDBnZc4sq0SYJZZIRQAW3yQsEHmribg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHI0x5N8zSfpCJgIbs9IKEezZqdfKYtBuZcXa7Wjy4XXxx3GCB7ZWia9A/640?wx_fmt=png&from=appmsg)

应该是程序自己构造函数序言部分，执行完成自行构造的序言部分后jmp到后面的代码验证构造call：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHATxibqURbtxj7fevAQiaaJtK1AtghsU04Abtkten6Yvsib6fckXBlZf6g/640?wx_fmt=png&from=appmsg)

直接去挂钩更底层的PsCreateSystemThreadEx和ExAllocateHeapPool一劳永逸，可以成功让目标驱动走我们的钩子。

不过看到跳板push ret有种莫名熟悉的感觉（XXX-BASE），尝试在物理机用CE附加虚拟机进程即vmware-vmx.exe，搜索跳板特征。

```
ffff8003`b49f5456 48895c2418      mov     qword ptr [rsp+18h],rbx
ffff8003`b49f545b 6825c5017f      push    7F01C525h
ffff8003`b49f5460 c744240402f8ffff mov     dword ptr [rsp+4],0FFFFF802h
ffff8003`b49f5468 c3              ret
0: kd> db ffff8003`b49f545b
ffff8003`b49f545b  68 25 c5 01 7f c7 44 24-04 02 f8 ff ff c3 31 04
```

68 ?? ?? ?? ?? C7 44 24 04 ?? ?? ?? ?? C3

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqH1OPcN2ibAHotoDM3FNnz96aicNVeXXt9qYOpT8ly2hWibvKMGgt0OCQsg/640?wx_fmt=png&from=appmsg)

94个结果，估计跳板格式是定死的。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHNIr7T2NrVMvQ9DWF2OJq8dRLGGUIWkq9PBLTaRbGxbSd4RQdQEGf4Q/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHyvaRqXO48twsCkMQz13zR3vBNxoibkCkmNibuG8VUyQY6lJZfklc2PUQ/640?wx_fmt=png&from=appmsg)

编写CE lua脚本dump出所有的跳转函数，测试对跳板写入0xCC，windbg中可以接管到断点。

之后把dump出的函数列表去重后依次在windbg里面看符号地址，这样就能得出shellcode的所有导入函数了；依次下断分析，可以知道那些函数是正在被调用的。写个下断脚本一键下断。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHtRrb1v6BBZkVByZ6Wn2l9o7ySqd72yIHdAejFyibw27jvcCAkkPaIUQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHdxpd1zL2LUJCbgtuw1HRRsuJ969oYzvX0qvD4V3QSAGvISCxGL0rKg/640?wx_fmt=png&from=appmsg)

最终得出正常运行时调用的系统函数大致如下：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHGHiaTgmYrlzjmYFa9fP2DJDbZzRwr3fm1sRdKgxYMjLuCCo9UItK4ibw/640?wx_fmt=png&from=appmsg)

程序会死循环遍历进程ID，并调用PsLookupProcessByProcessId获取进程对象。

```
for(auto pid=0x10ull; pid < 0x40000; pid+=4)
    PsLookupProcessByProcessId(pid, &Process);
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHQHkCB957GW4dKKZWfQ3zkBePibg83miattQqlhUY4HUKUrGIicyn2roRg/640?wx_fmt=png&from=appmsg)

Hook更底层的PspReferenceCidTableEnty可以得出最大PID为0x40000找到shellcode调用地址，按4K对齐的方式找到一个大致的shellcode头。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHI0x5N8zSfpCJgIbs9IKEezZqdfKYtBuZcXa7Wjy4XXxx3GCB7ZWia9A/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHsUYsQ93tlh5jM0P9ntIE4XOE3XyMKyFhSNcJCcUcTZ6Vd4Y0cRhSsA/640?wx_fmt=png&from=appmsg)

之后dump shellcode到文件，拖到IDA一条龙服务。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHHOWpO5dzEugzwudV2MYTMgvmBhIhp3us8Dc6V8nRDAaLAwIDvuL4WQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHAaFzXP8nmttnmcuawJAUS6X6VujNUNRVHmbnQ6W1a2d5jCNm3603yA/640?wx_fmt=png&from=appmsg)

编写一个简单的脚本去除shellcode中两处影响分析的控制流混淆指令，去掉混淆后只剩一个jmp指令，虽然还有很多混淆，但是基本不影响IDA创建函数分析控制流了。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Ey0Z2fLQtGQHrnic5NDLhqHmrddXavXKxia5nm6vmeLVkK8ibzvicic4xLLVZ9MBV1dmQ7nmv1DMp07iaA...