---
title: 【技术分享】针对电子邮件发件人欺骗攻击的大规模分析
url: https://mp.weixin.qq.com/s?__biz=MzA5ODA0NDE2MA==&mid=2649780434&idx=2&sn=0a53da4576e48d1ad32fe6e633cc6779&chksm=889340bdbfe4c9abc2a26bf2769c325e7781a53cfc5103a507759d0c7b066638e37d6c803dc6&scene=58&subscene=0#rd
source: 安全客
date: 2022-11-29
fetch_date: 2025-10-04T00:00:03.229608
---

# 【技术分享】针对电子邮件发件人欺骗攻击的大规模分析

![cover_image](https://mmbiz.qpic.cn/mmbiz_jpg/Ok4fxxCpBb4EpXibZf2JC66rmB47FxyZLRxJZUpMAe2ByQpYDACCO37LJZEcyQzYXTkRR6YHW5ybK8bJ3YuZPOA/0?wx_fmt=jpeg)

# 【技术分享】针对电子邮件发件人欺骗攻击的大规模分析

原创

CDra90n

安全客

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb4EpXibZf2JC66rmB47FxyZLz0RZeXUltbMzAmg28ImbHdUWAibAH21LH8L99VX1knQxGZJo9VW5ynA/640?wx_fmt=png)

作为一种基本的通信服务，电子邮件在个人和公司通信中都扮演着重要角色，这也使其成为最常见的攻击媒介之一。多个协议、角色和服务的身份验证链确保了电子邮件的真实性，任何失效的部分都可能破坏整个基于链的防御。本文系统地分析了电子邮件的传输，并确定了一系列能够绕过SPF，DKIM，DMARC和用户界面保护的新攻击。特别是通过进行cocktail组合攻击，可以伪造更真实的虚假电子邮件来渗透电子邮件服务，例如Gmail和Outlook。本文对30种流行的电子邮件服务和23个电子邮件客户端进行了大规模验证，发现它们都容易受到某些类型的攻击。已将发现的漏洞功能及时报告给相关的电子邮件服务提供商，并从包括Gmail，Yahoo，iCloud和Alibaba在内的11家公司收到了肯定的答复。

**Introduction**

电子邮件服务是当下必不可少的通信服务，这使其成为网络攻击的主要目标。但是，电子邮件传输协议远不能抵抗潜在的攻击。电子邮件系统的安全性依赖于由各种电子邮件服务维护的多方信任链，这增加了其对网络攻击的系统脆弱性。如下图所示，电子邮件传输过程中的身份验证涉及四个重要阶段。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb4EpXibZf2JC66rmB47FxyZLD4NZqQ0ucDEDX6d0PNrofHa6icDcu9PibhJZlBPrqbYRwCfIBYibWLZibg/640?wx_fmt=png)

正如木桶理论所揭示的，桶的容量取决于其最短的板，电子邮件的真实性取决于身份验证链中最薄弱的环节。首先，尽管存在各种用于识别欺骗电子邮件的安全扩展协议（例如SPF，DKIM和DMARC），但由于受不同协议保护的实体不一致，欺骗攻击仍可能成功。其次，电子邮件的身份验证涉及四个不同的角色：发件人，收件人，转发者和UI渲染器。每个角色应承担不同的安全职责。如果角色都无法提供适当的安全防御解决方案，则无法保证电子邮件的真实性。最后，安全机制是由具有不一致处理策略的不同电子邮件服务实现的。这些安全机制是由不同的开发人员实现，其中一些在处理带有模糊header的电子邮件时会偏离RFC规范。因此，不同的服务之间存在许多不一致之处。攻击者可以利用这些不一致来绕过安全机制，并向电子邮件浏览器端和电子邮件客户端呈现虚假结果。

这项工作系统地分析了电子邮件传递过程中身份验证的四个关键阶段：发送身份验证，接收验证，转发验证和UI呈现。发现14种电子邮件欺骗攻击能够绕过SPF，DKIM，DMARC和用户界面保护。通过组合不同的攻击，欺骗电子邮件可以完全通过所有当前流行的电子邮件安全协议，并且收件人的MUA上不会显示任何安全警告。

为了了解欺骗电子邮件攻击对电子邮件生态系统的实际影响，对30种流行的电子邮件服务进行了大规模实验，这些服务的用户总数达数十亿。此外还在不同的操作系统上测试了23个流行的电子邮件客户端，以衡量攻击对UI级别的影响。它们都容易受到某些类型的攻击，包括信誉良好的电子邮件服务，例如Gmail和Outlook。已经向涉及的电子邮件服务提供商妥善报告了所有已发现的问题，并从其中的11家（例如Gmail，Yahoo，iCloud，Alibaba Cloud）获得了积极的回应。

**Attack Model and Experiments**

### **A.攻击模型**

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb4EpXibZf2JC66rmB47FxyZL13vfT2TrPslcTaBhDvdWPIiaWNIKDeyVLGEwic5kibDib22u8OwgM7JpNg/640?wx_fmt=png)

如上图所示，电子邮件欺骗攻击的攻击模型包括一个受信任的电子邮件发送者（Alice，在a.com下拥有电子邮件帐户），一个受害者接收者（Bob，在b.com下拥有一个电子邮件帐户）和一个攻击者（Oscar）。Oscar的目标是向Bob发送电子邮件，伪装成Alice@ a.com并绕过所有安全验证。通常，电子邮件欺骗攻击有以下三种常见类型。

共享MTA攻击（Shared MTA Attack）：假设Oscar拥有一个电子邮件帐户（Oscar@ a.com），该帐户不同于Alice的帐户（Alice@ a.com）。Oscar可以通过修改Mail From / From / Auth username header，通过a.com的MTA发送欺骗性电子邮件。由于发件人的MTA IP信誉是影响垃圾邮件引擎决策算法的重要因素，因此欺骗电子邮件可以轻松进入受害者的收件箱。发件人的MTA的IP在a.com的SPF范围内。发件人的MTA可能还会自动将DKIM签名附加到欺骗电子邮件中。Oscar绕过SPF / DKIM / DMARC验证并欺骗Alice@ a.com几乎没有困难。

直接MTA攻击（Direct MTA Attack）：Oscar还可以通过自己的电子邮件服务器发送欺骗性电子邮件。请注意，发送者的MTA与接收者的MTA之间的通信过程没有身份验证机制。Oscar可以通过指定Mail From和From header来欺骗任意发件人。这种攻击模型可以确保所有欺骗性电子邮件都到达收件人的MTA，而不会受到发件人MTA严格发送检查（strict sending check）的影响。

转发MTA攻击（Forward MTA Attack）：Oscar可以通过滥用电子邮件转发服务来发送欺骗性电子邮件。首先，Oscar将欺骗性电子邮件发送到Oscar@ a.com，这是转发电子邮件服务上属于Oscar的电子邮件帐户。接下来，他可以配置转发服务以自动将此欺骗邮件转发给受害者（Bob@ b.com）。此攻击模型具有三个主要优点。首先，此攻击与共享MTA攻击模式具有相同的优势，因为收件人的MTA（b.com）认为电子邮件来自合法的MTA（a.com）。此外，此攻击还可以绕过发件人MTA的严格发送检查（例如，Mail From和From header之间不匹配）。最后，转发服务可以为转发的电子邮件提供更高的安全性认可（例如，添加不应添加的DKIM签名）。

因此，发件人身份验证问题可以分为四个阶段，包括发送身份验证，接收验证，转发验证和UI呈现，这些阶段可以缓解潜在的安全威胁。此外，将成功攻击的目标定义如下：（1）接收者的MUA错误地呈现了发件人地址，因为它来自合法域名，而不是攻击者的真实域名；（2）收件人的MTA错误地验证了欺骗电子邮件的发件人；（3）收件人的MUA不显示任何用于欺骗电子邮件的安全警报。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb4EpXibZf2JC66rmB47FxyZL8Gvribb1KrOr0oPyqEzBOPdDTajibvxqBvibrJhsYkaC7uXMkicZ3HOC0Q/640?wx_fmt=png)

上图显示了使用直接MTA攻击和转发MT攻击模型成功进行电子邮件发件人欺骗攻击的示例。。所有这三种电子邮件安全协议都会为欺骗性电子邮件提供“pass”验证结果。此外，接收方的MUA不显示任何安全警报。受害人几乎无法识别来自这种看似真实的欺骗电子邮件的任何攻击痕迹。因此，即使对于具有技术背景的人来说，要弄清这种电子邮件是否是欺骗也是具有挑战性的。

### **B.目标选择**

本研究系统地分析了30种电子邮件服务，包括最受欢迎的免费公共电子邮件服务，企业级电子邮件服务和托管的电子邮件服务。总共选择22种流行的电子邮件服务，它们的用户超过10亿，他们的安全问题可能会使广泛的普通用户受到威胁。此外还选择了Office 365，Alibaba Cloud和Coremail等5种流行的企业电子邮件服务，以测试对机构用户的威胁影响。对于托管电子邮件系统，构建\部署和维护3个著名的电子邮件系统（即Zimbra，EwoMail，Roundcube）。此外，测试了针对不同桌面和移动操作系统中23个广泛使用的电子邮件客户端的攻击，以评估对UI呈现的影响。

### **C.方法**

这项工作旨在涵盖整个电子邮件传递过程中所有可能的验证问题。因此进行了五个步骤的安全性分析：首先系统地分析电子邮件规范。在语法方面提取ABNF规则，重点关注与身份验证相关的header（例如Mail From / From / Helo / Sender）。在语义方面，关注是RFC中每个阶段的电子邮件身份验证。其次，收集合法的电子邮件样本，并根据ABNF语法生成带有认证相关header的测试样本。由于普通邮件服务通常拒绝处理具有高度变形header的电子邮件，因此将指定某些header的值。例如，将domain的值限制为几个著名的电子邮件域名（例如，gmail.com，icloud.com）。第三，在协议模糊化中引入了常见的变异方法，例如header重复，插入空格，插入Unicode字符，header编码和大小写变化。第四，使用生成的样本在四个阶段中测试目标电子邮件系统的安全验证逻辑。最后分析并总结了使电子邮件发件人欺骗在实践中成功的对抗技术。

### **D.实验设置**

成功的攻击：如果满足以下四个条件之一，则认为电子邮件欺骗攻击成功。

（1）在电子邮件发送验证阶段，攻击者可以任意修改标识符（例如，Auth username/ MAIL From/ From）。

（2）在电子邮件接收验证阶段，即使被欺骗域名已经部署了严格的SPF / DKIM / DMARC策略，收件人的MTA也会给出“none/pass”验证结果。由于验证结果并不总是显示在电子邮件header中，因此可以通过检查电子邮件是否已进入收件箱作为替代来推断结果。此外，如果欺骗性电子邮件被放入垃圾邮件箱，则认为攻击失败，这意味着收件人的MTA已检测到欺骗性并采取了防御措施。为避免意外情况，将每个攻击重复三遍，以确保欺骗电子邮件实际上已渗透到安全协议中。只有所有三遍都起作用的攻击才被视为成功攻击。

（3）在电子邮件转发阶段，转发者对转发的电子邮件给予更高的安全性认可。此外，如果攻击者无需任何身份验证就可以将转发的电子邮件自由配置到任何帐户，则攻击也被认为是成功的。

（4）在电子邮件UI呈现阶段，显示的电子邮件地址与真实电子邮件地址不一致。在此阶段，由于仅需要检查，因此使用IMAP协议的APPEND功能将欺骗的电子邮件发送到收件箱，因为只需要检查UI呈现结果，而不是绕过垃圾邮件引擎。最后，收集信息并根据UI级别上的电子邮件浏览器端和电子邮件客户端分析结果。

测量偏差最小化：首先，为了排除垃圾邮件检测的影响，选择了某个行业合作伙伴（一家著名的电子邮件提供商）提供的合法、良性和不敏感的电子邮件样本作为欺骗电子邮件的内容。这些电子邮件的内容是合法且无害的，不能被视为垃圾邮件。其次，所有欺骗电子邮件都是从位于不同区域的15个IP地址发送的，间隔为10分钟。此外为攻击者的域名和IP地址部署MX / TXT / PTR记录。第三，为了测试收件人的MTA如何处理带有“fail” SPF / DMARC验证结果的电子邮件，针对目标30个电子邮件服务进行了欺骗实验，发现其中有23个拒绝带有“fail”的SPF / DMARC验证结果的电子邮件。其余的将它们标记为垃圾邮件。

### **E.实验结果**

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb4EpXibZf2JC66rmB47FxyZLyv5K7YvOiatNfv6trLXibZ2WaicJFH8y6jPO6mNxWcyFcrq3fnE0Nq2ibw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb4EpXibZf2JC66rmB47FxyZLRO0X80lgRjQWRc2ZSSbhBezpn8WYISvbP3LmM3eft7qq449GfPkBmQ/640?wx_fmt=png)

发送方欺骗攻击的实验结果如上表，总结了以下实验结果。首先，测量了这些电子邮件服务对电子邮件安全协议的部署和验证。所有电子邮件服务都在发件人一方部署SPF协议，而只有23个服务部署全部三种协议。出乎意料的是，所有电子邮件服务都在接收方运行SPF，DKIM和DMARC检测。但是，只有12个服务执行发件人不一致检查。其次，所有目标电子邮件服务和电子邮件客户端都容易受到某些类型的攻击。最后，组合攻击使攻击者能够伪造看上去更真实的欺骗电子邮件。具体攻击方法（A1-A14）在下文中介绍。

**Email Sender Spoofifing Attacks**

将攻击分为四类，分别对应于电子邮件传递过程中的四个身份验证阶段。

### **A.邮件发送认证中的攻击**

电子邮件发送验证是确保电子邮件真实性的必要步骤。电子邮件发送身份验证中的攻击可能会滥用知名电子邮件服务的IP信誉。他们甚至可以绕过SPF / DKIM / DMARC协议的所有验证，这对电子邮件安全生态系统构成了重大威胁。这些攻击主要用于共享攻击模型（Model a）。

电子邮件发送过程中有三个发件人标识符：(1) Auth username; (2) Mail From; (3) From。攻击被认为是成功的，当它可以在电子邮件发送认证过程中任意控制这些标识符。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb4EpXibZf2JC66rmB47FxyZLic5v2y8kBd6QWspXyibicDnlqm3K8OoRPdJUUaibxiak0iaXsJUiaZDKyIRWA/640?wx_fmt=png)

Auth username和MailFrom header之间不一致（A1）：如上图a所示，攻击者可以假装是当前域名下的任何用户，以发送在电子邮件发送身份验证期间Auth username（Oscar@ a.com）和Mail From（Alice@ a.com）不一致的欺骗电子邮件。SMTP协议不提供任何内置的安全功能来保证auth username和Mail From header的一致性。因此，这种类型的保护仅取决于电子邮件开发人员的软件实现。

在欺骗实验中，大多数电子邮件服务都没有发现此类问题，并禁止用户发送与其原始身份不一致的电子邮件。但是，这种类型的问题仍然出现在某些著名的公司电子邮件软件（即Zimbra，EwoMail）中。在默认安全配置下，这两个电子邮件服务容易受到攻击。电子邮件管理员需要升级其安全配置，以手动防止此类问题。

MailFrom与From之间的不一致（A2）:攻击者可以发送带有不同Mail From和From header的欺骗电子邮件。上图b显示了这种类型的攻击。尽管允许某些用户使用电子邮件别名来发送带有不同的From header的电子邮件，但不应允许任何用户将From header随意修改为任何值（例如admin@ a.com）以防止受到攻击。仅应在有限的合法值内设置From header。许多流行的电子邮件服务（例如Outlook，Sina，QQ邮件）和大多数第三方电子邮件客户端（例如Foxmail，Apple Mail）仅显示From header，而不显示Mail From header。对于具有不同Mail From和From header的邮件，受害者甚至无法在MUA上看到任何安全警报。

RCPT To和To header之间也存在类似的不一致。在现实世界中，有些场景会导致不一致，例如电子邮件转发和密件抄送。但是，这种灵活性增加了攻击面并引入了新的安全风险。例如，即使电子邮件的From header不是受害者的地址，攻击者也可以将电子邮件发送给受害者。在这种情况下，攻击者可以进一步使用此方法来获取通常无法获得的带有DKIM签名的欺骗电子邮件，这对于进一步的攻击很有帮助。单独使用时，此技术可能无效，但与其他攻击技术结合使用时，通常可以达到出色的欺骗效果。

在实验中，有14种电子邮件服务容易受到此类攻击。此外，还发现某些电子邮件服务（例如Outlook，Zoho，AOL，Yahoo）已经意识到了这些风险，并实施了相应的安全限制。他们拒绝在SMTP发送过程中发送带有不一致的MailFrom和From header的电子邮件。但是，仍然可以通过两种类型的攻击（即A4，A5）来绕过这些防御措施。例如，可以在Yahoo中发送带有From header为< Oscar@ a.com>和 From header为< Alice@ a.com，Oscar@ a.com>的欺骗电子邮件，这引入了另一种歧义源，并最终绕过了电子邮件协议验证。因此，即使发件人已经部署了相关的安全措施，仍然可能发送这种欺骗性电子邮件。

### **B.电子邮件接收验证中的攻击**

SPF，DKIM和DMARC是用于抵抗电子邮件欺骗攻击的流行机制。如果攻击者可以绕过这些协议，则也可能对电子邮件安全生态系统构成严重的安全威胁。可以使用三种攻击模型来发起这种类型的攻击：共享MTA攻击，直接MTA攻击和转发MTA攻击。当接收方的MTA错误地获得“none/pass”验证结果时，攻击成功。

空Mail From攻击（A3）：RFC 5321明确描述了允许一个空的Mail From，主要用于防止回弹回送并允许某些特殊消息。但是，也可以滥用此功能来发起电子邮件欺骗攻击。如下图所示，攻击者可以发送带有空的Mail From header的电子邮件，而From header构成了Alice的身份（Alice@ a.com）。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb4EpXibZf2JC66rmB47FxyZL2Wxv8GBOZtNicEm1ddWsNUDXEVmmjE4Kiakhl8iaWpTtZLt0AnGrfmiaPg/640?wx_fmt=png)

SPF协议规定，如果Mail From header为空，则接收者的MTA必须根据Helo字段完成SPF验证。但是，现实生活中滥用Helo字段使某些电子邮件服...