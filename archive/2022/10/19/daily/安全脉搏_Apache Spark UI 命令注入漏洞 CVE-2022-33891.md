---
title: Apache Spark UI 命令注入漏洞 CVE-2022-33891
url: https://www.secpulse.com/archives/189331.html
source: 安全脉搏
date: 2022-10-19
fetch_date: 2025-10-03T20:13:03.048062
---

# Apache Spark UI 命令注入漏洞 CVE-2022-33891

[![](https://www.secpulse.com/wp-content/themes/secpulse2017/img/logo-header.png)](https://www.secpulse.com "安全脉搏")

* [首页](https://www.secpulse.com/)
* [分类阅读](https://www.secpulse.com/archives/category/category)

  #### 脉搏文库

  - [内网渗透](https://www.secpulse.com/archives/category/articles/intranet-penetration)
  - |
  - [代码审计](https://www.secpulse.com/archives/category/articles/code-audit)
  - |
  - [安全文献](https://www.secpulse.com/archives/category/articles/sec-doc)
  - |
  - [Web安全](https://www.secpulse.com/archives/category/articles/web)
  - |
  - [移动安全](https://www.secpulse.com/archives/category/articles/mobile-security)
  - |
  - [系统安全](https://www.secpulse.com/archives/category/articles/system)
  - |
  - [工控安全](https://www.secpulse.com/archives/category/articles/industrial-safety)
  - |
  - [CTF](https://www.secpulse.com/archives/category/exclusive/ctf-writeup)
  - |
  - [IOT安全](https://www.secpulse.com/archives/category/iot-security)
  - |

#### 安全建设

+ [业务安全](https://www.secpulse.com/archives/category/construction/businesssecurity)
+ |
+ [安全管理](https://www.secpulse.com/archives/category/construction/securityissue)
+ |
+ [数据分析](https://www.secpulse.com/archives/category/construction/bigdata)
+ |

#### 其他

+ [资讯](https://www.secpulse.com/archives/category/news)
+ |
+ [漏洞](https://www.secpulse.com/archives/category/vul)
+ |
+ [工具](https://www.secpulse.com/archives/category/tools)
+ |
+ [人物志](https://www.secpulse.com/archives/category/people)
+ |
+ [区块链安全](https://www.secpulse.com/archives/category/exclusive/block_chain_security)
+ |
+ [安全招聘](https://www.secpulse.com/archives/category/hiring)
+ |

- [安全问答](https://www.secpulse.com/newpage/question_list)
- [金币商城](https://www.secpulse.com/shop?donotcachepage=c010349fd98847cb9d6e07d3cbc19288)
- [安全招聘](https://www.secpulse.com/archives/category/hiring)
- [活动日程](https://www.secpulse.com/newpage/activity)
- [live课程](https://www.secpulse.com/live)
- [企业服务](https://duoyinsu.com/service.html)
- [插件社区](https://x.secpulse.com/)

小程序

![脉搏小程序](https://www.secpulse.com/wp-content/themes/secpulse2017/img/wxchat.jpg)
[登录](https://www.secpulse.com/user_login)
|
[注册](https://www.secpulse.com/user-register)

# Apache Spark UI 命令注入漏洞 CVE-2022-33891

[漏洞](https://www.secpulse.com/archives/category/vul)

[蚁景网安实验室](https://www.secpulse.com/newpage/author?author_id=37244)
![]( https://www.secpulse.com/wp-content/themes/secpulse2017/img/renzheng2.png)

2022-10-18

10,796

https://www.cnsuc.net/thread-522.htm

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-189331-1666085044.png)

## 漏洞简介

> The Apache Spark UI offers the possibility to enable ACLs via the
> configuration option spark.acls.enable. With an authentication filter, this
> checks whether a user has access permissions to view or modify the
> application. If ACLs are enabled, a code path in HttpSecurityFilter can
> allow someone to perform impersonation by providing an arbitrary user name.
> A malicious user might then be able to reach a permission check function
> that will ultimately build a Unix shell command based on their input, and
> execute it. This will result in arbitrary shell command execution as the
> user Spark is currently running as. This affects Apache Spark versions
> 3.0.3 and earlier, versions 3.1.1 to 3.1.2, and versions 3.2.0 to 3.2.1.

　　‍

> Apache Spark UI 提供了通过配置选项 spark.acls.enable。使用身份验证过滤器，这检查用户是否有访问权限来查看或修改应用。如果启用了 ACL，则 HttpSecurityFilter 中的代码路径可以允许某人通过提供任意用户名来执行模拟。然后恶意用户可能能够访问权限检查功能，最终将根据他们的输入构建一个 Unix shell 命令，并且执行它。这将导致任意 shell 命令执行。

> 影响版本：Apache Spark 版本 3.0.3 及更早版本，版本 3.11 至 3.1.2 ，以及版本 3.2.0 至 3.2.1

## 漏洞复现

　　下载 Apache Spark 3.2.1 https://archive.apache.org/dist/spark/

　　https://archive.apache.org/dist/spark/spark-3.2.1/spark-3.2.1-bin-hadoop2.7.tgz

　　根据描述是需要开启 acl 功能才可以触发漏洞

　　开启 ACL 可以通过设定启动时的参数 `./spark-shell --conf spark.acls.enable=true` 或者在 `conf/spark-defaults.conf` 中添加 `spark.acls.enable true`

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-189331-1666085045.png)

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-189331-1666085046.png)

　　‍

　　构造 poc

> http://localhost:4040/?doAs=`[command injection here]`

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-189331-1666085047.png)

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-189331-1666085048.png)

## 漏洞分析

　　为了方便调试在启动脚本中添加上调试参数

```
export SPARK_SUBMIT_OPTS="-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005"
```

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-189331-1666085049.png)

　　输入错误的执行语句时的报错信息

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-189331-1666085051.png)

　　漏洞的触发大概就在 `org.apache.spark.security.ShellBasedGroupsMappingProvider.getUnixGroups`

　　漏洞的调用栈应该为

```
org.apache.spark.ui.HttpSecurityFilter.doFilter(HttpSecurityFilter.scala:71)
org.apache.spark.SecurityManager.checkUIViewPermissions(SecurityManager.scala:238)
org.apache.spark.SecurityManager.isUserInACL(SecurityManager.scala:381)
org.apache.spark.util.Utils$.getCurrentUserGroups(Utils.scala:2523)
org.apache.spark.security.ShellBasedGroupsMappingProvider.getGroups(ShellBasedGroupsMappingProvider.scala:34)
org.apache.spark.security.ShellBasedGroupsMappingProvider.getUnixGroups(ShellBasedGroupsMappingProvider.scala:43)
```

　　加上断点进行调试分析

`org.apache.spark.ui.HttpSecurityFilter#doFilter`

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-189331-1666085054.png)

　　获取到参数 `doAS` 赋值为 `effectiveUser` 传到函数 `checkUIViewPermissions`

`org.apache.spark.SecurityManager#checkUIViewPermissions`

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-189331-1666085056.png)

`org.apache.spark.SecurityManager#isUserInACL`

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-189331-1666085057.png)

`org.apache.spark.util.Utils$#getCurrentUserGroups`

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-189331-1666085058.png)

`org.apache.spark.security.ShellBasedGroupsMappingProvider#getGroups`

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-189331-1666085060.png)

`org.apache.spark.security.ShellBasedGroupsMappingProvider#getUnixGroups`

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-189331-1666085062.png)

　　通过反引号将想要执行的命令包含起来，拼接到原本的命令执行语句中

`org.apache.spark.util.Utils$#executeAndGetOutput`

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-189331-1666085068.png)

`org.apache.spark.util.Utils$#executeCommand`

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-189331-1666085071.png)

　　‍

## 漏洞补丁

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-189331-1666085072.png)

　　新版本的修复 删除了 `ShellBasedGroupsMappingProvider` 中的 `bash` 的调用，最后执行命令的语句应该变为`/usr/bin/id -Gn` + 传入参数

**本文作者：[蚁景网安实验室](newpage/author?author_id=37244)**

**本文为安全脉搏专栏作者发布，转载请注明：**[**https://www.secpulse.com/archives/189331.html**](https://www.secpulse.com/archives/189331.html)

Tags: [Apache Spark UI](https://www.secpulse.com/archives/tag/apache-spark-ui)、[CVE-2022-33891](https://www.secpulse.com/archives/tag/cve-2022-33891)、[命令注入漏洞](https://www.secpulse.com/archives/tag/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E)

点赞：
2
[评论：0](#goComment)
收藏：
0

*新浪微博
QQ空间
微信扫一扫*

### 相关文章

* [![【漏洞预警】VMware Aria Operations for Networks命令注入漏洞](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/2023/06/1686278500147-300x180.png)

  【漏洞预警】VMware Aria Op…](https://www.secpulse.com/archives/201685.html...