---
title: 解析CLFS：从CVE-2022-24481到CVE-2022-35803类型混淆权限提升
url: https://www.freebuf.com/articles/system/407472.html
source: FreeBuf网络安全行业门户
date: 2024-08-02
fetch_date: 2025-10-06T18:03:05.447891
---

# 解析CLFS：从CVE-2022-24481到CVE-2022-35803类型混淆权限提升

[![freeBuf](/images/logoMax.png)](/)

主站

分类

云安全

AI安全

开发安全

终端安全

数据安全

Web安全

基础安全

企业安全

关基安全

移动安全

系统安全

其他安全

特色

热点

工具

漏洞

人物志

活动

安全招聘

攻防演练

政策法规

[报告](https://www.freebuf.com/report)[专辑](/column)

* ···
* [公开课](https://live.freebuf.com)
* ···
* [商城](https://shop.freebuf.com)
* ···
* 用户服务
* ···

行业服务

政 府

CNCERT
CNNVD

会员体系（甲方）
会员体系（厂商）
产品名录
企业空间

[知识大陆](https://wiki.freebuf.com/page)

搜索

![](/freebuf/img/7aa3bf7.svg) ![](/freebuf/img/181d733.svg)

创作中心

[登录](https://www.freebuf.com/oauth)[注册](https://www.freebuf.com/oauth)

官方公众号企业安全新浪微博

![](/images/gzh_code.jpg)

FreeBuf.COM网络安全行业门户，每日发布专业的安全资讯、技术剖析。

![FreeBuf+小程序](/images/xcx-code.jpg)

FreeBuf+小程序把安全装进口袋

[![](https://image.3001.net/images/20231020/1697804527_653270ef7570cc7356ba8.png)](https://wiki.freebuf.com)

解析CLFS：从CVE-2022-24481到CVE-2022-35803类型混淆权限提升

* ![]()
* 关注

* [系统安全](https://www.freebuf.com/articles/system)

解析CLFS：从CVE-2022-24481到CVE-2022-35803类型混淆权限提升

2024-08-01 08:55:17

![](https://image.3001.net/images/20240308/1709876354_65eaa4828e91d155430d9.png)
本文由
创作，已纳入「FreeBuf原创奖励计划」，未授权禁止转载

## 前言

最近闲着无聊分析了 clfs.sys 中的一些过去的安全漏洞，在 Windows 操作系统的内核中，通用日志文件系统 (CLFS) 提供了一项用于日志记录的服务。由于CLFS的复杂性和其驱动程序 clfs.sys 的设计特点，历史上曾多次发现安全漏洞。本文将深入分析 CVE-2022-35803 这一 CLFS 中的安全漏洞，该漏洞允许攻击者通过类型混淆问题绕过微软先前针对 CVE-2022-24481 的修复，进而实现权限提升。

首先从分析 CVE-2022-24481 开始，解释其原理和微软的修复措施，接着介绍如何通过类型混淆的技术手段绕过修复并最终实现权限提升。通过这一过程，带大家深入了解 CLFS 的工作原理以及如何利用特定的数据结构和内核行为来实现攻击目的。

废话不多说，让我们直奔主题！

## 旧漏洞：CVE-2022-24481 分析

在 CLFS 中，CLFS\_BASE\_RECORD\_HEADER 结构用于表示基本记录头：

![1722441274_66aa5e3ad745740d0d215.png!small?1722441274716](https://image.3001.net/images/20240731/1722441274_66aa5e3ad745740d0d215.png!small?1722441274716)

结构中的 rgClients 和 rgContainers 字段用于表示一个 32 位数组，该数组存储每个客户端上下文和容器上下文的偏移量。用户可以在磁盘上修改它们。漏洞的根本原因是缺乏对客户端偏移的有效验证，导致客户端上下文与容器上下文重叠。结果，由于 clfs.sys 修改客户端上下文会导致同时改变下一个容器上下文。

实例样本会在日志文件关闭时触发函数 CClfsLogFcbPhysical::FlushMetadata：

![1722441375_66aa5e9f34a6224ea254a.png!small?1722441375414](https://image.3001.net/images/20240731/1722441375_66aa5e9f34a6224ea254a.png!small?1722441375414)

上述代码中命名的 CClfsLogFcbPhy 变量指针是一个 CClfsLogFcbPhysical 对象，在 CClfsLogFcbPhysical::Initialize 函数中初始化，当打开日志文件时会调用该函数。

![1722441435_66aa5edbe7dcaf9be5a0c.png!small](https://image.3001.net/images/20240731/1722441435_66aa5edbe7dcaf9be5a0c.png!small)

在精心构造的 CLFS 日志文件中，攻击者使客户端上下文的 llCreateTime 字段与容器上下文的 pContainer 字段重叠，并将 llCreateTime 字段设置为用户空间中的一个地址。在调用 CClfsLogFcbPhysical::FlushMetadata 函数之后，容器上下文的 pContainer 字段（在运行时存储指向 CClfsContainer 对象的内核指针）将被修改。

FlushMetadata 结束后，clfs.sys 将调用 CClfsLogFcbPhysical::CloseContainers 函数来关闭容器：

![1722441760_66aa60205d6e9f3efd5a0.png!small?1722441760091](https://image.3001.net/images/20240801/1722441760_66aa60205d6e9f3efd5a0.png!small?1722441760091)

在 [1] 之后，pContainer 将指向攻击者控制的内存空间（在用户空间）。当调用 CClfsContainer::Close [2] 时，将触发内部函数 ObfDereferenceObject。这会导致任意地址递减。这个技巧被在野外样本所使用以减少 PreviousMode 到零，这会导致调用线程从用户模式被设置到内核模式，并最终使用户能够通过 NtWriteVirtualMemory / NtReadVirtualMemory 读写内核空间中的任意地址。之后，用户可以通过覆盖当前进程的 \_EPROCESS 对象中的 token 字段到系统进程的 \_EPROCESS 对象中的 token 的地址（样本通过 NtQuerySystemInformation 获取这些地址）来实现权限提升。

## CVE-2022-24481 的补丁

通过分析补丁，可以看到该漏洞的修复是在 CClfsBaseFile::ValidateRgOffsets 中添加了对 rgClients 和 rgContainers 偏移量的检查：

![1722441690_66aa5fda1d67a935c6ed6.png!small?1722441689973](https://image.3001.net/images/20240801/1722441690_66aa5fda1d67a935c6ed6.png!small?1722441689973)

可以看到该漏洞的补丁在 [3] 引入了一个重要的检查。它要求容器上下文与其下一个上下文之间的间隔至少为 0x30 + 12 \* 4 = 0x60 字节，而客户端上下文与其下一个上下文之间的间隔至少为 0x30 + 34 \* 4 = 0x88 = 0xb8 字节。然而，在 CClfsLogFcbPhysical::FlushMetadata 函数中，我们最多只能修改位于偏移量 0x78 字节处的字段 (ClfsClientContext->eState)。因此，通过添加的检查修复了该漏洞。

## 如何绕过

通过分析补丁，我们可以看到直接修改客户端上下文偏移量的问题已经被修复。但是，还有其他方式可以导致字段重叠并引发漏洞吗？

经过研究分析，发现从 ValidateRgOffsets 验证偏移量到 FlushMetadata 修改数据，再到 CloseContainers 关闭容器的过程中，没有对客户端上下文字段 cidNode.cType（代表上下文类型）的有效性进行检查。这可能会导致类型混淆问题：如果我们把客户端上下文的 cidNode.cType 设置为 0xC1FDF008，那么当 ValidateRgOffsets 计算时，客户端上下文与下一个上下文之间的间隔会被错误地限制为 0x60 字节，这会导致客户端上下文 0x60~0x88 字节处的字段与下一个上下文 0~0x28 字节处的字段重叠。这样就产生了一个新的漏洞。

我重新审查了 CClfsLogFcbPhysical::FlushMetadata，并确定了可以通过 ClfsClientContext->eState 修改下一个容器上下文中的 pContainer。

由于原始的 pContainer 已经按 0x10 字节对齐，这会使 pContainer 字段指向原始容器对象位置的 8 字节偏移处，那里正好存储着容器文件的大小，这是通过用户调用 AddLogContainer 函数时的参数 p

# 系统安全 # 漏洞分析 # Windows提权 # Windows内核安全

![]()

![](https://image.3001.net/images/20240308/1709876354_65eaa4828e91d155430d9.png)
已在FreeBuf发表 0 篇文章

本文为 独立观点，未经授权禁止转载。
如需授权、对文章有疑问或需删除稿件，请联系 FreeBuf
客服小蜜蜂（微信：freebee1024）

被以下专辑收录，发现更多精彩内容

+ 收入我的专辑

+ 加入我的收藏

展开更多

相关推荐

![]()

关 注

* 0 文章数
* 0 关注者

文章目录

前言

旧漏洞：CVE-2022-24481 分析

CVE-2022-24481 的补丁

如何绕过

利用

CVE-2022-35803 利用

结语

声明

![](/images/logo_b.png)

本站由阿里云 提供计算与安全服务

### 用户服务

* [有奖投稿](https://www.freebuf.com/write)
* [提交漏洞](https://www.vulbox.com/bounties/detail-72)
* [参与众测](https://www.vulbox.com/projects/list)
* [商城](https://shop.freebuf.com)

### 企业服务

* [安全咨询](https://company.freebuf.com)
* [产业全景图](https://www.freebuf.com/news/307349.html)
* [企业SRC](https://www.vulbox.com/service/src)
* [安全众测](https://www.vulbox.com/)

### 合作信息

* [斗象官网](https://www.tophant.com/)
* [广告投放](https://www.freebuf.com/articles/444331.html)
* [联系我们](https://www.freebuf.com/articles/444332.html)

### 关于我们

* [关于我们](https://www.freebuf.com/news/others/864.html)
* 微信公众号
* [新浪微博](http://weibo.com/freebuf)

### 战略伙伴

* [![](https://image.3001.net/images/20191017/1571306518_5da83c1686dd9.png)](http://www.aliyun.com/?freebuf)

### FreeBuf知识大陆

![](https://image.3001.net/images/20250703/1751535036_68664dbcae34ac40bb9e7.png)

扫码把安全装进口袋

* [斗象科技](https://www.tophant.com/)
* [FreeBuf](https://www.freebuf.com)
* [漏洞盒子](https://www.vulbox.com/)
* [斗象智能安全](https://ai.tophant.com/)
* [免责条款](https://www.freebuf.com/dis)
* [协议条款](https://my.freebuf.com/AgreeProtocol/duty)

Copyright © 2025 WWW.FREEBUF.COM All Rights Reserved
[沪ICP备2024099014号](https://beian.miit.gov.cn/#/Integrated/index) | [沪公安网备
![](https://image.3001.net/images/20200106/1578291342_5e12d08ec2379.png)](http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31011502009321)