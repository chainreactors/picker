---
title: PHP CGI Windows平台远程代码执行漏洞（CVE-2024-4577）分析与复现
url: https://lorexxar.cn/2024/06/11/phpcgi-rce/
source: LoRexxar's Blog
date: 2024-06-12
fetch_date: 2025-10-06T16:55:41.119122
---

# PHP CGI Windows平台远程代码执行漏洞（CVE-2024-4577）分析与复现



[LoRexxar's Blog | 盲驴隆忙聛炉忙聤聙忙聹炉氓聢聠盲潞芦](/)

[LoRexxar's Blog | 盲驴隆忙聛炉忙聤聙忙聹炉氓聢聠盲潞芦](/)

PHP CGI Windows氓鹿鲁氓聫掳猫驴聹莽篓聥盲禄拢莽聽聛忙聣搂猫隆聦忙录聫忙麓聻茂录聢CVE-2024-4577茂录聣氓聢聠忙聻聬盲赂聨氓陇聧莽聨掳



# PHP CGI Windows氓鹿鲁氓聫掳猫驴聹莽篓聥盲禄拢莽聽聛忙聣搂猫隆聦忙录聫忙麓聻茂录聢CVE-2024-4577茂录聣氓聢聠忙聻聬盲赂聨氓陇聧莽聨掳

php
rce


2024/06/11




Share

* 
* 
* 
* 
* 

![](/assets/loading.svg)

氓聹篓2024.6.6盲禄聤氓陇漏茂录聦@Orange氓聹篓盲禄聳莽職聞氓聧職氓庐垄氓聫聭氓赂聝盲潞聠盲禄聳氓聧鲁氓掳聠氓聹篓2024氓鹿麓8忙聹聢Black Hat USA氓聟卢氓录聙莽職聞猫庐庐茅垄聵茫聙聤**Confusion Attacks: Exploiting Hidden Semantic Ambiguity in Apache HTTP Server!**茫聙聥

* <https://www.blackhat.com/us-24/briefings/schedule/index.html#confusion-attacks-exploiting-hidden-semantic-ambiguity-in-apache-http-server-40227>

盲录麓茅職聫莽聺聙猫庐庐茅垄聵莽職聞氓聫聭氓赂聝茂录聦盲禄聤氓陇漏氓聹篓DEVCORE莽職聞氓庐聵忙聳鹿氓聧職氓庐垄氓聫聭氓赂聝盲潞聠盲赂聙盲赂陋忙录聫忙麓聻茅聙職忙聤楼茂录聦盲鹿聼氓掳卤忙聵炉氓颅聵氓聹篓盲潞聨**windows莽聣鹿忙庐聤氓聹潞忙聶炉盲赂聥莽職聞PHP CGI猫驴聹莽篓聥盲禄拢莽聽聛忙聣搂猫隆聦忙录聫忙麓聻**

* <https://devco.re/blog/2024/06/06/security-alert-cve-2024-4577-php-cgi-argument-injection-vulnerability/>

忙聨楼盲赂聥忙聺楼莽聹聥莽聹聥忙录聫忙麓聻莽職聞猫炉娄忙聝聟

# 忙录聫忙麓聻忙聫聫猫驴掳

**CVE-2024-4577**氓炉录猫聡麓忙录聫忙麓聻盲潞搂莽聰聼莽職聞忙聹卢猫麓篓氓聟露氓庐聻忙聵炉[Windows莽鲁禄莽禄聼氓聠聟氓颅聴莽卢娄莽录聳莽聽聛猫陆卢忙聧垄莽職聞Best-Fit莽聣鹿忙聙搂](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-ucoderef/d1980631-6401-428e-a49d-d71394be7da8)氓炉录猫聡麓莽職聞茂录聦莽聸赂氓炉鹿忙聺楼猫炉麓**PHP**氓聹篓猫驴聶盲赂陋忙录聫忙麓聻茅聡聦忙聸麓氓聝聫忙聵炉盲赂聙盲赂陋氓聫聴氓庐鲁猫聙聟茫聙聜

莽聰卤盲潞聨Windows莽鲁禄莽禄聼氓聠聟氓颅聴莽卢娄莽录聳莽聽聛猫陆卢忙聧垄莽職聞Best-Fit莽聣鹿忙聙搂氓炉录猫聡麓**PHP氓聨聼忙聹卢莽職聞氓庐聣氓聟篓茅聶聬氓聢露猫垄芦莽禄聲猫驴聡**茂录聦氓聠聧氓聤聽盲赂聤盲赂聙盲潞聸**莽聣鹿忙庐聤莽職聞PHP CGI莽聨炉氓垄聝**茅聟聧莽陆庐氓炉录猫聡麓盲潞聠猫驴聶盲赂陋茅聴庐茅垄聵茂录聦忙聹聙莽禄聢氓炉录猫聡麓忙录聫忙麓聻氓聢漏莽聰篓莽職聞莽庐聴忙聵炉盲赂聙盲潞聸PHP莽職聞氓掳聫忙聤聙氓路搂茫聙聜

## 氓陆卤氓聯聧猫聦聝氓聸麓

猫驴聶盲赂陋忙录聫忙麓聻莽聬聠猫庐潞盲赂聤氓陆卤氓聯聧PHP莽職聞忙聣聙忙聹聣莽聣聢忙聹卢

* PHP 8.3 < 8.3.8
* PHP 8.2 < 8.2.20
* PHP 8.1 < 8.1.29

茅聶陇忙颅陇盲鹿聥氓陇聳莽職聞氓聟露盲禄聳PHP莽聣聢忙聹卢氓庐聵忙聳鹿氓路虏莽禄聫盲赂聧氓聠聧莽禄麓忙聤陇盲潞聠茂录聦氓聦聟忙聥卢PHP8.0茫聙聛PHP7茫聙聛PHP5氓聹篓氓聠聟茂录聦盲陆聠忙聵炉**莽聬聠猫庐潞盲赂聤忙聺楼猫炉麓盲禄聳盲禄卢茅聝陆氓聫聴氓聢掳猫驴聶盲赂陋氓陆卤氓聯聧茫聙聜**

## 忙录聫忙麓聻氓聢漏莽聰篓忙聺隆盲禄露

### Windows莽鲁禄莽禄聼氓聠聟氓颅聴莽卢娄莽录聳莽聽聛猫陆卢忙聧垄莽職聞Best-Fit莽聣鹿忙聙搂

氓聣聧茅聺垄忙聫聬氓聢掳猫驴聡茂录聦猫驴聶盲赂陋忙录聫忙麓聻莽職聞氓聢漏莽聰篓氓聣聧忙聫聬忙聵炉莽聰卤盲潞聨Windows莽鲁禄莽禄聼氓聠聟氓颅聴莽卢娄莽录聳莽聽聛猫陆卢忙聧垄莽職聞Best-Fit莽聣鹿忙聙搂茂录聦忙聣聙盲禄楼莽卢卢盲赂聙盲赂陋氓聣聧忙聫聬忙聺隆盲禄露氓掳卤忙聵炉

* 氓驴聟茅隆禄忙聵炉**Window莽聨炉氓垄聝**

氓聟露忙卢隆莽聰卤盲潞聨猫驴聶盲赂陋莽聣鹿忙聙搂茂录聦windows氓驴聟茅隆禄盲陆驴莽聰篓盲禄楼盲赂聥氓聟露盲赂颅盲鹿聥盲赂聙莽職聞猫炉颅猫篓聙莽鲁禄莽禄聼

* **莽鹿聛盲陆聯盲赂颅忙聳聡** (氓颅聴莽聽聛茅隆碌 950)
* **莽庐聙盲陆聯盲赂颅忙聳聡** (氓颅聴莽聽聛茅隆碌 936)
* **忙聴楼忙聳聡** (氓颅聴莽聽聛茅隆碌 932)

猫聙聦盲赂聰茅聶陇盲潞聠猫驴聶3盲赂陋盲禄楼氓陇聳茂录聦氓聟露盲禄聳莽職聞猫炉颅猫篓聙盲鹿聼盲赂聧猫聝陆氓庐聦氓聟篓忙聨聮茅聶陇氓陆卤氓聯聧茂录聦氓聡隆忙聵炉氓颅聵氓聹篓猫炉楼莽聣鹿忙聙搂莽職聞莽職聞莽鲁禄莽禄聼茅聝陆氓聫聴氓聢掳氓陆卤氓聯聧茫聙聜

**茅聜拢盲禄聙盲鹿聢忙聵炉Best-Fit氓聭垄茂录聼忙聢聳猫聙聟猫炉麓茂录聦盲赂潞盲禄聙盲鹿聢忙聵炉Best-Fit茂录聼**

猫炉麓莽聶陆盲潞聠氓聟露氓庐聻氓掳卤忙聵炉windows氓炉鹿盲潞聨盲赂聧氓聬聦莽录聳莽聽聛氓颅聴莽卢娄茅聸聠盲鹿聥茅聴麓猫陆卢氓聦聳莽職聞盲赂聙盲赂陋莽聣鹿忙聙搂茂录聦氓聫炉猫聝陆氓陇搂氓庐露氓炉鹿盲潞聨Best-Fit氓戮聢茅聶聦莽聰聼茂录聦氓娄聜忙聻聹忙聧垄盲赂聙盲赂陋猫炉聧氓聫芦氓聛職氓庐陆氓颅聴猫聤聜茂录聦忙聢聭忙聝鲁氓陇搂氓庐露氓掳卤盲录職氓戮聢莽聠聼忙聜聣盲潞聠茂录聦猫炉麓莽聶陆盲潞聠氓掳卤忙聵炉**盲赂聙盲潞聸莽聣鹿忙庐聤氓颅聴莽卢娄氓聹篓莽聣鹿忙庐聤氓颅聴莽卢娄茅聸聠盲赂聥猫陆卢氓聦聳氓掳卤盲录職猫陆卢忙聢聬盲赂聙盲赂陋忙颅拢氓赂赂莽職聞氓颅聴莽卢娄**

猫聙聦猫驴聶茅聡聦莽聰篓氓聢掳莽職聞氓掳卤忙聵炉%ad

![img](https://lorexxar-blog.oss-cn-shanghai.aliyuncs.com/blog/202406110957711.png)

猫聙聦猫驴聶盲赂陋忙颅拢氓赂赂莽職聞氓颅聴莽卢娄氓掳卤忙聵炉`-`茂录聦忙聢聭盲禄卢氓聫炉盲禄楼莽禄聯氓聬聢php莽職聞忙潞聬莽聽聛忙聺楼莽聹聥茂录聦盲赂潞盲禄聙盲鹿聢猫驴聶盲赂陋`-`氓戮聢茅聡聧猫娄聛

<https://github.com/php/php-src/commit/4dd9a36c16#diff-680b80075cd2f8c1bbeb33b6ef6c41fb1f17ab98f28e5f87d12d82264ca99729R1798>

![img](https://lorexxar-blog.oss-cn-shanghai.aliyuncs.com/blog/202406110957598.png)

氓聹篓php莽職聞盲禄拢莽聽聛氓陆聯盲赂颅氓聟露氓庐聻氓聨聼忙聹卢氓掳卤猫驴聡忙禄陇盲潞聠-猫驴聶盲赂陋莽卢娄氓聫路茂录聦氓聹篓忙聳掳莽職聞commit氓陆聯盲赂颅猫驴聵氓聤聽氓聟楼盲潞聠**氓炉鹿0x80盲禄楼盲赂聤莽職聞忙聣聙忙聹聣氓颅聴莽卢娄莽職聞茅聶聬氓聢露忙聺楼盲驴庐氓陇聧**猫驴聶盲赂陋茅聴庐茅垄聵茫聙聜氓聹篓盲禄拢莽聽聛莽職聞忙鲁篓茅聡聤氓陆聯盲赂颅忙聹聣猫驴聶盲鹿聢盲赂聙忙庐碌猫炉聺忙聺楼猫搂拢茅聡聤猫驴聶盲赂陋茅聴庐茅垄聵

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 ``` | ``` Something is wrong with the XAMPP installation :-( Apache CGI will pass the query string to the command line if it doesn't contain a '='. This can create an issue where a malicious request can pass command line arguments to the executable. Ideally we skip argument parsing when we're in cgi or fastcgi mode, but that breaks PHP scripts on Linux with a hashbang: `#!/php-cgi -d option=value`. Therefore, this code only prevents passing arguments if the query string starts with a '-'. Similarly, scripts spawned in subprocesses on Windows may have the same issue. ``` |

氓娄聜忙聻聹get氓聫聭茅聙聛莽職聞猫炉路忙卤聜氓颅聴莽卢娄盲赂虏盲赂颅盲赂聧氓聦聟氓聬芦芒聙聺=芒聙聺茂录聦茅聜拢盲鹿聢**Apache氓掳卤盲录職忙聤聤猫炉路忙卤聜盲录聽氓聢掳氓聭陆盲禄陇猫隆聦盲陆聹盲赂潞cgi莽職聞氓聫聜忙聲掳**茫聙聜盲陆聠猫驴聶盲录職氓炉录猫聡麓忙聛露忙聞聫猫炉路忙卤聜氓掳卤氓聫炉盲禄楼氓掳聠氓聭陆盲禄陇猫隆聦氓聫聜忙聲掳盲录聽茅聙聮莽禄聶php茂录聦氓娄聜忙聻聹莽聸麓忙聨楼氓陇聞莽聬聠盲录聽氓聫聜茂录聦茅聜拢盲鹿聢盲录職氓陆卤氓聯聧氓聢掳盲禄楼莽聥卢莽芦聥猫聞職忙聹卢忙聳鹿氓录聫猫驴聬猫隆聦莽職聞PHP猫聞職忙聹卢茫聙聜忙聣聙盲禄楼氓聫陋忙聹聣**氓陆聯氓录聙氓陇麓忙聵炉-莽職聞忙聴露氓聙聶(猫路鲁猫驴聡忙聣聙忙聹聣莽漏潞莽聶陆莽卢娄氓聫路)忙聣聧茅聵禄忙颅垄盲录聽茅聙聮氓聫聜忙聲掳**茫聙聜

猫聙聦猫驴聶盲赂陋忙录聫忙麓聻氓聹篓2012氓鹿麓莽職聞忙聴露氓聙聶氓掳卤猫垄芦忙聸聺氓聟聣氓聡潞忙聺楼茂录聦氓掳卤忙聵炉CVE-2012-1823

<https://www.leavesongs.com/PENETRATION/php-cgi-cve-2012-1823.html>

氓陆聯忙聢聭盲禄卢莽聰篓%ad忙聺楼盲禄拢忙聸驴-盲鹿聥氓聬聨茂录聦氓聫聜忙聲掳盲录聽茅聙聮忙虏隆忙聹聣猫垄芦茅聵禄忙颅垄茂录聦氓掳卤忙聻聞忙聢聬盲潞聠**氓聫聜忙聲掳忙鲁篓氓聟楼**茫聙聜

猫聙聦PHP氓聮聦Apache莽職聞莽聨炉氓垄聝氓掳卤盲录職忙聸麓莽聣鹿忙庐聤盲赂聙莽聜鹿氓聞驴茂录聦氓聟露氓庐聻氓聹篓2024氓鹿麓盲陆聽氓戮聢茅職戮忙聣戮氓聢掳莽卤禄盲录录莽職聞莽聨炉氓垄聝茂录聦盲陆聠忙聵炉氓戮聢忙聹聣猫露拢莽職聞忙聵炉茂录聦**XAMPP For Windows莽職聞茅禄聵猫庐陇莽聨炉氓垄聝氓掳卤氓聫聴氓聢掳猫驴聶盲赂陋忙录聫忙麓聻莽職聞氓陆卤氓聯聧茫聙聜**

猫聙聦莽聸赂氓炉鹿忙聸麓氓聟路盲陆聯莽職聞氓聫聴氓陆卤氓聯聧莽職聞氓聹潞忙聶炉忙聹聣盲赂陇盲赂陋

### 盲禄楼CGI忙篓隆氓录聫猫驴聬猫隆聦莽職聞PHP莽聨炉氓垄聝

茅娄聳氓聟聢盲赂聧氓戮聴盲赂聧猫炉麓茂录聦猫驴聶忙聵炉盲赂聙盲赂陋茅聺聻氓赂赂茅聺聻氓赂赂氓掳聭猫搂聛莽職聞氓聹潞忙聶炉茂录聦氓聹篓2024氓鹿麓盲陆聽氓聡聽盲鹿聨忙虏隆氓聤聻忙鲁聲忙聣戮氓聢掳盲赂聙盲赂陋**莽聸麓忙聨楼盲禄楼CGI忙篓隆氓录聫猫驴聬猫隆聦莽職聞PHP莽聨炉氓垄聝**茂录聦猫聙聦盲赂聰盲鹿聼忙虏隆盲潞潞盲录職氓聨禄氓聛職猫驴聶忙聽路莽職聞盲驴庐忙聰鹿茫聙聜

氓娄聜忙聻聹盲陆聽忙聝鲁猫娄聛忙聰鹿氓聡潞莽卤禄盲录录莽職聞猫庐戮氓庐職盲陆聽茅聹聙猫娄聛氓聤聽氓聟楼盲禄楼盲赂聥莽職聞茅聟聧莽陆庐

|  |  |
| --- | --- |
| ``` 1 2 ``` | ``` AddHandler cgi-script .php Action cgi-script "/cgi-bin/php-cgi.exe" ``` |

忙聢聳猫聙聟莽卤禄盲录录盲潞聨

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 ``` | ``` <FilesMatch "\.php$">     SetHandler application/x-httpd-php-cgi </FilesMatch>  Action application/x-httpd-php-cgi "/php-cgi/php-cgi.exe" ``` |

氓聹篓XMAPP莽職聞茅禄聵猫庐陇茅聟聧莽陆庐氓陆聯盲赂颅茂录聦猫驴聶茅聝篓氓聢聠盲禄拢莽聽聛盲鹿聼忙聵炉猫垄芦忙鲁篓茅聡聤莽職聞茂录聦氓娄聜忙聻聹盲陆聽忙聝鲁猫娄聛忙碌聥猫炉聲猫驴聶莽搂聧氓聢漏莽聰篓**茅聹聙猫娄聛氓聹篓httpd-xampp.conf盲赂颅忙鲁篓茅聡聤猫搂拢氓录聙盲赂聥茅聺垄猫驴聶忙庐碌盲禄拢莽聽聛**

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 ``` | ``` # # PHP-CGI setup # <FilesMatch "\.php$">     SetHandler application/x-httpd-php-cgi </FilesMatch> <IfModule actions_module>     Action application/x-httpd-php-cgi "/php-cgi/php-cgi.exe" </IfModule> ``` |

盲赂聤茅聺垄猫驴聶盲潞聸茅聟聧莽陆庐氓陇聞莽聬聠莽職聞茅聝陆忙聵炉盲赂聙盲赂陋莽卤禄盲录录莽職聞氓聹潞忙聶炉茂录聦氓掳卤忙聵炉apache盲录職**忙聤聤猫炉路忙卤聜莽聸麓忙聨楼猫陆卢氓聫聭莽禄聶php-cgi**茫聙聜

莽禄聯氓聬聢盲赂聤茅聺垄莽職聞莽聣鹿忙聙搂茂录聦盲陆聽氓聫炉盲禄楼茅聙職猫驴聡盲录聽%ad忙聺楼盲录聽氓聟楼盲赂聙盲赂陋`-`茂录聦猫驴聶忙聽路氓聹篓-盲鹿聥氓聬聨莽職聞茅聝篓氓聢聠氓掳卤盲录職忙聢聬盲赂潞**php-cgi莽職聞氓聫聜忙聲掳**茂录聦忙聻聞忙聢聬**氓聫聜忙聲掳忙鲁篓氓聟楼**茫聙聜

![img](https://lorexxar-blog.oss-cn-shanghai.aliyuncs.com/blog/202406110957918.png)

|  |  |
| --- | --- |
| ``` 1 ``` | ``` %add+allow_url_include%3don+%add+auto_prepend_file%3dphp://input ``` |

盲录職氓聫聵忙聢聬

|  |  |
| --- | --- |
| ``` 1 ``` | ``` -d allow_url_include=on -d auto_prepend_file=php://input ``` |

忙聻聞忙聢聬氓聫聜忙聲掳忙鲁篓氓聟楼氓炉录猫聡麓**忙聹聙莽禄聢莽職聞盲禄禄忙聞聫盲禄拢莽聽聛忙聣搂猫隆聦**茫聙聜

### 氓掳聠PHP莽職聞忙聣搂猫隆聦莽篓聥氓潞聫忙職麓茅聹虏氓聹篓氓陇聳 - XAMPP茅禄聵猫庐陇茅聟聧莽陆庐

猫驴聶盲赂陋氓聹潞忙聶炉猫娄聛莽聣鹿氓聢芦盲赂聙盲潞聸茂录聦莽聸赂忙炉聰莽聸麓忙聨楼忙聤聤PHP莽職聞盲潞聦猫驴聸氓聢露莽聸麓忙聨楼忙聰戮氓聹篓web莽聸庐氓陆聲盲赂聥茂录聦氓聫炉猫聝陆忙聸麓氓赂赂猫搂聛莽職聞猫驴聵忙聵炉x**ampp莽職聞茅禄聵猫庐陇茅聟聧莽陆庐茫聙聜**

氓聹篓httpd-xampp.conf盲赂颅氓掳卤氓聫炉盲禄楼忙聣戮氓聢掳猫驴聶盲赂聙盲赂虏盲禄拢莽聽聛

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 ``` | ``` ScriptAlias /php-cgi/ "D:/xampp/php/" <Directory "D:/xampp/php">     AllowOverride None     Options None     Require all denied     <Files "php-cgi.exe">           Require all granted     </Files> </Directory> ``` |

盲赂聤茅聺垄莽職聞茅聟聧莽陆庐忙聵炉盲禄聙盲鹿聢忙聞聫忙聙聺氓聭垄茂录聼

氓聟露氓庐聻氓掳卤忙聵炉猫庐驴茅聴庐`/php-cgi/`猫路炉氓戮聞莽職聞忙聴露氓聙聶茂录聦盲录職忙聵聽氓掳聞`D:/xampp/php/`盲赂聥莽職聞忙聳聡盲禄露茂录聦猫聙聦猫驴聶盲赂陋莽聸庐氓陆聲盲赂聥忙颅拢氓楼陆忙聵炉php莽職聞忙聲麓盲赂陋莽聸庐氓陆聲

![img](https://lorexxar-blog.oss-cn-shanghai.aliyuncs.com/blog/202406110957534.png)

盲陆聠猫驴聶氓聫聢忙聹聣盲禄聙盲鹿聢莽聰篓氓聭垄茂录聦忙炉聲莽芦聼茅聝陆denied盲潞聠茂录聦**氓聫陋忙聹聣php-cgi.exe忙聵炉granted莽職聞**茂录聦忙聢聭盲禄卢忙聤聤猫搂聠猫搂聮猫驴聵忙聵炉氓聸聻氓聢掳php-cgi盲赂聤茫聙聜

氓娄聜忙聻聹忙聢聭盲禄卢莽聸麓忙聨楼猫庐驴茅聴庐猫掳聝莽聰篓php-cgi.exe茂录聦盲录職忙聙聨盲鹿聢忙聽路氓聭垄茂录聼

莽颅聰忙隆聢忙聵炉盲录職忙聹聣**氓庐聣氓聟篓猫颅娄氓聭聤**

![img](https://lorexxar-blog.oss-cn-shanghai.aliyuncs.com/blog/202406110957728.png)

茅聜拢忙聢聭盲禄卢茅隆潞莽聺聙猫驴聶盲赂陋忙聙聺猫路炉氓聨禄莽聹聥盲赂聥盲禄拢莽聽聛

<https://github.com/php/php-src/blob/51379d66ec8732e506c43f6c7f1befc500117ae8/sapi/cgi/cgi_main.c#L1912>

![img](https://lorexxar-blog.oss-cn-shanghai.aliyuncs.com/blog/202406110957709.png)

忙聢聭盲禄卢盲录職氓聫聭莽聨掳忙聢聭盲禄卢茅聛聡氓聢掳盲潞聠盲赂聙盲赂陋忙聳掳莽職聞忙娄聜氓驴碌氓聫芦氓聛職**force\_redirect**茂录聦猫驴聶氓聟露氓庐聻莽庐聴忙聵炉**PHP莽職聞盲赂聙盲赂陋猫聡陋忙聢聭盲驴聺忙聤陇忙聹潞氓聢露**茫聙聜氓聹篓P莽聣聸...