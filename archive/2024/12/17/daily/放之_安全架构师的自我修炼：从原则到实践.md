---
title: 安全架构师的自我修炼：从原则到实践
url: https://mp.weixin.qq.com/s?__biz=Mzg3ODAzNjg5OA==&mid=2247485282&idx=1&sn=ece88c0798929f670a626c6b3c36f1a5&chksm=cf1895aff86f1cb99a2d3159e055d221cd936082354f73c4a7b264d11f9b857641219e7047b5&scene=58&subscene=0#rd
source: 放之
date: 2024-12-17
fetch_date: 2025-10-06T19:40:42.474803
---

# 安全架构师的自我修炼：从原则到实践

![cover_image](https://mmbiz.qpic.cn/mmbiz_jpg/rmc0P5ibISkAy6auq91wZNHiaJrf47yicJlM2icVR9HBp8NStFWpYlhql68PrtDmRz2PFe5KjYEicZrwVDYtwuhXibOA/0?wx_fmt=jpeg)

# 安全架构师的自我修炼：从原则到实践

原创

放之

放之

# 0x00 前言

六年前开始在博客记录“架构”相关的知识（参考《#安全架构》），三年前做企业安全的思路已经基本成型（参考《[我的企业安全观](https://mp.weixin.qq.com/s?__biz=Mzg3ODAzNjg5OA==&mid=2247484441&idx=1&sn=09fc8e32f2f7bb84197c96c10229c8d4&scene=21#wechat_redirect)》）。数载春秋，有过犹豫，有过怀疑。正所谓驽马十驾，功在不舍。今天，再来谈谈我对企业安全的一些认知，亦或者说是，作为一个安全架构师的自我修养。

# 0x01 架构演进中的安全设计原则

应用从单机到分布式。架构也在逐渐的演变，从单体开始，到C/S架构，服务器端做集群。再到分层架构再到SOA，以及微服务和Serverless架构。有的人说是业务需求驱动着架构演进，也有人说是算力变化驱动着技术迭代。至于背后的原因，可能需要亲身经历过的才能知道一二。 我没经历过，就不胡乱猜测了。不过这些都不是新的东西，无论是应用的架构还是安全的设计理念。最小化权限（Least Privilege）最早在70年代提出，纵深防御（Defense In Depth）在90年代提出，哪怕是最新的零信任（Zero Trust）在2010年由Google推广出来之前，也早已在1994年被Dr.Stephen Paul Marsh创建出来。

![](https://mmbiz.qpic.cn/mmbiz_png/rmc0P5ibISkAy6auq91wZNHiaJrf47yicJlcsw3x88yvDlWG3SVR95cfrGFf3WBdxlhQpwyccm1F50bXUYB1vVuaQ/640?wx_fmt=png&from=appmsg)

How Security Deisgn Works?

// 注：Application Architecture列既有Architecture Style也有Architecture Pattern，方便对比，此处仅用Application Architecture统一代指。

回到前面，且不谈技术趋势演变的本质到底是什么。对应到编程语言的变化，从以C为代表的面向过程的编程语言到C++开始进行面向对象编程，以及后续的函数式编程（Function Programming）等等。除去早期的AD-HOC的编程，配置（早期应该也没有安全设计概念，起码在检索这些安全设计原则之初没有发现）。当应用从单体架构开始向客户端-服务器（C/S）架构发展的时候，设计原则也开始从关注隔离（Isolation）渐渐的转向最小化权限（Least Privilege）。擅自揣测，则是单体架构时期多是客户端程序（这里是从时间发展线上来看的，并不是指当下依旧存在的单体架构应用），只需要关注好隔离即可，谁能打开电脑谁就能访问。当之后开始出现服务端程序，架构也逐渐编程客户端-服务端的模式。此时不仅需要关注提供服务的端侧隔离，还需要考虑到访问权限的控制，于是出现了最小化权限的原则，同此时期，RBAC的模型等等也被创建起来。感兴趣的可以去维基百科一下。

同样的，后续逐渐出现了针对服务端侧的安全默认（Security By Default）和最小化暴露（Minimal Exposure）原则。再之后，分层架构（Layered Architecture）的引入，使安全设计的概念转向纵深防御（Depth In Depth）。乃至SOA架构和微服务架构时期，安全设计的理念一直遵循在DID（其实已经够用了）进行，直到云化，容器化和云原生逐渐发展，IAAS，PAAS，SAAS，乃至无服务器架构（Serverless Archiecture）也出来了（我曾听过某风控总监认为使用serverless架构就不用关注应用安全的说法）。微服务大规模扩展时，服务间的鉴权成了强需求。零信任（Zero Trust）的模型也终于有了落地的可能。随着应用侧Istio和K8S的出现，基础设施侧Boundary类产品，访问类Zscalar和端侧SASE类产品的出现，整体的零信任架构也算是勉强落了地。国产的平替会在后面讨论，尤其是针对分久必合，合久必分的One Agent类产品。

回到安全产品，再看下这些安全产品是如何支撑安全设计原则的。最初的最初，应该只是手动配置Unix服务器上的文件权限，以实现隔离和最小化权限的原则，后面渐渐的出现了Firewall产品，但是现在看来这些产品可能更多的类似脚本和工具。后面渐渐的出现了各类产品，从Logging到SIEM，从iptables到UFW，从Encryption到KMS，从Nginx WAF到RSAP（此处仅是通过搜索和推断，并未亲历，无实证。期待后续看到乙方前辈的文字记录。）以及云上引出CSPM类产品等等。安全产品有种大爆发的错觉，各类都在垂直领域做专业的事情。但对比国外和国内产品，生态还是相差甚远。尤其是对企业内基础设施的整合和安全产品之间的集成。

## 1. 从隔离到零信任

**新的安全设计原则的引进，并不代表着旧的安全设计原则被抛弃**。 应用架构的演进，使得服务的攻击面发生了较大的变化。从127.0.0.1到0.0.0.0的过程中，业务的复杂度逐渐变高，无论是访问的隔离还是权限的隔离（我把最小化原则视为另一种隔离，即权限的隔离，因为本质上都是减少服务请求方和服务提供方两个Entity之间的最小资源重合）都已经不再能完全满足安全需求。从网络维度，如果依旧通过防火墙的五元组实现隔离，大量耦合业务场景的规则将变得无法维护，同时也阻碍了“敏捷开发”（此时的安全会经常听到业务抱怨：“你们Block了Production的！！”的类似言论）。从应用维度，微服务内部几乎没有任何防护，也不存在所谓隔离。虽然有一段时间听过“微隔离”的概念，但是在我还没搞清这个概念是什么的时候，似乎又销声匿迹了。

隔离，是一种最常见的安全设计原则。从物理维度有独立建筑隔离，门禁隔离，专线隔离，围笼隔离，电磁屏蔽机柜隔离，以及硬件加密机这种专用硬件；从网络维度有VLAN，MPLS，VPN，网络防火墙隔离，还有iptables, ufw等；金融行业在应用和数据的维度上更多的是通过物理和网络维度优先实现隔离，显而易见的在运维运营方面都会出现很大的问题，虽然这在监管优先的情况下并不妨碍业务的正常运转。其次是通过提供认证及鉴权（SSO、MFA、RBAC等），沙箱，虚拟化等提供对应用层面的隔离控制，以及通过提供分段、掩码、加密（使用不同的密钥、同态加密）、多方计算等形式实现数据层面的“隔离”。另外当在实际情况中无法实现理想的隔离时，则往往会以代理的设计模式再辅之以检测和监控的方式进行实现。例如Web防火墙，出向代理（Outbound Proxy），邮件网关，上网行为代理，DLP，堡垒机等。

对于零信任而言，更像是在应用层面接管了物理层面及网络层面的隔离管控措施。例如通过引入ZTA类应用来接管Applicatoin和 Application之间的访问控制，User和Application之间的访问控制，以及User和Machine之间的访问控制。软件定义安全的形式确实更贴近业务。在K8S内部引入Istio来使用mTLS增强Service间的安全认证及鉴权，同时支持加密传输。使用SASE可以通过任何一个互联网接入点，在完成客户端侧的合规检测后，通过使用SSO的方式拨入SASE的网络接入点后内网畅游，通过Citrix完成对内部应用的访问。被访问的应用（包含SASE和Citrix）在做IDP集成时可以配置对应的用户及组的授权。但同时SASE类产品的控制后台也可以管理用户对特定应用的访问权限。

以隔离为代表的设计原则包含ACL，最小化权限。至于到零信任原则的设计，则是一方面细化了授权的场景，一方面增强了认证的强度。从设计模式上看，均是基于代理、单例（Singleton）、责任链模型（CoR/Chain of Responsibility）实现的中心化管控。个人感觉，虽然从应用层面看零信任实现的安全控制确实更加高效，但仍然需要通过基本的隔离进行兜底。例如：基本的物理隔离，相应的Security Zone（在和零信任配合的情况下，Zone的粒度可以适当放宽）

## 2. 从简单加密到隐私计算

如果继续引用隔离的设计思维，**对密钥访问权限的控制本质就是对数据访问的控制**。 从技术上看，从使用对称加密算法用于静态存储数据（DARE/Data At Rest Encryption）开始，到使用非对称加密算法完成两端之间的数据交互（TLS密钥协商，Data At Transit Encryption），再到PKI体系的发展，开始在要求加密的同时鉴别实体的身份。我们知道即便从RSA逐渐往ECC系列，可能也无法抵抗量子计算下的破解，Kyber的出现，代表着加密算法进入Post-Quantum时代。//尴尬的是，突然发现 IBM Quantum LAB 居然停服了。

从运营上看，更别提自创“加密”算法，自创“SDK”，N个业务方使用同一个固定IV，明文显示的“密钥”，Secret Sharing的不对等防护，证书的错误使用（场景更多），把用户名密码当作Cookie存在前端（这是我写该文章时翻到一篇18年文章里记载的，不可思议！），分不清哈希和加密等等错误的配置及使用。可以牵扯出一系列从根信任（RoT/Root Of Trust）到端到端加密（E2E）过程中遇到的各种沙雕问题。但很明显的是一边是通过在技术层面提高算法强度，一边在通过在运营维度保证私钥安全并缩短轮转的周期（无论是密钥还是证书）来实现对数据存储和传输过程中的加密。

但这些实际都没有解决数据在使用中的安全问题，即便可以通过较高强度的非对称算法去提高对称加密密钥生成时的机密性，但混合加密体系下并未设涉及密文计算。出于密钥和明文具备同等重要性的原则，对数据明文计算的结果是无法脱离密钥这个环节的，但**密文数据的计算解除了数据使用过程中密钥和明文数据的耦合**。至于隐私计算的技术，类别很多，在两年前也出现过一波出版炒作现象。具体可以参考该篇学习笔记：[浅谈隐私计算与数据安全](https://mp.weixin.qq.com/s?__biz=Mzg3ODAzNjg5OA==&mid=2247485013&idx=1&sn=74746ddb9ac4e7b225e9bed1a1fa17ab&scene=21#wechat_redirect)， 虽然在实际的落地场景中，并不常见，但整体来说在算力提升和云化的背景下，当存在更多互不完全信任的参与方时，如何确保数据安全情况下满足各参与方的计算需求的安全设计一定会越来越多。 //当然这里涉及到另一个话题，如何衡量合同解决事情的成本和技术解决方式的成本。

## 3. 从安全默认到安全左移

其实没有太多好说的，只是大家搞清楚概念和落地有点没那么容易。如需详细了解安全默认，和安全左移可以参考以下两篇文章：

* • [当我们在谈安全默认时我们在谈什么](https://mp.weixin.qq.com/s?__biz=Mzg3ODAzNjg5OA==&mid=2247485234&idx=1&sn=21fecfd63f6dba5b67ab64898087cb77&scene=21#wechat_redirect)
* • [安全左移移了么](https://mp.weixin.qq.com/s?__biz=Mzg3ODAzNjg5OA==&mid=2247485085&idx=1&sn=1cf7bed2858f04b29da592c5f878a29e&scene=21#wechat_redirect)

从单体架构时代关注配置的安全默认（Security By Defualt），到开始关注应用生命周期管理后提出SDLC，以及后续微服务时代，敏捷开发带来的快速迭代毫无因为疑问的引出了大量的潜在问题，即便在CI/CD中内置了安全扫描工具，但依旧无法避免新的威胁。例如供应链投毒：xshell类基础工具的投毒，pypi源投毒以及docker image的投毒等等。于是开始提出了安全左移（Shift To Left）。此时不仅需要关注安全默认的能力，更希望把安全默认的能力提前。但实际情况是，作为设计原则是好的，而企业中甚至不能把安全默认做好（请思考所谓的安全默认，在流程，工具上覆盖了哪些维度，侵入了哪些业务，亦或基础设施）。更别提左移的理念了。

## 4. 从记录监控到安全验证

在基础安全的维度去看设计的原则从隔离到零信任，在应用安全的维度看从默认实现到能力提前，以及数据维度的简单加密到密文计算。并未包含运营相关的设计演变，但考虑到实际安全设计在落地之后，运营是必不可少的，因此简单的写一下自己眼中安全运营的变化。

但如果大言不惭的话，国内在做甲方安全的过程，早期应该是不存在整体的安全设计。主打一个安全运营，炫彩夺目又可以输出。外面是光鲜亮丽的牛逼，里面是一线运营的苦逼。这也是我在18年对安全运营“文化”最为反感的时候，因为每个人都在鼓吹安全运营，但实际却是case by case的问题处理和《圈子及圈层》文化，以至于自己极力的想转向数据安全架构方向。当然现在的我早已不再排斥安全运营的话题，喷子状态也改善了很多。因为发现即便是做架构，也是少不了运营的。关于架构的运营可以参考[安全架构师的运营一二事](https://mp.weixin.qq.com/s?__biz=Mzg3ODAzNjg5OA==&mid=2247485068&idx=1&sn=d7452b1153454ed2ab0d77630d1075aa&scene=21#wechat_redirect)

再回到设计视角，企业最开始通过集中式日志中心完成对数据的收集（更早之前应该没有），安全日志的收集既可以独立进行，也可以作为企业内标准基础设施的一部分。此时还没有数据化，自动化的概念。随着SIEM类产品的出现，功能愈发丰富，开始对数据做场景化的分析，针对处置的结果做自动化。形成运营过程的SOP和对外发布的流程制度。这个时期是从手动往自动化过度的过程，期间也形成了对SOC类团队的组织架构需求。进一步要求SOC团队需要做到指标化，针对告警的压降，针对入侵的检出，针对响应时间的缩短，做看板，做IM的告警通知。再到后来一个较大的分割线就是SOAR类的商业化产品成型，摆脱了手工维护自定义脚本的过程（个人认为平台维度要比手工维护更有益）。纵观产品维度就是从SIEM到SOAR再到BAS类产品的研究（但是我感觉BAS类产品并不完全算，因为安全验证的概念实现完全也可以通过自定义的SOAR类脚本实现）。是安全运营逐渐自动化后再到安全设计得以验证的过程。因为设计的落地过程存在着很多灯下黑的问题，需要通过日常运营的结果去校正设计，当然这里又涉及到另一个话题，就是可以信任团队，但又不能完全信任运营的交付结果。

# 0x02 架构治理中的关键平衡点

在实现Business Goal时，如何平衡Management，Operation，Technology关乎企业发展与否。而在Technology部分，如何实现新的平衡来确保IT和Business相适应也至关重要。套娃的是，Technology的实现过程中需要再次平衡Management和Operation的难度。

![](https://mmbiz.qpic.cn/mmbiz_gif/rmc0P5ibISkAy6auq91wZNHiaJrf47yicJlEIBw5fO7h4dcN2ZUFaGrIiaUParyyvPvKhSYibeRj8gicTh9m0WXmnuEg/640?wx_fmt=gif&from=appmsg)

考虑到落地的尺度，这一节通过一系列问题来讨论架构治理中的关键平衡点（避免平衡成为一种无限套娃），但是这些问题是没有绝对正确的答案，谁是决策者，谁在运营成本、安全防护和高性能之间选择？ 对于架构，很大一部分程度上就是平衡的艺术。

## 1. 基线在哪里？

基线决定了木桶短板的高度，但基线的落地并不能完全通过技术手段，必须要贴合业务场景并通过流程制度和平台工具一同实现。如果从问责制的角度出发，为了关注谁会打破Baseline，就需要首先确定谁是最后一道守门员。是所谓的流程制度，还是关键的职能人员，亦或者是自动化的平台工具？在流程优先，工具支撑的情况下，最后一个守门员是例外审批流程里的就是最后一个节点人。 在业务优先的情况下，最后一个守门员是流程制度，记住不是X在为难Y，是流程在这里，虽然此处的本质是流程制度人作为守门员。不过有时候也无法避免为业务让道的结果，但是需要注意的是有一些基线是可以妥协的，而一定有一些是不可以的。比如对外暴露的端点加白名单是可以妥协的，使用通配符证书是可以妥协的，使用HTTP是不可以接受的。

## 2. 深度在哪里？

纵深防御、零信任一般很难完全落地，理解的不到位，组件/工具的不到位（乙方的产品在专业功能过关但不一定在基础设施的融合上面）。例如前面在《从隔离到零信任》中，隔离从物理维度到应用维度到数据维度有不同的方式，需不需要独立门禁，独立电磁柜，硬件加密机，专线还是IP白名单等等。而对于端到端的零信任应该是什么样的？如何去保护客户端的安全，到网络端呢，到应用侧呢？以及应用之间。 从数据的维度，加密是如何进行的？在不信任通信链路的情况下？如果存储也不背信任呢？甚至不信任云上的KMS？对应这些问题，都有对应的技术手段可以解决。但是如何平衡High Performance和Cost Efficieny? 比如能否为K8S引入TEE？有时候触发了监管的policy呢？深度是否应该放弃？就像前面说的，合同确保的数据流动是不是真的就比隐私计算技术差多少？哪些场景下，可以通过流程制度来弥补技术的不足？哪些情境下又必须通过平台工具来提升运营的有效性？或者根本就没有必须？必须二字只是技术人的自我感动？又比如卡发布的操作，如何又要卡发布又要不能影响业务迭代？又比如针对漏洞运营，cvss 9分的漏洞在你的企业内应该增加哪些维度评估？别人没有窗口去修复，是不是就要闹剧了？我们能够自己实现加密库吗？拥有fb这种开发fizz的能力吗？指标的陷阱是不是要避免？还是每天就要扣着工单数和告警数？需要对SAAS类服务逐一进行尽职调查吗？确定哪些自动化之前先确定下哪些不要自动化？但就以这个问题，在实际的场景中，业务方肯定是要安全提供需要自动化的需求是什么，而安全又希望业务方先梳理出已有的场景。在来回扯皮的过程中，只能说谁站在守门员的位置，谁才有资格决断。

## 3. 成本在哪里？

《将心注入》里霍...