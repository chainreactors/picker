---
title: 对学校服务器挖矿木马的一次逆向分析
url: https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458563599&idx=1&sn=5f2d3ca69e2cfdee15dc9533fd7ebc90&chksm=b18d848586fa0d93e8beca0c1c56bae398128f24596952c768cc2f90d40ab7830d72ec3d34d4&scene=58&subscene=0#rd
source: 看雪学苑
date: 2024-07-15
fetch_date: 2025-10-06T17:40:38.913742
---

# 对学校服务器挖矿木马的一次逆向分析

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPq1PfxmxniayzfqKz96smn1uMzfnMibZRralAcVQCibye0HvCOBy0lMGbicQ/0?wx_fmt=jpeg)

# 对学校服务器挖矿木马的一次逆向分析

Ghost\_196615

看雪学苑

前不久，学弟突然找上了我，说学校分配的服务器被人种了挖矿木马，心中一听顿时一惊。内网一台服务器的沦陷的话，可能其它服务器也遭黑手了（可惜我不是应急响应大神，加上学校对网安这块不太重视，我也没资格上人家的服务器看一看情况，只能让学弟把软件发给我。）

一共有两个文件，其中名字分别为：

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqDA8k2unEMT7TUkXg399Xw3o4icibRKrNazArWwPdc4ia54HWBnUXErrNA/640?wx_fmt=other&from=appmsg)

其中会定期执行-bash文件：

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqyiaPjyMyFJIrgqic3UTv9bJceXdWNlygAI8RCjGAs8jyZLjduqs0k9aQ/640?wx_fmt=other&from=appmsg)

但是由于学弟那边排查占用率最高的是python2.8文件，所以先用ida打开，查找字符串发现：

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqYib0sK4Ticibeibzad6DurpOJ7hYbHlHnfb8CIQruC3nqpwqRauK8WAfeA/640?wx_fmt=other&from=appmsg)

好家伙，xmrig，于是校验一波hash。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPq8Rt9eLDE14Ead2afp6Lp1PrZ0ynEyc93tgUsBK7JSibCJRWvWLTCJHg/640?wx_fmt=other&from=appmsg)

可以发现就是xmrig6.21.3 版本，于是我问了问被入侵的时间，结果是6月9号左右，那个时候xmrig还没更新6.21.3版本，好家伙，到被发现快有1个月了，既然确定了python2.8的真身，接下来就要开始分析-bash文件了。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqan4Wxf4pJxNH5OjPULVoHdSkp9enXkZ5TZ3RXQh9ibV6jzW2EselbqA/640?wx_fmt=other&from=appmsg)

可以看到被upx压缩了，于是打算upx -d脱壳，结果：

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqbwqJGVzkH6FJPtkKO7bHibicwD1R8028XSmiaoQUqPZjibfXXqgoNgZib1Q/640?wx_fmt=other&from=appmsg)

网上搜了搜，大多都是在说修改了upx特征，如果不看upx源码找到被修改的特征就只能找到oep之后dump下来，想了想后者比较快，于是先试了试后者，

脱壳操作参考了Linux逆向之加壳&脱壳 - 先知社区 (https://xz.aliyun.com/t/6881?time\_\_1311=n4%2BxnD0DRDyBeAK4GNnm0WY4D50QKQDgeRYD&alichlgref=https%3A%2F%2Fcn.bing.com%2F)。

然而ida打开搜索字符串发现了go语言特有的字符串：

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqLSbE77QEUVRq373glEPep571MpDrWT3J07iaHzGXvsGeByvibKkMdLIQ/640?wx_fmt=other&from=appmsg)

这样的话oep dump会丢失很多信息，而且调试符号本身也被去除了。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqMXdibw3cjHe8bgbQNF16DbNJCyjqjZjTc8vCwIxwFovJAnM9yPM4DZA/640?wx_fmt=other&from=appmsg)

在尝试了go\_parser和IDAGolangHelper工具恢复符号失败后，不得已开始研究pclntab和moduledata,这里参考了安全客一位师傅写的文章（https://www.anquanke.com/post/id/215419#h2-4）,在其中发现`gopclntab` Section 就对应于 pclntab 结构，由于-bash软件没有开pie，所以gopclntab不会被删除，这下必须研究upx源码并尝试恢复特征进行工具脱壳了。

源码的研究参考了[原创]UPX 4.0.2 源码分析（https://bbs.kanxue.com/thread-278288.htm）

简单说一下研究过程，首先全局搜索哪个函数爆出错误信息"NotPackedException: not packed by UPX"。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqziaVZBbLIKiabGg1aFXmSPuuBGhFib2rgLc3DRk40WF4ZqqcAibFMUkVKA/640?wx_fmt=other&from=appmsg)

定位throwNotPacked函数。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqfJicNm3ahYJiboUicKiaSem1hl4qnPTwVk66qWF0kJQRVpXIGk1wWQiboqw/640?wx_fmt=other&from=appmsg)

可以发现visitAllPackers是关键函数，继续定位，这里给出部分代码，但可以确定核心是func(pb.get(),user),结合刚刚传递的参数，确定核心为try\_can\_unpack。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqWjIWaEzpSmnMmfELhRnP1MkxsqQopAUGewLHyxFWJicLtrqC5GBl4Bg/640?wx_fmt=other&from=appmsg)

跟进

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqCm5M2OF13h2q9iau41x4sP6SOJ0VPt9W3sAG6pumFlpDlfNU27sMJ2g/640?wx_fmt=other&from=appmsg)

核心是pb->canUpack,这下要跟进类方法了，不过很容易就确定是：

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPq9sL6u4dleAQq8qW0CO0xlynQVxyDGMwuZDcXM4ia2VoLqIh0oropPWg/640?wx_fmt=other&from=appmsg)

里面的printf都是我后来加的，是为了确定哪个条件出了问题。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqjdO2A1KQMHcpneLicAKCiadiaeAAhZR43cmowHMoq7KxgGVjUa8yZx8RQ/640?wx_fmt=other&from=appmsg)

虽然不知道为何会多次调用，不过看样子感觉是为了尝试不同平台，这里主要解决父类canUnpack的问题，因为第一次调用e\_machine是对的上的。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqEaNDEAd3OAyACLOXGmsyVzUJ6SAlzM7L131iaJ1EzogZSmnicE6QUiaLg/640?wx_fmt=other&from=appmsg)

核心在于find\_overlay\_offset，跟进

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqOUeoCOHHwnjMpW5n3fXmopOURbTNo7eqboOsKibJwicYKj67oWXk08Jg/640?wx_fmt=other&from=appmsg)

由于find\_overlay\_offset并未抛出下面两种异常，所以问题只能在第一次条件判断，经过调试后得知是getPackHeader的问题，由于其篇幅过长，只给出核心地方，可以看见在解码时爆出错误，继续跟进。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPq7eaibU3FKH0ibDZAsVfJld1tWgXpw0Aa9DMUssVfP2qrvnWiaggPL1iaRQ/640?wx_fmt=other&from=appmsg)

还是给出核心地方。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqcla9sloH92VsnNyibnk2aJeP3d1qhLBs5ETIxicwOGTQWCzpMMdicNotA/640?wx_fmt=other&from=appmsg)

这下问题一目了然，在解码时，没有找到UPX的magic字段，而根据前面的代码得知upx是从文件倒过来开始解码的，所以16进制打开文件看一看。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPq1j11KEzT9HXJmg5D9FJiaWALEhm8RvjZv1G04k65Fzes0niciaIaVxsXg/640?wx_fmt=other&from=appmsg)

原来文件末尾硬编码一段数据upx也脱不了壳，网上那些各种改特征虽然很牛，但第一次觉得没有这个快捷方便。

虽然编码看起来像base64，但解出来不太行。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqbWN8kb2WxnWS9n3AVibUNQgksNjoG4Jnr6afRAQQHCoIFp4ichwU2XGQ/640?wx_fmt=other&from=appmsg)

/var/tmp/.x就是之前学弟找到的位置，不过前后的信息就有点迷惑了

先将尾部全置0，这样upx就能脱壳了。

脱壳之后再打开ida。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqvuQWia5XB6FpJ7FKNoyHzLqfJica2c9INiarSLSsRKAiaMiarMZn7wFMVqw/640?wx_fmt=other&from=appmsg)

这下就能快速定位gopclntab,然而这份样本上来就给我上了一课。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqpn5aw0ywkwoM6hPtzLyoSmokFebkPR88fZHLuWSCaljJSGsTsVGZug/640?wx_fmt=other&from=appmsg)

magic字段为16B867D6h，我在网上看了很多go样本混淆的，但magic字段都是FF开头，从来没见过这种。这下我也就知道了为什么go\_parser和IDAGolangHelper不行了，因为这两个工具找magic的前提是0xFF开头的

go\_parser。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqcW8VYTXxcpzpg8ThMScm81rib5T8m0ET4eAhqqsk0HwpEXIjkqKs2qQ/640?wx_fmt=other&from=appmsg)

IDAGolangHelper:

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPq7duyoXRCgLy5P4ec0hJW7QFhllZNMPnIdg30zyDL2ibwjbGdxtzypbA/640?wx_fmt=other&from=appmsg)

这下只能手动写脚本恢复符号了，这里参考了[原创]2021 CISCN gift题解（恢复符号+逆向算法）（https://bbs.kanxue.com/thread-267813.htm）

没想到2021CISCN就有过这种题了。

修改后的脚本：

```
from ida_bytes import del_items, DELIT_SIMPLE
from ida_funcs import add_func
from ida_name import set_name, SN_NOCHECK
from idc import get_strlit_contents
import idaapi

moduledata = 0x642240
func_table = idaapi.get_qword(moduledata + 0x80)
func_table_size = idaapi.get_qword(moduledata + 0x88)
string_table = idaapi.get_qword(moduledata + 0x8)

start_addr = func_table
end_addr = start_addr + func_table_size * 8

i = 0

while start_addr < end_addr:
    func_entry = idaapi.get_dword(start_addr) + 0x401000
    start_addr += 4
    func_struct = func_table + idaapi.get_dword(start_addr)
    string_addr = string_table + idaapi.get_dword(func_struct + 4)
    string_name = get_strlit_contents(string_addr).decode('utf-8') if get_strlit_contents(string_addr) else "unknown_"+str(i)
    print('Renaming ' + hex(func_entry) + ' to ' + string_name)
    del_items(func_entry, DELIT_SIMPLE, 1)
    add_func(func_entry)
    set_name(func_entry, string_name, SN_NOCHECK)
    start_addr += 4
    i += 1
```

这里说以下为什么不用func\_struct里第一个字段entry，这里我计算两个func\_struct地址。

func\_table = 0x6026A0

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqd8KS1RMNekK0oXUbfichLoGKmW3hOicRib4N5T8qMoKPwmgWLPxDsrxVw/640?wx_fmt=other&from=appmsg)

第一个func\_struct为0x6026A0 + 0x56B0 = 0x607D50

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqt21kO3LSpPHEmsytXD7elvm9BWGRZuYpUcmjctwMcSPVa9SrsaW4CA/640?wx_fmt=other&from=appmsg)

我们要的前两个数据都是没问题的，第一个是相对于基址的偏移，第二个是相对于字符串table的偏移。

然后再看第二个func\_struct为0x6026A0 + 0x5708 = 0x607DA8

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPq4xr5bmT05OgXCnMonWKRYM4Ir6A5EMXiax7aftpfiaMfiafHF4JictAmNg/640?wx_fmt=other&from=appmsg)

这个func\_struct第一个字段就完全对不上了，如果有知道原因的大佬还请指出

脚本执行恢复符号后。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EDOEyyAjIYqJ7ZShibj1sPqQlib2DE6ibjnibWRSkE2tRRPhJXjj7z2zd9RibFgCy90nSMJjkaWxfKIAA/640?wx_fmt=other&from=appmsg)

可以看到很多都是混淆的。

在...