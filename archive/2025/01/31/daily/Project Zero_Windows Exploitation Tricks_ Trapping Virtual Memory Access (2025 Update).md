---
title: Windows Exploitation Tricks: Trapping Virtual Memory Access (2025 Update)
url: https://googleprojectzero.blogspot.com/2025/01/windows-exploitation-tricks-trapping.html
source: Project Zero
date: 2025-01-31
fetch_date: 2025-10-06T20:10:26.665840
---

# Windows Exploitation Tricks: Trapping Virtual Memory Access (2025 Update)

# [Project Zero](https://googleprojectzero.blogspot.com/)

News and updates from the Project Zero team at Google

## Thursday, January 30, 2025

### Windows Exploitation Tricks: Trapping Virtual Memory Access (2025 Update)

Posted by James Forshaw, Google Project Zero

Back in 2021 I wrote a [blog post](https://googleprojectzero.blogspot.com/2021/01/windows-exploitation-tricks-trapping.html) about various ways you can build a virtual memory access trap primitive on Windows. The goal was to cause a reader or writer of a virtual memory address to halt for a significant (e.g. 1 or more seconds) amount of time, generally for the purpose of exploiting TOCTOU memory access bugs in the kernel.

The solutions proposed in the blog post were to either map an SMB file on a remote server, or abuse the Cloud Filter API. This blog isn't going to provide new solutions, instead I wanted to highlight a new feature of Windows 11 24H2 that introduces the ability to abuse the SMB file server directly on the local machine, no remote server required. This change also introduces the ability to locally exploit vulnerabilities which are of the so-called "[False File Immutability](https://www.elastic.co/security-labs/false-file-immutability)" bug class.

## All Change Please

The change was first made public, at least as far as I know, in [this blog post](https://techcommunity.microsoft.com/blog/filecab/smb-alternative-ports-now-supported-in-windows-insider/3974509). Microsoft's blog post described this change in Windows Insider previews, however it has subsequently shipped in Windows 11 24H2 which is generally available.

The TL;DR; is the SMB client on Windows now supports specifying the destination TCP port from the command line's net command. For example, you can force the SMB client to use port 12345 through the command net use \\localhost\c$ /TCPPORT:12345. Now accessing the UNC path \\localhost\c$\blah will connect through port 12345 instead of the old, fixed port of 445. This feature works from any user, administrator access is not required as it only affects the current user's logon session.

The problem encountered in the previous blog post was you couldn't bind your fake SMB server to port 445 without shutting down the local SMB server. Shutting down the server can only be done as an administrator, defeating most of the point of the exploitation trick. By changing the client port to one which isn't currently in use, we can open files via our fake SMB server and perform the delay locally without needing to use the Cloud Filter API. This still won't allow the technique to work in a sandbox fortunately.

Note, that an administrator can disable this feature through Group Policy, but it is enabled by default and non-enterprise users are never likely to change that. I personally think making it enabled by default is a mistake that will come back to cause problems for Windows going forward.

I've [updated the example fake SMB server](https://github.com/tyranid/windows-memory-access-traps) to allow you to bind to a different port so that you can perform the attack locally. Hopefully someone finds it useful.

Posted by

[Google Project Zero](https://www.blogger.com/profile/08975904405228580347 "author profile")

at
[9:57 AM](https://googleprojectzero.blogspot.com/2025/01/windows-exploitation-tricks-trapping.html "permanent link")

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=4838136820032157985&postID=5888159695536073518&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=4838136820032157985&postID=5888159695536073518&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=4838136820032157985&postID=5888159695536073518&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=4838136820032157985&postID=5888159695536073518&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=4838136820032157985&postID=5888159695536073518&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=4838136820032157985&postID=5888159695536073518&target=pinterest "Share to Pinterest")

#### No comments:

#### Post a Comment

[Newer Post](https://googleprojectzero.blogspot.com/2025/01/windows-bug-class-accessing-trapped-com.html "Newer Post")

[Older Post](https://googleprojectzero.blogspot.com/2024/12/the-windows-registry-adventure-5-regf.html "Older Post")
[Home](https://googleprojectzero.blogspot.com/)

Subscribe to:
[Post Comments (Atom)](https://googleprojectzero.blogspot.com/feeds/5888159695536073518/comments/default)

## Search This Blog

|  |  |
| --- | --- |
|  |  |

## Pages

* [About Project Zero](https://googleprojectzero.blogspot.com/p/about-project-zero.html)
* [0day "In the Wild"](https://googleprojectzero.blogspot.com/p/0day.html)
* [0day Exploit Root Cause Analyses](https://googleprojectzero.github.io/0days-in-the-wild/rca.html)
* [Reporting Transparency](https://googleprojectzero.blogspot.com/p/reporting-transparency.html)
* [Vulnerability Disclosure FAQ](https://googleprojectzero.blogspot.com/p/vulnerability-disclosure-faq.html)
* [Working at Project Zero](https://googleprojectzero.blogspot.com/p/working-at-project-zero.html)

## Archives

* ▼
  [2025](https://googleprojectzero.blogspot.com/2025/)
  (10)
  + ►
    [September](https://googleprojectzero.blogspot.com/2025/09/)
    (1)
  + ►
    [August](https://googleprojectzero.blogspot.com/2025/08/)
    (1)
  + ►
    [July](https://googleprojectzero.blogspot.com/2025/07/)
    (1)
  + ►
    [May](https://googleprojectzero.blogspot.com/2025/05/)
    (3)
  + ►
    [April](https://googleprojectzero.blogspot.com/2025/04/)
    (1)
  + ►
    [March](https://googleprojectzero.blogspot.com/2025/03/)
    (1)
  + ▼
    [January](https://googleprojectzero.blogspot.com/2025/01/)
    (2)
    - [Windows Bug Class: Accessing Trapped COM Objects w...](https://googleprojectzero.blogspot.com/2025/01/windows-bug-class-accessing-trapped-com.html)
    - [Windows Exploitation Tricks: Trapping Virtual Memo...](https://googleprojectzero.blogspot.com/2025/01/windows-exploitation-tricks-trapping.html)

* ►
  [2024](https://googleprojectzero.blogspot.com/2024/)
  (12)
  + ►
    [December](https://googleprojectzero.blogspot.com/2024/12/)
    (3)
  + ►
    [November](https://googleprojectzero.blogspot.com/2024/11/)
    (2)
  + ►
    [October](https://googleprojectzero.blogspot.com/2024/10/)
    (2)
  + ►
    [June](https://googleprojectzero.blogspot.com/2024/06/)
    (3)
  + ►
    [April](https://googleprojectzero.blogspot.com/2024/04/)
    (2)

* ►
  [2023](https://googleprojectzero.blogspot.com/2023/)
  (11)
  + ►
    [November](https://googleprojectzero.blogspot.com/2023/11/)
    (1)
  + ►
    [October](https://googleprojectzero.blogspot.com/2023/10/)
    (1)
  + ►
    [September](https://googleprojectzero.blogspot.com/2023/09/)
    (1)
  + ►
    [August](https://googleprojectzero.blogspot.com/2023/08/)
    (4)
  + ►
    [April](https://googleprojectzero.blogspot.com/2023/04/)
    (1)
  + ►
    [March](https://googleprojectzero.blogspot.com/2023/03/)
    (1)
  + ►
    [January](https://googleprojectzero.blogspot.com/2023/01/)
    (2)

* ►
  [2022](https://googleprojectzero.blogspot.com/2022/)
  (17)
  + ►
    [December](https://googleprojectzero.blogspot.com/2022/12/)
    (1)
  + ►
    [November](https://googleprojectzero.blogspot.com/2022/11/)
    (3)
  + ►
    [October](https://googleprojectzero.blogspot.com/2022/10/)
    (1)
  + ►
    [August](https://googleprojectzero.blogspot.com/2022/08/)
    (1)
  + ►
    [June](https://googleprojectzero.blogspot.com/2022/06/)
    (3)
  + ►
    [May](https://googleprojectzero.blogspot.com/2022/05/)
    (1)
  + ►
    [April](https://googleprojectzero.blogspot.com/2022/04/)
    (3)
  + ►
    [March](https://googleprojectzero.blogspot.com/2022/03/)
    (2)
  + ►
    [February](https://googleprojec...