---
title: 针对一个疑似红队样本的详细分析
url: https://mp.weixin.qq.com/s?__biz=MzA4ODEyODA3MQ==&mid=2247489555&idx=1&sn=ee1954b4b463d53ce857ad924f99cbc9&chksm=902fb73ba7583e2def53e75e6ca06794aa32f868cec33d9dcadf1ccc90094cbca50725ac79b1&scene=58&subscene=0#rd
source: 安全分析与研究
date: 2024-11-26
fetch_date: 2025-10-06T19:19:58.515568
---

# 针对一个疑似红队样本的详细分析

![cover_image](https://mmbiz.qpic.cn/mmbiz_jpg/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCx0RqRbOxiaWfhBYEa2H2VqRZJmqEbGWqGpib0maQRY1jGAmtljdWnfvQ/0?wx_fmt=jpeg)

# 针对一个疑似红队样本的详细分析

pandazhengzheng

安全分析与研究

**安全分析与研究**

专注于全球恶意软件的分析与研究

前言概述

原文首发出处：

https://xz.aliyun.com/t/16318

先知社区 作者：熊猫正正

近日微信朋友发给笔者一个样本，说沙箱跑不出来，让笔者帮忙看看，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvC5aR38JWqGQCwllibDD0IPpzR09mrklPKlZejDCaSvx5KeEq0hRcMtlQ/640?wx_fmt=png)

分析完之后，发现有点意思，分享出来供大家参考学习。

详细分析

1.样本解压缩之后,恶意文件被设置为系统隐藏属性，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCxVr6g99iafHolkEZpNORfmtXSwgo5ASROGJt6BPtFGhdFRM01ic6Xa8A/640?wx_fmt=png)

2.恶意模块的编译时间为2024年10月15日，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCX2gNibIWM4eP6hveAKhQQMsXib2Y44icMOWM3ib1vVFSasAFRwhb51eCoA/640?wx_fmt=png)

3.采用白+黑的加载方式，加载恶意模块，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCfLyheGfOa2k8olqeTlkAPjKQDtXOp93XnK1OxyzI6aDcm8mUDVicxgA/640?wx_fmt=png)

4.通过分析发现它的恶意代码隐藏在cef\_enable\_highdpi\_support导出函数，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCooG9liaicrUA9NX136IkwxLnDLfnCDus8bZhp944yHjtyIIr6zibna6bw/640?wx_fmt=png)

5.跳转执行到恶意代码，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCZkyv14XELayad8UBDQWBP8lcO8fNRiczcDxvNeuXNHd6US0Md6ulK2w/640?wx_fmt=png)

6.定位同目录下的加密数据文件log.dat，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCfia2M7IFoR4Pw1SORHh1gu7f8icibl9zPVp3yA5408B18A84ZMy7ZGgqA/640?wx_fmt=png)

7.读取加密数据到内存当中，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCThxChURpxzFKE8JIobfST6DlibiayTI0bmje6gvBbvvVibu4J7sn5P8qg/640?wx_fmt=png)

8.解密加密的数据，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCShwIdReTrxPNZzBwqWQ8MSXGAHibdydUFsVuFIzlicBibkibmaKuLksk2Q/640?wx_fmt=png)

9.解密后的PayLoad，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvC0gZa4ofHlQkY4X25JAU3USrDsZOs7TYSJMAb6UG99wSrZW21Yr1Cfg/640?wx_fmt=png)

10.分配相应的内存空间，将解密的PayLoad拷贝到内存空间当中，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCcxeAO79GFicYRaltddnSMQgNoib8x23cwpn8NUFb2smGGxFVn8BHPhSw/640?wx_fmt=png)

11.跳转执行到解密的PayLoad，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCneUldXDsr4AWwt4ssUzurAdHsN8SmCG1InYNruIOJXseVWBMMMd8AQ/640?wx_fmt=png)

12.执行到PayLoad的主函数入口点，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCmbGkZlGO4OI0lEPgzjDbyaYtNYZIrQzaqNBAP21tveIbVrVVp4P28Q/640?wx_fmt=png)

13.获取环境变量和程序执行路径，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvC68qwib6PSeCXAw6xhULbZic9zRfPn0LwxzUcdG7WDicuG7DqgO2wmaXJA/640?wx_fmt=png)

14.如果程序运行路径不在指定的目录下，则将程序拷贝到指定的C:\Users\Public目录下，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCZfEKSe46mX8md64saT86JpSqPOPyuDkkTYkHJicX3iciasDzFibDbTTx8Q/640?wx_fmt=png)

15.然后启动WPS.exe程序，加载执行恶意模块，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCPgc6pKnGOzQNR2FzkmsSkppIz7MjOOruw7H51m3S5qINvNichm37AIA/640?wx_fmt=png)

16.最后打开同目录下的WORD文件word.docx欺骗受害者，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvC4rALcy1h14dN2xxFwhDdiaubtf6ibcFLzJ3msNQN8PbgDOw8UT4c7K0Q/640?wx_fmt=png)

17.创建线程执行Sleep函数反虚拟机对抗，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvC0jeSQVFTjNoLVPmhEUb7wHCVEyic4ffHOQTsl4ibTy8VA81MQyKy9R0w/640?wx_fmt=png)

18.获取VirtualAlloc函数地址，调用执行分配相应的内存空间，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCWegAabFSqm6EFic5oliamsHrgia4uu69FZM6wVianRzEww8hEgHJZUJMkQ/640?wx_fmt=png)

19.解密程序中加密的数据，相关的解密算法，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCXHCUu0ztztKibG0mvhKpW4rlzstE7QDlSzW6OdPWgwxJotjviaKSqKIA/640?wx_fmt=png)

20.解密之后的ShellCode代码，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCtzkdxHN70xWjfvxWT90PwvWZFUjibGibnDrdgUJ6ZX57uPMkGRzTfyOQ/640?wx_fmt=png)

21.将解密的ShellCode代码拷贝到分配的内存空间当中，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCOPOAQNfnI730icNVOIlaCcDj38SgxXptTzHTvWuvgoHJmbwwicicsZJAQ/640?wx_fmt=png)

22.执行解密的ShellCode数据，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCVKsYtlcUb0qTlJ3JysvYNQJWbWKQDrccpwiaaqy1tgciakXwGCuXibcmg/640?wx_fmt=png)

23.解密出来的ShellCode是一个CS后门，相关的配置信息，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCibdBjTVFTWYsYh4ueZQ04a6OOcQFmjwWqWPwKsdTI3HAia80bMqOMpgg/640?wx_fmt=png)

24.CS后门的c2域名为www.6xh2cwlp.sched.v1lego.tdnsvod1.cn，通过威胁情报平台查询，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCDPr5kULq1YHxS3H6l9PUMQj0lhIk076pHReMngtxO2UH70yzRo24ag/640?wx_fmt=png)

通过威胁情报关联分析，可以关联到两个相关的钓鱼样本，就是笔者分析的这个样本，疑似某红队样本。

威胁情报

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCqmeKibPlDLsX8DpYsib67zfFib9Ot2FHgKtMW77Q2TfufQHS1euTKzvsw/640?wx_fmt=png)

总结结尾

每年都会有很多新的红队样本出现，里面包含各种各样的安全技术，是一个不错的学习机会，对一些有意思的对抗样本都可以深入分析和研究。

安全分析与研究，专注于全球恶意软件的分析与研究，深度追踪全球黑客组织攻击活动，欢迎大家关注，获取全球最新的黑客组织攻击事件威胁情报。

![](https://mmbiz.qpic.cn/mmbiz_jpg/oibWJqH5OVmVkgebOFE6USnCJfQYzbBvCJxJuky7ObicatzHQia4icFibWs7rKoEz9no1079x0mW32nu9HibCVdLdYLA/640?wx_fmt=jpeg)

王正

笔名：熊猫正正

恶意软件研究员

长期专注于全球恶意软件的分析与研究，深度追踪全球黑客组织的攻击活动，擅长各种恶意软件逆向分析技术，具有丰富的样本分析实战经验，对勒索病毒、挖矿病毒、窃密、远控木马、银行木马、僵尸网络、高端APT样本都有深入的分析与研究

预览时标签不可点

阅读原文

![]()

微信扫一扫
关注该公众号

继续滑动看下一个

轻触阅读原文

![](http://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVcFgYKtoVnKR7h3pkl3AyxwS0l7iagicAJnYjEQhwIuZgR3RR65DLpJh2TGZS82DY7CjsBUmiaAl7BQ/0?wx_fmt=png)

安全分析与研究

向上滑动看下一个

知道了

![]()
微信扫一扫
使用小程序

取消
允许

取消
允许

取消
允许

×
分析

![跳转二维码]()

![作者头像](http://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVcFgYKtoVnKR7h3pkl3AyxwS0l7iagicAJnYjEQhwIuZgR3RR65DLpJh2TGZS82DY7CjsBUmiaAl7BQ/0?wx_fmt=png)

微信扫一扫可打开此内容，
使用完整服务

：
，
，
，
，
，
，
，
，
，
，
，
，
。

视频
小程序
赞
，轻点两下取消赞
在看
，轻点两下取消在看
分享
留言
收藏
听过