---
title: 实战|记一次2022某地HVV中的木马逆向分析
url: https://www.secpulse.com/archives/194708.html
source: 安全脉搏
date: 2023-01-07
fetch_date: 2025-10-04T03:13:09.709036
---

# 实战|记一次2022某地HVV中的木马逆向分析

[![](https://www.secpulse.com/wp-content/themes/secpulse2017/img/logo-header.png)](https://www.secpulse.com "安全脉搏")

* [首页](https://www.secpulse.com/)
* [分类阅读](https://www.secpulse.com/archives/category/category)

  #### 脉搏文库

  - [内网渗透](https://www.secpulse.com/archives/category/articles/intranet-penetration)
  - |
  - [代码审计](https://www.secpulse.com/archives/category/articles/code-audit)
  - |
  - [安全文献](https://www.secpulse.com/archives/category/articles/sec-doc)
  - |
  - [Web安全](https://www.secpulse.com/archives/category/articles/web)
  - |
  - [移动安全](https://www.secpulse.com/archives/category/articles/mobile-security)
  - |
  - [系统安全](https://www.secpulse.com/archives/category/articles/system)
  - |
  - [工控安全](https://www.secpulse.com/archives/category/articles/industrial-safety)
  - |
  - [CTF](https://www.secpulse.com/archives/category/exclusive/ctf-writeup)
  - |
  - [IOT安全](https://www.secpulse.com/archives/category/iot-security)
  - |

#### 安全建设

+ [业务安全](https://www.secpulse.com/archives/category/construction/businesssecurity)
+ |
+ [安全管理](https://www.secpulse.com/archives/category/construction/securityissue)
+ |
+ [数据分析](https://www.secpulse.com/archives/category/construction/bigdata)
+ |

#### 其他

+ [资讯](https://www.secpulse.com/archives/category/news)
+ |
+ [漏洞](https://www.secpulse.com/archives/category/vul)
+ |
+ [工具](https://www.secpulse.com/archives/category/tools)
+ |
+ [人物志](https://www.secpulse.com/archives/category/people)
+ |
+ [区块链安全](https://www.secpulse.com/archives/category/exclusive/block_chain_security)
+ |
+ [安全招聘](https://www.secpulse.com/archives/category/hiring)
+ |

- [安全问答](https://www.secpulse.com/newpage/question_list)
- [金币商城](https://www.secpulse.com/shop?donotcachepage=c010349fd98847cb9d6e07d3cbc19288)
- [安全招聘](https://www.secpulse.com/archives/category/hiring)
- [活动日程](https://www.secpulse.com/newpage/activity)
- [live课程](https://www.secpulse.com/live)
- [企业服务](https://duoyinsu.com/service.html)
- [插件社区](https://x.secpulse.com/)

小程序

![脉搏小程序](https://www.secpulse.com/wp-content/themes/secpulse2017/img/wxchat.jpg)
[登录](https://www.secpulse.com/user_login)
|
[注册](https://www.secpulse.com/user-register)

# 实战|记一次2022某地HVV中的木马逆向分析

[Web安全](https://www.secpulse.com/archives/category/articles/web)

[蚁景网安实验室](https://www.secpulse.com/newpage/author?author_id=37244)
![]( https://www.secpulse.com/wp-content/themes/secpulse2017/img/renzheng2.png)

2023-01-06

19,402

声明：本文仅限于技术讨论与分享，严禁用于非法途径。若读者因此作出任何危害网络安全行为后果自负，与本号及原作者无关。

#### 前言

事情是这样的，国庆前期某地HVV，所以接到了客户通知他们收到了钓鱼邮件想要溯源

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969674.png "null")

直接下载文件逆向分析一波。钓鱼邮件，图标什么的做的还是挺逼真的，还真的挺容易中招的，但是这里的bug也明显，丹尼斯没有客户端，百度一下能够辨别这是钓鱼的。

#### 逆向分析

查壳工具`DIE`看是否加壳

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969675.png "null")

当然其他查壳工具也可以exeinfope等，看到的东西不一样

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969676.png "null")

可以看到是64位的应用，无壳，IDA静态分析

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-16729696761.png "null")

直接进入主函数，直接F5逆向main函数c代码

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969678.png "null")

主函数中使用的函数比较少

```
int __cdecl main(int argc, const char **argv, const char **envp)
{
  HRSRC ResourceW; // rbx
  HGLOBAL Resource; // rbp
  signed int v5; // eax
  size_t v6; // rsi
  size_t v7; // rcx
  void *v8; // rdi

  ResourceW = FindResourceW(0i64, (LPCWSTR)0x66, L"DATA");
  Resource = LoadResource(0i64, ResourceW);
  v5 = SizeofResource(0i64, ResourceW);
  v6 = v5;
  v7 = (unsigned int)(v5 + 1);
  if ( v5 == -1 )
    v7 = -1i64;
  v8 = malloc(v7);
  memset(v8, 0, (int)v6 + 1);
  memcpy(v8, Resource, v6);
  sub_140001070(v8);
  return 0;
}
```

简单来看就是先查找资源，DATA应该为加密的`shellcode`，加载资源赋

给`Resource`,计算资源空间大小，`malloc`分配空间大小，`memset` 将申请的内存初始化为0，`memcpy`函数的功能是从源内存地址的起始位置开始拷贝若干个字节到目标内存地址中,跟进`sub_140001070`

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-16729696781.png "null")

可以看到反汇编之后在第52行创建进程，在56行分配虚拟内存，60行写入内存，61行创建线程，这里创建的线程即为恶意进程。这里使用动态调试x96dbg验证我们的分析另外，需要分析一下外联的地址以及注入的进程是什么，64位的应用使用x64dbg，依次下断点

简单计算一下地址，IDA的起始地址为`00000001400015C4`

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969679.png "null")

`FindResourcew`地址为`00000001400015C4`

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969681.png "null")

在x64dbg中找到起始地址`00007FF638B915C4`

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969683.png "null")

根据偏移量跳转下断点

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969685.png "null")

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969686.png "null")

F7按步调试

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969691.png "null")

在`loadResource`函数中追踪内存

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969692.png "null")

这里加载的是`DATA`的内容，即为加密的`shellcode`,我们直接用`Resouce hacker`直接查看一下恶意进程`dennis.exe`的DATA内容

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969694.png "null")

说明我们的分析没有问题，继续向下调试

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969696.png "null")

因为这个应用比较小，所以代码量也不大，f5反编译之后可以直接找到函数下断点，这里不需要计算偏移量了，计算方法跟上面差不多。

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969700.png "null")

调试走到这里，可以发现走的是循环

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969701.png "null")

可以明显的看到有`xor`异或指令，这里对shellcode即DATA的内容做异或，异或的对象为`byte ptr`指向的地址，内存数据为`key`,那么key的内容为

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969703.png "null")

因为是按字节异或所以这里异或的内存应该为78，整个循环异或的key应该为`12345678`，shellcode加密的时候应该用的key为12345678加密的，所以这里解密使用key去解密，跳出循环RIP一下，到断点`CreateProcessW`

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969705.png "null")

可以清晰的看到注入的进程为`C:\windwos\system32\svchost.exe`，向下调试

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969707.png "null")

申请虚拟空间内存，然后向下为写入内存

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969708.png "null")

解密完成后写入内存，所以在这里是可以看到外联的ip地址或者说是域名的，这里使用的是ip，查询之后发现是`TX云`的服务器。

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969709.png "null")

在向下就是创建进程起服务`svchost.exe`了

#### 小结

钓鱼使用的服务器ip地址是TX云怕是报警之后应该可以溯源到本人的真实身份了吧，毕竟现在国内运营商都需要实名，如果用的国内域名也都是实名的不管是否有CDN,不过这种级别的HVV也没必要。第一次逆向分析，多亏了大佬指点，步履维艰，如有错误欢迎指出。

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194708-1672969711.gif)

靶场实操，戳“阅读原文“

**本文作者：[蚁景网安实验室](newpage/author?author_id=37244)**

**本文为安全脉搏专栏作者发布，转载请注明：**[**https://www.secpulse.com/archives/194708.html**](https://www.secpulse.com/archives/194708.html)

Tags: [HW](https://www.secpulse.com/archives/tag/hw)、[木马](https://www.secpulse.com/archives/tag/%E6%9C%A8%E9%A9%AC)、[溯源](https://www.secpulse.com/archives/tag/%E6%BA%AF%E6%BA%90)、[逆向分析](https://www.secpulse.com/archives/tag/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90)、[钓鱼邮件](https://www.secpulse.com/archives/tag/%E9%92%93%E9%B1%BC%E9%82%AE%E4%BB%B6)

点赞：
2
[评论：0](#goComment)
收藏：
0

*新浪微博
QQ空间
微信扫一扫*

### 相关文章

* [![某查询和短信轰炸样本的分析](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-con...