---
title: 【技术分享】TendrilStaller：比特币块延迟攻击
url: https://mp.weixin.qq.com/s?__biz=MzA5ODA0NDE2MA==&mid=2649781921&idx=1&sn=aa574d53f02b282e8b6012072d74ebdb&chksm=889346cebfe4cfd85fc7650746284a5965584ecf4c0b62f0168b94ace183c603aa9a2fca26e8&scene=58&subscene=0#rd
source: 安全客
date: 2023-01-06
fetch_date: 2025-10-04T03:10:19.765081
---

# 【技术分享】TendrilStaller：比特币块延迟攻击

![cover_image](https://mmbiz.qpic.cn/mmbiz_jpg/Ok4fxxCpBb6z2QDjPsRv9qITyBM3oFCgstTibsanD3XQcxVQIunlt9jiaxG1yVOCp2fiabwaF9E8ia4M8aGuv1X5gQ/0?wx_fmt=jpeg)

# 【技术分享】TendrilStaller：比特币块延迟攻击

原创

CDra90n

安全客

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ok4fxxCpBb6z2QDjPsRv9qITyBM3oFCgdzTTuIibFypDuBMoia4TMqh96b8hQAz6A4b1RkVw3gibIbiaap6Xfm78zw/640?wx_fmt=jpeg)

介绍了TendrilStaller，这是一种针对比特币对等网络的日蚀攻击。TendrilStaller使攻击者能够将块传播到受害者的时间延迟10分钟。攻击者阻碍了受害者获取最新的区块链状态。仅需要一个比特币完整节点和两个轻量级节点即可执行攻击。轻量节点执行完整比特币节点功能的子集。该攻击利用了2016年4月引入的最新块传播协议。该协议规定一个比特币节点选择3个邻居，这些邻居可以主动发送新块。这些邻居是根据它们最近在快速提供块中的性能来选择的。攻击者通过使攻击节点比其他邻居更快地向受害者发送有效块，从而诱使受害者选择3个攻击节点。

为此，攻击者部署了一些轻量级的节点，以便攻击者本身更快地接收新的区块。然后，攻击者进行攻击，以延迟传播到受害者的信息块。在当前默认比特币协议之上实施攻击，在全球多个位置部署攻击节点，并随机选择受害者节点。根据攻击者和受害者之间的往返时间，可能会将50％-85％的块延迟给受害者。进一步表明，采用轻量级节点平均可使攻击概率平均提高/ 5％。最后，提出了几种缓解日食攻击的对策。

**1**

**Introduction**

截至2019年3月，比特币是使用最广泛的加密货币，流通的比特币超过/ 700万，市值达到760亿美元。比特币的基础技术区块链被认为可用于智能合约，医疗保健，供应链，审核系统和数据存储系统。

早期的作品分析了比特币的安全性和可靠性。Nakamoto表明，如果一个参与方拥有超过51％的总挖矿能力，则比特币将被彻底破坏。自私挖矿使攻击者仅能指挥总采矿能力的33％以获得显着优势。双花攻击，扣块攻击和拒绝服务攻击都是利用比特币的弱点牟取暴利。这些研究大多数都假设大多数矿工几乎都可以立即使用比特币网络中的区块。

网络层面攻击针对比特币的点对点网络。网络层面攻击的受害者可能无法及时收到最新的区块链状态，从而导致他们将采矿能力浪费在陈旧的区块上。因此，攻击者可以获得更大的优势。Heilman等人提出了对比特币对等网络的日蚀攻击[1]。攻击使攻击者将受害节点与网络的其余部分隔离开。攻击者需要控制大量IP地址并操作大量攻击节点。攻击节点不断启动与受害者的连接，并向受害者发送精心制作的addr消息。受害者的未来邻居表中将填充由攻击者控制的IP地址。受害者重新开始之后，所有邻居都将受到攻击者的控制，可能性很高。攻击者然后篡改发送给受害者的消息，以操纵其对区块链的看法。

Apostolaki等人提出了一种BGP劫持攻击[2]，该攻击类似地导致比特币网络的划分，从而导致特定受害者的隔离。该攻击利用BGP劫持来拦截受害者节点的连接。自治系统（AS）级别的攻击者发送恶意路由公告。目的地为受害者或来自受害者的流量被发送到错误的位置。攻击者通过丢弃流量隔离受害节点。攻击者还可以通过操纵少量的比特币消息来延迟发送给受害者的信息。

以上两种攻击适合具有足够IP资源或网络带宽的AS级攻击者。成功攻击的成本可能很高。[1]中的攻击要求攻击者操作大量具有不同公共IP地址的比特币节点。[21]中的攻击要求攻击者接收并中继所有被劫持的AS（不仅是受害者节点）的互联网流量（不一定与比特币相关）。与[1,2]不同，本文攻击只需要3个比特币节点即可执行攻击。这些攻击节点不需要具有不同的公共IP地址。可以从防火墙后面的节点执行攻击。

Gervais等人[3]提出了一种块延迟攻击。攻击者可以在相当长的时间内延迟将块传播到特定节点，而不会引起网络分区。该攻击利用了历史块传播协议。比特币节点广播新区块的广播。当节点收到同一块的多个广播时，它仅向发送广播的第一个邻居请求该块。因此，[3]中的攻击节点试图成为最早向受害人发送新区块广播的节点。一旦受害者从攻击节点请求阻止，受害者就会暂时放弃向其他邻居请求相同阻止的请求。在攻击节点实际发送该区块之前，受害者将不会获得新的区块。getdata请求的超时为20分钟。因此，攻击者可能会将向受害者提供新块的时间延迟20分钟。此攻击对运行版本高达vO.IO的比特币软件的受害节点有效。比特币已经发展了多年。已经采用了新的块传播协议，该协议使[3]中的攻击变得过时了。

新的块传播协议允许节点V选择最多3个高带宽（HB）模式邻居[4]。HB邻居列表称为HB邻居（HBN）列表。HB邻居不发送新区块的广播；取而代之的是，他们一收到V，便立即向V发送一个新的，未经请求的块。此更改减轻了原始攻击。即使攻击节点设法第一个将广播发送给V，然后延迟了对V的getdata请求的响应，V的非攻击HB邻居之一也可以稍后将块自动发送给V。尽管有A的延迟，V仍然收到该新块而没有明显的延迟。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb6z2QDjPsRv9qITyBM3oFCg146IqTxVGyr7uakH3OBVFFRq3zNEGN5nHibENvwFAibmB2LibJeh5DZPQ/640?wx_fmt=png)

上图显示了TendrilStaller的设置。将攻击节点定义为攻击者控制的节点，将非攻击节点定义为公共比特币网络中的所有其他节点。攻击者部署两种类型的攻击节点，即，完整攻击节点和轻型攻击节点。完整的攻击节点建立与受害者的连接并执行实际攻击。轻量级攻击节点以两种模式中的任何一种进行操作。在模式1下，轻量级攻击节点不会连接到受害者。它们充当完整攻击节点的代理，以更快地接收新块。在模式2中，轻量级攻击节点也参与了攻击。上图和下图描述了在模式I下运行的轻型攻击节点的攻击。

共有3个完整攻击节点，分别称为a1，a2和a3。攻击分为两个阶段。每个完全攻击节点都会启动到受害者节点V的连接。在阶段I中，攻击者诱使受害者选择所有3个完全攻击节点作为其HB邻居。节点V根据最近发送块规则选择其HB邻居。如果邻居向V发送了新的有效块，则V将该邻居添加到HBN列表中。如果已有3个HBN邻居，则最早的邻居将从HB列表中删除。a1，a2和a3继续向受害者发送新的有效块，直到受害者的HBN列表由3个完整的攻击节点组成，如下图a和下图b所示。在阶段2中，完整攻击节点的行为与[3]中的攻击类似。由于在第2阶段中没有非攻击邻居向V发送未经请求的块，因此完整的攻击节点会延迟将块传播到受害者。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb6z2QDjPsRv9qITyBM3oFCguAF8semicC4k3OicsUfRR71zBhndpnvgylxRynfGs74enZACLWyjl6iaw/640?wx_fmt=png)

•介绍了TendrilStaller，这是一种阻止延迟攻击，可能会在相当长的时间内延迟将阻止块传播到受害者。实现了 https://github.comlkewangcmu/block\_delay\_attack 中发布的攻击代码。

•在公共比特币网络中验证攻击算法。证明在攻击过程中，可能有多达50-85％的块延迟给受害者。进一步表明，采用轻量级节点可使攻击概率平均提高15％。

•提出了一些缓解TendrilStaller的对策。表明这些对策可能会使块延迟攻击变得不可行。

**2**

**Historical Mechanism of Block Propagation and Block Delay Attack**

### **A.比特币**

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb6z2QDjPsRv9qITyBM3oFCg3YFUA8PicceDJRiamI6OiccNjl8OPm2EicVUcg75OpxNcDXickwPmgrvgnQ/640?wx_fmt=png)

比特币实施了一个区块链协议来记录和序列化用户之间的交易。上图显示了每个块与上一个块的关系，每个块都包含前一个的哈希。通过找到令人满意的随机数，计算节点（或矿工）彼此竞争，成为第一个构建新区块的人。矿工通过点对点网络相互连接，通过该网络广播新建的区块。矿工然后独立验证区块并开始处理下一个区块。在本文的其余部分中，将矿工和节点互换使用。每个矿工都保留区块链的本地副本，称为矿工所感知的视图。由于区块传播延迟，矿工对区块链的看法可能不同。区块链的不同视图包含不同顺序的不同交易集。如果一个矿工没有及时收到最新的区块，其观点将与大多数矿工的观点不同。该矿工将浪费其采矿能力，即使该矿工成功地成功建造了一个新的区块，该区块也不会被其他矿工接受，并且不会对该区块给予任何奖励。

### **B.比特币对等网络**

比特币节点通过TCP / IP相互连接。每个节点维护一个尝试过的新表来存储公共IP。尝试表存储节点最近建立连接的邻居的[P个地址。新表存储可能与之建立将来连接的节点的地址。当节点首次加入网络时，最初会使用DNS服务器的信息填充新表。节点还通过addr消息交换已知节点的P个地址，以定期更新其新表。当节点需要建立新连接时，它会从两个表中随机选择。在默认配置中，一个比特币节点从两个表中最多选择8个节点来建立连接，称为传出连接。一个节点还接受其他节点发起的连接，称为传入连接。一个节点总共可以有125个连接。

### **C.矿池**

成为第一个开采块的人的可能性很小。单个矿工的收益是惊人的。因此，矿工组成了矿池。池的成员不与池外的节点建立连接。相反，它们仅从池管理器接收信息。采矿池部署了多个池网关节点，以将采矿池与公共比特币网络连接。已知池网关节点比默认节点具有更多的连接，因为它们必须确保挖掘池的低延迟中继块和事务。

### **D.历史块中继模型**

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb6z2QDjPsRv9qITyBM3oFCgmu1JicmicVolAJ1bswCHvAWmRQQnviaG92T2odoSKQB5OBPRlZmVZUkzA/640?wx_fmt=png)

比特币协议实现了各种方法来最小化带宽消耗。首先，比特币采用如上图所示的基于广播的块中继机制。当节点cfl通过挖掘新块本身或从其邻居那里接收到一个新块来获知新块时，它会向其其他邻居广播inv消息，以便宣布新块的存在。对于邻居N，如果它还没有该块，则将getdata消息发送到cA以请求该块。然后，节点cA用实际块响应N。与在接收到新块后直接发送新块相比，通告优先方法减少了邻居已经拥有的块的冗余块传输。一个块可以大到1MB，而inv消息仅包含40字节块的哈希。其次，节点仅响应其收到的第一个广播。它暂时停止从其他邻居请求相同的块，直到先前的getdata请求超时。这样可以节省邻居的出站带宽。最后，比特币对getdata请求采用20分钟的超时时间（现在减少到10分钟）。比特币节点配备了不同的网络带宽。出站带宽有限的节点需要更长的时间来传输块。在网络或网络拥塞较慢的情况下，较长的超时可以避免不必要的块重传。

### **E.原始块延迟攻击**

块延迟攻击如下进行。攻击者cA首先设法成为向受害人V发送块B（inv消息）的广播的第一个节点。攻击节点实现了两种方法，以便第一个发送广播。

•首先，攻击节点比默认的比特币节点建立更多的连接。更多的连接使攻击节点可以在挖掘新块时更快地了解它。

•其次，攻击节点在收到新块后立即对其进行公告，而无需验证其正确性。

默认的比特币节点在向邻居宣布新区块之前会对其进行完全验证。验证可防止在网络中传播格式错误的块。验证过程涉及一系列步骤，并且需要花费大量时间。它检查该块是否包含正确的工作量证明，是否正确设置了该块的挖掘难度等等。对于该块中的每个事务，验证还检查事务格式是否正确以及事务的所有输入是否有效，未花费的事务输出（UTxO）。在Amazon EC2双核实例上，验证平均需要174毫秒。绕过验证过程平均可使攻击者获得174毫秒的优势。

如果攻击节点成功成为第一个发送inv消息的节点，则受害人V然后向A发送一个getdata请求，并暂时阻止其他邻居请求B。攻击者A在收到受害者的getdata消息后等待了足够长的时间。getdata请求的超时通常为20分钟。攻击者可以将对受害者的阻止交付延迟至少20分钟。平均而言，每10分钟开采一次区块。到受害者收到块时，它会比最长链条落后2个块。

**3**

**New Model of Block Propagation**

比特币协议已经发展了多年。新的块传播协议已被采用，以使网络更具可扩展性，感兴趣的是四项新措施。

### **A.新措施1：直接块头公告**

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb6z2QDjPsRv9qITyBM3oFCgHTlAoK2pKSSDf77zg76YZHDPXl4TFE3RZEibZJntFH3rdB44icibb2vBQ/640?wx_fmt=png)

由于20 IS中的v0.1 0.0版本，节点仅在收到该块的有效头后才请求该块。收到inv消息后，节点N首先发送agetheaders消息以请求该块的头。N接收并验证头消息后，它发送getdata请求。有效的头消息应包含具有正确工作量证明并构建在当前区块链之上的块头。以前的1.5往返时间（RTT）增加到2.5 RTT。为了减少传播延迟，从v0.12.0版本开始，建议直接头声明并将其添加到比特币协议中。如上图所示，节点A在获知新块时会直接发送头消息。与以前一样，往返时间减少到1.5 RTT。

### **B.新措施2：紧凑块中继**

对于在邻居之前收到一个块的节点，块中继会导致明显的出站带宽峰值。一个节点接收到比其邻居更早的块需要多次发送新块，一次发送给每个邻居。这样的带宽尖峰延迟了块的传输。结合一个节点一次仅向一个邻居请求同一块的事实，块传播时间将增加。

提出紧凑块中继以节省带宽，高达1 MB的完整块包含一个80字节的头和一个事务列表。这些大多数事务在块传播之前已经可供其他节点使用。代替发送完整的块，节点可以发送该块的精简版。紧凑块由块头，交易ID列表和一小部分预填充交易组成。

•块头包含80个字节，与常规块相同。

•交易ID是交易的哈希值。当接收到一个紧凑块时，接收者应该从接收者自己的内存中事务表中查找实际事务。

•预设交易是常规交易。构造紧凑块时，如果发送方认为接收方未看到某些交易，则发送方会将实际交易放入紧凑块中，而不是交易哈希中。

紧凑块中继的目的是发送最少的数据，同时为接收器提供足够的信息以重构块。如果接收者不知道某个交易ID，并且该交易不在预填充交易集中，则接收者随后会请求该特定交易。在最佳情况下，仅需0.5 RTT即可中继一个块。在最坏的情况下，紧凑块中缺少事务时，需要进行一次额外的往返。它总共需要1.5个RTT，与直接头通告相同，但是带宽消耗要少得多。紧凑块是响应getdata请求而发送的，或者是在HB模式下主动发送的（下一部分）。

### **C.新措施3：高带宽（HB）模式邻居**

节点选择3个邻居作为高带宽（HB）邻居。将HB邻居列表称为HBN列表。节点N指示其HB邻居主动发送紧凑块。将此类块称为未经请求的紧凑块。将邻居添加到HBN列表时，N向该邻居发送sendcmpct（true）消息。类似地，如果从HBN列表中删除了邻居，则N向被驱逐的邻居发送sendcmpct（false）消息，指示其停止发送未经请求的紧凑块。将HBN列表限制为仅3个邻居可以减少带宽消耗。选择m个HB邻居会导致传输m-1个冗余紧凑块，因为所有HB邻居在接收到它时都会发送一个新的紧凑块。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb6z2QDjPsRv9qITyBM3oFCg2K91ORsREowopoKcV5K4juPAQALBsMYEicsESVuG3tdRPQjxrNjxs9g/640?wx_fmt=png)

如上图所示，HB邻居cA通过直接发送紧凑块将新块中继到N。如有必要，节点N进一步发送getblocktxn消息以请求丢失的事务。然后，CA用blocktxn消息进行响应。节点N验证该块，然后更新cA的最后一个块发送时间。发送的最后一个块时间戳记录了cA向节点N发送新的有效块时的最后一次时间戳。在将新的HB邻居添加到列表中的情况下，此时间戳用于确定将淘汰哪个HB邻居。如图所示，当非HB邻居B获知一个新块时，将发生以下事件序列。

1.B发送块头消息以通告新块。

2.如果节点N之前从未听说过此块头，则N随后发送一个getdata请求以请求紧凑块。

3.B响应紧凑块。

4.如果节点N错过紧凑块中的某些事务，则将交换getblocktxn / blocktxn消息。

N更新其HBN列表以包括节点E。根据其上一个发送的上一个时间戳，将先前的HB邻居从列表中逐出。

另外，如果满足以下附加要求，则HB邻居cA仅向其邻居N发送紧凑块。

•RI：节点cA认为N没有当前块。例如，N一定没有将此块通告给A。这是为了避免发送不必要的紧凑块。

•R2：节点cA认为节点N知道当前块的前一个块。例如，节点N已将前一个块通知给节点A，或者节点A之前也已将前一个块发送给节点N。这是为了确保节点N在接收紧凑块时能够验证和重建实际块。

### **D.新措施4：缩短块下载超时**

自v0.10.5版本以来，比特币协议缩短了块下载超时。基本超时值为10分钟。对于每个额外的并行getdata请求，超时将增加5分钟。这是为了防止由于节点自身的下游链路饱和而导致对等节点超时。

### **E.对原始攻击的影响**

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb6z2QDjPsRv9qITyBM3oFCgtq2UErB16UibUxTRHWyjAiabVprFU2AXtib6zibfG4YxOjVVCaM817upAg/640?wx_fmt=png)

使用新的块传播协议不可能在块延迟攻击。攻击节点不知道受害者是否选择了其HB邻居。在常见情况下，如果有HB邻居向受害人V发送未经请求的紧凑块，则攻击将失败。如上图所示，攻击节点A设法成为第一个发送块头消息的对象，然后延迟了对受害者的getdata请求的响应。HB邻居N随后向受害人V发送未经请...