---
title: HTTP3 RFC 9114 发布，深入剖析HTTP3协议（一）
url: https://www.4hou.com/posts/wgxw
source: 嘶吼 RoarTalk – 网络安全行业综合服务平台,4hou.com
date: 2023-05-12
fetch_date: 2025-10-04T11:39:06.585749
---

# HTTP3 RFC 9114 发布，深入剖析HTTP3协议（一）

HTTP3 RFC 9114 发布，深入剖析HTTP3协议（一） - 嘶吼 RoarTalk – 网络安全行业综合服务平台,4hou.com

[![](https://www.4hou.com/sihou/images/new4hou/newlogoss.png)](https://www.4hou.com)

* [首页](https://www.4hou.com)
* [企业中心](https://www.4hou.com/corp/newindex)
* [产业研究院](https://www.4hou.com/real-time)

![](https://www.4hou.com/sihou/images/new4hou/search-icon.png)

[投稿](https://www.4hou.com/contribute)

[登录](https://www.4hou.com/login)
  |
[注册](https://www.4hou.com/register)

* 导读 ▾
* [活动](https://www.4hou.com/newticket)
* [专题](https://www.4hou.com/category/special)
* [图谱](https://www.4hou.com/atlas/index)
* [报告](https://www.4hou.com/new-report-info)
* [嘶票](https://www.4hou.com/tickets)
* [嘶货](https://www.4hou.com/shop)
* [企业查询](https://www.4hou.com/corp/new-search-company)
* [招聘](https://www.4hou.com/recruit)![](https://www.4hou.com/sihou/images/1561626446625934.png)

* [新闻](https://www.4hou.com/category/news)
* [行业](https://www.4hou.com/category/industry)
* [趋势](https://www.4hou.com/category/observation)
* [访谈](https://www.4hou.com/category/people)
* [漏洞](https://www.4hou.com/category/vulnerable)
* [WEB安全](https://www.4hou.com/category/web)
* [业务安全](https://www.4hou.com/category/business)
* [系统安全](https://www.4hou.com/category/system)
* [内网渗透](https://www.4hou.com/category/penetration)
* [勒索软件](https://www.4hou.com/category/typ)
* [安全工具](https://www.4hou.com/category/tools)

# HTTP3 RFC 9114 发布，深入剖析HTTP3协议（一）

lucywang
[技术](https://www.4hou.com/category/technology)
2023-05-11 12:00:00

![](https://img.4hou.com/article/%E6%B5%8F%E8%A7%88.png)141414

收藏

导语：本文档描述了 HTTP 语义在 QUIC 上的映射。本文还介绍了 QUIC 包含的 HTTP/2 功能，并描述了如何将 HTTP/2 扩展移植到 HTTP/3。

QUIC 传输协议具有 HTTP 传输所需的几个特性，例如stream multiplexing、每个流的流控制和低延迟连接建立。本文档描述了 HTTP 语义在 QUIC 上的映射。本文还介绍了 QUIC 包含的 HTTP/2 功能，并描述了如何将 HTTP/2 扩展移植到 HTTP/3。

**简介**

HTTP语义([HTTP])在互联网上广泛应用于各种服务。这些语义最常用于HTTP/1.1和HTTP/2。HTTP/1.1被用于各种传输和会话层，而HTTP/2主要用于TCP上的TLS。HTTP/3在一个新的传输协议上支持相同的语义：QUIC。

**1.1 HTTP的早期版本**

HTTP/1.1 ([HTTP/1.1])使用空格分隔的文本字段来传递HTTP消息。虽然这些交换是人类可读的，但使用空格进行消息格式化会导致解析复杂性和对变体行为的过度容忍。

由于HTTP/1.1不包括多路复用层，因此通常使用多个 TCP 连接来并行处理请求。然而，这对拥塞控制（congestion control）和网络效率有负面影响，因为 TCP 不跨多个连接共享拥塞控制。

HTTP/2 引入了一个二进制帧和多路复用层，在不修改传输层的情况下改善了延迟。然而，由于HTTP/2的多路复用的并行特性对TCP的丢失恢复机制是不可见的，因此丢失或重新排序的数据包会导致所有活动事务都经历停顿，无论该事务是否直接受到丢失数据包的影响。

**1.2 委托给 QUIC**

QUIC 传输协议结合了stream multiplexing和每个流的流控制，类似于HTTP/2帧层提供的。通过提供流级别的可靠性和整个连接的拥塞控制，与TCP映射相比，QUIC有能力提高HTTP的性能。QUIC还在传输层合并了TLS 1.3 ([TLS])，提供了与在TCP上运行TLS相当的机密性和完整性，并改善了TCP快速打开([TFO])的连接设置延迟。

本文定义了 HTTP/3：HTTP 语义在 QUIC 传输协议上的映射，大量借鉴了 HTTP/2 的设计。 HTTP/3 依赖于 QUIC 来提供数据的机密性和完整性保护；对等认证；可靠、有序、按流交付。在将流生命周期和流控制问题委托给 QUIC 时，每个流都使用类似于 HTTP/2 帧的二进制帧。 QUIC 包含一些 HTTP/2 功能，而其他功能则在 QUIC 之上实现。

**2. HTTP / 3协议概述**

HTTP/3使用QUIC传输协议和类似于HTTP/2的内部帧层为HTTP语义提供了传输。

一旦客户端知道某个终端存在 HTTP/3 服务器，它就会打开一个 QUIC 连接。 QUIC 提供协议协商、基于流的多路复用和流控制。

在每个流中，HTTP/3 通信的基本单位是一个帧。每种帧类型都有不同的用途。例如，HEADERS 和 DATA 帧构成了 HTTP 请求和响应的基础）。适用于整个连接的帧在专用控制流上传输。

请求的多路复用是使用QUIC流抽象来执行的，这在[QUIC- transport]的第2节中描述。每个请求-响应对使用一个QUIC流。流之间是相互独立的，所以一个流被阻止或丢失不会影响其他流的进程。

服务器推送是HTTP/2中引入的一种交互方案，它允许服务器在客户端发出指定请求之前向客户端推送一个请求-响应交换。这就权衡了网络使用和潜在的延迟增益。一些HTTP/3帧被用来管理服务器推送，例如PUSH\_PROMISE， MAX\_PUSH\_ID和CANCEL\_PUSH。

与 HTTP/2 一样，请求和响应字段被压缩以进行传输。因为 HPACK ([HPACK]) 依赖于压缩字段部分的顺序传输（QUIC 不提供保证），所以 HTTP/3 用 QPACK ([QPACK]) 替换了 HPACK。 QPACK 使用单独的单向流来修改和跟踪字段表状态，而编码字段部分引用表的状态而不修改它。

**3.连接设置和管理**

**3.1 发现HTTP/3终端**

HTTP依赖权威的概念响应：在给定目标资源在响应消息由源服务器发起（或在其方向）时的状态的情况下，该响应已被确定为对该请求最合适的响应在目标 URI 中标识。

“https”方案将授权与拥有证书相关联，客户端认为该证书对于由 URI 的授权组件标识的主机是可信赖的。在 TLS 握手中接收到服务器证书后，客户端必须验证证书是否与URI的源服务器匹配。如果证书无法针对 URI 的源服务器进行验证，则客户端不得认为服务器对该源具有权威性。

客户端可以尝试通过将主机标识符解析为 IP 地址来尝试访问具有“https”URI 的资源，在指定端口上建立到该地址的 QUIC 连接（包括如上所述的服务器证书验证），并通过该安全连接向服务器发送以URI为目标的HTTP/3请求消息。除非使用其他机制来选择HTTP/3，否则在 TLS 握手期间在应用层协议协商扩展中使用令牌“h3”。

连接问题(例如，阻止UDP)可能导致无法建立一个QUIC连接；在这种情况下，客户端应该尝试使用基于 TCP 的 HTTP 版本。

服务器可以在任何 UDP 端口上提供 HTTP/3；替代服务广告始终包含明确地端口，并且 URI 包含与方案关联的明确地端口或默认端口。

**3.1.1 HTTP替代服务**

HTTP 源可以使用“h3”ALPN 令牌通过 Alt-Svc HTTP 响应头字段或 HTTP/2 ALTSVC 帧 ([ALTSVC]) 通告等效 HTTP/3 终端的可用性。

例如，在HTTP响应中，通过包含以下标头字段，可以表明HTTP/3在UDP端口50781上相同主机名是可用的：

Alt-Svc: h3=":50781"

在接收到表示HTTP/3支持的Alt-Svc记录时，客户端可以尝试建立到指定主机和端口的QUIC连接；如果连接成功，客户端可以使用本文档中描述的映射发送HTTP请求。

**3.1.2 其他方案**

尽管HTTP独立于传输协议，但“HTTP”方案将权限与在权限组件中标识的任何主机的指定端口上接收TCP连接的能力相关联。由于HTTP/3不使用TCP， 所以HTTP/3不能用于直接访问由“HTTP”URI标识的资源的权威服务器。然而，诸如[ALTSVC]这样的协议扩展允许授权服务器识别其他同样具有授权且可能通过HTTP/3可访问的服务。

当向方案不是“https”的源发起请求之前，客户端必须确保服务器愿意为该方案提供服务。对于方案为“http”的源，我们会在之后介绍实现此目的的实验方法。

**3.2 建立连接**

HTTP/3依赖于QUIC版本1作为底层传输，未来的规范可能会定义使用 HTTP/3 的其他 QUIC 传输版本。

QUIC 版本 1 使用 TLS 版本 1.3 或更高版本作为其握手协议。 HTTP/3 客户端必须支持在 TLS 握手期间向服务器指示目标主机的机制。如果服务器由域名 ([DNS-TERMS]) 标识，则客户端必须发送服务器名称指示 (SNI; [RFC6066]) TLS 扩展，除非有另一种机制来指示使用的目标主机。

在建立连接期间，通过在TLS握手中选择ALPN令牌“h3”来表示对HTTP/3的支持。对其他应用层协议的支持可以在相同的握手中提供。

虽然与核心 QUIC 协议有关的连接级别选项是在初始加密握手中设置的，但特定于 HTTP/3 的设置在 SETTINGS 帧中传递。在建立了QUIC连接之后，每个终端必须发送一个SETTINGS帧作为它们各自的HTTP控制流的初始帧。

**3.3 连接重用**

HTTP/3连接是跨多个请求的持久连接。为了获得最佳性能，客户端在确定不再需要与服务器进行进一步通信之前(例如，当用户导航离开某个特定的网页时)不会关闭连接，或者直到服务器关闭连接。

一旦存在到服务器终端的连接，该连接可以被重用于具有多个不同 URI 权限组件的请求。要使用一个现有的连接到一个新的源，客户端必须验证服务器为新的源服务器提供的证书。这意味着客户端将需要保留服务器证书和验证该证书所需的任何额外信息，否则客户端将无法为其他源重用连接。

如果证书由于任何原因对于新源不可接受，则不得重用连接，并且应该为新源建立新连接。如果证书无法验证的原因可能适用于已经与连接关联的其他来源，客户端应该重新验证这些来源的服务器证书。例如，如果由于证书已过期或被吊销而导致证书验证失败，则这可能用于使该证书用于建立权限的所有其他来源无效。

客户端不应打开多个到给定 IP 地址和 UDP 端口的 HTTP/3 连接，其中 IP 地址和端口可能来自 URI、选定的替代服务 ([ALTSVC])、配置的代理或名称解析其中任何一个。客户端可以使用不同的传输或 TLS 配置打开到相同 IP 地址和 UDP 端口的多个 HTTP/3 连接，但应避免使用相同配置创建多个连接。

服务器应尽可能长时间地保持打开的 HTTP/3 连接，但在必要时允许终止空闲连接。当任何一个终端选择关闭HTTP/3连接时，终止的终端应该首先发送一个 GOAWAY 帧，以便两个终端能够可靠地确定之前发送的帧是否已经被处理并完成或终止任何必要的剩余任务。

如果服务器不希望客户端重用HTTP/3连接，它可以发送一个421(错误定向请求)状状态代码来响应请求来表明它对请求不具有权威性。

**4.在HTTP/3中表达HTTP语义**

**4.1 HTTP 消息帧**

客户端在请求流上发送 HTTP 请求，请求流是客户端发起的双向 QUIC 流。客户端必须在给定的流上只发送一个请求。服务器在与请求相同的流上发送零个或多个临时HTTP响应，然后是一个最终HTTP响应，详细信息如下。

推送响应在服务器发起的单向QUIC流上发送，服务器以与标准响应相同的方式发送零个或多个临时HTTP响应，然后是一个最终HTTP响应。在给定的流中，收到多个请求或在最终 HTTP 响应之后收到额外的 HTTP 响应必须被视为格式错误。

一个HTTP消息(请求或响应)包括：

标头部分，包括消息控制数据，作为单个标头帧发送；

可选地，如果内容存在，则以一系列数据帧的形式发送；

可选地，尾部部分（如果存在）作为单个 HEADERS 帧发送。

接收到无效的帧序列必须被视为 H3\_FRAME\_UNEXPECTED 类型的连接错误。特别是，任何 HEADERS 帧之前的 DATA 帧，或尾部 HEADERS 帧之后的 HEADERS 或 DATA 帧，都被认为是无效的。其他帧类型，尤其是未知帧类型，可能会根据它们自己的规则被允许。

服务器可以在响应消息的帧之前、之后或与响应消息的帧交错发送一个或多个 PUSH\_PROMISE 帧。这些 PUSH\_PROMISE 帧不是响应的一部分。push stream上不允许使用 PUSH\_PROMISE 帧；包含 PUSH\_PROMISE 帧的推送响应必须被视为 H3\_FRAME\_UNEXPECTED 类型的连接错误。

HEADERS 和 PUSH\_PROMISE 帧可能会引用对 QPACK 动态表的更新。虽然这些更新不是消息交换的直接部分，但必须先接收和处理它们，然后才能使用消息。

传输编码没有为HTTP/3定义；Transfer-Encoding标头字段绝对不能被使用。

当且仅当一个或多个临时响应在对同一请求的最终响应之前，响应可能包含多个消息。临时响应不包含内容或预告片部分。

HTTP 请求/响应交换完全使用客户端发起的双向 QUIC 流。发送请求后，客户端必须关闭要发送的流。除非使用 CONNECT 方法，否则客户端不得依赖于接收到对其请求的响应来进行流关闭。发送最终响应后，服务器必须关闭要发送的流。此时，QUIC 流已完全关闭。

当流关闭时，这表示最终HTTP消息的结束。因为有些消息很大或没有绑定，所以一旦接收到足够的消息以进行处理，终端就应该开始处理部分HTTP消息。如果客户端发起的流终止时没有足够的HTTP消息来提供完整的响应，服务器应该以错误码H3\_REQUEST\_INCOMPLETE终止其响应流。

如果响应不依赖于尚未发送和接收的请求的任何部分，服务器可以在客户端发送整个请求之前发送一个完整的响应。当服务器不需要接收请求的剩余部分时，它可以中止读取请求流，发送一个完整的响应，并关闭流的发送部分。当请求客户端停止发送请求流时，应该使用错误码H3\_NO\_ERROR。客户绝对不能因为他们的请求被突然终止而删除完整的回复，尽管客户总是可以根据自己的判断删除其他原因的回复。如果服务器发送了部分或完整的响应，但没有终止读取请求，客户端应该继续发送请求的内容，并正常关闭流。

**4.1.1 取消和拒绝请求**

一旦请求流被打开，请求可以被任何一个终端取消。如果对响应不再感兴趣，客户端会取消请求；如果服务器无法或选择不响应请求，则会取消请求。如果可能，建议服务器发送一个带有适当状态码的HTTP响应，而不是取消它已经开始处理的请求。

实现应该通过突然终止流中仍然打开的任何方向来取消请求。为此，实现重置流的发送部分，并中止流的接收部分的读取。

当服务器取消请求而不执行任何应用程序处理时，该请求被认为是“被拒绝”的。服务器应该中止包含错误代码H3\_REQUEST\_REJECTED的响应流。在这种情况下，“已处理”意味着流中的一些数据被传递到软件的较高层，该软件可能因此采取了一些操作。客户端可以将被服务器拒绝的请求当作从未发送过，从而允许它们稍后重试。

对于部分或全部处理的请求，服务器不得使用 H3\_REQUEST\_REJECTED 错误代码。当服务器在部分处理后放弃响应时，它应该以错误代码 H3\_REQUEST\_CANCELLED 中止其响应流。

客户端应该使用错误代码H3\_REQUEST\_CANCELLED来取消请求。在接收到此错误码后，如果没有执行任何处理，服务器可能会使用错误码H3\_REQUEST\_REJECTED突然终止响应。客户端绝对不能使用H3\_REQUEST\_REJECTED错误码，除非服务端使用此错误码请求关闭请求流。

如果在收到完整响应后取消流，客户端可以忽略取消并使用响应。但是，如果在收到部分响应后取消流，则不应使用响应。只有 GET、PUT 或 DELETE 等幂等操作可以安全地重试；客户端不应该使用非幂等方法自动重试请求，除非它有某种方法可以知道请求语义是独立于方法的幂等，或者有某种方法可以检测到原始请求从未被应用。

**4.1.2 格式错误的请求和响应**

格式错误的请求或响应是一个有效的帧序列，但由于以下原因而无效：、禁止字段或伪标头字段的存在；

没有强制性的伪标头字段；

伪标头字段的无效值；

字段后的伪标头字段；

无效的 HTTP 消息序列；

包含大写字段名称；

在字段名称或值中包含无效字符。

如果一个请求或响应被定义为包含content - length标头字段，如果content - length标头字段的值不等于接收到的数据帧长度之和，则该请求或响应是不规范的。一个被定义为永远没有内容的响应，即使有content - length，也可以有一个非...