---
title: Breaking the Code - Exploiting and Examining CVE-2023-1829 in cls_tcindex Classifier Vulnerability
url: https://starlabs.sg/blog/2023/06-breaking-the-code-exploiting-and-examining-cve-2023-1829-in-cls_tcindex-classifier-vulnerability/
source: Blogs on STAR Labs
date: 2023-06-20
fetch_date: 2025-10-04T11:46:53.788273
---

# Breaking the Code - Exploiting and Examining CVE-2023-1829 in cls_tcindex Classifier Vulnerability

[![logo](https://starlabs.sg/logo-white.png)](https://starlabs.sg/ "  (Alt + H)")

* [Home](https://starlabs.sg/ "Home")
* [About](https://starlabs.sg/about/ "About")
* [Advisories](https://starlabs.sg/advisories/ "Advisories")
* [Blog](https://starlabs.sg/blog/ "Blog")
* [Achievements](https://starlabs.sg/achievements/ "Achievements")
* [Publications](https://starlabs.sg/publications/ "Publications")
* [Search](https://starlabs.sg/search/ "Search (Alt + /)")

[Home](https://starlabs.sg/) » [Blogs](https://starlabs.sg/blog/)

# Breaking the Code - Exploiting and Examining CVE-2023-1829 in cls\_tcindex Classifier Vulnerability

June 19, 2023 · 17 min · Vũ Thị Lan (@lanleft\_)

Table of Contents

* [Background](#background)
* [Netlink Overview](#netlink-overview)
* [Traffic Control](#traffic-control)
  + [Queuing Disciplines](#queuing-disciplines)
  + [Filters](#filters)
  + [Playing with NETLINK\_ROUTE](#playing-with-netlink_route)
    - [Netlink message](#netlink-message)
    - [Netlink payload](#netlink-payload)
* [Vulnerability Analysis](#vulnerability-analysis)
* [Proof-of-Concept](#proof-of-concept)
* [Exploitation](#exploitation)
  + [How to solve the unstable problem when reclaiming UAF’s chunk](#how-to-solve-the-unstable-problem-when-reclaiming-uafs-chunk)
  + [Steps to exploitation](#steps-to-exploitation)
    - [Spraying table->udata](#spraying-table-udata)
    - [Using `tc_ctl_chain` function for second time freeing](#using-tc_ctl_chain-function-for-second-time-freeing)
    - [Leaking heap pointer and kernel base](#leaking-heap-pointer-and-kernel-base)
    - [Faking nft\_object](#faking-nft_object)
    - [Overwriting modprobe\_path](#overwriting-modprobe_path)
* [Patch Analysis](#patch-analysis)
* [Conclusion](#conclusion)
* [References](#references)

## Background[#](#background)

The discovery and analysis of vulnerabilities is a critical aspect of cybersecurity research. Today, we will dive into [CVE-2023-1829](https://nvd.nist.gov/vuln/detail/CVE-2023-1829), a vulnerability in the `cls_tcindex` network traffic classifier found by Valis. We will explore the process of exploiting and examining this vulnerability, shedding light on the intricate details and potential consequences. We have thoroughly tested our exploit on `Ubuntu 22.04` with kernel version `5.15.0-25`, which was built from the official `5.15.0-25.25` source code.

## Netlink Overview[#](#netlink-overview)

`Netlink` is a socket domain designed to facilitate interprocess communication (IPC) within the Linux kernel, particularly between the kernel and user programs. It was developed to replace the outdated `ioctl()` interface and offers a more versatile method of communication via standard sockets in the `AF_NETLINK` domain.

With `Netlink`, user programs can exchange messages with various kernel systems, including networking, routing, and system configuration. `Netlink` routing, in particular, focuses on managing and manipulating the routing table in the Linux kernel.

This aspect provides a robust interface for configuring and controlling the system’s routing behavior. It encompasses network routes, IP addresses, link parameters, neighbor setups, queuing disciplines, as well as traffic classes and packet classifiers. These functionalities can be accessed and manipulated using `NETLINK_ROUTE` sockets, leveraging the underlying netlink message framework.

## Traffic Control[#](#traffic-control)

Traffic control provides a framework for the development of integrated services and differentiated services support. It consists of queuing disciplines, classes, and filters/policies. Linux traffic control service is very flexible and allows for hierarchical cascading of the different blocks for traffic resource sharing.

![Figure 1. Egress traffic control flow](/blog/2023/images/06-tcindex-classifier_01.png)

> Figure 1. Egress traffic controls

The above image illustrates an instance of the egress Traffic Control (TC) block. In this process, a package undergoes filtering to determine its potential class membership. A class represents a terminal queuing discipline and is accompanied by a corresponding queue. The queue may employ a straightforward algorithm such as First-In-First-Out (FIFO), or a more sophisticated approach like Random Early Detection (RED) or a token bucket mechanism. At the highest level, the parent queuing discipline, often associated with a scheduler, oversees the entire system. Within this scheduler hierarchy, it is possible to find additional scheduling algorithms, providing the Linux Egress Traffic Control with remarkable flexibility.

Within the Netlink framework, traffic control is primarily handled by the `NETLINK_ROUTE` family and associated with some netlink message types:

* General networking environment manipulation services:
  + Link layer interface settings: identified by `RTM_NETLINK`, `RTM_DELLINK`, and `RTM_GETLINK`.
  + Network layer (IP) interface settings: `RTM_NEWADDR`, `RTM_DELADDR`, and `RTM_GETADDDR`.
  + Network layer routing tables: `RTM_NEWROUTE`, `RTM_DELROUTE`, and `RTM_GETROUTE`.
  + Neighbor cache that associates network layber and link layer addressing: `RTM_NEWNEIGH`, `RTM_DELNEIGH`, and `RTM_GETNEIGH`.
* Traffic shaping (management) services:
  + Routing rules to direct network layer packets: `RTM_NEWRULE`, `RTM_DELRUTE`, and `RTM_GETRULE`.
  + Queuing discipline settings associated with network interfaces: `RTM_NEWQDISC`, `RTM_DELQDISC`, and `RTM_GETQDISC`.
  + Traffic classes used together with queues: `RTM_NEWTCLASS`, `RTM_DELTCLASS`, and `RTM_GETTCLASS`.
  + Traffic filters associated with a queuing: `RTM_NEWFILTER`, `RTM_DELFILTER`, and `RTM_GETFILTER`.

More details in this [blog post](https://www.infradead.org/~tgr/libnl/doc/route.html).

### Queuing Disciplines[#](#queuing-disciplines)

Queuing disciplines are mechanisms utilized to control the flow of packets within a network interface or router. They play a crucial role in organizing and scheduling packets for transmission based on specific rules or policies. In addition, queuing disciplines offer two essential operations: `enqueue()` and `dequeue()`.

Whenever a network packet is sent out from the networking stack through a physical or virtual device, it is placed into a queue discipline, unless the device is designed to be queueless. The `enqueue()` operation immediately adds the packet to the appropriate queue, and it is then followed by a subsequent `dequeue()` call from the same queue discipline. This `dequeue()` operation is responsible for retrieving a packet from the queue, which can then be scheduled for transmission by the driver.

![Figure 2. Packets arrivers and leaves the queuing discipline](/blog/2023/images/06-tcindex-classifier_02.png)

> Figure 2. Packets arrivers and leaves the queuing discipline

If the `qdisc` is a classful qdisc, users have the flexibility to create their own queuing structure and classification process.

![Figure 3. Classful handles classify packets](/blog/2023/images/06-tcindex-classifier_03.png)

> Figure 3. Classful handles classify packets

Linux offers various queuing disciplines that can be applied to network interfaces. Some commonly used queuing disciplines include:

1. `Fist-In, First-Out (FIFO)`: This is the simplest queuing discipline where packets are transmitted in the order they arrive. It doesn’t provide any prioritization or traffic shaping capabilities.
2. `Hierchical Token Bucket (HTB)`: `HTB` is a hierarchical queuing discipline that allows the creation of traffic classes and sub-classes with different bandwidth allocations. It provides a flexible and hierarchical structure for managing bandwidth and prioritization.
3. `Class-Based Queuing (CBQ)`: `CBQ` is a more advanced queuing discipline that allows administrators to define traffic classes with different priority levels, bandwidth allocations, and delay guarantees. It supports hierarchical structures and provides fine-grained control over traffic shaping and p...