---
title: 冰蝎各版本工具分析与魔改思路
url: https://www.secpulse.com/archives/194554.html
source: 安全脉搏
date: 2023-01-05
fetch_date: 2025-10-04T03:03:08.934012
---

# 冰蝎各版本工具分析与魔改思路

[![](https://www.secpulse.com/wp-content/themes/secpulse2017/img/logo-header.png)](https://www.secpulse.com "安全脉搏")

* [首页](https://www.secpulse.com/)
* [分类阅读](https://www.secpulse.com/archives/category/category)

  #### 脉搏文库

  - [内网渗透](https://www.secpulse.com/archives/category/articles/intranet-penetration)
  - |
  - [代码审计](https://www.secpulse.com/archives/category/articles/code-audit)
  - |
  - [安全文献](https://www.secpulse.com/archives/category/articles/sec-doc)
  - |
  - [Web安全](https://www.secpulse.com/archives/category/articles/web)
  - |
  - [移动安全](https://www.secpulse.com/archives/category/articles/mobile-security)
  - |
  - [系统安全](https://www.secpulse.com/archives/category/articles/system)
  - |
  - [工控安全](https://www.secpulse.com/archives/category/articles/industrial-safety)
  - |
  - [CTF](https://www.secpulse.com/archives/category/exclusive/ctf-writeup)
  - |
  - [IOT安全](https://www.secpulse.com/archives/category/iot-security)
  - |

#### 安全建设

+ [业务安全](https://www.secpulse.com/archives/category/construction/businesssecurity)
+ |
+ [安全管理](https://www.secpulse.com/archives/category/construction/securityissue)
+ |
+ [数据分析](https://www.secpulse.com/archives/category/construction/bigdata)
+ |

#### 其他

+ [资讯](https://www.secpulse.com/archives/category/news)
+ |
+ [漏洞](https://www.secpulse.com/archives/category/vul)
+ |
+ [工具](https://www.secpulse.com/archives/category/tools)
+ |
+ [人物志](https://www.secpulse.com/archives/category/people)
+ |
+ [区块链安全](https://www.secpulse.com/archives/category/exclusive/block_chain_security)
+ |
+ [安全招聘](https://www.secpulse.com/archives/category/hiring)
+ |

- [安全问答](https://www.secpulse.com/newpage/question_list)
- [金币商城](https://www.secpulse.com/shop?donotcachepage=c010349fd98847cb9d6e07d3cbc19288)
- [安全招聘](https://www.secpulse.com/archives/category/hiring)
- [活动日程](https://www.secpulse.com/newpage/activity)
- [live课程](https://www.secpulse.com/live)
- [企业服务](https://duoyinsu.com/service.html)
- [插件社区](https://x.secpulse.com/)

小程序

![脉搏小程序](https://www.secpulse.com/wp-content/themes/secpulse2017/img/wxchat.jpg)
[登录](https://www.secpulse.com/user_login)
|
[注册](https://www.secpulse.com/user-register)

# 冰蝎各版本工具分析与魔改思路

[工具](https://www.secpulse.com/archives/category/tools)

[蚁景网安实验室](https://www.secpulse.com/newpage/author?author_id=37244)
![]( https://www.secpulse.com/wp-content/themes/secpulse2017/img/renzheng2.png)

2023-01-04

14,974

**本文转自先知社区：**

**https://xz.aliyun.com/t/11989**

**作者：KimJun**

# 0x00 V2版本

## 1. 项目

github项目：https://github.com/rebeyond/Behinder/releases/
V2 源码：https://github.com/hktalent/afterLoader

## 2. 流量分析

执行流程图：

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194554-1672735464.png)

1. 首次连接一句话服务端时，客户端首先向服务器端发起GET请求，只有一个参数，格式为?pass=123形式，服务器端随机产生一个128位的密钥，把密钥回显给客户端，同时把密钥写进服务器侧的Session中

   ![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194554-1672735465.png)
2. 客户端获取密钥后，后面的请求都为POST请求，对本地的二进制payload先进行AES加密然后base64编码，再通过POST请求发送至服务器端。正常的网站接口或者页面中，一般是响应的html代码或者json，冰蝎2响应的数据则为经过AES加密的二进制数据，所以Content-Type均为 : application/octet-stream

   ![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194554-1672735466.png)

## 3. 特点

1. 服务器端动态解析二进制class文件
2. 客户端已编译类的参数化：使用ASM框架来动态修改class文件中的属性值，动态生成经过参数化的payload class

## 4. 流量特征

1. GET请求的 HTTP 响应包中Content-Length字段的值是固定的16，同时URI只有一个参数，key-value型参数
2. 默认的 Accept 字段较为特殊 text/html, image/gif, image/jpeg, *; q=.2,*/\*; q=.2
3. UserAgent字段内置了十余种比较老的User Agent，每次连接shell会随机选择一个进行使用
4. JSP类型的webshell，POST请求体数据均为base64编码，Content-Type为application/octet-stream，响应体数据均为二进制文件
5. 执行JSP webshell，一般较短的命令Content-Length都是9068

# 0x01 V3版本

## 1. 项目

github项目：https://github.com/rebeyond/Behinder/releases/
V3 源码：https://github.com/MountCloud/BehinderClientSource

## 2. 流量分析

冰蝎3和2相比，最重要的变化就是去除动态密钥协商机制，采用预共享密钥，全程无明文交互，密钥格式为md5("admin")[0:16]，其余的都差不多
这里还要提到一点，当客户端第一次调用ShellService�#doConnect�方法连接webshell失败，会调用Utils#getKeyAndCookie�方法发送Get请求连接协商秘钥，猜测作者可能是为了兼容2版本的webshell，也算是一个特征点

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194554-1672735469.png)

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194554-1672735471.png)

## 3. 特点

1. 去除动态密钥协商机制

## 4. 流量特征

1. 流量特征其实也V2版本类似，同样内置了十余种比较老的User Agent，POST请求体数据均为base64编码
2. 存在GET请求，同时URI只有一个key-value类型参数

# 0x02 V4版本

## 1. 项目

github项目：https://github.com/rebeyond/Behinder/releases/
V4 源码：https://github.com/MountCloud/BehinderClientSource

## 2. 流量分析

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194554-1672735472.png)

1. 本地选择加密算法，生成服务端Webshell，加密算法对Payload进行加密，然后数据通过POST请求发送给远程服务端

   ![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194554-1672735474.png)

   ![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194554-1672735476.png)
2. 服务端收到Payload密文后，利用解密算法进行解密
3. 服务端执行解密后的Payload，并获取执行结果
4. 服务端对Payload执行结果进行加密，然后返回给本地客户端
5. 客户端收到响应密文后，利用解密算法解密，得到响应内容明文

## 3. 特点

1. 允许自定义加密解密协议

## 4. 流量特征

1. 采用默认aes加密协议情况下流量特征与V2、V3类似

# 0x03 安全设备检测原理图

某盟UTS：

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194554-1672735480.png)

# 0x04 魔改思路

针对不同安全产商设备的检测原理，整理了以下几种魔改思路：

1. 加密解密算法，除了默认的AES，可以使用DES、3DES、TDEA、Blowfish、Twofish、RC2、RC4、RC5、IDEA、SKIPJACK等对称加密算法
2. 去除base64编码特征，请求体和响应体数据随机产生不定长度的额外字节数组
3. 去除请求头User-Agent、Accept、Referer、Content-type等特征
4. 请求包以json格式参数，响应体数据返回json格式或者html格式，数据可以拆散隐藏在html标签中
5. 修改请求协议，使用HEAD协议，长度较小的paylaod放到header执行，Shell返回404，响应数据通过ceye类似接口进行中转/服务器可访问的目录图片中转
6. 客户端不定时发送不定长度的垃圾数据
7. 基于sessionID生成密钥、payload参数名、分隔符等
8. 使用Java底层函数绕OpenRASP
9. webshell免杀

## 参考

https://xz.aliyun.com/t/2744#toc-5
https://mp.weixin.qq.com/s/EwY8if6ed\_hZ3nQBiC3o7A

**本文作者：[蚁景网安实验室](newpage/author?author_id=37244)**

**本文为安全脉搏专栏作者发布，转载请注明：**[**https://www.secpulse.com/archives/194554.html**](https://www.secpulse.com/archives/194554.html)

Tags: [ASM框架](https://www.secpulse.com/archives/tag/asm%E6%A1%86%E6%9E%B6)、[二进制](https://www.secpulse.com/archives/tag/%E4%BA%8C%E8%BF%9B%E5%88%B6)、[冰蝎](https://www.secpulse.com/archives/tag/%E5%86%B0%E8%9D%8E)、[加密算法](https://www.secpulse.com/archives/tag/%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95)、[客户端](https://www.secpulse.com/archives/tag/%E5%AE%A2%E6%88%B7%E7%AB%AF)、[魔改](https://www.secpulse.com/archives/tag/%E9%AD%94%E6%94%B9)

点赞：
0
[评论：0](#goComment)
收藏：
0

*新浪微博
QQ空间
微信扫一扫*

### 相关文章

* [![Windows版宝塔bypass到RDP登录](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/2023/06/1686117734105-300x189.png)

  Windows版宝塔bypass到RDP…](https://www.secpulse.com/archives/201484.html "详细阅读 Windows版宝塔bypass到RDP登录")
* [![常见webshell工具及特征分析](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/2023/03/1678175200543-300x177.png)

  常见webshell工具及特征分析](https://www.secpulse.com/archives/197128.html "详细阅读 常见webshell工具及特征分析")
* [![冰蝎V4.0流量分析到攻防检测](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/2023/01/1674974948709-300x172.png)

  冰蝎V4.0流量分析到攻防检测](https://www.secpulse.com/archives/195173.html "详细阅读 冰蝎V4.0流量分析到攻防检测")

评论  (0)

昵称

必填
您当前尚未登录。
[登录？](https://www.secpulse.com/user_login "登录")
[注册](https://www.secpulse.com/user-register)

邮箱

必填（保密）

快来写下你的想法吧！

upload

|  |  |  |
| --- | --- | --- |
| [![]( https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/2024/12/logo-white.png)](https://www.secpulse.com/newpage/author?author_id=37244aaa) | [蚁景网安实验室 ![]( https://www.secpulse.com/wp-content/themes/secpulse2017/img/renzheng2.png)](https://www.secpulse.com/newpage/author?author_id=37244) | |
| 文章数：402 | 积分： 877 |
| 蚁景网安实验室（www.yijinglab.com）网络安全靶场练习平台，涉及CTF赛前指导、职业技能训练、网安专项技能提升等。 | |

* [![阿波罗主机安全管理](/wp-content/themes/secpulse2017/img/product-agent.png)](https://linkage.duoyinsu.com)
* [![伏特漏洞扫描云平台](/wp-content/themes/secpulse2017/img/pr...