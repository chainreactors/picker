---
title: Apache Struts2 文件上传逻辑绕过(CVE-2024-53677)(S2-067)
url: https://y4tacker.github.io/2024/12/16/year/2024/12/Apache-Struts2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%80%BB%E8%BE%91%E7%BB%95%E8%BF%87-CVE-2024-53677-S2-067/
source: Y4tacker:Hacking The World!
date: 2024-12-17
fetch_date: 2025-10-06T19:38:07.177372
---

# Apache Struts2 文件上传逻辑绕过(CVE-2024-53677)(S2-067)

* [Home](/)
* [Writing](/archives/)
* [Topics](/tags/)
* [Search](/search/)
* [About](/about/)
* [Friends](/link/)

Previous post Next post Back to top Share post

1. [1. Apache Struts2 文件上传逻辑绕过(CVE-2024-53677)(S2-067)](#Apache-Struts2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%80%BB%E8%BE%91%E7%BB%95%E8%BF%87-CVE-2024-53677-S2-067)
   1. [1.1. 前言](#%E5%89%8D%E8%A8%80)
   2. [1.2. 分析](#%E5%88%86%E6%9E%90)
      1. [1.2.1. 影响版本](#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC)
      2. [1.2.2. 环境搭建](#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA)
      3. [1.2.3. 前置知识](#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86)
   3. [1.3. 失败的尝试](#%E5%A4%B1%E8%B4%A5%E7%9A%84%E5%B0%9D%E8%AF%95)
   4. [1.4. Struts2的参数绑定](#Struts2%E7%9A%84%E5%8F%82%E6%95%B0%E7%BB%91%E5%AE%9A)
   5. [1.5. S2-067之多文件上传场景绕过](#S2-067%E4%B9%8B%E5%A4%9A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%9C%BA%E6%99%AF%E7%BB%95%E8%BF%87)
   6. [1.6. S2-067之单文件上传场景绕过](#S2-067%E4%B9%8B%E5%8D%95%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%9C%BA%E6%99%AF%E7%BB%95%E8%BF%87)
   7. [1.7. 参考文章](#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0)

# Apache Struts2 文件上传逻辑绕过(CVE-2024-53677)(S2-067)

Y4tacker

2024-12-16 (Updated: 2024-12-17)

[Java](/categories/Java/)

[Java](/tags/Java/), [Struts2](/tags/Struts2/)

# Apache Struts2 文件上传逻辑绕过(CVE-2024-53677)(S2-067)

## 前言

​ [Apache官方公告](https://cwiki.apache.org/confluence/display/WW/S2-067)又更新了一个Struts2的漏洞，考虑到很久没有发无密码的博客了，再加上漏洞的影响并不严重，因此公开分享利用的思路。

## 分析

### 影响版本

Struts 2.0.0 - Struts 2.3.37 ([EOL](https://struts.apache.org/struts23-eol-announcement)), Struts 2.5.0 - Struts 2.5.33, Struts 6.0.0 - Struts 6.3.0.2

### 环境搭建

Struts2的环境搭建比较简单，分析时使用了两种不同漏洞场景的代码

UploadsAction对应多文件上传的场景，也是最简单的场景，不需要任何其他背景知识方便理解

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 ``` | ``` package com.struts2;  import com.opensymphony.xwork2.ActionSupport; import java.io.*; import java.util.ArrayList; import java.util.List;  public class UploadsAction extends ActionSupport {      private static final long serialVersionUID = 1L;     private List<File> upload;     private List<String> uploadContentType;     private List<String> uploadFileName;     private List<String> uploadedFileNames =  new ArrayList<String>();      public List<File> getUpload() {         return upload;     }      public void setUpload(List<File> upload) {         this.upload = upload;     }      public List<String> getUploadContentType() {         return uploadContentType;     }      public void setUploadContentType(List<String> uploadContentType) {         this.uploadContentType = uploadContentType;     }      public List<String> getUploadFileName() {         return uploadFileName;     }      public void setUploadFileName(List<String> uploadFileName) {         this.uploadFileName = uploadFileName;     }      public List<String> getUploadedFileNames() {         return uploadedFileNames;     }      public String doUpload() {         for (int i = 0; i < uploadFileName.size(); i++) {             uploadedFileNames.add(uploadFileName.get(i));         }         return SUCCESS;     }  } ``` |

UploadAction对应单文件上传的场景

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 ``` | ``` package com.struts2;  import com.opensymphony.xwork2.ActionSupport; import java.io.*; import java.util.ArrayList; import java.util.List;  public class UploadAction extends ActionSupport {      private static final long serialVersionUID = 1L;       private File upload;     private String uploadContentType;     private String uploadFileName;       public File getUpload() {         return upload;     }      public void setUpload(File upload) {         this.upload = upload;     }      public String getUploadContentType() {         return uploadContentType;     }      public void setUploadContentType(String uploadContentType) {         this.uploadContentType = uploadContentType;     }      public String getUploadFileName() {         return uploadFileName;     }      public void setUploadFileName(String uploadFileName) {         this.uploadFileName = uploadFileName;     }       public String doUpload() {         return SUCCESS;     }  } ``` |

struts.xml

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 ``` | ``` <?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE struts PUBLIC         "-//Apache Software Foundation//DTD Struts Configuration 2.0//EN"         "http://struts.apache.org/dtds/struts-2.0.dtd"> <struts>     <package name="upload" extends="struts-default">         <action name="upload" class="com.struts2.UploadAction" method="doUpload">             <result name="success" type="">/file.jsp</result>         </action>     </package>     <package name="uploads" extends="struts-default">         <action name="uploads" class="com.struts2.UploadsAction" method="doUpload">             <result name="success" type="">/files.jsp</result>         </action>     </package> </struts> ``` |

file.jsp

|  |  |
| --- | --- |
| ``` 1 2 3 ``` | ``` <%@page contentType="text/html; charset=UTF-8" language="java" %> <%@ taglib prefix="y4tacker" uri="/struts-tags"%> 上传的文件名是:<y4tacker:property value="uploadFileName" /> ``` |

files.jsp

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 10 11 ``` | ``` <%@page contentType="text/html; charset=UTF-8" language="java" %> <%@ taglib prefix="y4tacker" uri="/struts-tags"%> <y4tacker:if test="uploadedFileNames.size() > 0">     文件上传成功:     <y4tacker:iterator value="uploadedFileNames">         <li><y4tacker:property /></li>     </y4tacker:iterator> </y4tacker:if> <y4tacker:else>     no files. </y4tacker:else> ``` |

web.xml

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 ``` | ``` <?xml version="1.0" encoding="UTF-8"?> <!--  Licensed to the Apache Software Foundation (ASF) under one or more   contributor license agreements.  See the NOTICE file distributed with   this work for additional information regarding copyright ownership.   The ASF licenses this file to You under the Apache License, Version 2.0   (the "License"); you may not use this file except in compliance with   the License.  You may obtain a copy of the License at        http://www.apache.org/licenses/LICENSE-2.0    Unless required by applicable law or agreed to in writing, software   distributed under the License is distributed on an "AS IS" BASIS,   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.   See the License for the specific language governing permissions and   limitations under the License. --> <web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"   xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee                       http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"   version="4.0"   metadata-complete="true">      <filter>         <filter-name>struts2</filter-name>         <filter-class>org.apache.struts2.dispatcher.filter.StrutsPrepareAndExecuteFilter</filter-class>     </filter>     <filter-mapping>         <filter-name>struts2</filter-name>         <url-pattern>*.action</url-pattern>     </filter-mapping>  </web-app> ``` |

目录结构如下

![image-20241216204105946](/2024/12/16/year/2024/12/Apache-Struts2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%80%BB%E8%BE%91%E7%BB%95%E8%BF%87-CVE-2024-53677-S2-067/image-20241216204105946.png)

### 前置知识

由于是S2-066的绕过，所以需要对上一个漏洞的原理有所了解，在我上一篇文章中[Apache Struts2 文件上传分析(S2-066)](https://y4tacker.github.io/2023/12/09/year/2023/12/Apache-Struts2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90-S2-066/)对此有详细的介绍，这里就不详细描述了，对于上一个漏洞，官方的修复也很暴力，在`FileUploadInterceptor`中设置参数时，忽略大小写遍历删除同名参数再做添加

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 ``` | ``` public HttpParameters appendAll(Map<String, Parameter> newParams) {     this.remove(newParams.keySet());     this.p...