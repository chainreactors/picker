---
title: SaaSå¤šç§Ÿæˆ·è‡ªåŠ¨åŒ–æ¸—é€å¹³å°-æ•°æ®å®‰å…¨éš”ç¦»å®è·µ
url: https://mp.weixin.qq.com/s?__biz=MzkwNDE5NzUyMA==&mid=2247483699&idx=1&sn=3d35c690bff8246d0f8e320c59108828&chksm=c08be5ccf7fc6cda4ece5c805eba67be1ee3287684f3db3d2d4d5ca2fe658274cb4a922ddbfb&scene=58&subscene=0#rd
source: b1ngzçš„ç¬”è®°æœ¬
date: 2024-09-28
fetch_date: 2025-10-06T18:28:15.567458
---

# SaaSå¤šç§Ÿæˆ·è‡ªåŠ¨åŒ–æ¸—é€å¹³å°-æ•°æ®å®‰å…¨éš”ç¦»å®è·µ

![cover_image](https://mmbiz.qpic.cn/mmbiz_jpg/1JicUwKQqRQ7VeezpovtfjXuSEPEQ6n98xsofHiclXNElympFICb4S9TZUsako3CsPX1NgEpwrbhQ5cnVFrZ6K0A/0?wx_fmt=jpeg)

# SaaSå¤šç§Ÿæˆ·è‡ªåŠ¨åŒ–æ¸—é€å¹³å°-æ•°æ®å®‰å…¨éš”ç¦»å®è·µ

åŸåˆ›

b1ngz

b1ngzçš„ç¬”è®°æœ¬

0x01. ç®€ä»‹

---

åœ¨ä¸Šä¸€ç¯‡ [SaaSå¤šç§Ÿæˆ·è‡ªåŠ¨åŒ–æ¸—é€å¹³å°-æ¶æ„ç¬”è®°](https://mp.weixin.qq.com/s?__biz=MzkwNDE5NzUyMA==&mid=2247483694&idx=1&sn=f790233f79f52fb60fcd1aefa25d4820&scene=21#wechat_redirect) ä¸­æåˆ°äº† â€œå®¢æˆ·å¯¹ SaaS å½¢æ€äº§å“çš„æ•°æ®å®‰å…¨æ€§éå¸¸æ•æ„Ÿâ€ï¼Œå› æ­¤å®ç°æ•°æ®å®‰å…¨éš”ç¦»æ˜¯å¹³å°çš„ä¸€ä¸ªæ ¸å¿ƒè¦æ±‚ã€‚åŒæ—¶å› äº§å“çš„å®šä½æ˜¯è‡ªåŠ¨åŒ–æ¸—é€å¹³å°ï¼Œç”¨æˆ·ä¸ºä¸“ä¸šå®‰å…¨äººå‘˜ï¼Œä½¿å¾—ä¿éšœå¹³å°è‡ªèº«çš„æ•°æ®å®‰å…¨æ›´åŠ é‡è¦ã€‚è¿™ç¯‡ç¬”è®°ä»‹ç»äº†åœ¨å¤šç§Ÿæˆ·æ¶æ„ä¸‹ï¼Œå®ç°æ•°æ®å®‰å…¨éš”ç¦»çš„ä¸€äº›æ€è€ƒå’Œå®è·µï¼Œä¸»è¦å†…å®¹åŒ…æ‹¬

* å¤šç§Ÿæˆ·æ¶æ„æ•°æ®å®‰å…¨éš”ç¦»çš„è¦æ±‚å’Œè®¾è®¡æ€è·¯
* åŸºäº Flaskã€SQLAlchemyã€Dramatiq æ¡†æ¶å¦‚ä½•å®ç°å¤šç§Ÿæˆ·æ•°æ®åº“å®‰å…¨è®¿é—®
* ORM æ¡†æ¶ç‰¹æ€§å¯¼è‡´å‡ºç°â€œæ•°æ®åº“è·¨ç§Ÿæˆ·è¶Šæƒâ€é—®é¢˜çš„æ’æŸ¥è¿‡ç¨‹å’Œè§£å†³åŠæ³•

PSï¼šğŸ”¥ å›¢é˜Ÿæ€¥æ‹›åç«¯ç ”å‘ï¼Œæ„Ÿå…´è¶£å¯ç§ä¿¡è”ç³»ã€‚å¦å¤–å…¬å¸æ­£åœ¨å¹¿çº³äººæ‰ï¼Œå¯å¤åˆ¶è®¿é—®ä¸‹æ–¹é“¾æ¥åœ¨çº¿æŸ¥çœ‹èŒä½è¯¦æƒ…å’ŒæŠ•é€’ç®€å†

**https://app.mokahr.com/su/5wsls**

# 0x02. è¦æ±‚å’Œæ€è·¯

---

åœ¨å¤šç§Ÿæˆ·æ¶æ„ä¸‹ï¼Œä¸åŒå®¢æˆ·çš„è®¿é—®å’Œæ“ä½œå‡å¯¹åº”åŒä¸€å¥—ä»£ç å’ŒæœåŠ¡ï¼Œå¦‚ä½•é˜²æ­¢ä¸€ä¸ªç”¨æˆ·è¶Šæƒè®¿é—®åˆ°å…¶ä»–ç§Ÿæˆ·çš„æ•°æ®ï¼Œæ˜¯ä¸€ä¸ªéå¸¸å…³é”®å’ŒåŸºç¡€çš„å®‰å…¨é—®é¢˜ã€‚è¿™é‡Œé¦–å…ˆæƒ³åˆ°çš„æ–¹æ¡ˆæ˜¯ï¼Œæ¯ä¸ªç§Ÿæˆ·åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„æ•°æ®åº“ï¼Œæœ‰ä¸åŒçš„è´¦å·å¯†ç ï¼Œå¹¶é™åˆ¶è®¿é—®æƒé™ã€‚è€Œä»ç ”å‘å®‰å…¨çš„è§†è§’ï¼Œéœ€è¦å°½é‡é¿å…åœ¨å†™ä¸šåŠ¡ä»£ç æ—¶ï¼Œæ‰‹åŠ¨å¤„ç†é€‰æ‹©å’Œè®¿é—®æ•°æ®åº“èµ„æºçš„æ“ä½œï¼Œå³åœ¨åº•å±‚è¿›è¡Œç»Ÿä¸€çš„å°è£…å’Œå±è”½ï¼Œå®ç°æ ¹æ®å½“å‰ç”¨æˆ·æ‰€å±çš„ç§Ÿæˆ·è‡ªåŠ¨é€‰æ‹©å¯¹åº”çš„æ•°æ®åº“ã€‚è€Œè¿™ä¹Ÿä¾èµ–ç”¨æˆ·æ‰€å±ç§Ÿæˆ·çš„ä¿¡æ¯æ— æ³•è¢«ç¯¡æ”¹å’Œä¼ªé€ ï¼Œå³éœ€è¦ä¿è¯èº«ä»½è®¤è¯çš„å®‰å…¨æ€§

æ¢³ç†ä¸€ä¸‹ï¼Œæœ‰å‡ ä¸ªè¦ç‚¹

1. è·å–å½“å‰ç™»é™†ç”¨æˆ·æ‰€å±ç§Ÿæˆ·ä¿¡æ¯çš„ä»£ç é€»è¾‘æ˜¯å®‰å…¨çš„
2. ä¸šåŠ¡ä»£ç åªå…³æ³¨åŠŸèƒ½é€»è¾‘ï¼Œå¯¹æ•°æ®åº“çš„é€‰æ‹©æ— æ„ŸçŸ¥
3. ä¸åŒç§Ÿæˆ·å¯¹åº”ä¸åŒæ•°æ®åº“ã€ä¸åŒè´¦å·å¯†ç ï¼Œæ— æ³•ç›¸äº’è®¿é—®

# 0x03. ä»£ç å®è·µ

---

å¹³å°ä½¿ç”¨çš„æŠ€æœ¯æ ˆä¸ºï¼šWeb æ¡†æ¶ Flask ã€æ•°æ®åº“æ¡†æ¶ SQLAlchemyã€å¼‚æ­¥ä»»åŠ¡æ¡†æ¶ Dramatiq

å®ç°è¿‡ç¨‹åŒ…æ‹¬

1. è·å–å½“å‰ç”¨æˆ·æ‰€å±ç§Ÿæˆ·ä¿¡æ¯

è¿™é‡Œä½¿ç”¨ JSON Web Token (JWT) çš„æ–¹å¼æ¥ä¿å­˜ç”¨æˆ·èº«ä»½å’Œæ‰€å±ç§Ÿæˆ·ä¿¡æ¯ã€‚å¯¹äº JWT çš„å®‰å…¨ï¼Œéœ€è¦ç¡®ä¿è¿›è¡Œ signature çš„éªŒè¯ï¼ˆç¬¬ä¸‰æ–¹åº“é€šå¸¸é»˜è®¤å¼€å¯ï¼‰ï¼Œä»¥åŠä½¿ç”¨çš„ secret key å¤æ‚åº¦è¶³å¤Ÿå¼ºã€‚å¦å¤–ä¸ºäº†é¿å…å…±ç”¨ secret key æ³„éœ²åç›¸äº’å½±å“ï¼Œè¿™é‡Œä¸ºæ¯ä¸ªç§Ÿæˆ·ç”Ÿæˆä¸åŒäº† secret keyã€‚ä»£ç ç¤ºä¾‹å¦‚ä¸‹

```
```
verified_info = jwt.decode(jwt_token, jwt_secret)enterprise_id = verified_info.get("enterprise_id")
```

JWT å®‰å…¨éƒ¨åˆ†è¯¦ç»†å¯å‚è€ƒ https://portswigger.net/web-security/jwt
```

2. åœ¨å½“å‰ä¸Šä¸‹æ–‡è®¾ç½®æ‰€å±ç§Ÿæˆ·ä¿¡æ¯

åœ¨ Flask ä¸­æä¾›äº† Application Context æ¥å®ç°åœ¨ä¸€æ¬¡è¯·æ±‚ã€CLI å‘½ä»¤ç­‰éœ€è¦åœ¨ç‰¹å®šæ‰§è¡ŒèŒƒå›´å†…ï¼Œç®¡ç†å’Œå…±äº«æ•°æ®çš„èƒ½åŠ›ã€‚ä½¿ç”¨è€…å¯åœ¨å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œé€šè¿‡ `g` proxy å˜é‡æ¥è®¾ç½®ã€è®¿é—®ã€ä¿®æ”¹æ•°æ®ã€‚è¯¦ç»†å¯å‚è€ƒ

* https://flask.palletsprojects.com/en/3.0.x/appcontext/
* flask.g https://flask.palletsprojects.com/en/3.0.x/api/#flask.g

ä»£ç å®ç°æ–¹é¢ï¼Œéœ€è¦åŒºåˆ†ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ã€‚ä¸€æ˜¯ç”¨æˆ·ä½¿ç”¨å¹³å°è®¿é—® Web æ¥å£ï¼ŒFlask ä¼šåœ¨å¤„ç†è¯·æ±‚å‰åï¼Œè‡ªåŠ¨ push å’Œ pop application contextã€‚æˆ‘ä»¬åªéœ€è¦åœ¨ç”¨æˆ·æˆåŠŸç™»å½•åï¼Œé€šè¿‡`g`å˜é‡è®¾ç½®ç§Ÿæˆ·çš„ä¿¡æ¯ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹

```
```
from flask import g
g.enterprise_id = "tenant-A"
```

å¦ä¸€ä¸ªä¸šåŠ¡åœºæ™¯æ˜¯æ‰§è¡Œç§Ÿæˆ·ç›¸å…³çš„å¼‚æ­¥ä»»åŠ¡ã€‚æ­¤æ—¶æˆ‘ä»¬éœ€è¦
```

1. åœ¨æ‰§è¡Œä»»åŠ¡çš„å‰å push å’Œ pop application context
2. å‘é€ä»»åŠ¡æ—¶ï¼Œè‡ªåŠ¨åœ¨å‚æ•°ä¸­æ·»åŠ æ‰€å±ç§Ÿæˆ·ä¿¡æ¯
3. æ‰§è¡Œä»»åŠ¡å‰åï¼Œä»å‚æ•°ä¸­è·å–ç§Ÿæˆ·ä¿¡æ¯ï¼Œé€šè¿‡Â `g`å˜é‡è®¾ç½®/æ¸…é™¤ç§Ÿæˆ·ä¿¡æ¯

åœ¨ Dramatiq æ¡†æ¶ä¸­ï¼Œæˆ‘ä»¬å¯é€šè¿‡ç¼–å†™è‡ªå®šä¹‰ Middlewareï¼Œåœ¨å¯¹åº” hooks å‡½æ•°ä¸­å®ç°ä»¥ä¸Šé€»è¾‘ï¼Œè¯¦ç»†å‚è€ƒ https://dramatiq.io/reference.html#middleware

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼Œéœ€æ±‚ 1 å¯¹åº” AppContextMiddlewareï¼Œéœ€æ±‚ 2ï¼Œ3 å¯¹åº” EnterpriseMiddleware

```
```
from threading import localfrom dramatiq import Message, Middlewarefrom flask import g

class AppContextMiddleware(Middleware):    # æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±ç‹¬ç«‹çš„ context    STATE = local()
    def __init__(self, app):        self.app = app
    def before_process_message(self, broker, message):        context: AppContext = self.app.app_context()        context.push()        self.STATE.context = context
    def after_process_message(self, broker, message, *, result=None, exception=None):        try:            context = self.STATE.context            context.pop(exception)            del self.STATE.context        except AttributeError:            pass
    after_skip_message = after_process_message

class EnterpriseMiddleware(Middleware):
    def before_enqueue(self, broker, message: Message, delay):        # å‘é€ä»»åŠ¡æ—¶è‡ªåŠ¨è®¾ç½®  enterprise_id        message.options.setdefault("enterprise_id", g.enterprise_id)
    def before_process_message(self, broker, message):        if enterprise_id := message.options.get("enterprise_id", None):            g.enterprise_id = enterprise_id
    def after_process_message(self, broker, message, *, result=None, exception=None):        g.pop("enterprise_id", None)
    after_skip_message = after_process_message
```
```

3. æ•°æ®è®¿é—®æ“ä½œæ—¶ï¼Œæ ¹æ®å½“å‰æ‰€å±ç§Ÿæˆ·é€‰æ‹©å¯¹åº”æ•°æ®åº“

åœ¨ SQLAlchemy ä¸­ï¼Œä¼šä½¿ç”¨ Session æ¥è¿›è¡Œ ORM ç›¸å…³æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é‡å†™ Session çš„ `get_bind`æ–¹æ³•æ¥å®ç°æ ¹æ®ç¬¬ä¸€æ­¥ä¸­çš„ç§Ÿæˆ·ä¿¡æ¯ `g.enterprise_id`æ¥åŠ¨æ€é€‰æ‹©å¯¹åº”æ•°æ®åº“è¿æ¥ï¼ˆé€šå¸¸ä¸º Engine å®ä¾‹ï¼‰

ä»£ç ç¤ºä¾‹å¦‚ä¸‹

```
```
from flask_sqlalchemy.session import Sessionfrom flask import g
class DynamicSession(Session):    def get_bind(        self,        mapper: t.Any | None = None,        clause: t.Any | None = None,        bind: sa.engine.Engine | sa.engine.Connection | None = None,        **kwargs: t.Any,    ) -> sa.engine.Engine | sa.engine.Connection:        found_bind = None          if bind_key := g.get("enterprise_id", ""):            found_bind = self._db.engines.get(bind_key)                # å…¶ä»–é€»è¾‘ ...
        if not found_bind:            found_bind = super().get_bind(mapper, clause, bind, **kwargs)
        return found_bind
```
```

å…¶ä¸­ `self._db.engines`ä¿å­˜äº†æ‰€æœ‰ç§Ÿæˆ·æ•°æ®åº“çš„è¿æ¥ä¿¡æ¯ï¼Œç±»å‹ä¸º mapï¼Œkey ä¸ºç§Ÿæˆ·çš„ IDã€‚è¿™éƒ¨åˆ†ç”±å¦ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹å®šæ—¶åŒæ­¥å’ŒåŠ¨æ€åŠ è½½ç§Ÿæˆ·çš„æ•°æ®åº“è¿æ¥é…ç½®ã€‚

è¯¦ç»†å¯å‚è€ƒ

* Session.get\_bind https://docs.sqlalchemy.org/en/20/orm/session\_api.html#sqlalchemy.orm.Session.get\_bind
* Engine https://docs.sqlalchemy.org/en/20/core/engines.html

# 0x04. å®‰å…¨é—®é¢˜

---

åœ¨å®Œæˆä¸Šè¿°æ•°æ®å®‰å…¨éš”ç¦»æªæ–½åï¼Œæˆ‘ä»¬ä»é‡åˆ°äº†åœ¨ç‰¹å®šåœºæ™¯ä¸‹ â€œæŸä¸ªç§Ÿæˆ·è·å–åˆ°äº†å…¶ä»–ç§Ÿæˆ·æ•°æ®â€ çš„å®‰å…¨é—®é¢˜ã€‚

é¦–å…ˆä»‹ç»å‘ç”Ÿé—®é¢˜çš„ä¸šåŠ¡åœºæ™¯â€œæ‰«æä»»åŠ¡çš„æ‰§è¡Œâ€ã€‚å½“ç”¨æˆ·åœ¨å¹³å°åˆ›å»ºä»»åŠ¡åï¼Œå¹¶ä¸ä¼šç«‹åˆ»è¢«è¿è¡Œï¼Œè€Œæ˜¯åœ¨â€œä»»åŠ¡é˜Ÿåˆ—è¡¨â€ä¸­æ’å…¥ä¸€æ¡æ•°æ®ã€‚å†ç”±â€œä»»åŠ¡è°ƒåº¦æœåŠ¡â€å®šæœŸæ£€æŸ¥ä»»åŠ¡é˜Ÿåˆ—è¡¨ä¸­æ˜¯å¦æœ‰ä»»åŠ¡ï¼Œæ»¡è¶³è¿è¡Œçš„æ¡ä»¶åæ‰ä¼šå‘é€åˆ°é˜Ÿåˆ—è¿è¡Œã€‚åœ¨å¤šç§Ÿæˆ·æ¶æ„ä¸‹ï¼Œâ€œä»»åŠ¡è°ƒåº¦æœåŠ¡â€ä¼šä¾æ¬¡è®¿é—®æ‰€æœ‰ç§Ÿæˆ·çš„æ•°æ®åº“è¿›è¡Œæ£€æŸ¥ï¼Œå…¶ä»£ç ç¤ºä¾‹å¦‚ä¸‹

```
while True:    enterprise_ids = get_enterprise_ids()        for enterprise_id in enterprise_ids:      # è®¾ç½® g.enterprise_id å€¼ï¼Œç”¨äºåˆ‡æ¢æ•°æ®åº“      with bind_enterprise(enterprise_id):Â Â Â Â Â Â Â Â # æŸ¥è¯¢å¾…è¿è¡Œçš„ä»»åŠ¡åˆ—è¡¨        stmt = select(TaskQueue).where(TaskQueue.handled == false())        tasks = session.scalars(stmt).all()        # ... è¿è¡Œæ¡ä»¶æ£€æŸ¥        # å‘é€ä»»åŠ¡åˆ°é˜Ÿåˆ—        for task in tasks:          _send_task(task)          # æ¯ä¸ªç§Ÿæˆ·å•æ¬¡åªå‘é€ä¸€ä¸ªä»»åŠ¡          break        time.sleep(1)
```

`TaskQueue`Â model çš„å®šä¹‰å¦‚ä¸‹

```
class TaskQueue(Base):  id: Mapped[int] = mapped_column(    BigInteger(), primary_key=True  )  task_id: Mapped[int] = mapped_column(    BigInteger(), nullable=False, index=True  )  # ä»»åŠ¡å¯¹åº”çš„å…¨å±€å”¯ä¸€æ¶ˆæ¯ UUID  message_id: Mapped[str] = mapped_column(    String(36), index=True, nullable=False  )  # æ˜¯å¦å·²å¤„ç†  handled: Mapped[bool] = mapped_column(        Boolean(), default=False, server_default=false()  )
```

è¿è¡Œä»»åŠ¡çš„ä»£ç å‡½æ•°

```
@dramatiq.actor(queue_name="task")def run_flow_task(task_id):    try:      obj = get_task_obj_by_id(task_id)      ...    except Exception:      ...
```

æŸå¤©ç›‘æ§å‘Šè­¦å‘ç°ï¼Œåœ¨ç§Ÿæˆ· A ä¸‹è¿è¡Œä»»åŠ¡æŠ¥é”™ï¼Œé”™è¯¯ä¿¡æ¯ä¸ºâ€œtask\_id = 121 åœ¨æ•°æ®åº“é‡Œä»»åŠ¡è®°å½•ä¸å­˜åœ¨â€ï¼Œå…¶æ¶ˆæ¯ IDï¼ˆmessage\_idï¼‰ä¸º `6d4a0abc-d277-44db-8f6a-2a90491b1dee`ã€‚ä¹‹åæˆ‘ä»¬å¼€å§‹æ’æŸ¥ï¼Œåœ¨ç§Ÿæˆ· A å¯¹åº”çš„æ•°æ®åº“ä¸­ï¼Œæœ€å¤§çš„ä»»åŠ¡ ID ä¸º 39ï¼Œç¡®å®ä¸å­˜åœ¨ 121 çš„è®°å½•ã€‚æ¥ç€å¼€å§‹æŸ¥è¯¢ â€œä»»åŠ¡è°ƒåº¦æœåŠ¡â€ çš„æ—¥å¿—ï¼Œå‘ç°æ—¥å¿—ä¸­çš„å‚æ•°å€¼å’Œé”™è¯¯ä¿¡æ¯èƒ½å¯¹åº”ä¸Š

ä»»åŠ¡è°ƒåº¦æœåŠ¡æ—¥å¿—

```
ç§Ÿæˆ·Aï¼šsend message_id='xxxx' task_id=37ç§Ÿæˆ·Aï¼šsend message_id='6d4a0abc-d277-44db-8f6a-2a90491b1dee' task_id=121ç§Ÿæˆ·Aï¼šsend message_id='xxxx' task_id=39
```

æ ¹æ®å‰åçš„æ—¥å¿—åˆ¤æ–­ï¼Œæ­£ç¡®çš„ task\_id åº”è¯¥æ˜¯ 38ã€‚åˆ°ç§Ÿæˆ· A çš„ â€œä»»åŠ¡é˜Ÿåˆ—è¡¨â€ ä¸­æŸ¥çœ‹ï¼Œç¡®å®æœ‰ 38ï¼Œä½† message\_id æ˜¯ `47fb72b3-64dd-460d-bc03-bccfe18fa039`ä¸å‰é¢ä»»åŠ¡è°ƒåº¦å™¨çš„æ—¥å¿—å¯¹åº”ä¸ä¸Š

ç§Ÿæˆ·A-ä»»åŠ¡é˜Ÿåˆ—è¡¨æ•°æ®

```
id, task_id, message_id40, 37, xxxxx     41, 38, 47fb72b3-64dd-460d-bc03-bccfe18fa03942, 39, xxxx
```

â€œä»»åŠ¡è°ƒåº¦æœåŠ¡æ—¥å¿—â€ ä¸­æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹æ˜¯ï¼Œå‰å task\_id 37 å’Œ 39 çš„ä¸¤ä¸ªä»»åŠ¡æ˜¯æ­£å¸¸è¿è¡Œçš„ï¼Œç»è¿‡æ‰‹å·¥æµ‹è¯•ï¼Œä¹Ÿæ— æ³•å¤ç°è¯¥é—®é¢˜ã€‚

å› ä¸º message\_id Â ä¸ºå…¨å±€å”¯ä¸€æ¶ˆæ¯ IDï¼Œæ ¹æ®æ—¥å¿—æŸ¥è¯¢åˆ°Â `47fb72b3-64dd-460d-bc03-bccfe18fa039`å±äºç§Ÿæˆ·Bï¼Œå…¶â€œä»»åŠ¡é˜Ÿåˆ—è¡¨è¡¨â€æ•°æ®å¦‚ä¸‹ï¼Œtask\_id ä¸º `121` ä¹Ÿèƒ½å¯¹çš„ä¸Š

ç§Ÿæˆ·B-ä»»åŠ¡é˜Ÿåˆ—è¡¨æ•°æ®

```
id, task_id, message_id41, 121, 47fb72b3-64dd-460d-bc03-bccfe18fa039
```

ä¸Šè¿°é—®é¢˜çš„è¡¨ç°åƒæ˜¯â€œç§Ÿæˆ·Aâ€è¯»å–åˆ°çš„â€œç§Ÿæˆ·Bâ€ä¸‹çš„æ•°æ®ï¼Œå‡ºç°äº†è·¨ç§Ÿæˆ·è¶Šæƒçš„é—®é¢˜ã€‚èµ·åˆæˆ‘ä»¬æ€€ç–‘æ˜¯ä»£ç å®ç°æœ‰é—®é¢˜ï¼Œä½†ç»è¿‡æ’æŸ¥å’Œè®¨è®ºï¼Œå¹¶æœªæ‰¾åˆ°åŸå› ã€‚

æˆ‘ä»¬åˆç»§ç»­æ’æŸ¥ä»»åŠ¡è°ƒåº¦æ—¥å¿—ï¼Œå‘ç°åœ¨ç§Ÿæˆ·Aä¹‹å‰ï¼Œè°ƒåº¦çš„ä¸Šä¸€ä¸ªç§Ÿæˆ·æ°å·§æ˜¯ç§Ÿæˆ·Bçš„ï¼Œä¸”ä¹Ÿæ‰¾åˆ°äº†åŒ `message_id`å’Œ `task_id`çš„ä»»åŠ¡å‘é€æ—¥å¿—ï¼ˆç¬¬ä¸€è¡Œå’Œç¬¬å››è¡Œï¼‰

```
ç§Ÿæˆ·Bï¼šsend message_id='6d4a0abc-d277-44db-8f6a-2a90491b1dee' task_id=121...ç§Ÿæˆ·Aï¼šsend message_id='xxxx' task_id=37ç§Ÿæˆ·Aï¼šsend message_id='6d4a0abc-d277-44db-8f6a-2a90491b1dee' task_id=121ç§Ÿæˆ·Aï¼šsend message_id='xxxx' task_id=39
```

å†æ ¹æ® â€œä»»åŠ¡é˜Ÿåˆ—è¡¨â€ çš„æ•°æ®å¯¹æ¯”ï¼Œå‘ç°è¿™ä¸¤æ¡æ•°æ®æ‹¥æœ‰ç›¸åŒçš„æ•°æ®åº“ä¸»é”®å€¼ï¼Œid å‡ä¸º 41

```
ç§Ÿæˆ·Aid, task_id, message_id41, 38, 47fb72b3-64dd-460d-bc03-bccfe18fa039

ç§Ÿæˆ·Bid, task_id, message_id41, 121, 47fb72b3-64dd-460d-bc03-bccfe18fa039
```

æ ¹æ®ä¸Šè¿°è¡¨ç°ï¼Œæˆ‘ä»¬æ€€ç–‘æ˜¯ä¸šåŠ¡å±‚ä»£ç åœ¨è¿›è¡Œæ•°æ®åº“æŸ¥è¯¢æ—¶ï¼Œæ²¡æœ‰åˆ·æ–°å·²åŠ è½½åˆ°å†…å­˜ä¸­çš„æ•°æ®ã€‚

ç»è¿‡æ–‡æ¡£çš„æœç´¢ï¼Œå‘ç°åœ¨ SQLAlchemy ORM ä¸­å­˜åœ¨ä¸€ä¸ªé»˜è®¤ç‰¹æ€§ï¼Œâ€œåŒä¸€ä¸»é”® model object åªä¼šè¢« load ä¸€æ¬¡ï¼Œåç»­å†æ¬¡æŸ¥è¯¢ä¸ä¼šæ›´æ–°å½“å‰ object çš„çŠ¶æ€â€ï¼Œç›®çš„ä¸ºäº†ä¿ç•™å†…å­˜ä¸­ model å·²ç»è¢«ä¿®æ”¹çš„çŠ¶æ€ï¼Œä»¥åŠé¿å…åˆ·æ–°å·²ç»å­˜åœ¨æ•°æ®çš„æˆæœ¬å’Œå¤æ‚åº¦ã€‚å®˜æ–¹æ–‡æ¡£ä¸­çš„æè¿°åŸæ–‡ä¸º

Normally, ORM objects are only loaded once, and if they are matched up to the primary key in a subsequent result row, the row is not applied to the object. This is both to preserve pending, unflushed changes on the object as well as to avoid the overhead and complexity of refreshing data which is already there.

æ–‡æ¡£åœ°å€ï¼šhttps://docs.sqlalchemy.org/en/20/orm/queryguide/api.html#populate-existing

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä»£ç ç¤ºä¾‹ï¼Œä»¥ä¾¿æ›´å¥½çš„ç†è§£ç‰¹æ€§èƒŒåçš„è¡¨ç°ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ª User modelï¼Œæœ‰ ...