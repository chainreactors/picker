---
title: Linux 时钟源之 TSC：软硬件原理、使用场景、已知问题（2024）
url: https://arthurchiao.github.io/blog/linux-clock-source-tsc-zh/
source: ArthurChiao's Blog
date: 2024-07-29
fetch_date: 2025-10-06T17:38:47.496181
---

# Linux 时钟源之 TSC：软硬件原理、使用场景、已知问题（2024）

# [ArthurChiao's Blog](https://arthurchiao.github.io/)

* [Home](/index.html)
* [Articles (EN)](/articles)
* [Articles (дёӯж–Ү)](/articles-zh)
* [Categories](/categories)
* [About](/about)
* [Donate](/donate)

# Linux ж—¶й’ҹжәҗд№Ӣ TSCпјҡиҪҜзЎ¬д»¶еҺҹзҗҶгҖҒдҪҝз”ЁеңәжҷҜгҖҒе·ІзҹҘй—®йўҳпјҲ2024пјү

Published at 2024-07-28 | Last Update 2024-10-10

жң¬ж–Үж•ҙзҗҶдәҶдёҖдәӣ Linux ж—¶й’ҹжәҗ `tsc` зӣёе…ізҡ„иҪҜзЎ¬д»¶зҹҘиҜҶпјҢеңЁдёҖдәӣж•…йҡңжҺ’жҹҘеңәжҷҜеҸҜиғҪдјҡз”ЁеҲ°гҖӮ

![](/assets/img/linux-clock-source/freq-scale-up.gif)

Fig. Scaling up crystal frequency for different components of a computer.
Image source [Youtube](https://www.youtube.com/watch?v=B7djs4zSbuU&t=150s)

ж°ҙе№іеҸҠз»ҙжҠӨзІҫеҠӣжүҖйҷҗпјҢж–ҮдёӯдёҚе…ҚеӯҳеңЁй”ҷиҜҜжҲ–иҝҮж—¶д№ӢеӨ„пјҢиҜ·й…Ңжғ…еҸӮиҖғгҖӮ
**дј ж’ӯзҹҘиҜҶпјҢе°ҠйҮҚеҠіеҠЁпјҢе№ҙж»ЎеҚҒе…«е‘ЁеІҒпјҢиҪ¬иҪҪиҜ·жіЁжҳҺ[еҮәеӨ„](https://arthurchiao.art)**гҖӮ

---

* [1 и®Ўз®—жңәз»„д»¶зҡ„иҝҗиЎҢйў‘зҺҮ](#1-и®Ўз®—жңәз»„д»¶зҡ„иҝҗиЎҢйў‘зҺҮ)
  + [1.1 ж—¶й’ҹжәҗпјҡ**`~20MHz`** зҡ„зҹіиӢұжҷ¶дҪ“и°җжҢҜеҷЁпјҲquartz crystal resonatorпјү](#11-ж—¶й’ҹжәҗ20mhz-зҡ„зҹіиӢұжҷ¶дҪ“и°җжҢҜеҷЁquartz-crystal-resonator)
  + [1.2 Clock generatorпјҡй’ҲеҜ№дёҚеҗҢйғЁеҲҶпјҲеҶ…еӯҳгҖҒPCIeгҖҒCPU зӯүпјүеҖҚйў‘](#12-clock-generatorй’ҲеҜ№дёҚеҗҢйғЁеҲҶеҶ…еӯҳpciecpu-зӯүеҖҚйў‘)
  + [1.3 CPU йў‘зҺҮжҳҜеҰӮдҪ•д»Һ `~20MHz` жҸҗеҚҮеҲ° **`~3GHz`** зҡ„](#13-cpu-йў‘зҺҮжҳҜеҰӮдҪ•д»Һ-20mhz-жҸҗеҚҮеҲ°-3ghz-зҡ„)
    - [1.3.1 дј йҖ’и·Ҝеҫ„пјҡжңҖз»ҲиҝһжҺҘеҲ° CPU `CLK` еј•и„ҡ](#131-дј йҖ’и·Ҝеҫ„жңҖз»ҲиҝһжҺҘеҲ°-cpu-clk-еј•и„ҡ)
    - [1.3.2 CPU еҶ…йғЁпјҡиҝҳжңүдёҖдёӘ clock generator](#132-cpu-еҶ…йғЁиҝҳжңүдёҖдёӘ-clock-generator)
* [2 x86 жһ¶жһ„зҡ„еҜ„еӯҳеҷЁ](#2-x86-жһ¶жһ„зҡ„еҜ„еӯҳеҷЁ)
  + [2.1 йҖҡз”Ёзӣ®зҡ„еҜ„еӯҳеҷЁ](#21-йҖҡз”Ёзӣ®зҡ„еҜ„еӯҳеҷЁ)
  + [2.2 зү№ж®Ҡзӣ®зҡ„еҜ„еӯҳеҷЁ](#22-зү№ж®Ҡзӣ®зҡ„еҜ„еӯҳеҷЁ)
    - [2.2.1 model-specific register (`MSR`)](#221-model-specific-register-msr)
    - [2.2.2 `MSR` д№ӢдёҖпјҡ`TSC`](#222-msr-д№ӢдёҖtsc)
* [3 TSCпјҲж—¶й—ҙжҲіи®Ўж•°еҷЁпјү](#3-tscж—¶й—ҙжҲіи®Ўж•°еҷЁ)
  + [3.1 жң¬иҙЁпјҡX86 еӨ„зҗҶеҷЁдёӯзҡ„дёҖдёӘ **зү№ж®ҠеҜ„еӯҳеҷЁ**](#31-жң¬иҙЁx86-еӨ„зҗҶеҷЁдёӯзҡ„дёҖдёӘ-зү№ж®ҠеҜ„еӯҳеҷЁ)
  + [3.2 дҪңз”Ёпјҡи®°еҪ• cpu еҗҜеҠЁд»ҘжқҘзҙҜи®Ўзҡ„ **`cycles`** ж•°йҮҸ](#32-дҪңз”Ёи®°еҪ•-cpu-еҗҜеҠЁд»ҘжқҘзҙҜи®Ўзҡ„-cycles-ж•°йҮҸ)
  + [3.3 е®һйҷ…пјҡз»Ҹеёёиў«еҪ“еҒҡпјҲй«ҳзІҫеәҰпјүж—¶й’ҹз”Ё](#33-е®һйҷ…з»Ҹеёёиў«еҪ“еҒҡй«ҳзІҫеәҰж—¶й’ҹз”Ё)
    - [3.3.1 дҪҝз”Ёд»Јз Ғ](#331-дҪҝз”Ёд»Јз Ғ)
    - [3.3.1 жҪңеңЁй—®йўҳ](#331-жҪңеңЁй—®йўҳ)
  + [3.4 жҢ‘жҲҳпјҡTSC зҡ„еҮҶзЎ®жҖ§и¶ҠжқҘи¶Ҡйҡҫд»ҘдҝқиҜҒ](#34-жҢ‘жҲҳtsc-зҡ„еҮҶзЎ®жҖ§и¶ҠжқҘи¶Ҡйҡҫд»ҘдҝқиҜҒ)
  + [3.5 ж”№иҝӣпјҡеј•е…Ҙ constant/invariant TSC](#35-ж”№иҝӣеј•е…Ҙ-constantinvariant-tsc)
  + [3.5 е°Ҹз»“пјҡ**и®Ўж•°еҷЁ**пјҲcounterпјүпјҢиҖҢйқһж—¶й’ҹпјҲclockпјү](#35-е°Ҹз»“и®Ўж•°еҷЁcounterиҖҢйқһж—¶й’ҹclock)
* [4 жҹҘзңӢе’Ңзӣ‘жҺ§ TSC зӣёе…ідҝЎжҒҜ](#4-жҹҘзңӢе’Ңзӣ‘жҺ§-tsc-зӣёе…ідҝЎжҒҜ)
  + [4.1 Linux зі»з»ҹж—¶й’ҹжәҗпјҲ`clocksource`пјүй…ҚзҪ®](#41-linux-зі»з»ҹж—¶й’ҹжәҗclocksourceй…ҚзҪ®)
    - [4.1.1 `tsc`пјҡдјҳе…Ҳ](#411-tscдјҳе…Ҳ)
    - [4.1.2 `hpet`пјҡжҖ§иғҪејҖй”ҖеӨӘеӨ§](#412-hpetжҖ§иғҪејҖй”ҖеӨӘеӨ§)
  + [4.2 `turbostat` жҹҘзңӢе®һйҷ… TSC и®Ўж•°пјҲеҸҜиғҪдёҚеҮҶпјү](#42-turbostat-жҹҘзңӢе®һйҷ…-tsc-и®Ўж•°еҸҜиғҪдёҚеҮҶ)
  + [4.3 `rdtsc/rdtscp` жҢҮд»ӨйҮҮйӣҶ TSC и®Ўж•°](#43-rdtscrdtscp-жҢҮд»ӨйҮҮйӣҶ-tsc-и®Ўж•°)
    - [4.3.1 C д»Јз Ғ](#431-c-д»Јз Ғ)
    - [4.3.2 жү§иЎҢж•Ҳжһң](#432-жү§иЎҢж•Ҳжһң)
  + [4.4 зӣ‘жҺ§](#44-зӣ‘жҺ§)
    - [4.4.1 еҹәдәҺ `turbostat`пјҲдёҚжҺЁиҚҗпјү](#441-еҹәдәҺ-turbostatдёҚжҺЁиҚҗ)
    - [4.4.2 еҹәдәҺ `rdtscp`](#442-еҹәдәҺ-rdtscp)
    - [4.4.3 еҹәдәҺ `rdtscp` + еҶ…ж ёжЁЎеқ—](#443-еҹәдәҺ-rdtscp--еҶ…ж ёжЁЎеқ—)
* [5 TSC иӢҘе№Іеқ‘](#5-tsc-иӢҘе№Іеқ‘)
  + [5.1 `constant_tsc`: a feature, not a runtime guarantee](#51-constant_tsc-a-feature-not-a-runtime-guarantee)
    - [5.1.1 Lenovo SR645 (AMD EPYC 7543 CPU) TSC дёҚзЁіе®ҡ](#511-lenovo-sr645-amd-epyc-7543-cpu-tsc-дёҚзЁіе®ҡ)
    - [5.1.2 еҺҹеӣ еҸҠи§ЈеҶіж–№ејҸ](#512-еҺҹеӣ еҸҠи§ЈеҶіж–№ејҸ)
  + [5.2 BIOS и®ҫзҪ®иҮҙдҪҝ TSC дёҚжҒ’е®ҡ](#52-bios-и®ҫзҪ®иҮҙдҪҝ-tsc-дёҚжҒ’е®ҡ)
    - [5.2.1 TSC еҜ„еӯҳеҷЁжҳҜ**еҸҜеҶҷ**зҡ„пјҒ](#521-tsc-еҜ„еӯҳеҷЁжҳҜеҸҜеҶҷзҡ„)
    - [5.2.2 BIOS SMI handler йҖҡиҝҮдҝ®ж”№ TSC йҡҗи—Ҹе®ғд»¬зҡ„жү§иЎҢ](#522-bios-smi-handler-йҖҡиҝҮдҝ®ж”№-tsc-йҡҗи—Ҹе®ғд»¬зҡ„жү§иЎҢ)
    - [5.2.3 жңҚеҠЎеҷЁеҺӮе•ҶеҮәдәҺеҠҹиҖ—жҺ§еҲ¶зӯүеҺҹеӣ еңЁ BIOS дҝ®ж”№ TSC еҗҢжӯҘйҖ»иҫ‘](#523-жңҚеҠЎеҷЁеҺӮе•ҶеҮәдәҺеҠҹиҖ—жҺ§еҲ¶зӯүеҺҹеӣ еңЁ-bios-дҝ®ж”№-tsc-еҗҢжӯҘйҖ»иҫ‘)
  + [5.3 SMI дёӯж–ӯйЈҺжҡҙеҜјиҮҙ TSC дёҚзЁі](#53-smi-дёӯж–ӯйЈҺжҡҙеҜјиҮҙ-tsc-дёҚзЁі)
  + [5.4 VM TSC дёҚзЁі](#54-vm-tsc-дёҚзЁі)
* [6 жҖ»з»“](#6-жҖ»з»“)
* [еҸӮиҖғиө„ж–ҷ](#еҸӮиҖғиө„ж–ҷ)

---

# 1 и®Ўз®—жңәз»„д»¶зҡ„иҝҗиЎҢйў‘зҺҮ

## 1.1 ж—¶й’ҹжәҗпјҡ**`~20MHz`** зҡ„зҹіиӢұжҷ¶дҪ“и°җжҢҜеҷЁпјҲquartz crystal resonatorпјү

зҹіиӢұжҷ¶дҪ“и°җжҢҜеҷЁжҳҜеҲ©з”Ё**зҹіиӢұжҷ¶дҪ“пјҲеҸҲз§°ж°ҙжҷ¶пјү**зҡ„**еҺӢз”өж•Ҳеә”**
жқҘдә§з”ҹй«ҳзІҫеәҰ**жҢҜиҚЎйў‘зҺҮ**зҡ„дёҖз§Қз”өеӯҗеҷЁд»¶гҖӮ

> * 1880 е№ҙз”ұйӣ…е…ӢВ·еұ…йҮҢдёҺзҡ®еҹғе°”В·еұ…йҮҢеҸ‘зҺ°еҺӢз”өж•Ҳеә”гҖӮ
> * дёҖжҲҳжңҹй—ҙ дҝқзҪ—В·жң—д№ӢдёҮйҰ–е…ҲжҺўи®ЁдәҶзҹіиӢұи°җжҢҜеҷЁеңЁеЈ°зәідёҠзҡ„еә”з”ЁгҖӮ
> * 1917 з¬¬дёҖдёӘз”ұжҷ¶дҪ“жҺ§еҲ¶зҡ„з”өеӯҗејҸжҢҜиҚЎеҷЁгҖӮ
> * 1918 е№ҙиҙқе°”е®һйӘҢе®Өзҡ„ Alexander M. Nicholson еҸ–еҫ—дё“еҲ©пјҢиҷҪз„¶дёҺеҗҢж—¶з”іиҜ·дё“еҲ©зҡ„ Walter Guyton Cady жӣҫжңүдәүи®®гҖӮ
> * 1921 е№ҙ Cady еҲ¶дҪңдәҶз¬¬дёҖдёӘзҹіиӢұжҷ¶дҪ“жҢҜиҚЎеҷЁгҖӮ
>
> Wikipedia [зҹіиӢұжҷ¶дҪ“и°җжҢҜеҷЁ](https://zh.wikipedia.org/zh-cn/%E7%9F%B3%E8%8B%B1%E6%99%B6%E4%BD%93%E8%B0%90%E6%8C%AF%E5%99%A8)

зҺ°еңЁдёҖиҲ¬й•ҝиҝҷж ·пјҢз„ҠеңЁи®Ўз®—жңә**дё»жқҝ**дёҠпјҢ

![](/assets/img/linux-clock-source/Crystal_oscillator_4MHz.jpg)

Fig. A miniature 16 MHz quartz crystal enclosed in a hermetically sealed HC-49/S package, used as the resonator in a crystal oscillator.
Image source [wikipedia](https://en.wikipedia.org/wiki/Crystal_oscillator)

еҸ—зү©зҗҶзү№жҖ§зҡ„йҷҗеҲ¶пјҢеҸӘжңү**еҮ еҚҒ MHz**гҖӮ

## 1.2 Clock generatorпјҡй’ҲеҜ№дёҚеҗҢйғЁеҲҶпјҲеҶ…еӯҳгҖҒPCIeгҖҒCPU зӯүпјүеҖҚйў‘

и®Ўз®—жңәзҡ„еҶ…еӯҳгҖҒPCIe и®ҫеӨҮгҖҒCPU зӯүзӯүз»„д»¶йңҖиҰҒзҡ„е·ҘдҪңйў‘зҺҮдёҚдёҖж ·пјҲдё»иҰҒеҺҹеӣ д№ӢдёҖжҳҜе…¶д»–з»„д»¶и·ҹдёҚдёҠ CPU зҡ„йў‘зҺҮпјүпјҢ
иҖҢдё”йғҪ**иҝңеӨ§дәҺеҮ еҚҒ MHz**пјҢеӣ жӯӨйңҖиҰҒеҜ№йў‘зҺҮеҒҡжҸҗеҚҮгҖӮе·ҘдҪңеҺҹзҗҶпјҡ

1. [What is a CPU clock physically?](https://cs.stackexchange.com/questions/153752/what-is-a-cpu-clock-physically)
2. [Wikipedia: Phase-locked\_loop (PLL)](https://en.wikipedia.org/wiki/Phase-locked_loop)

жңүдёӘи§Ҷйў‘и§ЈйҮҠең°еҫҲеҪўиұЎпјҢ

![](/assets/img/linux-clock-source/freq-scale-up.gif)

Fig. Scaling up crystal frequency for different components of a computer.
Image source [Youtube](https://www.youtube.com/watch?v=B7djs4zSbuU&t=150s)

еӣҫдёӯзҡ„ clock generator жҳҜдёӘдё“з”ЁиҠҜзүҮпјҢд№ҹжҳҜ**з„ҠеңЁдё»жқҝдёҠ**пјҢдёҖиҲ¬и·ҹжҷ¶жҢҜжҢЁзқҖгҖӮ

## 1.3 CPU йў‘зҺҮжҳҜеҰӮдҪ•д»Һ `~20MHz` жҸҗеҚҮеҲ° **`~3GHz`** зҡ„

жң¬иҠӮзЁҚеҫ®еҶҚејҖеұ•дёҖдёӢпјҢзңӢзңӢ CPU йў‘зҺҮжҳҜеҰӮдҪ•жҸҗеҚҮеҲ°жҲ‘д»¬еёёи§Ғзҡ„ ~3GHz иҝҷд№Ҳй«ҳзҡ„гҖӮ

### 1.3.1 дј йҖ’и·Ҝеҫ„пјҡжңҖз»ҲиҝһжҺҘеҲ° CPU `CLK` еј•и„ҡ

з»“еҗҲдёҠйқўзҡ„еӣҫпјҢж—¶й’ҹдҝЎеҸ·зҡ„**дј йҖ’/жҸҗеҚҮи·Ҝеҫ„**пјҡ

1. жҷ¶жҢҜпјҲ**`~20MHz`**пјү
2. **дё»жқҝдёҠзҡ„ clock generator иҠҜзүҮ**
3. еҢ—жЎҘиҠҜзүҮ
4. CPU

ж—¶й’ҹдҝЎеҸ·иҝһжҺҘеҲ° CPU зҡ„дёҖдёӘеҗҚдёә **`CLK`** зҡ„еј•и„ҡгҖӮ
дёӨдёӘе…·дҪ“зҡ„ CLK еј•и„ҡе®һзү©еӣҫпјҡ

* Intel 486 еӨ„зҗҶеҷЁпјҲ**`1989`**пјү

  ![](/assets/img/linux-clock-source/intel-486-pin-map.png)

  Fig. Intel 486 pin map[Image Source](http://ps-2.kev009.com/eprmhtml/eprmx/12203.htm)

  иҝҷз§Қ CPU еј•и„ҡд»ҠеӨ©зңӢжқҘиҝҳжҳҜеҫҲз®ҖеҚ•зҡ„пјҢCLK еңЁз¬¬дёүиЎҢеҖ’ж•°з¬¬дёүеҲ—гҖӮ
* AMD SP3 CPU Socket (**`2017`**)

  EPYC 7001/7002/7003 зі»еҲ—з”Ёзҡ„иҝҷз§ҚгҖӮеӣҫеӨӘеӨ§дәҶе°ұдёҚж”ҫдәҶпјҢи§Ғ
  [SP3 Pin Map](https://en.wikichip.org/wiki/amd/packages/socket_sp3#Pin_Map)гҖӮ

### 1.3.2 CPU еҶ…йғЁпјҡиҝҳжңүдёҖдёӘ clock generator

зҺ°д»Ј CPU еҶ…йғЁдёҖиҲ¬иҝҳжңүдёҖдёӘ **`clock generator`**пјҢеҸҜд»Ҙз»§з»ӯжҸҗеҚҮйў‘зҺҮпјҢ
жңҖз»ҲиҫҫеҲ°еҺӮе•Ҷе®Јдј йҮҢзҡ„еҹәйў‘пјҲbase frequencyпјүжҲ–ж Үз§°йў‘зҺҮпјҲnominal frequencyпјүпјҢдҫӢеҰӮ EPYC 6543 зҡ„ 2795MHzгҖӮ
иҝҷи·ҹеҺҹе§Ӣжҷ¶жҢҜйў‘зҺҮжҜ”пјҢе·Із»ҸжҸҗеҚҮдәҶдёҠзҷҫеҖҚгҖӮ

# 2 x86 жһ¶жһ„зҡ„еҜ„еӯҳеҷЁ

д»Ӣз»ҚзӮ№еҝ…иҰҒзҡ„иғҢжҷҜзҹҘиҜҶпјҢжңүеҹәзЎҖзҡ„еҸҜи·іиҝҮгҖӮ

## 2.1 йҖҡз”Ёзӣ®зҡ„еҜ„еӯҳеҷЁ

![](/assets/img/x86-asm-guide/x8...