---
title: How we applied advanced fuzzing techniques to cURL
url: https://blog.trailofbits.com/2024/03/01/toward-more-effective-curl-fuzzing/
source: Trail of Bits Blog
date: 2024-03-02
fetch_date: 2025-10-04T12:10:34.980294
---

# How we applied advanced fuzzing techniques to cURL

[The Trail of Bits Blog](/ "The Trail of Bits Blog")

[![Trail of Bits Logo](/img/tob.png)](https://trailofbits.com "Trail of Bits")

# How we applied advanced fuzzing techniques to cURL

Shaun Mirani

March 01, 2024

[application-security](/categories/application-security/), [fuzzing](/categories/fuzzing/), [open-source](/categories/open-source/)

Near the end of 2022, Trail of Bits was hired by the Open Source Technology Improvement Fund (OSTIF) to [perform a security assessment](https://daniel.haxx.se/blog/2022/12/21/the-2022-curl-security-audit/) of the [cURL](https://curl.se/) file transfer command-line utility and its library, [libcurl](https://curl.se/libcurl/). The scope of our engagement included a code review, a threat model, and the subject of this blog post: an engineering effort to analyze and improve cURL’s fuzzing code.

We’ll discuss several elements of this process, including how we identified important areas of the codebase lacking coverage, and then modified the fuzzing code to hit these missed areas. For example, by setting certain libcurl options during fuzzer initialization and introducing new seed files, we doubled the line coverage of the HTTP Strict Transport Security (HSTS) handling code and quintupled it for the `Alt-Svc` header. We also expanded the set of fuzzed protocols to include WebSocket and enabled the fuzzing of many new libcurl options. We’ll conclude this post by explaining some more sophisticated fuzzing techniques the cURL team could adopt to increase coverage even further, bring fuzzing to the cURL command line, and reduce inefficiencies intrinsic to the current test case format.

### How is cURL fuzzed?

[OSS-Fuzz](https://google.github.io/oss-fuzz/), a free service provided by Google for open-source projects, serves as the continuous fuzzing infrastructure for cURL. It supports C/C++, Rust, Go, Python, and Java codebases, and uses the coverage-guided libFuzzer, AFL++, and Honggfuzz fuzzing engines. [OSS-Fuzz adopted cURL on July 1, 2017](https://daniel.haxx.se/blog/2022/07/01/5-years-on-oss-fuzz/), and the incorporated code lives in the `[curl-fuzzer](https://github.com/curl/curl-fuzzer)` repository on GitHub, which was our focus for this part of the engagement.

The repository contains the code (setup scripts, test case generators, harnesses, etc.) and corpora (the sets of initial test cases) needed to fuzz cURL and libcurl. It’s designed to fuzz individual *targets*, which are protocols supported by libcurl, such as HTTP(S), WebSocket, and FTP. curl-fuzzer downloads the latest copy of cURL and its dependencies, compiles them, and builds binaries for these targets against them.

Each target takes a specially structured input file, processes it using the appropriate calls to libcurl, and exits. Associated with each target is a corpus directory that contains interesting seed files for the protocol to be fuzzed. These files are structured using a custom type-length-value (TLV) format that encodes not only the raw protocol data, but also specific fields and metadata for the protocol. For example, the fuzzer for the HTTP protocol includes options for the version of the protocol, custom headers, and whether libcurl should follow redirects.

### First impressions: HSTS and Alt-Svc

We’d been tasked with analyzing and improving the fuzzer’s coverage of libcurl, the library providing curl’s internals. The obvious first question that came to mind was: what does the current coverage look like? To answer this, we wanted to peek at the latest coverage data given in the reports periodically generated by OSS-Fuzz. After some poking around at the URL for the publicly accessible oss-fuzz-coverage Google Cloud Storage bucket, we were able to find the coverage reports for cURL (for future reference, you can get there through the [OSS-Fuzz introspector page](https://oss-fuzz-introspector.storage.googleapis.com/)). [Here’s a report](https://storage.googleapis.com/oss-fuzz-coverage/curl/reports/20220928/linux/src/curl/lib/report.html) from September 28, 2022, at the start of our engagement.

Reading the report, we quickly noticed that several source files were receiving almost no coverage, including some files that implemented security features or were responsible for handling untrusted data. For instance, hsts.c, which provides functions for parsing and handling the `[Strict-Transport-Security](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security)` response header, had only 4.46% line coverage, 18.75% function coverage, and 2.56% region coverage after over five years on OSS-Fuzz:

![](/img/wpdump/fd2f988c32540ded8531fb6a77426054.png)

The file responsible for processing the [Alt-Svc](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Alt-Svc) response header, altsvc.c, was similarly coverage-deficient:

![](/img/wpdump/ae73126e78bda234acffee2418e9ef2e.png)

An investigation of the fuzzing code revealed why these numbers were so low. The first problem was that the corpora directory was missing test cases that included the `Strict-Transport-Security` and `Alt-Svc` headers, which meant there was no way for the fuzzer to quickly jump into testing these regions of the codebase for bugs; it would have to use coverage feedback to construct these test cases by itself, which is usually a slow(er) process.

The second issue was that the fuzzer never set the `[CURLOPT_HSTS](https://curl.se/libcurl/c/CURLOPT_HSTS.html)` option, which instructs libcurl to use an HSTS cache file. As a result, HSTS was never enabled during runs of the fuzzer, and most code paths in `hsts.c` were never hit.

The final impediment to achieving good coverage of HSTS was an issue with its specification, which tells user agents to ignore the `Strict-Transport-Security` header when sent over unencrypted HTTP. However, this creates a problem in the context of fuzzing: from the perspective of our fuzzing target, which never stood up an actual TLS connection, every connection was unencrypted, and `Strict-Transport-Security` was always ignored. For `Alt-Svc`, libcurl already included a [workaround](https://github.com/curl/curl/blob/72652c0613d37ce18e99cca17a42887f12ad43da/lib/http.c#L3735-L3740) to relax the HTTPS requirement for debug builds when a certain environment variable was set (although curl-fuzzer did not set this variable). So, resolving this issue was just a matter of adding a similar feature for HSTS to libcurl and ensuring that curl-fuzzer set all necessary environment variables.

Our changes to address these issues were as follows:

1. We added seed files for `Strict-Transport-Security` and `Alt-Svc` to curl-fuzzer ([ee7fad2](https://github.com/curl/curl-fuzzer/commit/ee7fad2a2869ea3030c1b8d471ff90f51411a5ee)).
2. We enabled `CURLOPT_HSTS` in curl-fuzzer ([0dc42e4](https://github.com/curl/curl-fuzzer/commit/0dc42e4a8f3ec6a6e7074536cd821e18e10243d4#diff-f50315868d5149f08fd9d32ba6606b3c1f92c29f50801d8921bc586e23bcf3e3R205)).
3. We added a check to allow debug builds of libcurl to bypass the HTTPS restriction for HSTS when the `CURL_HSTS_HTTP` environment variable is set, and we set the `CURL_HSTS_HTTP` and `CURL_ALTSVC_HTTP` environment variables in curl-fuzzer ([6efb6b1](https://github.com/curl/curl/commit/6efb6b1e772934da9f3bc0d5dba5420da14ce587) and [937597c](https://github.com/curl/curl-fuzzer/commit/937597c51ecdc7a4140737bfb1e8ed7f24eb4397)).

The day after our changes were merged upstream, OSS-Fuzz [reported](https://storage.googleapis.com/oss-fuzz-coverage/curl/reports/20221016/linux/src/curl/lib/report.html) a significant bump in coverage for both files:

![](/img/wpdump/7a8f5e8698e138911f76b296242cb6ce.png)

![](/img/wpdump/355d2f592ca262228741bd3b82f2220f.png)

A little over a year of fuzzing later (on [January 29, 2024](https://storage.googleapis.com/oss-fuzz-coverage/curl/reports/20240129/linux/src/curl/lib/report.html)), our three fixes had doubled the line coverage for `hsts.c` and nearly quintupled it f...