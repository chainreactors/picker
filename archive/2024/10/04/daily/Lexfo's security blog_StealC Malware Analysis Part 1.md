---
title: StealC Malware Analysis Part 1
url: https://blog.lexfo.fr/StealC_malware_analysis_part1.html
source: Lexfo's security blog
date: 2024-10-04
fetch_date: 2025-10-06T18:50:47.104941
---

# StealC Malware Analysis Part 1

[BLOG POSTS](/index.html) [CATEGORIES](/categories.html) [ARCHIVES](/archives.html)

[CONTACT US](https://lexfo.fr/contact/)

StealC Malware Analysis Part 1

Mon 02 September 2024 by **Lexfo** in [Malware Analysis](category/malware-analysis.html)

# 01 - Introduction

This series of blog posts is aimed at a technical audience interested in reverse engineering and, more specifically, malware analysis.

In this article, we'll take a look at the analysis of a malicious sample for Windows from the StealC family, from the packed sample to the recovery of C2.

We'll automate our analysis steps with a view to integrating them into an automated pipeline for extracting indicators of compromise.

In the [second article](./StealC_malware_analysis_part2.html) we'll retrieve C2 from the loader, get the third stage sample and unpack it.

The [third article](./StealC_malware_analysis_part3.html) will focus on the last stage (StealC malware) and C2 recovery using static analysis.

## Requirements

The prerequisites for this articles are :

* Knowledge of reverse engineering on malicious programs
* Basic knowledge of x86 assembler
* Knowledge of C/Cpp is strongly recommended
* Knowledge of Python is required for automation
* Knowledge of a disassembler (Binary Ninja, IDA, Ghidra)
* Experience of opening malware in a disassembler
* Experience with a debugger (x64dbg/WinDBG...)
* Motivation and a few liters of coffee

# 02 - Reminders and preparation of the analysis environment

## Some definitions

In order to follow this article, you need to be familiar with the vocabulary of malware analysis.

### A sandbox

A sandbox is a solution for detonating (executing) a malicious program in a controlled environment. The purpose of this solution is to help you understand how a malicious program works. I invite you to find out for yourself about this fascinating subject, as it can save you precious time when you're under time pressure.

It's worth noting that some malware programs have features that can detect whether they are running in this type of environment, so as not to execute the malicious payload and thwart detection.

Open-source ([CapeSandbox](https://github.com/kevoreilly/CAPEv2), [Drakfuf Sanbox](https://github.com/CERT-Polska/drakvuf-sandbox)...) and proprietary ([AnyRun](https://any.run/), [JoeSandbox](https://www.joesandbox.com)...) sandboxes are available. Your choice of sandbox depends on the level of discretion you require when analyzing malware. In fact, some sandboxes collect the samples you send them and make them available to a more or less restricted audience, as is the case with some free online sandboxes. If you need to maintain a high level of discretion, you should opt for a sandbox that can be hosted on your premises, and disable all telemetry options or, even more radically, cut off access to the Internet.

### A command and control server

A command and control server, also known as C2 or CnC (Command and Control), is a server belonging to a malicious actor, enabling them to collect and even interact with an agent (malware) installed on an infected workstation.

The C2 of a malicious program is very often requested from a malware analyst with the aim of adding it in detection and network flow equipments (e.g. firewalls, SIEMs, etc.).

The C2 of a malicious program can, for example, be identified as a domain or an IP address.

### A packer

A packer is generally the name given to a tool that compresses and potentially obfuscates an original program. A packer can be used legitimately by software publishers to protect intellectual property. Malicious programs are regularly packed to bypass static detection systems.

A packer can incorporate obfuscation, anti-emulation, anti-VM and anti-debugging techniques. The packer studied in this blog post will contain only anti-emulation and obfuscation methods.

There are open-source packers and obfuscators available on Github, and other proprietary ones (e.g. [Tigress](https://tigress.wtf/), [VMProtect](https://vmpsoft.com/)).

### An emulator (symbolic execution)

In the context of reverse engineering, an emulator simulates the behavior of a program or a sequence of instructions by reproducing the execution context (CPU register, memory, etc.). Emulation does not deliver the same performance as a virtual machine, because the program instructions are not executed directly by the processor, but simulated.

Among other things, emulation makes it possible to bypass specific anti-debug or anti-VM mechanisms that may be implemented in programs. On the other hand, some programs use anti-emulation. Anti-emulation can be characterized by the presence of dead code (useless code) that requires a quite a few of execution time, e.g. a loop that calls a useless function. A normal CPU would take a fraction of a second to execute, whereas an emulator can take several minutes.

Emulators are present in detection systems such as antivirus software. The latter analyzes the behavior of programs by emulating them. If anti-emulation techniques are present in the program and are not thwarted by the emulator, the emulation may then terminate in timeout.

Some open-source emulators allow symbolic execution of Windows PEs, such as [MIASM](https://github.com/cea-sec/miasm), [Qiling](https://github.com/qilingframework/qiling), [Triton](https://github.com/JonathanSalwan/Triton) or [SpeakEasy](https://github.com/mandiant/speakeasy).

## Analysis tools

For malware analysis, we strongly recommend using a virtual environment. You can use the hypervisor of your choice (e.g. VMWare, Virtualbox, KVM). It can be useful to use different systems, as some malware only work on specific systems. For example, you may have a Windows 7 machine and a Windows 10 machine. Once your machine is installed, you can install analysis tools, a disassembler, a debugger, dynamic analysis tools, and a development and compilation environment.

Below is a non-exhaustive list of tools that may be useful for your analyses:

* [Sysinternal Suite](https://learn.microsoft.com/fr-fr/sysinternals/downloads/sysinternals-suite) (procmon, processexplorer, autoruns, tcpview...)
* [Detect It Easy](https://github.com/horsicq/Detect-It-Easy)
* [PEStudio](https://www.winitor.com/download)
* [DNSpy](https://github.com/dnSpyEx/dnSpy) (if you come across .NET)
* [PE-Bear](https://github.com/hasherezade/pe-bear)
* [Floss](https://github.com/mandiant/flare-floss)

**Isolate your machine from the network** to prevent any connection to the outside world. Unless you're using a system such as [inetsim](https://www.inetsim.org/), **disable network interface completely**.

**Make a snapshot of your virtual machine in a healthy state** once all your analysis tools are installed and configured, so that you can return to a healthy state at any time.

Set up a system enabling you to transfer files between your host and your virtual system. **Be careful to restrict access to an empty directory or one with no critical data (some ransomware encrypts file shares)**. If in doubt, disable file sharing completely once you've transferred the malicious sample to the virtual machine.

Make regular snapshots as you progress through the analyses, so that you can keep a record of your progress.

### A disassembler

There are several disassemblers on the market, but the one that seems to be the most widely used in professional environments today is [IDA Pro](https://hex-rays.com/ida-pro/). It costs a quite a few of money, especially if you need a decompiler for a specific architecture. It has a built-in debugger and an API to automate your analysis, as well as a number of open-source plugins available on Github.

In this article we use [Binary Ninja](https://binary.ninja/), which has the same features as the IDA Pro tool, but at a much more affordable price. Binary Ninja has an active community and responsive bug-fixing support. Its integrated plugin manager lets you quickly install and configure plugins.

I...