---
title: Apache Archiva 任意目录删除(CVE-2022-40309) 和 任意文件读取(CVE-2022-40308)
url: https://l3yx.github.io/2022/12/24/Apache-Archiva-%E4%BB%BB%E6%84%8F%E7%9B%AE%E5%BD%95%E5%88%A0%E9%99%A4-CVE-2022-40309-%E5%92%8C-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96-CVE-2022-40308/
source: l3yx's blog
date: 2022-12-25
fetch_date: 2025-10-04T02:28:44.740425
---

# Apache Archiva 任意目录删除(CVE-2022-40309) 和 任意文件读取(CVE-2022-40308)

[l3yx's blog](/)

* [首页](/)
* [归档](/archives/)
* [标签](/tags/)
* 搜索

* 文章目录
* 站点概览

1. [1. CVE-2022-40309](#CVE-2022-40309)
   1. [1.1. 影响范围](#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4)
   2. [1.2. 环境搭建](#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA)
   3. [1.3. 漏洞复现](#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0)
   4. [1.4. 漏洞分析](#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90)
   5. [1.5. 漏洞修复](#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D)
2. [2. CVE-2022-40308](#CVE-2022-40308)
   1. [2.1. 影响范围](#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4-1)
   2. [2.2. 环境搭建](#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-1)
   3. [2.3. 漏洞复现](#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-1)
   4. [2.4. 漏洞分析](#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1)
   5. [2.5. 漏洞修复](#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-1)
3. [3. 参考](#%E5%8F%82%E8%80%83)

![淚笑](/resources/avatar.jpg)

淚笑

学的越多，懂的越少

[GitHub](https://github.com/l3yx "GitHub → https://github.com/l3yx")

E-Mail

# Apache Archiva 任意目录删除(CVE-2022-40309) 和 任意文件读取(CVE-2022-40308)

发表于
2022-12-24

本文字数：
892

阅读时长 ≈
3 分钟

Apache Archiva是一个存储库管理软件，2.2.9以下版本在删除或者下载Artifact时，可以在目录或者文件名中注入目录穿越符，导致任意目录删除/任意文件读取漏洞。

## CVE-2022-40309

### 影响范围

* Apache Archiva < 2.2.9

### 环境搭建

<https://archive.apache.org/dist/archiva/2.2.8/binaries/apache-archiva-2.2.8-bin.zip>

<https://codeload.github.com/apache/archiva/zip/refs/tags/archiva-2.2.8>

|  |  |
| --- | --- |
| ``` 1 ``` | ``` ./bin/archiva console ``` |

or

|  |  |
| --- | --- |
| ``` 1 ``` | ``` .\bin\archiva.bat console ``` |

可以提前在`conf/wrapper.conf`添加如下配置，方便IDEA远程调试

|  |  |
| --- | --- |
| ``` 1 ``` | ``` wrapper.java.additional.9=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005 ``` |

首次运行需要添加Admin用户，注意需要勾选`Validated`复选框：

<http://127.0.0.1:8080/#open-admin-create-box>

### 漏洞复现

前置条件是需要用户拥有`archiva-delete-artifact`操作权限，使用首次添加的系统管理员账号或者角色为`Repository Manager - internal`的账号都可，其次需要存储库中有`Artifact`

先上传一个`Artifact`到`Archiva Managed Internal Repository`

![](/2022/12/24/Apache-Archiva-%E4%BB%BB%E6%84%8F%E7%9B%AE%E5%BD%95%E5%88%A0%E9%99%A4-CVE-2022-40309-%E5%92%8C-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96-CVE-2022-40308/image-20221224112101909.png "image-20221224112101909")

保存之后文件会储存在`repositories/internal/com/test/test/1.0/test-1.0.jar`

在`/#browse`页面点进`group`然后删除`project`时抓包，如果此页面为空的话可以重启一下Archiva

![](/2022/12/24/Apache-Archiva-%E4%BB%BB%E6%84%8F%E7%9B%AE%E5%BD%95%E5%88%A0%E9%99%A4-CVE-2022-40309-%E5%92%8C-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96-CVE-2022-40308/image-20221224114016618.png "image-20221224114016618")

可以抓到如下DELETE请求

|  |  |
| --- | --- |
| ``` 1 ``` | ``` DELETE /restServices/archivaServices/repositoriesService/project/internal/com.test/test ``` |

在`projectid`后面添加POC`%2f..%2f..%2f..%2f..%2f..%2fdata`，这将删除Archiva根目录下的`data`目录

|  |  |
| --- | --- |
| ``` 1 ``` | ``` DELETE /restServices/archivaServices/repositoriesService/project/internal/com.test/test%2f..%2f..%2f..%2f..%2f..%2fdata ``` |

### 漏洞分析

入口在 org.apache.archiva.rest.api.services.RepositoriesService#deleteProject

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 ``` | ``` @Path ("project/{repositoryId}/{groupId}/{projectId}") @DELETE @Produces ({ MediaType.APPLICATION_JSON, MediaType.APPLICATION_XML, MediaType.TEXT_PLAIN }) @RedbackAuthorization (noPermission = true) Boolean deleteProject( @PathParam ("groupId") String groupId, @PathParam ("projectId") String projectId,                        @PathParam ("repositoryId") String repositoryId )     throws ArchivaRestServiceException; ``` |

org.apache.archiva.rest.services.DefaultRepositoriesService#deleteProject

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 ``` | ``` public Boolean deleteProject( String groupId, String projectId, String repositoryId )     throws ArchivaRestServiceException { ...     if ( !isAuthorizedToDeleteArtifacts( repositoryId ) )     {         throw new ArchivaRestServiceException( "not authorized to delete artifacts", 403, null );     }  ...     try     {         ManagedRepositoryContent repository = repositoryFactory.getManagedRepositoryContent( repositoryId );          repository.deleteProject( groupId, projectId );     } ... } ``` |

`isAuthorizedToDeleteArtifacts` 限制登录用户需要有`archiva-delete-artifact`权限

在`repository.deleteProject( groupId, projectId )`中直接拼接了目录名进行删除

org.apache.archiva.repository.content.maven2.ManagedDefaultRepositoryContent#deleteProject

![](/2022/12/24/Apache-Archiva-%E4%BB%BB%E6%84%8F%E7%9B%AE%E5%BD%95%E5%88%A0%E9%99%A4-CVE-2022-40309-%E5%92%8C-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96-CVE-2022-40308/image-20221224122331434.png "image-20221224122331434")

### 漏洞修复

<https://github.com/apache/archiva/commit/930460424c715f52a7cb5eef5b084a7a8ef31fb5#diff-bde5305e671d2bdf9f05df227a6fa706f87b911c28799575537f806a063a9134R95>

![](/2022/12/24/Apache-Archiva-%E4%BB%BB%E6%84%8F%E7%9B%AE%E5%BD%95%E5%88%A0%E9%99%A4-CVE-2022-40309-%E5%92%8C-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96-CVE-2022-40308/image-20221224122618527.png "image-20221224122618527")

## CVE-2022-40308

### 影响范围

* Apache Archiva < 2.2.9

### 环境搭建

同上

### 漏洞复现

前置条件是启用匿名读取或者使用拥有`archiva-read-repository`权限的用户

在如下界面点击下载然后抓包

![](/2022/12/24/Apache-Archiva-%E4%BB%BB%E6%84%8F%E7%9B%AE%E5%BD%95%E5%88%A0%E9%99%A4-CVE-2022-40309-%E5%92%8C-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96-CVE-2022-40308/image-20221224144645880.png "image-20221224144645880")

修改URL为`/repository/internal/..//../data/databases/users/log/log1.dat`，这将会读取Archiva根目录下的`data/databases/users/log/log1.dat`文件，该文件会记录系统用户账号及加密后的密码

### 漏洞分析

由web.xml

|  |  |
| --- | --- |
| ``` 1 2 3 4 ``` | ``` <servlet-mapping>   <servlet-name>RepositoryServlet</servlet-name>   <url-pattern>/repository/*</url-pattern> </servlet-mapping> ``` |

入口在RepositoryServlet，而且POC`/repository/internal/..///../data/databases/users/log/log1.dat`中的`..///..`必须是两个及以上数量的`/`，如果URL为`/repository/internal/../../data/databases/users/log/log1.dat`，则Jetty会认为请求的是`/data/databases/users/log/log1.dat`而非`/repository/*`

org.apache.archiva.webdav.RepositoryServlet#service

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 ``` | ``` protected void service( HttpServletRequest request, HttpServletResponse response )     throws ServletException, IOException {     WebdavRequest webdavRequest = new WebdavRequestImpl( request, getLocatorFactory() );     // DeltaV requires 'Cache-Control' header for all methods except 'VERSION-CONTROL' and 'REPORT'.     int methodCode = DavMethods.getMethodCode( request.getMethod() );     boolean noCache = DavMethods.isDeltaVMethod( webdavRequest ) && !( DavMethods.DAV_VERSION_CONTROL == methodCode         || DavMethods.DAV_REPORT == methodCode );     WebdavResponse webdavResponse = new WebdavResponseImpl( response, noCache );     DavResource resource = null;      try     {         // make sure there is a authenticated user         if ( !getDavSessionProvider().attachSession( webdavRequest ) )         {             return;         }          // check matching if=header for lock-token relevant operations         resource =             getResourceFactory().createResource( webdavRequest.getRequestLocator(), webdavRequest, webdavResponse );          if ( !isPreconditionValid( webdavRequest, resource ) )         {             webdavResponse.sendError( DavServletResponse.SC_PRECONDITION_FAILED );             return;         }         if ( !execute( webdavRequest, webdavResponse, methodCode, resource ) )         {             super.service( request, response );         }      } ... } ``` |

跟入`getResourceFactory().createResource`

org.apache.archiva.webdav.ArchivaDavResourceFactory#createResource(org.apache.jackrabbit.webdav.DavResourceLocator, org.apache.jackrabbit.webdav.DavServletRequest, org.apache.jackrabbit.webdav.DavServletResponse)

![](/2022/12/24/Apache-Archiva-%E4%BB%BB%E6%84%8F%E7%9B%AE%E5%BD%95%E5%88%A0%E9%99%A4-CVE-2022-40309-%E5%92%8C-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%...