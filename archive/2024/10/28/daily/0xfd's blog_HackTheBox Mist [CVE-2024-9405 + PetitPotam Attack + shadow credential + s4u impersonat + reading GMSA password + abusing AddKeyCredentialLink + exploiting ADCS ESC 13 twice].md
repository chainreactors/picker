---
title: HackTheBox Mist [CVE-2024-9405 + PetitPotam Attack + shadow credential + s4u impersonat + reading GMSA password + abusing AddKeyCredentialLink + exploiting ADCS ESC 13 twice]
url: https://fdlucifer.github.io/2024/10/27/mist/
source: 0xfd's blog
date: 2024-10-28
fetch_date: 2025-10-06T18:49:26.530870
---

# HackTheBox Mist [CVE-2024-9405 + PetitPotam Attack + shadow credential + s4u impersonat + reading GMSA password + abusing AddKeyCredentialLink + exploiting ADCS ESC 13 twice]

[0xfd's blog](/)

by 0xfd

* [Home](/)
* [About](/about/)
* [Tags41](/tags/)
* [Categories78](/categories/)
* [Archives214](/archives/)
* [Commonweal 404](/404/)
* Search

* Table of Contents
* Overview

1. [1. 简述](#%E7%AE%80%E8%BF%B0)
2. [2. 信息收集](#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86)
   1. [2.1. nmap](#nmap)
   2. [2.2. Website - TCP 80](#Website-TCP-80)
3. [3. Shell as svc\_web on MS01](#Shell-as-svc-web-on-MS01)
   1. [3.1. 恢复admin密码](#%E6%81%A2%E5%A4%8Dadmin%E5%AF%86%E7%A0%81)
      1. [3.1.1. 漏洞背景](#%E6%BC%8F%E6%B4%9E%E8%83%8C%E6%99%AF)
      2. [3.1.2. 目录发现 - 文件读取](#%E7%9B%AE%E5%BD%95%E5%8F%91%E7%8E%B0-%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96)
      3. [3.1.3. Crackstation](#Crackstation)
   2. [3.2. Webshell Pluck Module](#Webshell-Pluck-Module)
      1. [3.2.1. Create Module](#Create-Module)
      2. [3.2.2. Upload Module](#Upload-Module)
      3. [3.2.3. Bypass AMSI](#Bypass-AMSI)
4. [4. Shell as Brandon.Keywarp on MS01](#Shell-as-Brandon-Keywarp-on-MS01)
   1. [4.1. Enumeration](#Enumeration)
      1. [4.1.1. Host](#Host)
   2. [4.2. 恶意链接](#%E6%81%B6%E6%84%8F%E9%93%BE%E6%8E%A5)
5. [5. Auth as MS01$](#Auth-as-MS01)
   1. [5.1. Bloodhound](#Bloodhound)
      1. [5.1.1. 收集信息](#%E6%94%B6%E9%9B%86%E4%BF%A1%E6%81%AF)
      2. [5.1.2. 文件提取](#%E6%96%87%E4%BB%B6%E6%8F%90%E5%8F%96)
      3. [5.1.3. 分析](#%E5%88%86%E6%9E%90)
   2. [5.2. Recover Brandon.Keywrap NTLM](#Recover-Brandon-Keywrap-NTLM)
      1. [5.2.1. Overview](#Overview)
      2. [5.2.2. Get Certificate](#Get-Certificate)
      3. [5.2.3. dump hash](#dump-hash)
   3. [5.3. 隧道](#%E9%9A%A7%E9%81%93)
   4. [5.4. Enumeration](#Enumeration-1)
      1. [5.4.1. SMB](#SMB)
      2. [5.4.2. Creating Machines](#Creating-Machines)
      3. [5.4.3. AV / AMSI Evasion](#AV-x2F-AMSI-Evasion)
      4. [5.4.4. LDAP Signing](#LDAP-Signing)
   5. [5.5. PetitPotam Attack](#PetitPotam-Attack)
      1. [5.5.1. 策略](#%E7%AD%96%E7%95%A5)
      2. [5.5.2. Enable webclient](#Enable-webclient)
      3. [5.5.3. Tunnel](#Tunnel)
      4. [5.5.4. Attack Without Relay](#Attack-Without-Relay)
      5. [5.5.5. Relay](#Relay)
      6. [5.5.6. Get MS01$ NTLM Hash](#Get-MS01-NTLM-Hash)
6. [6. Shell as Administrator on MS01](#Shell-as-Administrator-on-MS01)
   1. [6.1. Get Kerberos Ticket](#Get-Kerberos-Ticket)
   2. [6.2. shell](#shell)
   3. [6.3. secretsdump](#secretsdump)
7. [7. Shell as op\_Sharon.Mullard on Mist](#Shell-as-op-Sharon-Mullard-on-Mist)
   1. [7.1. Enumeration](#Enumeration-2)
      1. [7.1.1. Home Directories](#Home-Directories)
      2. [7.1.2. KeePass](#KeePass)
   2. [7.2. 恢复密码](#%E6%81%A2%E5%A4%8D%E5%AF%86%E7%A0%81)
      1. [7.2.1. 破解 KeePass Master Password](#%E7%A0%B4%E8%A7%A3-KeePass-Master-Password)
      2. [7.2.2. Read Password from KeePass](#Read-Password-from-KeePass)
   3. [7.3. 确认user](#%E7%A1%AE%E8%AE%A4user)
   4. [7.4. Evil-WinRM](#Evil-WinRM)
8. [8. Auth as svc\_ca$](#Auth-as-svc-ca)
   1. [8.1. Enumeration](#Enumeration-3)
   2. [8.2. Get Password Hash](#Get-Password-Hash)
9. [9. Auth as svc\_cabackup](#Auth-as-svc-cabackup)
   1. [9.1. Enumeration](#Enumeration-4)
   2. [9.2. Add Shadow Credential](#Add-Shadow-Credential)
10. [10. Shell as Administrator](#Shell-as-Administrator)
    1. [10.1. ESC13 Background](#ESC13-Background)
    2. [10.2. ESC13 Enumeration](#ESC13-Enumeration)
       1. [10.2.1. Check-ADCSESC13.ps1](#Check-ADCSESC13-ps1)
       2. [10.2.2. Bloodhound 预定义查询](#Bloodhound-%E9%A2%84%E5%AE%9A%E4%B9%89%E6%9F%A5%E8%AF%A2)
       3. [10.2.3. 更新Certipy](#%E6%9B%B4%E6%96%B0Certipy)
    3. [10.3. Exploit](#Exploit)
       1. [10.3.1. Overview](#Overview-1)
       2. [10.3.2. 访问证书管理器组](#%E8%AE%BF%E9%97%AE%E8%AF%81%E4%B9%A6%E7%AE%A1%E7%90%86%E5%99%A8%E7%BB%84)
       3. [10.3.3. 访问ServiceAccounts组](#%E8%AE%BF%E9%97%AEServiceAccounts%E7%BB%84)
    4. [10.4. Recover Hashes](#Recover-Hashes)
       1. [10.4.1. Exfil Reg Hives](#Exfil-Reg-Hives)
       2. [10.4.2. secretsdump](#secretsdump-1)
       3. [10.4.3. 二次secretsdump](#%E4%BA%8C%E6%AC%A1secretsdump)
    5. [10.5. DC01 administrator Shell](#DC01-administrator-Shell)

![253](/images/blackhole.png)

253

All things about infosec & ctf

[214
posts](/archives/)

[78
categories](/categories/)

[41
tags](/tags/)

GitHub

E-Mail

Twitter

FB Page

YouTube

Instagram

infosec.exchange

![Creative Commons](https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/big/by_nc_sa.svg)

0%

Links

* atsud0
* 记忆里的纯真
* 小离

# HackTheBox Mist [CVE-2024-9405 + PetitPotam Attack + shadow credential + s4u impersonat + reading GMSA password + abusing AddKeyCredentialLink + exploiting ADCS ESC 13 twice]

Posted on
2024-10-27

In

[CVE-2024-9405](/categories/CVE-2024-9405/)
,
[Bypass AMSI](/categories/CVE-2024-9405/Bypass-AMSI/)
,
[Malicious Link](/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/)
,
[Mist-DC01-CA enroll templates](/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/)
,
[Rubues Dump Hash](/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/)
,
[Defender Exclusions](/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/Defender-Exclusions/)
,
[PetitPotam Attack](/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/Defender-Exclusions/PetitPotam-Attack/)
,
[ntlm relay LDAP shell](/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/Defender-Exclusions/PetitPotam-Attack/ntlm-relay-LDAP-shell/)
,
[rubeus get Kerberos ticket](/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/Defender-Exclusions/PetitPotam-Attack/ntlm-relay-LDAP-shell/rubeus-get-Kerberos-ticket/)
,
[s4u impersonating Administrator](/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/Defender-Exclusions/PetitPotam-Attack/ntlm-relay-LDAP-shell/rubeus-get-Kerberos-ticket/s4u-impersonating-Administrator/)
,
[shadow credential](/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/Defender-Exclusions/PetitPotam-Attack/ntlm-relay-LDAP-shell/rubeus-get-Kerberos-ticket/s4u-impersonating-Administrator/shadow-credential/)
,
[ESC13 enum and attack](/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/Defender-Exclusions/PetitPotam-Attack/ntlm-relay-LDAP-shell/rubeus-get-Kerberos-ticket/s4u-impersonating-Administrator/shadow-credential/ESC13-enum-and-attack/)
,
[Bloodhound Pre-Defined Query](/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/Defender-Exclusions/PetitPotam-Attack/ntlm-relay-LDAP-shell/rubeus-get-Kerberos-ticket/s4u-impersonating-Administrator/shadow-credential/ESC13-enum-and-attack/Bloodhound-Pre-Defined-Query/)
,
[Exfil Reg Hives](/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/Defender-Exclusions/PetitPotam-Attack/ntlm-relay-LDAP-shell/rubeus-get-Kerberos-ticket/s4u-impersonating-Administrator/shadow-credential/ESC13-enum-and-attack/Bloodhound-Pre-Defined-Query/Exfil-Reg-Hives/)

Views:

Word count in article:
9.3k

Reading time ≈
34 mins.

# 简述

本文是Insane难度的HTB Mist机器的域渗透部分，其中CVE-2024-9405 + PetitPotam Attack + shadow credential + s4u impersonat + reading GMSA password + abusing AddKeyCredentialLink + exploiting ADCS ESC 13 twice等域渗透提权细节是此box的特色，主要参考0xdf’s blog Mist walkthrough记录这篇博客加深记忆和理解，及供后续做深入研究查阅，备忘。

* ![](https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist.png)

# 信息收集

## nmap

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 ``` | ``` fdluci@hacky$ nmap -p- --min-rate 10000 10.10.11.17 Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-21 15:46 EDT Nmap scan report for 10.10.11.17 Host is up (0.089s latency). Not shown: 65534 filte...