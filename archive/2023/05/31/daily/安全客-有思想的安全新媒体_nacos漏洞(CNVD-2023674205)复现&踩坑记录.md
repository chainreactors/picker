---
title: nacos漏洞(CNVD-2023674205)复现&踩坑记录
url: https://www.anquanke.com/post/id/288930
source: 安全客-有思想的安全新媒体
date: 2023-05-31
fetch_date: 2025-10-04T11:37:53.220401
---

# nacos漏洞(CNVD-2023674205)复现&踩坑记录

首页

阅读

* [安全资讯](https://www.anquanke.com/news)
* [安全知识](https://www.anquanke.com/knowledge)
* [安全工具](https://www.anquanke.com/tool)

活动

社区

学院

安全导航

内容精选

* [专栏](/column/index.html)
* [精选专题](https://www.anquanke.com/subject-list)
* [安全KER季刊](https://www.anquanke.com/discovery)
* [360网络安全周报](https://www.anquanke.com/week-list)

# nacos漏洞(CNVD-2023674205)复现&踩坑记录

阅读量**644664**

发布时间 : 2023-05-30 16:22:52

**x**

##### 译文声明

本文是翻译文章

译文仅供参考，具体内容表达以及含义原文为准。

## nacos漏洞(CNVD-2023674205)复现&踩坑记录

### 漏洞披露

3月2日，CNVD披露了编号为CNVD-2023674205的nacos认证绕过漏洞

![]()

在nacos官方github项目([https://github.com/alibaba/nacos)发布2.2.0.1版本对应修复版本，移除了默认鉴权插件中依赖的`nacos.core.auth.plugin.nacos.token.secret.key`默认值](https://github.com/alibaba/nacos%29%E5%8F%91%E5%B8%832.2.0.1%E7%89%88%E6%9C%AC%E5%AF%B9%E5%BA%94%E4%BF%AE%E5%A4%8D%E7%89%88%E6%9C%AC%EF%BC%8C%E7%A7%BB%E9%99%A4%E4%BA%86%E9%BB%98%E8%AE%A4%E9%89%B4%E6%9D%83%E6%8F%92%E4%BB%B6%E4%B8%AD%E4%BE%9D%E8%B5%96%E7%9A%84%60nacos.core.auth.plugin.nacos.token.secret.key%60%E9%BB%98%E8%AE%A4%E5%80%BC)

![]()

### 漏洞复现&分析

下载2.2.0版本nacos搭建环境，下载链接：<https://github.com/alibaba/nacos/releases/download/2.2.0/nacos-server-2.2.0.tar.gz>

启动也很简单，先安装好java环境（如何安装java自行搜索 (～￣▽￣)～），进入bin目录下，执行./startsh -m standalone即可

```
# 解压缩
unzip nacos-server-1.0.0.zip
# 进入bin目录
cd nacos/bin
# 运行nacos 注意添加 -m standalone
sh startup.sh -m standalone
# 关闭nacos
sh shutdown.sh
```

![]()

根据官方的修复公告，查看配置文件 conf/application.properties，发现`nacos.core.auth.plugin.nacos.token.secret.key`是有默认值的

![]()

而nacos使用jwt构造认证token，使用HS256算法，把配置文件中`nacos.core.auth.plugin.nacos.token.secret.key`的默认值当作私钥生成Signature，将subject（用户名）和exp戳写到jwt token里

查看源码：nacos-2.2.0\plugin-default-impl\src\main\java\com\alibaba\nacos\plugin\auth\impl\JwtTokenManager.java

![]()

其中secretKey即配置文件中`nacos.core.auth.plugin.nacos.token.secret.key`的值，从JwtTokenManager类的processProperties()函数中可以看到

![]()

在jwt token校验的时候，校验了token签名有效性和是否过期（nacos-2.2.0\plugin-default-impl\src\main\java\com\alibaba\nacos\plugin\auth\impl\NacosAuthManager.java）

![]()

现在知道了jwt的生成和校验逻辑，以及jwt的默认私钥，就可以伪造jwt token绕过认证nacos认证逻辑，构造一个超长有效期的token，就可以使用poc扫描啦

![]()

下面进行验证，以获取配置信息接口为例，首先是没有jwt token访问接口，返回禁止访问

![]()

带上Authorization再访问，jwt token使用刚才构造的，成功返回

![]()

ps：在老版本中（1.1.4版本及以下），如果nacos没有配置信息，则body中没有数据，仅返回200，所以poc不能以响应包的body为标志进行扫描，若以status\_code为标志，则误报会很多

![]()

可以删除search参数值，以响应包的body为标志( •̀ ω •́ )✧

![]()

**ps：**0.x.x的远古版本没有登录逻辑。。访问就直接进入系统了

## 漏洞修复

1.2.0版本及以上的nacos，修改配置文件中的`nacos.core.auth.plugin.nacos.token.secret.key`即可

1.1.4版本及以下的nacos，由于私钥写死到了代码里，用户无法自行配置，只能升级nacos到最新版

![]()

## 踩过的坑

一开始用登录接口来检测jwt默认私钥漏洞，在1.2.0及以上版本中，使用构造的jwt token访问，发现即使不输入账密，也显示登录成功，接口地址为/nacos/v1/auth/users/login（默认配置启动），响应包中校验200状态码和accessToken字段即可

![]()

但在老版本（1.1.4及以下版本）中，接口地址为/nacos/v1/auth/login（默认配置启动），跟新版本的不一样，并且使用了伪造的jwt token也不成功，造成了漏报(っ °Д °;)っ

![]()

勾起了好奇心，下载nacos源码一探究竟：

首先是老版本（1.1.4及以前）的源码，登录逻辑为直接比对账密，比对成功即登录成功

![]()

而在新版本（1.2.0版本-最新）中，增加了一个header中token的认证逻辑：如果配置文件中的nacos.core.auth.system.type为nacos或者ldap，且请求包含Authorization的header并校验通过，则优先使用请求中的token，可以不用校验账密

配置文件（nacos.core.auth.system.type默认为nacos）：

![]()

登录部分的源码（nacos-2.2.0\plugin-default-impl\src\main\java\com\alibaba\nacos\plugin\auth\impl\controller\UserController.java）：

校验通过后，响应包会直接使用请求包中的jwt token

![]()

跟进authManager.login(request)函数，到达nacos-2.2.0\plugin-default-impl\src\main\java\com\alibaba\nacos\plugin\auth\impl\NacosAuthManager.java里面

在resolveToken和validate0函数里校验

![]()

resolveToken函数用于提取Authorization的值，若以Bearer 为开头，则取第7个字符以后的字符串返回

![]()

validate0用于校验jwt token，使用配置的nacos.core.auth.default.token.secret.key

![]()

响应包中返回登录成功，响应包中包含请求header中的token，而老版本仅校验账密导致返回登陆失败

![]()

所以新版本中使用登录接口验证默认私钥漏洞不适用于老版本，构造一个全版本通杀的poc还是不容易的o(TヘTo)，还是加上获取配置信息接口一块扫吧。。

## 题外话

#### 1、User-Agent导致的未授权漏洞

nacos历史上曾经爆出过使用特殊构造的User-Agent造成未授权接口访问的漏洞，在翻官方文档（[https://nacos.io/zh-cn/docs/auth.html）中发现这么一段话：](https://nacos.io/zh-cn/docs/auth.html%EF%BC%89%E4%B8%AD%E5%8F%91%E7%8E%B0%E8%BF%99%E4%B9%88%E4%B8%80%E6%AE%B5%E8%AF%9D%EF%BC%9A)

![]()

由此可见，使用特殊构造的User-Agent是官方用于服务端之间的可信通信，未考虑到暴露公网的情况，在nacos 1.2-1.4.0版本期间存在这个安全问题，在1.4.1及以上版本中，nacos默认配置关闭了这个特性，用户可以手动开启，开启后需要配置自定义的key value对

#### 2、某poc扫描器的小特性

在写poc时，我的expression是这样写的，校验响应包头中是否有Content-Type字段，并判断是否为application/json

![]()

看着莫得问题，结果poc扫描器显示poc加载失败

![]()

看了看官方文档，也没发现啥问题，文档里也这么用的

![]()

调试了半天，发现前面一定要有response.status的判断才能加载成功。。

![]()

![]()

但是响应包的状态码本来就不确定，可能为200 400 500，所以就没加状态码的判断，结果就卡在这里了。。（不晓得为啥一定要先判断response.status才能检查headers）

被逼无奈，只能写了个response.status != 1来意思一下了(\* ￣︿￣)

本文翻译自 原文链接。如若转载请注明出处。

商务合作，文章发布请联系 anquanke@360.cn

本文由**360安全应急响应中心**原创发布

转载，请参考[转载声明](https://www.anquanke.com/note/repost)，注明出处： [https://www.anquanke.com/post/id/288930](/post/id/288930)

安全KER - 有思想的安全新媒体

本文转载自:

如若转载,请注明出处：

安全KER - 有思想的安全新媒体

分享到：![微信](https://p0.ssl.qhimg.com/sdm/28_28_100/t01e29062a5dcd13c10.png)

* [安全资讯](/tag/%E5%AE%89%E5%85%A8%E8%B5%84%E8%AE%AF)
* [漏洞分析；web安全；](/tag/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BC%9Bweb%E5%AE%89%E5%85%A8%EF%BC%9B)

**+1**22赞

收藏

![](https://p3.ssl.qhmsg.com/dm/200_200_100/t01b5d8fecc4d01072b.jpg)360安全应急响应中心

分享到：![微信](https://p0.ssl.qhimg.com/sdm/28_28_100/t01e29062a5dcd13c10.png)

## 发表评论

您还未登录，请先登录。

[登录](/login/index.html)

![](https://p3.ssl.qhimg.com/t014757b72460d855bf.png)

[![](https://p3.ssl.qhmsg.com/dm/200_200_100/t01b5d8fecc4d01072b.jpg)](/member.html?memberId=122586)

[360安全应急响应中心](/member.html?memberId=122586)

360安全应急响应中心（360 Security Response Center，简称360SRC）是360公司致力于保障产品及业务安全，促进白帽专家合作与交流的平台。诚邀白帽专家向我们反馈360产品安全漏洞、威胁情报，共筑数字安全基石，保障数亿用户业务和产品的安全。

* 文章
* **67**

* 粉丝
* **13**

### TA的文章

* ##### [Python代码保护之重置操作码映射的攻与防探究（一）](/post/id/311484)

  2025-08-26 10:49:47
* ##### [诚邀莅临|三六零天御·亚马逊云科技安全合规沙龙](/post/id/308420)

  2025-06-13 14:18:45
* ##### [360 MCP 生态安全风险治理实践与思考](/post/id/307934)

  2025-05-29 11:07:56
* ##### [ingress-nightmare 漏洞利用分析与 k8s 相关组件理解](/post/id/306494)

  2025-04-14 15:24:44
* ##### [基于 RAG 提升大模型安全运营效率](/post/id/306214)

  2025-04-03 19:07:23

### 相关文章

* ##### [国庆重保+攻防演练大考在即！360大模型安全服务专项方案筑牢AI防线](/post/id/312460)

  2025-09-29 18:06:17
* ##### [Apache Airflow 存在权限漏洞，可导致只读用户获取敏感信息](/post/id/312457)

  2025-09-29 18:05:56
* ##### [Meta 旨在打造机器人领域的“Android”，为下一代人形AI提供通用平台](/post/id/312454)

  2025-09-29 18:05:34
* ##### [Formbricks 存在高危漏洞 (CVE-2025-59934)，攻击者可通过伪造JWT令牌导致未授权的密码重置](/post/id/312451)

  2025-09-29 18:05:05
* ##### [Notepad++ 中存在DLL劫持漏洞（CVE-2025-56383），可导致任意代码执行，且POC已公开](/post/id/312448)

  2025-09-29 18:04:33
* ##### [Morte僵尸网络被披露：正利用路由器与企业应用漏洞，迅速扩张其“加载器即服务”活动](/post/id/312444)

  2025-09-29 18:04:01
* ##### [Akira勒索软件利用SonicWall VPN账户发起急速入侵](/post/id/312438)

  2025-09-29 18:03:28

### 热门推荐

文章目录

* [nacos漏洞(CNVD-2023674205)复现&踩坑记录](#h2-0)
  + [漏洞披露](#h3-1)
  + [漏洞复现&分析](#h3-2)
* [漏洞修复](#h2-3)
* [踩过的坑](#h2-4)
* [题外话](#h2-5)

![](https://p0.qhimg.com/t11098f6bcd5614af4bf21ef9b5.png)

安全KER

* [关于我们](/about)
* [联系我们](/note/contact)
* [用户协议](/note/protocol)
* [隐私协议](/note/privacy)

商务合作

* [合作内容](/note/business)
* [联系方式](/note/contact)
* [友情链接](/link)

内容需知

* [投稿须知](https://www.anquanke.com/contribute/tips)
* [转载须知](/note/repost)
* 官网QQ群：568681302

合作单位

* [![安全KER](https://p0.ssl.qhimg.com/t01592a959354157bc0.png)](http://www.cert.org.cn/)
* [![安全KER](https://p0.ssl.qhimg.com/t014f76fcea94035e47.png)](http://www.cnnvd.org.cn/)

Copyright © 北京奇虎科技有限公司 三六零数字安全科技集团有限公司 安全KER All Rights Reserved [京ICP备08010314号-66](https://beian.miit.gov.cn/)[![](https://icon.cnzz.com/img/pic.gif)](https://www.cnzz.com/stat/website.php?web_id=1271278035 "站长统计")

微信二维码

**X**![安全KER](https://p0.ssl.qhimg.com/t0151209205b47f2270.jpg)