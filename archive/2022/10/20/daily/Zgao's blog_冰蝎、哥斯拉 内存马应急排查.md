---
title: å†°èã€å“¥æ–¯æ‹‰ å†…å­˜é©¬åº”æ€¥æ’æŸ¥
url: https://zgao.top/%e5%86%b0%e8%9d%8e%e3%80%81%e5%93%a5%e6%96%af%e6%8b%89-%e5%86%85%e5%ad%98%e9%a9%ac%e5%ba%94%e6%80%a5%e6%8e%92%e6%9f%a5/
source: Zgao's blog
date: 2022-10-20
fetch_date: 2025-10-03T20:20:10.395232
---

# å†°èã€å“¥æ–¯æ‹‰ å†…å­˜é©¬åº”æ€¥æ’æŸ¥

# [Zgao's blog](https://zgao.top/)

æ„¿æœ‰ä¸€æ—¥ï¼Œå®‰å…¨åœˆçš„å¸ˆå‚…ä»¬éƒ½èƒ½ç”¨ä¸ŠZgaoå†™çš„å·¥å…·ã€‚

Toggle navigation

* [å·¥å…·ç®±](https://zgao.top/tool/)
* [æ–‡ç« å½’æ¡£](https://zgao.top/archives/)
* [å…³äºæˆ‘](https://zgao.top/about-me/)
* [github](https://github.com/zgao264)
* Gmail

# å†°èã€å“¥æ–¯æ‹‰ å†…å­˜é©¬åº”æ€¥æ’æŸ¥

* [é¦–é¡µ](https://zgao.top)
* [å†°èã€å“¥æ–¯æ‹‰ å†…å­˜é©¬åº”æ€¥æ’æŸ¥](https://zgao.top:443/%E5%86%B0%E8%9D%8E%E3%80%81%E5%93%A5%E6%96%AF%E6%8B%89-%E5%86%85%E5%AD%98%E9%A9%AC%E5%BA%94%E6%80%A5%E6%8E%92%E6%9F%A5/)

[10æœˆ 19, 2022](https://zgao.top/2022/10/)

### å†°èã€å“¥æ–¯æ‹‰ å†…å­˜é©¬åº”æ€¥æ’æŸ¥

ä½œè€… [Zgao](https://zgao.top/author/zgao/)
åœ¨[[åº”æ€¥å“åº”](https://zgao.top/category/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/)](https://zgao.top/%E5%86%B0%E8%9D%8E%E3%80%81%E5%93%A5%E6%96%AF%E6%8B%89-%E5%86%85%E5%AD%98%E9%A9%AC%E5%BA%94%E6%80%A5%E6%8E%92%E6%9F%A5/)

å†…å­˜é©¬çš„æ’æŸ¥æ–¹å¼æ±‡æ€»ã€‚å†…å­˜é©¬çš„åŸç†åˆ†æç½‘ä¸Šæœ‰å¾ˆå¤šæ–‡ç« ï¼Œè¿™é‡Œå°±ä¸ä»‹ç»äº†ã€‚é€šè¿‡å®éªŒåˆ†æå¦‚ä½•åœ¨å®æˆ˜ç¯å¢ƒä¸­å¿«é€Ÿå®šä½å†…å­˜é©¬ã€‚

æ–‡ç« ç›®å½•

[ ]

* [å®éªŒç¯å¢ƒ](#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83 "å®éªŒç¯å¢ƒ")
* [ç¯å¢ƒæ­å»º](#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA "ç¯å¢ƒæ­å»º")
  + [å®‰è£…tomcat](#%E5%AE%89%E8%A3%85tomcat "å®‰è£…tomcat")
  + [å®‰è£… Arthas](#%E5%AE%89%E8%A3%85_Arthas "å®‰è£… Arthas")
* [å“¥æ–¯æ‹‰ å†…å­˜é©¬](#%E5%93%A5%E6%96%AF%E6%8B%89_%E5%86%85%E5%AD%98%E9%A9%AC "å“¥æ–¯æ‹‰ å†…å­˜é©¬")
  + [FilterShell](#FilterShell "FilterShell")
  + [MemoryShell](#MemoryShell "MemoryShell")
* [å†°è å†…å­˜é©¬](#%E5%86%B0%E8%9D%8E_%E5%86%85%E5%AD%98%E9%A9%AC "å†°è å†…å­˜é©¬")
* [heapdump å†…å­˜æ’æŸ¥](#heapdump_%E5%86%85%E5%AD%98%E6%8E%92%E6%9F%A5 "heapdump å†…å­˜æ’æŸ¥")
* [Arthas æ’æŸ¥å†…å­˜é©¬å‘½ä»¤æ€»ç»“](#Arthas_%E6%8E%92%E6%9F%A5%E5%86%85%E5%AD%98%E9%A9%AC%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93 "Arthas æ’æŸ¥å†…å­˜é©¬å‘½ä»¤æ€»ç»“")
  + [æ³¨æ„äº‹é¡¹](#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9 "æ³¨æ„äº‹é¡¹")

## å®éªŒç¯å¢ƒ

* Centos / tomcat 7.0.76
* å†°èv4.0.5
* å“¥æ–¯æ‹‰v4.0.1
* Arthas 3.6.6

## ç¯å¢ƒæ­å»º

### å®‰è£…tomcat

é€šè¿‡yumå®‰è£…tomcatã€‚

```
yum install -y tomcat tomcat-webapps tomcat-admin-webapps
systemctl start tomcat
```

å¯åŠ¨åè®¿é—®8080ç«¯å£ï¼Œçœ‹åˆ°tomcatèµ·æ¥äº†ã€‚

![](https://zgao.top/wp-content/uploads/2022/10/image-33-1024x391.png)

### å®‰è£… Arthas

<https://github.com/alibaba/arthas/releases>

ä¸‹è½½å‹ç¼©åŒ…è§£å‹æ‰§è¡Œ

```
wget https://github.com/alibaba/arthas/releases/download/arthas-all-3.6.6/arthas-bin.zip
unzip arthas-bin.zip
java -jar arthas-boot.jar
```

![](https://zgao.top/wp-content/uploads/2022/10/image-37-1024x521.png)

## å“¥æ–¯æ‹‰ å†…å­˜é©¬

ç”¨å“¥æ–¯æ‹‰ç”ŸæˆğŸ´ã€‚

![](https://zgao.top/wp-content/uploads/2022/10/image-34-1024x443.png)

æ”¾åˆ°ç½‘ç«™æ ¹ç›®å½•ä¸‹é¢ã€‚

![](https://zgao.top/wp-content/uploads/2022/10/image-35-1024x537.png)

æ¤å…¥å†…å­˜é©¬ä¹‹å‰æŸ¥çœ‹å†…å­˜ä¸­mbeanä¿¡æ¯ã€‚

```
 mbean | grep "name=/"
```

![](https://zgao.top/wp-content/uploads/2022/10/image-38-1024x473.png)

### FilterShell

è¿ä¸Šå“¥æ–¯æ‹‰çš„webshellå¯ä»¥çœ‹åˆ°æä¾›äº†memoryShellå’ŒFilterShellä¸¤ç§ğŸ´ã€‚

![](https://zgao.top/wp-content/uploads/2022/10/image-39-1024x636.png)
![](https://zgao.top/wp-content/uploads/2022/10/image-40-1024x481.png)

å¯ä»¥çœ‹åˆ°å“¥æ–¯æ‹‰çš„Filterå†…å­˜é©¬nameä¸­éƒ½å¸¦æœ‰æ—¶é—´æˆ³ã€‚

```
sc *.Filter
sc -d org.apache.coyote.SerializationConfig
```

![](https://zgao.top/wp-content/uploads/2022/10/image-41-864x1024.png)

ä½¿ç”¨jadåç¼–è¯‘æˆ‘ä»¬è®¤ä¸ºå¯ç–‘çš„ç±»ã€‚

```
jad org.apache.coyote.SerializationConfig
```

![](https://zgao.top/wp-content/uploads/2022/10/image-43-1024x949.png)
![](https://zgao.top/wp-content/uploads/2022/10/image-44-1024x703.png)

ä»£ç ä¸­å¤§é‡è¿ç”¨invokeåå°„æ¥å®ç°ã€‚

### MemoryShell

![](https://zgao.top/wp-content/uploads/2022/10/image-45-1024x554.png)

æ·»åŠ è¯¥å†…å­˜é©¬åé€šè¿‡mbeanå¯ä»¥çœ‹åˆ°å¤šäº†å‡ ä¸ªservletã€‚

```
mbean | grep "name=/"
sc *.Servlet
```

![](https://zgao.top/wp-content/uploads/2022/10/image-46-1024x370.png)
![](https://zgao.top/wp-content/uploads/2022/10/image-47-1024x624.png)

å¯ç–‘çš„classloaderã€‚

![](https://zgao.top/wp-content/uploads/2022/10/image-48-1024x425.png)

## å†°è å†…å­˜é©¬

å†°èå†…å­˜é©¬ç”±äºå¯¹åº•å±‚å‡½æ•°åšäº†hookçš„æ“ä½œï¼Œæ‰€ä»¥ç‰¹å¾æ›´å¼±ä¸€äº›ã€‚

å…ˆç”Ÿæˆå†°è4.0çš„æœåŠ¡ç«¯ã€‚

![](https://zgao.top/wp-content/uploads/2022/10/image-49-1024x681.png)

ä¸Šä¼ åè¿æ¥æ³¨å…¥å†…å­˜é©¬ã€‚

![](https://zgao.top/wp-content/uploads/2022/10/image-50-1024x501.png)

å¼€å¯å†°èçš„é˜²æ£€æµ‹åŠŸèƒ½ã€‚

![](https://zgao.top/wp-content/uploads/2022/10/image-51-1024x376.png)

è¿ä¸Šå†…å­˜é©¬ã€‚

![](https://zgao.top/wp-content/uploads/2022/10/image-52-1024x507.png)

å†°èçš„classloaderã€‚

![](https://zgao.top/wp-content/uploads/2022/10/image-53-1024x441.png)
![](https://zgao.top/wp-content/uploads/2022/10/image-54-1024x720.png)

å†°èğŸ´å±äºServletç±»å‹çš„ï¼Œä¸è¿‡å¹¶ä¸æ˜¯åŠ è½½å†…å­˜é©¬ä¹‹åæ‰æœ‰çš„ï¼Œè€Œæ˜¯è¿æ¥å†°èæœåŠ¡ç«¯çš„æ—¶å€™å°±æœ‰çš„ã€‚

åç¼–è¯‘å†°èçš„é©¬ï¼Œå¯ä»¥çœ‹åˆ°æ˜æ˜¾AESåŠ å¯†çš„keyã€‚

![](https://zgao.top/wp-content/uploads/2022/10/image-55-1024x669.png)

ä½†æ˜¯æœ‰ä¸ªç»ˆææ’æŸ¥æ€è·¯ï¼Œå°±æ˜¯å†…å­˜dumpã€‚

## heapdump å†…å­˜æ’æŸ¥

ä¸ç®¡å†°èçš„å†…å­˜é©¬å¦‚ä½•hookï¼Œä½†æ˜¯å†…å­˜ğŸ´è‚¯å®šæ˜¯åœ¨å†…å­˜ä¸­çš„ã€‚å¹¶ä¸”è®¿é—®çš„æ—¶å€™æ˜¯æœ‰è·¯ç”±æ˜ å°„çš„ã€‚é‚£ä¹ˆå†…å­˜dumpå‡ºæ¥çš„æ–‡ä»¶è‚¯å®šä¼šæœ‰è®°å½•ã€‚

```
heapdump
strings /var/cache/tomcat/temp/heapdump2022-10-19-12-464292342944555007800.hprof | grep "POST /"
```

![](https://zgao.top/wp-content/uploads/2022/10/image-56-1024x625.png)

è¿˜æœ‰å¦å¤–ä¸€ç§æ–¹æ³•æ’æŸ¥å†°èå†…å­˜ğŸ´ï¼Œå°±æ˜¯æŸ¥æ‰¾å†…å­˜ä¸­webç›®å½•çš„å¯ç–‘è·¯å¾„ã€‚

```
strings /var/cache/tomcat/temp/heapdump2022-10-19-12-464292342944555007800.hprof | grep -E "/webapps/.*?\!" | sort -u
```

![](https://zgao.top/wp-content/uploads/2022/10/image-57-1024x429.png)

## Arthas æ’æŸ¥å†…å­˜é©¬å‘½ä»¤æ€»ç»“

```
classloader
sc *.Filter
sc *.Servlet
jad
heapdump
```

### æ³¨æ„äº‹é¡¹

ä½¿ç”¨Arthaså¯èƒ½ä¼šé‡åˆ°ä¸‹é¢çš„æŠ¥é”™ã€‚

Unable to open socket file: target process not responding or HotSpot VM not loaded

![](https://zgao.top/wp-content/uploads/2022/10/image-58-1024x369.png)

è¯¥æŠ¥é”™æ˜¯å› ä¸ºtomcatæ˜¯ä»¥tomcatç”¨æˆ·è¿è¡Œçš„ï¼Œè€Œæˆ‘ä»¬ç”¨arthasæ˜¯ç”¨rootç”¨æˆ·è¿è¡Œçš„ã€‚JVM åªèƒ½ attach åŒæ ·ç”¨æˆ·ä¸‹çš„ java è¿›ç¨‹ã€‚

ä½¿ç”¨runuserå‘½ä»¤å³å¯ä»¥tomcatç”¨æˆ·è¿è¡Œarthasã€‚

```
runuser -l tomcat -c "java -jar /usr/share/tomcat/arthas-boot.jar"
```

![](https://zgao.top/wp-content/uploads/2022/10/image-59-1024x488.png)

Post Views: 7,333

èµèµ

![](https://zgao.top/wp-content/uploads/2022/02/QQå›¾ç‰‡20201028114105.jpeg)å¾®ä¿¡èµèµ![](https://zgao.top/wp-content/uploads/2022/02/QQå›¾ç‰‡20201028114100.jpeg)æ”¯ä»˜å®èµèµ

###### Zgao

æ„¿æœ‰ä¸€æ—¥ï¼Œå®‰å…¨åœˆçš„å¸ˆå‚…ä»¬éƒ½èƒ½ç”¨ä¸ŠZgaoå†™çš„å·¥å…·ã€‚

### 3æ¡è¯„è®º

###### novvv å‘å¸ƒäº12:51 ä¸Šåˆ - 11æœˆ 9, 2023

[root@coco tomcat]# runuser -l tomcat -c â€œjava -jar /usr/share/tomcat/arthas-boot.jarâ€
This account is currently not available.
å“­äº†ã€‚ä¸€æ ·çš„centos7 x64 è¿™ä¸ªç¼“è§£è§£å†³ä¸äº†äº†

[å›å¤](https://zgao.top/%E5%86%B0%E8%9D%8E%E3%80%81%E5%93%A5%E6%96%AF%E6%8B%89-%E5%86%85%E5%AD%98%E9%A9%AC%E5%BA%94%E6%80%A5%E6%8E%92%E6%9F%A5/?replytocom=6182#respond)

###### åŒ¿å å‘å¸ƒäº10:06 ä¸Šåˆ - 11æœˆ 9, 2023

è¯´æ˜ä½ ç³»ç»Ÿä¸Šæ²¡æœ‰tomcatè¿™ä¸ªç”¨æˆ·ï¼Œä½ å¯ä»¥éšä¾¿æŒ‡å®šä¸€ä¸ªå…¶ä»–ä½æƒç”¨æˆ·è¿è¡Œ

[å›å¤](https://zgao.top/%E5%86%B0%E8%9D%8E%E3%80%81%E5%93%A5%E6%96%AF%E6%8B%89-%E5%86%85%E5%AD%98%E9%A9%AC%E5%BA%94%E6%80%A5%E6%8E%92%E6%9F%A5/?replytocom=6185#respond)

###### kiki å‘å¸ƒäº8:56 ä¸‹åˆ - 11æœˆ 12, 2022

å¤§ä½¬ Pç«™ä¸‹è½½è§†é¢‘çš„æ’ä»¶å·²å¤±æ•ˆï¼Œè·ªæ±‚æ‚¨æ›´æ–°æ–°ç‰ˆæœ¬ã€‚22.11.12ç•™ã€‚

[å›å¤](https://zgao.top/%E5%86%B0%E8%9D%8E%E3%80%81%E5%93%A5%E6%96%AF%E6%8B%89-%E5%86%85%E5%AD%98%E9%A9%AC%E5%BA%94%E6%80%A5%E6%8E%92%E6%9F%A5/?replytocom=4245#respond)

### å‘è¡¨è¯„è®º [å–æ¶ˆå›å¤](/%E5%86%B0%E8%9D%8E%E3%80%81%E5%93%A5%E6%96%AF%E6%8B%89-%E5%86%85%E5%AD%98%E9%A9%AC%E5%BA%94%E6%80%A5%E6%8E%92%E6%9F%A5/#respond)

Î”

ç‰ˆæƒÂ©2020 Author By : Zgao