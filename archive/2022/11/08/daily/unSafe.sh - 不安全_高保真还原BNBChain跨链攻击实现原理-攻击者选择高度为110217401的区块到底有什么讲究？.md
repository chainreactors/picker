---
title: 高保真还原BNBChain跨链攻击实现原理-攻击者选择高度为110217401的区块到底有什么讲究？
url: https://buaq.net/go-134591.html
source: unSafe.sh - 不安全
date: 2022-11-08
fetch_date: 2025-10-03T21:54:26.384449
---

# 高保真还原BNBChain跨链攻击实现原理-攻击者选择高度为110217401的区块到底有什么讲究？

* [unSafe.sh - 不安全](https://unsafe.sh)
* [我的收藏](/user/collects)
* [今日热榜](/?hot=true)
* [公众号文章](/?gzh=true)
* [导航](/nav/index)
* [Github CVE](/cve)
* [Github Tools](/tools)
* [编码/解码](/encode)
* [文件传输](/share/index)
* [Twitter Bot](https://twitter.com/buaqbot)
* [Telegram Bot](https://t.me/aqinfo)
* [Search](/search/search)

[Rss](/rss.xml)

[ ]
黑夜模式

![](https://8aqnet.cdn.bcebos.com/c1702e0bbf613e87b4adeeb10747bbf8.jpg)

高保真还原BNBChain跨链攻击实现原理-攻击者选择高度为110217401的区块到底有什么讲究？

高保真还原BNBChain跨链攻击实现原理-攻击者选择高度为110217401的区块到底有什么讲究？BNBChain跨链桥攻
*2022-11-7 18:7:25
Author: [www.aqniu.com(查看原文)](/jump-134591.htm)
阅读量:18
收藏*

---

高保真还原BNBChain跨链攻击实现原理-攻击者选择高度为110217401的区块到底有什么讲究？

BNBChain跨链桥攻击事件已过去10天了，网上的分析和讨论也非常多，大家对漏洞的产生和修复非常关心。

但是，我们发现99%的开发者只理解漏洞产生是由于Cosmos SDK中IAVL+树叶子节点的Hash算法存在漏洞，但并不知道攻击者到底是如何构造payload（inputdata）的，实现这样的攻击的难度到底有多大，选择很久之前的这个区块高度（110217401）到底是什么原因？

带着这些问题，SharkTeam高保真还原了黑客的漏洞挖掘过程和payload构造逻辑，让我们来一探究竟

txHash：0xebf83628ba893d35b496121fb8201666b8e09f3cbadf0e269162baa72efe3b8b

![](https://www.aqniu.com/wp-content/uploads/2022/11/1-14.png)

访问的合约是BNBChain中的CrossChain合约，地址是0x2000，调用的函数以及参数如下：

![](https://www.aqniu.com/wp-content/uploads/2022/11/2-12.png)

参数解析：

1. payload：有效负载，是跨链交易的包信息，其中包含了调用BNB转账的函数及其参数，长度为147bytes。

2. proof：跨链交易的包的Merkle证明，包含了IVAL树的范围证明以及MultiStore存储的简单Merkle树证明，长度为999bytes。

3. height：区块高度，读取跨链交易的来源链高度为height的区块中的appHash，实际是前一个区块的appHash，用于验证MultiStore存储的简单Merkle树证明。

4. packageSequence：跨链交易的包序列号，其特性类似于区块的Nonce。

5. channelId：跨链通道ID，指明跨链交易的来源链与目标链。这里，channelId=2表示从BC链到BSC链的跨链转账交易。

CrossChain合约如下：

![](https://www.aqniu.com/wp-content/uploads/2022/11/3-6.png)

我们通过整个执行过程，将handlePackage函数分为6个关键函数，下面依次分析这6个关键函数的逻辑、参数以及返回值。

## 2.1 validateMerkleProof函数

该函数的功能就是验证Merkle证明，函数名称和参数定义如下：

![](https://www.aqniu.com/wp-content/uploads/2022/11/4-6.png)

传递的参数如下：

{

  “appHash”: “0x72cda827a83531ca0fd7ac917a6b65649719aab0836722caafe0603147a52318”,

  “storeName”: “ibc”,

  “key”: “0x00000100380200000000010dd85c”,

  “value”: “0x000000000000000000000000000000000000000000000000000000000000000000f870a0424e4200000000000000000000000000000000000000000000000000000000009400000000000000000000000000000000000000008ad3c21bcecceda100000094489a8756c18c0b8b24ec2a2b9ff3d4d447f79bec94489a8756c18c0b8b24ec2a2b9ff3d4d447f79bec846553f100”,

  “proof”: “0x0a8d020a066961766c3a76120e00000100380200000000010dd85c1af201f0010aed010a2b0802100318b091c73422200c10f902d266c238a4ca9e26fa9bc36483cd3ebee4e263012f5e7f40c22ee4d20a4d0801100218b091c7342220e4fd47bffd1c06e67edad92b2bf9ca63631978676288a2aa99f95c459436ef632a20da657c1ffb86c684eb3e265361ef0fa4f9dfa670b45f9f91c5eb6ad84b21a4d112001a370a0e0000010038020000000000000002122011056c6919f02d966991c10721684a8d1542e44003f9ffb47032c18995d4ac7f18b091c7341a340a0e00000100380200000000010dd85c12202c3a561458f8527b002b5ec3cab2d308662798d6245d4588a4e6a80ebdfe30ac18010ad4050a0a6d756c746973746f726512036962631ac005be050abb050a110a066f7261636c6512070a0508b891c7340a0f0a046d61696e12070a0508b891c7340a350a08736c617368696e6712290a2708b891c7341220c8ccf341e6e695e7e1cb0ce4bf347eea0cc16947d8b4e934ec400b57c59d6f860a380a0b61746f6d69635f7377617012290a2708b891c734122042d4ecc9468f71a70288a95d46564bfcaf2c9f811051dcc5593dbef152976b010a110a0662726964676512070a0508b891c7340a300a0364657812290a2708b891c73412201773be443c27f61075cecdc050ce22eb4990c54679089e90afdc4e0e88182a230a2f0a02736312290a2708b891c7341220df7a0484b7244f76861b1642cfb7a61d923794bd2e076c8dbd05fc4ee29f3a670a330a06746f6b656e7312290a2708b891c734122064958c2f76fec1fa5d1828296e51264c259fa264f499724795a740f48fc4731b0a320a057374616b6512290a2708b891c734122015d2c302143bdf029d58fe381cc3b54cedf77ecb8834dfc5dc3e1555d68f19ab0a330a06706172616d7312290a2708b891c734122050abddcb7c115123a5a4247613ab39e6ba935a3d4f4b9123c4fedfa0895c040a0a300a0361636312290a2708b891c734122079fb5aecc4a9b87e56231103affa5e515a1bdf3d0366490a73e087980b7f1f260a0e0a0376616c12070a0508b891c7340a300a0369626312290a2708b891c7341220e09159530585455058cf1785f411ea44230f39334e6e0f6a3c54dbf069df2b620a300a03676f7612290a2708b891c7341220db85ddd37470983b14186e975a175dfb0bf301b43de685ced0aef18d28b4e0420a320a05706169727312290a2708b891c7341220a78b556bc9e73d86b4c63ceaf146db71b12ac80e4c10dd0ce6eb09c99b0c7cfe0a360a0974696d655f6c6f636b12290a2708b891c73412204775dbe01d41cab018c21ba5c2af94720e4d7119baf693670e70a40ba2a52143”

}

以上参数解读如下：

（1）appHash通过调用TendermintLightClient合约中的getAppHash函数来读取的高度为height的AppHash，getAppHash函数如下：

![](https://www.aqniu.com/wp-content/uploads/2022/11/5-7.png)

状态变量lightClientConsensusStates是由跨链中继器Relayer调用syncTendermintHeader函数同步每一个区块头部信息的时候进行更新的，其中保存了每一个BC链中区块的appHash。

![](https://www.aqniu.com/wp-content/uploads/2022/11/6-6.png)

AppHash是区块头部的一个字段，代表前一个区块执行完成后的应用状态散列值。

![](https://www.aqniu.com/wp-content/uploads/2022/11/7-3.png)
![](https://www.aqniu.com/wp-content/uploads/2022/11/8-4.png)
![](https://www.aqniu.com/wp-content/uploads/2022/11/9-4.png)

*摘自：《区块链架构与实现：**Cosmos**详解》*

由此可见，参数appHash是BC链高度为110217400的区块的AppHash（参数height为110217401），其值为0x72cda827a83531ca0fd7ac917a6b65649719aab0836722caafe0603147a52318

（2）参数storeName=”ibc”，是合约定义的常量，转换成十六进制为0x696263

（3）参数key是调用generateKey函数生成的，代码如下：

![](https://www.aqniu.com/wp-content/uploads/2022/11/10-2.png)

参数key的值长度为14bytes，由两部分组成：

* 前6 bytes由通道ID，即channelId生成，其值为0x000001003802，按顺序包含：

|  |  |  |
| --- | --- | --- |
| **长度（/字节）** | **字段** | **值** |
| 1 | 前缀 | 0x00 |
| 2 | 来源链ID | 0x0001 |
| 2 | 目标链ID | 0x0038 |
| 1 | 通道ID | 0x02 |

* 后8 bytes是包序列号packageSequence，即17684572=0x00000000010dd85c

所以，这里key=0x00000100380200000000010dd85c，length=14=0x0e

（4）参数payloadLocal就是交易InputData中的payload，长度为147bytes

（5）参数proofLocal就是交易InputData中的proof，长度为999bytes

validateMerkleProof函数的实现代码如下：

![](https://www.aqniu.com/wp-content/uploads/2022/11/11.png)
![](https://www.aqniu.com/wp-content/uploads/2022/11/12.png)

该函数调用了0x65地址的合约对proof进行验证，参数如下：

(1)input=0x00000000000000000000000000000000000000000000000000000000000005086962630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e00000100380200000000010dd85c0000000000000000000000000000000000000000000000000000000000000093000000000000000000000000000000000000000000000000000000000000000000f870a0424e4200000000000000000000000000000000000000000000000000000000009400000000000000000000000000000000000000008ad3c21bcecceda100000094489a8756c18c0b8b24ec2a2b9ff3d4d447f79bec94489a8756c18c0b8b24ec2a2b9ff3d4d447f79bec846553f10072cda827a83531ca0fd7ac917a6b65649719aab0836722caafe0603147a523180a8d020a066961766c3a76120e00000100380200000000010dd85c1af201f0010aed010a2b0802100318b091c73422200c10f902d266c238a4ca9e26fa9bc36483cd3ebee4e263012f5e7f40c22ee4d20a4d0801100218b091c7342220e4fd47bffd1c06e67edad92b2bf9ca63631978676288a2aa99f95c459436ef632a20da657c1ffb86c684eb3e265361ef0fa4f9dfa670b45f9f91c5eb6ad84b21a4d112001a370a0e0000010038020000000000000002122011056c6919f02d966991c10721684a8d1542e44003f9ffb47032c18995d4ac7f18b091c7341a340a0e00000100380200000000010dd85c12202c3a561458f8527b002b5ec3cab2d308662798d6245d4588a4e6a80ebdfe30ac18010ad4050a0a6d756c746973746f726512036962631ac005be050abb050a110a066f7261636c6512070a0508b891c7340a0f0a046d61696e12070a0508b891c7340a350a08736c617368696e6712290a2708b891c7341220c8ccf341e6e695e7e1cb0ce4bf347eea0cc16947d8b4e934ec400b57c59d6f860a380a0b61746f6d69635f7377617012290a2708b891c734122042d4ecc9468f71a70288a95d46564bfcaf2c9f811051dcc5593dbef152976b010a110a0662726964676512070a0508b891c7340a300a0364657812290a2708b891c73412201773be443c27f61075cecdc050ce22eb4990c54679089e90afdc4e0e88182a230a2f0a02736312290a2708b891c7341220df7a0484b7244f76861b1642cfb7a61d923794bd2e076c8dbd05fc4ee29f3a670a330a06746f6b656e7312290a2708b891c734122064958c2f76fec1fa5d1828296e51264c259fa264f499724795a740f48fc4731b0a320a057374616b6512290a2708b891c734122015d2c302143bdf029d58fe381cc3b54cedf77ecb8834dfc5dc3e1555d68f19ab0a330a06706172616d7312290a2708b891c734122050abddcb7c115123a5a4247613ab39e6ba935a3d4f4b9123c4fedfa0895c040a0a300a0361636312290a2708b891c734122079fb5aecc4a9b87e56231103affa5e515a1bdf3d0366...