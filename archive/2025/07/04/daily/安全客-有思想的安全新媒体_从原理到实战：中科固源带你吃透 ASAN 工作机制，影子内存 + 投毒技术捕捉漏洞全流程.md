---
title: 从原理到实战：中科固源带你吃透 ASAN 工作机制，影子内存 + 投毒技术捕捉漏洞全流程
url: https://www.anquanke.com/post/id/309321
source: 安全客-有思想的安全新媒体
date: 2025-07-04
fetch_date: 2025-10-06T23:28:52.310913
---

# 从原理到实战：中科固源带你吃透 ASAN 工作机制，影子内存 + 投毒技术捕捉漏洞全流程

йҰ–йЎө

йҳ…иҜ»

* [е®үе…Ёиө„и®Ҝ](https://www.anquanke.com/news)
* [е®үе…ЁзҹҘиҜҶ](https://www.anquanke.com/knowledge)
* [е®үе…Ёе·Ҙе…·](https://www.anquanke.com/tool)

жҙ»еҠЁ

зӨҫеҢә

еӯҰйҷў

е®үе…ЁеҜјиҲӘ

еҶ…е®№зІҫйҖү

* [дё“ж Ҹ](/column/index.html)
* [зІҫйҖүдё“йўҳ](https://www.anquanke.com/subject-list)
* [е®үе…ЁKERеӯЈеҲҠ](https://www.anquanke.com/discovery)
* [360зҪ‘з»ңе®үе…Ёе‘ЁжҠҘ](https://www.anquanke.com/week-list)

# д»ҺеҺҹзҗҶеҲ°е®һжҲҳпјҡдёӯз§‘еӣәжәҗеёҰдҪ еҗғйҖҸ ASAN е·ҘдҪңжңәеҲ¶пјҢеҪұеӯҗеҶ…еӯҳ + жҠ•жҜ’жҠҖжңҜжҚ•жҚүжјҸжҙһе…ЁжөҒзЁӢ

йҳ…иҜ»йҮҸ**136871**

еҸ‘еёғж—¶й—ҙ : 2025-07-03 17:21:58

**x**

##### иҜ‘ж–ҮеЈ°жҳҺ

жң¬ж–ҮжҳҜзҝ»иҜ‘ж–Үз«

иҜ‘ж–Үд»…дҫӣеҸӮиҖғпјҢе…·дҪ“еҶ…е®№иЎЁиҫҫд»ҘеҸҠеҗ«д№үеҺҹж–ҮдёәеҮҶгҖӮ

AddressSanitizer(ASAN)жҳҜдёҖз§ҚеҹәдәҺзј–иҜ‘ж—¶жҸ’жЎ©е’ҢиҝҗиЎҢж—¶жЈҖжөӢзҡ„еҶ…еӯҳй”ҷиҜҜиҜҠж–ӯе·Ҙе…·пјҢе®ғйҖҡиҝҮеҲӣж–°зҡ„еҪұеӯҗеҶ…еӯҳ(Shadow Memory)жңәеҲ¶е’ҢвҖқжҠ•жҜ’вҖқ(Poisoning)жҠҖжңҜпјҢиғҪеӨҹеңЁзЁӢеәҸиҝҗиЎҢж—¶еҠЁжҖҒжЈҖжөӢеӨҡз§ҚеҶ…еӯҳе®үе…Ёй—®йўҳгҖӮASANзҡ„и®ҫи®Ўе“ІеӯҰжҳҜеңЁжҖ§иғҪејҖй”Җе’ҢжЈҖжөӢе…ЁйқўжҖ§д№Ӣй—ҙеҸ–еҫ—е№іиЎЎпјҢе…¶е№іеқҮиҝҗиЎҢж—¶ејҖй”Җд»…дёә73%пјҢеҚҙиғҪжЈҖжөӢз»қеӨ§еӨҡж•°еёёи§ҒеҶ…еӯҳй”ҷиҜҜгҖӮ

еҪұеӯҗеҶ…еӯҳжһ¶жһ„жҳҜASANзҡ„ж ёеҝғеҲӣж–°пјҢе®ғе°ҶиҷҡжӢҹең°еқҖз©әй—ҙзҡ„е…«еҲҶд№ӢдёҖдё“з”ЁдәҺеӯҳеӮЁеҶ…еӯҳи®ҝй—®зҠ¶жҖҒдҝЎжҒҜгҖӮе…·дҪ“е®һзҺ°дёҠпјҢASANйҮҮз”Ё1:8зҡ„жҜ”дҫӢжҳ е°„еә”з”ЁзЁӢеәҸеҶ…еӯҳеҲ°еҪұеӯҗеҶ…еӯҳвҖ”вҖ”еҚіжҜҸ1еӯ—иҠӮзҡ„еҪұеӯҗеҶ…еӯҳжҸҸиҝ°8еӯ—иҠӮеә”з”ЁзЁӢеәҸеҶ…еӯҳзҡ„зҠ¶жҖҒгҖӮиҝҷз§Қзҙ§еҮ‘зј–з ҒдҪҝеҫ—ASANиғҪеӨҹй«ҳж•Ҳи·ҹиёӘеҶ…еӯҳзҡ„еҸҜи®ҝй—®жҖ§пјҡеҖјдёә0иЎЁзӨәе…ЁйғЁ8еӯ—иҠӮеҸҜи®ҝй—®пјҢ1-7иЎЁзӨәеүҚkеӯ—иҠӮеҸҜи®ҝй—®пјҢиҙҹеҖјиЎЁзӨәеҗ„з§Қзұ»еһӢзҡ„дёҚеҸҜи®ҝй—®еҢәеҹҹ(еҰӮredzone)гҖӮ

ASANзҡ„иҝҗиЎҢж—¶**жЈҖжөӢжңәеҲ¶**дё»иҰҒеҢ…жӢ¬дёӨж–№йқўпјҡзј–иҜ‘еҷЁжҸ’жЎ©е’ҢжӣҝжҚўзҡ„еҶ…еӯҳеҲҶй…ҚеҷЁгҖӮзј–иҜ‘еҷЁеңЁжҜҸж¬ЎеҶ…еӯҳи®ҝй—®еүҚжҸ’е…ҘжЈҖжҹҘд»Јз ҒпјҢжҹҘиҜўеҪұеӯҗеҶ…еӯҳзҠ¶жҖҒпјӣиҖҢжӣҝжҚўзҡ„malloc/freeзӯүеҮҪж•°еҲҷеңЁеҲҶй…Қзҡ„еҶ…еӯҳе‘ЁеӣҙеҲӣе»әredzone(жҜ’еҢә)пјҢе№¶еңЁйҮҠж”ҫеҶ…еӯҳеҗҺе°Ҷе…¶ж Үи®°дёәдёҚеҸҜи®ҝй—®гҖӮеҪ“жЈҖжөӢеҲ°йқһжі•и®ҝй—®ж—¶пјҢASANдјҡз”ҹжҲҗиҜҰз»Ҷзҡ„й”ҷиҜҜжҠҘе‘ҠпјҢеҢ…жӢ¬й”ҷиҜҜзұ»еһӢгҖҒи°ғз”Ёж Ҳе’ҢеҶ…еӯҳзҠ¶жҖҒзӯүдҝЎжҒҜгҖӮ

**ASANиғҪеӨҹжЈҖжөӢзҡ„дё»иҰҒй”ҷиҜҜзұ»еһӢеҢ…жӢ¬**пјҡ

е ҶгҖҒж Ҳе’Ңе…ЁеұҖеҸҳйҮҸзҡ„и¶Ҡз•Ңи®ҝй—®(Heap/Stack/Global buffer overflow)

йҮҠж”ҫеҗҺдҪҝз”Ё(Use-after-free)е’Ңиҝ”еӣһеҗҺдҪҝз”Ё(Use-after-return)

еҸҢйҮҚйҮҠж”ҫ(Double-free)е’Ңж— ж•ҲйҮҠж”ҫ(Invalid-free)

еҶ…еӯҳжі„жјҸ(Memory leaks)

еҲқе§ӢеҢ–йЎәеәҸй—®йўҳ(Initialization order bugs)

# **ASANиҜҰз»ҶдҪҝз”Ёж–№жі•**

## зј–иҜ‘дёҺй“ҫжҺҘйҖүйЎ№

еҗҜз”ЁASANйңҖиҰҒеңЁзј–иҜ‘е’Ңй“ҫжҺҘйҳ¶ж®өж·»еҠ зү№е®ҡж Үеҝ—гҖӮеҜ№дәҺClangе’ҢGCCзј–иҜ‘еҷЁпјҢеҹәжң¬дҪҝз”Ёж–№ејҸдёәпјҡ

clang -fsanitize=address -g source.c -o program

gcc -fsanitize=address -g source.c -o program

е…¶дёӯ**-fsanitize=address**йҖүйЎ№жҢҮзӨәзј–иҜ‘еҷЁеҗҜз”ЁASANжҸ’жЎ©пјҢ**-g**йҖүйЎ№еҢ…еҗ«и°ғиҜ•з¬ҰеҸ·д»ҘдҫҝеңЁй”ҷиҜҜжҠҘе‘ҠдёӯжҳҫзӨәжәҗз ҒдҪҚзҪ®гҖӮеҜ№дәҺC++зЁӢеәҸпјҢеҸҜиғҪйңҖиҰҒйўқеӨ–й“ҫжҺҘlibc++пјҡ

clang++ -fsanitize=address -g -lc++ source.cpp -o program

В

**е…ій”®зј–иҜ‘йҖүйЎ№еҢ…жӢ¬пјҡ**

-fno-omit-frame-pointerпјҡзҰҒз”Ёеё§жҢҮй’ҲдјҳеҢ–пјҢиҺ·еҸ–жӣҙе®Ңж•ҙзҡ„и°ғз”Ёж Ҳ

-O1жҲ–жӣҙй«ҳпјҡдјҳеҢ–зә§еҲ«дёҚиғҪдёә-O0пјҢеҗҰеҲҷжҹҗдәӣжЈҖжөӢеҸҜиғҪдёҚе·ҘдҪң

-fsanitize-recover=addressпјҡи®ҫзҪ®ASANдёәеҸҜжҒўеӨҚжЁЎејҸ(й»ҳи®ӨйҒҮеҲ°й”ҷиҜҜдјҡдёӯжӯў)

-fsanitize-address-use-after-scopeпјҡеҗҜз”ЁдҪңз”Ёеҹҹз»“жқҹеҗҺдҪҝз”ЁжЈҖжөӢ

## иҝҗиЎҢж—¶зҺҜеўғй…ҚзҪ®

ASANиҝҗиЎҢж—¶иЎҢдёәеҸҜйҖҡиҝҮзҺҜеўғеҸҳйҮҸи°ғж•ҙпјҡ

exportASAN\_OPTIONS=вҖқverbosity=1:abort\_on\_error=0:malloc\_context\_size=20вҖі

В

еёёз”ЁиҝҗиЎҢж—¶йҖүйЎ№еҢ…жӢ¬пјҡ

halt\_on\_error=0/1пјҡжҳҜеҗҰеңЁйҰ–ж¬Ўй”ҷиҜҜж—¶дёӯжӯў(й»ҳи®Өдёә1)

log\_path=filenameпјҡе°ҶжҠҘе‘Ҡиҫ“еҮәеҲ°ж–Үд»¶иҖҢйқһstderr

detect\_leaks=1пјҡеҗҜз”ЁеҶ…еӯҳжі„жјҸжЈҖжөӢ

malloc\_fill\_byte=0xAAпјҡеҲҶй…ҚеҶ…еӯҳж—¶еЎ«е……зү№е®ҡеӯ—иҠӮжЁЎејҸ

free\_fill\_byte=0xBBпјҡйҮҠж”ҫеҶ…еӯҳж—¶еЎ«е……зү№е®ҡеӯ—иҠӮжЁЎејҸ

## й”ҷиҜҜжҠҘе‘Ҡи§Јжһҗ

ASANй”ҷиҜҜжҠҘе‘ҠеҢ…еҗ«дё°еҜҢдҝЎжҒҜд»Ҙеё®еҠ©иҜҠж–ӯй—®йўҳгҖӮд»Ҙе…ёеһӢзҡ„е ҶжәўеҮәй”ҷиҜҜдёәдҫӢпјҡ

==65906==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x00010613a7d4 at pc 0x000102c57f48 bp 0x00016d1ab190 sp 0x00016d1ab188

READ of size 4 at 0x00010613a7d4 thread T0

#0 0x1021d3e6c in main test\_heap\_buffer\_overflow.cpp:5

#1 0x193e4be4c in (<unknown module>)

В

0x00010613a7d4 is located 4 bytes to the right of 400-byte region [0x00010613a640,0x00010613a7d0)

allocated by thread T0 here:

#0 0x1025de018 in wrap\_\_Znam+0x74 (libclang\_rt.asan\_osx\_dynamic.dylib:arm64e+0x4e018)

#1 0x1021d3e6c in main test\_heap\_buffer\_overflow.cpp:3

#2 0x193e4be4c in (<unknown module>)

жҠҘе‘Ҡе…ій”®йғЁеҲҶеҢ…жӢ¬пјҡ

й”ҷиҜҜзұ»еһӢ(heap-buffer-overflow)е’ҢеҶ…еӯҳең°еқҖ

ж“ҚдҪңзұ»еһӢ(READ/WRITE)е’ҢеӨ§е°Ҹ

и°ғз”Ёж ҲжҳҫзӨәй”ҷиҜҜеҸ‘з”ҹдҪҚзҪ®(test\_heap\_buffer\_overflow.cpp:5)

еҶ…еӯҳеҲҶй…ҚдҪҚзҪ®(test\_heap\_buffer\_overflow.cpp:3)

жәўеҮәзӣёеҜ№дәҺеҲҶй…ҚеҢәеҹҹзҡ„дҪҚзҪ®(4 bytes to the right)

## й«ҳзә§дҪҝз”ЁжҠҖе·§

иҮӘе®ҡд№үжӢҰжҲӘеҷЁпјҡеҜ№дәҺдҪҝз”ЁиҮӘе®ҡд№үеҶ…еӯҳеҲҶй…ҚжңәеҲ¶зҡ„еә”з”ЁзЁӢеәҸ(еҰӮApacheзҡ„apr\_palloc)пјҢж ҮеҮҶASANеҸҜиғҪж— жі•жңүж•ҲжЈҖжөӢеҶ…еӯҳй”ҷиҜҜгҖӮжӯӨж—¶еҸҜд»Ҙе®һзҺ°иҮӘе®ҡд№үжӢҰжҲӘеҷЁпјҡ

#include<sanitizer/asan\_interface.h>

INTERCEPTOR(void\*, apr\_palloc,apr\_pool\_t\*pool,size\_t size){

void\*p =REAL(apr\_palloc)(pool, size);

ASAN\_POISON\_MEMORY\_REGION(p, size);*// жүӢеҠЁжҜ’еҢ–еҶ…еӯҳ*

return p;

}

йңҖеңЁInitializeAsanInterceptorsеҮҪж•°дёӯжіЁеҶҢжӢҰжҲӘеҷЁпјҡASAN\_INTERCEPT\_FUNC(apr\_palloc)

дәәе·ҘеҶ…еӯҳжҜ’еҢ–пјҡASANжҸҗдҫӣжүӢеҠЁAPIз”ЁдәҺзү№ж®ҠеңәжҷҜзҡ„еҶ…еӯҳзҠ¶жҖҒз®ЎзҗҶпјҡ

#include<sanitizer/asan\_interface.h>

void\*p =malloc(100);ASAN\_POISON\_MEMORY\_REGION(p,100);*// ж Үи®°дёәдёҚеҸҜи®ҝй—®*

ASAN\_UNPOISON\_MEMORY\_REGION(p,50);*// йғЁеҲҶеҢәеҹҹж Үи®°дёәеҸҜи®ҝй—®*

иҝҷеңЁжөӢиҜ•иҮӘе®ҡд№үеҶ…еӯҳз®ЎзҗҶжҲ–зү№ж®Ҡж•°жҚ®з»“жһ„ж—¶йқһеёёжңүз”ЁгҖӮ

# **й»‘зӣ’еҚҸи®®жЁЎзіҠжөӢиҜ•зі»з»ҹйӣҶжҲҗ**

## й»‘зӣ’жЁЎзіҠжөӢиҜ•зі»з»ҹзҡ„жҢ‘жҲҳ

дј з»ҹй»‘зӣ’еҚҸи®®жЁЎзіҠжөӢиҜ•йқўдёҙеҮ дёӘе…ій”®йҷҗеҲ¶пјҡ

зјәд№Ҹжү§иЎҢеҸҚйҰҲпјҡж— жі•иҺ·еҸ–зЁӢеәҸеҶ…йғЁзҠ¶жҖҒе’Ңд»Јз ҒиҰҶзӣ–зҺҮпјҢеҜјиҮҙжөӢиҜ•ж•ҲзҺҮдҪҺдёӢ

ж— еҶ…еӯҳй”ҷиҜҜжЈҖжөӢпјҡйҡҫд»ҘеҸ‘зҺ°еҜјиҮҙеҶ…еӯҳжҚҹеқҸдҪҶжңӘзӣҙжҺҘеј•еҸ‘еҙ©жәғзҡ„жјҸжҙһ

зҠ¶жҖҒжңәе»әжЁЎеӣ°йҡҫпјҡеҚҸи®®зҠ¶жҖҒиҪ¬жҚўеӨҚжқӮпјҢйҡҫд»Ҙз»ҙжҢҒдјҡиҜқжңүж•ҲжҖ§

ASANдёҺй»‘зӣ’жЁЎзіҠжөӢиҜ•зҡ„з»“еҗҲиғҪеӨҹжңүж•Ҳи§ЈеҶіеүҚдёӨдёӘй—®йўҳпјҢйҖҡиҝҮеҶ…еӯҳй”ҷиҜҜжЈҖжөӢеҸ‘зҺ°йҡҗи”ҪжјҸжҙһпјҢе№¶й…ҚеҗҲиҰҶзӣ–зҺҮеҸҚйҰҲжҸҗеҚҮжөӢиҜ•ж·ұеәҰгҖӮ

## йӣҶжҲҗжһ¶жһ„и®ҫи®Ў

е…ёеһӢзҡ„ASANеўһејәеһӢй»‘зӣ’жЁЎзіҠжөӢиҜ•зі»з»ҹеҢ…еҗ«д»ҘдёӢз»„д»¶пјҡ

1.зӣ®ж ҮзЁӢеәҸеҮҶеӨҮпјҡ

дҪҝз”ЁASANзј–иҜ‘зӣ®ж ҮеҚҸи®®зЁӢеәҸ(еҰӮ-fsanitize=address)

зЎ®дҝқеҢ…еҗ«и°ғиҜ•з¬ҰеҸ·(-g)д»Ҙдҫҝй”ҷиҜҜе®ҡдҪҚ

еҜ№дәҺй—ӯжәҗиҪҜд»¶пјҢеҸҜйҖҡиҝҮдәҢиҝӣеҲ¶жҸ’жЎ©жҲ–еҠЁжҖҒеә“жіЁе…Ҙж–№ејҸеҠ иҪҪASANиҝҗиЎҢж—¶

2.жЁЎзіҠжөӢиҜ•еј•ж“Һпјҡ

з”ҹжҲҗжҲ–еҸҳејӮеҚҸи®®ж¶ҲжҒҜдҪңдёәжөӢиҜ•з”ЁдҫӢ

зӣ‘жҺ§зӣ®ж ҮиҝӣзЁӢзҠ¶жҖҒ(еҙ©жәғгҖҒж–ӯиЁҖеӨұиҙҘгҖҒASANжҠҘе‘Ҡ)

ж”¶йӣҶд»Јз ҒиҰҶзӣ–зҺҮеҸҚйҰҲ(еҰӮйҖҡиҝҮASANжҸ’жЎ©жҲ–иҫ…еҠ©е·Ҙе…·)

3.з»“жһңеҲҶжһҗжЁЎеқ—пјҡ

и§ЈжһҗASANй”ҷиҜҜжҠҘе‘Ҡ

еҲҶзұ»е’ҢеҺ»йҮҚеҸ‘зҺ°зҡ„жјҸжҙһ

з”ҹжҲҗеҸҜеҲ©з”ЁжөӢиҜ•з”ЁдҫӢзҡ„жңҖе°ҸеҢ–йӣҶеҗҲ

## жү§иЎҢжөҒзЁӢдјҳеҢ–

дёәжҸҗй«ҳжөӢиҜ•ж•ҲзҺҮпјҢеҸҜйҮҮз”Ё**еҸҢжЁЎејҸжү§иЎҢ**зӯ–з•Ҙпјҡ

1.еҝ«йҖҹи·Ҝеҫ„пјҡдҪҝз”ЁиҪ»йҮҸзә§жҸ’жЎ©зүҲжң¬(д»…еҹәжң¬еқ—и·ҹиёӘ)жү§иЎҢеӨ§еӨҡж•°жөӢиҜ•з”ЁдҫӢпјҢзӯӣйҖүеҮәи§ҰеҸ‘ж–°и·Ҝеҫ„зҡ„иҫ“е…Ҙ

2.ж·ұеәҰжЈҖжөӢпјҡд»…еҜ№зӢ¬зү№и·Ҝеҫ„зҡ„жөӢиҜ•з”ЁдҫӢеҗҜз”Ёе®Ңж•ҙASANжЈҖжөӢпјҢе№іиЎЎжҖ§иғҪдёҺжЈҖжөӢж·ұеәҰ

е®һзҺ°дёҠйңҖиҰҒзј–иҜ‘дёӨдёӘзүҲжң¬зҡ„зӣ®ж ҮзЁӢеәҸпјҡ

program-traceпјҡд»…и·Ҝеҫ„жҸ’жЎ©

program-trace-asanпјҡе®Ңж•ҙASANжҸ’жЎ©

йҖҡиҝҮи°ғеәҰеҷЁж №жҚ®и·Ҝеҫ„йҮҚеӨҚзҺҮеҠЁжҖҒеҲҶй…ҚжөӢиҜ•з”ЁдҫӢеҲ°дёҚеҗҢзүҲжң¬

## еҚҸи®®зҠ¶жҖҒз»ҙжҠӨжҠҖе·§

й’ҲеҜ№жңүзҠ¶жҖҒеҚҸи®®пјҢASANйӣҶжҲҗйңҖзү№еҲ«жіЁж„Ҹпјҡ

дјҡиҜқйҡ”зҰ»пјҡжҜҸдёӘжөӢиҜ•з”ЁдҫӢеңЁзӢ¬з«ӢиҝӣзЁӢдёӯжү§иЎҢпјҢйҒҝе…ҚзҠ¶жҖҒжұЎжҹ“

иө„жәҗжё…зҗҶпјҡејәеҲ¶йҮҚеҗҜзӣ®ж ҮжңҚеҠЎе®ҡжңҹжё…зҗҶж®Ӣз•ҷзҠ¶жҖҒ

й”ҷиҜҜжіЁе…ҘзӮ№пјҡй’ҲеҜ№еҚҸи®®и§ЈжһҗдёҚеҗҢйҳ¶ж®ө(еҲқе§ӢжҸЎжүӢгҖҒи®ӨиҜҒгҖҒж•°жҚ®дј иҫ“)и®ҫи®Ўдё“й—ЁжөӢиҜ•з”ЁдҫӢ

# **ASANеҸ‘зҺ°жјҸжҙһзұ»еһӢдёҺжЎҲдҫӢеҲҶжһҗ**

## е Ҷзӣёе…іжјҸжҙһ

**1.е ҶжәўеҮә(Heap Buffer Overflow)**пјҡ

еҪ“и®ҝй—®е ҶеҲҶй…ҚеҶ…еӯҳд№ӢеӨ–зҡ„еҢәеҹҹж—¶и§ҰеҸ‘гҖӮдҫӢеҰӮпјҡ

int\*array =newint[100];

int res = array[100];*// и¶Ҡз•Ңи®ҝй—®*

ASANжҠҘе‘ҠжҳҫзӨәпјҡ

ERROR: ...