---
title: 原创 Paper | GL-iNet 路由器 CVE-2024-39226 漏洞分析
url: https://mp.weixin.qq.com/s?__biz=MzAxNDY2MTQ2OQ==&mid=2650985033&idx=1&sn=eb8264e9eb4f3dec90c22ecb464e5e9e&chksm=8079907bb70e196d58b310e5733e4c9cb0f7a6d4c4d51c3afeca35f73b14cbfc828e2d2afb95&scene=58&subscene=0#rd
source: 知道创宇404实验室
date: 2024-09-07
fetch_date: 2025-10-06T18:28:31.812448
---

# 原创 Paper | GL-iNet 路由器 CVE-2024-39226 漏洞分析

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/3k9IT3oQhT2OVmxDyJicjufFMKd825S8DibQHDIrsPDic9cnUw17JHVhVRQEbNLoFffuC5TibUoCtSjBibtAn6fg8VQ/0?wx_fmt=jpeg)

# 原创 Paper | GL-iNet 路由器 CVE-2024-39226 漏洞分析

原创

404实验室

知道创宇404实验室

**作者：fan@******知道创宇404实验室****

**时间：**2024年9月6日****

**1 前言**

参考资料

8月5日网上披露了 CVE-2024-399226 [1]，影响多款 `GL-iNet` 路由器，随后开始漏洞应急。起初对 `GL-iNet` 路由器不了解导致踩了很多坑、浪费了不少时间，因此在做完应急后对这次漏洞分析和固件仿真进行记录。

****2 产品介绍****

参考资料

`GL.iNet` 是一家专注于智能路由器和网络设备开发的科技公司。成立于 2009 年，总部位于中国，该公司的产品以 `OpenWrt` 操作系统为基础，提供高度的可定制性和灵活性。公司致力于为家庭、企业以及工业物联网环境提供可靠的网络解决方案。`GL.iNet` 的设备以其开源特性、强大的功能和优秀的用户体验而受到开发者、网络安全专家和高级用户的青睐。

`OpenWrt` 是一个基于 Linux 的开源嵌入式操作系统，专为网络设备（如路由器、网关和接入点）设计。与传统的路由器固件不同，`OpenWrt` 不是单一的、不可变的固件，而是一个完整且可扩展的操作系统，允许自定义以适应任何应用程序。

`OpenResty` 是一个基于 `Nginx`的高性能 `Web` 平台，它将 `Lua` 脚本引擎嵌入到 `Nginx` 中，使开发者可以通过 `Lua` 脚本编写高度可定制的 `Web` 服务，用来处理复杂的 `web` 逻辑和 `API` 请求。`OpenResty` 通常用于高并发、低延迟的 `Web` 应用程序开发，特别是在需要处理复杂逻辑或与外部服务交互时。

这种组合使得 `GL.iNet` 路由器不仅仅是一个网络设备，还可以作为一个小型的 `Web` 服务器或应用平台。

****3 环境模拟****

参考资料

**3.1 固件提取**

`GL.iNet` 官网提供历史固件下载[2]。

```
固件版本：GL-AX1800 Flint 4.5.16
```

`sysupgrade-glinet_ax1800` 文件夹下存在 `root` 文件。

```
$ file root
root: Squashfs filesystem, little endian, version 4.0, 44613986 bytes, 4754 inodes, blocksize: 262144 bytes, created: Thu Mar 21 13:28:00 2024
```

使用 `binwalk`，从 `root` 中提取 `Squashfs` 文件系统。

```
$ binwalk -Me root
```

查看 `bin/busybox` 得知是 `32位arm` 架构。

```
$ file squashfs-root/bin/busybox
squashfs-root/bin/busybox: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /lib/ld-musl-arm.so.1, stripped
```

### **3.2 QEMU模拟**

使用 `qemu-system-arm` 从系统角度进行模拟，此时需要一个 `arm` 架构的内核镜像和文件系统，可以在这个网站下载[3]。

```
vmlinuz-3.2.0-4-vexpress  linux内核镜像文件
initrd.img-3.2.0-4-vexpress  RAM磁盘映像文件
debian_wheezy_armhf_standard.qcow2  虚拟磁盘映像文件
```

启动虚拟环境。

```
$ sudo qemu-system-arm -M vexpress-a9 -cpu cortex-a15 -kernel vmlinuz-3.2.0-4-vexpress -initrd initrd.img-3.2.0-4-vexpress -drive if=sd,file=debian_wheezy_armhf_standard.qcow2 -append "root=/dev/mmcblk0p2" -net nic -net tap,ifname=tap0,script=no,downscript=no -nographic
```

//默认可以不指定 cpu 模型，我在模拟过程中遇到报错所以指定了 cpu。

```
Illegal instruction
```

启动后用户名和密码都是 `root` 即可登录模拟的系统。

接下来在宿主机创建一个网卡，使 `qemu` 内能和宿主机通信。

宿主机安装依赖。

```
$ sudo apt-get install bridge-utils uml-utilities
```

将如下代码保存为 `net.sh` 并运行即可。

```
#!/bin/bash

# Enable IP forwarding
sudo sysctl -w net.ipv4.ip_forward=1

# Reset iptables
sudo iptables -t nat -F
sudo iptables -t nat -X
sudo iptables -P FORWARD ACCEPT

# Set up NAT
sudo iptables -t nat -A POSTROUTING -o ens33 -j MASQUERADE

# Accept traffic on tap0
sudo iptables -I FORWARD -i tap0 -j ACCEPT
sudo iptables -I FORWARD -o tap0 -m state --state RELATED,ESTABLISHED -j ACCEPT

# Create and configure tap0
sudo ip tuntap add dev tap0 mode tap
sudo ifconfig tap0 192.168.100.254 netmask 255.255.255.0 up
```

然后配置 `qemu` 虚拟系统的路由，在 `qemu` 虚拟系统中运行 `net.sh` 并运行。

```
#！/bin/sh
ifconfig eth0 192.168.100.2 netmask 255.255.255.0
route add default gw 192.168.100.254
```

//虚拟系统可能没有 `vim` 或 `nano` ，使用 `echo` 一行一行写。

这样宿主机和模拟环境互通，使用 `scp` 将 `squashfs-root` 文件夹上传到 `qemu` 系统中的 `/root` 路径下。

```
scp -r squashfs-root/ root@192.168.100.2:/root
```

然后挂载 `proc` 、 `dev` ，最后 `chroot` 即可。

```
root@debian-armhf:~# mount -t proc /proc ./squashfs-root/proc
root@debian-armhf:~# mount -o bind /dev ./squashfs-root/dev
root@debian-armhf:~# chroot ./squashfs-root/ sh

BusyBox v1.33.2 (2024-03-21 13:28:00 UTC) built-in shell (ash)

/ # ls
bin      etc      lib      overlay  rom      sbin     tmp      var
dev      init     mnt      proc     root     sys      usr      www
```

****4 漏洞复现****

参考资料

启动 `web` 服务，前文已经介绍过 `GL.iNet` 路由器利用 `OpenResty` 来增强其 `web` 管理界面和 `API` 的功能。而 `OpenResty` 是基于 `Nginx` 的 `web` 平台，内置 `Lua` 脚本支持，所以首先启动 `Nginx` 服务。

尝试运行 `/etc/init.d` 下 `nginx` 脚本(`/etc/init.d` 目录通常包含系统启动和管理各种服务的脚本，如果需要启动某个服务，通常可以在该目录中找到相应的脚本)。

查看 `/etc/init.d/nginx` 如何手动启动 `nginx`。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2OVmxDyJicjufFMKd825S8DpvPg6PLvghXrZaOCpSewASm2QRlM969FneX8r6rB8jwwucVia6iasQfg/640?wx_fmt=png&from=appmsg)

图1 nginx 脚本源码

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2OVmxDyJicjufFMKd825S8DpFtMQd7iapIJiaicMggXMgHXZ7IEAiagKtqC4ER7P4IQ5RuUL0un8XUgFQ/640?wx_fmt=png&from=appmsg)

图2 启动 nginx 报错

创建缺少的文件夹再次启动 `nginx`。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2OVmxDyJicjufFMKd825S8Deno2PhN2FzCwyfzc2k3M3ha5uJFukLjssCAZ5G94WCNZyTaCGOiaHSA/640?wx_fmt=png&from=appmsg)

图3 再次启动 nginx

看样子 `nginx` 好像起来了，访问 `web` 却是 `404`。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2OVmxDyJicjufFMKd825S8DKuicMLpiagfQicVUhwkzgSZlwqpM2mGBbMDhURFgbAsxj24PDDk3K5Bcw/640?wx_fmt=png&from=appmsg)

图4 web 访问 404

这个时候已经没什么头绪了，`find` 一下所有 `nginx` 相关文件试试。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2OVmxDyJicjufFMKd825S8DsU1N5jn5FMuo3Kv77vWcJ1J6CLKsgBfeH7Vsgczywm3BWLyTCYrOUw/640?wx_fmt=png&from=appmsg)

图5 查找 nginx 相关文件

每个文件都看看，发现 `/etc/uci-defaults/80_nginx-oui` 脚本。

`/etc/uci-defaults/80_nginx-oui` 脚本的主要作用是配置和调整Nginx的相关文件，确保Web服务能够正常运行。

尝试运行 `/etc/uci-defaults/80_nginx-oui` 看看是否能修复 `404` 问题。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2OVmxDyJicjufFMKd825S8D8Yv5oAUtM3B0Mg8icnAM0BiaricjNxWc0Gvd4xhfrsdnX9ibj0JhzWibNTg/640?wx_fmt=png&from=appmsg)

图6 运行 /etc/uci-defaults/80\_nginx-oui

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2OVmxDyJicjufFMKd825S8Dmdk3diaXAvRTKsTr9TVIbZNBVM8OptXFuWG7fLsBTdppSKZGy1ZW88g/640?wx_fmt=png&from=appmsg)

图7 web 访问成功

成功修复，接下来尝试漏洞复现，先看一下披露的 `PoC`。

```
curl -H 'glinet: 1' 127.0.0.1/rpc -d '{"method":"call", "params":["", "s2s", "enable_echo_server", {"port": "7 $(touch /root/test)"}]}'
```

从 `PoC` 来看好像只能通过 `127.0.0.1` 利用，先使用 `192.168.100.2` 试试。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2OVmxDyJicjufFMKd825S8Dqiavo01NBIKEB2WuuX6aNRrMfCsX17AfCAZnQCR4W72WFsibOP06h0bg/640?wx_fmt=png&from=appmsg)

图8 PoC 远程利用

拒绝访问，再使用 `127.0.0.1` (之前的会话因为启动 `nginx` ，需要 `ssh` 再创建一个会话)。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2OVmxDyJicjufFMKd825S8DIfJFtXAh54kWygXX0nYogFT2HKA8VxaQ5aOjzcXIQUDyEwaRibibfRTA/640?wx_fmt=png&from=appmsg)

图9 PoC 本地利用

这次报错为内部错误。继续找问题。根据 `PoC` 可知请求的路径是`rpc` ，在 `/etc/nginx` 下的 `nginx` 配置文件中查找 `rpc` 相关信息。

在 `/etc/nginx/conf.d/gl.conf` 找到请求 `rpc` 路径的处理方法。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2OVmxDyJicjufFMKd825S8DBvqgWw8LzlgicyH6n7Eg2OsL0pRYC089w6QF5XDpygkMRNamE1hdupg/640?wx_fmt=png&from=appmsg)

图10 /etc/nginx/conf.d/gl.conf 源码

跟进到 `/usr/share/gl-ngx/oui-rpc.lua`。

代码来看 `/usr/share/gl-ngx/oui-rpc.lua` 是处理 `HTTP POST` 请求 `jSON-RPC` 调用的。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2OVmxDyJicjufFMKd825S8DdHnYyUTJdZicw8IXDiay90CBBBendOpZwicicBs3DZ3mUibSfa4OkFVFJUw/640?wx_fmt=png&from=appmsg)

图11 /usr/share/gl-ngx/oui-rpc.lua 源码开头部分

以上代码实现模块导入、请求方式验证和读取请求体。

要注意 `ubus` 服务是 `OpenWrt` 系统中一个进程间通信框架，需要启动。

`HTTP` 请求仅允许 `POST` ，拒绝其他方式访问。

`/usr/share/gl-ngx/oui-rpc.lua` 定义了多个处理函数，每个函数对应不同的 `rpc` 方法(因为 `PoC` 通过 `call` 方法调用 `s2s.enable_echo_server` 进行攻击，所以只截取 `rpc_method_call` 方法代码)。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2OVmxDyJicjufFMKd825S8Dka9kMoOTN5xCWvUd6tkmpaMJtjSP9znNwEZ0ZZpibBtgZPQlmUr0QqA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2OVmxDyJicjufFMKd825S8DUvOYdM7XgeicAYEkX971Ym9icEZB6gpTlc07lX83dQ7bOS7Fu0gnMNMQ/640?wx_fmt=png&from=appmsg)

图12 /usr/share/gl-ngx/oui-rpc.lua 源码核心部分

`rpc_method_call` 进行参数校验、会话检查和 `Ubus` 调用：

1. 确保 `params` 中至少三个元素且元素类型正确。
2. 检查 `sid` 是否有效，并通过 `rpc.access` 验证访问权限。
3. 如果上述判断均通过，使用 `rpc.call` 执行指定的 `Ubus` 对象和方法。

继续跟进 `/usr/lib/lua/oui/rpc.lua` 查看 `rpc.access` 和 `rpc.call` 实现。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2OVmxDyJicjufFMKd825S8DU4kD7jcTYuoBOYBfD5ibWAo1lxbjtbXEnS8WP7MRLiasQX0MQicVQttmA/640?wx_fmt=png&from=appmsg)

图13 M.seesion 和 M.access 函数源码

`access` 通过 `is_local` 判断是否本地请求。对于本地请求和 `glinet` 标头的请求，总是允许访问(确定了只能本地利用)。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/3k9IT3oQhT2OVmxDyJicjufFMKd825S8D01CZG328wDrRicR873icpqp8p1tVLff4dTTLTMjNPiajOnDZSnFS44icicQ/640?wx_fmt=png&from=appmsg)

图14 M.cal...