---
title: [译]大疆无人机安全与DroneID漏洞
url: https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458496584&idx=1&sn=4d74ffbf312639dba3ab745ac46517af&chksm=b18e9ec286f917d46ed7b5d20462c43a6726db71c8c321b57042b864b4ad5683060f56cbc40a&scene=58&subscene=0#rd
source: 看雪学院
date: 2023-03-08
fetch_date: 2025-10-04T08:55:14.391421
---

# [译]大疆无人机安全与DroneID漏洞

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8E666ZFYXrDRBPfXwcEcOHGcbicIPSzcicic0l3PqpzKU6rhVDHhAI1Hqp6tXcy12erpgFtpt3yfuwAA/0?wx_fmt=jpeg)

# [译]大疆无人机安全与DroneID漏洞

CDra90n

看雪学苑

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8E666ZFYXrDRBPfXwcEcOHGiaBh3PZrDvYNkv2azT25Qqib9cIb42A1JHyxnqK5yVDmyOcoxZr7AOLA/640?wx_fmt=jpeg)

本文为看雪论坛优秀文章

看雪论坛作者ID：CDra90n

#

```
一

摘要
```

消费级无人机可以用于高级航拍、物流和人道主义救援等等。但是其广泛使用给安全、安保和隐私带来了许多风险。例如，攻击方可能会使用无人机进行监视、运输非法物品，或通过侵入机场上方的封闭空域造成经济损失。为了防止恶意使用，无人机制造商采用多种对策来强制安全可靠地使用无人机，例如对速度和高度施加软件限制，或使用地理围栏实施禁飞区。

作为对传统对策的补充，市场领导者大疆（DJI）为无人机实施了一种称为 DroneID 的跟踪协议，该协议旨在将无人机及其操作员的位置传输给授权实体，例如执法部门或关键基础设施的运营商。

本文中分析了无人机的安全和隐私声明，重点关注市场份额为 94% 的领先制造商 DJI。首先，将现有无人机的攻击面系统化，并调查了能够窃听无人机空中数据流量的攻击。通过对DJI固件的逆向工程实现了大疆专有跟踪协议 DroneID 的解码器，且仅使用廉价的COTS硬件。研究结果表明，DroneID传输的数据未加密且任何人都可以访问，这损害了无人机操作员的隐私。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E666ZFYXrDRBPfXwcEcOHG9HLodyiahyA9UiaHTDia9JFwDFr04iaUdYknYCzHuMbz9hiaR15z3lVstibw/640?wx_fmt=png)

其次，对无人机安全性进行了全面分析：结合逆向工程、针对 DJI 通信协议定制的新模糊测试方法以及硬件分析，研究者发现了无人机固件中的几个关键缺陷，这些缺陷允许攻击者在两个不同的平台上获得DJI 无人机及其遥控器的更高特权。这种根访问权限可能会导致禁用、绕过反制或滥用。此研究总共发现了 16 个漏洞，从拒绝服务到任意代码执行等等。这些错误中的 14 个可以通过操作员的智能手机远程触发，并导致无人机在飞行途中坠落。

#

#

```
二

研究介绍
```

尽管存在潜在的安全隐私风险以及无人机的滥用，但有无人机系统的系统安全方面尚未得到全面评估。本研究包括：

• 安全分析：对市场领导者大疆的消费级无人机进行了全面的安全分析。这个分析包括无人机本身和遥控器的硬件、软件和无线物理层。通过分析揭示了多个严重的安全漏洞，这些漏洞允许任意命令执行和绕过反制措施，甚至可以在飞行途中远程破坏无人机。

• DroneID： 对当前大疆无人机的固件和无线物理层进行逆向工程，以分析 DJI 的专有传输协议 OcuSync。基于这些发现，得到了DroneID 接收器、解调器和解码器的组合，以揭示包括无人机和远程操作员实时位置在内的敏感信息。

• 模糊测试：设计并实现了一个定制的黑盒fuzzer，它将 DJI 特定语法与新的Bug Oracle相结合，以识别无人机及其遥控器中的故障。该fuzzer发现了可用于获得根访问权限，目前大疆已修复所有错误。模糊测试框架和相关数据已开源：https://github.com/RUB-SysSec/DroneSecurity

#

#

```
三

大疆无人机相关原理和基础
```

大疆是全球领先的商用无人机制造商，总市场份额约为 54%（截至 2021 年底），在消费无人机领域的市场份额为 94%。DJI 提供了一份关于其安全机制的白皮书（https://security.dji.com/data/resources/ ），从而在安全和安全方面建立了坚实的基线。鉴于大疆的实际重要性，本研究的工作重点关注该供应商在 200 克到 1 千克之间的消费级无人机。在这项工作中使用三种不同的大疆无人机模型及其相应的遥控器 (RC) 进行安全分析以及针对不同固件的逆向工程：

• DJI Mini 2，RC：RC231

• Mavic Air 2，RC：RC231

• Mavic 2 Pro / Zoom, RC: RC1B

##

## **A. 通信接口和协议**

下文概述了大疆无人机的接口和通信协议，这些都直接暴露给攻击者。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E666ZFYXrDRBPfXwcEcOHGpDQFMkrDaE0ibJG1Jgl0ibqaugYN8fAfLCftF0YnuOc14rKCyvRaCFYg/640?wx_fmt=png)

上图概述了大疆无人机的不同接口，以及如何使用这些接口在无人机、遥控器 (Remote Control，RC) 和计算机之间进行通信。在无人机运行过程中，无人机与遥控器进行通信，而计算机仅用于分析、更新或访问无人机或遥控器上的文件。

###

### 1. USB

无人机和遥控通常都有一个 USB 接口，用于各种设备类别和用例。预期用例是下载数据，例如来自内部存储的媒体文件或来自飞行记录器的飞行日志。对于 DJI 设备，USB 接口还用于发送大疆通用标记语言 (DJI Universal Markup Language，DUML) 命令 - DJI专有通信协议 - 以控制设备的内部设置或启动固件更新。此外，在设备的启动过程中会暴露一个引导加载程序，它可以通过特定的 USB 数据包触发。遥控器（RC231）上有两个 USB 接口，一个用于连接智能手机和遥控器以访问 DJI Fly 应用程序，另一个用于为遥控器充电。充电端口还可用于将遥控器连接到计算机。

###

### 2. UART

通用异步收发器 (UART) 接口主要用于有线通信的微控制器。这种 UART 接口也可以在大疆无人机中找到，如Sparrow S1 收发器，也称为 S1 片上系统（System on a Chip，SoC)。在硬件分析过程中发现该界面在启动后启用了两秒，并显示了bootloader的启动画面。

###

### 3. 无线物理层

包括蓝牙、WiFi 和 OcuSync。最新的大疆无人机支持不同的无线协议，如蓝牙和 WiFi。例如，使用 DJI Fly 应用程序将无人机相机拍摄的照片传输到智能手机。WiFi 连接也可用于 Mavic Pro 或 Mavic Air 等较旧的无人机，但用于命令与控制 (C2) 链接以通过智能手机控制无人机。在较新的大疆无人机上，此通信链路已被专有的 OcuSync 无线电协议所取代，该协议的性能明显更好并且不易受到干扰。

###

### 4. DUML

DUML是大疆使用的专有通信协议，可用于在内部模块之间以及从 RC 向无人机发送命令和数据。DUML 用于设置和更改无人机的参数，如最大高度的飞行参数或最大上升和下降速度等不同速度参数。由于此协议的解析过程容易出错，因此 DUML 是进一步安全分析的有趣目标。因此，在下面提供了此自定义协议的详细概述。

区分两个 DUML 协议版本：V1 和 Logic。Logic协议用于无人机各个模块之间的内部通信，而V1协议用于通过USB在计算机和无人机之间进行通信。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E666ZFYXrDRBPfXwcEcOHGeY4KpfPGHVuladUMBEGxf9t7iaF2QW7SM9kB9CNlpVkAiaJI39qrCMSA/640?wx_fmt=png)

如上图所示，DUML数据包的结构可分为四个部分：标头、传输、命令和有效负载。标头包含一个设置为固定值 0x55 的魔术字节，然后是数据包的长度、版本号和 CRC-8 标头校验和。标头后面是传输数据，用于设置 DUML 命令的发送者/接收者。有 32 种已知的发送方和接收方类型（如PC, Mobile App, Center Board和WiFi）。除了源和目的地之外，数据包的传输部分还包含一个唯一的序列号，用于维护多个数据包的顺序。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E666ZFYXrDRBPfXwcEcOHGTxOeLiaI2gJ24icw4umsGmAaRbFXwAJhOx6RppIMS9QZNVNtKx6y4S1Q/640?wx_fmt=png)

DUML 数据包的第三部分是它自己的命令。此处定义了字段 commandtype、commandset 和 commandid。将根据commandtype设置确认类型、数据包类型和加密类型。commandset 指定哪一组命令可以用于 commandid。有 17 个已知的命令集可以使用，如general, flight controller, WiFi或battery。逆向工程结果证实了这些发现。数据包的最后一部分是有效负载和对整个数据包计算的 CRC-16 校验和。出于效率原因，在信息紧凑的地方使用自定义编码。上图和下图分别总结了这种编码和解码。接下来将基于恢复的 DUML 格式进行动态安全测试，并使用它来构建自定义模糊测试框架。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E666ZFYXrDRBPfXwcEcOHGJSGgwFMKr2bv7icuv0lKL9UzssdQkicnQBRYrUyXzjjV5KVLAF2V1GGg/640?wx_fmt=png)

###

### 5. DJI Fly和DJI Go 4应用程序

大疆为 iOS 和 Android 提供了一个应用程序来显示实时视频源和其他控件。最新的无人机使用 DJI Fly 应用程序，而传统无人机使用 DJI Go 4 应用程序。这两个应用程序提供基本相同的功能，特别是都显示无人机的实时视频源、允许拍照和录制视频、更改不同的无人机设置、更新固件或检查无人机的一般状态。

##

## **B. 无人机固件**

根据复杂性，无人机使用不同的操作系统 (OS)。对于大多数 DJI 无人机，操作系统基于 Android，Android 也用于旧版本的遥控器（例如 Mavic Pro RC GL200）。DJI Mini 系列使用基于 Buildroot的 32 位 ARM Linux。对于时间和性能关键的操作，使用实时操作系统 (RTOS)，例如。例如，飞行控制器和较新的 RC（例如 RC231）在收发器中使用两个 RTOS 来管理射频 (RF) 连接 - 一个应用程序和一个通信处理器。收发器中 RTOS 的固件可作为两个处理器的加密二进制文件使用。操作系统（RTOS 固件除外）采用基于嵌入式系统中常用的 BusyBox 软件套件。DJI 以使用 AES 加密并使用 RSA 签名的专有文件格式对其固件进行编码。不同的模块、文件和用例（例如固件更新或传输）使用不同的加密密钥。其中一些加密密钥已被 DJI 社区的个人泄露，用于解密部分固件；研究者确认这些密钥有效。

##

## **C. 无人机硬件**

接下来，概述了无人机中使用的典型硬件组件。下图以 DJI Mini 2 为例显示了此类无人机基本组件的概览。该图还说明了各个组件如何链接在一起以及它们如何相互通信。此概述和以下描述可转移到仅组件性能不同或具有额外传感器的其他 DJI 无人机型号。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E666ZFYXrDRBPfXwcEcOHGUExccCNW8SYIr0xZSj8RzEjyoStmSc1huyyHkSyKqerweAxThUicbew/640?wx_fmt=png)

### 1. 飞行控制器

飞行控制器是无人机最关键的部分，必须在任何情况下都有可靠性、可预测性和确定性。为了确保这些属性，飞行控制器使用了 RTOS。控制器通过收集来自惯性测量单元 (IMU)、指南针、GPS 或视觉定位系统等传感器的输入来监督飞行行为。它使用此信息通过向调节四个电机速度的电子速度控制 (ESC) 控制器发送指令来维持稳定飞行。此外，它还负责通过检查电调、电池和其他模块的状态来批准飞行并允许无人机起飞。此外，它还会检查内部禁飞区 (NFZ) 数据库，以确定无人机是否被禁止进入附近空域的特定区域。飞行控制器通过收发器（此处为 S1 SoC）接收控制命令，并对从该 SoC 接收到的用户输入做出反应。此外，飞行控制器将来自不同模块和传感器的信息发送到收发器。

###

### 2. 视频编码和防撞 SoC

该 SoC 处理图像传感器和视频编码。它接收来自摄像机的视频和图像数据，对其进行处理，并将其转发给收发器。如果安装了额外的传感器来避免碰撞，它们的数据也会在此 SoC 中处理。除了将视频数据发送到收发器外，SoC 还使用 USB 接口将图片或视频存储在内部存储器或 SD 卡上。最后，它处理无人机的固件更新过程。此 SoC 为 DJI 无人机使用基于 Linux 或 Android 的操作系统。

###

### 3. 遥控器

遥控器通过 C2 链路控制无人机和相机。来自控制器和智能手机的用户输入被发送到收发器，收发器调制信号并通过 OcuSync 协议传输。此外，RC 接收无人机的下行链路数据，其中包括遥测数据和视频馈送，然后将其传递给智能手机。RC231 也使用 S1 SoC 作为收发器，支持最新的 DJI 无人机，如 DJI Mini 2、Mavic Air 2、Mavic Air 2s 和 Mavic 3。这些无人机使用 OcuSync 传输协议进行 C2 和下行链路。选择的OcuSync版本以实际无人机机型为准 - 可以是 OcuSync 2.0、3.0 或 3+。

###

### 4. 收发器

收发器结合了用于无线电通信的发射器和接收器，是无人机的重要组成部分。它通过专有协议或无线标准（如蓝牙或 WiFi）工作。一些最新的 DJI 无人机使用所谓的 Sparrow S1 收发器进行 OcuSync 传输。该收发器是基于 ARM Cortex-M CPU 的专有 SoC，可以在 Mini 2 和 Mavic Air 2 中找到。Mavic Air 2s 和 Mavic 3 使用所谓的 P1（Pigeon）SoC 作为收发器。本研究专注于 S1 SoC。

该 SoC 用作 OcuSync 的收发器，并包含两个用于应用处理器和通信处理器的 RTOS。RTOS 的固件称为 Sparrow 固件，可以在 RC 的固件更新以及无人机的文件系统中找到。无人机中的收发器接收来自飞行控制器的遥测数据和其他报告以及来自视频编码 SoC 的视频数据。然后，所有这些数据都经过 RF 调制并通过天线传输。此外，收发器从遥控器接收 C2 链路并将此数据传递给飞行控制器。

###

### 5. WiFi / 蓝牙芯片

WiFi 或蓝牙芯片也可以作为收发器，连接遥控或智能手机来控制无人机。然而，这种设置的缺点是范围和可靠性不如专有无线电协议。DJI Mini 2 和 Mavic 3 有一个额外的 WiFi 和蓝牙芯片，允许用户轻松访问存储在无人机上的媒体文件。

###

### 6. 额外传感器和其他硬件

大多数当前的消费级无人机都有一个连接到万向架的高分辨率相机。该万向架补偿了无人机的运动，并确保稳定的图像。除了主摄像头，无人机还可以使用额外的摄像头来避免碰撞。其他传感器可以包括用于测量无人机高度的红外线或超声波传感器，或分别用于测量加速度和倾斜度的加速度计和陀螺仪传感器。

##

## **D. 无线物理层**

当前一代的大疆无人机使用专有的 OcuSync 协议，在不受管制的 2.4 GHz 和 5 GHz ISM 频段中进行无线传输。无人机将高带宽、实时视频传输到 RC，然后传输到连接的智能手机。RC 通过 C2 信号控制无人机。根据 DJI，上行链路和下行链路均采用 AES-256 加密。OcuSync 在 2.4 GHz 和 5 GHz ISM 频段的传输范围约为 15 公里。

根据 FCC ID 数据库，这些设备使用 20 MHz 宽的信道作为下行链路（从无人机到远程）和正交频分复用 (OFDM) 信号。控制上行链路使用较窄信号的跳频。早期的无人机使用可以使用 WiFi 卡嗅探的“增强型 WiFi”。相比之下，没有公开可用的 OcuSync 兼容接收器可以解码来自无人机或 RC 的信号。

#

#

```
四

无需物理访问的安全分析
```

无人机是由许多模块组成的复杂网络物理系统。如前图所示，这些模块为攻击者暴露了各种接口。组件和接口的相互作用需要访问功能的系统化，以提供对无人机的全面安全分析。这些接口可分为无线接口和需要物理访问的接口。

##

## **A. 威胁模型 - 被动攻击**

在安全分析的第一部分，假设攻击者无法物理访问无人机本身或 RC 的场景。因此，攻击者仅限于无线链路和广播信号。设想一个攻击者被动地监听无线物理层以检测无人机以及伴随的 RC（即操作员）的下落。在后文中放宽了这一假设，并考虑攻击者可以物理访问无人机，因此具有更广泛的利用功能和访问关键信息的能力。
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8E666ZFYXrDRBPfXwcEcOHGnBByq5hUJXpVcJcY9xQ5ZcJDFlxzfkkfcFiaMfLl4PuTYOgvuuXoY4Q/640?wx_fmt=png)

##

## **B. 无线链接**

无线链路是一个关键的攻击媒介，因为它控制着无人机并且可以远程访问。DJI 无人机使用专有的 OcuSync 协议来控制无人机并将视频流传输到遥控器。大疆销售的Aeroscope是一种允许执法部门定位无人机和操作员的设备。对于这种定位，Aeroscope 会侦听一种称为 DroneID 的特殊信号，该信号由所有 DJI 无人机广播。不幸的是，OcuSync 和 DroneID 都没有公开记录，也没有可用的开放接收器。DJI 的安全白皮书没有明确提及 DroneID 传输、它们的特性或内容。在本节中展示了对 DroneID 广播进行逆向工程的结果，并展示了如何成功提取敏感信息，例如无人机和远程操作员的位置。
...