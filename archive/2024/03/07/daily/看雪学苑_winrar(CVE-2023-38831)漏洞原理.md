---
title: winrar(CVE-2023-38831)漏洞原理
url: https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458544969&idx=1&sn=473822d99738dc8c20cf0c7df866adea&chksm=b18d5bc386fad2d597b3b73e9bbd6d243e83e0191527db7cf84f277ac8c455b590956d5da778&scene=58&subscene=0#rd
source: 看雪学苑
date: 2024-03-07
fetch_date: 2025-10-06T17:09:38.480032
---

# winrar(CVE-2023-38831)漏洞原理

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwkPmkfApawWJXKr0O0EViaryEhHeeSmN48ZxOq1KR6bic2shQD1rzWlvQ/0?wx_fmt=jpeg)

# winrar(CVE-2023-38831)漏洞原理

time.time

看雪学苑

##

```
一

背景
```

WinRAR是最受欢迎的压缩工具之一，在全球拥用超过5亿用户。**2023 年 7 月 10 日**，国外威胁情报机构Group-IB研究**DarkMe**恶意软件传播时，在 WinRAR 处理 ZIP 文件格式中发现了一个以前未知的漏洞。通过利用该程序中的漏洞，威胁行为者能够制作 ZIP 存档，作为各种恶意软件系列的载体。**2023 年 8 月 15 日，MITRE Corporation 将此零日漏洞标记为 CVE-2023-38831**。

##

```
二

漏洞详情
```

漏洞受影响范围：5亿WinRAR用户；

漏洞受影响版本：WinRar < v6.23所有版本。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFw5TWINLggGL5ILxGTUzrA9eiaOZIX7XYhXQjmwBznBHzK6AY24mUOyJQ/640?wx_fmt=png&from=appmsg)

#

##

```
三

漏洞复现
```

#

WinRar在小于6.23版本中点击压缩包中的文件预览时错误得将被点击的文件名和同名文件夹下的所有文件释放到临时目录中，随后调用Shellexecute执行文件造成代码执行。

正常情况下windows文件系统不允许同一路径下存在同名的文件或文件夹，但是可以通过一些途径绕过此限制。

1.创建一个test.txt1文件和一个test.txt2文件夹，在test.txt2文件夹中创建一个test.txt3.cmd，写入打开计算机，然后打包成zip文件。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFw3iaaBYBxCNqkib8styPB15akaicxXnwCkf0GTWXicSJsaQlFnfHWlT9y0Q/640?wx_fmt=other&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwzZzDGjB8kxyZH4kqDDPMSa6y0try9QqdaIKPM1HicxhUDTPxbmibeJ5A/640?wx_fmt=other&from=appmsg)

2.使用16进制编辑器，如010Editor，对压缩文件中的文件名进行更改。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwN5Ohvx0fqjqrJXrU6wXeZCaJTo2VZJSLrJ4u2xLiaCFJNFiahl58ykEA/640?wx_fmt=other&from=appmsg)

这里代表有3个文件，我们把txt后面的数字123都改成空格，空格x`对应的acsll码是0x20。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwWicTro3U5rwh2xFkcWZjnpeXgOHVElXUA7ZprQdBzlaeNe80liciaBysQ/640?wx_fmt=other&from=appmsg)

再去看压缩包发现文件夹和文件已经是同名的。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwwUSiaC8XLcZZicibSr4I5t7kYzd5q16vLJruWrCMDvEsMdKctaXgTMOmw/640?wx_fmt=other&from=appmsg)

此时去双击test.txt 文件，会发现.cmd文件被执行了，弹出了计算机，且临时目录下提取了两个文件。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwsJCgRbfrVz80VytyglJev2lqqgHom5dBgibM9gAZ5doDCBP78lMx07g/640?wx_fmt=other&from=appmsg)

至此，Winrar代码执行漏洞复现完毕，下面我们了解下，这个过程发生了什么，为什么要该掉一个字符为空格（0x20)？为什么点击了一个文件却解压出来了两个文件？为什么test.txt .cmd被执行了？

# Winrar的执行流程

Winrar是一个GUI程序，在用户双击一个文件预览时会发送一个WM\_LBUTTONDOWN消息，然后主程序根据此消息获得点击的文件名，也就是click\_name,随即主程序会遍历压缩包中所有的deFileName（文件夹也在此列)，当deFileName==click\_name那么该文件就会被释放出来并写入临时目录中，也就是说同名文件夹下的所有文件都会被释放出来。最终Winrar会初始化ShellExecuteInfo结构体，将click\_name释放后的路径设置到lpFileName中，并调用Windows系统APi ShellExecute函数执行该文件。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwLaDkGK6ibuSbr5SZPhWAJvJqpMZ7JPolv39KwxDWrGWVVoX37WfgOeQ/640?wx_fmt=other&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwtotkEY0CZ8g8e0ibsLaQXTkIGc3PHLqBiceux4A364wnopYVxuILeavA/640?wx_fmt=other&from=appmsg)

我们通过调试逆向的方式看到整个流程确实是这样的，而且在调用Shellexecute函数时可以看到文件名也确实是test.txt 。为什么最终是test.txt .cmd被执行了。带着这个问题继续往下看，我们知道一个程序被运行是要被加载到进程空间的，因此Shellexecute函数最终也会调用CreateProcess等函数来创建进程，于是在进程创建函数上下断点进行调试运行。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwxj2se7pPaEgTXgphq1K40hZtFjx6xYdALqoAcHUOAbJhU5IvAwgib8A/640?wx_fmt=other&from=appmsg)

此时断点命中CreateProcessW，但这里发现一个问题，WinRAR在调用ShellexecuteW时lpFileName参数明明是"test.txt ",后面调用CreateProcesssW创建进程时却变成了”test.txt .cmd“。很明显ShellexecuteW做了一些我们不知道的操作，更改了参数。那shellexecute做了什么就变成了了解问题的关键。

# ShellExecute函数

Shellexecute在处理一个文件时会通过文件路径获取文件的扩展名(PathFindExtension)，然后通过注册表和\*\*`AssocQueryString`\*\*等文件关联函数获取绑定了扩展名的关联程序(例：.xml文件的关联程序：MS Edge微软浏览器)的绝对路径，最后将创建进程所需的ModuleFileName参数设置为获取到的绝对路径，CommandLine参数设置为文件的绝对路径，并调用CreateProcessW启动进程。

如果没找到扩展名，则会对当前目录下的所有同名文件进行遍历，如果存在同名文件且是可执行文件(com、cmd、bat、exe等)则使用该可执行文件作为进程的模块地址。若找不到同名文件，或没有找到扩展名的关联程序，那么会弹出窗口让用户自己选择要使用的处理程序。

# 以正常的test.txt文件为例

该文件为正常的.txt文本文件，后面无空格。此时再到CreateProcessW断点处，可以看到ModuleFIleName(lpApplicationName)参数被设置为notepad++的地址，CommandLine参数被设置为test.txt文件地址，这些参数都是Shellexecute进行设置的。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwYKPxdDOnrJF6hnlKviboGl2cFPpjrtYVdU5FQ4Q6rZ7icKBxInoVRr3Q/640?wx_fmt=other&from=appmsg)

Shellexecute会通过.txt后缀名在注册表中找到绑定的ProgID(一般在默认键值中)，如果没设置默认值也可以在子键OpenWithProgID中找到绑定的ProgID，随后根据ProgID找到注册的处理程序的路径地址，将之设为ModuleFilName参数的值。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwKOd6fC8UichH7iasutQs6bvw6v4Sx80s8Zy3JZciaK5Tf5ia1JUN3nnH4A/640?wx_fmt=other&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwXIVrcibw8InicNmKibDleXXsluFwPWiauR98NT0bfyqhdoMh1k6odBNmcQ/640?wx_fmt=other&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwGcKe7JEXgcUcVibIWXpibicoPYVf8He8r7oia07DGUz6pjbZN9VgIMSyvw/640?wx_fmt=other&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFw0mw3DP3sCx9HD5hCvS36KUd93HvQEx1p6miaK3jdNCa9CicYbr6bwzhA/640?wx_fmt=other&from=appmsg)

#

# 以恶意的test.txt 文件为例

注意，test.txt后面有个空格，此时就变成了最初看到的情况，test.txt .cmd被设置成了创建进程的参数。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwxj2se7pPaEgTXgphq1K40hZtFjx6xYdALqoAcHUOAbJhU5IvAwgib8A/640?wx_fmt=other&from=appmsg)

接下来我们通过逆向ShellExecute函数看看为什么加了空格后，原本的执行逻辑就改变了。

# ShellExecute函数逆向

ShellExecute在Shell32.dll中，大致执行流程如下图所示，我们只关注的核心的标红函数，这三个函数是最终的问题所在，但他们不在Shell32.dll而是在Shlwapi.dll中。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwVAI1iapB0uZ7upJP4dLSZ4NAbxMeCTHCs0MZmDsSicDB6KFMJWhlMafQ/640?wx_fmt=other&from=appmsg)

#

# PahtFileExistsDefExtAndAttributesW

路径字符串末尾为空格或”\“就会返回指向NULL的指针(windwos文件系统在创建文件时首部和尾部会自动把空格清除)。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwUd7ZEHQO7NGncqqzP3xP4ph7aIMkPtp3UxB5mPkiaruFKPMjgC3icYAA/640?wx_fmt=other&from=appmsg)

#

# PathFindExtensionw

该函数没找到符号文件,IDA解析时有问题，故用了另一位博主**B1tg**的图。通过伪代码可以看出如果路径长度超过最大长度或在最后一个点后再次出现空格或\都会返回指向NULL的字符串指针，即未找到后缀名。这也是为什么把最后一个字符串改成空格的原因。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwlHjktjIO2xqKwViaq27A5ALtOhNHKYZgpBzDbpa04MaHW9kpyEvHcVg/640?wx_fmt=other&from=appmsg)

当未找到后缀名时会进入sub\_63192842函数中。

# sub\_63192842

这个函数的主要功能是遍历当前路径下的所有文件，并将文件后缀和一个数组比较，数组中是windwos系统下常见可执行文件的后缀名。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFw0De0w91UvXJOIcoe9znniaklQkf58Zxs5HTicHeukYxEUbsYpRYse7sA/640?wx_fmt=other&from=appmsg)

对遍历到的文件进行比对，返回数组下标。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwy10WfjkbqBBc85fLsoYAMbW5fbsIhDd5N3fvjMJdiaxjBvqcU63XAUg/640?wx_fmt=other&from=appmsg)![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwfQ3Hc40Sn0M0YTW8fRmGhtUqBU8FyxMPcN7doVvIpyyvSfOXN4tqrw/640?wx_fmt=other&from=appmsg)

所以test.txt 文件因为.后面出现的空格返回了Null，导致if中的表达式为False，于是进入了sub\_63192842函数中，搜索到了test.txt .cmd文件，最终该文件被返回并设置了进程创建的参数完成了代码执行。

当然如果同一路径下也没发现这6种可执行路径的后缀则会启动rundll32程序，加载shell32的OpenAs\_RunDLL函数弹出对话框，让用户选择要执行的程序。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwDLLNjqaJbOmWRAYkmDNpziaw0ZxYOGLkp5FibS3CzZicexz5U3AMdpUwA/640?wx_fmt=other&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwJ91zXicAOmhIhxCyyNmU7kNhxnTSpo5HHVk7y8WtRO5fUVFtYLaHexw/640?wx_fmt=other&from=appmsg)

##

```
四

总结
```

触发该漏洞的完整调用链大致如上所述，究其原因还是Winrar程序本身在双击文件预览时错误的释放逻辑，以及WindowsApi Shellexecute在根据后缀名寻找相应执行文件时触发本地搜索的特性，二者结合才形成了完整的漏洞利用链条。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8G7HtHFr3o4kgcibyhopANFwTj5WTkHJpT19FdhSibE4cvmHjn2g2nnQVXDdLBPTSjTHcSQp9mzibo7A/640?wx_fmt=png&from=appmsg)

**看雪ID：time.time**

https://bbs.kanxue.com/user-home-967913.htm

\*本文为看雪论坛优秀文章，由 time.time 原创，转载请注明来自看雪社区

[![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GJubmq65v9uBFmEJuoJD78w0KV7JRTgp4BfEUygPooDj4dATOIfNQBtpSUKfiaqygawibPHPr5tY5A/640?wx_fmt=png&from=appmsg)](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458542779&idx=3&sn=ca6d34e5d9af9acd1abd46ed43224744&chksm=b18d523186fadb2759ffaa18bd8b1b403bce7673bfeeb9162f4528120ba5a76bafab88c15ebc&scene=21#wechat_redirect)

**#****往期推荐**

1、[ELF文件脱壳纪事](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458543004&idx=1&sn=725adc0fb63a7bf7...