---
title: 银狐样本分析
url: https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458554906&idx=1&sn=271d52cc31bff5aadaba023dd2db8fe3&chksm=b18da29086fa2b861941c8eac1e53923a283cf1994b2814f0b8af5475d7e705df3c9d44c860b&scene=58&subscene=0#rd
source: 看雪学苑
date: 2024-05-16
fetch_date: 2025-10-06T17:16:19.966158
---

# 银狐样本分析

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8cst8M1oIvHPUj8UicanSAv0GViblt7chibp6BSRuqsqnjZEXF0N4hOJXu1g/0?wx_fmt=jpeg)

# 银狐样本分析

pyikaaaa

看雪学苑

病毒概述

msi在安装过程中执行恶意脚本，在C盘释放载荷ee.exe，ee.exe解密执行shellcode，shellcode通过多种手段执行反调试操作，添加Windows Defender的排除路径，解密字符串获取url后建立连接下载文件并解密，获得多个url，继续下载文件释放到指定路径下，文件包括具有数据签名的白文件，恶意dll，ffff.pol，ffff，lop。

Shellcode加载白文件，白文件运行过程中加载恶意dll，恶意dll加载ffff.pol到内存中，ffff.pol是缺少MZ头的pe文件，添加后跳转到入口点执行，ffff.pol解密ffff.lop文件得到dll文件和ip地址等，执行ffff.lop文件的导出函数Edge与c2建立通信获取指令执行窃密、提权、设置自启动等操作。

根据域名，释放文件路径，远控模块判断是银狐病毒。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csNNvsq4icQXiahZKYF7MGkHiauic6tkhXVRqzzbUVJfSO9AH3DoibOq3lRicA/640?wx_fmt=png&from=appmsg)

##

## MSI文件

Msi文件中被注入恶意脚本，在安装过程中将三个文件的内容合并成一个二进制文件C:\ee.exe并执行。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csfL2U5ejric2WicFB4DGoA6SIgP9g0rIQrUDNREJ5XDSbxGQun9G1ZBMg/640?wx_fmt=png&from=appmsg)

##

## ee.exe

ee.exe入口点被修改为跳转指令，text段存在shellcode。将shellcode复制到申请到的内存空间后跳转执行。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csNJeqo5FO5Sqib000JhxlINvISPsOHTTCSsgibbY3fhQZT20iaVkQmbszw/640?wx_fmt=png&from=appmsg)

##

## shellcode

通过xor解密shellcode。

利用LoadLibraryA和GetProcAddress动态获取其他函数。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csicibh56OdFKibcFFNvqFuB6A8eGhFbhyVgXWCFDwiapJo0guicYAMl54m5w/640?wx_fmt=png&from=appmsg)

调用CreateToolhelp32Snapshot()，Process32First()和Process32Next()函数遍历进程，判断是否存在MsiExec.exe进程。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csicPgTzE9VtvpP0ibMCJH5o6ibB6JoKwrGztUzNcKUmgzFOnclbKicjYbZw/640?wx_fmt=jpeg&from=appmsg)

调用GetCurrentProcessId()函数获取当前进程ee.exe的pid，遍历进程，通过进程id判断是否是当前进程，是当前进程则获取当前进程的父进程pid。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8cs5GiaGic3iaicuLS6PicibWlHgj9SgicWddaj3I2O5Bfou9ZqZ64Gts4DUXj0Q/640?wx_fmt=png&from=appmsg)

遍历进程获取ee.exe父进程的父进程pid。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csIDvlLiaF59lM2qHnI6MupDjWRXmUuaiamuHlRlqSBfX8g7JexwzewcLw/640?wx_fmt=png&from=appmsg)
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csOGfcyY7iawV5ZJCeibMflFwiaRyFpe5bzzFXOGUzr5BHyVibL6hIzEunxQ/640?wx_fmt=png&from=appmsg)

再次遍历进程获取ee.exe父进程的进程名。再次遍历进程获取ee.exe父进程的的父进程进程名如果是explore.exe结束进程。

获取计算机名称，创建互斥体。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8cswPLjoOVhL6WJRbkAOV86YtSYAfgZGYmQQ3OJdXSyRkcM4zNAm7GH5g/640?wx_fmt=png&from=appmsg)

解密出配置文件路径C:\xxxx.ini。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8cs93apBN7XCbqxegKmzsD0VurowvbZzP8oic2BCOkwuptTrrShWfNWsKQ/640?wx_fmt=png&from=appmsg)

利用GetTickCount64函数和rdtsc反调试。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8cshhoZXaPty0ib4gJI7poF8sgR3gicIZ0Nf7g6yIhsnEc7bic68kicf2FKBg/640?wx_fmt=jpeg&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csibR7lbPAQjuvoO7aM2tdueClvXXUpictUUz0Swb5AWF2HHwPWIhrujGg/640?wx_fmt=jpeg&from=appmsg)

调用CreateToolhelp32Snapshot()，Process32First()和Process32Next()函数遍历进程，判断是否存在360tray.exe，360sd.exe，360safe.exe进程。如果存在结束进程。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8cspsy6moM8faMrh1w9uxV5uQYO87XuflbHNWdrwz0PmesfRdEA5gOl1Q/640?wx_fmt=jpeg&from=appmsg)

调用CreateToolhelp32Snapshot()，Process32First()和Process32Next()函数遍历进程，判断是否存在msmpeng.exe，mpcopyaccelerator.exe，securityhealthsystray.exe进程，这些是windows defender相关进程。通过这个shellexecuteA调用，会启动 PowerShell 并执行指定的命令，完成对Windows Defender的排除路径的设置。排除的路径包括'C:\ProgramData'和'C:\Users\Public'。参数-Force表示强制执行，即使有警告或确认提示也会被忽略。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csib09V6ibzianXnRtB7XTMaOn9yRCXnTkzaQ024X3FytntuavrE3GTN7Qw/640?wx_fmt=png&from=appmsg)

由硬编码的字符串解密出url：Hxxps://oss3333.oss-cn-shanghai.aliyuncs.com/c.dat。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csyNWLjycCpOwyOSDhmYTcpvPDeSMNU4Gxm5OFBf9vDiatLvnkx5P9yfg/640?wx_fmt=jpeg&from=appmsg)

调用InternetOpen，InternetOpenUrlA，InternetReadFile读取数据到申请的内存中。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csic3KY7qWcyrL8rx8wcnr0icIahkn7lRu7N6hr3At8vibrnWLLzsBh9gJg/640?wx_fmt=jpeg&from=appmsg)

从读取的内容中解密出以下url。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csDZsHW9SbhcIzrcy4fR0GmsN4g544tma0ibBRwpW7ZYUUTgKMgEJ7Mdw/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csR9LruuiaribJ57UfSgdcDldRicZgicagOCAN4GZP7l1asdUkiaqLKicp6v9g/640?wx_fmt=jpeg&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csrVgCAWzg1Le5A2w79W4d4yH49nfIDS94LBC72v6BNlHRyf5RZiagGZQ/640?wx_fmt=jpeg&from=appmsg)

随机生成字符串后，从硬编码的字符串中解密出释放路径。之后与随机生成的字符串拼接，调用CreateDirectoryA函数创建目录。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csHtLuiaua9yx5PTygaegwKsbDH2McESTAkhG7N6tYNWmeTonPTxibeBTw/640?wx_fmt=png&from=appmsg)

生成随机字符串与上述路径拼接后与.exe拼接。之后又拼接出三个路径如下图所示，文件名由上文中https通信读取的数据解密得到。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csLoIicMHqGaiazsaiaunGZrKogEJRAIkDGnCwYFjU9GEhHrmvuJsO0ae9w/640?wx_fmt=jpeg&from=appmsg)

调用InternetOpen，InternetOpenUrlA，InternetReadFile从Hxxps://oss3333.oss-cn-shanghai.aliyuncs.com/DMR\_120.jpg读取数据到申请的内存中异或解密得到pe文件。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csJ669DWCOP523sDriceKMJjibTLrFeWysEjmUHY8wSkKzoTTXlh1TRXjw/640?wx_fmt=jpeg&from=appmsg)

写入到下图所示文件中。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csHtVD8EOZX3NJ2SkvrVjZ7ZBkDJttd2M3mTgvhXCpeXn4wqbdtib2qcg/640?wx_fmt=png&from=appmsg)

从Hxxps://oss3333.oss-cn-shanghai.aliyuncs.com/DMR\_121.jpg中下载的数据解密后是dll文件，写入到释放路径下的CiscoSparkLauncher.dll文件中。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csO1e8nmzichrZdbg8ETg7m6lUUeWNiaBS8M3QRXsWSaGZu4vuhHNo7z4A/640?wx_fmt=png&from=appmsg)

可执行程序是具有有效签名的白文件，运行时加载恶意dll。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8cs7HEZ5KkfperneaJyFdwXIfxRhpepxa7J2ZrY1eLickudiahSsPwgibYMQ/640?wx_fmt=png&from=appmsg)

从Hxxps://oss3333.oss-cn-shanghai.aliyuncs.com/DMR\_122.jpg中下载的数据解密后是不具有mz标识的不完整pe文件，写入到释放路径下的ffff.pol文件中。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csibmkqX9yXiaRm0ukuZnN0VXhfPuajZfjhkU5UKpP8C8X3ZEGwHafIibtQ/640?wx_fmt=png&from=appmsg)

从Hxxps://oss3333.oss-cn-shanghai.aliyuncs.com/DMR\_123.jpg中下载的数据解密后写入到释放路径下的ffff.lop文件中。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csFsFkyImKeJpnEiacnGrhhaWDDJv6VxF1icqUrwfG8W6oTPsQSzuDD74w/640?wx_fmt=png&from=appmsg)

设置释放文件所在的路径为当前路径。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csb0JhR97uibCicD5dwIOWic65KY09In8oPXdkibfXCic90ktwibqaLpKlg0FA/640?wx_fmt=png&from=appmsg)

调用ShellExecuteEx执行释放的白文件。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csSdA2oDfb6CSIsuzJtfCN6DAA72NjuCCvpwhu0G6scfibVTKX1KZS8sQ/640?wx_fmt=jpeg&from=appmsg)

## CiscoSparkLauncher.dll

获取计算机名称，创建互斥体。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csQUpxVo4c7TIlg5lSPgvcjjHtoHV03jJLIdc1kwxKMm76tYPHcPxsOA/640?wx_fmt=png&from=appmsg)

解密出shellcode后执行。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csr16oRC7efVmGFiaTuZu4hQ3LUTCy7yfyylI2rRoZIhE2iaLQjaRWRfrw/640?wx_fmt=jpeg&from=appmsg)

利用LoadLibraryA和GetProcAddress动态获取其他函数。加载ffff.pol文件到内存中，修补mz头后跳转到入口点执行。

## ffff.pol

调用OpenMutexA、CreateMutexA函数确保进程唯一运行。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csMJcO9AljP7ZFf8NMyoZs0RrvO2Vxzia34icz1t1EE1YPiafgaBib3aEcuw/640?wx_fmt=png&from=appmsg)

创建线程，获取命令行参数作为线程函数的参数。

调用IsUserAnAdmin函数判断当前用户是否具有管理员权限。如果具有管理员权限则设置UAC不弹出任何提示框，以管理员权限自动运行程序。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8csSb2gNumerTL75w8I8hq4TUDzBRdjEeB8dK5jyu2hpuk6iaAwXicYEecw/640?wx_fmt=png&from=appmsg)

创建线程不断遍历进程，判断是否存在360tray.exe，360safe.exe，360sd.exe进程，并且请求目标窗口关闭自身。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HDnhgUJnILF1z0PTN4N8cs0QIEO5...