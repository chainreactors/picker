---
title: 好心群友给的外挂大礼包——记一次远控马分析
url: https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458571424&idx=2&sn=ac1b7a92e6b7a5d8d8c086f17a8ba98c&chksm=b18de22a86fa6b3cb64604bfca09dfc21023949b325aaf9c455824d42bd2234c401e9e0f6a97&scene=58&subscene=0#rd
source: 看雪学苑
date: 2024-09-02
fetch_date: 2025-10-06T18:25:54.783512
---

# 好心群友给的外挂大礼包——记一次远控马分析

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNUUkqHxxcMmfKpPjw32BecibPoKdtFia881nHfXyt1vYHUfs4GPpRQjAdw/0?wx_fmt=jpeg)

# 好心群友给的外挂大礼包——记一次远控马分析

0xA1pha

看雪学苑

最近玩MC的3c3u服务器，是一个类似2b2t的无政府服务器，加了官方群，一个好心大哥给我发了一个挂。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNU4bE4POgsHabYcRyvyR4hgGUrOj3xzMAQgmbQj9OJMP5yHbHGxyGT8Q/640?wx_fmt=png&from=appmsg)

如此好心，我当然要开心地收下。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNUzoLHV5dV0zSvqatDK7VVk5rVF1RgW5OfM3d2LBgDyz73U0hmgwXc4A/640?wx_fmt=png&from=appmsg)

UPX -d 脱掉。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNUhj9rjGDOxJ8GOicYjR5OD9DQPmS4xL1hBj2gv3AEKupSIfNZ3YsoYicg/640?wx_fmt=png&from=appmsg)

IDA32启动。

## 主程序

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNU6nPicvrJJ9qC30mTC1z5f8nxdbQOqdD3SnyogLFJQQncLlwwWiax2Fug/640?wx_fmt=png&from=appmsg)

WinMain就一个函数，跟进。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNUDPsvbE9bXzW4Vmf4F3xuDuubMhrVyBxziaGeibb5JM0sG6e018wHWBBQ/640?wx_fmt=png&from=appmsg)

逻辑如图，跟踪一下函数，函数名和变量名都是我恢复的。一开始以为是SMC，后来发现是反射加载dll。加载函数如下。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNUAZwhHYSTD5tia19cRRlNnybqPjKcaVTT1JCawlwqEjAwhecVVia5jSZA/640?wx_fmt=png&from=appmsg)

解密函数如下，一眼xxtea。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNU4iaDTyPAFGIOIEHtYXghbHZXvJ7l6GRDvAIg2jr2yjuwapO8UOclicyA/640?wx_fmt=png&from=appmsg)

至此程序逻辑已经较为清晰：反射加载dll，具体为从密文以标准xxtea算法解密数据，然后把数据地址传入加载dll函数，最后调用dll中的函数，函数名为前面传进来的StudyHard。

## dll

dump dll的过程可谓艰辛，由于打CTF打多了，最开始写了一个c脚本，结果发现0x15000个u\_int32似乎不好打印，后来又尝试保存到文本，效果也一般。（可能是IDA哪里分析出问题了）后来又尝试了下断点让他自己解密，因为他这个dll想执行最后肯定得以无加密方式执行，但是似乎有反调试，运行会卡住，跑不到解密的地方。（复盘时考虑可能是那些抛出异常的地方写了专门的处理，结合下图一堆函数猜测可能是自调反调试）

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNU7A2Qp3N9iabP6PvGa7qibZw6XNaQI37LGrt2RRF7N4ZqbGXlDU6Hrg6w/640?wx_fmt=png&from=appmsg)

最后采取的方案：虚拟机直接运行，转储运行文件。这个程序应该是写入计划任务了，重启发现虚拟机里面还有这个样本，那只能说是正合我意了。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNU48rIMSG59z51Rxj3EHQSL6RC2kIy73pkKiaOSsdLW84FOic0zXjXCR3g/640?wx_fmt=png&from=appmsg)

直接IDA分析这个内核转储文件。这里直接用windbg打开，显示：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNU9Qenw8jGfkGYcrvQJicy9DNyvF5XcyMa2XaBCAWszgdZ3ozGn9Um9dg/640?wx_fmt=png&from=appmsg)

吓了我一跳，还以为是天堂之门，后来群里大哥说是调用了64位dll就会这样，而且这样必须用IDA64分析了。

IDA64打开转储文件，直接按G jump到那个加密dll的地址。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNUW4Lsd6mYl5OYwBgDbialg4S4mHbeYZPlIAB73jcsm8VpfsX4Jz8s6mA/640?wx_fmt=png&from=appmsg)

MZ开头，舒服了。

dump下来，32位IDA打开。

### StartAddress

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNUv1vvRUgYpg7owvlC87dLQ11fRPicibo6kiblPhImZQqsib8PjqurDzPKTw/640?wx_fmt=png&from=appmsg)

获取路径，写注册表，写开机启动，持久化。

### DllMain

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNU3ia4fvwdsBuiaOD2yPwnnpgytrianibk0Ovibe7wpg4icAJ11JI9C1CnAhtw/640?wx_fmt=png&from=appmsg)

查找explorer.exe

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNUtpdhX5j7zKBs9UyLa6libMyBKiaUQSWeexD8W32TEO9e607oeTZaxUNg/640?wx_fmt=png&from=appmsg)

查找父进程

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNUbeSwuoibXr91AKojdBqnictLiaLIcCaREgoqRsu2dqRfRLdWdlAy98Yaw/640?wx_fmt=png&from=appmsg)

都没找到就退出。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNU9OvN4VdbgAxAJjtib88QAmib23C9I21nOM99jTxU4FdKiaUZyMcFuDY5A/640?wx_fmt=png&from=appmsg)

获取win版本。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNUnHDLic0L9144MIZiaBYVowSmJZE1Rxibib7b2tQoN3OyLltgJ9F022G1mg/640?wx_fmt=png&from=appmsg)

从URL下载文件，写入构造的地址（就是前面获取的）。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNUaL5yJpDdBPMqlNLtBpN3jMj9s8icWpNsSWxkTJehebiatmSQTaPq8UjQ/640?wx_fmt=png&from=appmsg)

查找rundll32.exe，找到就taskkill了。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNUjcIib4hibmEjNplUN70hct3pltTRKvd2uokS7Gr20ZNUAbZAmmNiaL9BA/640?wx_fmt=png&from=appmsg)

注册成服务。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNUBsicGyNpicwh3L7J5UIYuiatnQgibbps5wmp23m7K7hVEOeqDJHZicFV0hg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNUkIfDw6zJckHOw30qWNPbVO8AUZrDW7dVoRmkoMRAyB8ibzCyB1vtC3g/640?wx_fmt=png&from=appmsg)

等待服务器发送指令（域名不贴了，就是server\_domin），控完while(1) sleep。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNUPicibicgNrKFc8TS42ADzzjiamp8Id6XosGZeGr2SEHxN14icFtFVEKlURA/640?wx_fmt=png&from=appmsg)

根据系统版本写启动项，驻留。其中win10就用前面分析的StartAdress。

### StudyAdress

本来以为这才是正餐，分析了一下，大部分跟dllmain一样。

### 剩余部分有意思的函数

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNU3CiapfEBFTEkLBtgNtx8kTzxxVUyiajln9jibicicSvEO5Tic6KKw4LgqwTg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNUUKTEU0iavdzcE1kUdt0dGfj920dUup9qepWiajvMQTe8PQMQzXgU7qWA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNURk7LpTcIGsoOKthvqDzNfDFHMagUAhOIYkzHOVUUSo2XRQRsVDMYsg/640?wx_fmt=png&from=appmsg)

查找这161个杀软是否存在，看到这玩意我第一反应是真牛逼。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HSibhHxkF8YPasZG8clQicNUriaPID0f46Cnwmz9iciclicMJoHSLvjmOKv25NQ8Lmbxpl9IPWDL3QBqow/640?wx_fmt=png&from=appmsg)

scvh0st.exe，6.

至此已经拆的差不多了，控制方发送字符组成的指令序列，在被控机执行。

另外有意思的是作者把网站的80端口伪装成了一个没备案被拦截的页面，nmap扫了只有22 443 80开着，微步沙箱测到是在3xxxx上通信的，后面有空在研究了。

感谢这位群友送的大礼物。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Gs70JL6J7jibudAo46bgRrvqOjZ8cYoBgbqFtR10vzWgua0aXUNrwicB0wxwgIoVftoEKHmcty2Vwg/640?wx_fmt=png&from=appmsg)

**看雪ID：0xA1pha**

*https://bbs.kanxue.com/user-home-1004111.htm*

\*本文为看雪论坛优秀文章，由 0xA1pha 原创，转载请注明来自看雪社区

[![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GRSx16NymEZASvWUkD0o0xciaOHemlKTGuEic3iazgrRg1njFXg0Ey0Ap6bl8iafGbZD1hLJYZEZAj7w/640?wx_fmt=png&from=appmsg)](https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458565463&idx=1&sn=e03e9773326308fa63d18676470a6824&scene=21#wechat_redirect)

**# 往期推荐**

1、[Alt-Tab Terminator注册算法逆向](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458563181&idx=1&sn=1dd42dbb95362d9678431b94473ab1f4&chksm=b18d82e786fa0bf1681d92f0d13b064eeae9530e5b2e86f78fd7f4d2662bfaffe5e99993d08f&scene=21#wechat_redirect)

2、[恶意木马历险记](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458562562&idx=2&sn=1d66bb3141b820c717f86d349660e9ec&chksm=b18d808886fa099efc353521af0839c9bf5fbd4cae2985cf3a9a6ea28fa617f8300c0ab115a7&scene=21#wechat_redirect)

3、[VMP源码分析：反调试与绕过方法](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458562488&idx=2&sn=fe5bd1498948137775db5f454bd5a6a2&chksm=b18d9f3286fa162491072b9cd141784c1a60b2b00fd8203f865c51ef753e3f45573a78810949&scene=21#wechat_redirect)

4、[Chrome V8 issue 1486342浅析](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458562487&idx=2&sn=b2d6ad2776d37f416933e1439f244430&chksm=b18d9f3d86fa162b5edfd1c8e616c9ea5460cf21afc5d41cfd8122fbc73830c61f125c8a4960&scene=21#wechat_redirect)

5、[Cython逆向-语言特性分析](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458562186&idx=1&sn=bd95ad7951c93578ed5f0cbb1971332c&chksm=b18d9e0086fa1716382e78c54135a0a296fa215688b9a741576d41897729625284287e598faf&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_jpg/Uia4617poZXP96fGaMPXib13V1bJ52yHq9ycD9Zv3WhiaRb2rKV6wghrNa4VyFR2wibBVNfZt3M5IuUiauQGHvxhQrA/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8GDgjicLBjGjBq63Hnp7DmRNT86hyuq6QGl2Zh7b0IwRicAPgb3r1abUEe46MhrwYD1GqcX76t31fKA/640?wx_fmt=gif&from=appmsg)

**球分享**

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8GDgjicLBjGjBq63Hnp7DmRNT86hyuq6QGl2Zh7b0IwRicAPgb3r1abUEe46MhrwYD1GqcX76t31fKA/640?wx_fmt=gif&from=appmsg)

**球点赞**

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8GDgjicLBjGjBq63Hnp7DmRNT86hyuq6QGl2Zh7b0IwRicAPgb3r1abUEe46MhrwYD1GqcX76t31fKA/640?wx_fmt=gif&from=appmsg)

...