---
title: Behind the Scenes: Understanding CVE-2022-24547
url: https://starlabs.sg/blog/2024/12-behind-the-scenes-understanding-cve-2022-24547/
source: Blogs on STAR Labs
date: 2024-12-25
fetch_date: 2025-10-06T19:36:15.036966
---

# Behind the Scenes: Understanding CVE-2022-24547

[![logo](https://starlabs.sg/logo-white.png)](https://starlabs.sg/ "  (Alt + H)")

* [Home](https://starlabs.sg/ "Home")
* [About](https://starlabs.sg/about/ "About")
* [Advisories](https://starlabs.sg/advisories/ "Advisories")
* [Blog](https://starlabs.sg/blog/ "Blog")
* [Achievements](https://starlabs.sg/achievements/ "Achievements")
* [Publications](https://starlabs.sg/publications/ "Publications")
* [Search](https://starlabs.sg/search/ "Search (Alt + /)")

[Home](https://starlabs.sg/) » [Blogs](https://starlabs.sg/blog/)

# Behind the Scenes: Understanding CVE-2022-24547

December 24, 2024 · 5 min · Đào Tuấn Linh

Table of Contents

* [TL;dr](#tldr)
  + [Summary](#summary)
  + [CVSS3.1 Scoring System:](#cvss31-scoring-system)
  + [Affected Software](#affected-software)
  + [Description of Vulnerability](#description-of-vulnerability)
  + [Exploitation](#exploitation)
  + [Exploit Reproduction (Optional)](#exploit-reproduction-optional)
  + [Exploit Conditions](#exploit-conditions)
  + [Detection Guidance](#detection-guidance)
  + [Suggested Mitigations](#suggested-mitigations)
  + [Acknowledgements](#acknowledgements)
  + [Conclusion](#conclusion)

# TL;dr[#](#tldr)

Vulnerabilities can often be found in places we don’t expect, and `CVE-2022-24547` in `CastSrv.exe` is one of the examples. CVE-2022-24547 is a privilege escalation vulnerability in CastSrv.exe, allowing attackers to bypass security and gain elevated privileges. We’ll break down how the bug works, its exploitation, and how to protect against it.

## Summary[#](#summary)

|  |  |
| --- | --- |
| **Vendor** | Microsoft |
| **Security Impact** | Elevation of Privilege |
| **CVE ID** | [CVE-2022-24547](https://msrc.microsoft.com/update-guide/en-US/advisory/CVE-2022-24547) |

## CVSS3.1 Scoring System:[#](#cvss31-scoring-system)

**Base Score:** 7.8
**Vector String:** `CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H`

|  |  |
| --- | --- |
| **Attack Vector (AV)** | Local |
| **Attack Complexity (AC)** | Low |
| **Privileges Required (PR)** | Low |
| **User Interaction (UI)** | None |
| **Scope (S)** | Unchanged |
| **Confidentiality (C)** | High |
| **Integrity (I)** | High |
| **Availability (A)** | High |

## Affected Software[#](#affected-software)

Product:

* Microsoft Windows 10.0.18363.592 64-bits (2020-01-14)

ISO Download:

* <https://uupdump.net/selectlang.php?id=99c9fe2f-8e78-451f-ab95-410106ee59bf>

Version:

* Windows 10 10.0.18363.592 64-bits (2020-01-14)

## Description of Vulnerability[#](#description-of-vulnerability)

The vulnerability exists in the `IcastServerControl::GetEnableControl` function of the `CastSrv.exe` program, allowing attackers to create arbitrary folders within another user’s account on the system.

Key factors contributing to this bug:

1. **Session Hijacking**: Attackers can run `CastSrv.exe` under the context of another logged-in user by initializing the program with that user’s session.
2. **Unchecked Folder Creation**: The `IcastServerControl::GetEnableControl` function creates the `\AppData\Local\__Shared\PlayToReceiver` directory without verifying if it’s a symbolic link.
3. **Improper Permissions**: The created directory has full DACL permissions, allowing any user to access and modify it (see [DACL Access Control](https://learn.microsoft.com/en-us/windows/win32/secauthz/dacls-and-aces/)).
   Thus, the vulnerability allows an attacker to run `CastSrv.exe` under another user’s session and use the `IcastServerControl::GetEnableControl` function to create arbitrary folders in that user’s directory.

This interface is registered under:

```
clsid: f8842f8e-dafe-4b37-9d38-4e0714a61149

uuid: 7733f245-f909-4be2-918f-bddecbcd07cc

clsid name: CastServerInteractiveUser

interfaces name: ICastServerControl

Vulnerable method name: ICastServerControl::GetEnableControl
```

![](/blog/2024/images/CVE-2022-24547_01.png)

The registered interface (`ICastServerControl`) can be activated within any interactive user session on the machine through the utilization of a “session moniker.” This capability presents a potential vector for cross-session privilege escalation, as both the interfaces and their associated methods may be exploited. For further details, please refer to the following link: [COM Cross-Session Activation](https://blog.compass-security.com/2024/10/com-cross-session-activation/).

The underlying call of functions in `IcastServerControl::GetEnableControl` that create `\\PlayToReceiver` with full DACL permission, and drop image files are simplified in below Control Flow Graph. I will describe more details on this later in Exploitation.

![](/blog/2024/images/CVE-2022-24547_02.png)

## Exploitation[#](#exploitation)

**Step 1**: We need to initialize `CastSrv.exe` with the target user’s session ID.

![](/blog/2024/images/CVE-2022-24547_03.png)

In the image above, the string `session:2!new:f8842f8e-dafe-4b37-9d38-4e0714a61149` indicates that the number `2` represents the target user’s session ID, while `f8842f8e-dafe-4b37-9d38-4e0714a61149` is the GUID for the `CastSrv.exe` service. You will need to replace `2` with the session ID of the targeted user.

**Step 2**: We need to trigger the `CCastServerControl::GetEnableControl` function in the `ICastServerControl` interface.

![](/blog/2024/images/CVE-2022-24547_04.png)

In the above picture, you could see the vtable of `ICastServerControl` interface

```
CCastServerControl::StartCastServer(void)
CCastServerControl::StopCastServer(void)
CCastServerControl::Advise(ICastAppLaunchCallback *)
CCastServerControl::Unadvise(ICastAppLaunchCallback *)
CCastServerControl::GetEnableControl(int *)
CCastServerControl::SetEnableControl(int)
CCastServerControl::PutSettings(IUnknown *)
```

One method from the `ICastServerControl` interface, `CCastServerControl::GetEnableControl`, when called, will create a folder under `\AppData\Local\__SHARED\PlayToReceiver`.

![](/blog/2024/images/CVE-2022-24547_05.png)

When invoked, `CCastServerControl::GetEnableControl` initiates a call to `CServerHolder::GetDMRServer` and subsequently to `IPlayToReceiverAppRegistrar+72`, which corresponds to `CPlayToReceiverAppRegistrar::GetEnableControl` via its virtual table in `DMRServer.dll`.

![](/blog/2024/images/CVE-2022-24547_06.png)

![](/blog/2024/images/CVE-2022-24547_07.png)

Within `DMRServer.dll`, these calls trigger the initialization of the `CSharedDMR` and `CPlayToReceiverInternal` classes. The initialization of the `CSharedDMR` class results in the creation of several image files, which will be discussed in further detail later. Meanwhile, the `CPlayToReceiverInternal::RuntimeClassInitialize` method creates the `PlayToReceiver` folder within the `%AppData%` directory. Notably, this process does not include a check for symbolic links.

![](/blog/2024/images/CVE-2022-24547_08.png)

Since we know that the UUID of `ICastServerControl` is `7733f245-f909-4be2-918f-bddecbcd07cc`, we can recreate it as follows.

```
// 7733f245-f909-4be2-918f-bddecbcd07cc is UUID of ICastServerControl
class __declspec(uuid("7733f245-f909-4be2-918f-bddecbcd07cc")) ICastServerControl : public IUnknown {
public:
    virtual HRESULT __stdcall StartCastServer(void);
    virtual HRESULT __stdcall StopCastServer(void);
    virtual HRESULT __stdcall Advise(void* p0);
    virtual HRESULT __stdcall Unadvise(void* p0);
    virtual HRESULT __stdcall GetEnableControl(int64_t* p0);
    virtual HRESULT __stdcall SetEnableControl(int64_t p0);
    virtual HRESULT __stdcall PutSettings(IUnknown* p0);
};
```

Since we are already running `CastSrv.exe` for the `user02` session `2` from Step 1, we will now call `BindToObject` to obtain a pointer to the `ICastServerControl` interface and then trigger the `ICastServerControl->GetEnableControl` method from there.

![](/blog/2024/images/CVE-2022-24547_09.png)

Note that this is the first time we are calling the `ICastServerControl->GetEnableControl` method. However, since `CastSrv.exe` is now running under another user conte...