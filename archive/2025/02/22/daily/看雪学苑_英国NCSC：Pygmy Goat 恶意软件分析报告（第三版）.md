---
title: 英国NCSC：Pygmy Goat 恶意软件分析报告（第三版）
url: https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458589903&idx=1&sn=6ed95c159aa5817b2099b7ddaa036743&chksm=b18c2a4586fba353874759d56bd9ff700d21817fa3efb4332596c8f6656efb76e9ccec6205ab&scene=58&subscene=0#rd
source: 看雪学苑
date: 2025-02-22
fetch_date: 2025-10-06T20:37:24.066752
---

# 英国NCSC：Pygmy Goat 恶意软件分析报告（第三版）

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EWD0MdncKREanmoUwqiaOW0mCnicl8CyxdvibN277UOjV13esP3zuXlpEqvwDKP28oJuibHC7LhGA3Qg/0?wx_fmt=jpeg)

# 英国NCSC：Pygmy Goat 恶意软件分析报告（第三版）

梦幻的彼岸【译】

看雪学苑

```
一

执行摘要
```

◆使用LD\_PRELOAD加载到/bin/sshd并拦截其accept函数。

◆在原始Socket上监听传入的ICMP数据包以触发回连，或者使用拦截的accept函数在SSH连接中搜索特定序列的魔法字节。

◆功能包括远程shell、数据包捕获、cron任务以及创建反向SOCKS代理服务器。

```
二

摘要
```

Pygmy Goat是一个本地的x86-32 ELF共享对象，被发现在Sophos XG防火墙设备上，提供了对该设备的后门访问权限。它利用 LD\_PRELOAD 环境变量将共享对象加载到 sshd（SSH 守护进程）二进制文件中。

◆样本创建了一个原始 ICMP Socket来监控传入的数据包，这些数据包包含 AES 加密的 TCP 回调 IP 和端口，用于样本连接以实现 C2（命令与控制）功能。

◆样本利用其 LD\_PRELOAD 位置拦截 socket 的 accept 函数，以窥探传入流量寻找特定的 SSH 协议声明，然后重用该连接作为另一种 C2 的方式。

◆样本使用一个硬编码的嵌入式CA证书伪装成Fortinet，以与C2建立TLS连接并验证对方身份

◆C2命令使攻击者能够在设备上建立远程shell，启动数据包捕获，创建cron任务，并创建反向SOCKS代理以将流量发送到防火墙后的设备。

```
三

恶意软件详细信息
```

#

## （一）元数据

|  |  |
| --- | --- |
| 文件名 | libsophos.so |
| 描述 | 加载到 /bin/sshd 的恶意共享对象 |
| 大小 | 1,759,412 bytes |
| MD5 | c71cd27efcdb8c44ab8c29d51f033a22 |
| SHA-1 | 71f70d61af00542b2e9ad64abd2dda7e437536ff |
| SHA-256 | 6455de74ae15071fa98f18cdbc3148c967755e69df7dee747bc31d0387751162 |
|  | |
| 文件名 | libsophos.so |
| 描述 | 较早版本的 libsophos.so 缺失了反向代理功能，并使用 VMProtect 来混淆二进制文件。 |
| 大小 | 3,056,741 bytes |
| MD5 | 3f28196675dc8cb20cf5b5f80ea29310 |
| SHA-1 | 7ace663c22b3e800fc17c1477d54b533f7002833 |
| SHA-256 | 823b079c75f4e6a5905d9eea9a60c62e1f0995bfc25764d1ba0407a5bd78c962 |

```
四

功能介绍
```

## （一）持久性

Pygmy Goat预计是通过使用LD\_PRELOAD环境变量加载到/bin/sshd进程中的，这从钩住的accept函数以及二进制文件加载时立即取消设置LD\_PRELOAD环境变量的情况可以明显看出。这表明攻击者通过在启动时设置LD\_PRELOAD环境变量，例如，通过修改启动脚本，来实现在受害设备上的持久化存在。其脚本内容类似于如下代码：

```
LD_PRELOAD=”libsophos.so” /bin/sshd
```

这将确保恶意的libsophos.so文件在系统启动时被加载到下一个执行的SSH守护进程中，使其能够覆盖sshd二进制文件中的现有函数。

## （二）后门

Pygmy Goat的libsophos.so二进制文件在其INIT\_ARRAY段中包含一个指向名为main\_constructor函数的引用（此名称来源于保留在二进制文件内的调试符号）。这意味着在sshd二进制文件的主要功能启动之前，这个main\_constructor函数将会被自动执行。

main\_constructor函数会进行fork操作，以避免妨碍合法sshd进程的加载，然后立即为自己和所有未来的子进程取消设置LD\_PRELOAD环境变量。尽管如此，值得注意的是，原始的父sshd进程在此时仍然会在其环境中保留LD\_PRELOAD变量。

恶意软件会检查主机系统的运行时间，确保系统已经运行超过60秒，若未达到则进入休眠。然后，它尝试在‘/var/run/sshd.pid’处获取一个单实例pid文件的互斥锁，以确保当前只有这一个恶意软件实例在执行。接着，恶意软件再次fork，通过静态编译嵌入的BusyBox 1.33.1启动一个crond守护进程，以便稍后执行攻击者可以通过恶意软件部署到设备上的cron任务。    最后，恶意软件创建了一个ICMP 原始socket，用于监听设备接收到的所有ICMP数据包，并且还创建了一个Unix socket，用于监听连接到‘/tmp/.sshd.ipc’的请求。

由于Pygmy Goat通过LD\_PRELOAD加载到sshd进程中，libsophos.so共享对象中导出的函数会替代sshd（/bin/sshd）原本导入的同名函数。具体来说，当检查libsophos.so和sshd之间的函数交互时，发现只有一个函数被替换：accept函数。这意味着所有到达sshd守护进程的TCP连接都会经过这个修改过的accept函数处理。

当这个修改后的accept函数被调用时，它使用dlsym来找到并调用原始的accept函数。然后，该函数会对前0x17字节的数据进行非消耗性、非阻塞的预览，并每100毫秒重复这一过程，持续3秒钟，直到成功读取到0x17字节的数据、连接中断或时间到期。如果成功读取了0x17字节的数据，它们将与一个硬编码的字节序列进行比较：

```
SSH-2.0-OpenSSH_5.3p1\r\n
备注：尽管这是一个合法的 OpenSSH 协议版本（发布于2009年），但恶意软件开发者可能认为在2024年自然出现这种情况的可能性极低。
```

如果检测到这些字节，恶意软件会识别出这是一个后门SSH连接，并通过与先前在main\_constructor函数中创建的/tmp/.sshd.ipc Unix socket进行通信，来转发所有来自和去往后门SSH连接的数据。此外，拦截的accept函数在被调用时，也会立即取消设置LD\_PRELOAD变量    由于accept函数是在父sshd进程中被调用的，而此时该进程仍然设置了LD\_PRELOAD变量，这使得该技术在设备的常规取证检查中不易被发现。环境变量仅在sshd进程中设置，并且会在sshd首次接受TCP连接时取消设置。然而，如果攻击者在系统首次启动后没有尝试连接到Pygmy Goat的受害者，或者攻击者使用了ICMP唤醒方法，则LD\_PRELOAD变量将永远不会在父sshd进程中被取消设置。

### （三）指令

Pygmy Goat 是一种复杂的恶意软件，它通过与 C2 服务器通信来接收指令并执行特定的操作。这种通信是基于命令 ID 字节的，这意味着每个命令都由一个唯一的标识符表示，C2 服务器发送这个标识符给受感染设备上的 Pygmy Goat 恶意软件，后者据此执行相应的操作。    一旦与C2（命令与控制服务器）建立连接，Pygmy Goat可以根据命令ID字节执行多个命令。每个命令在C2任务分配部分中有详细说明
补充C2 命令结构示例。

命令 ID 字节：这是每个命令的核心标识，通常是一个字节或几个字节，用来告诉恶意软件接下来要做什么。这可以看作是双方协议的一部分，确保只有预期的命令被识别和处理。

参数：某些命令可能还需要额外的数据作为参数传递，例如 IP 地址、端口号、文件路径等。这些参数紧跟在命令 ID 后面，用于指导具体的操作细节。

|  |  |
| --- | --- |
| 命令ID | 功能描述 |
| 0x01 | 返回当前日期和时间 补充功能用途：当 C2 服务器发送此命令时，恶意软件将响应并返回设备上的当前日期和时间。这可以帮助攻击者确认受感染设备的时间设置，或者用于同步操作。 |
| 0x02 | 返回系统详情 补充功能用途：该命令使得恶意软件返回有关受感染系统的详细信息，可能包括操作系统版本、网络配置、已安装软件等。这些信息有助于攻击者了解目标环境并规划后续行动。 |
| 0x03 | 启动 /bin/sh shell 补充功能用途：此命令指示恶意软件在受感染设备上启动一个交互式的 Bourne shell (/bin/sh)。攻击者可以通过这个 shell 执行任意系统命令，从而获得对系统的完全控制。 |
| 0x04 | 启动 /bin/csh shell 补充功能用途：类似于命令 ID 0x03，但这次是启动 C shell (/bin/csh)。不同的 shell 提供了不同的环境和特性，攻击者可能会根据需求选择合适的 shell。 |
| 0x05 | 创建新的计划任务 补充功能用途：通过调用 crontab，此命令允许攻击者为受感染设备添加新的定时任务。这些任务可以是定期下载更新、执行脚本或进行其他类型的恶意活动。 |
| 0x06 | 开始数据包捕获 补充功能用途：启用网络嗅探器来记录流经受感染设备的所有或特定类型的网络流量。这对于窃取敏感信息或监视网络活动非常有用。 |
| 0x07 | 连接到 EarthWorm Server 创建反向 SOCKS5 代理 补充功能用途：此命令指示恶意软件连接回一个被称为“EarthWorm”的服务器，并建立一个反向 SOCKS5 代理。这允许攻击者通过受感染设备作为中介访问内部网络资源，甚至穿透防火墙。有关 EarthWorm 的更多信息，请参阅“EarthWorm 反向 Socks 代理。 |

```
五

通信机制
```

Pygmy Goat具有两种机制，攻击者可以根据需要使用这些机制来建立与后门的C2（命令与控制服务器）连接：

◆ICMP 原始Socket端口敲击

◆拦截 SSH accept 的响应

## （一）ICMP 端口敲击

在接收到任何类型的ICMP数据包时，Pygmy Goat会尝试使用AES-256-CBC算法和一个硬编码的初始化向量（IV）及密钥，对ICMP数据部分的前0x10字节进行解密，使用空填充（null padding）方式：

```
IV：43 4a fc 1c 5d 9d 77 06 67 c1 c3 0e c1 37 47 bb
Key：59 4b 6e 77 51 6a 6d 41 54 62 41 6e 52 6f 5a 6d 30 66 47 37 55 5a 57 62 32 59 55 78 55 51 50 77
```

一旦解密完成，前四个字节会被与一个特定的魔数序列进行比较，以确保数据实际上是一个C2控制数据包而非正常的ICMP数据包：

```
魔幻字节序列：ef 12 68 45
```

接下来的四个字节被视为一个大端格式的IPv4地址，随后的两个字节为大端格式的TCP端口号，数据包中的其余部分则被忽略。备注：本报告中的所有示例数据都是使用Pygmy Goat样本在虚拟环境中生成的，因此这些数据仅用于说明目的，并非从任何受害者或攻击者的数据中获取。

|  |  |  |
| --- | --- | --- |
| **加密 ICMP 数据包** | | |
| **00****00****cc a2****5a 9d****00 01****d7 00 9e 6c 17 c0 82 6b 95 f0 fa 5b 5b 4e dd 8a** | | |
| Echo (ping) reply | ICMP 编码 | ICMP 校验和 |
| ICMP 标识符 | 序列号 | 加密数据 |

|  |  |  |
| --- | --- | --- |
| **解密数据包数据** | | |
| **ef 12 68 45****c0 a8 06 01****1e 61****00 00 00 00 00 00** | | |
| 魔法验证字节 | IPv4 地址192.168.6.1 | TCP 端口7777 |
| AES 填充 | | |

一旦提取出C2的IPv4地址和TCP端口，Pygmy Goat会与服务器建立TLS连接，并使用嵌入在libsophos.so二进制文件中的根CA证书验证服务器提供的证书（参见TLS根CA证书）。这一点值得注意，因为这意味着攻击者可以从不同的设备发送ICMP数据包到C2回连服务器。

备注：Root CA 证书声称是由另一家网络设备供应商 FortiGate, Fortinet Ltd. 签发的。

## （二）拦截SSH Accept

一旦拦截的 accept 函数识别出 SSH 版本魔幻字节并将连接通过 Unix Socket /tmp/.sshd.ipc 传递后，Pygmy Goat 继续使用硬编码的数据执行假的 SSH 握手，读取固定数量的响应字节，但忽略其内容。

|  |  |  |
| --- | --- | --- |
| **伪造 SSH 握手 (C2 -> Malware)** | | |
| **0x0000**  **0x0010** | **53 53 48 2d 32 2e 30 2d 4f 70 65 6e 53 53 48 5f**  **35 2e 33 70 31 0d 0a** | **SSH-2.0-OpenSSH\_ 5.3p1..** |
| SSH 版本交换（在初次接受后窥视） | | |

|  |  |  |
| --- | --- | --- |
| **伪造 SSH 握手 (Malware -> C2)** | |  |
| **0x0000** | **53 53 48 2d 32 2e 30 2d 44 38 70 6a 45 0d 0a** | **SSH-2.0-D8pjE..** |
| SSH 版本替换 | | |

|  |  |  |
| --- | --- | --- |
| **伪造 SSH 握手 (Malware -> C2)** | | |
| **0x0000**  **0x0010**  **0x0020**  **0x0030**  **0x0040**  **0x0050**  **0x0060**  **0x0070**  **0x0080**  **0x0090**  **0x00a0**  **0x00b0**  **0x00c0**  **0x00d0**  **0x00e0**  **0x00f0**  **0x0100**  **0x0110**  **0x0120**  **0x0130**  **0x0140**  **0x0150**  **0x0160**  **0x0170**  **0x0180**  **0x0190**  **0x01a0**  **0x01b0**    **0x01c0**  **0x01d0**  **0x01e0**  **0x01f0**  **0x0200**  **0x0210**  **0x0220**  **0x0230**  **0x0240**  **0x0250**  **0x0260**  **0x0270**  **0x0280**  **0x0290**  **0x02a0**  **0x02b0**  **0x02c0**  **0x02d0**  **0x02e0**  **0x02f0**  **0x0300**  **0x0310**  **0x0320**  **0x0330**  **0x0340**  **0x0350**  **0x0360**  **0x0370**  **0x0380**  **0x0390**  **0x03a0**  **0x03b0**  **0x03c0**  **0x03d0**  **0x03e0**  **0x03f0**  **0x0400**  **0x0410**  **0x0420**  **0x0430**  **0x0440**  **0x0450**  **0x0460**  **0x0470**  **0x0480**  **0x0490**  **0x04a0**  **0x04b0**  **0x04c0**  **0x04d0**  **0x04e0**  **0x04f0**  **0x0500**    **0x0510**  **0x0520**  **0x0530**  **0x0540** | **00 00 05 4c 0a 14 fd 8d cf 7b 16 6d de 60 6f f4**  **1c 19 89 c1 93 ee 00 00 00 80 63 75 72 76 65 32**  **35 35 31 39 2d 73 68 61 32 35 36 40 6c 69 62 73**  **73 68 2e 6f 72 67 2c 64 69 66 66 69 65 2d 68 65**  **6c 6c 6d 61 6e 2d 67 72 6f 75 70 2d 65 78 63 68**  **61 6e 67 65 2d 73 68 61 32 35 36 2c 64 69 66 66**  **69 65 2d 68 65 6c 6c 6d 61 6e 2d 67 72 6f 75 70**  **2d 65 78 63 68 61 6e 67 65 2d 73 68 61 31 2c 64**  **69 66 66 69 65 2d 68 65 6c 6c 6d 61 6e 2d 67 72**  **6f 75 70 31 34 2d 73 68 61 31 00 00 00 13 73 73**  **68 2d 72 73 61 2c 73 73 68 2d 65 64 32 35 35 31**  **39 00 00 00 bb 63 68 61 63 68 61 32 30 2d 70 6f**  **6c 79 31 33 30 35 40 6f 70 65 6e 73 73 68 2e 63**  **6f 6d 2c 61 65 73 31 32 38 2d 63 74 72 2c 61 65**  **73 31 39 32 2d 63 74 72 2c 61 65 ...