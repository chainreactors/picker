---
title: 某黑产最新免杀攻击样本详细分析
url: https://mp.weixin.qq.com/s?__biz=MzA4ODEyODA3MQ==&mid=2247488674&idx=1&sn=e27df173edcb389bf5bc4d22bf4a4b51&chksm=902fbb8aa758329c6f652730d925651a8a185392bb0f77512ab18cc824cb2aa1031c379c1a18&scene=58&subscene=0#rd
source: 安全分析与研究
date: 2024-08-06
fetch_date: 2025-10-06T18:04:56.988291
---

# 某黑产最新免杀攻击样本详细分析

![cover_image](http://mmbiz.qpic.cn/mmbiz_jpg/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJU1qpxcllx2ZHd1E5Rdeygs14aP4lR7CphEZzlX5icE1IyANib36ibpEGlQ/0?wx_fmt=jpeg)

# 某黑产最新免杀攻击样本详细分析

原创

pandazhengzheng

安全分析与研究

**安全分析与研究**

专注于全球恶意软件的分析与研究

前言概述

原文首发出处：

https://xz.aliyun.com/t/15182

先知社区 作者：熊猫正正

近日有朋友通过微信发我一个样本，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUeOLyXBAGwDfjibEXl9iaoDp6vcwV6VLbmlicGMmAByCgcOjw0UApFo15w/640?wx_fmt=png)

在VT上查了一下样本，发现竟然只有一个报毒的，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUQzqC6PD8NyBjPsCq4CmTsdk4x6SbcexOjKxMxmVRXaibc3ARQYDkibUA/640?wx_fmt=png)

样本第一次上传的日期是2024年7月12日，到现在为止也还只有一家报毒，笔者针对这个最新的免杀样本进行了详细分析，分享出来供大家参考学习。

详细分析

1.样本解压之后，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUOqTqtwMuFmOMYMyg89UicIgmAxWCJ5PD8xg5OYia0L7GjceRLyV5LRrw/640?wx_fmt=png)

2.采用白+黑的方式加载恶意DLL，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUOeehC9p7bmpIw6zNMm0zZibHqATNGtxgFb5hJMEkQknzo8fFqSnicNew/640?wx_fmt=png)

3.恶意DLL在VT上的识别率非常低，通过分析它的导出函数，基本都使用MessageBoxA进行重构，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUbC7Q3AFrheX507LvTaFmfh16tP1WBjx7eko7f8qvJ1BIUJmDAngMiaA/640?wx_fmt=png)

4.然后发现有一个函数没有使用MessageBoxA，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUFqwkJMaxQYA1brWaamiaEHAgGgW8Xw3YrvYMdg88CDHveLPkBG1pHGA/640?wx_fmt=png)

5.对比这个函数与原文件函数，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUTAOVgJhua6sdRA3ILuibKQ2yicAxbme5tdPyKIkqv9YNWiaKmogyj6T8Q/640?wx_fmt=png)

6.进入这个函数，发现会读取内目录下的TXT加密数据，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUPwVR6AsdayGA3KISWuAPr4UQGZicj4Wnvibiar13JVPzlGZq96JFCuZibQ/640?wx_fmt=png)

7.然后通过函数解密加密的数据，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUuRJ3c1KzwXia6Vhm5jgPsoGQeLibHhx22OCxg8K4ZX2vnMS6keXlFsmA/640?wx_fmt=png)

8.读取TXT文件加密数据到内存当中，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJURJbEZH74T9PCSakicECyQuBOpwXPIMXCtN62uIn4iceBb6tazzuoq96A/640?wx_fmt=png)

9.解密加密的数据，解密之后，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUdyNzDTibibWeJA2QU7YZBFukJwKH1PcYcic0YhLPibMRPdpP6FfKUw9I3g/640?wx_fmt=png)

10.解压缩上面解密后的数据，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUribHjWnciabYoA0smngNgeDyzbRdTkCMaalIWd8GEao0pqZChlx8ibJPQ/640?wx_fmt=png)

11.解压缩之后，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUSQE5yWCysfm69a0LncKOdp9D51xwSRjmY4ZlpFXWlG0KBJwlJ9CibJw/640?wx_fmt=png)

12.解压缩后的PayLoad使用UPX加壳，编译时间为2024年6月5日，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJU0NquUG7aibE0KdEJz90Q4ia30fWv5riajCrBMRwuianXWia0ia6Vibic0Gm15A/640?wx_fmt=png)

13.使用upx解壳，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUIiak07q11Y9OlDumuzflF6D7ibyuF0nIpZtsau8QRuEv1Q4iacjNdgiaQg/640?wx_fmt=png)

14.将解密解压缩出来的PayLoad拷贝加载到分配的内存空间，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUkXXnbK0nHSzqUmahesbmNxnsIbtwrDhGfibpsJ4GhrHlw6Evcuolajw/640?wx_fmt=png)

15.抺掉PE文件标识，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUClPKts2zia17D4PBukfUBQbcwZGyjHWtJSjv90JMMzSs83S3sIn1H6Q/640?wx_fmt=png)

16.抺掉PayLoad的PE文件标识之后，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUZkVOhwtJuQVj0gI8G6g0ygPGiaunot2YibLUY3ltySa7tftJRS9vUNVg/640?wx_fmt=png)

17.跳转执行到PayLoad的入口代码处，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUlYAzWq1GadK8ao87ak9a24icDCT8PXYcYR9bLyfRoUVBDjecoc9uJQQ/640?wx_fmt=png)

18.执行解壳代码，最后跳转到脱壳后的代码入口点，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUiaFkbbIbrXFWWia8RhtZd5O9OzPxFFqzMibgPIoBCAiaqt3E94xCDYunAg/640?wx_fmt=png)

19.创建互斥变量，使用IsDebuggerPresent反调试，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUe7x7xiaruKiagxVgkuy9iapX8M2MTWUaUaEWWM00Hht0yqNYMmtjPTgXA/640?wx_fmt=png)

20.获取系统信息和内存状态等信息反虚拟机，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUibNvFTZlK9KeChAia7spLHJMwsB4jR9oJ5elZRciaxkFdP82tiaVIkIfibw/640?wx_fmt=png)

21.指定进程的优先级，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUBKsfhCibUU2A9cA391KABjWUibLQr3TJeKwSia048kyqtthOyzicUMcugQ/640?wx_fmt=png)

22.解密远程服务器C2配置信息，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUDrRgB0L7budDCyp5HUJXAZUE0KltsicR3mVLYXRhLPGlYlAdgKdtupA/640?wx_fmt=png)

23.解密函数，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUMmLsc9OvMIgIl6VEQsgPrc7hZT6ymP8uhHDFic0gYxKtOxyWla4iathg/640?wx_fmt=png)

24.解密出来的远程服务器C2配置信息，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUgM1v0QIicDqfcH5lTJZzMktbibCwicrmbPp5psFLNaia9QC7XMvtcazcuw/640?wx_fmt=png)

25.判断是否为管理员权限，如果是管理员权限，则执行相关的操作等，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUYsvjQIlyMEhDX1tzN3IH3yWvPaNyVtYicJHwRIVtJjZo2vsziaU6uRJA/640?wx_fmt=png)

26.查询相关的注册表键值，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUtbZibeUzA2AWia1OY3JR5G1qWqZFFsaOsYJU83koTtwfXUCDmAtAT53A/640?wx_fmt=png)

27.如果注册表键值存在，则启动相应的服务，服务名为Windows Eventn，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUjGceCyicDLVkMQlHQz2LJQroG0kxjKP1IPFwYhErEWDicSaaECLIEViaw/640?wx_fmt=png)

28.创建指定的文件目录，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUgnvDCwgCRIsOv5aRmL4sUIP7UbmmVFqTibC9F0NiaDralCQFkiciaiacYPQ/640?wx_fmt=png)

29.将文件夹设置为隐藏属性，然后将文件拷贝到生成的文件目录下面，并创建相应的服务自启动项，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJU5Z3uAMCPicT3IbzQhQUs2fmmDpJB7yVDiaeS68vL6kfP8glNIxEukg2w/640?wx_fmt=png)

30.拷贝完成之后，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUIvDLhLkZlCYsTyhMibNrt1rBh7WnD3ADOLSEOdJfxLlf2MwPZFPnhTw/640?wx_fmt=png)

31.创建的服务自启动项，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUmjLUovbLvEfHf7FpicUR1sCiaKmqR6cS3aq2zwvb1OicnKsfsscwvLSdw/640?wx_fmt=png)

32.与远程服务器通信，通过不同的指令执行不同的操作，其中包含文件进程管理，上载下载等功能，还有一些扩展模块的功能，如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUNJuzergRau15Fb8lWgRk1GpYhZb9T58Ds02wN5BRryvLUrfOpZXHoQ/640?wx_fmt=png)

该部分功能代码与此前变种功能代码基本一致，就不一一列举了。

威胁情报

![](https://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmXlCy4D7T1T8251ey9hZxJUNbLbuYL3e4750QZHbibZyXpicqr5A0x40faGEUUcPFBNKicZhRbicAoNaQ/640?wx_fmt=png)

总结结尾

去年使用“银狐”黑客工具的多个黑产团伙非常活跃，今年这些黑产团伙仍然非常活跃，而且仍然在不断的更新自己的攻击样本，采用各种免杀方式，逃避安全厂商的检测，免杀对抗手法一直在升级。

预览时标签不可点

阅读原文

![]()

微信扫一扫
关注该公众号

继续滑动看下一个

轻触阅读原文

![](http://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVcFgYKtoVnKR7h3pkl3AyxwS0l7iagicAJnYjEQhwIuZgR3RR65DLpJh2TGZS82DY7CjsBUmiaAl7BQ/0?wx_fmt=png)

安全分析与研究

向上滑动看下一个

知道了

![]()
微信扫一扫
使用小程序

取消
允许

取消
允许

取消
允许

×
分析

![跳转二维码]()

![作者头像](http://mmbiz.qpic.cn/mmbiz_png/oibWJqH5OVmVcFgYKtoVnKR7h3pkl3AyxwS0l7iagicAJnYjEQhwIuZgR3RR65DLpJh2TGZS82DY7CjsBUmiaAl7BQ/0?wx_fmt=png)

微信扫一扫可打开此内容，
使用完整服务

：
，
，
，
，
，
，
，
，
，
，
，
，
。

视频
小程序
赞
，轻点两下取消赞
在看
，轻点两下取消在看
分享
留言
收藏
听过