---
title: 再看 BLE：如何免费骑家楼下的共享电单车
url: https://github.red/hack-ble-electric-bicycle/
source: Light Cube
date: 2023-08-05
fetch_date: 2025-10-04T12:00:47.670989
---

# 再看 BLE：如何免费骑家楼下的共享电单车

[![logo](/images/logo.svg)](/)

[é¦é¡µ](/)

[å³äºæ](/about-me/)

[ç»æçè¨](/guestbook/)

[åé¾](/my-friends/)

[æç« å½æ¡£](/archive/)

[æ´æ°æ¥å¿](/update-history/)

![åç BLEï¼å¦ä½åè´¹éªå®¶æ¥¼ä¸çå±äº«çµåè½¦](https://img11.360buyimg.com/da/jfs/t1/102082/27/43777/24075/65d4df05Feaf3c085/d92334e0f268b776.png.webp)

## åç BLEï¼å¦ä½åè´¹éªå®¶æ¥¼ä¸çå±äº«çµåè½¦

[2023-08-04](//hack-ble-electric-bicycle//)â¢
[å®å¨](/categories/%E5%AE%89%E5%85%A8/)
â¢
3417 å­ / 7 åé

è·ç¦»ä¸ä¸æ¬¡ä¸æä»½ååå®¢ï¼å·²ç»è¿äºæ´æ´äºä¸ªæäºã

æå¨ä¸æåºçæ¶åå»åäº¬æäºä¸åº CTF çº¿ä¸èµï¼é¡ºå¸¦ææ¸¸äºä¸æ³¢ãåæä»½çæ¶å…… æï¼æ¯èåèº« 23 å¹´çæï¼å±ç¶å¦æ¿ä»¥å¿å°è±åäºãè°æç±ä¹åæè§æ¯å¤©çæ¶é´é½è¿å¾é£å¿«ï¼åç§åºå»ååååééï¼æä»¥åå®¢ä¸ç´æçæ²¡åãï¼å½æ¶ä¹æ²¡å¥ä¸è¥¿å

å­æä»½çæ¶åæå¨ä½æ­ç§çå¬å¯å°æäºï¼åå ä¸ç°å¨æ¯å¨å®¶è¿ç¨å¼¹æ§åå¬ï¼æä¾¿æ¬å°äºæ­å·æ¯è¾åçå°æ¹ä½çï¼è¿éçæ¿ä¸é½æ¯éè¿çæè¿æ·ï¼å»å¹´å¹´åºæ¯ä¸ªäººé½åå°äºå¥½å å¥å®ç½®æ¿ï¼éæ¿æ¥åºç§ç»éè¿çå­¦çåä¸ç­æï¼æ¿ç§é£å«ä¸ä¸ªä½ã
ä½æ¿ç§çä»£ä»·å°±æ¯åºé¨å¾ä¸æ¹ä¾¿ï¼æè¿çå°éç«ä¹è¦ä¸¤å¬éãéçå°åºéè¿çåºç¡è®¾æ½éæ¸å®åï¼æåç°å®¶æ¥¼ä¸æå±äº«çµåè½¦äºï¼æ¯å¤©æä¸é¥¿äºå¯ä»¥éªççµåè½¦å°ç¦»å®¶å å¬éçæµ·åºææä¸é¡¿ã

ä¸è¿è¿å±äº«çµåè½¦æ¯è¾åï¼ä¸æ¬¡èµ·å 20 åï¼æ¶é´ä¹äºï¼æé¾åæç¹å¿çæ³è¯è¯æï¼æå¤©æä¸æææ¨äºä¸è¾è½¦è¿çµæ¢¯ä¸æ¥¼ï¼ç¶åæ¾å®¶éå®¢åãå¼å¹²ï¼

å ä¸ºææ¹ä¸ä¸è¯¥æ¹çéº»ç¦ï¼ä»¥ä¸åå®¹æé¨åä¿®æ¹åæç ï¼æ¬è¯·è°è§£ã

## åä»å°ç¨åºä¸æ

è·å¸é¢ä¸çå±äº«åè½¦ä¸æ ·ï¼è§£éä¸è¾å±äº«çµåè½¦æ¯éè¿ææºæ«æè½¦èº«ä¸çäºç»´ç ï¼æèµ·å¾®ä¿¡å°ç¨åºï¼ç¶åå¨å°ç¨åºåç¹å»å¼éãé£ä¹æä»¬å°±åä»å°ç¨åºå¥æï¼ççå®çå¼éæµç¨ä¸­æ¯å¦æä¸å®å¨çå ç´ ã
å¾®ä¿¡å°ç¨åºçåç¼è¯è§£åå¨ GitHub ä¸æç°æçå·¥å·ï¼æ¬æå°±ä¸åèµè¿°ãæåé¢å¶å®æ¯ç¨äºæ´å åå·§çæ¹å¼è½»æ¾å°æ¿å°äºå°ç¨åºè§£ååçä»£ç ãåºæ¬ä¸æ¯å¨æºç  JavaScript ä¸æååç¼©è¿çç¨åº¦ï¼éæçåéè·æµç¨ä¹æ¯ååè½»æ¾ã

æä»¬ç´æ¥å¨å¨å±ä»£ç ä¸­æç´¢`å¼é`äºå­ï¼å¾å¿«å°±æ¾å°äºå¶å°ç¨åºä¸­çâå¼éä¸­â Toast å¼¹çªï¼å¼¹çªçåè°å°±æ¯è°ç¨èçåéå¼éçæä½ï¼

```
(wx.showToast({
            title: "å¼éä¸­",
            icon: "loading",
            mask: !0,
            duration: 1e5
        }), e.checkToken(function(o) {
            o.length > 0 && e.operateBluetooth("open", e.globalData.machineNO, function(n) {
                if (n) {
                    var a = e.globalData.baseUrl + "park/continueRide.do", l = {
                        token: o,
                        ble: !0,
                        orderSource: 3
                    };
                    t.request(a, l, function(o) {
                        o.ret && (wx.hideToast(), e.unlockAudio(), i && i());
                    });
                } else t.showModal_nocancel("èçæä½å¤±è´¥ï¼è¯·éè¯ï¼");
            });
        }))
```

åç°éç¹æ¯ `operateBluetooth` å½æ°ï¼è¿ä¸ªå½æ°ä¼ å¥äºä¸ä¸ªå¥åï¼åå«æ¯ `open` å­ç¬¦ä¸²ã`e.globalData.machineNO` ä¹å°±æ¯è½¦è¾ç¼å·ï¼åæè¿ååç°å°±æ¯è½¦è¾äºç»´ç ä¸é¢çæ°å­ï¼ç¬¬ä¸ä¸ªåæ°æ¯ä¸ä¸ªå½æ°ï¼çå½æ°éé¢è°ç¨äº `park/continueRide.do` æ¥å£ï¼åºè¯¥æ¯åæå¡ç«¯ä¸æ¥è½¦è¾çå¼éç¶æãè¿ä¸ªå½æ°åºè¯¥å°±æ¯ä¸ªåè°å½æ°ã

ç±è¿éæä»¬å¶å®ä¹å¯ä»¥ç¥éï¼è½¦è¾å¨å¼éåæ¯ææºä¸çå°ç¨åºä¸æ¥å¼éç¶æçï¼å ä¸ºå±äº«çµåè½¦æ¬èº«æ¯æ æ³èç½çï¼å®çä¸åå¼éå³éå®ä½ç¶æé½éè¦ç¨æ·çææºä¸æ¥ãå¦ææä»¬å¨ææºä¸ block æäºè¿ä¸ªåéç»æå¡ç«¯çè¯·æ±ï¼å°±å¯ä»¥å®ç°èçå¼éåä¸è®¡è´¹ãè½¦è¾æ¬èµ°åä¸æ´æ°å®ä½ç­åè½ã

ä½ç§çå¯¹ææ¯çè¿½æ±ï¼æè¿æ¯æ³ç»§ç»­æ·±æè¿ä¸ªèçéä¿¡çè¿ç¨ãå¾ä¸è· `operateBluetooth` å½æ°ï¼

```
operateBluetooth: function(o, t, e) {
        var a = this;
        this.getSecretKey(t).then(function(n) {
            a.bluetooth.start(o, n.machineNO, n.secret, function(o) {
                a.saveLog(t, a.globalData.mobileBrand, a.globalData.mobileOS, JSON.stringify(a.bluetooth.getLog())),
                console.log(a.bluetooth.getMachinevoltage()), e && e(o);
            });
        });
    }
```

è¿éæä»¬éå°äºç¬¬ä¸ä¸ªâçº¸èèâï¼æä¸ª `getSecretKey` å½æ°ï¼å®çå½æ°å¥å `o`ï¼å°±æ¯ä¸é¢ `operateBluetooth` çç¬¬äºä¸ªåæ° `t`ï¼ä¹å°±æ¯è½¦è¾çç¼å·ãè¿ä¸ªå½æ°å¨è¯·æ±æå¡ç«¯è·åå½åè½¦è¾çç§é¥ï¼
æ±çè¯ä¸è¯çæ³æ³ï¼ææé äºä¸è¯·æ±ï¼ç¬¬ä¸ä¸ª `token` åæ°æ¯å°ç¨åºæåå¾å°çå½åç¨æ·ç»å½åè·å¾ç Tokenï¼`userCode` ä¼ å¥çµåè½¦ç¼å·…… ç»æå±ç¶ççæåç»æè¿åè½¦è¾çç§é¥ã
æåç¨è½¦è¾å®ä½çæ¥å£è·åäºå¶å®çè½¦è¾ç¼å·ä¼ å¥è¿ä¸ªæ¥å£ï¼å±ç¶ä¹è½è¿åç»æå¯¹åºè½¦è¾çç§é¥ãä¹å°±æ¯å®åç«¯å®å¨æ²¡ææ ¡éªè¯¥è½¦æ¯å¦ä¸ºè¢«æç§åçç¶æï¼æå¯ä»¥è¯·æ±æ¥å£æ¿ä»»æè½¦çç§é¥å¼éã
å¯è§å®è¯¥é²çæ²¡é²ä½ï¼æä»¥ææç§°ä¹ä¸ºâçº¸èèâã

```
getSecretKey: function(o) {
        var e = this;
        return new Promise(function(a, n) {
            var l = e.globalData.baseUrl + "/machine/getBleSecret.do";
            e.checkToken(function(e) {
                if (e.length > 0) {
                    var n = {
                        token: e,
                        userCode: o
                    };
                    t.request(l, n, function(o) {
                        console.log("è·åçç§é¥", o.data), a(o.data);
                    });
                } else wx.hideToast();
            });
        });
    },
```

## åæ¯ BLE

æ¿å°äºè½¦è¾çç§é¥ï¼å©ä¸çå°±å¥½åäºãæä»¬ç»§ç»­è· `a.bluetooth.start` å½æ°ï¼

```
this.start = function(e, n, c, l) {
        A(), i = e, M = c, C = l, t.log(n, o, "operate:", i), W(function() {
            n == o && r && i ? R() : (o = n, r = null, O());
        });
```

å¶ä¸­ e = “open” å­ç¬¦ä¸²ï¼n = è½¦è¾ç¼å·ï¼c = ä¸é¢æ¿å°çè½¦è¾ç§é¥ï¼l åæ¯ä¸ªæ§è¡æååçåè°å½æ°ã`W` å½æ°è°ç¨å¾®ä¿¡å°ç¨åº SDK ä¸­ç `wx.openBluetoothAdapter` æ¹æ³åå§åèçï¼ä¹åçä¸åè¿ç®ç¬¦è¿å¥ `O` å½æ°ï¼`O` è°ç¨ `F` å½æ°ï¼`F` å½æ°å¼å§æç´¢èçè®¾å¤ã
æä¸çï¼å¥½å®¶ä¼ï¼è¿ä¸æ¯è·æåå¹´æå¾å°ç±³æç¯è·åå¿è·³çæç« ä¸æ ·åï¼[https://github.red/miband-heart-rate/](https://github.red/miband-heart-rate/ "https://github.red/miband-heart-rate/")ï¼ï¼è¿å±äº«çµåè½¦ä¹æ¯ä½¿ç¨çèç BLE åè®®ã
ç´æ¥ä¸ Go ç `github.com/JuulLabs-OSS/ble` åºï¼æå¦ä¸æ­¥éª¤ä¸ææ¢­ã

1. æç´¢è®¾å¤
2. æç´¢ Services
3. æç´¢ Characteristics
4. è®¢éï¼è¯»åæ¶æ¯

### æç´¢è®¾å¤

æé¦åä½¿ç¨ Bluetility æç´¢éè¿çè®¾å¤ï¼åç°æ²¡æè®¾å¤åç±»ä¼¼å±äº«çµåè½¦çè®¾å¤ãçäºä¸å°ç¨åºæºç è®¾å¤åç°è¿åï¼

```
wx.onBluetoothDeviceFound(function(n) {
            var l = n.devices[0];
            if (l && l.advertisData && 0 != l.advertisData.byteLength) {
                var s = e.encrypt(e.ab2hex(l.advertisData).slice(4, 13));
                t.log("æç´¢å°çè®¾å¤ç¼å·ï¼" + s + "ï¼ç®æ ï¼" + o), s == o && (Q(), clearInterval(c), c = null,
                r = l.deviceId, t.log("deviceId:", r), "open" == i || "close" == i ? R() : C && C(!0));
            }
        });
```

å¯ä»¥çå°å®å°èçè®¾å¤ç `advertisData`ï¼è¿ç®åä¸`start` å½æ°ä¸­è®¾ç½®ç `o` åéï¼è½¦è¾ç¼å·ï¼è¿è¡æ¯è¾ï¼å¦æç¸ååè¡¨æè¿ä¸ªè®¾å¤æ¯æä»¬è¦æ¾çå¯¹åºç¼å·çå±äº«çµåè½¦ã
è¿ä¸ª `advertisData` çè¿ç®å...