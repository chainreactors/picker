---
title: Onenote Malware: Classification and Personal Notes
url: https://buaq.net/go-147933.html
source: unSafe.sh - ‰∏çÂÆâÂÖ®
date: 2023-02-05
fetch_date: 2025-10-04T05:45:02.018504
---

# Onenote Malware: Classification and Personal Notes

* [unSafe.sh - ‰∏çÂÆâÂÖ®](https://unsafe.sh)
* [ÊàëÁöÑÊî∂Ëóè](/user/collects)
* [‰ªäÊó•ÁÉ≠Ê¶ú](/?hot=true)
* [ÂÖ¨‰ºóÂè∑ÊñáÁ´†](/?gzh=true)
* [ÂØºËà™](/nav/index)
* [Github CVE](/cve)
* [Github Tools](/tools)
* [ÁºñÁ†Å/Ëß£Á†Å](/encode)
* [Êñá‰ª∂‰º†Ëæì](/share/index)
* [Twitter Bot](https://twitter.com/buaqbot)
* [Telegram Bot](https://t.me/aqinfo)
* [Search](/search/search)

[Rss](/rss.xml)

[ ]
ÈªëÂ§úÊ®°Âºè

![](https://8aqnet.cdn.bcebos.com/b8f692773acb412e2001b63b24cbef00.jpg)

Onenote Malware: Classification and Personal Notes

During the past 4 months Microsoft Onenote file format has been (ab)used as Malware carrier
*2023-2-4 16:17:56
Author: [marcoramilli.com(Êü•ÁúãÂéüÊñá)](/jump-147933.htm)
ÈòÖËØªÈáè:49
Êî∂Ëóè*

---

During the past 4 months Microsoft Onenote file format has been (ab)used as Malware carrier by different criminal groups. While the main infection vector is still on eMail side ‚Äì so nothing really relevant to write on ‚Äì the used techniques, the templates and the implemented code to inoculate Malware changed a lot. So it would be interesting to study this new phenomenon for further attribution and for quick identifications.

Aim of this post is to highlights the main used techniques to inject Malware into Microsoft Onenote file format and to attribute them to specific Malware families.

NB: This post represents personal notes on how actors are abusing Microsoft Onenote file. You will not find complete Malware analyses or reverse engineering path since it‚Äôs not my current goal.

#### Async RAT

The very first Malware seen abusing Microsoft Onenote file format was AsyncRAT. Async RAT is using a VBScript embedded into the `.one` file format next to images (PNG) and random scripts as well to start its infection chain. The `VBscript` executes the `AutoOpen` function which eventually runs the following main routine:

```
Function WmiExec(cmdLine )
    Dim objConfig
    Dim objProcess
    Set objWMIService = GetObject("winmgmts:\\.\root\cimv2")
    Set objStartup = objWMIService.Get("Win32_ProcessStartup")
    Set objConfig = objStartup.SpawnInstance_
    objConfig.ShowWindow = 0
    Set objProcess = GetObject("winmgmts:\\.\root\cimv2:Win32_Process")
    WmiExec = dukpatek(objProcess, objConfig, cmdLine)
End Function
```

Interesting to report the following function: the `ExecuteAsync` function from which it takes its name:

```
Sub ExecuteCmdAsync(targetPath )
    On Error Resume Next
    Err.Clear
    wimResult = WmiExec(targetPath)
    If Err.Number <> 0 Or wimResult <> 0 Then
        Err.Clear
        WscriptExec targetPath
    End If
    On Error Goto 0
End Sub
```

The chosen command to drop and execute the desired RAT is a `powershell`  `Invoke-WebRequest` from a specific URI. The following images shows the complete core execution function included into the carrier file format. I find remarkable the similarity with classic Microsoft Office Macros pattern here. It looks like a developer who desired to reuse many skill from classic Office Droppers.

![](https://i0.wp.com/marcoramilli.com/wp-content/uploads/2023/02/2023-01-31_22-04.png?resize=1024%2C419&ssl=1)

#### Remcos

One of the most interesting samples seen to abuse Microsoft onenote file format, at least so far, was the Remcos implant. It directly embeds a `.NET` dropper which carries (potentially) many infection vectors. The main function parses for input characters and eventually adds delays or dumps codes. The following image shows how the main function would run once executed.

While is not my intent to perform a complete Remcos analysis, it‚Äôs remarkable the way the Malware writer uses `string.compare` and `string.replace` to evade classic pattern matching signatures. Check the red boxes to the following image to see what I meant.

![](https://i0.wp.com/marcoramilli.com/wp-content/uploads/2023/02/a1.png?resize=1024%2C551&ssl=1)

Remcos main function

The second stage is directly dropped from an encoded string and run on memory. The following image shows the used pattern to decode and execute the news payload. Many tools are available to decode this junk but you might just introduce some `writeline` on the code to monitor the variable change.

![](https://i0.wp.com/marcoramilli.com/wp-content/uploads/2023/02/a2.png?resize=1024%2C498&ssl=1)

Second Stage Payload

Decoding the `base64` string would show the clear-text code from where we might appreciate a nice and plain drop-and-execute payload. Finally we see the dropping url (in this case `canon.buytoprint.com`) and the romantic execution by reflection as in the best Remcos tradition.

![](https://i0.wp.com/marcoramilli.com/wp-content/uploads/2023/02/2023-01-31_21-49.png?resize=1024%2C545&ssl=1)

Remcos Dropper

The multi stage delivered payloads are very interesting and complex in its rounds, it looks like to be the result of a multi-layered ‚ÄúRemcos Builder‚Äù in where attackers added the new functionality to be injected into Onenote file.

#### Quakbot

Quakbot presents itself as an embedded HTML page within both `javascript` and `VBscript` functions into the Onenote file format. The `qbot` or `Quakbot` sample sees a `<div>` section within encoded parameters to a given dropped and downloaded `WScript` code. In this case the encoded parameter is stored on the local key `hkcu\\Software\Firm\Soft\Name`.

Javascript is used to extract section (`id=content`) from DOM, to drop and execute a specific `WShell` script (in this scenario from 45.155.37.124) while VBscript is used to interact with Windows Register.

![](https://i0.wp.com/marcoramilli.com/wp-content/uploads/2023/02/2023-01-31_21-47.png?resize=1024%2C463&ssl=1)

QuackBot Dropper

Quite interesting to see its fingerprint and to see the implementation in two scripting languages in where the second one is only used for simple tasks. In my personal point of view it looks like to be the result of multiple developers who never spoke to themselves üòÄ (LOL).

#### Redline

Redline Malware presents itself in a very original way if compared to previous ones. It looks like a botnet (it really reminds me, in this specific form, the way Mirai spreads itself) indeed it includes into Onenote file format many single `VBScript`s running simple `powershell` commands. Into every script you would find many indicators (droppping urls): only one is needed to be up-and-running for begin the infection chain. The following image shows how it behaves: from a dropping url it drops a ‚Äúreal onenote file‚Äù (for example `Invocice`.one) which runs first. After the documents run it loads from a second url a `powershell` file running the Redline infection chain.

![](https://i0.wp.com/marcoramilli.com/wp-content/uploads/2023/02/2023-02-01_17-36.png?resize=1024%2C544&ssl=1)

Redline Dropper

The analyzed sample implements an impressing obfuscated payloads as seen in the bottom of the previous image. It uses a substitution variable plus some junk base64 encoded piece of code to make the analysis long and boring. Once the payload is run the following command line is invoked and the Redline info stealer begins its journey.

It looks that a very similar sample was previously analyzed by Rapid7 in its report [here](https://www.rapid7.com/blog/post/2023/01/31/rapid7-observes-use-of-microsoft-onenote-to-spread-redline-infostealer-malware/).

Redline is the only sample which wants to lure the victim by giving to him a fake ‚Äúreal‚Äù document acting like a Trojan (even not really), one more interesting characteristics to be recorded.

![](https://i0.wp.com/marcoramilli.com/wp-content/uploads/2023/02/2023-02-01_17-37.png?resize=1024%2C169&ssl=1)

Redline Second Stage

#### Conclusion

From this quick blog post we should takeaway the following principles:

#### Classified Samples

* **Sha256**: 482a4763c8cf9c448fc851e6fe4554cc48abc563c49847ed040cdaee8a12003c (Async Rat)
* **Sha256**: b45ace5a35914dcd4beb7486f3ddad4bbd84be245d403b9e6a3f1b907aa4ae03 (Quakbot)
* **Sha256**: b13c979dae8236f1e7f322712b774cedb05850c989fc08312a348e2385ed1b21 (Remcos)
* **Sha256**: eb674dc2e3787de0948e0af5a50aa365b21eb2...