---
title: Defensive Technology: Antimalware Scan Interface (AMSI)
url: https://textslashplain.com/2024/10/25/defensive-technology-antimalware-scan-interface-amsi/
source: text/plain
date: 2024-10-26
fetch_date: 2025-10-06T18:52:45.041363
---

# Defensive Technology: Antimalware Scan Interface (AMSI)

[Skip to content](#content)

[text/plain](https://textslashplain.com/)

ericlaw talks about security, the web, and software in general

# Defensive Technology: Antimalware Scan Interface (AMSI)

Posted by[ericlaw](https://textslashplain.com/author/ericlaw1979/)[2024-10-252025-09-17](https://textslashplain.com/2024/10/25/defensive-technology-antimalware-scan-interface-amsi/)Posted in[security](https://textslashplain.com/category/security/), [tech](https://textslashplain.com/category/tech/)Tags:[Defender](https://textslashplain.com/tag/defender/), [InfoSecTTP](https://textslashplain.com/tag/infosecttp/), [malware](https://textslashplain.com/tag/malware/), [security](https://textslashplain.com/tag/security/)

Endpoint security software faces a tough challenge — it needs to be able to rapidly distinguish between desired and unwanted behavior with few false positives and false negatives, and attackers work hard to obfuscate ([or cloak](https://textslashplain.com/2024/02/20/cloaking-detonation-and-client-side-phishing-detection/)) their malicious code to prevent detection by security scanners.

To maximize protection, security software wants visibility into attack chains at their weakest — after any obfuscation has been stripped away, immediately before (or during) execution. Unfortunately, this is hard, because most security software hooks are either very **low-level** (e.g. kernel drivers watching file and process activity) and thus lack context, or very **high-level** (e.g. scanning downloaded files), where obfuscation is in place.

The Antimalware Scan Interface is a Windows platform mechanism that allows host applications to call out to security software before performing sensitive operations (e.g. running script, elevating UAC, invoking ActiveX objects, etc). The security software can scan the data buffers and return a “Allow”/”Deny” verdict based on its threat intelligence. AMSI is **pluggable on both sides** — any **host** application can call into AMSI, and any **security software** can receive the calls[1].

On a default Windows system, **hosts** include `cscript`, `wscript`, [PowerShell](https://www.youtube.com/watch?v=DYWPtt7qszY&t=2725s), the [.NET CLR](https://github.com/dotnet/runtime/blob/main/src/coreclr/vm/amsi.cpp) Platform, [UAC](https://learn.microsoft.com/en-us/windows/security/application-security/application-control/user-account-control/how-it-works) elevation prompting, [WMI](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-classes), [VSS](https://learn.microsoft.com/en-us/windows-server/storage/file-server/volume-shadow-copy-service), and several Microsoft server products (including [optionally](https://learn.microsoft.com/en-us/sharepoint/security-for-sharepoint-server/configure-amsi-integration) [SharePoint](https://www.microsoft.com/en-us/security/blog/2025/04/09/stopping-attacks-against-on-premises-exchange-server-and-sharepoint-server-with-amsi/)). Microsoft Office desktop applications call AMSI to [scan VBA macros](https://www.microsoft.com/en-us/security/blog/2018/09/12/office-vba-amsi-parting-the-veil-on-malicious-macros/).

**Security software** like Microsoft Defender (and most 3rd party AV products) will scan the data buffers provided by the host and return **verdicts** based on their threat intelligence (signatures). Microsoft Defender for Endpoint also uses AMSI to implement several of its [attack surface reduction rules](https://learn.microsoft.com/en-us/defender-endpoint/attack-surface-reduction-rules-reference?view=o365-worldwide#block-javascript-or-vbscript-from-launching-downloaded-executable-content) that constrain the behavior of scripts.

[![](https://textslashplain.com/wp-content/uploads/2024/10/image-13.png?w=656)](https://textslashplain.com/wp-content/uploads/2024/10/image-13.png)

AMSI protections help improve blocking in common initial access vectors ([e.g. running a downloaded `.js` file](https://textslashplain.com/2024/05/20/attack-techniques-full-trust-script-downloads/)) and improve protection over traditional AV signatures (which can be fooled by obfuscation) and behavior monitoring (which might detect misbehavior too late). It’s especially [useful](https://learn.microsoft.com/en-us/windows/win32/amsi/how-amsi-helps#more-background-info-about-fileless-threats) against [fileless threats](https://learn.microsoft.com/en-us/defender-endpoint/malware/fileless-threats) in which the attack code was never on disk for a traditional AV sensor to scan.

The [documentation for application developers](https://learn.microsoft.com/en-us/windows/win32/amsi/how-amsi-helps) who want to call into AMSI is pretty good. For security software developers, there’s both [documentation](https://learn.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-interface-portal) and an [sample AMSI scanner on GitHub](https://github.com/Microsoft/Windows-classic-samples/tree/main/Samples/AmsiProvider).

### Limitations

The biggest limitation in AMSI is that a host application must call it– unlike most security software sensors, which rely on kernel drivers and [process injection techniques](https://github.com/microsoft/Detours) to provide security for every application, AMSI requires the explicit participation of an application to call out to AMSI and respect its verdict.

Hosts must choose when and if they will call into AMSI– for example, a host might not choose to call AMSI if it doesn’t think a given script is potentially dangerous (e.g. the Windows Scripting hosts may only call AMSI if they see a potentially-dangerous object created). We call these **triggers**, and they must be selected carefully to balance performance and security.

For example, AMSI is never called to evaluate JavaScript running inside your web browser (Edge, Chrome, Firefox, etc). Unlike `cscript` and `wscript` which run “shell scripts” with access to powerful capabilities (writing files, launching processes, etc), browsers execute “web platform” JavaScript inside tight security sandboxes that prevent interaction with files and other objects on the system. Browsers compete on runtime performance, and the overhead of security scans on sandboxed script would yield a poor cost/benefit.

As with any other security software component, attackers have attempted to tamper with AMSI, using a wide range of techniques ranging from simple to ingenious. The majority of such techniques require that the attacker have at least partially-compromised the victim PC (to manipulate the execution environment), and a major goal of AMSI is to foil the attacks that would grant the attacker initial access to start with.

### Future Brainstorming?

AMSI has been around for a long time now, and hasn’t seen a ton of changes over the years. However, there’s recently a [greatly renewed interest](https://blogs.windows.com/windowsexperience/2024/09/12/taking-steps-that-drive-resiliency-and-security-for-windows-customers/) in empowering security software without requiring that each vendor write its own kernel drivers, and the model used by AMSI is a great one for providing powerful visibility and control in user-space.

To that end, I’d love to see more scenarios for AMSI-like callouts. Most notably among them– **URL Reputation**. Today, myriad applications present, transmit, and load content from URLs, but security software often is not well-positioned to “see” those URLs. Except for security code directly integrated into browsers (e.g. SafeBrowsing for Chrome, SmartScreen for Edge), security software is often forced to “guess” where a given network request is going via low-level packet-sniffing. This approach (*at best*) [supplies only the hostname](https://textslashplain.com/2023/10/04/security-tradeoffs-privacy/) (not the full URL) will soon become even less reliable, as browsers further improve their privacy against network sniffers. Imagine if every application could easily call out to the platform security software and ask “*Hey, I’m going to go grab these 40 URLs. Any ob...