---
title: 如何在终端上定位发起恶意请求的进程？
url: https://www.anquanke.com/post/id/287604
source: 安全客-有思想的安全新媒体
date: 2023-03-22
fetch_date: 2025-10-04T10:13:41.602223
---

# 如何在终端上定位发起恶意请求的进程？

首页

阅读

* [安全资讯](https://www.anquanke.com/news)
* [安全知识](https://www.anquanke.com/knowledge)
* [安全工具](https://www.anquanke.com/tool)

活动

社区

学院

安全导航

内容精选

* [专栏](/column/index.html)
* [精选专题](https://www.anquanke.com/subject-list)
* [安全KER季刊](https://www.anquanke.com/discovery)
* [360网络安全周报](https://www.anquanke.com/week-list)

# 如何在终端上定位发起恶意请求的进程？

阅读量**443102**

发布时间 : 2023-03-21 10:30:15

**x**

##### 译文声明

本文是翻译文章

译文仅供参考，具体内容表达以及含义原文为准。

![]()

## 前言

在日常工作中，我们常常会监测到办公网发出的恶意域名请求。然而，由于缺乏EDR工具的辅助，我们在定位这些恶意请求时效率往往较低。因此，我们总结了一些有助于提高定位效率的方法，包括开源工具使用和借助系统自身日志分析。这些方法都可以帮助我们更快速、准确地定位办公网发出恶意域名请求的进程，提高我们的安全响应能力。

## MacOS篇

### 安全工具

思考这个问题的时候，首先想到的是借助现有安全工具，于是调研了多款具备网络监控能力的工具，下面展示可以满足需求的两款工具的实际使用效果。

**火绒剑Mac版**

火绒提供了对进程进行网络监控的能力。

![]()

实际测试中，开启对dns请求的过滤，并没有任何输出。但是对于dns解析固定的域名，可以通过开启监控，过滤指定ip来协助定位。

**DNSMonitor**

DNSMonitor是一款利用 Apple 的Network Extension Framework监控 DNS 请求和响应的开源安全工具。
项目地址：<https://github.com/objective-see/DNSMonitor>
下载地址：<https://objective-see.org/products/utilities.html>
使用方法：
将软件解压至Applications目录，运行后允许加载系统扩展和监控dns流量即可使用。

```
DNSMonitor.app/Contents/MacOS/DNSMonitor -h

DNSMonitor usage:
 -h or -help      display this usage info
 -json            output is formatted as JSON
 -pretty          JSON output is 'pretty-printed'
```

监控效果如下，可以获取执行dns请求的程序路径和进程ID，能够完美匹配需求。

![]()

### 开启MacOS统一日志的私有数据日志并进行查询

macOS统一日志是一种全新的日志系统，在Mac OS X 10.12 Sierra中首次引入。它将多个日志来源整合到一个统一的日志文件中，包括系统日志、应用程序日志和安全日志等。其中包含了DNS请求日志，但是默认是被作为私有数据日志记录的，需要手动开启。在Sierra后的不同的系统版本中有不同的启用方式。

**从Sierra到Mojave**

在终端中运行下列命令即可开启
`sudo log config --mode "private_data:on"`

**Catalina <10.15.3**

上述方法在Catalina中不再有效。研究员Saagar Jha提供了一款PrivateLogs工具用于开启私有数据日志。
在终端中运行下列命令即可开启

```
$ PrivateLogs enable
$ PrivateLogs status
enabled
```

> PrivateLogs工具：<https://saagarjha.com/blog/2019/09/29/making-os-log-public-on-macos-catalina/#putting-it-all-together>

**Catalina 10.15.3+**

在更高的版本中，可以通过安装描述文件，打开私有数据日志

```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>PayloadContent</key>
  <array>
    <dict>
      <key>PayloadDisplayName</key>
      <string>ManagedClient logging</string>
      <key>PayloadEnabled</key>
      <true/>
      <key>PayloadIdentifier</key>
      <string>com.apple.logging.ManagedClient.1</string>
      <key>PayloadType</key>
      <string>com.apple.system.logging</string>
      <key>PayloadUUID</key>
      <string>ED5DE307-A5FC-434F-AD88-187677F02222</string>
      <key>PayloadVersion</key>
      <integer>1</integer>
      <key>System</key>
      <dict>
        <key>Enable-Private-Data</key>
        <true/>
      </dict>
    </dict>
  </array>
  <key>PayloadDescription</key>
  <string>Enable Unified Log Private Data logging</string>
  <key>PayloadDisplayName</key>
  <string>Enable Unified Log Private Data</string>
  <key>PayloadIdentifier</key>
  <string>C510208B-AD6E-4121-A945-E397B61CACCF</string>
  <key>PayloadRemovalDisallowed</key>
  <false/>
  <key>PayloadScope</key>
  <string>System</string>
  <key>PayloadType</key>
  <string>Configuration</string>
  <key>PayloadUUID</key>
  <string>D30C25BD-E0C1-44C8-830A-964F27DAD4BA</string>
  <key>PayloadVersion</key>
  <integer>1</integer>
</dict>
</plist>
```

效果如下：

![]()

**日志查询方式**

在终端中运行下列命令，可检测是否开启成功

```
$  sudo log config --status
System mode = INFO PRIVATE_DATA
```

在终端中运行下列命令，可以查询近一小时的日志

`log show --last 1h --predicate 'eventMessage CONTAINS[cd] "dns"' |grep "mDNSResponder" |grep "START PID"`

效果如下：

![]()

*备注：只能查询开启私有数据日志记录之后的日志，历史日志仍以私有日志形式展示。实际测试中在Ventura只显示了部分私有数据日志，精力有限，未跟进探究。*

### 小结

以上几种方式各有优缺点。DNSmonitor可以完美解决开篇的问题，而火绒在此设定场景下的监控能力对比DNSmonitor稍有不足，但是其能力也不限于网络监控。如果不想借助第三方工具，可以按系统版本参照上文对应方法开启私有数据日志，另外不信任第三方描述文件的话，也可以参照官方文档自行编写。

> 官方文档：<https://developer.apple.com/documentation/devicemanagement/systemlogging>

## Windows篇

微软的Sysmon 10，集成了DNS查询记录功能，此功能将允许Sysmon用户在受监视的计算机上记录进程所执行的DNS查询。从功能介绍来看，是契合需求的。
通过官方下载地址下载，cmd命令窗口执行`sysmon.exe -accepteula -i sysmonconfig-export.xml` 命令进行安装，配置文件来自Github开源项目sysmon-config。

> 官方下载地址：<https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon>
> sysmon-config:<https://github.com/SwiftOnSecurity/sysmon-config>

安装成功后即可在事件查看器中的应用程序和服务日志/Microsof /Windows/Sysmon/Operational 查看dns请求日志，事件ID为22。

![]()

如果想查询特定的域名，需要编辑xml格式的查询语句进行筛选，这里直接贴一段powershell脚本，可查询指定时间内的指定域名以及发起dns请求的用户和进程id。

```
#查询过去1小时内，事件ID为22，域名为www.baidu.com的日志
$xml ='<QueryList>
  <Query Id="0" Path="Microsoft-Windows-Sysmon/Operational">
    <Select Path="Microsoft-Windows-Sysmon/Operational">*[System[(EventID=22)
and TimeCreated[timediff(@SystemTime) &lt;= 3600000]]] and *[EventData[Data[@Name="QueryName"] and (Data="www.baidu.com")]]</Select>
  </Query>
</QueryList>'

$events = Get-WinEvent -FilterXml $xml
$i=0

while ($i -lt $events.length) {
    $time=$events[$i].TimeCreated
    $dns=[regex]::matches($events[$i].Message, 'QueryName:(.+)') | %{$_.Groups[1].Value.Trim()}
    $id=[regex]::matches($events[$i].Message, 'ProcessId:(.+)') | %{$_.Groups[1].Value.Trim()}
    $user=[regex]::matches($events[$i].Message, 'User:(.+)') | %{$_.Groups[1].Value.Trim()}
    Write-Host $time,'  QueryName:'$dns'  ','ProcessId:'$id'  ','User:'$user
    $i++
}
```

执行效果如下:

![]()

## 参考

<https://github.com/SwiftOnSecurity/sysmon-config>
<https://huorong.cn/info/1620802825658.html>
<https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon>
<https://georgegarside.com/blog/macos/sierra-console-private/#google_vignette>
<https://saagarjha.com/blog/2019/09/29/making-os-log-public-on-macos-catalina/>

本文翻译自 原文链接。如若转载请注明出处。

商务合作，文章发布请联系 anquanke@360.cn

本文由**陌陌安全**原创发布

转载，请参考[转载声明](https://www.anquanke.com/note/repost)，注明出处： [https://www.anquanke.com/post/id/287604](/post/id/287604)

安全KER - 有思想的安全新媒体

本文转载自:

如若转载,请注明出处：

安全KER - 有思想的安全新媒体

分享到：![微信](https://p0.ssl.qhimg.com/sdm/28_28_100/t01e29062a5dcd13c10.png)

* [应急响应](/tag/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94)
* [终端安全](/tag/%E7%BB%88%E7%AB%AF%E5%AE%89%E5%85%A8)
* [办公网安全](/tag/%E5%8A%9E%E5%85%AC%E7%BD%91%E5%AE%89%E5%85%A8)

**+1**11赞

收藏

![](https://p3.ssl.qhimg.com/t012e36e1a186afffc4.png)陌陌安全

分享到：![微信](https://p0.ssl.qhimg.com/sdm/28_28_100/t01e29062a5dcd13c10.png)

## 发表评论

您还未登录，请先登录。

[登录](/login/index.html)

![](https://p3.ssl.qhimg.com/t014757b72460d855bf.png)

[![](https://p3.ssl.qhimg.com/t012e36e1a186afffc4.png)](/member.html?memberId=123747)

[陌陌安全](/member.html?memberId=123747)

https://security.immomo.com/

* 文章
* **72**

* 粉丝
* **4**

### TA的文章

* ##### [APP合规开发指南](/post/id/288593)

  2023-05-09 16:34:58
* ##### [活动｜春季限定，创新类产品活动大放送](/post/id/288549)

  2023-05-09 16:33:16
* ##### [如何在终端上定位发起恶意请求的进程？](/post/id/287604)

  2023-03-21 10:30:15
* ##### [活动｜快乐生日月，我们6岁啦！](/post/id/287361)

  2023-03-13 17:00:42
* ##### [活动｜开箱大吉！客官您里面看看？](/post/id/285799)

  2023-01-30 17:30:35

### 相关文章

* ##### [终端防御对抗演化史（一）](/post/id/293594)

  2024-03-25 11:30:07
* ##### [杀软EDR都没检出？一文秒懂“银狐”四大绕过手法](/post/id/288039)

  2023-03-31 11:14:56
* ##### [终端安全步入“深水区”，EDR如何破局？](/post/id/287498)

  2023-03-23 14:30:10
* ##### [windows应急响应](/post/id/287417)

  2023-03-15 15:30:13
* ##### [应急响应不“摇人”，好的EDR做对了哪些事？](/post/id/286737)

  2023-02-27 14:00:57
* ##### [无文件攻击，如何被EDR在1分钟内自动检出？](/post/id/286389)

  2023-02-15 15:50:09
* ##### [当红队已获得靶标，为何你的杀软依旧静悄悄](/post/id/286135)

  2023-02-10 14:30:51

### 热门推荐

文章目录

* [前言](#h2-0)
* [MacOS篇](#h2-1)
  + [安全工具](#h3-2)
  + [开启MacOS统一日志的私有数据日志并进行查询](#h3-3)
  + [小结](#h3-4)
* [Windows篇](#h2-5)
* [参考](#h2-6)

![](https://p0.qhimg.com/t11098f6bcd5614af4bf21ef9b5.png)

安全KER

* [关于我们](/about)
* [联系我们](/note/contact)
* [用户协议](/note/protocol)
* [隐私协议](/note/privacy)

商务合作

* [合作内容](/note/business)
* [联系方式](/note/contact)
* [友情链接](/link)

内容需知

* [投稿须知](https://www.anquanke.com/contribute/tips)
* [转载须知](/note/repost)
* 官网QQ群：568681302

合作单位

* [![安全KER](https://p0.ssl.qhimg.com/t01592a959354157bc0.png)](http://www.cert.org.cn/)
* [![安全KER](https://p0.ssl.qhimg.com/t014f76fcea94035e47.png)](http://www.cnnvd.org.c...