---
title: CVE-2017-11882分析和白象样本分析
url: https://buaq.net/go-241570.html
source: unSafe.sh - 不安全
date: 2024-05-26
fetch_date: 2025-10-06T16:49:14.679789
---

# CVE-2017-11882分析和白象样本分析

* [unSafe.sh - 不安全](https://unsafe.sh)
* [我的收藏](/user/collects)
* [今日热榜](/?hot=true)
* [公众号文章](/?gzh=true)
* [导航](/nav/index)
* [Github CVE](/cve)
* [Github Tools](/tools)
* [编码/解码](/encode)
* [文件传输](/share/index)
* [Twitter Bot](https://twitter.com/buaqbot)
* [Telegram Bot](https://t.me/aqinfo)
* [Search](/search/search)

[Rss](/rss.xml)

[ ]
黑夜模式

![](https://8aqnet.cdn.bcebos.com/50c523fc584b4fc0f865eb2022a71636.jpg)

CVE-2017-11882分析和白象样本分析

CVE-2017-11882是微软公布的一个远程代码执行漏洞，漏洞是由模块EQNEDT32.EXE公式编辑器引起，该模块在Office的安装过程中被默认安装，该模块以OLE技术（Object Link
*2024-5-25 15:17:0
Author: [mp.weixin.qq.com(查看原文)](/jump-241570.htm)
阅读量:9
收藏*

---

CVE-2017-11882是微软公布的一个远程代码执行漏洞，漏洞是由模块EQNEDT32.EXE公式编辑器引起，该模块在Office的安装过程中被默认安装，该模块以OLE技术（Object Linking and Embedding，对象链接与嵌入）将公式嵌入在Office文档内。

漏洞产生原因是公式编辑器EQNEDT32.EXE（路径C:\Program Files\Common Files\microsoft shared\EQUATION）读入包含MathType的OLE数据，在拷贝公式字体名称时没有对名称长度进行校验，使得攻击者可以通过刻意构造的数据内容覆盖栈上的函数返回地址，造成栈缓冲区溢出，劫持程序执行流程，执行自己的恶意代码，又因为插入和编辑数学公式时,EQNEDT32.EXE并不会被作为Office进程的子进程创建，而是以单独的进程形式存在。所以Office进程的保护机制也无法保护EQNEDT32.EXE这个进程被利用。从漏洞利用效果来看，它可以通杀Office 2003到2016的所有版本。

apt组织像蔓灵花、白象、摩诃草、响尾蛇利用该漏洞文档发起攻击。

（以上内容来自互联网）

```
一

漏洞分析
```

系统环境：win10
office版本：office 16
poc:https://github.com/Ridter/CVE-2017-11882

因为双击poc后会弹出calc.exe，所以在CreateProcess和WinExec函数下断点。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkV6h46P9MhTUZqaIm8fAOCibiaVd0tuIrrdmFvBnLdKVeWGkaladzKOUsA/640?wx_fmt=png&from=appmsg)

断在WinExec函数处，WinExec的返回地址是00430C18，参数19ef00,内容是通过cmd打开calc.exe。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVjSSDZKBNYUKvOic1tzESGwoBCZB4brVjibdwQ7MJ1Jn4p0Dn7XypjPqw/640?wx_fmt=png&from=appmsg)

此时ebp应该存储调用者ebp,但是现在是41414141，ebp被破坏了，向上低地址（低地址有已经执行过的函数堆栈）查找ebp是在哪被破坏的。

411658处指令 rep movsd，将esi内容复制到edi，ecx个双字大小
rep movs byte ptr es:[edi], byte ptr ds:[esi] 简写为: rep movsb
rep movs word ptr es:[edi], word ptr ds:[esi] 简写为: rep movsw
rep movs dword ptr es:[edi], dword ptr ds:[esi] 简写为: rep movsd
复制次数由ecx决定。

EDI 为 ebp-28（40字节）,复制内容大小为48字节，41414141覆盖ebp,剩余四字节覆盖返回地址。跳转到返回地址执行call WinExec函数，参数已经在栈中。（ecx大于A就会破坏ebp。大于B破坏到返回地址）

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkV850LpP6eIPd3hFGIDNomVwBtobWtkVhpvUibqXAwJsnAkxJQnAJDdKg/640?wx_fmt=png&from=appmsg)

断点断在WinExec函数处，
从栈中查找调用winexec的函数（向高地址找）。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVohQvWH7P1IgMmZQ5f7lHxDV95jP4uAPTcoQSUqmeHwx0kZfGQVhGeA/640?wx_fmt=png&from=appmsg)

**分析4115a7函数，调用41160f函数，411658处调用不安全的strcpy函数，没有对参数的长度进行判断和限制，导致栈溢出。**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVKiaiapIdBnUMtpZashYqrP9LVBNUzvjFwML5Lg4vj39wKN8eLIaiav1rQ/640?wx_fmt=png&from=appmsg)
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVgKibibfxU3mBfZGQ2K0wCvvAp90RAH1SibTyXia5qDyCH8BDIHAZrrzY9w/640?wx_fmt=png&from=appmsg)

成功弹出计算器。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkV4kcAFJjkqwibvKOWsd8fUjDceKGC4fevbaeavLPCcgvxuFpqHfGHUHQ/640?wx_fmt=png&from=appmsg)

```
二

白象组织诱饵文档
```

### 定位漏洞

使用pchunter和 process Monitor 定位产生漏洞的模块，是EQNEDT32.EXE。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVYrWvlew8QmMW3WJVruibybehsHeV4ZXU2hP4dGBXIPNicZQHiaSboDo1g/640?wx_fmt=png&from=appmsg)

并且利用forfiles进程执行释放文件mcods.exe（C:\ProgramData\Microsoft\DeviceSync\mcods.exe）

利用IFEO劫持调试

计算机\HKEY\_LOCAL\_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\EQNEDT32.EXE

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVibH7qXhUNiaxNenKNMGfdDzofDf1z2JhyhXT2z0nZQtlsxntygDdVGdg/640?wx_fmt=png&from=appmsg)

### 漏洞利用

根据cve的分析，将断点下在411658处，不断F9（注意exc的值,当大于B时查看）此时exc为0xC，F8后如下图堆栈被覆盖。

返回地址被覆盖为48C7C2。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVRr1KoXMvk93nVNbtGKfNZ3GSicjzQzH2jInPK3ia1eN0BD0pWNISiasGA/640?wx_fmt=png&from=appmsg)

继续执行到函数结束处leave指令，ret指令。

Leave等价于：
movl %ebp %esp
popl %ebp

RET指令则是将栈顶的返回地址弹出到EIP，然后按照EIP此时指示的指令地址继续执行程序。

跳转到返回地址48C7C2，执行ret指令。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkV6FMy4ECvqaTxpqHxVJCBrC4uQicUfjic0QeB6HROFvXMpGHeulLI4FYA/640?wx_fmt=png&from=appmsg)

ret指令执行后跳转到19eec4处，fs段寄存器偏移0x30h，可以找到PEB。第一个fs:[30h]+2指向了PEB的BeingDubgged，BeingDubgged=1的时候就是被调试。

19eec4来源说明：
在执行411658处指令之前，堆栈中已经存在19eec4，看堆栈可知是41160f函数的参数。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVuwEktvicPfJhu1ZHeNZqgK1HBxQ67NwcFVfaN6ibIX3811WHOYW3PNiaA/640?wx_fmt=png&from=appmsg)
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkV4RoN3MrbEAhpOxNZGKpktIqYoSHN7RiaDaKVOOPJ0LA91TgDPhWGq0Q/640?wx_fmt=png&from=appmsg)

接着看19EEC4处指令，绕过反调试后（BeingDubgged修改为0）获取第二段shellcode地址跳转执行。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVp9mH4558CtOep30hUtCuaTu28ss7aOv0iah5UyTbRwKP7uVvKI9icYicA/640?wx_fmt=png&from=appmsg)

获取pe写入"C:\ProgramData\Microsoft\DeviceSync\mcods.exe"

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVul1WzIBk3OCyjJLPvnGsJrG65LiblicMGACO5FEGaNWicL2PMoibnquQwA/640?wx_fmt=png&from=appmsg)

添加到自启动项

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVtozQFqQtEeV1DnIpCNG24hCHm3YAPUBib9BWqsL4a45w0WP4XnLrZtA/640?wx_fmt=png&from=appmsg)
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVVpJPdaM2ER38iavsC1MPRrSAn9FXQwhBpUBXogaqCvrhPs8Rm1wDJMg/640?wx_fmt=png&from=appmsg)

调用ShellExecuteA函数执行命令“forfiles.exe /p c:\windows /m twain\_32.dll /c c:\windowsuser\..\programdata\microsoft\deviceSynC\mcods.exe”

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVicibswkYtdGJqHictwp1YuLMqFviauBXfl2aYUiaK5hHnbJ2OkyJIfviamIA/640?wx_fmt=png&from=appmsg)

### mcods.exe分析

隐藏窗口。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVzrELybCBN3r7GE9VibsMdwGF2icsorYTiaksor8utjOHzqD5EHE9wFictw/640?wx_fmt=png&from=appmsg)

判断是否是中国时区。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkV4nKdJsaIe0cAlDeM3j2k850QNMicuEYgXKEkBJkqHJjPjJAuZiczFMDA/640?wx_fmt=png&from=appmsg)

如果是中国时区执行sub\_408E80函数。

#### sub\_408E80

创建rendumm互斥体。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkV54OcH6AicZV0AeuyV3uH35GrtQdKMLia0lfxqEUYK15eKhSibH7iawzNicg/640?wx_fmt=png&from=appmsg)

解密出UserAgent，获取uuid。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkV8OlQmWUgeHrqUDocm3Tqpjov7798JfWBCuFFMyUYIGOnwlRqfQQBwQ/640?wx_fmt=png&from=appmsg)

获取用户名和计算机名。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVGttVHwb83kQnHfU2pUBvrgVZVAtzdO2YxGr3z0vPnQujNI76pz9sJw/640?wx_fmt=png&from=appmsg)

获取系统版本，本机ip地址，后门版本。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVxrxqKI336y1VcOz3ASjtFlbU8TOiadF77Jic9SYicpVTMOhmqLdJpF09A/640?wx_fmt=png&from=appmsg)

拼接出字符串如下图随所示。格式：uuid=用户标识#un=用户名#cn=计算机名#on=系统版本#lan=本机IP地址#nop=#ver=后门版本

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVJWtFPGA4YcJtcOc4b2Qka8A5GC0TdlG7jhtdYR3J3eqWBiaNC4ACpDA/640?wx_fmt=png&from=appmsg)

创建线程，将获取的信息作为线程函数参数传递。线程函数：将信息AES加密+base64+指定位置加入=或者&。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVicB6Ivla8nhVL5ReE5LLaNaprAs6Sd9rAh2rEq7O4PtPcA933XymuOA/640?wx_fmt=png&from=appmsg)

使用http协议post上传加密信息到C2服务器。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVLpib86TEON9sz4ibUe9ibXTlicWsV3e6TDA1oDH1JpGX4Nt1sulAIQETcQ/640?wx_fmt=png&from=appmsg)
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVJLibvOSE7Lfs6gpxZu6kCzohKEfLwrrRnGH67ZFBiacUZnxzRUrM379g/640?wx_fmt=png&from=appmsg)

除了上述获取的信息外，mcods.exe还会收集以下信息。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkVdk2gWBq0JTbZbx6ufklvKW1RGia0q7HsdRfNDwjVBSbVSnRDn7g2zpw/640?wx_fmt=png&from=appmsg)

写入到temp路径下的BdZ22x.tmp文件中。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GIHyrCqRufSwZKotZHJgkV0hickWFJ5yOZ6AfQx88rhBleurKW6WUnEejZYGbN67Nlic181N10H30g/640?wx_fmt=png&from=appmsg)

之后读取BdZ22x.tmp文件，AES加密+base64，上传文件。

![](https://mmbiz.qpic.cn/sz_mmbiz_png...