---
title: 【技术原创】Sophos XG防火墙身份验证绕过漏洞(CVE-2022-1040)利用分析
url: https://www.4hou.com/posts/WBBJ
source: 嘶吼 RoarTalk – 回归最本质的信息安全,互联网安全新媒体,4hou.com
date: 2022-11-03
fetch_date: 2025-10-03T21:36:48.903480
---

# 【技术原创】Sophos XG防火墙身份验证绕过漏洞(CVE-2022-1040)利用分析

【技术原创】Sophos XG防火墙身份验证绕过漏洞(CVE-2022-1040)利用分析 - 嘶吼 RoarTalk – 网络安全行业综合服务平台,4hou.com

[![](https://www.4hou.com/sihou/images/new4hou/newlogoss.png)](https://www.4hou.com)

* [首页](https://www.4hou.com)
* [企业中心](https://www.4hou.com/corp/newindex)
* [产业研究院](https://www.4hou.com/real-time)

![](https://www.4hou.com/sihou/images/new4hou/search-icon.png)

[投稿](https://www.4hou.com/contribute)

[登录](https://www.4hou.com/login)
  |
[注册](https://www.4hou.com/register)

* 导读 ▾
* [活动](https://www.4hou.com/newticket)
* [专题](https://www.4hou.com/category/special)
* [图谱](https://www.4hou.com/atlas/index)
* [报告](https://www.4hou.com/new-report-info)
* [嘶票](https://www.4hou.com/tickets)
* [嘶货](https://www.4hou.com/shop)
* [企业查询](https://www.4hou.com/corp/new-search-company)
* [招聘](https://www.4hou.com/recruit)![](https://www.4hou.com/sihou/images/1561626446625934.png)

* [新闻](https://www.4hou.com/category/news)
* [行业](https://www.4hou.com/category/industry)
* [趋势](https://www.4hou.com/category/observation)
* [访谈](https://www.4hou.com/category/people)
* [漏洞](https://www.4hou.com/category/vulnerable)
* [WEB安全](https://www.4hou.com/category/web)
* [业务安全](https://www.4hou.com/category/business)
* [系统安全](https://www.4hou.com/category/system)
* [内网渗透](https://www.4hou.com/category/penetration)
* [勒索软件](https://www.4hou.com/category/typ)
* [安全工具](https://www.4hou.com/category/tools)

# 【技术原创】Sophos XG防火墙身份验证绕过漏洞(CVE-2022-1040)利用分析

3gstudent
[技术](https://www.4hou.com/category/technology)
2022-11-02 12:00:00

![](https://img.4hou.com/article/%E6%B5%8F%E8%A7%88.png)171795

收藏

导语：CVE-2022-1040是一个Sophos XG防火墙的身份验证绕过漏洞，漏洞细节可参考《CVE-2022-1040 Sophos XG Firewall Authentication bypass》，本文仅在此文章的基础上补全文中未提到的技术细节。

**0x00 前言**

CVE-2022-1040是一个Sophos XG防火墙的身份验证绕过漏洞，漏洞细节可参考[《CVE-2022-1040 Sophos XG Firewall Authentication bypass》](https://blog.viettelcybersecurity.com/cve-2022-1040-sophos-xg-firewall-authentication-bypass/)，本文仅在此文章的基础上补全文中未提到的技术细节。

**0x01 简介**

本文将要介绍以下内容：

本地恢复带有漏洞的调试环境

OpCode的寻找方法

WAN和VPN区域的利用思路

开启login disclaimer切断利用链

**0x02 本地恢复带有漏洞的调试环境**

在本地搭建漏洞环境时，如果自动更新了补丁，可通过以下方式恢复成带有漏洞的调试环境：

编辑文件/usr/share/webconsole/WEB-INF/web.xml

定位以下内容：

![image.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20220824/1661328244134562.png "1661328032187961.png")

这里使用RequestCheckFilter用来过滤request请求中JSON参数是否包含不可见字符。

可以手动删除以上代码，恢复成带有漏洞的调试环境。

无法直接修改文件/usr/share/webconsole/WEB-INF/web.xml

在修改文件前需要重新挂载：mount -o remount,rw /

再次修改文件即可。

**0x03 OpCode的寻找方法**

原文中提到：CSC端大概有1200种模式在运行，其中有161种模式的响应类型为2

这里可以通过反编译EventBean.class找到如下代码：

![image.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20220824/1661328245507330.png "1661328070113608.png")

经过分析后，响应类型对应的应该为requesttype，而不是responsetype

查询符合条件数据的完整命令：

![image.png](https://img.4hou.com/uploads/ueditor/php/upload/image/20220824/1661328245203610.png "1661328088391871.png")

输出内容：

```
              opcode                 | mode | requesttype---------------------------------------+------+------------- set_system_date                       |  271 |           2 update_l2tp_connection                |  227 |           2 update_pharming_protection            |  259 |           2 export_connection                     |  238 |           2 migrate_group_to_cyberoam             |  407 |           2 group_policy_mapping                  |  408 |           2 migrate_group_summary                 |  409 |           2 migrate_group_add                     |  410 |           2 change_gui_language                   |  127 |           2 tooltip                               |  454 |           2 wizardopmode                          |  156 |           2 wizardbridgemodezoneaction            |  157 |           2 wizardinterface                       |  158 |           2 wizardinternetaccess                  |  159 |           2 wizardnotification                    |  160 |           2 wizardtimezoneconf                    |  161 |           2 wizardfinish                          |  162 |           2 sslvpn_liveuser_logout                |  240 |           2 migrateuser_csvupload                 |  503 |           2 DownloadMyAccountQuarantineMail       |  463 |           2 download_certificate                  |  250 |           2 load_new_firmware                     |  243 |           2 cancel_firmware_upload                |  184 |           2 CUSTOMER_REGISTRATION_REQUEST         |  176 |           2 APPLIANCE_REGISTRATION_REQUEST        |  175 |           2 TRAIL_SUBSCRIPTION_REQUEST            |  177 |           2 SUBSCRIPTION_REQUEST                  |  178 |           2 RELEASEQUARANTINEMAILFROMMAIL         |  458 |           2 import_group                          |  406 |           2 download_ca_certificate               |  361 |           2 theme_apply                           |  323 |           2 login                                 |  151 |           2 myaccount_login                       |  451 |           2 Download_AV_MyACQuarantineMail        |  472 |           2 Download_AV_MyACQuarantMailOld        |  186 |           2 DownloadMyAccountQuarantMailOld       |  192 |           2 release_quarantine_my_ac              |  488 |           2 release_quarantine_my_ac_old          |  489 |           2 checkForApplianceUpgrade              |  602 |           2 Download_AV_QuarantineOldMail         |  189 |           2 download_backup                       |  466 |           2 dryrun_new_firmware                   |  183 |           2 download_ctr                          |  704 |           2 REGISTRATION_SYNC_WITH_SERVER         |  181 |           2 ccc_opcode_request                    | 1500 |           2 Download_AV_QuarantineMail            |  471 |           2 download_old_spam                     |  493 |           2 ReleaseQuarantineMail                 |  460 |           2 ccc_compress_dir                      | 1502 |           2 ccc_appliance_login                   |  603 |           2 ccc_login                             | 1503 |           2 delete_file                           | 1505 |           2 add_protocol_group                    |  961 |           2 update_protocol_group                 |  962 |           2 add_application                       |  963 |           2 update_application                    |  964 |           2 add_protocol_identifier               |  965 |           2 reset_to_default                      |  966 |           2 ccc_flush_sql_file                    | 1501 |           2 verify_manual_update_content          |  139 |           2 login_disclaimer_action               |  716 |           2 resend_crederntials                   |  952 |           2 sms_gw_test_connectivity              |  954 |           2 generate_captcha_code                 |  958 |           2 ccc_opcode_pull_request               |  605 |           2 renew_guest_user                      |  953 |           2 add_guest_user_log_msg                |  956 |           2 failed_sms_log                        |  957 |           2 add_guest_user                        |  746 |           2 sms_status_log_msg                    |  955 |           2 dns_static_entry_add                  |  142 |           2 update_cisco_ipsec_connection         |  344 |           2 dns_static_entry_update               |  143 |           2 system_backup_for_CCC                 |  604 |           2 usbmodem_setting_gui                  |  185 |           2 download_crl_certificate              |  350 |           2 web_cat_domain_import                 |  421 |           2 web_cat_keyword_import                |  422 |           2 wDNSServerConfiguration               |  522 |           2 getmodemdetail                        |  423 |           2 sslvpn_logout                         |  405 |           2 iview_login                           |  385 |           2 create_virtualhost_rules              |  767 |           2 create_user_iphone_ipsecprofile       |  345 |           2 CyberoamIPSAutoUpgrade                | 1202 |         ...