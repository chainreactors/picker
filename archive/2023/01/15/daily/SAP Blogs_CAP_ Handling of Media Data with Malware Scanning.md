---
title: CAP: Handling of Media Data with Malware Scanning
url: https://blogs.sap.com/2023/01/14/cap-handling-of-media-data-with-malware-scanning/
source: SAP Blogs
date: 2023-01-15
fetch_date: 2025-10-04T03:56:42.595652
---

# CAP: Handling of Media Data with Malware Scanning

* [SAP Community](/)
* [Products and Technology](/t5/products-and-technology/ct-p/products)
* [Technology](/t5/technology/ct-p/technology)
* [Technology Blog Posts by SAP](/t5/technology-blog-posts-by-sap/bg-p/technology-blog-sap)
* CAP: Handling of Media Data with Malware Scanning

Technology Blog Posts by SAP

All communityThis categoryBlogKnowledge baseUsersManaged tags

cancel

[Turn on suggestions](https://community.sap.com/t5/blogs/v2/blogarticlepage.enableautocomplete%3Aenableautocomplete?t:ac=blog-id/technology-blog-sap/article-id/164365&t:cp=action/contributions/searchactions)

Auto-suggest helps you quickly narrow down your search results by suggesting possible matches as you type.

Showing results for

Search instead for

Did you mean:

We have just launched our new Developer forums! Check out more in
[this What's New post](https://community.sap.com/t5/what-s-new/new-developer-forums/ba-p/14230147) (This banner is now dismissible.)

Read only

## [CAP: Handling of Media Data with Malware Scanning](/t5/technology-blog-posts-by-sap/cap-handling-of-media-data-with-malware-scanning/ba-p/13569965)

![Ajit_K_Panda](https://avatars.profile.sap.com/d/1/idd1af3570ab5bb3989d673b6d8c6f5694a20b5738460036d1f11cdae23d7c6864_small.jpeg "Ajit_K_Panda")

![Product and Topic Expert](/html/@138D6F765B60D7FC0168643DE27D8A68/rank_icons/sap-logo-small-14px.png "Product and Topic Expert")
[Ajit\_K\_Panda](https://community.sap.com/t5/user/viewprofilepage/user-id/16653)

Product and Topic Expert

Options

* [Subscribe to RSS Feed](/khhcw49343/rss/message?board.id=technology-blog-sap&message.id=164365)
* Mark as New
* Mark as Read
* Bookmark
* Subscribe
* [Printer Friendly Page](/t5/blogs/blogarticleprintpage/blog-id/technology-blog-sap/article-id/164365)
* [Report Inappropriate Content](/t5/notifications/notifymoderatorpage/message-uid/13569965)

‎2023 Jan 14
3:14 PM

[14
Kudos](/t5/kudos/messagepage/board-id/technology-blog-sap/message-id/164365/tab/all-users "Click here to see who gave kudos to this post.")

4,857

* SAP Managed Tags
* [SAP Cloud Application Programming Model](https://community.sap.com/t5/c-khhcw49343/SAP%2520Cloud%2520Application%2520Programming%2520Model/pd-p/9f13aee1-834c-4105-8e43-ee442775e5ce)
* [SAP BTP, Cloud Foundry runtime and environment](https://community.sap.com/t5/c-khhcw49343/SAP%2520BTP%252C%2520Cloud%2520Foundry%2520runtime%2520and%2520environment/pd-p/73555000100800000287)

* [SAP BTP, Cloud Foundry runtime and environment

  SAP Business Technology Platform](/t5/c-khhcw49343/SAP%2BBTP%25252C%2BCloud%2BFoundry%2Bruntime%2Band%2Benvironment/pd-p/73555000100800000287)
* [SAP Cloud Application Programming Model

  Software Product Function](/t5/c-khhcw49343/SAP%2BCloud%2BApplication%2BProgramming%2BModel/pd-p/9f13aee1-834c-4105-8e43-ee442775e5ce)

View products (2)

![](/legacyfs/online/storage/blog_attachments/2023/01/cap-media-malware.png)

Media Data with Malware Scanning

### **Introduction**

During digital transformation, every business uses a diverse set of technologies to build application to digitize non-digital processes and operations. The "Cloud Application Programming Model" (CAP) offered by SAP can be used to develop enterprise-grade cloud services or applications and deploy on the SAP Business Technology Platform (BTP). You can learn more about CAP by visiting [this page](https://cap.cloud.sap/docs/about/).

In almost every application, one or more business documents are uploaded. These documents or files need to be check for virus or other malware. SAP provides a service called ‘[SAP Malware Scanning Service](https://discovery-center.cloud.sap/serviceCatalog/malware-scanning-service?service_plan=clamav&region=all&commercialModel=cloud)’ on BTP to scan business documents for malware.

In this blog post, we'll look at how to create a cap application that allows users to upload files and check them for malware using the SAP Malware Scanning Service.

### **Develop and Deploy application**

Often project templates are used to generate the skeleton of a CAP application. But this time we shall see how we can create an application using command line. If you don't want to follow step by step, you can find the complete project [here](https://github.com/SAP-samples/btp-cap-demo-usecases/tree/main/cap-media-malware).

* If you are using local set up instead of SAP Business Application Studio (BAS), then install cap development kit:  ***npm install -g [@Sisn](/t5/user/viewprofilepage/user-id/1387241)/cds-dk***
  use cds --help command to verify installation is successful. Also install rimraf package which is used later using ***npm install -g rimraf***

* Create a project using ***cds init cap-media-malware*** command where cap-media-malware is the project name. It creates the project layout with a project descriptor package.json, folder app for UI content, folder db for database related artifacts and folder srv for service related content. You can modify your project description in ***package.json*** descriptor file.

* Install the dependencies using ***npm install*** command

* Make sure you are on cap-media-malware folder in terminal. Then create a file using command ***touch db/schema.cds*** and fill with following content:

  ```
  namespace cap.media.db;

  using {cuid} from '@sap/cds/common';

  entity MediaFiles : cuid {

      @Core.MediaType   : type

      content : LargeBinary;

      @Core.IsMediaType : true

      type    : String;

      filename: String;    }​
  ```

  Note-1, cuid aspect is used to add universally unique primary key to the entity.
  Note-2, MediaFiles entity needs to be annotated with following annotations to indicate that a field contains media data.
  ***@Core.MediaType***: Indicates that the element contains media data
  ***@Core.IsMediaType***: Indicates that the element contains a MIME type

* Create service definition file using touch srv/service.cds command and add following content

  ```
  using { cap.media.db as db } from '../db/schema';

  service MediaService {

      entity MediaFiles as projection on db.MediaFiles;

  }​
  ```

* SAP Malware Scanning Service provides REST based apis to scan document for malware and api definition is described in [OpenAPI](https://www.openapis.org/) Hence, we will use OpenAPI client generator feature of SAP Cloud SDK for Javascript to consume service apis. You can find more information about SAP Cloud SDK [here](https://sap.github.io/cloud-sdk/docs/js/features/openapi/overview).

* Go to SAP Malware Scanning Service on API Business Hub, download OpenAPI specification from [here](https://api.sap.com/api/MalwareScanAPI/overview) and save as MalwareScanAPI.json.

* Create folders to keep api specifications and api clients using following command
  ***mkdir srv/resources***
  ***mkdir srv/resources/api-specs***
  ***mkdir srv/resources/api-clients***
  Copy MalwareScanAPI.json file downloaded in previous step into api-specs folder.

* Install SAP Cloud SDK OpenAPI code generator dependencies using following commands:
  ***npm install [@Sisn](/t5/user/viewprofilepage/user-id/1387241)-cloud-sdk/openapi-generator --save --D***
  ***npm install [@Sisn](/t5/user/viewprofilepage/user-id/1387241)-cloud-sdk/openapi --save***

* Generate api client for Malware Scanning Service based on the imported specification using below command:
  ***npx openapi-generator -t -i srv/resources/api-specs/MalwareScanAPI.json -o srv/resources/api-clients***

* Now let’s add logic in service implementation to scan documents before it is updated in db.
  Create service implementation using touch srv/service.js and copy following code:

  ```
  const cds = require("@sap/cds");

  const apiMalwareScan = require("./resources/api-clients/MalwareScanAPI/default-api")

  const { PassThrough } = require('stream')

  module.exports = cds.service.impl(async function (srv) {

    const { MediaFiles } = this.entities;

    srv.on('PUT', MediaFiles, async (req, next) => {

      const url ...