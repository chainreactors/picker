---
title: 首度揭示！个性化视频技术——短视频体验的秘密！
url: https://mp.weixin.qq.com/s?__biz=MzI1MzYzMjE0MQ==&mid=2247511620&idx=1&sn=806d388134cfad4cb50a91e1d05b693b&chksm=e9d365a6dea4ecb0894d87c5e78a959351ec0ec557f614dbdc41e65f63994e917c68845df28d&scene=58&subscene=0#rd
source: 字节跳动技术团队
date: 2024-11-21
fetch_date: 2025-10-06T19:17:34.878670
---

# 首度揭示！个性化视频技术——短视频体验的秘密！

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/5EcwYhllQOhDuvDb22vCrA6Xra6nfJCtaFYPNFWI3l0F9T6FJJmn285rUAZrfCgMAQNNBR450u7MruZOG5eV0Q/0?wx_fmt=jpeg)

# 首度揭示！个性化视频技术——短视频体验的秘密！

原创

字节互娱基础体验

字节跳动技术团队

短视频在过去数年内成为主流的内容创作和信息分发渠道之一， 字节跳动提供独特的视频播放体验，吸引了全球数十亿用户， 一项重要的贡献因素是其先进的个性化视频技术。过去五年间，团队完整开创了这一崭新的技术领域以优化用户体验， 在此我们首次向业界披露个性化视频技术区别于传统音视频技术的主要概念和部分方法， 希望对整个行业有所启发。本文系“个性化播放技术”的中文精简版，欲了解更详细内容可参考原论文。论文链接：https://arxiv.org/abs/2410.17073（复制到浏览器打开，也可点击文末**阅读原文**，直接跳转）

# **背景**

过去的若干年间，音视频服务重在提供基础的视频转码与分发能力，行业的注意力主要集中在四个方向。

• 编解码器标准的演进、前后处理算法的研究与开发。例如MPEG-2、RMVB、264/AVC、 265/HEVC、266/VVC、VP9、AV1、AV2等视频编解码器，MP3、AAC、HEAACv1/v2、XHEAAC、OGG等音频编解码器，Jpeg、WebP、Heif等图像编解码器，以及前后处理方面的大量工作如超分、降噪、色彩增强、ROI区域分析等。

• 流媒体传输协议的演进。一些取得广泛影响与应用的协议包括RTP/RTSP、MPEG2-TS、RTMP、HLS、DASH、SRT、RTC等。

• 多媒体框架。例如DirectShow（Microsoft）、Helix（Realnetworks）、MediaFramework（Google）、AVFoundation（Apple）、FFMpeg、VideoLAN、Gstreamer等。

• 云服务。许多公司往往以弹性计算平台为基础，提供基于容器镜像模式或者基于serveless模式的服务，允许计算图式的任务分配与调度，用以灵活地处理转码与前处理任务，并以此为核心构建包含元数据、上传、转码与下发服务、CDN、播放SDK、埋点分析等在内的端到端能力集，供业务使用，相似地，Brightcove、AWS、Azure和Google Cloud等供应商也展开了基于云的音视频服务，供各种规模的公司快速集成与应用。

除此之外，还有一些与音视频技术相关的重要工作，例如信号调制、DRM保护、芯片开发等，与上述各方向之间均存在关联、其发展轨迹亦相互影响，不赘述。

在控制与决策优化方向上，工业界和学术界曾有许多尝试，例如自适应比特率（ABR）算法方案和改进等，在编码方面则有Netflix、Brightcove从2015年开始发表的一系列工作，让Content Aware Encoding和Context Aware Encoding成为业界编码优化工作的范式，但以上工作仍过于局部、零散，并不能充分解决短视频遇到的问题。

在短视频服务的研发方面，我们面临前所未有的挑战：

* 投稿数量及其差异性。短视频应用拥有每天亿级别以上的UGC投稿，其内容和质量千差万别，真实地代表了整个世界的多样性。许多问题及其解法、总结出的规律是在小得多的规模上进行的，但在我们的规模下却距离理想状态差之甚远。
* 用户数量及其多样性。世界上每天有数十亿用户使用短视频，其使用方式与人为偏好存在巨大方差，并由于给予应用的反馈信号虽然数量繁多，但蕴含的信息稀疏且有限，相关干预的效果易被掩盖。
* 复杂业务形态带来的收益与成本约束。短视频应用承载了极为复杂的业务，包括广告、电商、直播打赏、生活服务、搜索等等，同时视频的处理、存储与分发所带来的成本极高，视频技术应当聚焦提升用户体验，进而提升业务指标，同时平衡与成本之间的关系。

通过引入众多在推荐、广告、用户增长等领域飞速发展的个性化技术，与“传统”音视频技术进行结合，字节跳动从2019年开始第一次构建完备的个性化视频技术体系，带来了根本性的范式转变，在内部评估和市场竞争中均取得了优异的结果。

# **总述**

## 1. 方法论

沃伦·巴菲特曾经论断，企业的价值，甚至任何资产的内在价值，本质上是其未来现金流以适当利率折现的现值，其形式可写为：

仿照该论断，假设某个用户在时间对业务的营收贡献原本是，而通过某技术领域的工作，对该用户业务营收贡献的影响增益为，即有了该技术后用户业务贡献从增长为，则该技术对用户的增益价值可以表示为：

那么，对于类似短视频这样的toC公司而言，整个公司的价值可以表示为对所有潜在用户营收折现的总和，则该技术领域的工作，在于最大化（正向）所有用户影响的一个总和：

注意，以上公式系为便于理解问题所作的概念性描述，我们无论新构建一个系统、进行组件改造或者更换一种策略，都应当评估对用户的影响、对业务指标与成本的影响，计算收益增量。此外，这里存在一些明显的约束，例如技术成本和各业务的可投成本，即考虑边际效应、募集周期和市场上限：

个性化视频技术的理念在于，对不同用户，根据对其偏好和习惯的理解，综合考虑观看内容、时间、场景、设备、网络等所有影响维度，对音视频领域所具有的不同技术进行重新估计与选择性运用，提供整体最优效果。即以控制和决策为核心，强调整体最优、强调对不同用户及其相关影响维度采用不同技术。与之对应，传统音视频领域的工程实践未对不同用户的差异化诉求予以足够关注和满足，往往以固化的框架和能力为核心，寄希望于发展通用、统一的技术提供给用户，或陷于局部较优的方案，这在高用户规模、高偏好方差的视频应用体系中将丧失巨大的提升空间。

基于以上理解，我们重新设立了个性化视频技术的工作流程，参考图2-1，在此流程中将针对每次改进评估其用户影响，这不是一个很新的思路或者方法，但将这套方法置于核心地位，以此驱动传统的编解码、协议、框架、服务等开发工作，则属于首创，借助字节跳动数据驱动的文化和相应工具（例如AB实验平台）得以实现。

![](https://mmbiz.qpic.cn/mmbiz_jpg/5y2rPFak32sTBS9ic9SVnmVPlCicQHGdYFC8K9icuiawAGNQicFROqkBWoMWsNmJSr2lALeOQ5Etes4TDmmyYepnGYg/640?wx_fmt=other&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

图2-1 个性化音视频技术工作的通用流程

## 2. 目标定义

从通用角度看，ToC的社交媒体类业务广泛使用（Life Time）表示一段时间内用户的活跃情况，以及使用（Average Revenue Per User）表示每用户平均收入，此处为后文讨论方便，我们做一简化，即设定短视频业务的整体目标为（Life Time Value）：

用户反应类的指标提升，如时长、投稿数等，实际反映了用户是否对服务满意，此类指标均可以考虑折算为，所有营收类的指标均折算为。因此可以设立收益指标代表一项工作为业务带来的改变：

这里表示ROI系数。

基于上述目标，我们设立二级指标，音视频领域大家会观测EBVS（Exist Before Video Start）、VPF(Video Playback Failures)、VST(Video Startup Time)、Rebuffering Ratio等不同指标。但我们认为这并不足以刻画用户的信息，也并不能完整反映用户播放过程中的状态变化，因此会设立一个更为全面、开放的指标组（Quality of Performance）表示多维度的完整性能体验。具体定义参见表2-1 ，同时也会估计不同性能指标对业务指标的影响。

![](https://mmbiz.qpic.cn/mmbiz_png/5y2rPFak32sTBS9ic9SVnmVPlCicQHGdYFhhJUPB8p4GAupMP5EUib3rB6YrGYnQjwia0yRyYyr4qwyu7Y93Z9dUUQ/640?wx_fmt=other&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

表2-1 部分性能指标定义

注意，以上表格内并非全部指标，其影响幅度将随业务发展阶段与环境而变化，指标组所涵盖的指标会发生增减，变更影响幅度也可能发生大幅改变。

在评估环节，我们将对每个项目计算profit和ROI，并根据业务场景和目标设定不同的调控不同的成本价值。并令其满足以下上线条件：

1. 1.
2. 2. 可归因。性能指标组的观测中给出符合预期的原理解释。评估方式主要以线上AB实验（包括正向实验、反转实验）为主，辅以问卷调查、反馈统计、AA对比、指标监控、变动归因等方法进行。

基于以上原则，我们会放弃部分较新但不实用的技术，构建一系列复杂度远超常规的方案，实践证明，内部观测到的收益和市场竞争表现都相当突出。

## 3. 端到端工作框架

传统上端到端的音视频技术体系将链路划分成多个环节，包括投稿、转码、分发、调度、播放等环节，一种典型的系统架构如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/5y2rPFak32sTBS9ic9SVnmVPlCicQHGdYFM8Fbs0CYOCEQRCZ37cIw4BCLg7tuqbdCIgqqamtdn8DkWnWNAfJNOA/640?wx_fmt=other&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

图2-2 AWS的VOD Streaming架构

在我们的系统上会格外强调控制与决策，以及对用户的影响，并且我们认为每个子领域均与其他子领域存在面向个性化体验的统筹优化空间，仅仅由于复杂的链路从而导致不能直接进行整体建模，但每个子领域仍需对其他环节进行深度理解和配合，逼近整体建模的效果，概念性的划分图如下：

![](https://mmbiz.qpic.cn/mmbiz_jpg/5y2rPFak32sTBS9ic9SVnmVPlCicQHGdYFQ9D3QSDdlxSaV6swrJU8C9EJhlXIicic3icCibiagzygKLVDhzuy8sibwM9w/640?wx_fmt=other&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

图2-3 个性化音视频技术的概念性架构图

在上图所示的架构中，我们认为下发、调度、传输、下载与播放相关的策略应当统筹看待，因此把这一子领域命名为Personalized Streaming & Playback，对转码相关的决策领域命名为User-Item Aware Encoding，同时把投稿相关的编码和传输策略命名为Foresight Based Publishing。

个性化从技术角度则是策略化，策略优化在个性化目标下通常包含以下角度：

* User：对不同用户提供的策略方法不同，此处还可细分为投稿者、消费者、甚至投稿者 x 消费者等维度。
* Item：对每个Item（在短视频应用中的视频——其他消费体裁如图文等类同）做差异化的处理，进而在User x Item维度上提供不同效果。
* Context：即用户消费的场景、个人状态、外部环境等，在User x Context、Item x Context（较少）或者User x Item x Context维度上形成差异化。

对不同决策干预点而言（上图中每个子领域内都至少有数个乃至数十个不同的干预点，后文章节中将择要介绍部分干预位置），其优化水平可以按粒度划分为以下层次：

* Rule-based level：根据简单、明确、有限的规则，对部分User、部分Item或部分Context情形下采用不同策略。
* Portrait based level：对不同的User、Item，可能会筛选出同质的群组，对不同群组采用不同的策略，画像可以通过数据分析、挖掘，或者模型筛选的方式生成。
* Individual level：对单一的UserItem、Context下采用不同的策略，通常需要使用机器学习、深度模型等技术。
* 其中不同层次之间可能存在交错，例如，画像不仅可以单独使用，仍然可以作为Individual处理的特征输入。
* 以上体系可由基础数据、规则、特征、画像、模型（或特定算法模块）等内容组合构建，并且在服务端、客户端均具备相应能力，用以支持各个策略模块的统筹决策。

  ![](https://mmbiz.qpic.cn/mmbiz_jpg/5y2rPFak32sTBS9ic9SVnmVPlCicQHGdYFPqM6V5hw7Pjosg4m4YmfAPeo6F8BokbBonGsbhEAjjGVp2najpZMTw/640?wx_fmt=other&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  图2-4 支持个性化音视频技术的方式

在上述系统的设立与构建的基础上，可以按照优化问题的一般工作思路对整个视频播放工作进行拆解和拓展，我们根据工作便捷性可以定义了以下维度，后文将尽力从这些视角介绍：优化目标（Object）;干预选项/动作（Treatment/Action）;信号/状态（Feature/State）;优化方法（Method）

# **个性化流媒体&播放技术**

在推荐算法或者用户选择决定了播放内容（Item List）的前提下，整个流媒体播放服务可视为主要包含Delivery，Scheduling，Streaming & Playback三个环节，根据视频Item当时所具有的档位（Ladder）基础上，对调度、传输和播放的相关逻辑进行个性化、算法化优化，能够有效提升播放体验、降低成本，最终提升整体业务收益。

* 按需下发（On-Demand Delivery）
* CDN调度（Personality Quality Scheduling）
* 流媒体播放（Personalized Streaming & Playback）

  ![](https://mmbiz.qpic.cn/mmbiz_jpg/5y2rPFak32sTBS9ic9SVnmVPlCicQHGdYFLRQHFWqPmibibyvZEfHtw1icb54e0d0oPIxlJrsbytBo3O62pibMN3w91g/640?wx_fmt=other&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  图3-1 个性化流媒体播放模块示意图

上述播放服务的优化目标可用下式所示：

其中，

* 包含所有相关状态，包括User、Item、Context等维度状态。
* 表示动作集合，包括下发、调度、流媒体播放等所有模块上的动作。
* 表示为在状态条件下选择动作的策略。
* 表示在整体状态下，按照策略执行动作，用户播放内容列表的相关性能体验的期望。
* 包括具体的视频内容和档位文件。内容由推荐算法和用户选择决定，档位由转码服务决定。
* 表示用户在整体状态下以的性能体验观看内容列表后能获得的业务价值的期望。所以对所有用户的业务价值的总和即表示产品的总业务价值。
* 表示在整体状态下，按照策略执行动作，所带来的成本的总和，在本章的部分问题中，整体成本与每所带来的成本之和相等，我们只需关注单一用户甚至其每次播放动作相关的影响即可，但另一些问题中由于存在明确约束，需要关注的是成本总和。

整个流媒体播放的优化工作即为寻找最优的策略，同时为可执行性考虑，需要在各个环节中均保证的迭代可以以一种持续、贪心的方式增加。

## 1. 个性化流媒体 & 播放

### **问题**

根据短视频应用的特点，信息流播放占据绝大多数的用户时长。在信息流播放过程中，一次信息流请求会获取一个排序过的Item List，供用户顺序观看（用<user，item>表示一次播放），播放器理应依据对观看行为的预判，提前下载每个视频最可能被看到的片段，并提前准备播放相关组件，以保障列表中的各个视频的启播速度、流畅度、画质等效果，即，优化目标不再是单次播放的效果，而是用户在整个播放序列中的综合体验。

### **方案**

**思路**

对于客户端的下载、播放策略优化，业界一般以或者某几项指标加权求和的为建模目标，历史工作一般集中于基于ABR、缓存控制等下载相关动作的控制，但往往和真实用户的体验与业务目标偏差较大，对下载过程中的用户、视频以及上下文信息利用不足，同时对播放过程如解码、渲染等过程控制阙如，更遑论联合优化。我们期望直接以业务目标建模，同时由于在客户端可以近似忽略全局性约束，因此能够以单用户最大化为目标：

其中，

* 表示所有在客户端执行的动作集合，如是否超分、是否预先渲染、是否预下载、下载大小等，由于某个动作选择会对多个体验维度产生影响，相应动作空间维度极高，实践中需要分治，但亦需在重要维度统筹。
* 表示包含用户状态如设备评分、播放器缓存、消费画像，视频状态如视频列表中的码率、画质、音频响度、预测消费时长等，Context如业务场景、网络环境等。
* 表示状态空间内用户的状态。
* 表示用户对所获得的收益。
* 表示用户在不同状态下选择动作，提升的策略，此处可分为两种优化路径：

1.类比于传统思路保持大部分维度较少劣化的情况下大幅优化其一个或多个维度，从而撬动整体收益提升，我们将传统的优化升级为，即将的映射构建为，引入各种特征优化，以获得业务提升。

2.考虑用户偏好的个性化优化方法，可以概括为“发现不同用户/场景对不同维度性能体验的偏好优化对映射的建模迭代策略参数获得收益”。

**动作空间**

客户端流媒体优化动作空间的动作，可以根据执行的主要是下载，还是对播放器其他环节的操控粗略地分为下载动作和播控动作。

在短视频应用中，需要保证决策动作的完备收集，即考虑所有对目标具备一定影响强度的因素（动作），一种可行的梳理方式是面向所有工程模块（组件或组件内的代码块），及其占有CPU、GPU、IO、Memory、Disk、Socket等资源的维度构建矩阵，对矩阵元素遍历，评估是否存在不同实现方式或者接受不同参数范围，并估计其对指标的影响幅度，影响幅度前列者即纳入决策范围。

* 表示某个工程模块的第种实现方法对第个资源的使用量。
* 表示带来的影响。
* 表示取影响最大的TopK个。
* 则是对应的（（工程模块，实现），资源）对的列表，即我们期望决策的动作。

**状态空间**

状态空间中的状态即是策略所需的特征信号，更大的状态空间通常意味着更高的优化上限。为了实现个性化的目标建模与策略优化，在状态空间的构建时应当系统化考虑Rule-based、Portrait based、I...