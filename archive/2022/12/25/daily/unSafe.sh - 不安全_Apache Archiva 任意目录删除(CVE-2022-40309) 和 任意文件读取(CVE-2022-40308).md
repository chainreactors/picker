---
title: Apache Archiva 任意目录删除(CVE-2022-40309) 和 任意文件读取(CVE-2022-40308)
url: https://buaq.net/go-141257.html
source: unSafe.sh - 不安全
date: 2022-12-25
fetch_date: 2025-10-04T02:29:08.015239
---

# Apache Archiva 任意目录删除(CVE-2022-40309) 和 任意文件读取(CVE-2022-40308)

* [unSafe.sh - 不安全](https://unsafe.sh)
* [我的收藏](/user/collects)
* [今日热榜](/?hot=true)
* [公众号文章](/?gzh=true)
* [导航](/nav/index)
* [Github CVE](/cve)
* [Github Tools](/tools)
* [编码/解码](/encode)
* [文件传输](/share/index)
* [Twitter Bot](https://twitter.com/buaqbot)
* [Telegram Bot](https://t.me/aqinfo)
* [Search](/search/search)

[Rss](/rss.xml)

[ ]
黑夜模式

![](https://8aqnet.cdn.bcebos.com/115f9c64e8630bd1d0d44c50799f76d9.jpg)

Apache Archiva 任意目录删除(CVE-2022-40309) 和 任意文件读取(CVE-2022-40308)

Apache Archiva是一个存储库管理软件，2.2.9以下版本在删除或者下载Artifact时，可以在目录或者文件名中注入目录穿越符，导致任意目录删除/任意文件
*2022-12-24 15:57:0
Author: [xz.aliyun.com(查看原文)](/jump-141257.htm)
阅读量:78
收藏*

---

Apache Archiva是一个存储库管理软件，2.2.9以下版本在删除或者下载Artifact时，可以在目录或者文件名中注入目录穿越符，导致任意目录删除/任意文件读取漏洞。

## CVE-2022-40309

### 影响范围

* Apache Archiva < 2.2.9

### 环境搭建

<https://archive.apache.org/dist/archiva/2.2.8/binaries/apache-archiva-2.2.8-bin.zip>

<https://codeload.github.com/apache/archiva/zip/refs/tags/archiva-2.2.8>

`./bin/archiva console`

可以提前在`conf/wrapper.conf`添加如下配置，方便IDEA远程调试

```
wrapper.java.additional.9=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005
```

首次运行需要添加Admin用户，注意需要勾选`Validated`复选框：

<http://127.0.0.1:8080/#open-admin-create-box>

### 漏洞复现

前置条件是需要用户拥有`archiva-delete-artifact`操作权限，使用首次添加的系统管理员账号或者角色为`Repository Manager - internal`的账号都可，其次需要存储库中有`Artifact`

先上传一个`Artifact`到`Archiva Managed Internal Repository`

![](https://xzfile.aliyuncs.com/media/upload/picture/20221224155142-ce093904-835f-1.png)

保存之后文件会储存在`repositories/internal/com/test/test/1.0/test-1.0.jar`

在`/#browse`页面点进`group`然后删除`project`时抓包，如果此页面为空的话可以重启一下Archiva

![](https://xzfile.aliyuncs.com/media/upload/picture/20221224155149-d2c594e2-835f-1.png)

可以抓到如下DELETE请求

```
DELETE /restServices/archivaServices/repositoriesService/project/internal/com.test/test
```

在`projectid`后面添加POC`%2f..%2f..%2f..%2f..%2f..%2fdata`，这将删除Archiva根目录下的`data`目录

```
DELETE /restServices/archivaServices/repositoriesService/project/internal/com.test/test%2f..%2f..%2f..%2f..%2f..%2fdata
```

### 漏洞分析

入口在 org.apache.archiva.rest.api.services.RepositoriesService#deleteProject

```
@Path ("project/{repositoryId}/{groupId}/{projectId}")
@DELETE
@Produces ({ MediaType.APPLICATION_JSON, MediaType.APPLICATION_XML, MediaType.TEXT_PLAIN })
@RedbackAuthorization (noPermission = true)
Boolean deleteProject( @PathParam ("groupId") String groupId, @PathParam ("projectId") String projectId,
                       @PathParam ("repositoryId") String repositoryId )
    throws ArchivaRestServiceException;
```

org.apache.archiva.rest.services.DefaultRepositoriesService#deleteProject

```
public Boolean deleteProject( String groupId, String projectId, String repositoryId )
    throws ArchivaRestServiceException
{
...
    if ( !isAuthorizedToDeleteArtifacts( repositoryId ) )
    {
        throw new ArchivaRestServiceException( "not authorized to delete artifacts", 403, null );
    }

...
    try
    {
        ManagedRepositoryContent repository = repositoryFactory.getManagedRepositoryContent( repositoryId );

        repository.deleteProject( groupId, projectId );
    }
...
}
```

`isAuthorizedToDeleteArtifacts` 限制登录用户需要有`archiva-delete-artifact`权限

在`repository.deleteProject( groupId, projectId )`中直接拼接了目录名进行删除

org.apache.archiva.repository.content.maven2.ManagedDefaultRepositoryContent#deleteProject

![](https://xzfile.aliyuncs.com/media/upload/picture/20221224155200-d91c8616-835f-1.png)

### 漏洞修复

<https://github.com/apache/archiva/commit/930460424c715f52a7cb5eef5b084a7a8ef31fb5#diff-bde5305e671d2bdf9f05df227a6fa706f87b911c28799575537f806a063a9134R95>

![](https://xzfile.aliyuncs.com/media/upload/picture/20221224155203-dae35092-835f-1.png)

## CVE-2022-40308

### 影响范围

* Apache Archiva < 2.2.9

### 环境搭建

同上

### 漏洞复现

前置条件是启用匿名读取或者使用拥有`archiva-read-repository`权限的用户

在如下界面点击下载然后抓包

![](https://xzfile.aliyuncs.com/media/upload/picture/20221224155206-dc7a87b8-835f-1.png)

修改URL为`/repository/internal/..//../data/databases/users/log/log1.dat`，这将会读取Archiva根目录下的`data/databases/users/log/log1.dat`文件，该文件会记录系统用户账号及加密后的密码

### 漏洞分析

由web.xml

```
<servlet-mapping>
  <servlet-name>RepositoryServlet</servlet-name>
  <url-pattern>/repository/*</url-pattern>
</servlet-mapping>
```

入口在RepositoryServlet，而且POC`/repository/internal/..///../data/databases/users/log/log1.dat`中的`..///..`必须是两个及以上数量的`/`，如果URL为`/repository/internal/../../data/databases/users/log/log1.dat`，则Jetty会认为请求的是`/data/databases/users/log/log1.dat`而非`/repository/*`

org.apache.archiva.webdav.RepositoryServlet#service

```
protected void service( HttpServletRequest request, HttpServletResponse response )
    throws ServletException, IOException
{
    WebdavRequest webdavRequest = new WebdavRequestImpl( request, getLocatorFactory() );
    // DeltaV requires 'Cache-Control' header for all methods except 'VERSION-CONTROL' and 'REPORT'.
    int methodCode = DavMethods.getMethodCode( request.getMethod() );
    boolean noCache = DavMethods.isDeltaVMethod( webdavRequest ) && !( DavMethods.DAV_VERSION_CONTROL == methodCode
        || DavMethods.DAV_REPORT == methodCode );
    WebdavResponse webdavResponse = new WebdavResponseImpl( response, noCache );
    DavResource resource = null;

    try
    {
        // make sure there is a authenticated user
        if ( !getDavSessionProvider().attachSession( webdavRequest ) )
        {
            return;
        }

        // check matching if=header for lock-token relevant operations
        resource =
            getResourceFactory().createResource( webdavRequest.getRequestLocator(), webdavRequest, webdavResponse );

        if ( !isPreconditionValid( webdavRequest, resource ) )
        {
            webdavResponse.sendError( DavServletResponse.SC_PRECONDITION_FAILED );
            return;
        }
        if ( !execute( webdavRequest, webdavResponse, methodCode, resource ) )
        {
            super.service( request, response );
        }

    }
...
}
```

跟入`getResourceFactory().createResource`

org.apache.archiva.webdav.ArchivaDavResourceFactory#createResource(org.apache.jackrabbit.webdav.DavResourceLocator, org.apache.jackrabbit.webdav.DavServletRequest, org.apache.jackrabbit.webdav.DavServletResponse)

![](https://xzfile.aliyuncs.com/media/upload/picture/20221224155208-ddf8fade-835f-1.png)

鉴权在`processRepository(...)`中，过了鉴权后发现其实问题也是由于未验证文件名，这里将包含目录穿越的路径直接拼接到`new File()`参数中

### 漏洞修复

这是当时给官方提交漏洞后，官方回复的修复方式，和目前最新版的代码好像不太一样

<https://github.com/apache/archiva/commit/4a2d43be63634331668d71590034963e96a8886a#diff-7828cc4ef12a5f453debc98ef5c3eaf85c6851b271ee298a75b4bd6ea001846cR605>

![](https://xzfile.aliyuncs.com/media/upload/picture/20221224155211-dfcd69e4-835f-1.png)

当时的修复方式和CVE-2022-40309的修复差不多

## 参考

<https://lists.apache.org/thread/1odl4p85r96n27k577jk6ftrp19xfc27>

<https://lists.apache.org/thread/x01pnn0jjsw512cscxsbxzrjmz64n4cc>

文章来源: https://xz.aliyun.com/t/11979
 如有侵权请联系:admin#unsafe.sh

© [unSafe.sh - 不安全](https://unsafe.sh) Powered By [PaperCache](https://github.com/code-scan/PaperCache)

* admin#unsafe.sh
* [安全马克](https://aq.mk)
* [星际黑客](https://xj.hk)
* [T00ls](https://t00ls.net)