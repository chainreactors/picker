---
title: 当全加密M1卡沦陷之后
url: https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458588417&idx=1&sn=5be4f315dc3a7c74a7c9af4eb2745ba9&chksm=b18c258b86fbac9dc5825384788af7b4fd99f936b6c9c8d3ce76492a22a3b271d84da0f16585&scene=58&subscene=0#rd
source: 看雪学苑
date: 2025-01-10
fetch_date: 2025-10-06T20:08:54.548612
---

# 当全加密M1卡沦陷之后

![cover_image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8HqoESibexDGWPrtDd2WnUF5NGrpx4tLgEcbfPKf2sBnTXficn92x75eiax8JCZD21aIwBKSEKezhLFA/0?wx_fmt=jpeg)

# 当全加密M1卡沦陷之后

wx\_张三\_488

看雪学苑

```
一

背景
```

##

复某微发行的 FM11RF08(S) 作为 M1 卡的对标卡，其提供了对于数据的加密保护。相对于 NXP 原厂的卡，能够有效避免类如 NACK、Nested 攻击。

最初在 2024 年 8 月 12 日，来自夸克实验室的 Philippe Teuwen 发表了题目为MIFARE Classic: exposing the static encrypted nonce variant*（https://eprint.iacr.org/2024/1275）*的论文。在 2024 年 11 月 8 日的时候修订提交了第二版。在文章中，完整地描述了来自复某微 FM11RF08(S) 芯片存在后门密钥和可预测随机数的问题。通过这些问题，可以在很短的时间内解密全加密卡，除了全量更换卡片外，没有好的解决方案。

在论文中提到了三种不同的攻击方式，而目前大部分网上的推文都仅关注了一种方式，所以认为影响范围不大。而实际上，目前市面上的 M1 卡加密已经形同虚设，CPU 卡将是大势所趋。

```
二

攻击方式
```

##

在论文中提到了三种不同的攻击方式，用于不同的场景。

### 1. 利用官方 API 读取零扇区全部内容

这一种方式是最简单的，也是令我感到最奇怪的。这看起来似乎是官方预留的后门。将 0 块的数据发送到复某微提供的 API 接口，就可以获得整个零扇区的 keyA 密钥，而***不论***是否对零扇区进行加密。由于 0 块是不加密的，因此可以直接获得 0 块 ~ 3 块的全部数据。

```
 wget -q --header="Content-Type: application/text; charset=utf-8"
  --post-data "1C4C7563460804000475DE7AFD3B8890" -O -
  https://rfid.fm-uivs.com/nfcTools/api/getKeyA | json_pp
```

```
{
  "code" : 0,
  "data" : "0543C7A1F992",
  "message" : "success"
}
```

后面论文也提到，还发现了一个专用于读取零扇区的密钥`A31667A8CEC1`。因此读取零扇区有以下三种方式，后面两种应当是**不得**存在量产卡中的：

1.通过预先设置的加密密钥

2.通过复某微 API 请求密钥

3.后门密钥

### 2、利用后门密钥读取所有数据内容

这里加了***数据***限定是由于这种方法只能够读取所有的数据块内容，而不能够读取控制块的内容。

论文中提到，通过 fuzz 的方式获取到`A396EFA4E24F`这一个密钥。如果使用该密钥对**任一**扇区进行鉴权，即可获得其他**所有**扇区的读取权。

```
hf mf ecfill -c 4 --key A396EFA4E24F
```

这个方案可以导出数据，也可以嗅探到 nonce，但是无法导出密钥，所以似乎是无法实现复制卡的。但是，事实上 Crypto-1 的加密算法强度并没有那么高，只要**让读卡器认为密码正确**就行了。因此，伪造卡的风险很高。

### 3、利用可预测伪随机数进行全卡解密

相对于前两种方法，这个方法我更倾向于是 Crypto-1 算法和芯片设计缺陷。

由于历史的局限性，当时并没有办法实现高强度的加密握手。而且，NFC 卡本身不内置电源，且功耗极其有限，因此在当时没有办法使用真随机数发生器采集足够的熵源，于是采用了 LFSR 的方式生成伪随机数序列用于握手 nonce。（当然，随着时代发展，一些加密算法被硬件实现，其功耗能做到很低，安全性又很高。因此现在 CPU 卡在没有后门的情况下，基本是不太可能被攻破的）

不过，尽管 Crypto-1 算法先天具有一定问题，但是，在全加密的情况下想要破解，也是需要很长的时间。而复某微似乎在特定情况下，会将**同一个**明文使用两个**不同的**密钥进行加密，因此给破解带来了很大的便利。

论文作者给出了一个脚本，但是没有提供预编译的工具。于是现在对 Windows 环境进行了适配，kazutoiris/pm3-fudan里面提供了脚本和相关工具，用于在 Windows 上测试当前的卡是否存在问题，如果存在问题将会自动全卡解密转储。（你需要提前拥有 PM3）

经过测试，之前一些全加密无漏洞卡只需要 5 分钟左右就可以全部转储。

## 验证方法

之前认为只有 FM11RF08S 一款受到影响，但是通读论文后，发现相关的 M1 卡、CPU 混合卡似乎都存在有相同的问题。

确认的方式是通过后门密钥`A31667A8CEC1`、`A396EFA4E24F`等尝试是否能够读取数据。

## 后记

如今再使用 M1 卡已经不再安全，而 CPU 卡的价格也并没有非常高昂，全面更新卡片是**极其必要**的。

## 附录

### 工具用法

kazutoiris/pm3-fudan里面提供了脚本和相关工具，用于在 Windows 上测试当前的卡是否存在问题，如果存在问题将会自动全卡解密转储。（你需要提前拥有 PM3）

```
python fm11rf08s_recovery.py --port COM1
```

###

### 参考文献

Teuwen, P. (2024).*MIFARE Classic: Exposing the Static Encrypted Nonce Variant*. Cryptology ePrint Archive, Paper 2024/1275. Retrieved fromhttps://eprint.iacr.org/2024/1275

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HdGonls53t1vVzOPbheS5f4iciaXCGibNZ7EpK34p2Hq6mMFyQ35QpI3MtACDNL5CGxy78IEL0Sk3Xw/640?wx_fmt=other&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

看雪ID：wx\_张三\_488

*https://bbs.kanxue.com/user-home-903160.htm*

\*本文为看雪论坛优秀文章，由 wx\_张三\_488 原创，转载请注明来自看雪社区

# 往期推荐

1、[PWN入门-SROP拜师](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458579476&idx=2&sn=4f9adc1e7d61c7357bdc85ba654f24cb&chksm=b18dc29e86fa4b88c483a581131de043b076918cd7c7436a82e9bb56bc37c8f1edf6c87d8350&scene=21#wechat_redirect)

2、[一种apc注入型的Gamarue病毒的变种](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458579387&idx=1&sn=9d6fbf25f11b3d99c92c5ac8de0587d5&chksm=b18dc13186fa4827ae7a7bf909e0d2b9490c6df4417c1d7eebc27127133daa9771c212b4f310&scene=21#wechat_redirect)

3、[野蛮fuzz：提升性能](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458579145&idx=1&sn=9134327916f678cfe7e2bc3371cedeaf&chksm=b18dc04386fa49557abc8c7e6ce3410dd4042ed88635c48961fda72b7fa4425698e56bb86ff6&scene=21#wechat_redirect)

4、[关于安卓注入几种方式的讨论，开源注入模块实现](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458579138&idx=1&sn=fef09513ae9f594e68a503f69a312f4f&chksm=b18dc04886fa495e440990cd2dbddb24693452562e53bd8cb565063ddee921b7e288477f4eea&scene=21#wechat_redirect)

5、[2024年KCTF水泊梁山-反混淆](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458579017&idx=2&sn=a97dacde8a6c913108999da8a96a667f&chksm=b18dc0c386fa49d57ce9f0ce6923690d6eb8efb3ccb8032e8c6b923184af3dd29b1b4471f9a2&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_jpg/Uia4617poZXP96fGaMPXib13V1bJ52yHq9ycD9Zv3WhiaRb2rKV6wghrNa4VyFR2wibBVNfZt3M5IuUiauQGHvxhQrA/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8FVzNwDWrTVic9ZOChjQcCJdL82O1EeYY7G3U2crX1uELF6qWUc3OphJLL3jibmyxOsfibRlN0ZdrEDw/640?wx_fmt=gif&from=appmsg)

**球分享**

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8FVzNwDWrTVic9ZOChjQcCJdL82O1EeYY7G3U2crX1uELF6qWUc3OphJLL3jibmyxOsfibRlN0ZdrEDw/640?wx_fmt=gif&from=appmsg)

**球点赞**

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8FVzNwDWrTVic9ZOChjQcCJdL82O1EeYY7G3U2crX1uELF6qWUc3OphJLL3jibmyxOsfibRlN0ZdrEDw/640?wx_fmt=gif&from=appmsg)

**球在看**

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8FVzNwDWrTVic9ZOChjQcCJdZEZibJY2J8WenJnUdOqRMEKnJ6HgCsxf0VTIicFa2nLiceL1r5E5hosHg/640?wx_fmt=gif&from=appmsg)

点击阅读原文查看更多

预览时标签不可点

阅读原文

![]()

微信扫一扫
关注该公众号

继续滑动看下一个

轻触阅读原文

![](http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8EGLfh77kFmnicd9WOic2ibvhCibFdB4bL4srJCgo2wnvdoXLxpIvAkfCmmcptXZB0qKWMoIP8iaibYN2FA/0?wx_fmt=png)

看雪学苑

向上滑动看下一个

知道了

![]()
微信扫一扫
使用小程序

取消
允许

取消
允许

取消
允许

×
分析

![跳转二维码]()

![作者头像](http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8EGLfh77kFmnicd9WOic2ibvhCibFdB4bL4srJCgo2wnvdoXLxpIvAkfCmmcptXZB0qKWMoIP8iaibYN2FA/0?wx_fmt=png)

微信扫一扫可打开此内容，
使用完整服务

：
，
，
，
，
，
，
，
，
，
，
，
，
。

视频
小程序
赞
，轻点两下取消赞
在看
，轻点两下取消在看
分享
留言
收藏
听过