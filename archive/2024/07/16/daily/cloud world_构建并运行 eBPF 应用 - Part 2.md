---
title: æ„å»ºå¹¶è¿è¡Œ eBPF åº”ç”¨ - Part 2
url: https://cloudsjhan.github.io/2024/07/15/%E6%9E%84%E5%BB%BA%E5%B9%B6%E8%BF%90%E8%A1%8C-eBPF-%E5%BA%94%E7%94%A8-Part-2/
source: cloud world
date: 2024-07-16
fetch_date: 2025-10-06T17:42:43.165236
---

# æ„å»ºå¹¶è¿è¡Œ eBPF åº”ç”¨ - Part 2

[cloud world](/)

# To be A geek

* [home](/)
* [tags](/tags/)
* [categories](/categories/)
* [archives](/archives/)
* [top](/top)
* [about](/about/)
* search

## æ„å»ºå¹¶è¿è¡Œ eBPF åº”ç”¨ - Part 2

posted

2024-07-15

|

in

[eBPF](/categories/eBPF/)

|

visitors:

|

|

wordcount:

1,576
|

min2read â‰ˆ

7

![](https://)

åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ç”¨ C è¯­è¨€åˆ›å»ºäº†ä¸€ä¸ª eBPF ç¨‹åºï¼Œä»¥äº†è§£æŸä¸ªè¿›ç¨‹ä½¿ç”¨ CPU çš„æ—¶é—´ã€‚è¿™äº›æ•°æ®éšåè¢«å­˜å‚¨åœ¨ BPF HashMap ä¸­ã€‚ä½†è¿™æ˜¯ä¸€ä¸ªä¸æ–­æ›´æ–°çš„çŸ­æœŸå­˜å‚¨ä½ç½®ï¼Œæ•°æ®çš„å¯¿å‘½å¾ˆçŸ­â€¦â€¦æˆ‘ä»¬è¯¥å¦‚ä½•åˆ©ç”¨è¿™äº›æ•°æ®å‘¢ï¼Ÿ

è¿™å°±æ˜¯ç”¨æˆ·ç©ºé—´ç¨‹åºçš„ç”¨æ­¦ä¹‹åœ°ã€‚ç”¨æˆ·ç©ºé—´ç¨‹åºä¸åœ¨å†…æ ¸ç©ºé—´è¿è¡Œï¼Œä½†å¯ä»¥é™„åŠ åˆ° eBPF ç¨‹åºå¹¶è®¿é—® BPF HashMapã€‚

ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•ç”¨ Golang ç¼–å†™ç”¨æˆ·ç©ºé—´ç¨‹åºã€‚

### Bpf2go

åœ¨ä½¿ç”¨ Golang æ—¶ï¼Œæœ‰ä¸€ä¸ªå¾ˆå¥½ç”¨çš„å·¥å…·å«åš [bpf2go](https://pkg.go.dev/github.com/cilium/ebpf/cmd/bpf2go#section-readme "bpf2go")ã€‚è¿™ä¸ªå·¥å…·å¯ä»¥å¸®åŠ©æˆ‘ä»¬å°†ä¹‹å‰ç¼–å†™çš„ C ä»£ç ç¼–è¯‘æˆ eBPF å­—èŠ‚ç ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜èƒ½åˆ›å»º Golang å‡½æ•°å’Œç»“æ„çš„éª¨æ¶ï¼Œä»¥ä¾¿æˆ‘ä»¬å°†å…¶æ¥å£åˆ°ä»£ç ä¸­ï¼Œä»è€ŒèŠ‚çœå¤§é‡æ—¶é—´ã€‚

### Step 1: åˆ›å»º gen.go æ–‡ä»¶

|  |  |
| --- | --- |
| ``` 1 2 ``` | ``` package main //go:generate go run github.com/cilium/ebpf/cmd/bpf2go processtime processtime.c ``` |

gen.go æ–‡ä»¶ä¸­çš„æ³¨é‡Šè¡Œå…è®¸æˆ‘ä»¬è¿è¡Œ go ç”Ÿæˆï¼Œç„¶åä½¿ç”¨ bpf2go å·¥å…·è¯»å– C ç¨‹åºï¼ˆåœ¨æœ¬ä¾‹ä¸­ï¼Œç¬¬äºŒä¸ªæ ‡å¿—æ˜¯ processtime.cï¼‰ï¼Œå¹¶è¾“å‡ºç”Ÿæˆçš„ Golang ä»£ç ï¼Œè¿™äº›ä»£ç å°†ä½¿ç”¨å‰ç¼€ processtimeï¼ˆç¬¬ä¸€ä¸ªæ ‡å¿—ï¼‰ã€‚è¿è¡Œ go ç”Ÿæˆåï¼Œä½ å°†å¾—åˆ°ä»¥ä¸‹æ–‡ä»¶ï¼š

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 ``` | ``` $ tree . |____gen.go |____processtime.c |____processtime_bpfel.o |____processtime_bpfeb.o |____processtime_bpfel.go |____processtime_bpfeb.go ``` |

è¿™é‡Œç”Ÿæˆäº†å››ä¸ªæ–‡ä»¶ã€‚å¯¹è±¡æ–‡ä»¶ï¼ˆä»¥ .o ç»“å°¾çš„æ–‡ä»¶ï¼‰æ˜¯å°†åŠ è½½åˆ°å†…æ ¸ä¸­çš„ eBPF å­—èŠ‚ç ã€‚ä»¥ Golang ext ç»“å°¾çš„ .go æ–‡ä»¶æ˜¯åˆ›å»ºæ‰€æœ‰ç”¨æˆ·ç©ºé—´æ¥å£çš„æ–‡ä»¶ã€‚

æ‰“å¼€è¿™ä¸¤ä¸ª Golang æ–‡ä»¶ï¼Œä½ è¿˜ä¼šå‘ç°æ¯ä¸ªæ–‡ä»¶çš„é¡¶éƒ¨éƒ½æœ‰ä¸€ä¸ªæ³¨é‡Šï¼Œè¯´æ˜è¯¥æ–‡ä»¶é€‚ç”¨äºå“ªç§ CPU æ¶æ„ã€‚ä¾‹å¦‚ï¼Œprocesstime\_bpfeb.go çš„æ³¨é‡Šå¦‚ä¸‹ï¼š

|  |  |
| --- | --- |
| ``` 1 2 ``` | ``` // Code generated by bpf2go; DO NOT EDIT. //go:build arm64be || armbe || mips || mips64 || mips64p32 || ppc64 || s390 || s390x || sparc || sparc64 ``` |

processtime\_bpfel.go æœ‰ä¸åŒçš„æ¶æ„ï¼š
è¿™æ˜¯å› ä¸ºï¼Œåœ¨å¤„ç†å†…æ ¸æ—¶ï¼Œç¨‹åºçš„ç¼–è¯‘æ–¹å¼åœ¨æ¯ç§æ¶æ„ä¸Šéƒ½æœ‰ç»†å¾®å·®åˆ«ã€‚

### æ­¥éª¤ 2ï¼šç¼–å†™ç”¨æˆ·ç©ºé—´ç¨‹åº

æˆ‘ä»¬å¯ä»¥å¼€å§‹ä½¿ç”¨ eBPF ç¨‹åºäº†ã€‚æˆ‘ä»¬å°†åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª main.goï¼Œå¹¶é¦–å…ˆå–æ¶ˆèµ„æºé™åˆ¶ï¼š

|  |  |
| --- | --- |
| ``` 1 2 3 4 ``` | ``` // Remove resource limits for kernels <5.11. if err := rlimit.RemoveMemlock(); err != nil {   log.Fatal("Removing memlock:", err) } ``` |

è¿™æ˜¯å› ä¸ºå†…æ ¸ v5.11 å‘ç”Ÿäº†å˜åŒ–ï¼ŒBPF è¿›ç¨‹çš„å¯ç”¨å†…å­˜è¿‡å»å— RLIMIT\_MEMLOCK é™åˆ¶ï¼Œä½†è¿™ä¸€é€»è¾‘å·²ç§»è‡³å†…å­˜ cgroup (memcg)ã€‚

ä¸‹ä¸€æ­¥æ˜¯åŠ è½½ eBPF ç¨‹åºã€‚è¿™æ˜¯é€šè¿‡ bpf2go å·¥å…·ç”Ÿæˆçš„æ¥å£ä»£ç ä¸­çš„ä¸€ä¸ªåä¸º loadProcesstimeObject çš„å‡½æ•°å®Œæˆçš„ã€‚æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå˜é‡æ¥å­˜å‚¨è¯¥å‡½æ•°è°ƒç”¨çš„è¾“å‡ºã€‚

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 ``` | ``` // Load the compiled eBPF ELF into the kernel. var objs processtimeObjects if err := loadProcesstimeObjects(&objs, nil); err != nil {   log.Fatal("Loading eBPF objects:", err) } defer objs.Close() ``` |

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦è¿æ¥åˆ°å·²åŠ è½½çš„ç¨‹åºã€‚è¿™å°±éœ€è¦çŸ¥é“ä½ æŒ‚æ¥çš„æ˜¯ä»€ä¹ˆäº‹ä»¶ï¼Œå› ä¸ºä½ éœ€è¦æŒ‡å®šå®ƒã€‚åœ¨æˆ‘ä»¬çš„ C ç¨‹åºä¸­ï¼Œæˆ‘ä»¬æŒ‡å®šäº†ä»¥ä¸‹å†…å®¹ï¼š

|  |  |
| --- | --- |
| ``` 1 ``` | ``` SEC("tracepoint/sched/sched_switch") ``` |

å› æ­¤ï¼Œæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬çš„ç¨‹åºæŒ‚æ¥åˆ°äº† sched å‘½åç©ºé—´ä¸­çš„è·Ÿè¸ªç‚¹ sched\_switchã€‚è¿™å¯ä»¥è½¬åŒ–ä¸ºä»¥ä¸‹å†…å®¹ï¼š

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 ``` | ``` // link to the tracepoint program that we loaded into the kernel tp, err := link.Tracepoint("sched", "sched_switch", objs.CpuProcessingTime, nil) if err != nil {   log.Fatalf("opening kprobe: %s", err) } defer tp.Close() ``` |

æˆ‘ä»¬éœ€è¦çš„æœ€åä¸€é¡¹åŠŸèƒ½æ˜¯è¯»å–å­˜å‚¨åœ¨ BPF HashMap ä¸­çš„æ•°æ®ã€‚è¿™å¯ä»¥é€šè¿‡ä½¿ç”¨ HashMap çš„é”®æ¥æŸ¥çœ‹å­˜å‚¨çš„å€¼ã€‚
åœ¨ç”Ÿæˆ Golang ä»£ç æ—¶ï¼Œæˆ‘ä»¬ç”Ÿæˆäº†ä¸¤ç§ç±»å‹æ¥å¸®åŠ©æˆ‘ä»¬ä¸ BPF HashMap äº¤äº’ã€‚

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 ``` | ``` // used as HashMap Key type processtimeKeyT struct{ Pid uint32 } // used as HashMap Value type processtimeValT struct {   StartTime uint64   ElapsedTime uint64 } ``` |

è¿™ä¸æˆ‘ä»¬åœ¨ C ç¨‹åºä¸­ä½¿ç”¨çš„ä¸¤ç§ç±»å‹ç›¸å…³ï¼š

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 ``` | ``` // used as Hashmap Key struct key_t { __u32 pid; }; // used as Hashmap Value struct val_t { __u64 start_time; __u64 elapsed_time; }; ``` |

åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œé”®å€¼åŸºæœ¬ä¸Šå°±æ˜¯è¿›ç¨‹ IDã€‚ç°åœ¨ï¼Œåœ¨å¤§å¤šæ•°ç³»ç»Ÿä¸­ï¼ŒPID çš„é»˜è®¤å€¼ä»‹äº 1 å’Œ 32767 ä¹‹é—´ï¼Œä½†ä½ å¯ä»¥é€šè¿‡æŸ¥çœ‹ /proc/sys/kernel/pid\_max æ–‡ä»¶æ¥æŸ¥çœ‹è¯¥å€¼ã€‚

é€šè¿‡ä¸Šè¿°é€»è¾‘ï¼Œæˆ‘ä»¬åº”è¯¥å¯ä»¥éå†æ‰€æœ‰æ½œåœ¨çš„ PIDï¼Œå¹¶æ£€æŸ¥ BPF HashMapï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰å­˜å‚¨çš„å€¼ã€‚
å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥ç¼–å†™æˆ‘ä»¬çš„å¾ªç¯é€»è¾‘ï¼š

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 10 11 ``` | ``` var key processtimeKeyT // Iterate over all PIDs between 1 and 32767 (maximum PID on linux) // found in /proc/sys/kernel/pid_max for i := 1; i <= 32767; i++ {   key.Pid = uint32(i)   // Query the BPF map   var mapValue processtimeValT   if err := objs.ProcessTimeMap.Lookup(key, &mapValue); err == nil {     log.Printf("CPU time for PID=%d: %dns\n", key.Pid, mapValue.ElapsedTime)   } } ``` |

è¿™æ®µä»£ç å°†å¾ªç¯å¤„ç†æ¯ä¸ªå¯ç”¨çš„ PIDï¼Œå¹¶åœ¨æˆ‘ä»¬çš„ BPF HashMapï¼ˆç”± objs.ProcessTimeMap æŒ‡å®šï¼‰ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰é”™è¯¯è¿”å›ï¼Œå°†æ‰“å°å‡ºå€¼ã€‚

### æ­¥éª¤ 3.å®Œæ•´ä»£ç 

æœ€ç»ˆä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼šï¼ˆè¯·æ³¨æ„ï¼Œæˆ‘æœ‰ä¸€ä¸ªæ¯ç§’è¿è¡Œä¸€æ¬¡å¾ªç¯çš„ tickerï¼Œå› ä¸º HashMap å¯ä»¥ä¸æ–­æ›´æ–°ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸æ–­é‡æ–°è¯»å–å®ƒï¼‰

|  |  |
| --- | --- |
| ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 ``` | ``` package main  import (   "C"   "log"   "time"    "github.com/cilium/ebpf/link"   "github.com/cilium/ebpf/rlimit" )  func main() {   // Remove resource limits for kernels <5.11.   if err := rlimit.RemoveMemlock(); err != nil {     log.Fatal("Removing memlock:", err)   }    // Load the compiled eBPF ELF and load it into the kernel.   var objs processtimeObjects   if err := loadProcesstimeObjects(&objs, nil); err != nil {     log.Fatal("Loading eBPF objects:", err)   }   defer objs.Close()    // link to the tracepoint program that we loaded into the kernel   tp, err := link.Tracepoint("sched", "sched_switch", objs.CpuProcessingTime, nil)   if err != nil {     log.Fatalf("opening kprobe: %s", err)   }   defer tp.Close()    // Read loop reporting the total amount of times the kernel   // function was entered, once per second.   ticker := time.NewTicker(1 * time.Second)   defer ticker.Stop()    log.Println("Waiting for events..")   for range ticker.C {     var key processtimeKeyT      // Iterate over all PIDs between 1 and 32767 (maximum PID on linux)     // found in /proc/sys/kernel/pid_max     for i := 1; i <= 32767; i++ {       key.Pid = uint32(i)       // Query the BPF map       var mapValue processtimeValT       if err := objs.ProcessTimeMap.Lookup(key, &mapValue); err == nil {         log.Printf("CPU time for PID=%d: %dns\n", key.Pid, mapValue.ElapsedTime)       }     }   } } ``` |

### æ€»ç»“

eBPF æ˜¯ä¸€é¡¹å€¼å¾—å…³æ³¨çš„æŠ€æœ¯ã€‚å®ƒåœ¨ç½‘ç»œã€å¯è§‚æµ‹æ€§å’Œå®‰å…¨æ€§æ–¹é¢èƒ½å¤Ÿå‘æŒ¥é‡è¦ä½œç”¨ã€‚äº†è§£åŸºæœ¬åŸç†æ˜¯ç¬¬ä¸€æ­¥ï¼Œä½†è¦æ·±å…¥ç ”ç©¶çš„ä¸œè¥¿è¿˜æœ‰å¾ˆå¤šã€‚å¯ä»¥æœŸå¾…åç»­çš„æ–‡ç« åˆ†äº«ğŸ‘€ã€‚

---

-------------The End-------------

Title:[æ„å»ºå¹¶è¿è¡Œ eBPF åº”ç”¨ - Part 2](/2024/07/15/%E6%9E%84%E5%BB%BA%E5%B9%B6%E8%BF%90%E8%A1%8C-eBPF-%E5%BA%94%E7%94%A8-Part-2/)

Author:[cloud sjhan](/ "visit cloud sjhan blog")

Publish Time:2024å¹´07æœˆ15æ—¥ - 15:07

Last Update:2024å¹´07æœˆ15æ—¥ - 15:07

Original Link:[https://cloudsjhan.github.io/2024/07/15/æ„å»ºå¹¶è¿è¡Œ-eBPF-åº”ç”¨-Part-2/](/2024/07/15/%E6%9E%84%E5%BB%BA%E5%B9%B6%E8%BF%90%E8%A1%8C-eBPF-%E5%BA%94%E7%94%A8-Part-2/ "æ„å»ºå¹¶è¿è¡Œ eBPF åº”ç”¨ - Part 2")

License: [By-NC-ND 4.0 international](https://creativecommons.org/licenses/by-nc-nd/4.0/ "Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)")ã€‚

![cloud sjhan wechat](/images/wechat-qcode.jpg)

keep going, keep coding

donate

![cloud sjhan å¾®ä¿¡æ”¯ä»˜](/images/wechatpay.jpg)

å¾®ä¿¡æ”¯ä»˜

![cloud sjhan æ”¯ä»˜å®](/images/alipay.jpg)

æ”¯ä»˜å®

[Go](/tags/Go/)
 [eBPF](/tags/eBPF/)

(>ç»™è¿™ç¯‡åšå®¢æ‰“ä¸ªåˆ†å§<)

[æ„å»ºå¹¶è¿è¡Œ eBPF åº”ç”¨ - Part one](/2024/07/14/%E6%9E%84%E5%BB%BA%E5%B9%B6%E8%BF%90%E8%A1%8C-eBPF-%E5%BA%94%E7%94%A8-Part-one/ "æ„å»ºå¹¶è¿è¡Œ eBPF åº”ç”¨ - Part one")

[Lambda-Goï¼šå°†å‡½æ•°å¼ç¼–ç¨‹å¼•å…¥ Go](/2024/07/23/Lambda-Go%EF%BC%9A%E5%B0%86%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B%E5%BC%95%E5%85%A5-Go/ "Lambda-Goï¼šå°†å‡½æ•°å¼ç¼–ç¨‹å¼•å…¥ Go")

* Content
* Overview

![cloud sjhan](/images/avatar.png)

cloud sjhan

[166
æ—¥å¿—](/archives/)

[40
åˆ†ç±»](/categories/index.html)

[73
æ ‡ç­¾](/tags/index.html)

[RSS](/atom.xml)

[GitHub](https://github.com/hantmac "GitHub")

E-Mail

Links

* [CSDN](https://blog.csdn.net/u012421976 "CSDN")
* [w3school](http://www.w3school.com.cn/ "w3school")
* [å¿«æœ](http://search.chongbuluo.com/ "å¿«æœ")

1. [1. Bpf2go](#Bpf2go)
2. [2. Step 1: åˆ›å»º gen.go æ–‡ä»¶](#Step-1-åˆ›å»º-gen-go-æ–‡ä»¶)
3. [3. æ­¥éª¤ 2ï¼šç¼–å†™ç”¨æˆ·ç©ºé—´ç¨‹åº](#æ­¥éª¤-2ï¼šç¼–å†™ç”¨æˆ·ç©ºé—´ç¨‹åº)
4. [4. æ­¥éª¤ 3.å®Œæ•´ä»£ç ](#æ­¥éª¤-3-å®Œæ•´ä»£ç )
5. [5. æ€»ç»“](#æ€»ç»“)

Â© 2018 â€” 2025

cloud sjhan
|

Site words total count:
308.0k

stay hungry,stay foolish

Total Words:308.0k

0%

;