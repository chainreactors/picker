---
title: php反序列化完整总结
url: https://buaq.net/go-162155.html
source: unSafe.sh - 不安全
date: 2023-05-08
fetch_date: 2025-10-04T11:37:11.454969
---

# php反序列化完整总结

* [unSafe.sh - дёҚе®үе…Ё](https://unsafe.sh)
* [жҲ‘зҡ„ж”¶и—Ҹ](/user/collects)
* [д»Ҡж—ҘзғӯжҰң](/?hot=true)
* [е…¬дј—еҸ·ж–Үз«](/?gzh=true)
* [еҜјиҲӘ](/nav/index)
* [Github CVE](/cve)
* [Github Tools](/tools)
* [зј–з Ғ/и§Јз Ғ](/encode)
* [ж–Үд»¶дј иҫ“](/share/index)
* [Twitter Bot](https://twitter.com/buaqbot)
* [Telegram Bot](https://t.me/aqinfo)
* [Search](/search/search)

[Rss](/rss.xml)

[ ]
й»‘еӨңжЁЎејҸ

![](https://8aqnet.cdn.bcebos.com/211d4cd0eb9fd60c326b069394a9a2df.jpg)

phpеҸҚеәҸеҲ—еҢ–е®Ңж•ҙжҖ»з»“

иҠұдәӣж—¶й—ҙжҠҠеӣӣз§Қеёёи§Ғзҡ„phpеҸҚеәҸеҲ—еҢ–жҖ»з»“дәҶдёҖйҒҚпјҢеҗ„иҮӘйғҪжүҫдәҶз®ҖеҚ•зӨәдҫӢе’ҢctfдҫӢйўҳпјҢеҸӮиҖғдәҶдёҖдәӣеёҲеӮ…зҡ„й“ҫжҺҘеҠ дёҠиҮӘе·ұзҡ„зҗҶи§ЈпјҢеҰӮжһңжңүд»Җд№Ҳй”ҷиҜҜпјҢиҜ·еёҲеӮ…д»¬еӨҡеӨҡжҢҮзӮ№пјҢеҸӮиҖғй“ҫжҺҘж”ҫеңЁж–Үжң«
*2023-5-7 19:49:0
Author: [xz.aliyun.com(жҹҘзңӢеҺҹж–Ү)](/jump-162155.htm)
йҳ…иҜ»йҮҸ:61
ж”¶и—Ҹ*

---

иҠұдәӣж—¶й—ҙжҠҠеӣӣз§Қеёёи§Ғзҡ„phpеҸҚеәҸеҲ—еҢ–жҖ»з»“дәҶдёҖйҒҚпјҢеҗ„иҮӘйғҪжүҫдәҶз®ҖеҚ•зӨәдҫӢе’ҢctfдҫӢйўҳпјҢеҸӮиҖғдәҶдёҖдәӣеёҲеӮ…зҡ„й“ҫжҺҘеҠ дёҠиҮӘе·ұзҡ„зҗҶи§ЈпјҢеҰӮжһңжңүд»Җд№Ҳй”ҷиҜҜпјҢиҜ·еёҲеӮ…д»¬еӨҡеӨҡжҢҮзӮ№пјҢеҸӮиҖғй“ҫжҺҘж”ҫеңЁж–Үжң«

иҜҙеҲ°еҸҚеәҸеҲ—еҢ–пјҢз»ҸеёёдјҡжғіеҲ°serialize()пјҢunserialize()иҝҷдёӨдёӘеҮҪж•°гҖӮ

еҲ°иҝҷйҮҢе°ұе·®дёҚеӨҡдәҶпјҢеҰӮжһңиҜҙдёҠйқўзҡ„json\_encodeеҮҪж•°жҳҜе°Ҷж•°з»„иҪ¬еҢ–жҲҗjsonж јејҸзҡ„еӯ—з¬ҰдёІпјҢйӮЈд№ҲжҲ‘д»¬жқҘзңӢеәҸеҲ—еҸ·е’ҢеҸҚеәҸеҲ—еҢ–е°ұжҳҜдёҖдёӘеҜ№иұЎеәҸеҲ—еҢ–жҲҗдёҖдёІеӯ—з¬ҰдёІпјҢдҪҶд»…дҝқз•ҷеҜ№иұЎйҮҢзҡ„жҲҗе‘ҳеҸҳйҮҸпјҢдёҚдҝқз•ҷеҮҪж•°ж–№жі•

зңӢзңӢдҫӢеӯҗ
![](https://xzfile.aliyuncs.com/media/upload/picture/20230507094951-7524d0b8-ec79-1.png)
еәҸеҲ—еҢ–з»“жһңдёәпјҡ
O:6:"class1":3:{s:1:"a";s:1:"1";s:4:"*b";s:5:"ThisB";s:9:"class1c";s:5:"ThisC";}
еҜ№иұЎеәҸеҲ—еҢ–еҗҺзҡ„з»“жһ„дёәпјҡ
O:еҜ№иұЎеҗҚзҡ„й•ҝеәҰ:"еҜ№иұЎеҗҚ":еҜ№иұЎеұһжҖ§дёӘж•°:{s:еұһжҖ§еҗҚзҡ„й•ҝеәҰ:"еұһжҖ§еҗҚ";s:еұһжҖ§еҖјзҡ„й•ҝеәҰ:"еұһжҖ§еҖј";}
aжҳҜpublicзұ»еһӢзҡ„еҸҳйҮҸпјҢsиЎЁзӨәеӯ—з¬ҰдёІпјҢ1иЎЁзӨәеҸҳйҮҸеҗҚзҡ„й•ҝеәҰпјҢaжҳҜеҸҳйҮҸеҗҚгҖӮ
bжҳҜprotectedзұ»еһӢзҡ„еҸҳйҮҸпјҢе®ғзҡ„еҸҳйҮҸеҗҚй•ҝеәҰдёә4пјҢд№ҹе°ұжҳҜbеүҚж·»еҠ дәҶ%00*%00гҖӮжүҖд»ҘпјҢprotectedеұһжҖ§зҡ„иЎЁзӨәж–№ејҸжҳҜеңЁеҸҳйҮҸеҗҚеүҚеҠ дёҠ%00\*%00гҖӮ
cжҳҜprivateзұ»еһӢзҡ„еҸҳйҮҸпјҢcзҡ„еҸҳйҮҸеҗҚеүҚж·»еҠ дәҶ%00зұ»еҗҚ%00гҖӮжүҖд»ҘпјҢprivateеұһжҖ§зҡ„иЎЁзӨәж–№ејҸжҳҜеңЁеҸҳйҮҸеҗҚеүҚеҠ дёҠ%00зұ»еҗҚ%00гҖӮ
иҷҪз„¶Testзұ»дёӯжңүtest1ж–№жі•пјҢдҪҶжҳҜпјҢеәҸеҲ—еҢ–еҫ—еҲ°зҡ„еӯ—з¬ҰдёІдёӯпјҢеҸӘдҝқеӯҳдәҶе…¬жңүеҸҳйҮҸaпјҢдҝқжҠӨеҸҳйҮҸbе’Ңз§ҒжңүеҸҳйҮҸcпјҢе№¶жІЎдҝқеӯҳзұ»дёӯзҡ„ж–№жі•гҖӮд№ҹеҸҜд»ҘзңӢеҮәпјҢеәҸеҲ—еҢ–дёҚдҝқеӯҳж–№жі•гҖӮ

иҜ•иҜ•еҸҚеәҸеҲ—еҢ–
![](https://xzfile.aliyuncs.com/media/upload/picture/20230507094952-7547abb0-ec79-1.png)
echoе’Ңvar\_dumpеҸӘиғҪиҫ“еҮә$test1->aпјҢз§ҒжңүеҸҳйҮҸе’ҢprotectedеҸҳйҮҸйғҪдёҚеҸҜд»Ҙ
![](https://xzfile.aliyuncs.com/media/upload/picture/20230507094952-7565ec2e-ec79-1.png)
![](https://xzfile.aliyuncs.com/media/upload/picture/20230507094952-75892fc2-ec79-1.png)

еҸҚеәҸеҲ—еҢ–жјҸжҙһдә§з”ҹзҡ„еҺҹеӣ жҲ‘дёӘдәәжҖ»з»“е°ұжҳҜеҸҚеәҸеҲ—еҢ–еӨ„зҡ„еҸӮж•°з”ЁжҲ·еҸҜжҺ§пјҢжңҚеҠЎеҷЁжҺҘж”¶жҲ‘д»¬еәҸеҲ—еҢ–еҗҺзҡ„еӯ—з¬ҰдёІе№¶дё”жңӘз»ҸиҝҮж»ӨжҠҠе…¶дёӯзҡ„еҸҳйҮҸж”ҫе…ҘдёҖдәӣйӯ”жңҜж–№жі•йҮҢйқўжү§иЎҢпјҢиҝҷе°ұеҫҲе®№жҳ“дә§з”ҹжјҸжҙһгҖӮ

#### йӮЈйӯ”жңҜж–№жі•жҳҜд»Җд№Ҳе‘ў

йӯ”жңҜж–№жі•е‘ҪеҗҚжҳҜд»Ҙз¬ҰеҸ·**ејҖеӨҙзҡ„пјҢжҜ”еҰӮ** construct, **destruct,** toString, **sleep,** wakeupзӯүзӯүгҖӮиҝҷдәӣеҮҪж•°еңЁжҹҗдәӣжғ…еҶөдёӢдјҡиҮӘеҠЁи°ғз”ЁгҖӮ

* \_\_construct():е…·жңүжһ„йҖ еҮҪж•°зҡ„зұ»дјҡеңЁжҜҸж¬ЎеҲӣе»әж–°еҜ№иұЎж—¶е…Ҳи°ғз”ЁжӯӨж–№жі•гҖӮ
* \_\_destruct():жһҗжһ„еҮҪж•°дјҡеңЁеҲ°жҹҗдёӘеҜ№иұЎзҡ„жүҖжңүеј•з”ЁйғҪиў«еҲ йҷӨжҲ–иҖ…еҪ“еҜ№иұЎиў«жҳҫејҸй”ҖжҜҒж—¶жү§иЎҢгҖӮ
* \_\_toString()ж–№жі•з”ЁдәҺдёҖдёӘзұ»иў«еҪ“жҲҗеӯ—з¬ҰдёІж—¶еә”жҖҺж ·еӣһеә”гҖӮдҫӢеҰӮecho $obj;еә”иҜҘжҳҫзӨәдәӣд»Җд№ҲгҖӮ жӯӨж–№жі•еҝ…йЎ»иҝ”еӣһдёҖдёӘеӯ—з¬ҰдёІпјҢеҗҰеҲҷе°ҶеҸ‘еҮәдёҖжқЎ E\_RECOVERABLE\_ERROR зә§еҲ«зҡ„иҮҙе‘Ҫй”ҷиҜҜгҖӮ
* \_\_sleep()ж–№жі•еңЁдёҖдёӘеҜ№иұЎиў«еәҸеҲ—еҢ–д№ӢеүҚи°ғз”Ёпјӣ
* \_\_wakeup():unserialize( )дјҡжЈҖжҹҘжҳҜеҗҰеӯҳеңЁдёҖдёӘ\_wakeup( )ж–№жі•гҖӮеҰӮжһңеӯҳеңЁпјҢеҲҷдјҡе…Ҳи°ғз”Ё\_wakeupж–№жі•пјҢйў„е…ҲеҮҶеӨҮеҜ№иұЎйңҖиҰҒзҡ„иө„жәҗгҖӮ
* **get(),**set() еҪ“и°ғз”ЁжҲ–и®ҫзҪ®дёҖдёӘзұ»еҸҠе…¶зҲ¶зұ»ж–№жі•дёӯжңӘе®ҡд№үзҡ„еұһжҖ§ж—¶
* \_\_invoke() и°ғз”ЁеҮҪж•°зҡ„ж–№ејҸи°ғз”ЁдёҖдёӘеҜ№иұЎж—¶зҡ„еӣһеә”ж–№жі•
* **call е’Ң** callStaticеүҚиҖ…жҳҜи°ғз”Ёзұ»дёҚеӯҳеңЁзҡ„ж–№жі•ж—¶жү§иЎҢпјҢиҖҢеҗҺиҖ…жҳҜи°ғз”Ёзұ»дёҚеӯҳеңЁзҡ„йқҷжҖҒж–№ејҸж–№жі•ж—¶жү§иЎҢгҖӮ

иҝҷйҮҢйҖҡиҝҮдёҖдёӘе®һдҫӢжңүеҠ©дәҺзҗҶи§ЈиҝҷеҮ дёӘйӯ”жңҜж–№жі•зҡ„жү§иЎҢйЎәеәҸ
![](https://xzfile.aliyuncs.com/media/upload/picture/20230507094952-75b64340-ec79-1.png)

## 1.еҸҚеәҸеҲ—еҢ–з®ҖеҚ•е…Ҙй—Ёе®һдҫӢ

```
<?php
class A{
    var $test = "demo";
    function __destruct(){
        echo $this->test;
    }
}
$a = $_GET['test'];
$a_unser = unserialize($a);
?>
```

иҝҷйҮҢжҲ‘д»¬еҸӘиҰҒжһ„йҖ payloadпјҡ[http://127.0.0.1/test.php?test=O:1:"A":1:{s:4:"test";s:5:"hello";}](http://127.0.0.1/test.php?test=O:1:)
е°ұиғҪеӨҹе®һзҺ°жҺ§еҲ¶echoиҫ“еҮәзҡ„еҸҳйҮҸпјҢе®ҢжҲҗдёҖдёӘеҸҚе°„еһӢxss

![](https://xzfile.aliyuncs.com/media/upload/picture/20230507094953-75d8224e-ec79-1.png)![](https://xzfile.aliyuncs.com/media/upload/picture/20230507094953-75faad78-ec79-1.png)

### иҝҷйҮҢжҲ‘йҮҚж–°еҶҷдёӘдҫӢеӯҗжқҘж•ҙзҗҶдёҖдёӢеәҸеҲ—еҢ–зҡ„жү§иЎҢиҝҮзЁӢ

```
<?php
class A
{
    var $a = "a";
    var $b = "b\r\n";

    function __construct()
    {
        $this->a = "123";
        echo "еҲқе§ӢеҢ–ж—¶и°ғз”Ё\r\n";
    }

    function __destruct()
    {
        echo "й”ҖжҜҒж—¶и°ғз”Ё--";
        echo $this->a . "\r\n";
    }
}
$b = new A();
#$ser serialize($b);
#echo $ser;
$ser_test = 'O:1:"A":1:{s:1:"a";s:4:"test";}';
$unser = unserialize($ser_test);
echo $b->b;
?>
```

йҖҡиҝҮdebugд»ҘеҸҠеӣўйҳҹеёҲеӮ…зҡ„и§Јжғ‘еҗҺжҲ‘жүҚжҠҠд»Јз ҒиҝҗиЎҢиҝҮзЁӢжҚӢжё…жҘҡдәҶпјҢе…Ҳж”ҫеҮәиҫ“еҮәз»“жһң![](https://xzfile.aliyuncs.com/media/upload/picture/20230507094953-761389a6-ec79-1.png)
иҝҷйҮҢе…ҲжҠҠAзұ»е®һдҫӢеҢ–дёә$bпјҢи§ҰеҸ‘дәҶжһ„йҖ еҮҪж•°\_\_construct()пјҢжү“еҚ°дәҶеҲқе§ӢеҢ–ж—¶и°ғз”ЁпјҢйЎәдҫҝжҠҠ$aи®ҫзҪ®жҲҗ123
жҺҘзқҖиҝҗиЎҢпјҢиҝҷйҮҢзҡ„еҸҚеәҸеҲ—еҢ–дёҚдјҡжңүд»»дҪ•иҫ“еҮәпјҢд»Ҙдёәд»–жІЎжңүи°ғз”Ёжһ„йҖ еҮҪж•°д№ҹжІЎй”ҖжҜҒпјҢдҪҶжҳҜз”ҹжҲҗдәҶдёҖдёӘAзұ»зҡ„еҸҚеәҸеҲ—еҢ–еҜ№иұЎгҖӮпјҲдёәд»Җд№ҲеәҸеҲ—еҢ–еҜ№иұЎз”ҹжҲҗжІЎжңүи§ҰеҸ‘жһ„йҖ еҮҪж•°пјү
жңҖеҗҺдјҡиө°еҲ°echo $b->bиҝҷйҮҢпјҢиҫ“еҮәжӯӨж—¶е®һдҫӢеҢ–зҡ„еҜ№иұЎ$b->bзҡ„еҖјпјҢд№ҹе°ұжҳҜb
з„¶еҗҺи„ҡжң¬з»“жқҹпјҢе…Ҳй”ҖжҜҒеҸҚеәҸеҲ—еҢ–еҜ№иұЎunserпјҢиҫ“еҮәй”ҖжҜҒж—¶и°ғз”ЁпјҢжӯӨж—¶еҸҚеәҸеҲ—еҢ–еҜ№иұЎзҡ„$aжҳҜtestпјҢжҺҘзқҖй”ҖжҜҒе®һдҫӢеҢ–еҜ№иұЎ$bпјҢд№ҹжҳҜеҗҢзҗҶгҖӮ

## 2.wakeupз»•иҝҮ

### CVE-2016-7124

```
<?php
class A{
    var $target = "test";
    function __wakeup(){
        $this->target = "wakeup!";
    }
    function __destruct(){
        $fp = fopen("C:\\phpstudy_pro\\WWW\\unserialize\\shell.php","w");
        fputs($fp,$this->target);
        fclose($fp);
    }
}

$test = $_GET['test'];
$test_unseria = unserialize($test);

echo "shell.php<br/>";
include(".\shell.php");
?>
```

д»Јз ҒжӯЈеёёзҡ„жү§иЎҢйҖ»иҫ‘пјҢеә”иҜҘжҳҜпјҡunserialize( )дјҡжЈҖжҹҘжҳҜеҗҰеӯҳеңЁдёҖдёӘ\_wakeup( )ж–№жі•гҖӮжң¬дҫӢдёӯеӯҳеңЁпјҢеҲҷдјҡе…Ҳи°ғз”Ё\_wakeup()ж–№жі•пјҢйў„е…Ҳе°ҶеҜ№иұЎдёӯзҡ„targetеұһжҖ§иөӢеҖјдёә"wakeup!"гҖӮжіЁж„ҸпјҢдёҚз®Ўз”ЁжҲ·дј е…Ҙзҡ„еәҸеҲ—еҢ–еӯ—з¬ҰдёІдёӯзҡ„targetеұһжҖ§дёәдҪ•еҖјпјҢ**wakeup()йғҪдјҡжҠҠ$targetзҡ„еҖјйҮҚзҪ®дёә"wakeup!"гҖӮжңҖеҗҺзЁӢеәҸиҝҗиЎҢз»“жқҹпјҢеҜ№иұЎиў«й”ҖжҜҒпјҢи°ғз”Ё**destruct()ж–№жі•пјҢе°ҶtargetеҸҳйҮҸзҡ„еҖјеҶҷе…Ҙж–Үд»¶shell.phpдёӯгҖӮиҝҷж ·shell.phpж–Үд»¶дёӯзҡ„еҶ…е®№е°ұжҳҜеӯ—з¬ҰдёІ"wakeup"гҖӮ
дёӢйқўжҳҜдёҖйҒ“иҝҷдёӘзҹҘиҜҶзӮ№зҡ„ctfйўҳзӣ®

### 3.[зҪ‘йјҺжқҜ 2020 йқ’йҫҷз»„]AreUSerialz

![](https://xzfile.aliyuncs.com/media/upload/picture/20230507094953-7645e018-ec79-1.png)
![](https://xzfile.aliyuncs.com/media/upload/picture/20230507094954-7674c252-ec79-1.png)
е…ҲжқҘзҗҶи§ЈдёҖдёӢжәҗз Ғпјҡ
иҝҷйҮҢе…ҲеҲӨж–ӯеӯҳдёҚеӯҳеңЁstrдј еҸӮпјҢеӯҳеңЁзҡ„иҜқе…ҲжӢҝеҺ»is\_validеҮҪж•°иҝҮж»ӨдёҖдёӢпјҢиҝҷйҮҢis\_validеҮҪж•°зҡ„дҪңз”ЁжҳҜжЈҖжҹҘдёҖдёӢstrеӯ—з¬ҰдёІйҮҢйқўжңүжІЎжңүеӯҳеңЁдёҚеҸҜжү“еҚ°зҡ„еӯ—з¬ҰгҖӮordеҮҪж•°жҳҜжү“еҚ°з¬¬дёҖдёӘеӯ—з¬Ұзҡ„ASCIIз Ғеҝ…йЎ»еңЁ32еҲ°125д№Ӣй—ҙ

з„¶еҗҺиҝӣе…ҘеҸҚеәҸеҲ—еҢ–пјҢиҝҷйҮҢеҸҚеәҸеҲ—еҢ–еҗҺз”ҹжҲҗдёҖдёӘеәҸеҲ—еҢ–еҜ№иұЎпјҢдҪҶжҳҜдёҚи§ҰеҸ‘д»»дҪ•еҮҪж•°пјҢз„¶еҗҺиҝӣзЁӢз»“жқҹпјҢеәҸеҲ—еҢ–еҜ№иұЎй”ҖжҜҒпјҢи§ҰеҸ‘\_\_destruct()пјҢеҲӨж–ӯopеҖјеҰӮжһңејәзӯүдәҺвҖң2вҖқеҲҷжҠҠopйҮҚзҪ®дёәвҖң1вҖқпјҢжіЁж„ҸиҝҷйҮҢзҡ„вҖң2вҖқжҳҜеӯ—з¬ҰдёІпјҢз„¶еҗҺжҠҠ...