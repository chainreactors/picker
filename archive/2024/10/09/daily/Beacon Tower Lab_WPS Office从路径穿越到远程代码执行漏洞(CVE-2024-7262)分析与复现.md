---
title: WPS Office从路径穿越到远程代码执行漏洞(CVE-2024-7262)分析与复现
url: https://mp.weixin.qq.com/s?__biz=MzkyNzcxNTczNA==&mid=2247486748&idx=1&sn=46e2c665774918fd88693d73fdfb0a0c&chksm=c22295e5f5551cf3db16503a2dda80ff895aa21c9d20192e08efbba7a5120179ec3ffb5ac154&scene=58&subscene=0#rd
source: Beacon Tower Lab
date: 2024-10-09
fetch_date: 2025-10-06T18:54:34.886452
---

# WPS Office从路径穿越到远程代码执行漏洞(CVE-2024-7262)分析与复现

![cover_image](https://mmbiz.qpic.cn/mmbiz_jpg/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTXVnbp6f0icxQshH89icS8HHlmib0YdoxkuHtIkIQvfEP6IUI7PcrUdUBtA/0?wx_fmt=jpeg)

# WPS Office从路径穿越到远程代码执行漏洞(CVE-2024-7262)分析与复现

原创

烽火台实验室

Beacon Tower Lab

**漏洞概述**

WPS Office程序promecefpluginhost.exe存在不当路径验证问题，允许攻击者在Windows上加载任意Windows库文件。该漏洞已被APT-C-60攻击者利用，当用户打开MHTML格式的文档时，只需单击一个恶意制作的超链接，即可执行攻击者指定的恶意库文件，实现远程代码执行。

**影响范围**

WPS Office版本12.2.0.13110-12.2.0.16412

**复现环境**

```
操作系统：Win10 10.0.18363.592WPS Office版本：WPS Office 12.2.0.13110
```

**分析过程**

WPS程序安装后注册了一个名为 ksoqing 的自定义URL协议，注册表路径为：计算机\HKEY\_CLASSES\_ROOT\ksoqing\shell\open\command，其内容为"C:\Users\【用户名】\AppData\Local\Kingsoft\WPS Office\12.2.0.13110\office6\wps.exe" /qingbangong "%1"。即访问以ksoqing 开头的URL协议时，将启动wps.exe程序，并传递/qingbangong参数，%1则被替换为以ksoqing 开头的协议链接，一并作为wps启动的参数。

![](https://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTX2LK7XbcEdLWVYRricnibl1UEbzTa1vMwrCkn3viacIFaNPA04Xbbqx5XA/640?wx_fmt=png&from=appmsg)

此时wps.exe程序解析参数/qingbangong，并将ksoqing链接内容一并发送到 C:\Users\【用户名】\AppData\Local\Kingsoft\WPS Office\12.2.0.13110\office6\wpscloudsvr.exe

![](https://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTXgYgI7ibW37ib6rNWGLhEiaC7rRquXp6162NkSk0F9fVghXP7saKAkdqEA/640?wx_fmt=png&from=appmsg)

wpscloudsvr.exe中的qingbangong.dll解析自定义URL链接内容。当type参数为ksolaunch时，将启动launchname参数指定的程序，参数使用base64编码。

![](https://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTXV0iacvGo3XWnUTz09aydCzztLwzZEaiaIv1nicicpDicxl27pTPsyibiaMQAQ/640?wx_fmt=png&from=appmsg)

launchname参数指定的程序启动时，wpscloudsvr.exe会将URL链接中的cmd参数使用base64解码，然后传递给它。

![](https://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTXTe9cNoxA2vcWJKhU05YR8kT9uaYCA2DnicdibqNfeGSnbf5iafFABOIlA/640?wx_fmt=png&from=appmsg)

如果launchname参数指定的是promecefpluginhost.exe，该程序启动后，将加载ksojscore.dll，然后解析命令行中的-JSCefServicePath。

![](https://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTXGkm0vLztpX7bWAMibUncia04KE0Uib48N5iaJR07FicYEiafTJdNTaodRxPQ/640?wx_fmt=png&from=appmsg)

这个参数可以指定一个文件名，这个文件会被kso\_qt::QLibrary::load函数加载到内存执行。默认情况下，如果只是指定一个文件名，会按照DLL搜索顺序搜索和加载这个文件，比如加载同EXE目录下指定的DLL文件。但是这个参数未做任何过滤，可以指定“..\”包含目录的路径，存在路径穿越漏洞，可以加载任意指定的DLL文件，最终实现任意代码执行。

![](https://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTXfhgFicF6TopSib8v8VoyNqe2k4UspK1V8hkPCjSDf62nSXr2DgggdfHg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTXjkJwXMPhepF6TicVAf1udvvWOClQTBrMULvJF1RficYiaLSue2pjoUGtA/640?wx_fmt=png&from=appmsg)

使用路径穿越的漏洞可以加载指定DLL文件，但这还不够。APT-C-60攻击者使用MHTML格式的xls电子表格文件，利用其特性，实现下载远程DLL文件的目的。WPS支持MHTML格式的文档，这种文档可以包含 HTML、CSS 和 JavaScript 等文件，方便在浏览器中显示文档。

文档中可以使用img标签，指定远程DLL文件。

![](https://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTXCCIwicghpZsTvQicLfN5XDAJAqr7pDiakT2BoJdtficwe8qsqLLPE9TdyA/640?wx_fmt=png&from=appmsg)

当文档被打开时，wps使用\_XUrlDownloadToCacheFile函数下载文件到temp目录下的wps\INetCache目录中。

![](https://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTXibhBonTiajTFOc0KcO4H9NzPnJAUMNlzkhfL5oiciabtdStDD2tRTatIFA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTX9gVAJ6wKHWJ23JaJiaLhOWeVgSX8JeCkw2ueUX4mhgtcLKRzyBuRic2w/640?wx_fmt=png&from=appmsg)

下载后的文件名，使用的是下载链接（UNICODE编码）的MD5值。

![](https://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTXtChibn2gfG4MatnuItpda5ia4cMMIvmaxbSOKNaL3ibibW9HzIwkn2zh8g/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTXibvqaqALqCzDriaxtDOwyj5V7Vt1P1yUicJ2dydw3nmxhsXzNJpbCWdKg/640?wx_fmt=png&from=appmsg)

最终配合上述路径穿越漏洞，在-JSCefServicePath参数中指定下载的文件名，实现远程代码执行。这里还有一个小技巧，因为下载后的文件名并没有.dll后缀，而在加载的时候如果没有指定.dll后缀，会自动补上该后缀再加载。为了避免在加载的时候找不到指定文件导致失败，在-JSCefServicePath参数中指定下载的文件名时，需要在文件名最后额外加个“.”。

![](https://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTX6jIyIicVBljGQLM8U3mIM7sqzOrbRxRavefrxCZAuuwCNwL6XtibWB0Q/640?wx_fmt=png&from=appmsg)

**漏洞复现**

新建xls格式的文档，添加超链接，超链接可任意，并另存为MHTML格式的文档。

![](https://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTXjdpHDzaqibpAjRn1Bf6Qo0srWIPqqUIic3MkUsvNZyG5HIH6icoibkhUtQ/640?wx_fmt=png&from=appmsg)

根据远程DLL的下载链接，使用poc.py计算下载后的文件名，并最终生成ksoqing协议链接。

![](https://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTXVShEuia0xR5PW5vict858plfpsXVNCfdc72aibvBubdBO9G1ibmC6aUzjA/640?wx_fmt=png&from=appmsg)

将ksoqing链接替换导出的MHTML格式文档中的超链接。

![](https://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTXmfokwxLbxZuGAe2gnMa58gwCtCmCbTwoBIQibpzyTibzibEnW39qG6Agw/640?wx_fmt=png&from=appmsg)

再根据远程DLL的下载链接，添加img标签，实现远程下载DLL文件。

![](https://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTXrbBibsFQHKSspIC6I4VSv3BX495WicL2hmSLgZFTO0D6Q1NjYjb3XWqw/640?wx_fmt=png&from=appmsg)

开启远程DLL下载服务，然后打开MHTML文档，点击超链接，触发漏洞。

![](https://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTXlJGibu9JVwRLqg9Cg4JynqVNf5spR8cNrhl7J91Y4Dwu54MGFkwKw2Q/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeANZiavjlicibqp7Bqpbu6WrSTXCU39tAHozU40YSwPfoJBWic1g4mXukTn0A5FkwyNfcz911YZgqUgstw/640?wx_fmt=png&from=appmsg)

**参考链接**

ddpoc链接：

https://www.ddpoc.com/DVB-2024-8279.html

```
https://www.welivesecurity.com/en/eset-research/analysis-of-two-arbitrary-code-execution-vulnerabilities-affecting-wps-office/https://nvd.nist.gov/vuln/detail/CVE-2024-7262https://avd.aliyun.com/detail?id=AVD-2024-7262
```

预览时标签不可点

![]()

微信扫一扫
关注该公众号

继续滑动看下一个

轻触阅读原文

![](http://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeAPuXuLlzxV94SmGrdhm12Xoib8pv5tVryyDTMZPUwvOeXrHV2ygdoKrKJQ1u618rmXbhfhiaw8icr5Lw/0?wx_fmt=png)

Beacon Tower Lab

向上滑动看下一个

知道了

![]()
微信扫一扫
使用小程序

取消
允许

取消
允许

取消
允许

×
分析

![跳转二维码]()

![作者头像](http://mmbiz.qpic.cn/mmbiz_png/8E5sfrfkeAPuXuLlzxV94SmGrdhm12Xoib8pv5tVryyDTMZPUwvOeXrHV2ygdoKrKJQ1u618rmXbhfhiaw8icr5Lw/0?wx_fmt=png)

微信扫一扫可打开此内容，
使用完整服务

：
，
，
，
，
，
，
，
，
，
，
，
，
。

视频
小程序
赞
，轻点两下取消赞
在看
，轻点两下取消在看
分享
留言
收藏
听过